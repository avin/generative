(this.webpackJsonpgenerative=this.webpackJsonpgenerative||[]).push([[22,7,317,318,319,320,321],{212:function(we,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
attribute vec3 position;
attribute vec3 normal;
attribute vec2 uv;

uniform mat4 worldViewProjection;
uniform float time;

varying vec3 vPosition;
varying vec2 vUV;

void main() {
    vec4 p = vec4( position, 1. );
    vPosition = p.xyz;
    vUV = uv;
	gl_Position = worldViewProjection * p;
}
`},213:function(we,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
#define COUNT 122
#define RADIUS .03
#define SPEED .0038

#define FD(x,y) texelFetch(iChannel0, ivec2(x, y), 0)
#define hue(v)  ( .6 + .6 * cos( 6.3*(v)  + vec4(0,23,21,0)  ) )
#define MOD3 vec3(.1031, .11369, .13787)

vec3 hash33(vec3 p3)
{
    p3 = fract(p3 * MOD3);
    p3 += dot(p3, p3.yxz + 19.19);
    return -1.0 + 2.0 * fract(vec3((p3.x + p3.y) * p3.z, (p3.x + p3.z) * p3.y, (p3.y + p3.z) * p3.x));
}

float snoise(vec3 p)
{
    const float K1 = 0.333333333;
    const float K2 = 0.166666667;

    vec3 i = floor(p + (p.x + p.y + p.z) * K1);
    vec3 d0 = p - (i - (i.x + i.y + i.z) * K2);

    vec3 e = step(vec3(0.0), d0 - d0.yzx);
    vec3 i1 = e * (1.0 - e.zxy);
    vec3 i2 = 1.0 - e.zxy * (1.0 - e);

    vec3 d1 = d0 - (i1 - 1.0 * K2);
    vec3 d2 = d0 - (i2 - 2.0 * K2);
    vec3 d3 = d0 - (1.0 - 3.0 * K2);

    vec4 h = max(0.6 - vec4(dot(d0, d0), dot(d1, d1), dot(d2, d2), dot(d3, d3)), 0.0);
    vec4 n = h * h * h * h * vec4(dot(d0, hash33(i)), dot(d1, hash33(i + i1)), dot(d2, hash33(i + i2)), dot(d3, hash33(i + 1.0)));

    return dot(vec4(31.316), n);
}

float hash12(vec2 p)
{
    vec3 p3  = fract(vec3(p.xyx) * .1031);
    p3 += dot(p3, p3.yzx + 33.33);
    return fract((p3.x + p3.y) * p3.z);
}

float hash11(float p)
{
    p = fract(p * 0.1031);
    p *= p + 33.33;
    p *= p + p;
    return fract(p);
}
`},214:function(we,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
uniform float iTime;
uniform vec2 iResolution;
uniform sampler2D iChannel0;
uniform sampler2D iChannel1;
uniform sampler2D iChannel2;
uniform sampler2D iChannel3;
uniform int iFrame;

varying vec3 vPosition;
varying vec2 vUV;

// --------- START-SHADER-TOY-CODE-HERE ------------

#define SF 2./min(iResolution.x, iResolution.y)
#define SS(l, s) smoothstep(SF, -SF, l - s)

void mainImage( out vec4 fragColor, in vec2 fragCoord )
{
    vec2 uv = (fragCoord - iResolution.xy * .5) / iResolution.y;
    vec2 ouv = fragCoord/iResolution.xy;

    vec3 col = texture(iChannel1, ouv).xyz;

    for (float i = 0.; i < float(COUNT); i += 1.) {
        vec4 point = FD(i, 0);

        vec2 pos = point.xy;

        float d = length(uv - pos)*1.5;
        float g = SS(d, RADIUS);

        col = mix(col, vec3(1.).rgb, g*.5);
    }

    fragColor = texture(iChannel0, ouv);
    fragColor = vec4(col, 0.);

}

// --------- END-SHADER-TOY-CODE-HERE ------------

void main() { mainImage(gl_FragColor, vUV * iResolution.xy); }
`},215:function(we,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
uniform float iTime;
uniform vec2 iResolution;
uniform sampler2D iChannel0;
uniform sampler2D iChannel1;
uniform sampler2D iChannel2;
uniform sampler2D iChannel3;
uniform int iFrame;

varying vec3 vPosition;
varying vec2 vUV;

// --------- START-SHADER-TOY-CODE-HERE ------------

void mainImage(out vec4 fragColor, in vec2 fragCoord)
{
    int x = int(fragCoord.x);
    float fx = fragCoord.x;
    int y = int(fragCoord.y);

    if(y > 2 || x > COUNT){
    	discard;
    }

    vec2 rt = vec2(iResolution.x / iResolution.y, 1.);

    if(iFrame == 1){
        float ms = sqrt(float(COUNT));
        float yp = floor(float(x) / ms) - ms*.45;
        float xp = mod(float(x), ms) - ms*.45;
        vec2 pos = (vec2(xp,yp)) * (1./ms)*.9;

        pos *= rt;

        vec2 dir = normalize(vec2(hash12(fragCoord*200.)*2.-1., hash12(fragCoord * 100.)*2.-1.));

        if(y==0){
            fragColor = vec4(pos, dir);
        }
        if(y==1){
            fragColor = vec4(0., hash11(float(x)), 0., 0.);
        }

    } else {
        vec4 iPoint = FD(x,0);
        vec2 pos = iPoint.xy;
        vec2 dir = iPoint.zw;

        bool col = false;

        if(iPoint.x <= (-.5*rt.x + RADIUS)){
            dir.x *= -1.;
            col = true;
        }
        if(iPoint.x >= (.5*rt.x - RADIUS)){
            dir.x *= -1.;
            col = true;
        }
        if(iPoint.y <= (-.5*rt.y + RADIUS)){
            dir.y *= -1.;
            col = true;
        }
        if(iPoint.y >= (.5*rt.y - RADIUS)){
            dir.y *= -1.;
            col = true;
        }

        for(int i=0; i<COUNT; i+=1){
            if(i!=x){
                vec4 nPoint = FD(i,0);
                vec2 nPointDir = nPoint.zw;
                if(distance(nPoint.xy, pos) < (RADIUS*2.)){
                    vec2 inV = normalize(nPoint.xy - pos);
                    if(dot(dir, inV) > 0.){
                        dir = reflect(dir, inV);
                    }

                    col = true;
                }
            }
        }

        dir = normalize(dir);

        pos += dir * SPEED
            + vec2(
                snoise(vec3(fx, fx*100., iTime)),
                snoise(vec3(fx*33., fx*78., iTime))
            )*.005;
            // + vec2(sin(iTime*20. + hash11(float(x*25))), cos(iTime*10.  + hash11(float(x*100)))) * SPEED * .5;

        pos.x = min(max(pos.x, -.5*rt.x + RADIUS), .5*rt.x - RADIUS);
        pos.y = min(max(pos.y, -.5*rt.y + RADIUS), .5*rt.y - RADIUS);

        if(y==0){
            fragColor = vec4(pos, dir);
        } else if(y==1){
            float oColFactor = FD(x,1.).y;
            fragColor =  vec4(oColFactor + iTime*.25, oColFactor, 0, 0);
        }

    }
}

// --------- END-SHADER-TOY-CODE-HERE ------------

void main() { mainImage(gl_FragColor, vUV * iResolution.xy); }
`},216:function(we,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
uniform float iTime;
uniform vec2 iResolution;
uniform sampler2D iChannel0;
uniform sampler2D iChannel1;
uniform sampler2D iChannel2;
uniform sampler2D iChannel3;
uniform int iFrame;

varying vec3 vPosition;
varying vec2 vUV;

// --------- START-SHADER-TOY-CODE-HERE ------------

#define COL1 vec3(24, 32, 38) / 255.0
#define COL2 vec3(235, 241, 245) / 255.0

#define SF 2./min(iResolution.x, iResolution.y)
#define SS(l, s) smoothstep(SF, -SF, l - s)

void mainImage(out vec4 fragColor, in vec2 fragCoord)
{
    vec2 uv = (fragCoord - iResolution.xy * .5) / iResolution.y;
    vec2 ouv = fragCoord/iResolution.xy;

    float m = 0.;

    vec3 backCol = texture(iChannel1, ouv).xyz;
    vec3 col = backCol*.99;

    for (float i = 0.; i < float(COUNT); i += 1.) {
        vec4 point = FD(i, 0);
        vec4 colData = FD(i, 1);

        float pointColFactor = colData.x;

        vec2 pos = point.xy;

        float d = length(uv - pos);
        float g = SS(d, RADIUS);

        if(g > 0.){

        }
        col = mix(col, hue(pointColFactor).rgb, g);
    }

    fragColor = vec4(col, 1.0);
}

// --------- END-SHADER-TOY-CODE-HERE ------------

void main() { mainImage(gl_FragColor, vUV * iResolution.xy); }
`},25:function(we,P,u){"use strict";u.r(P);var S=u(445),R=u(449),U=u(498),O=u(475),x=u(506),G=u(648),T=u(435),h=u(441),f=u(455),d=u(704),g=u(446),p=u(451),_=u(549),m=u(212),l=u(213),y=u(214),E=u(215),A=u(216),F=(I,z,k)=>new Promise((j,w)=>{var Q=he=>{try{Y(k.next(he))}catch(le){w(le)}},W=he=>{try{Y(k.throw(he))}catch(le){w(le)}},Y=he=>he.done?j(he.value):Promise.resolve(he.value).then(Q,W);Y((k=k.apply(I,z)).next())});const B={animate:!0,context:Object(_.a)()};T.a.ShadersStore.bufferAVertexShader=m.default,T.a.ShadersStore.bufferAFragmentShader=`${l.default}
${E.default}`,T.a.ShadersStore.bufferBVertexShader=m.default,T.a.ShadersStore.bufferBFragmentShader=`${l.default}
${A.default}`,T.a.ShadersStore.imageVertexShader=m.default,T.a.ShadersStore.imageFragmentShader=`${l.default}
${y.default}`;const L=I=>F(void 0,[I],function*({canvas:z,width:k,height:j}){const w=new S.a(z,!0,{preserveDrawingBuffer:!0,stencil:!0}),Q=new R.a(w),W=(Ee,Te)=>{const se=new x.a("camera1",0,0,10,O.z.Zero(),Q);se.layerMask=Te,se.setTarget(O.z.Zero()),se.mode=p.a.ORTHOGRAPHIC_CAMERA,se.orthoTop=1,se.orthoBottom=-1,se.orthoLeft=-1,se.orthoRight=1;const ve=new U.a("hemiLight",new O.z(-1,1,0),Q);ve.diffuse=new h.a(1,1,1),ve.groundColor=new h.a(1,1,1),ve.specular=new h.a(0,0,0),ve.includeOnlyWithLayerMask=Te;const ye=new f.a("base",Q);ye.backFaceCulling=!0;const Le=g.a.CreateGround("ground1",2,2,1,Q);Le.material=ye,Le.layerMask=Te,Le.rotation.y=-Math.PI/2;const be=new d.RenderTargetTexture("render to texture",512,Q);return Q.customRenderTargets.push(be),be.activeCamera=se,be.renderList.push(Le),ye.diffuseTexture=Ee,be},Y=Math.PI/4,he=Math.PI/3,le=new x.a("camera",Y,he,3,new O.z(0,0,0),Q);le.setTarget(O.z.Zero()),le.attachControl(z,!0),Q.activeCamera=le;const J=new U.a("hemiLight",new O.z(-1,1,0),Q);J.diffuse=new h.a(1,1,1),J.groundColor=new h.a(1,1,1),J.specular=new h.a(0,0,0),Q.onNewLightAdded=(Ee,Te,se)=>{Ee.excludeWithLayerMask=268435456};const Re=new d.ProceduralTexture("bufferA",512,"bufferA",Q,null,!1,!1);Re.setTexture("iChannel0",W(Re,268435456));const Me=new d.ProceduralTexture("bufferB",512,"bufferB",Q,null,!1,!1);Me.setTexture("iChannel0",Re),Me.setTexture("iChannel1",W(Me,536870912));const me=new d.ProceduralTexture("image",512,"image",Q,null,!1,!1);me.setTexture("iChannel0",Re),me.setTexture("iChannel1",Me);const H=new f.a("mat",Q);H.diffuseTexture=Re;const q=G.a.CreateGround("ground1",{width:4,height:4,subdivisions:1},Q);q.material=H,q.material.backFaceCulling=!0;const _e=[Re,Me,me];return{render({time:Ee,frame:Te}){for(let se=0;se<_e.length;se+=1){const ve=_e[se];ve.setInt("iFrame",Te),ve.setFloat("iTime",Ee),ve.setVector2("iResolution",new O.y(1,1))}Q.render()},resize({pixelRatio:Ee,width:Te,height:se}){w.resize()},unload(){w.dispose()}}});P.default={sketch:L,settings:B}},444:function(we,P,u){"use strict";u.d(P,"a",function(){return d});var S=u(434),R=u(490),U=u(438),O=u(436),x=u(534),G=u(445),T=u(500),h=u(439),f=u(437),d=function(){function g(p,_,m,l,y,E,A,F,B,L,I,z,k,j,w){A===void 0&&(A=1),L===void 0&&(L=null),I===void 0&&(I=0),z===void 0&&(z="postprocess"),j===void 0&&(j=!1),w===void 0&&(w=5),this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this._textures=new R.a(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new O.d(1,1),this._texelSize=O.d.Zero(),this.onActivateObservable=new U.c,this.onSizeChangedObservable=new U.c,this.onApplyObservable=new U.c,this.onBeforeRenderObservable=new U.c,this.onAfterRenderObservable=new U.c,this.name=p,E!=null?(this._camera=E,this._scene=E.getScene(),E.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):F&&(this._engine=F,this._engine.postProcesses.push(this)),this._options=y,this.renderTargetSamplingMode=A||1,this._reusable=B||!1,this._textureType=I,this._textureFormat=w,this._samplers=l||[],this._samplers.push("textureSampler"),this._fragmentUrl=_,this._vertexUrl=z,this._parameters=m||[],this._parameters.push("scale"),this._indexParameters=k,j||this.updateEffect(L)}return Object.defineProperty(g.prototype,"samples",{get:function(){return this._samples},set:function(p){var _=this;this._samples=Math.min(p,this._engine.getCaps().maxMSAASamples),this._textures.forEach(function(m){m.samples!==_._samples&&_._engine.updateRenderTargetTextureSampleCount(m,_._samples)})},enumerable:!1,configurable:!0}),g.prototype.getEffectName=function(){return this._fragmentUrl},Object.defineProperty(g.prototype,"onActivate",{set:function(p){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),p&&(this._onActivateObserver=this.onActivateObservable.add(p))},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"onSizeChanged",{set:function(p){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(p)},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"onApply",{set:function(p){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(p)},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"onBeforeRender",{set:function(p){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(p)},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"onAfterRender",{set:function(p){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(p)},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"inputTexture",{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(p){this._forcedOutputTexture=p},enumerable:!1,configurable:!0}),g.prototype.restoreDefaultInputTexture=function(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())},g.prototype.getCamera=function(){return this._camera},Object.defineProperty(g.prototype,"texelSize",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)},enumerable:!1,configurable:!0}),g.prototype.getClassName=function(){return"PostProcess"},g.prototype.getEngine=function(){return this._engine},g.prototype.getEffect=function(){return this._effect},g.prototype.shareOutputWith=function(p){return this._disposeTextures(),this._shareOutputWithPostProcess=p,this},g.prototype.useOwnOutput=function(){this._textures.length==0&&(this._textures=new R.a(2)),this._shareOutputWithPostProcess=null},g.prototype.updateEffect=function(p,_,m,l,y,E,A,F){p===void 0&&(p=null),_===void 0&&(_=null),m===void 0&&(m=null),this._postProcessDefines=p,this._effect=this._engine.createEffect({vertex:A!=null?A:this._vertexUrl,fragment:F!=null?F:this._fragmentUrl},["position"],_||this._parameters,m||this._samplers,p!==null?p:"",void 0,y,E,l||this._indexParameters)},g.prototype.isReusable=function(){return this._reusable},g.prototype.markTextureDirty=function(){this.width=-1},g.prototype._createRenderTargetTexture=function(p,_,m){m===void 0&&(m=0);for(var l=0;l<this._textureCache.length;l++)if(this._textureCache[l].texture.width===p.width&&this._textureCache[l].texture.height===p.height&&this._textureCache[l].postProcessChannel===m)return this._textureCache[l].texture;var y=this._engine.createRenderTargetTexture(p,_);return this._textureCache.push({texture:y,postProcessChannel:m,lastUsedRenderId:-1}),y},g.prototype._flushTextureCache=function(){for(var p=this._renderId,_=this._textureCache.length-1;_>=0;_--)if(p-this._textureCache[_].lastUsedRenderId>100){for(var m=!1,l=0;l<this._textures.length;l++)if(this._textures.data[l]===this._textureCache[_].texture){m=!0;break}m||(this._engine._releaseTexture(this._textureCache[_].texture),this._textureCache.splice(_,1))}},g.prototype._resize=function(p,_,m,l,y){this._textures.length>0&&this._textures.reset(),this.width=p,this.height=_;var E={width:this.width,height:this.height},A={generateMipMaps:l,generateDepthBuffer:y||m._postProcesses.indexOf(this)===0,generateStencilBuffer:(y||m._postProcesses.indexOf(this)===0)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat};this._textures.push(this._createRenderTargetTexture(E,A,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(E,A,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)},g.prototype.activate=function(p,_,m){var l=this;_===void 0&&(_=null),p=p||this._camera;var y=p.getScene(),E=y.getEngine(),A=E.getCaps().maxTextureSize,F=(_?_.width:this._engine.getRenderWidth(!0))*this._options|0,B=(_?_.height:this._engine.getRenderHeight(!0))*this._options|0,L=p.parent;L&&(L.leftCamera==p||L.rightCamera==p)&&(F/=2);var I=this._options.width||F,z=this._options.height||B,k=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var j=E.currentViewport;j&&(I*=j.width,z*=j.height)}(k||this.alwaysForcePOT)&&(this._options.width||(I=E.needPOTTextures?G.a.GetExponentOfTwo(I,A,this.scaleMode):I),this._options.height||(z=E.needPOTTextures?G.a.GetExponentOfTwo(z,A,this.scaleMode):z)),(this.width!==I||this.height!==z)&&this._resize(I,z,p,k,m),this._textures.forEach(function(Y){Y.samples!==l.samples&&l._engine.updateRenderTargetTextureSampleCount(Y,l.samples)}),this._flushTextureCache(),this._renderId++}var w;if(this._shareOutputWithPostProcess)w=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)w=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{w=this.inputTexture;for(var Q=void 0,W=0;W<this._textureCache.length;W++)if(this._textureCache[W].texture===w){Q=this._textureCache[W];break}Q&&(Q.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(F/I,B/z),this._engine.bindFramebuffer(w,0,F,B,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(w,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker("post process "+this.name+" input"),this.onActivateObservable.notifyObservers(p),this.autoClear&&this.alphaMode===0&&this._engine.clear(this.clearColor?this.clearColor:y.clearColor,y._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),w},Object.defineProperty(g.prototype,"isSupported",{get:function(){return this._effect.isSupported},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"aspectRatio",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height},enumerable:!1,configurable:!0}),g.prototype.isReady=function(){return this._effect&&this._effect.isReady()},g.prototype.apply=function(){if(!this._effect||!this._effect.isReady())return null;this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);var p;return this._shareOutputWithPostProcess?p=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?p=this._forcedOutputTexture:p=this.inputTexture,this._effect._bindTexture("textureSampler",p),this._effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effect),this._effect},g.prototype._disposeTextures=function(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()},g.prototype._disposeTextureCache=function(){for(var p=this._textureCache.length-1;p>=0;p--)this._engine._releaseTexture(this._textureCache[p].texture);this._textureCache.length=0},g.prototype.setPrePassRenderer=function(p){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=p.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1},g.prototype.dispose=function(p){p=p||this._camera,this._disposeTextures();var _;if(this._scene&&(_=this._scene.postProcesses.indexOf(this),_!==-1&&this._scene.postProcesses.splice(_,1)),_=this._engine.postProcesses.indexOf(this),_!==-1&&this._engine.postProcesses.splice(_,1),!!p){if(p.detachPostProcess(this),_=p._postProcesses.indexOf(this),_===0&&p._postProcesses.length>0){var m=this._camera._getFirstPostProcess();m&&m.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}},g.prototype.serialize=function(){var p=h.a.Serialize(this),_=this.getCamera()||this._scene&&this._scene.activeCamera;return p.customType="BABYLON."+this.getClassName(),p.cameraId=_?_.id:null,p.reusable=this._reusable,p.textureType=this._textureType,p.fragmentUrl=this._fragmentUrl,p.parameters=this._parameters,p.samplers=this._samplers,p.options=this._options,p.defines=this._postProcessDefines,p.textureFormat=this._textureFormat,p.vertexUrl=this._vertexUrl,p.indexParameters=this._indexParameters,p},g.prototype.clone=function(){var p=this.serialize();p._engine=this._engine,p.cameraId=null;var _=g.Parse(p,this._scene,"");return _?(_.onActivateObservable=this.onActivateObservable.clone(),_.onSizeChangedObservable=this.onSizeChangedObservable.clone(),_.onApplyObservable=this.onApplyObservable.clone(),_.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),_.onAfterRenderObservable=this.onAfterRenderObservable.clone(),_._prePassEffectConfiguration=this._prePassEffectConfiguration,_):null},g.Parse=function(p,_,m){var l=f.a.GetClass(p.customType);if(!l||!l._Parse)return null;var y=_?_.getCameraByID(p.cameraId):null;return l._Parse(p,y,_,m)},g._Parse=function(p,_,m,l){return h.a.Parse(function(){return new g(p.name,p.fragmentUrl,p.parameters,p.samplers,p.options,_,p.renderTargetSamplingMode,p._engine,p.reusable,p.defines,p.textureType,p.vertexUrl,p.indexParameters,!1,p.textureFormat)},p,m,l)},Object(S.c)([Object(h.c)()],g.prototype,"uniqueId",void 0),Object(S.c)([Object(h.c)()],g.prototype,"name",void 0),Object(S.c)([Object(h.c)()],g.prototype,"width",void 0),Object(S.c)([Object(h.c)()],g.prototype,"height",void 0),Object(S.c)([Object(h.c)()],g.prototype,"renderTargetSamplingMode",void 0),Object(S.c)([Object(h.f)()],g.prototype,"clearColor",void 0),Object(S.c)([Object(h.c)()],g.prototype,"autoClear",void 0),Object(S.c)([Object(h.c)()],g.prototype,"alphaMode",void 0),Object(S.c)([Object(h.c)()],g.prototype,"alphaConstants",void 0),Object(S.c)([Object(h.c)()],g.prototype,"enablePixelPerfectMode",void 0),Object(S.c)([Object(h.c)()],g.prototype,"forceFullscreenViewport",void 0),Object(S.c)([Object(h.c)()],g.prototype,"scaleMode",void 0),Object(S.c)([Object(h.c)()],g.prototype,"alwaysForcePOT",void 0),Object(S.c)([Object(h.c)("samples")],g.prototype,"_samples",void 0),Object(S.c)([Object(h.c)()],g.prototype,"adaptScaleToCurrentViewport",void 0),g}();f.a.RegisteredTypes["BABYLON.PostProcess"]=d},458:function(we,P,u){"use strict";u.d(P,"a",function(){return g});var S=u(434),R=u(438),U=u(443),O=u(436),x=u(442),G=u(590),T=u(591),h=u(500),f=u(522),d=u(445),g=function(p){Object(S.d)(_,p);function _(m,l,y,E,A,F,B,L,I,z,k,j,w,Q){A===void 0&&(A=!0),F===void 0&&(F=0),B===void 0&&(B=!1),L===void 0&&(L=x.a.TRILINEAR_SAMPLINGMODE),I===void 0&&(I=!0),z===void 0&&(z=!1),k===void 0&&(k=!1),j===void 0&&(j=5),w===void 0&&(w=!1);var W,Y=p.call(this,null,y,!E,void 0,L,void 0,void 0,void 0,void 0,j)||this;return Y.renderParticles=!0,Y.renderSprites=!1,Y.ignoreCameraViewport=!1,Y.onBeforeBindObservable=new R.c,Y.onAfterUnbindObservable=new R.c,Y.onBeforeRenderObservable=new R.c,Y.onAfterRenderObservable=new R.c,Y.onClearObservable=new R.c,Y.onResizeObservable=new R.c,Y._currentRefreshId=-1,Y._refreshRate=1,Y._samples=1,Y.boundingBoxPosition=O.e.Zero(),y=Y.getScene(),!y||(Y._coordinatesMode=x.a.PROJECTION_MODE,Y.renderList=new Array,Y.name=m,Y.isRenderTarget=!0,Y._initialSizeParameter=l,Y._processSizeParameter(l),Y._resizeObserver=Y.getScene().getEngine().onResizeObservable.add(function(){}),Y._generateMipMaps=!!E,Y._doNotChangeAspectRatio=A,Y._renderingManager=new T.b(y),Y._renderingManager._useSceneAutoClearSetup=!0,k)||(Y._renderTargetOptions={generateMipMaps:E,type:F,format:(W=Y._format)!==null&&W!==void 0?W:void 0,samplingMode:Y.samplingMode,generateDepthBuffer:I,generateStencilBuffer:z,samples:Q},Y.samplingMode===x.a.NEAREST_SAMPLINGMODE&&(Y.wrapU=x.a.CLAMP_ADDRESSMODE,Y.wrapV=x.a.CLAMP_ADDRESSMODE),w||(B?(Y._texture=y.getEngine().createRenderTargetCubeTexture(Y.getRenderSize(),Y._renderTargetOptions),Y.coordinatesMode=x.a.INVCUBIC_MODE,Y._textureMatrix=O.a.Identity()):Y._texture=y.getEngine().createRenderTargetTexture(Y._size,Y._renderTargetOptions),Q!==void 0&&(Y.samples=Q))),Y}return Object.defineProperty(_.prototype,"renderList",{get:function(){return this._renderList},set:function(m){this._renderList=m,this._renderList&&this._hookArray(this._renderList)},enumerable:!1,configurable:!0}),_.prototype._hookArray=function(m){var l=this,y=m.push;m.push=function(){for(var A=[],F=0;F<arguments.length;F++)A[F]=arguments[F];var B=m.length===0,L=y.apply(m,A);return B&&l.getScene()&&l.getScene().meshes.forEach(function(I){I._markSubMeshesAsLightDirty()}),L};var E=m.splice;m.splice=function(A,F){var B=E.apply(m,[A,F]);return m.length===0&&l.getScene().meshes.forEach(function(L){L._markSubMeshesAsLightDirty()}),B}},Object.defineProperty(_.prototype,"postProcesses",{get:function(){return this._postProcesses},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"_prePassEnabled",{get:function(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"onAfterUnbind",{set:function(m){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(m)},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"onBeforeRender",{set:function(m){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(m)},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"onAfterRender",{set:function(m){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(m)},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"onClear",{set:function(m){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(m)},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"renderTargetOptions",{get:function(){return this._renderTargetOptions},enumerable:!1,configurable:!0}),_.prototype._onRatioRescale=function(){this._sizeRatio&&this.resize(this._initialSizeParameter)},Object.defineProperty(_.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(m){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(m))){this._boundingBoxSize=m;var l=this.getScene();l&&l.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"depthStencilTexture",{get:function(){var m;return((m=this.getInternalTexture())===null||m===void 0?void 0:m._depthStencilTexture)||null},enumerable:!1,configurable:!0}),_.prototype.createDepthStencilTexture=function(m,l,y,E){var A;m===void 0&&(m=0),l===void 0&&(l=!0),y===void 0&&(y=!1),E===void 0&&(E=1);var F=this.getInternalTexture();if(!(!this.getScene()||!F)){(A=F._depthStencilTexture)===null||A===void 0||A.dispose();var B=this.getScene().getEngine();F._depthStencilTexture=B.createDepthStencilTexture(this._size,{bilinearFiltering:l,comparisonFunction:m,generateStencil:y,isCube:this.isCube,samples:E})}},_.prototype._processSizeParameter=function(m){if(m.ratio){this._sizeRatio=m.ratio;var l=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(l.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(l.getRenderHeight(),this._sizeRatio)}}else this._size=m},Object.defineProperty(_.prototype,"samples",{get:function(){return this._samples},set:function(m){if(this._samples!==m){var l=this.getScene();!l||(this._samples=l.getEngine().updateRenderTargetTextureSampleCount(this._texture,m))}},enumerable:!1,configurable:!0}),_.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(_.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(m){this._refreshRate=m,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),_.prototype.addPostProcess=function(m){if(!this._postProcessManager){var l=this.getScene();if(!l)return;this._postProcessManager=new G.a(l),this._postProcesses=new Array}this._postProcesses.push(m),this._postProcesses[0].autoClear=!1},_.prototype.clearPostProcesses=function(m){if(m===void 0&&(m=!1),!!this._postProcesses){if(m)for(var l=0,y=this._postProcesses;l<y.length;l++){var E=y[l];E.dispose()}this._postProcesses=[]}},_.prototype.removePostProcess=function(m){if(!!this._postProcesses){var l=this._postProcesses.indexOf(m);l!==-1&&(this._postProcesses.splice(l,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}},_.prototype._shouldRender=function(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},_.prototype.getRenderSize=function(){return this.getRenderWidth()},_.prototype.getRenderWidth=function(){return this._size.width?this._size.width:this._size},_.prototype.getRenderHeight=function(){return this._size.width?this._size.height:this._size},_.prototype.getRenderLayers=function(){var m=this._size.layers;return m||0},Object.defineProperty(_.prototype,"canRescale",{get:function(){return!0},enumerable:!1,configurable:!0}),_.prototype.scale=function(m){var l=Math.max(1,this.getRenderSize()*m);this.resize(l)},_.prototype.getReflectionTextureMatrix=function(){return this.isCube?this._textureMatrix:p.prototype.getReflectionTextureMatrix.call(this)},_.prototype.resize=function(m){var l=this.isCube;this.releaseInternalTexture();var y=this.getScene();!y||(this._processSizeParameter(m),l?this._texture=y.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._texture=y.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))},_.prototype.render=function(m,l){m===void 0&&(m=!1),l===void 0&&(l=!1);var y=this.getScene();if(!!y){var E=y.getEngine();if(this.useCameraPostProcesses!==void 0&&(m=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(var A=0;A<this._waitingRenderList.length;A++){var F=this._waitingRenderList[A],B=y.getMeshByID(F);B&&this.renderList.push(B)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];var y=this.getScene();if(!y)return;for(var L=y.meshes,A=0;A<L.length;A++){var I=L[A];this.renderListPredicate(I)&&this.renderList.push(I)}}this.onBeforeBindObservable.notifyObservers(this);var z;if(this.activeCamera?(z=this.activeCamera,E.setViewport(this.activeCamera.viewport,this.getRenderWidth(),this.getRenderHeight()),this.activeCamera!==y.activeCamera&&y.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(!0))):(z=y.activeCamera,z&&E.setViewport(z.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1,this.is2DArray)for(var k=0;k<this.getRenderLayers();k++)this.renderToTarget(0,m,l,k,z),y.incrementRenderId(),y.resetCachedMaterial();else if(this.isCube)for(var j=0;j<6;j++)this.renderToTarget(j,m,l,void 0,z),y.incrementRenderId(),y.resetCachedMaterial();else this.renderToTarget(0,m,l,void 0,z);this.onAfterUnbindObservable.notifyObservers(this),y.activeCamera&&((y.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==y.activeCamera)&&y.setTransformMatrix(y.activeCamera.getViewMatrix(),y.activeCamera.getProjectionMatrix(!0)),E.setViewport(y.activeCamera.viewport)),y.resetCachedMaterial()}},_.prototype._bestReflectionRenderTargetDimension=function(m,l){var y=128,E=m*l,A=d.a.NearestPOT(E+y*y/(y+E));return Math.min(d.a.FloorPOT(m),A)},_.prototype._prepareRenderingManager=function(m,l,y,E){var A=this.getScene();if(!!A){this._renderingManager.reset();for(var F=A.getRenderId(),B=0;B<l;B++){var L=m[B];if(L&&!L.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(L,this.refreshRate)){this.resetRefreshCounter();continue}}else if(!L.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!L._internalAbstractMeshDataInfo._currentLODIsUpToDate&&A.activeCamera&&(L._internalAbstractMeshDataInfo._currentLOD=A.customLODSelector?A.customLODSelector(L,A.activeCamera):L.getLOD(A.activeCamera),L._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!L._internalAbstractMeshDataInfo._currentLOD)continue;var I=L._internalAbstractMeshDataInfo._currentLOD;I._preActivateForIntermediateRendering(F);var z=void 0;if(E&&y?z=(L.layerMask&y.layerMask)==0:z=!1,L.isEnabled()&&L.isVisible&&L.subMeshes&&!z&&(I!==L&&I._activate(F,!0),L._activate(F,!0)&&L.subMeshes.length)){L.isAnInstance?L._internalAbstractMeshDataInfo._actAsRegularMesh&&(I=L):I._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,I._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(var k=0;k<I.subMeshes.length;k++){var j=I.subMeshes[k];this._renderingManager.dispatch(j,I)}}}}for(var w=0;w<A.particleSystems.length;w++){var Q=A.particleSystems[w],W=Q.emitter;!Q.isStarted()||!W||!W.position||!W.isEnabled()||m.indexOf(W)>=0&&this._renderingManager.dispatchParticles(Q)}}},_.prototype._bindFrameBuffer=function(m,l){m===void 0&&(m=0),l===void 0&&(l=0);var y=this.getScene();if(!!y){var E=y.getEngine();this._texture&&E.bindFramebuffer(this._texture,this.isCube?m:void 0,void 0,void 0,this.ignoreCameraViewport,0,l)}},_.prototype.unbindFrameBuffer=function(m,l){var y=this;!this._texture||m.unBindFramebuffer(this._texture,this.isCube,function(){y.onAfterRenderObservable.notifyObservers(l)})},_.prototype._prepareFrame=function(m,l,y,E){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!E||!m.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(l,y)},_.prototype.renderToTarget=function(m,l,y,E,A){E===void 0&&(E=0),A===void 0&&(A=null);var F=this.getScene();if(!!F){var B=F.getEngine();if(!!this._texture){B._debugPushGroup("render to face #"+m+" layer #"+E,1),this._prepareFrame(F,m,E,l),this.is2DArray?this.onBeforeRenderObservable.notifyObservers(E):this.onBeforeRenderObservable.notifyObservers(m);var L=null,I=this.renderList?this.renderList:F.getActiveMeshes().data,z=this.renderList?this.renderList.length:F.getActiveMeshes().length;this.getCustomRenderList&&(L=this.getCustomRenderList(this.is2DArray?E:m,I,z)),L?this._prepareRenderingManager(L,L.length,A,!1):(this._defaultRenderListPrepared||(this._prepareRenderingManager(I,z,A,!this.renderList),this._defaultRenderListPrepared=!0),L=I);for(var k=0,j=F._beforeRenderTargetClearStage;k<j.length;k++){var w=j[k];w.action(this,m,E)}this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(B):B.clear(this.clearColor||F.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||F.updateTransformMatrix(!0);for(var Q=0,W=F._beforeRenderTargetDrawStage;Q<W.length;Q++){var w=W[Q];w.action(this,m,E)}this._renderingManager.render(this.customRenderFunction,L,this.renderParticles,this.renderSprites);for(var Y=0,he=F._afterRenderTargetDrawStage;Y<he.length;Y++){var w=he[Y];w.action(this,m,E)}var le=this._texture.generateMipMaps;this._texture.generateMipMaps=!1,this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._texture,m,this._postProcesses,this.ignoreCameraViewport):l&&F.postProcessManager._finalizeFrame(!1,this._texture,m),this._texture.generateMipMaps=le,this._doNotChangeAspectRatio||F.updateTransformMatrix(!0),y&&U.b.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),B),this.unbindFrameBuffer(B,m),this.isCube&&m===5&&B.generateMipMapsForCubemap(this._texture),B._debugPopGroup(1)}}},_.prototype.setRenderingOrder=function(m,l,y,E){l===void 0&&(l=null),y===void 0&&(y=null),E===void 0&&(E=null),this._renderingManager.setRenderingOrder(m,l,y,E)},_.prototype.setRenderingAutoClearDepthStencil=function(m,l){this._renderingManager.setRenderingAutoClearDepthStencil(m,l),this._renderingManager._useSceneAutoClearSetup=!1},_.prototype.clone=function(){var m=this.getSize(),l=new _(this.name,m,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return l.hasAlpha=this.hasAlpha,l.level=this.level,l.coordinatesMode=this.coordinatesMode,this.renderList&&(l.renderList=this.renderList.slice(0)),l},_.prototype.serialize=function(){if(!this.name)return null;var m=p.prototype.serialize.call(this);if(m.renderTargetSize=this.getRenderSize(),m.renderList=[],this.renderList)for(var l=0;l<this.renderList.length;l++)m.renderList.push(this.renderList[l].id);return m},_.prototype.disposeFramebufferObjects=function(){var m=this.getInternalTexture(),l=this.getScene();m&&l&&l.getEngine()._releaseFramebufferObjects(m)},_.prototype.dispose=function(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;var m=this.getScene();if(!!m){var l=m.customRenderTargets.indexOf(this);l>=0&&m.customRenderTargets.splice(l,1);for(var y=0,E=m.cameras;y<E.length;y++){var A=E[y];l=A.customRenderTargets.indexOf(this),l>=0&&A.customRenderTargets.splice(l,1)}this.depthStencilTexture&&this.getScene().getEngine()._releaseTexture(this.depthStencilTexture),p.prototype.dispose.call(this)}},_.prototype._rebuild=function(){this.refreshRate===_.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=_.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()},_.prototype.freeRenderingGroups=function(){this._renderingManager&&this._renderingManager.freeRenderingGroups()},_.prototype.getViewCount=function(){return 1},_.REFRESHRATE_RENDER_ONCE=0,_.REFRESHRATE_RENDER_ONEVERYFRAME=1,_.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,_}(x.a);x.a._CreateRenderTargetTexture=function(p,_,m,l){return new g(p,_,m,l)}},461:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(449),R=u(438),U=u(464),O=u(448),x=u(498),G=u(436),T=u(441),h=function(){function f(d,g){var p=this;g===void 0&&(g=!0),this.originalScene=d,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.onPointerOutObservable=new R.c,this.utilityLayerScene=new S.a(d.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=d.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.detachControl(),g&&(this._originalPointerObserver=d.onPrePointerObservable.add(function(_,m){if(!!p.utilityLayerScene.activeCamera&&!(!p.processAllEvents&&_.type!==U.a.POINTERMOVE&&_.type!==U.a.POINTERUP&&_.type!==U.a.POINTERDOWN&&_.type!==U.a.POINTERDOUBLETAP)){p.utilityLayerScene.pointerX=d.pointerX,p.utilityLayerScene.pointerY=d.pointerY;var l=_.event;if(d.isPointerCaptured(l.pointerId)){p._pointerCaptures[l.pointerId]=!1;return}var y=_.ray?p.utilityLayerScene.pickWithRay(_.ray):p.utilityLayerScene.pick(d.pointerX,d.pointerY);if(!_.ray&&y&&(_.ray=y.ray),p.utilityLayerScene.onPrePointerObservable.notifyObservers(_),p.onlyCheckPointerDownEvents&&_.type!=U.a.POINTERDOWN){_.skipOnPointerObservable||p.utilityLayerScene.onPointerObservable.notifyObservers(new U.b(_.type,_.event,y),_.type),_.type===U.a.POINTERUP&&p._pointerCaptures[l.pointerId]&&(p._pointerCaptures[l.pointerId]=!1);return}if(p.utilityLayerScene.autoClearDepthAndStencil||p.pickUtilitySceneFirst)y&&y.hit&&(_.skipOnPointerObservable||p.utilityLayerScene.onPointerObservable.notifyObservers(new U.b(_.type,_.event,y),_.type),_.skipOnPointerObservable=!0);else{var E=_.ray?d.pickWithRay(_.ray):d.pick(d.pointerX,d.pointerY),A=_.event;E&&y&&(y.distance===0&&E.pickedMesh?p.mainSceneTrackerPredicate&&p.mainSceneTrackerPredicate(E.pickedMesh)?(p._notifyObservers(_,E,A),_.skipOnPointerObservable=!0):_.type===U.a.POINTERDOWN?p._pointerCaptures[A.pointerId]=!0:p._lastPointerEvents[A.pointerId]&&(p.onPointerOutObservable.notifyObservers(A.pointerId),delete p._lastPointerEvents[A.pointerId]):!p._pointerCaptures[A.pointerId]&&(y.distance<E.distance||E.distance===0)?(p._notifyObservers(_,y,A),_.skipOnPointerObservable||(_.skipOnPointerObservable=y.distance>0)):!p._pointerCaptures[A.pointerId]&&y.distance>E.distance&&(p.mainSceneTrackerPredicate&&p.mainSceneTrackerPredicate(E.pickedMesh)?(p._notifyObservers(_,E,A),_.skipOnPointerObservable=!0):p._lastPointerEvents[A.pointerId]&&(p.onPointerOutObservable.notifyObservers(A.pointerId),delete p._lastPointerEvents[A.pointerId])),_.type===U.a.POINTERUP&&p._pointerCaptures[A.pointerId]&&(p._pointerCaptures[A.pointerId]=!1))}}}),this._originalPointerObserver&&d.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterCameraRenderObservable.add(function(_){p.shouldRender&&_==p.getRenderCamera()&&p.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(function(){p.dispose()}),this._updateCamera()}return f.prototype.getRenderCamera=function(d){if(this._renderCamera)return this._renderCamera;var g=void 0;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?g=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:g=this.originalScene.activeCamera,d&&g&&g.isRigCamera?g.rigParent:g},f.prototype.setRenderCamera=function(d){this._renderCamera=d},f.prototype._getSharedGizmoLight=function(){return this._sharedGizmoLight||(this._sharedGizmoLight=new x.a("shared gizmo light",new G.e(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=T.a.Gray()),this._sharedGizmoLight},Object.defineProperty(f,"DefaultUtilityLayer",{get:function(){return f._DefaultUtilityLayer==null&&(f._DefaultUtilityLayer=new f(O.a.LastCreatedScene),f._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(function(){f._DefaultUtilityLayer=null})),f._DefaultUtilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(f,"DefaultKeepDepthUtilityLayer",{get:function(){return f._DefaultKeepDepthUtilityLayer==null&&(f._DefaultKeepDepthUtilityLayer=new f(O.a.LastCreatedScene),f._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,f._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(function(){f._DefaultKeepDepthUtilityLayer=null})),f._DefaultKeepDepthUtilityLayer},enumerable:!1,configurable:!0}),f.prototype._notifyObservers=function(d,g,p){d.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new U.b(d.type,d.event,g),d.type),this._lastPointerEvents[p.pointerId]=!0)},f.prototype.render=function(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){var d=this.utilityLayerScene.activeCamera.getScene(),g=this.utilityLayerScene.activeCamera;g._scene=this.utilityLayerScene,g.leftCamera&&(g.leftCamera._scene=this.utilityLayerScene),g.rightCamera&&(g.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),g._scene=d,g.leftCamera&&(g.leftCamera._scene=d),g.rightCamera&&(g.rightCamera._scene=d)}},f.prototype.dispose=function(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()},f.prototype._updateCamera=function(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()},f._DefaultUtilityLayer=null,f._DefaultKeepDepthUtilityLayer=null,f}()},463:function(we,P,u){"use strict";u.d(P,"b",function(){return d}),u.d(P,"a",function(){return g});var S=u(443),R=u(438),U=u(611),O=u(449),x=u(445),G=u(448),T=u(440),h=u(668),f=u(473),d;(function(p){p[p.Clean=0]="Clean",p[p.Stop=1]="Stop",p[p.Sync=2]="Sync",p[p.NoSync=3]="NoSync"})(d||(d={}));var g=function(){function p(){}return Object.defineProperty(p,"ForceFullSceneLoadingForIncremental",{get:function(){return h.a.ForceFullSceneLoadingForIncremental},set:function(_){h.a.ForceFullSceneLoadingForIncremental=_},enumerable:!1,configurable:!0}),Object.defineProperty(p,"ShowLoadingScreen",{get:function(){return h.a.ShowLoadingScreen},set:function(_){h.a.ShowLoadingScreen=_},enumerable:!1,configurable:!0}),Object.defineProperty(p,"loggingLevel",{get:function(){return h.a.loggingLevel},set:function(_){h.a.loggingLevel=_},enumerable:!1,configurable:!0}),Object.defineProperty(p,"CleanBoneMatrixWeights",{get:function(){return h.a.CleanBoneMatrixWeights},set:function(_){h.a.CleanBoneMatrixWeights=_},enumerable:!1,configurable:!0}),p.GetDefaultPlugin=function(){return p._registeredPlugins[".babylon"]},p._GetPluginForExtension=function(_){var m=p._registeredPlugins[_];return m||(T.a.Warn("Unable to find a plugin to load "+_+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/how_to/load_from_any_file_type"),p.GetDefaultPlugin())},p._GetPluginForDirectLoad=function(_){for(var m in p._registeredPlugins){var l=p._registeredPlugins[m].plugin;if(l.canDirectLoad&&l.canDirectLoad(_))return p._registeredPlugins[m]}return p.GetDefaultPlugin()},p._GetPluginForFilename=function(_){var m=_.indexOf("?");m!==-1&&(_=_.substring(0,m));var l=_.lastIndexOf("."),y=_.substring(l,_.length).toLowerCase();return p._GetPluginForExtension(y)},p._GetDirectLoad=function(_){return _.substr(0,5)==="data:"?_.substr(5):null},p._LoadData=function(_,m,l,y,E,A,F){var B=p._GetDirectLoad(_.url),L=F?p._GetPluginForExtension(F):B?p._GetPluginForDirectLoad(_.url):p._GetPluginForFilename(_.url),I;if(L.plugin.createPlugin!==void 0?I=L.plugin.createPlugin():I=L.plugin,!I)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(p.OnPluginActivatedObservable.notifyObservers(I),B){if(I.directLoad){var z=I.directLoad(m,B);z.then?z.then(function(q){l(I,q)}).catch(function(q){E("Error in directLoad of _loadData: "+q,q)}):l(I,z)}else l(I,B);return I}var k=L.isBinary,j=function(q,_e){if(m.isDisposed){E("Scene has been disposed");return}l(I,q,_e)},w=null,Q=!1,W=I.onDisposeObservable;W&&W.add(function(){Q=!0,w&&(w.abort(),w=null),A()});var Y=function(){if(!Q){var q=function(Ee,Te){j(Ee,Te?Te.responseURL:void 0)},_e=function(Ee){E(Ee.message,Ee)};w=I.requestFile?I.requestFile(m,_.url,q,y,k,_e):m._requestFile(_.url,q,y,!0,k,_e)}};if(f.a.StartsWith(_.url,"file:"))if(_.file){var he=function(q){E(q.message,q)};w=I.readFile?I.readFile(m,_.file,j,y,k,he):m._readFile(_.file,j,y,k,he)}else E("Unable to find file named "+_.name);else{var le=m.getEngine(),J=le.enableOfflineSupport;if(J){for(var Re=!1,Me=0,me=m.disableOfflineSupportExceptionRules;Me<me.length;Me++){var H=me[Me];if(H.test(_.url)){Re=!0;break}}J=!Re}J&&x.a.OfflineProviderFactory?m.offlineProvider=x.a.OfflineProviderFactory(_.url,Y,le.disableManifestCheck):Y()}return I},p._GetFileInfo=function(_,m){var l,y,E=null;if(!m)l=_,y=S.b.GetFilename(_),_=S.b.GetFolderPath(_);else if(m.name){var A=m;l=_+A.name,y=A.name,E=A}else if(typeof m=="string"&&f.a.StartsWith(m,"data:"))l=m,y="";else{var F=m;if(F.substr(0,1)==="/")return S.b.Error("Wrong sceneFilename parameter"),null;l=_+F,y=F}return!E&&y&&f.a.StartsWith(l,"file:")&&(E=U.a.FilesToLoad[y.toLowerCase()]||null),{url:l,rootUrl:_,name:y,file:E}},p.GetPluginForExtension=function(_){return p._GetPluginForExtension(_).plugin},p.IsPluginForExtensionAvailable=function(_){return!!p._registeredPlugins[_]},p.RegisterPlugin=function(_){if(typeof _.extensions=="string"){var m=_.extensions;p._registeredPlugins[m.toLowerCase()]={plugin:_,isBinary:!1}}else{var l=_.extensions;Object.keys(l).forEach(function(y){p._registeredPlugins[y.toLowerCase()]={plugin:_,isBinary:l[y].isBinary}})}},p.ImportMesh=function(_,m,l,y,E,A,F,B){if(l===void 0&&(l=""),y===void 0&&(y=G.a.LastCreatedScene),E===void 0&&(E=null),A===void 0&&(A=null),F===void 0&&(F=null),B===void 0&&(B=null),!y)return T.a.Error("No scene available to import mesh to"),null;var L=p._GetFileInfo(m,l);if(!L)return null;var I={};y._addPendingData(I);var z=function(){y._removePendingData(I)},k=function(Q,W){var Y="Unable to import meshes from "+L.url+": "+Q;F?F(y,Y,W):T.a.Error(Y),z()},j=A?function(Q){try{A(Q)}catch(W){k("Error in onProgress callback: "+W,W)}}:void 0,w=function(Q,W,Y,he,le,J,Re){if(y.importedMeshesFiles.push(L.url),E)try{E(Q,W,Y,he,le,J,Re)}catch(Me){k("Error in onSuccess callback: "+Me,Me)}y._removePendingData(I)};return p._LoadData(L,y,function(Q,W,Y){if(Q.rewriteRootURL&&(L.rootUrl=Q.rewriteRootURL(L.rootUrl,Y)),Q.importMesh){var he=Q,le=new Array,J=new Array,Re=new Array;if(!he.importMesh(_,y,W,L.rootUrl,le,J,Re,k))return;y.loadingPluginName=Q.name,w(le,J,Re,[],[],[],[])}else{var Me=Q;Me.importMeshAsync(_,y,W,L.rootUrl,j,L.name).then(function(me){y.loadingPluginName=Q.name,w(me.meshes,me.particleSystems,me.skeletons,me.animationGroups,me.transformNodes,me.geometries,me.lights)}).catch(function(me){k(me.message,me)})}},j,k,z,B)},p.ImportMeshAsync=function(_,m,l,y,E,A){return l===void 0&&(l=""),y===void 0&&(y=G.a.LastCreatedScene),E===void 0&&(E=null),A===void 0&&(A=null),new Promise(function(F,B){p.ImportMesh(_,m,l,y,function(L,I,z,k,j,w,Q){F({meshes:L,particleSystems:I,skeletons:z,animationGroups:k,transformNodes:j,geometries:w,lights:Q})},E,function(L,I,z){B(z||new Error(I))},A)})},p.Load=function(_,m,l,y,E,A,F){return m===void 0&&(m=""),l===void 0&&(l=G.a.LastCreatedEngine),y===void 0&&(y=null),E===void 0&&(E=null),A===void 0&&(A=null),F===void 0&&(F=null),l?p.Append(_,m,new O.a(l),y,E,A,F):(S.b.Error("No engine available"),null)},p.LoadAsync=function(_,m,l,y,E){return m===void 0&&(m=""),l===void 0&&(l=G.a.LastCreatedEngine),y===void 0&&(y=null),E===void 0&&(E=null),new Promise(function(A,F){p.Load(_,m,l,function(B){A(B)},y,function(B,L,I){F(I||new Error(L))},E)})},p.Append=function(_,m,l,y,E,A,F){var B=this;if(m===void 0&&(m=""),l===void 0&&(l=G.a.LastCreatedScene),y===void 0&&(y=null),E===void 0&&(E=null),A===void 0&&(A=null),F===void 0&&(F=null),!l)return T.a.Error("No scene available to append to"),null;var L=p._GetFileInfo(_,m);if(!L)return null;p.ShowLoadingScreen&&!this._showingLoadingScreen&&(this._showingLoadingScreen=!0,l.getEngine().displayLoadingUI(),l.executeWhenReady(function(){l.getEngine().hideLoadingUI(),B._showingLoadingScreen=!1}));var I={};l._addPendingData(I);var z=function(){l._removePendingData(I)},k=function(Q,W){var Y="Unable to load from "+L.url+(Q?": "+Q:"");A?A(l,Y,W):T.a.Error(Y),z()},j=E?function(Q){try{E(Q)}catch(W){k("Error in onProgress callback",W)}}:void 0,w=function(){if(y)try{y(l)}catch(Q){k("Error in onSuccess callback",Q)}l._removePendingData(I)};return p._LoadData(L,l,function(Q,W){if(Q.load){var Y=Q;if(!Y.load(l,W,L.rootUrl,k))return;l.loadingPluginName=Q.name,w()}else{var he=Q;he.loadAsync(l,W,L.rootUrl,j,L.name).then(function(){l.loadingPluginName=Q.name,w()}).catch(function(le){k(le.message,le)})}},j,k,z,F)},p.AppendAsync=function(_,m,l,y,E){return m===void 0&&(m=""),l===void 0&&(l=G.a.LastCreatedScene),y===void 0&&(y=null),E===void 0&&(E=null),new Promise(function(A,F){p.Append(_,m,l,function(B){A(B)},y,function(B,L,I){F(I||new Error(L))},E)})},p.LoadAssetContainer=function(_,m,l,y,E,A,F){if(m===void 0&&(m=""),l===void 0&&(l=G.a.LastCreatedScene),y===void 0&&(y=null),E===void 0&&(E=null),A===void 0&&(A=null),F===void 0&&(F=null),!l)return T.a.Error("No scene available to load asset container to"),null;var B=p._GetFileInfo(_,m);if(!B)return null;var L={};l._addPendingData(L);var I=function(){l._removePendingData(L)},z=function(w,Q){var W="Unable to load assets from "+B.url+(w?": "+w:"");Q&&Q.message&&(W+=" ("+Q.message+")"),A?A(l,W,Q):T.a.Error(W),I()},k=E?function(w){try{E(w)}catch(Q){z("Error in onProgress callback",Q)}}:void 0,j=function(w){if(y)try{y(w)}catch(Q){z("Error in onSuccess callback",Q)}l._removePendingData(L)};return p._LoadData(B,l,function(w,Q){if(w.loadAssetContainer){var W=w,Y=W.loadAssetContainer(l,Q,B.rootUrl,z);if(!Y)return;l.loadingPluginName=w.name,j(Y)}else if(w.loadAssetContainerAsync){var he=w;he.loadAssetContainerAsync(l,Q,B.rootUrl,k,B.name).then(function(le){l.loadingPluginName=w.name,j(le)}).catch(function(le){z(le.message,le)})}else z("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},k,z,I,F)},p.LoadAssetContainerAsync=function(_,m,l,y,E){return m===void 0&&(m=""),l===void 0&&(l=G.a.LastCreatedScene),y===void 0&&(y=null),E===void 0&&(E=null),new Promise(function(A,F){p.LoadAssetContainer(_,m,l,function(B){A(B)},y,function(B,L,I){F(I||new Error(L))},E)})},p.ImportAnimations=function(_,m,l,y,E,A,F,B,L,I){if(m===void 0&&(m=""),l===void 0&&(l=G.a.LastCreatedScene),y===void 0&&(y=!0),E===void 0&&(E=d.Clean),A===void 0&&(A=null),F===void 0&&(F=null),B===void 0&&(B=null),L===void 0&&(L=null),I===void 0&&(I=null),!l){T.a.Error("No scene available to load animations to");return}if(y){for(var z=0,k=l.animatables;z<k.length;z++){var j=k[z];j.reset()}l.stopAllAnimations(),l.animationGroups.slice().forEach(function(Y){Y.dispose()});var w=l.getNodes();w.forEach(function(Y){Y.animations&&(Y.animations=[])})}else switch(E){case d.Clean:l.animationGroups.slice().forEach(function(Y){Y.dispose()});break;case d.Stop:l.animationGroups.forEach(function(Y){Y.stop()});break;case d.Sync:l.animationGroups.forEach(function(Y){Y.reset(),Y.restart()});break;case d.NoSync:break;default:T.a.Error("Unknown animation group loading mode value '"+E+"'");return}var Q=l.animatables.length,W=function(Y){Y.mergeAnimationsTo(l,l.animatables.slice(Q),A),Y.dispose(),l.onAnimationFileImportedObservable.notifyObservers(l),F&&F(l)};this.LoadAssetContainer(_,m,l,W,B,L,I)},p.ImportAnimationsAsync=function(_,m,l,y,E,A,F,B,L,I){return m===void 0&&(m=""),l===void 0&&(l=G.a.LastCreatedScene),y===void 0&&(y=!0),E===void 0&&(E=d.Clean),A===void 0&&(A=null),F===void 0&&(F=null),B===void 0&&(B=null),L===void 0&&(L=null),I===void 0&&(I=null),new Promise(function(z,k){p.ImportAnimations(_,m,l,y,E,A,function(j){z(j)},B,function(j,w,Q){k(Q||new Error(w))},I)})},p.NO_LOGGING=0,p.MINIMAL_LOGGING=1,p.SUMMARY_LOGGING=2,p.DETAILED_LOGGING=3,p.OnPluginActivatedObservable=new R.c,p._registeredPlugins={},p._showingLoadingScreen=!1,p}()},466:function(we,P,u){"use strict";u.d(P,"a",function(){return R});var S=u(443),R=function(){function U(O,x,G,T){this._name=x,this._singleInstance=T||!0,this._getPostProcesses=G,this._cameras={},this._indicesForCamera={},this._postProcesses={}}return Object.defineProperty(U.prototype,"isSupported",{get:function(){for(var O in this._postProcesses)if(this._postProcesses.hasOwnProperty(O)){for(var x=this._postProcesses[O],G=0;G<x.length;G++)if(!x[G].isSupported)return!1}return!0},enumerable:!1,configurable:!0}),U.prototype._update=function(){},U.prototype._attachCameras=function(O){var x=this,G,T=S.b.MakeArray(O||this._cameras);if(!!T)for(var h=0;h<T.length;h++){var f=T[h];if(!!f){var d=f.name;if(this._singleInstance?G=0:G=d,!this._postProcesses[G]){var g=this._getPostProcesses();g&&(this._postProcesses[G]=Array.isArray(g)?g:[g])}this._indicesForCamera[d]||(this._indicesForCamera[d]=[]),this._postProcesses[G].forEach(function(p){var _=f.attachPostProcess(p);x._indicesForCamera[d].push(_)}),this._cameras[d]||(this._cameras[d]=f)}}},U.prototype._detachCameras=function(O){var x=S.b.MakeArray(O||this._cameras);if(!!x)for(var G=0;G<x.length;G++){var T=x[G],h=T.name,f=this._postProcesses[this._singleInstance?0:h];f&&f.forEach(function(d){T.detachPostProcess(d)}),this._cameras[h]&&(this._cameras[h]=null)}},U.prototype._enable=function(O){var x=this,G=S.b.MakeArray(O||this._cameras);if(!!G)for(var T=0;T<G.length;T++)for(var h=G[T],f=h.name,d=0;d<this._indicesForCamera[f].length;d++)(h._postProcesses[this._indicesForCamera[f][d]]===void 0||h._postProcesses[this._indicesForCamera[f][d]]===null)&&this._postProcesses[this._singleInstance?0:f].forEach(function(g){G[T].attachPostProcess(g,x._indicesForCamera[f][d])})},U.prototype._disable=function(O){var x=S.b.MakeArray(O||this._cameras);if(!!x)for(var G=0;G<x.length;G++){var T=x[G],h=T.name;this._postProcesses[this._singleInstance?0:h].forEach(function(f){T.detachPostProcess(f)})}},U.prototype.getPostProcesses=function(O){return this._singleInstance?this._postProcesses[0]:O?this._postProcesses[O.name]:null},U}()},469:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(588),R=u(436),U=u(539),O=u(667),x=u(449),G=u(451),T=function(){function h(f,d,g){g===void 0&&(g=Number.MAX_VALUE),this.origin=f,this.direction=d,this.length=g}return h.prototype.intersectsBoxMinMax=function(f,d,g){g===void 0&&(g=0);var p=h._TmpVector3[0].copyFromFloats(f.x-g,f.y-g,f.z-g),_=h._TmpVector3[1].copyFromFloats(d.x+g,d.y+g,d.z+g),m=0,l=Number.MAX_VALUE,y,E,A,F;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<p.x||this.origin.x>_.x)return!1}else if(y=1/this.direction.x,E=(p.x-this.origin.x)*y,A=(_.x-this.origin.x)*y,A===-Infinity&&(A=Infinity),E>A&&(F=E,E=A,A=F),m=Math.max(E,m),l=Math.min(A,l),m>l)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<p.y||this.origin.y>_.y)return!1}else if(y=1/this.direction.y,E=(p.y-this.origin.y)*y,A=(_.y-this.origin.y)*y,A===-Infinity&&(A=Infinity),E>A&&(F=E,E=A,A=F),m=Math.max(E,m),l=Math.min(A,l),m>l)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<p.z||this.origin.z>_.z)return!1}else if(y=1/this.direction.z,E=(p.z-this.origin.z)*y,A=(_.z-this.origin.z)*y,A===-Infinity&&(A=Infinity),E>A&&(F=E,E=A,A=F),m=Math.max(E,m),l=Math.min(A,l),m>l)return!1;return!0},h.prototype.intersectsBox=function(f,d){return d===void 0&&(d=0),this.intersectsBoxMinMax(f.minimum,f.maximum,d)},h.prototype.intersectsSphere=function(f,d){d===void 0&&(d=0);var g=f.center.x-this.origin.x,p=f.center.y-this.origin.y,_=f.center.z-this.origin.z,m=g*g+p*p+_*_,l=f.radius+d,y=l*l;if(m<=y)return!0;var E=g*this.direction.x+p*this.direction.y+_*this.direction.z;if(E<0)return!1;var A=m-E*E;return A<=y},h.prototype.intersectsTriangle=function(f,d,g){var p=h._TmpVector3[0],_=h._TmpVector3[1],m=h._TmpVector3[2],l=h._TmpVector3[3],y=h._TmpVector3[4];d.subtractToRef(f,p),g.subtractToRef(f,_),R.e.CrossToRef(this.direction,_,m);var E=R.e.Dot(p,m);if(E===0)return null;var A=1/E;this.origin.subtractToRef(f,l);var F=R.e.Dot(l,m)*A;if(F<0||F>1)return null;R.e.CrossToRef(l,p,y);var B=R.e.Dot(this.direction,y)*A;if(B<0||F+B>1)return null;var L=R.e.Dot(_,y)*A;return L>this.length?null:new O.a(1-F-B,F,L)},h.prototype.intersectsPlane=function(f){var d,g=R.e.Dot(f.normal,this.direction);if(Math.abs(g)<999999997475243e-21)return null;var p=R.e.Dot(f.normal,this.origin);return d=(-f.d-p)/g,d<0?d<-999999997475243e-21?null:0:d},h.prototype.intersectsAxis=function(f,d){switch(d===void 0&&(d=0),f){case"y":var g=(this.origin.y-d)/this.direction.y;return g>0?null:new R.e(this.origin.x+this.direction.x*-g,d,this.origin.z+this.direction.z*-g);case"x":var g=(this.origin.x-d)/this.direction.x;return g>0?null:new R.e(d,this.origin.y+this.direction.y*-g,this.origin.z+this.direction.z*-g);case"z":var g=(this.origin.z-d)/this.direction.z;return g>0?null:new R.e(this.origin.x+this.direction.x*-g,this.origin.y+this.direction.y*-g,d);default:return null}},h.prototype.intersectsMesh=function(f,d){var g=R.c.Matrix[0];return f.getWorldMatrix().invertToRef(g),this._tmpRay?h.TransformToRef(this,g,this._tmpRay):this._tmpRay=h.Transform(this,g),f.intersects(this._tmpRay,d)},h.prototype.intersectsMeshes=function(f,d,g){g?g.length=0:g=[];for(var p=0;p<f.length;p++){var _=this.intersectsMesh(f[p],d);_.hit&&g.push(_)}return g.sort(this._comparePickingInfo),g},h.prototype._comparePickingInfo=function(f,d){return f.distance<d.distance?-1:f.distance>d.distance?1:0},h.prototype.intersectionSegment=function(f,d,g){var p=this.origin,_=R.c.Vector3[0],m=R.c.Vector3[1],l=R.c.Vector3[2],y=R.c.Vector3[3];d.subtractToRef(f,_),this.direction.scaleToRef(h.rayl,l),p.addToRef(l,m),f.subtractToRef(p,y);var E=R.e.Dot(_,_),A=R.e.Dot(_,l),F=R.e.Dot(l,l),B=R.e.Dot(_,y),L=R.e.Dot(l,y),I=E*F-A*A,z,k,j=I,w,Q,W=I;I<h.smallnum?(k=0,j=1,Q=L,W=F):(k=A*L-F*B,Q=E*L-A*B,k<0?(k=0,Q=L,W=F):k>j&&(k=j,Q=L+A,W=F)),Q<0?(Q=0,-B<0?k=0:-B>E?k=j:(k=-B,j=E)):Q>W&&(Q=W,-B+A<0?k=0:-B+A>E?k=j:(k=-B+A,j=E)),z=Math.abs(k)<h.smallnum?0:k/j,w=Math.abs(Q)<h.smallnum?0:Q/W;var Y=R.c.Vector3[4];l.scaleToRef(w,Y);var he=R.c.Vector3[5];_.scaleToRef(z,he),he.addInPlace(y);var le=R.c.Vector3[6];he.subtractToRef(Y,le);var J=w>0&&w<=this.length&&le.lengthSquared()<g*g;return J?he.length():-1},h.prototype.update=function(f,d,g,p,_,m,l){return this.unprojectRayToRef(f,d,g,p,_,m,l),this},h.Zero=function(){return new h(R.e.Zero(),R.e.Zero())},h.CreateNew=function(f,d,g,p,_,m,l){var y=h.Zero();return y.update(f,d,g,p,_,m,l)},h.CreateNewFromTo=function(f,d,g){g===void 0&&(g=R.a.IdentityReadOnly);var p=d.subtract(f),_=Math.sqrt(p.x*p.x+p.y*p.y+p.z*p.z);return p.normalize(),h.Transform(new h(f,p,_),g)},h.Transform=function(f,d){var g=new h(new R.e(0,0,0),new R.e(0,0,0));return h.TransformToRef(f,d,g),g},h.TransformToRef=function(f,d,g){R.e.TransformCoordinatesToRef(f.origin,d,g.origin),R.e.TransformNormalToRef(f.direction,d,g.direction),g.length=f.length;var p=g.direction,_=p.length();if(!(_===0||_===1)){var m=1/_;p.x*=m,p.y*=m,p.z*=m,g.length*=_}},h.prototype.unprojectRayToRef=function(f,d,g,p,_,m,l){var y=R.c.Matrix[0];_.multiplyToRef(m,y),y.multiplyToRef(l,y),y.invert();var E=R.c.Vector3[0];E.x=f/g*2-1,E.y=-(d/p*2-1),E.z=-1;var A=R.c.Vector3[1].copyFromFloats(E.x,E.y,1),F=R.c.Vector3[2],B=R.c.Vector3[3];R.e._UnprojectFromInvertedMatrixToRef(E,y,F),R.e._UnprojectFromInvertedMatrixToRef(A,y,B),this.origin.copyFrom(F),B.subtractToRef(F,this.direction),this.direction.normalize()},h._TmpVector3=S.a.BuildArray(6,R.e.Zero),h.smallnum=1e-8,h.rayl=1e9,h}();x.a.prototype.createPickingRay=function(h,f,d,g,p){p===void 0&&(p=!1);var _=T.Zero();return this.createPickingRayToRef(h,f,d,_,g,p),_},x.a.prototype.createPickingRayToRef=function(h,f,d,g,p,_){_===void 0&&(_=!1);var m=this.getEngine();if(!p){if(!this.activeCamera)return this;p=this.activeCamera}var l=p.viewport,y=l.toGlobal(m.getRenderWidth(),m.getRenderHeight());return h=h/m.getHardwareScalingLevel()-y.x,f=f/m.getHardwareScalingLevel()-(m.getRenderHeight()-y.y-y.height),g.update(h,f,y.width,y.height,d||R.a.IdentityReadOnly,_?R.a.IdentityReadOnly:p.getViewMatrix(),p.getProjectionMatrix()),this},x.a.prototype.createPickingRayInCameraSpace=function(h,f,d){var g=T.Zero();return this.createPickingRayInCameraSpaceToRef(h,f,g,d),g},x.a.prototype.createPickingRayInCameraSpaceToRef=function(h,f,d,g){if(!U.a)return this;var p=this.getEngine();if(!g){if(!this.activeCamera)throw new Error("Active camera not set");g=this.activeCamera}var _=g.viewport,m=_.toGlobal(p.getRenderWidth(),p.getRenderHeight()),l=R.a.Identity();return h=h/p.getHardwareScalingLevel()-m.x,f=f/p.getHardwareScalingLevel()-(p.getRenderHeight()-m.y-m.height),d.update(h,f,m.width,m.height,l,l,g.getProjectionMatrix()),this},x.a.prototype._internalPickForMesh=function(h,f,d,g,p,_,m,l){var y=f(g),E=d.intersects(y,p,m,_,g,l);return!E||!E.hit||!p&&h!=null&&E.distance>=h.distance?null:E},x.a.prototype._internalPick=function(h,f,d,g,p){if(!U.a)return null;for(var _=null,m=0;m<this.meshes.length;m++){var l=this.meshes[m];if(f){if(!f(l))continue}else if(!l.isEnabled()||!l.isVisible||!l.isPickable)continue;var y=l.skeleton&&l.skeleton.overrideMesh?l.skeleton.overrideMesh.getWorldMatrix():l.getWorldMatrix();if(l.hasThinInstances&&l.thinInstanceEnablePicking){var E=this._internalPickForMesh(_,h,l,y,!0,!0,p);if(E){if(g)return _;for(var A=R.c.Matrix[1],F=l.thinInstanceGetWorldMatrices(),B=0;B<F.length;B++){var L=F[B];L.multiplyToRef(y,A);var I=this._internalPickForMesh(_,h,l,A,d,g,p,!0);if(I&&(_=I,_.thinInstanceIndex=B,d))return _}}}else{var E=this._internalPickForMesh(_,h,l,y,d,g,p);if(E&&(_=E,d))return _}}return _||new U.a},x.a.prototype._internalMultiPick=function(h,f,d){if(!U.a)return null;for(var g=new Array,p=0;p<this.meshes.length;p++){var _=this.meshes[p];if(f){if(!f(_))continue}else if(!_.isEnabled()||!_.isVisible||!_.isPickable)continue;var m=_.skeleton&&_.skeleton.overrideMesh?_.skeleton.overrideMesh.getWorldMatrix():_.getWorldMatrix();if(_.hasThinInstances&&_.thinInstanceEnablePicking){var l=this._internalPickForMesh(null,h,_,m,!0,!0,d);if(l)for(var y=R.c.Matrix[1],E=_.thinInstanceGetWorldMatrices(),A=0;A<E.length;A++){var F=E[A];F.multiplyToRef(m,y);var B=this._internalPickForMesh(null,h,_,y,!1,!1,d,!0);B&&(B.thinInstanceIndex=A,g.push(B))}}else{var l=this._internalPickForMesh(null,h,_,m,!1,!1,d);l&&g.push(l)}}return g},x.a.prototype.pickWithBoundingInfo=function(h,f,d,g,p){var _=this;if(!U.a)return null;var m=this._internalPick(function(l){return _._tempPickingRay||(_._tempPickingRay=T.Zero()),_.createPickingRayToRef(h,f,l,_._tempPickingRay,p||null),_._tempPickingRay},d,g,!0);return m&&(m.ray=this.createPickingRay(h,f,R.a.Identity(),p||null)),m},x.a.prototype.pick=function(h,f,d,g,p,_){var m=this;if(!U.a)return null;var l=this._internalPick(function(y){return m._tempPickingRay||(m._tempPickingRay=T.Zero()),m.createPickingRayToRef(h,f,y,m._tempPickingRay,p||null),m._tempPickingRay},d,g,!1,_);return l&&(l.ray=this.createPickingRay(h,f,R.a.Identity(),p||null)),l},x.a.prototype.pickWithRay=function(h,f,d,g){var p=this,_=this._internalPick(function(m){return p._pickWithRayInverseMatrix||(p._pickWithRayInverseMatrix=R.a.Identity()),m.invertToRef(p._pickWithRayInverseMatrix),p._cachedRayForTransform||(p._cachedRayForTransform=T.Zero()),T.TransformToRef(h,p._pickWithRayInverseMatrix,p._cachedRayForTransform),p._cachedRayForTransform},f,d,!1,g);return _&&(_.ray=h),_},x.a.prototype.multiPick=function(h,f,d,g,p){var _=this;return this._internalMultiPick(function(m){return _.createPickingRay(h,f,m,g||null)},d,p)},x.a.prototype.multiPickWithRay=function(h,f,d){var g=this;return this._internalMultiPick(function(p){return g._pickWithRayInverseMatrix||(g._pickWithRayInverseMatrix=R.a.Identity()),p.invertToRef(g._pickWithRayInverseMatrix),g._cachedRayForTransform||(g._cachedRayForTransform=T.Zero()),T.TransformToRef(h,g._pickWithRayInverseMatrix,g._cachedRayForTransform),g._cachedRayForTransform},f,d)},G.a.prototype.getForwardRay=function(h,f,d){return h===void 0&&(h=100),this.getForwardRayToRef(new T(R.e.Zero(),R.e.Zero(),h),h,f,d)},G.a.prototype.getForwardRayToRef=function(h,f,d,g){return f===void 0&&(f=100),d||(d=this.getWorldMatrix()),h.length=f,g?h.origin.copyFrom(g):h.origin.copyFrom(this.position),R.c.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),R.e.TransformNormalToRef(R.c.Vector3[2],d,R.c.Vector3[3]),R.e.NormalizeToRef(R.c.Vector3[3],h.direction),h}},471:function(we,P,u){"use strict";u.d(P,"a",function(){return x});var S=u(436),R=u(446),U=u(461),O=u(464),x=function(){function G(T){var h=this;T===void 0&&(T=U.a.DefaultUtilityLayer),this.gizmoLayer=T,this._attachedMesh=null,this._attachedNode=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this.updateGizmoPositionToMatchAttachedMesh=!0,this.updateScale=!0,this._interactionsEnabled=!0,this._tempQuaternion=new S.b(0,0,0,1),this._tempVector=new S.e,this._tempVector2=new S.e,this._tempMatrix1=new S.a,this._tempMatrix2=new S.a,this._rightHandtoLeftHandMatrix=S.a.RotationY(Math.PI),this._rootMesh=new R.a("gizmoRootNode",T.utilityLayerScene),this._rootMesh.rotationQuaternion=S.b.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add(function(){h._update()})}return Object.defineProperty(G.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(T){this._scaleRatio=T},enumerable:!1,configurable:!0}),Object.defineProperty(G.prototype,"isHovered",{get:function(){return this._isHovered},enumerable:!1,configurable:!0}),Object.defineProperty(G.prototype,"attachedMesh",{get:function(){return this._attachedMesh},set:function(T){this._attachedMesh=T,T&&(this._attachedNode=T),this._rootMesh.setEnabled(!!T),this._attachedNodeChanged(T)},enumerable:!1,configurable:!0}),Object.defineProperty(G.prototype,"attachedNode",{get:function(){return this._attachedNode},set:function(T){this._attachedNode=T,this._attachedMesh=null,this._rootMesh.setEnabled(!!T),this._attachedNodeChanged(T)},enumerable:!1,configurable:!0}),G.prototype.setCustomMesh=function(T){if(T.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach(function(h){h.dispose()}),T.parent=this._rootMesh,this._customMeshSet=!0},Object.defineProperty(G.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(T){this._updateGizmoRotationToMatchAttachedMesh=T},enumerable:!1,configurable:!0}),G.prototype._attachedNodeChanged=function(T){},G.prototype._update=function(){if(this.attachedNode){var T=this.attachedNode;if(this.attachedMesh&&(T=this.attachedMesh._effectiveMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh){var h=T.getWorldMatrix().getRow(3),f=h?h.toVector3():new S.e(0,0,0);this._rootMesh.position.copyFrom(f)}if(this.updateGizmoRotationToMatchAttachedMesh?T.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1),this.updateScale){var d=this.gizmoLayer.utilityLayerScene.activeCamera,g=d.globalPosition;d.devicePosition&&(g=d.devicePosition),this._rootMesh.position.subtractToRef(g,this._tempVector);var p=this._tempVector.length()*this.scaleRatio;this._rootMesh.scaling.set(p,p,p),T._getWorldMatrixDeterminant()<0&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}},G.prototype._matrixChanged=function(){if(!!this._attachedNode){if(this._attachedNode._isCamera){var T=this._attachedNode,h,f;if(T.parent){var d=this._tempMatrix2;T.parent._worldMatrix.invertToRef(d),this._attachedNode._worldMatrix.multiplyToRef(d,this._tempMatrix1),h=this._tempMatrix1}else h=this._attachedNode._worldMatrix;T.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(h,this._tempMatrix2),f=this._tempMatrix2):f=h,f.decompose(this._tempVector2,this._tempQuaternion,this._tempVector);var g=this._attachedNode.getClassName()==="FreeCamera"||this._attachedNode.getClassName()==="FlyCamera"||this._attachedNode.getClassName()==="ArcFollowCamera"||this._attachedNode.getClassName()==="TargetCamera"||this._attachedNode.getClassName()==="TouchCamera"||this._attachedNode.getClassName()==="UniversalCamera";if(g){var p=this._attachedNode;p.rotation=this._tempQuaternion.toEulerAngles(),p.rotationQuaternion&&(p.rotationQuaternion.copyFrom(this._tempQuaternion),p.rotationQuaternion.normalize())}T.position.copyFrom(this._tempVector)}else if(this._attachedNode._isMesh||this._attachedNode.getClassName()==="AbstractMesh"||this._attachedNode.getClassName()==="TransformNode"||this._attachedNode.getClassName()==="InstancedMesh"){var _=this._attachedNode;if(_.parent){var d=this._tempMatrix1,m=this._tempMatrix2;_.parent.getWorldMatrix().invertToRef(d),this._attachedNode.getWorldMatrix().multiplyToRef(d,m),m.decompose(_.scaling,this._tempQuaternion,_.position)}else this._attachedNode._worldMatrix.decompose(_.scaling,this._tempQuaternion,_.position);_.billboardMode||(_.rotationQuaternion?(_.rotationQuaternion.copyFrom(this._tempQuaternion),_.rotationQuaternion.normalize()):_.rotation=this._tempQuaternion.toEulerAngles())}else if(this._attachedNode.getClassName()==="Bone"){var l=this._attachedNode,y=l.getParent();if(y){var E=this._tempMatrix1,A=this._tempMatrix2;y.getWorldMatrix().invertToRef(E),l.getWorldMatrix().multiplyToRef(E,A);var F=l.getLocalMatrix();F.copyFrom(A)}else{var F=l.getLocalMatrix();F.copyFrom(l.getWorldMatrix())}l.markAsDirty()}}},G.GizmoAxisPointerObserver=function(T,h){var f=!1,d=T.utilityLayerScene.onPointerObservable.add(function(g){var p,_;if(g.pickInfo){if(g.type===O.a.POINTERMOVE){if(f)return;h.forEach(function(l){var y,E;if(l.colliderMeshes&&l.gizmoMeshes){var A=((y=l.colliderMeshes)===null||y===void 0?void 0:y.indexOf((E=g==null?void 0:g.pickInfo)===null||E===void 0?void 0:E.pickedMesh))!=-1,F=A||l.active?l.hoverMaterial:l.material;l.gizmoMeshes.forEach(function(B){B.material=F,B.color&&(B.color=F.diffuseColor)})}})}if(g.type===O.a.POINTERDOWN&&h.has((p=g.pickInfo.pickedMesh)===null||p===void 0?void 0:p.parent)){f=!0;var m=h.get((_=g.pickInfo.pickedMesh)===null||_===void 0?void 0:_.parent);m.active=!0,h.forEach(function(l){var y,E,A=((y=l.colliderMeshes)===null||y===void 0?void 0:y.indexOf((E=g==null?void 0:g.pickInfo)===null||E===void 0?void 0:E.pickedMesh))!=-1,F=A||l.active?l.hoverMaterial:l.disableMaterial;l.gizmoMeshes.forEach(function(B){B.material=F,B.color&&(B.color=F.diffuseColor)})})}g.type===O.a.POINTERUP&&h.forEach(function(l){l.active=!1,f=!1,l.gizmoMeshes.forEach(function(y){y.material=l.material,y.color&&(y.color=l.material.diffuseColor)})})}});return d},G.prototype.dispose=function(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)},G}()},472:function(we,P,u){"use strict";u.d(P,"a",function(){return w});var S=u(434),R=u(444),U=u(442),O=u(435),x="kernelBlurVaryingDeclaration",G="varying vec2 sampleCoord{X};";O.a.IncludesShadersStore[x]=G;var T={name:x,shader:G},h=u(535),f="kernelBlurFragment",d=`#ifdef DOF
factor=sampleCoC(sampleCoord{X});
computedWeight=KERNEL_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif`;O.a.IncludesShadersStore[f]=d;var g={name:f,shader:d},p="kernelBlurFragment2",_=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});
computedWeight=KERNEL_DEP_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif`;O.a.IncludesShadersStore[p]=_;var m={name:p,shader:_},l="kernelBlurPixelShader",y=`
uniform sampler2D textureSampler;
uniform vec2 delta;

varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;
uniform vec2 cameraMinMaxZ;
float sampleDistance(const in vec2 offset) {
float depth=texture2D(circleOfConfusionSampler,offset).g;
return cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth;
}
float sampleCoC(const in vec2 offset) {
float coc=texture2D(circleOfConfusionSampler,offset).r;
return coc;
}
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
void main(void)
{
float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT;
float factor=0.0;

#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;O.a.ShadersStore[l]=y;var E={name:l,shader:y},A="kernelBlurVertex",F="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";O.a.IncludesShadersStore[A]=F;var B={name:A,shader:F},L="kernelBlurVertexShader",I=`
attribute vec2 position;

uniform vec2 delta;

varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
void main(void) {
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
}`;O.a.ShadersStore[L]=I;var z={name:L,shader:I},k=u(437),j=u(439),w=function(Q){Object(S.d)(W,Q);function W(Y,he,le,J,Re,Me,me,H,q,_e,Ee){Me===void 0&&(Me=U.a.BILINEAR_SAMPLINGMODE),q===void 0&&(q=0),_e===void 0&&(_e=""),Ee===void 0&&(Ee=!1);var Te=Q.call(this,Y,"kernelBlur",["delta","direction","cameraMinMaxZ"],["circleOfConfusionSampler"],J,Re,Me,me,H,null,q,"kernelBlur",{varyingCount:0,depCount:0},!0)||this;return Te.blockCompilation=Ee,Te._packedFloat=!1,Te._staticDefines="",Te._staticDefines=_e,Te.direction=he,Te.onApplyObservable.add(function(se){Te._outputTexture?se.setFloat2("delta",1/Te._outputTexture.width*Te.direction.x,1/Te._outputTexture.height*Te.direction.y):se.setFloat2("delta",1/Te.width*Te.direction.x,1/Te.height*Te.direction.y)}),Te.kernel=le,Te}return Object.defineProperty(W.prototype,"kernel",{get:function(){return this._idealKernel},set:function(Y){this._idealKernel!==Y&&(Y=Math.max(Y,1),this._idealKernel=Y,this._kernel=this._nearestBestKernel(Y),this.blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(W.prototype,"packedFloat",{get:function(){return this._packedFloat},set:function(Y){this._packedFloat!==Y&&(this._packedFloat=Y,this.blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),W.prototype.getClassName=function(){return"BlurPostProcess"},W.prototype.updateEffect=function(Y,he,le,J,Re,Me){Y===void 0&&(Y=null),he===void 0&&(he=null),le===void 0&&(le=null),this._updateParameters(Re,Me)},W.prototype._updateParameters=function(Y,he){for(var le=this._kernel,J=(le-1)/2,Re=[],Me=[],me=0,H=0;H<le;H++){var q=H/(le-1),_e=this._gaussianWeight(q*2-1);Re[H]=H-J,Me[H]=_e,me+=_e}for(var H=0;H<Me.length;H++)Me[H]/=me;for(var Ee=[],Te=[],se=[],H=0;H<=J;H+=2){var ve=Math.min(H+1,Math.floor(J)),ye=H===ve;if(ye)se.push({o:Re[H],w:Me[H]});else{var Le=ve===J,be=Me[H]+Me[ve]*(Le?.5:1),ze=Re[H]+1/(1+Me[H]/Me[ve]);ze===0?(se.push({o:Re[H],w:Me[H]}),se.push({o:Re[H+1],w:Me[H+1]})):(se.push({o:ze,w:be}),se.push({o:-ze,w:be}))}}for(var H=0;H<se.length;H++)Te[H]=se[H].o,Ee[H]=se[H].w;Re=Te,Me=Ee;var Ye=this.getEngine().getCaps().maxVaryingVectors,He=Math.max(Ye,0)-1,Ue=Math.min(Re.length,He),re="";re+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(re+="#define CENTER_WEIGHT "+this._glslFloat(Me[Ue-1])+`\r
`,Ue--);for(var H=0;H<Ue;H++)re+="#define KERNEL_OFFSET"+H+" "+this._glslFloat(Re[H])+`\r
`,re+="#define KERNEL_WEIGHT"+H+" "+this._glslFloat(Me[H])+`\r
`;for(var Z=0,H=He;H<Re.length;H++)re+="#define KERNEL_DEP_OFFSET"+Z+" "+this._glslFloat(Re[H])+`\r
`,re+="#define KERNEL_DEP_WEIGHT"+Z+" "+this._glslFloat(Me[H])+`\r
`,Z++;this.packedFloat&&(re+="#define PACKEDFLOAT 1"),this.blockCompilation=!1,Q.prototype.updateEffect.call(this,re,null,null,{varyingCount:Ue,depCount:Z},Y,he)},W.prototype._nearestBestKernel=function(Y){for(var he=Math.round(Y),le=0,J=[he,he-1,he+1,he-2,he+2];le<J.length;le++){var Re=J[le];if(Re%2!=0&&Math.floor(Re/2)%2==0&&Re>0)return Math.max(Re,3)}return Math.max(he,3)},W.prototype._gaussianWeight=function(Y){var he=1/3,le=Math.sqrt(2*Math.PI)*he,J=-(Y*Y/(2*he*he)),Re=1/le*Math.exp(J);return Re},W.prototype._glslFloat=function(Y,he){return he===void 0&&(he=8),Y.toFixed(he).replace(/0+$/,"")},W._Parse=function(Y,he,le,J){return j.a.Parse(function(){return new W(Y.name,Y.direction,Y.kernel,Y.options,he,Y.renderTargetSamplingMode,le.getEngine(),Y.reusable,Y.textureType,void 0,!1)},Y,le,J)},Object(S.c)([Object(j.c)("kernel")],W.prototype,"_kernel",void 0),Object(S.c)([Object(j.c)("packedFloat")],W.prototype,"_packedFloat",void 0),Object(S.c)([Object(j.n)()],W.prototype,"direction",void 0),W}(R.a);k.a.RegisteredTypes["BABYLON.BlurPostProcess"]=w},478:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(434),R=u(439),U=u(436),O=u(445),x=u(528),G=u(531),T=u(443),h=function(f){Object(S.d)(d,f);function d(g,p,_,m){m===void 0&&(m=!0);var l=f.call(this,g,p,_,m)||this;return l.ellipsoid=new U.e(.5,1,.5),l.ellipsoidOffset=new U.e(0,0,0),l.checkCollisions=!1,l.applyGravity=!1,l._needMoveForGravity=!1,l._oldPosition=U.e.Zero(),l._diffPosition=U.e.Zero(),l._newPosition=U.e.Zero(),l._collisionMask=-1,l._onCollisionPositionChange=function(y,E,A){A===void 0&&(A=null);var F=function(B){l._newPosition.copyFrom(B),l._newPosition.subtractToRef(l._oldPosition,l._diffPosition),l._diffPosition.length()>O.a.CollisionsEpsilon&&(l.position.addInPlace(l._diffPosition),l.onCollide&&A&&l.onCollide(A))};F(E)},l.inputs=new G.a(l),l.inputs.addKeyboard().addMouse(),l}return Object.defineProperty(d.prototype,"angularSensibility",{get:function(){var g=this.inputs.attached.mouse;return g?g.angularSensibility:0},set:function(g){var p=this.inputs.attached.mouse;p&&(p.angularSensibility=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"keysUp",{get:function(){var g=this.inputs.attached.keyboard;return g?g.keysUp:[]},set:function(g){var p=this.inputs.attached.keyboard;p&&(p.keysUp=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"keysUpward",{get:function(){var g=this.inputs.attached.keyboard;return g?g.keysUpward:[]},set:function(g){var p=this.inputs.attached.keyboard;p&&(p.keysUpward=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"keysDown",{get:function(){var g=this.inputs.attached.keyboard;return g?g.keysDown:[]},set:function(g){var p=this.inputs.attached.keyboard;p&&(p.keysDown=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"keysDownward",{get:function(){var g=this.inputs.attached.keyboard;return g?g.keysDownward:[]},set:function(g){var p=this.inputs.attached.keyboard;p&&(p.keysDownward=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"keysLeft",{get:function(){var g=this.inputs.attached.keyboard;return g?g.keysLeft:[]},set:function(g){var p=this.inputs.attached.keyboard;p&&(p.keysLeft=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"keysRight",{get:function(){var g=this.inputs.attached.keyboard;return g?g.keysRight:[]},set:function(g){var p=this.inputs.attached.keyboard;p&&(p.keysRight=g)},enumerable:!1,configurable:!0}),d.prototype.attachControl=function(g,p){p=T.b.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(p)},d.prototype.detachControl=function(g){this.inputs.detachElement(),this.cameraDirection=new U.e(0,0,0),this.cameraRotation=new U.d(0,0)},Object.defineProperty(d.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(g){this._collisionMask=isNaN(g)?-1:g},enumerable:!1,configurable:!0}),d.prototype._collideWithWorld=function(g){var p;this.parent?p=U.e.TransformCoordinates(this.position,this.parent.getWorldMatrix()):p=this.position,p.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);var _=this.getScene().collisionCoordinator;this._collider||(this._collider=_.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var m=g;this.applyGravity&&(m=g.add(this.getScene().gravity)),_.getNewPosition(this._oldPosition,m,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},d.prototype._checkInputs=function(){this._localDirection||(this._localDirection=U.e.Zero(),this._transformedDirection=U.e.Zero()),this.inputs.checkInputs(),f.prototype._checkInputs.call(this)},d.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},d.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):f.prototype._updatePosition.call(this)},d.prototype.dispose=function(){this.inputs.clear(),f.prototype.dispose.call(this)},d.prototype.getClassName=function(){return"FreeCamera"},Object(S.c)([Object(R.o)()],d.prototype,"ellipsoid",void 0),Object(S.c)([Object(R.o)()],d.prototype,"ellipsoidOffset",void 0),Object(S.c)([Object(R.c)()],d.prototype,"checkCollisions",void 0),Object(S.c)([Object(R.c)()],d.prototype,"applyGravity",void 0),d}(x.a)},479:function(we,P,u){"use strict";u.d(P,"a",function(){return G});var S=u(434),R=u(440),U=u(442),O=u(532),x=u(596),G=function(T){Object(S.d)(h,T);function h(f,d,g,p,_,m,l){g===void 0&&(g=null),p===void 0&&(p=!1),_===void 0&&(_=3),m===void 0&&(m=5);var y=T.call(this,null,g,!p,l,_,void 0,void 0,void 0,void 0,m)||this;y.name=f,y.wrapU=U.a.CLAMP_ADDRESSMODE,y.wrapV=U.a.CLAMP_ADDRESSMODE,y._generateMipMaps=p;var E=y._getEngine();if(!E)return y;d.getContext?(y._canvas=d,y._texture=E.createDynamicTexture(d.width,d.height,p,_)):(y._canvas=x.a.CreateCanvas(1,1),d.width||d.width===0?y._texture=E.createDynamicTexture(d.width,d.height,p,_):y._texture=E.createDynamicTexture(d,d,p,_));var A=y.getSize();return y._canvas.width=A.width,y._canvas.height=A.height,y._context=y._canvas.getContext("2d"),y}return h.prototype.getClassName=function(){return"DynamicTexture"},Object.defineProperty(h.prototype,"canRescale",{get:function(){return!0},enumerable:!1,configurable:!0}),h.prototype._recreate=function(f){this._canvas.width=f.width,this._canvas.height=f.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(f.width,f.height,this._generateMipMaps,this.samplingMode)},h.prototype.scale=function(f){var d=this.getSize();d.width*=f,d.height*=f,this._recreate(d)},h.prototype.scaleTo=function(f,d){var g=this.getSize();g.width=f,g.height=d,this._recreate(g)},h.prototype.getContext=function(){return this._context},h.prototype.clear=function(){var f=this.getSize();this._context.fillRect(0,0,f.width,f.height)},h.prototype.update=function(f,d){d===void 0&&(d=!1),this._getEngine().updateDynamicTexture(this._texture,this._canvas,f===void 0?!0:f,d,this._format||void 0)},h.prototype.drawText=function(f,d,g,p,_,m,l,y){y===void 0&&(y=!0);var E=this.getSize();if(m&&(this._context.fillStyle=m,this._context.fillRect(0,0,E.width,E.height)),this._context.font=p,d==null){var A=this._context.measureText(f);d=(E.width-A.width)/2}if(g==null){var F=parseInt(p.replace(/\D/g,""));g=E.height/2+F/3.65}this._context.fillStyle=_||"",this._context.fillText(f,d,g),y&&this.update(l)},h.prototype.clone=function(){var f=this.getScene();if(!f)return this;var d=this.getSize(),g=new h(this.name,d,f,this._generateMipMaps);return g.hasAlpha=this.hasAlpha,g.level=this.level,g.wrapU=this.wrapU,g.wrapV=this.wrapV,g},h.prototype.serialize=function(){var f=this.getScene();f&&!f.isReady()&&R.a.Warn("The scene must be ready before serializing the dynamic texture");var d=T.prototype.serialize.call(this);return this._IsCanvasElement(this._canvas)&&(d.base64String=this._canvas.toDataURL()),d.invertY=this._invertY,d.samplingMode=this.samplingMode,d},h.prototype._IsCanvasElement=function(f){return f.toDataURL!==void 0},h.prototype._rebuild=function(){this.update()},h}(U.a)},481:function(we,P,u){"use strict";u.d(P,"a",function(){return O});var S=u(434),R=u(443),U=u(439),O=function(){function x(G,T){this.engine=G,this._name=T,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}return Object.defineProperty(x.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(x.prototype,"cameras",{get:function(){return this._cameras},enumerable:!1,configurable:!0}),x.prototype.getClassName=function(){return"PostProcessRenderPipeline"},Object.defineProperty(x.prototype,"isSupported",{get:function(){for(var G in this._renderEffects)if(this._renderEffects.hasOwnProperty(G)&&!this._renderEffects[G].isSupported)return!1;return!0},enumerable:!1,configurable:!0}),x.prototype.addEffect=function(G){this._renderEffects[G._name]=G},x.prototype._rebuild=function(){},x.prototype._enableEffect=function(G,T){var h=this._renderEffects[G];!h||h._enable(R.b.MakeArray(T||this._cameras))},x.prototype._disableEffect=function(G,T){var h=this._renderEffects[G];!h||h._disable(R.b.MakeArray(T||this._cameras))},x.prototype._attachCameras=function(G,T){var h=R.b.MakeArray(G||this._cameras);if(!!h){var f=[],d;for(d=0;d<h.length;d++){var g=h[d];if(!!g){var p=g.name;this._cameras.indexOf(g)===-1?this._cameras[p]=g:T&&f.push(d)}}for(d=0;d<f.length;d++)h.splice(f[d],1);for(var _ in this._renderEffects)this._renderEffects.hasOwnProperty(_)&&this._renderEffects[_]._attachCameras(h)}},x.prototype._detachCameras=function(G){var T=R.b.MakeArray(G||this._cameras);if(!!T){for(var h in this._renderEffects)this._renderEffects.hasOwnProperty(h)&&this._renderEffects[h]._detachCameras(T);for(var f=0;f<T.length;f++)this._cameras.splice(this._cameras.indexOf(T[f]),1)}},x.prototype._update=function(){for(var G in this._renderEffects)this._renderEffects.hasOwnProperty(G)&&this._renderEffects[G]._update();for(var T=0;T<this._cameras.length;T++)if(!!this._cameras[T]){var h=this._cameras[T].name;this._renderEffectsForIsolatedPass[h]&&this._renderEffectsForIsolatedPass[h]._update()}},x.prototype._reset=function(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array},x.prototype._enableMSAAOnFirstPostProcess=function(G){if(!this.engine._features.supportMSAA)return!1;var T=Object.keys(this._renderEffects);if(T.length>0){var h=this._renderEffects[T[0]].getPostProcesses();h&&(h[0].samples=G)}return!0},x.prototype.setPrePassRenderer=function(G){return!1},x.prototype.dispose=function(){},Object(S.c)([Object(U.c)()],x.prototype,"_name",void 0),x}()},482:function(we,P,u){"use strict";u.d(P,"a",function(){return O});var S=u(452),R=u(548),U=u(449);Object.defineProperty(U.a.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){var x=this._getComponent(S.a.NAME_POSTPROCESSRENDERPIPELINEMANAGER);x||(x=new O(this),this._addComponent(x)),this._postProcessRenderPipelineManager=new R.a}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});var O=function(){function x(G){this.name=S.a.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=G}return x.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(S.a.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)},x.prototype.rebuild=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()},x.prototype.dispose=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()},x.prototype._gatherRenderTargets=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()},x}()},486:function(we,P,u){"use strict";u.d(P,"b",function(){return _}),u.d(P,"a",function(){return m});var S=u(434),R=u(444),U=u(445),O=u(435),x="passPixelShader",G=`
varying vec2 vUV;
uniform sampler2D textureSampler;
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
}`;O.a.ShadersStore[x]=G;var T={name:x,shader:G},h="passCubePixelShader",f=`
varying vec2 vUV;
uniform samplerCube textureSampler;
void main(void)
{
vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;O.a.ShadersStore[h]=f;var d={name:h,shader:f},g=u(437),p=u(439),_=function(l){Object(S.d)(y,l);function y(E,A,F,B,L,I,z,k){return F===void 0&&(F=null),z===void 0&&(z=0),k===void 0&&(k=!1),l.call(this,E,"pass",null,null,A,F,B,L,I,void 0,z,void 0,null,k)||this}return y.prototype.getClassName=function(){return"PassPostProcess"},y._Parse=function(E,A,F,B){return p.a.Parse(function(){return new y(E.name,E.options,A,E.renderTargetSamplingMode,E._engine,E.reusable)},E,F,B)},y}(R.a);g.a.RegisteredTypes["BABYLON.PassPostProcess"]=_;var m=function(l){Object(S.d)(y,l);function y(E,A,F,B,L,I,z,k){F===void 0&&(F=null),z===void 0&&(z=0),k===void 0&&(k=!1);var j=l.call(this,E,"passCube",null,null,A,F,B,L,I,"#define POSITIVEX",z,void 0,null,k)||this;return j._face=0,j}return Object.defineProperty(y.prototype,"face",{get:function(){return this._face},set:function(E){if(!(E<0||E>5))switch(this._face=E,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");break}},enumerable:!1,configurable:!0}),y.prototype.getClassName=function(){return"PassCubePostProcess"},y._Parse=function(E,A,F,B){return p.a.Parse(function(){return new y(E.name,E.options,A,E.renderTargetSamplingMode,E._engine,E.reusable)},E,F,B)},y}(R.a);U.a._RescalePostProcessFactory=function(l){return new _("rescale",1,null,2,l,!1,0)}},492:function(we,P,u){"use strict";var S=u(456),R=u(440),U=u(443),O=u(467);O.a.prototype.updateRawTexture=function(h,f,d,g,p,_){if(p===void 0&&(p=null),_===void 0&&(_=0),!!h){var m=this._getRGBABufferInternalSizedFormat(_,d),l=this._getInternalFormat(d),y=this._getWebGLTextureType(_);this._bindTextureDirectly(this._gl.TEXTURE_2D,h,!0),this._unpackFlipY(g===void 0?!0:!!g),this._doNotHandleContextLost||(h._bufferView=f,h.format=d,h.type=_,h.invertY=g,h._compression=p),h.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),p&&f?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[p],h.width,h.height,0,f):this._gl.texImage2D(this._gl.TEXTURE_2D,0,m,h.width,h.height,0,l,y,f),h.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),h.isReady=!0}},O.a.prototype.createRawTexture=function(h,f,d,g,p,_,m,l,y){l===void 0&&(l=null),y===void 0&&(y=0);var E=new S.a(this,S.b.Raw);E.baseWidth=f,E.baseHeight=d,E.width=f,E.height=d,E.format=g,E.generateMipMaps=p,E.samplingMode=m,E.invertY=_,E._compression=l,E.type=y,this._doNotHandleContextLost||(E._bufferView=h),this.updateRawTexture(E,h,g,_,l,y),this._bindTextureDirectly(this._gl.TEXTURE_2D,E,!0);var A=this._getSamplingParameters(m,p);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,A.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,A.min),p&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(E),E},O.a.prototype.createRawCubeTexture=function(h,f,d,g,p,_,m,l){l===void 0&&(l=null);var y=this._gl,E=new S.a(this,S.b.CubeRaw);E.isCube=!0,E.format=d,E.type=g,this._doNotHandleContextLost||(E._bufferViewArray=h);var A=this._getWebGLTextureType(g),F=this._getInternalFormat(d);F===y.RGB&&(F=y.RGBA),A===y.FLOAT&&!this._caps.textureFloatLinearFiltering?(p=!1,m=1,R.a.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):A===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(p=!1,m=1,R.a.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):A===y.FLOAT&&!this._caps.textureFloatRender?(p=!1,R.a.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):A===y.HALF_FLOAT&&!this._caps.colorBufferFloat&&(p=!1,R.a.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));var B=f,L=B;E.width=B,E.height=L;var I=!this.needPOTTextures||U.b.IsExponentOfTwo(E.width)&&U.b.IsExponentOfTwo(E.height);I||(p=!1),h&&this.updateRawCubeTexture(E,h,d,g,_,l),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,E,!0),h&&p&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);var z=this._getSamplingParameters(m,p);return y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_MAG_FILTER,z.mag),y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_MIN_FILTER,z.min),y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),this._bindTextureDirectly(y.TEXTURE_CUBE_MAP,null),E.generateMipMaps=p,E.samplingMode=m,E},O.a.prototype.updateRawCubeTexture=function(h,f,d,g,p,_,m){_===void 0&&(_=null),m===void 0&&(m=0),h._bufferViewArray=f,h.format=d,h.type=g,h.invertY=p,h._compression=_;var l=this._gl,y=this._getWebGLTextureType(g),E=this._getInternalFormat(d),A=this._getRGBABufferInternalSizedFormat(g),F=!1;E===l.RGB&&(E=l.RGBA,F=!0),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,h,!0),this._unpackFlipY(p===void 0?!0:!!p),h.width%4!=0&&l.pixelStorei(l.UNPACK_ALIGNMENT,1);for(var B=0;B<6;B++){var L=f[B];_?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+B,m,this.getCaps().s3tc[_],h.width,h.height,0,L):(F&&(L=x(L,h.width,h.height,g)),l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+B,m,A,h.width,h.height,0,E,y,L))}var I=!this.needPOTTextures||U.b.IsExponentOfTwo(h.width)&&U.b.IsExponentOfTwo(h.height);I&&h.generateMipMaps&&m===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),h.isReady=!0},O.a.prototype.createRawCubeTextureFromUrl=function(h,f,d,g,p,_,m,l,y,E,A,F){var B=this;y===void 0&&(y=null),E===void 0&&(E=null),A===void 0&&(A=3),F===void 0&&(F=!1);var L=this._gl,I=this.createRawCubeTexture(null,d,g,p,!_,F,A,null);f==null||f._addPendingData(I),I.url=h,this._internalTexturesCache.push(I);var z=function(j,w){f==null||f._removePendingData(I),E&&j&&E(j.status+" "+j.statusText,w)},k=function(j){var w=I.width,Q=m(j);if(!!Q){if(l){var W=B._getWebGLTextureType(p),Y=B._getInternalFormat(g),he=B._getRGBABufferInternalSizedFormat(p),le=!1;Y===L.RGB&&(Y=L.RGBA,le=!0),B._bindTextureDirectly(L.TEXTURE_CUBE_MAP,I,!0),B._unpackFlipY(!1);for(var J=l(Q),Re=0;Re<J.length;Re++)for(var Me=w>>Re,me=0;me<6;me++){var H=J[Re][me];le&&(H=x(H,Me,Me,p)),L.texImage2D(me,Re,he,Me,Me,0,Y,W,H)}B._bindTextureDirectly(L.TEXTURE_CUBE_MAP,null)}else B.updateRawCubeTexture(I,Q,g,p,F);I.isReady=!0,f==null||f._removePendingData(I),y&&y()}};return this._loadFile(h,function(j){k(j)},void 0,f==null?void 0:f.offlineProvider,!0,z),I};function x(h,f,d,g){var p;g===1?p=new Float32Array(f*d*4):p=new Uint32Array(f*d*4);for(var _=0;_<f;_++)for(var m=0;m<d;m++){var l=(m*f+_)*3,y=(m*f+_)*4;p[y+0]=h[l+0],p[y+1]=h[l+1],p[y+2]=h[l+2],p[y+3]=1}return p}function G(h){return function(f,d,g,p,_,m,l,y,E,A){E===void 0&&(E=null),A===void 0&&(A=0);var F=h?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,B=h?S.b.Raw3D:S.b.Raw2DArray,L=new S.a(this,B);L.baseWidth=d,L.baseHeight=g,L.baseDepth=p,L.width=d,L.height=g,L.depth=p,L.format=_,L.type=A,L.generateMipMaps=m,L.samplingMode=y,h?L.is3D=!0:L.is2DArray=!0,this._doNotHandleContextLost||(L._bufferView=f),h?this.updateRawTexture3D(L,f,_,l,E,A):this.updateRawTexture2DArray(L,f,_,l,E,A),this._bindTextureDirectly(F,L,!0);var I=this._getSamplingParameters(y,m);return this._gl.texParameteri(F,this._gl.TEXTURE_MAG_FILTER,I.mag),this._gl.texParameteri(F,this._gl.TEXTURE_MIN_FILTER,I.min),m&&this._gl.generateMipmap(F),this._bindTextureDirectly(F,null),this._internalTexturesCache.push(L),L}}O.a.prototype.createRawTexture2DArray=G(!1),O.a.prototype.createRawTexture3D=G(!0);function T(h){return function(f,d,g,p,_,m){_===void 0&&(_=null),m===void 0&&(m=0);var l=h?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,y=this._getWebGLTextureType(m),E=this._getInternalFormat(g),A=this._getRGBABufferInternalSizedFormat(m,g);this._bindTextureDirectly(l,f,!0),this._unpackFlipY(p===void 0?!0:!!p),this._doNotHandleContextLost||(f._bufferView=d,f.format=g,f.invertY=p,f._compression=_),f.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),_&&d?this._gl.compressedTexImage3D(l,0,this.getCaps().s3tc[_],f.width,f.height,f.depth,0,d):this._gl.texImage3D(l,0,A,f.width,f.height,f.depth,0,E,y,d),f.generateMipMaps&&this._gl.generateMipmap(l),this._bindTextureDirectly(l,null),f.isReady=!0}}O.a.prototype.updateRawTexture2DArray=T(!1),O.a.prototype.updateRawTexture3D=T(!0)},498:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(439),U=u(436),O=u(441),x=u(453),G=u(484);x.a.AddNodeConstructor("Light_Type_3",function(h,f){return function(){return new T(h,U.e.Zero(),f)}});var T=function(h){Object(S.d)(f,h);function f(d,g,p){var _=h.call(this,d,p)||this;return _.groundColor=new O.a(0,0,0),_.direction=g||U.e.Up(),_}return f.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},f.prototype.getClassName=function(){return"HemisphericLight"},f.prototype.setDirectionToTarget=function(d){return this.direction=U.e.Normalize(d.subtract(U.e.Zero())),this.direction},f.prototype.getShadowGenerator=function(){return null},f.prototype.transferToEffect=function(d,g){var p=U.e.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",p.x,p.y,p.z,0,g),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),g),this},f.prototype.transferToNodeMaterialEffect=function(d,g){var p=U.e.Normalize(this.direction);return d.setFloat3(g,p.x,p.y,p.z),this},f.prototype.computeWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=U.a.Identity()),this._worldMatrix},f.prototype.getTypeID=function(){return G.a.LIGHTTYPEID_HEMISPHERICLIGHT},f.prototype.prepareLightSpecificDefines=function(d,g){d["HEMILIGHT"+g]=!0},Object(S.c)([Object(R.e)()],f.prototype,"groundColor",void 0),Object(S.c)([Object(R.o)()],f.prototype,"direction",void 0),f}(G.a)},500:function(we,P,u){"use strict";var S=u(434),R=u(456),U=u(440),O=u(595),x=u(467);x.a.prototype.createRenderTargetTexture=function(G,T){var h=new O.a;T!==void 0&&typeof T=="object"?(h.generateMipMaps=T.generateMipMaps,h.generateDepthBuffer=!!T.generateDepthBuffer,h.generateStencilBuffer=!!T.generateStencilBuffer,h.type=T.type===void 0?0:T.type,h.samplingMode=T.samplingMode===void 0?3:T.samplingMode,h.format=T.format===void 0?5:T.format):(h.generateMipMaps=T,h.generateDepthBuffer=!0,h.generateStencilBuffer=!1,h.type=0,h.samplingMode=3,h.format=5),(h.type===1&&!this._caps.textureFloatLinearFiltering||h.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(h.samplingMode=1),h.type===1&&!this._caps.textureFloat&&(h.type=0,U.a.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var f=this._gl,d=new R.a(this,R.b.RenderTarget),g=G.width||G,p=G.height||G,_=G.layers||0,m=this._getSamplingParameters(h.samplingMode,!!h.generateMipMaps),l=_!==0?f.TEXTURE_2D_ARRAY:f.TEXTURE_2D,y=this._getRGBABufferInternalSizedFormat(h.type,h.format),E=this._getInternalFormat(h.format),A=this._getWebGLTextureType(h.type);this._bindTextureDirectly(l,d),_!==0?(d.is2DArray=!0,f.texImage3D(l,0,y,g,p,_,0,E,A,null)):f.texImage2D(l,0,y,g,p,0,E,A,null),f.texParameteri(l,f.TEXTURE_MAG_FILTER,m.mag),f.texParameteri(l,f.TEXTURE_MIN_FILTER,m.min),f.texParameteri(l,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(l,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),h.generateMipMaps&&this._gl.generateMipmap(l),this._bindTextureDirectly(l,null);var F=this._currentFramebuffer,B=f.createFramebuffer();return this._bindUnboundFramebuffer(B),d._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!h.generateStencilBuffer,h.generateDepthBuffer,g,p),d.is2DArray||f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,d._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(F),d._framebuffer=B,d.baseWidth=g,d.baseHeight=p,d.width=g,d.height=p,d.depth=_,d.isReady=!0,d.samples=1,d.generateMipMaps=!!h.generateMipMaps,d.samplingMode=h.samplingMode,d.type=h.type,d.format=h.format,d._generateDepthBuffer=h.generateDepthBuffer,d._generateStencilBuffer=!!h.generateStencilBuffer,this._internalTexturesCache.push(d),d},x.a.prototype.createDepthStencilTexture=function(G,T){if(T.isCube){var h=G.width||G;return this._createDepthStencilCubeTexture(h,T)}else return this._createDepthStencilTexture(G,T)},x.a.prototype._createDepthStencilTexture=function(G,T){var h=this._gl,f=G.layers||0,d=f!==0?h.TEXTURE_2D_ARRAY:h.TEXTURE_2D,g=new R.a(this,R.b.Depth);if(!this._caps.depthTextureExtension)return U.a.Error("Depth texture is not supported by your browser or hardware."),g;var p=Object(S.a)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},T);this._bindTextureDirectly(d,g,!0),this._setupDepthStencilTexture(g,G,p.generateStencil,p.bilinearFiltering,p.comparisonFunction);var _=p.generateStencil?h.UNSIGNED_INT_24_8:h.UNSIGNED_INT,m=p.generateStencil?h.DEPTH_STENCIL:h.DEPTH_COMPONENT,l=m;return this.webGLVersion>1&&(l=p.generateStencil?h.DEPTH24_STENCIL8:h.DEPTH_COMPONENT24),g.is2DArray?h.texImage3D(d,0,l,g.width,g.height,f,0,m,_,null):h.texImage2D(d,0,l,g.width,g.height,0,m,_,null),this._bindTextureDirectly(d,null),g}},502:function(we,P,u){"use strict";u.d(P,"a",function(){return Te});var S=u(436),R=u(447),U=u(442),O=u(538),x=u(454),G=u(441),T=u(455),h=u(533),f=u(476),d=u(459),g=u(435),p="mrtFragmentDeclaration",_=`#if defined(WEBGL2) || defined(WEBGPU)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;g.a.IncludesShadersStore[p]=_;var m={name:p,shader:_},l=u(614),y=u(615),E=u(616),A="geometryPixelShader",F=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY) && (defined(HAS_SPECULAR) || defined(HAS_REFLECTIVITY))
varying vec2 vReflectivityUV;
uniform sampler2D reflectivitySampler;
#endif
#ifdef ALPHATEST
uniform sampler2D diffuseSampler;
#endif
#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
void main() {
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#else
normalOutput=normalize(vNormalV);
#endif
#ifdef PREPASS
#ifdef PREPASS_DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef PREPASS_NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#else
gl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
gl_FragData[1]=vec4(normalOutput,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
#ifdef HAS_SPECULAR

vec4 reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#elif HAS_REFLECTIVITY

vec4 reflectivity=vec4(texture2D(reflectivitySampler,vReflectivityUV).rgb,1.0);
#else
vec4 reflectivity=vec4(0.0,0.0,0.0,1.0);
#endif
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;g.a.ShadersStore[A]=F;var B={name:A,shader:F},L=u(487),I=u(496),z=u(497),k=u(501),j="geometryVertexDeclaration",w=`
uniform mat4 viewProjection;
uniform mat4 view;`;g.a.IncludesShadersStore[j]=w;var Q={name:j,shader:w},W=u(674),Y="geometryUboDeclaration",he="#include<sceneUboDeclaration>";g.a.IncludesShadersStore[Y]=he;var le={name:Y,shader:he},J=u(507),Re=u(508),Me=u(488),me=u(489),H=u(675),q="geometryVertexShader",_e=`precision highp float;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
attribute vec3 position;
attribute vec3 normal;
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;
varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;
varying vec2 vReflectivityUV;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
uniform mat4 previousWorld;
uniform mat4 previousViewProjection;
#ifdef BONES_VELOCITY_ENABLED
#if NUM_BONE_INFLUENCERS>0
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
void main(void)
{
vec3 positionUpdated=position;
vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)

vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*previousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
vec4 pos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;
vNormalW=normalUpdated;
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
vViewPos=view*pos;
#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*previousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*previousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=pos.xyz/pos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uv;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#else
vUV=uv2;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;g.a.ShadersStore[q]=_e;var Ee={name:q,shader:_e},Te=function(){function se(ve,ye){ye===void 0&&(ye=1),this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this._scene=ve,this._ratio=ye,this._useUbo=ve.getEngine().supportsUniformBuffers,se._SceneComponentInitialization(this._scene),this._createRenderTargets()}return se.prototype._linkPrePassRenderer=function(ve){this._linkedWithPrePass=!0,this._prePassRenderer=ve,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(function(ye){}))},se.prototype._unlinkPrePassRenderer=function(){this._linkedWithPrePass=!1,this._createRenderTargets()},se.prototype._resetLayout=function(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachments=[]},se.prototype._forceTextureType=function(ve,ye){ve===se.POSITION_TEXTURE_TYPE?(this._positionIndex=ye,this._enablePosition=!0):ve===se.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=ye,this._enableVelocity=!0):ve===se.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=ye,this._enableReflectivity=!0):ve===se.DEPTH_TEXTURE_TYPE?this._depthIndex=ye:ve===se.NORMAL_TEXTURE_TYPE&&(this._normalIndex=ye)},se.prototype._setAttachments=function(ve){this._attachments=ve},se.prototype._linkInternalTexture=function(ve){this._multiRenderTarget._texture=ve},Object.defineProperty(se.prototype,"renderList",{get:function(){return this._multiRenderTarget.renderList},set:function(ve){this._multiRenderTarget.renderList=ve},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"isSupported",{get:function(){return this._multiRenderTarget.isSupported},enumerable:!1,configurable:!0}),se.prototype.getTextureIndex=function(ve){switch(ve){case se.POSITION_TEXTURE_TYPE:return this._positionIndex;case se.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case se.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;default:return-1}},Object.defineProperty(se.prototype,"enablePosition",{get:function(){return this._enablePosition},set:function(ve){this._enablePosition=ve,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"enableVelocity",{get:function(){return this._enableVelocity},set:function(ve){this._enableVelocity=ve,ve||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"enableReflectivity",{get:function(){return this._enableReflectivity},set:function(ve){this._enableReflectivity=ve,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"ratio",{get:function(){return this._ratio},enumerable:!1,configurable:!0}),se.prototype.isReady=function(ve,ye){var Le=ve.getMaterial();if(Le&&Le.disableDepthWrite)return!1;var be=[],ze=[R.b.PositionKind,R.b.NormalKind],Ye=ve.getMesh();if(Le){var He=!1;Le.needAlphaTesting()&&Le.getAlphaTestTexture()&&(be.push("#define ALPHATEST"),be.push("#define ALPHATEST_UV"+(Le.getAlphaTestTexture().coordinatesIndex+1)),He=!0),Le.bumpTexture&&T.a.BumpTextureEnabled&&(be.push("#define BUMP"),be.push("#define BUMP_UV"+(Le.bumpTexture.coordinatesIndex+1)),He=!0),this._enableReflectivity&&(Le instanceof T.a&&Le.specularTexture?(be.push("#define HAS_SPECULAR"),be.push("#define REFLECTIVITY_UV"+(Le.specularTexture.coordinatesIndex+1)),He=!0):Le instanceof h.a&&Le.reflectivityTexture&&(be.push("#define HAS_REFLECTIVITY"),be.push("#define REFLECTIVITY_UV"+(Le.reflectivityTexture.coordinatesIndex+1)),He=!0)),He&&(be.push("#define NEED_UV"),Ye.isVerticesDataPresent(R.b.UVKind)&&(ze.push(R.b.UVKind),be.push("#define UV1")),Ye.isVerticesDataPresent(R.b.UV2Kind)&&(ze.push(R.b.UV2Kind),be.push("#define UV2")))}this._linkedWithPrePass&&(be.push("#define PREPASS"),this._depthIndex!==-1&&(be.push("#define DEPTH_INDEX "+this._depthIndex),be.push("#define PREPASS_DEPTH")),this._normalIndex!==-1&&(be.push("#define NORMAL_INDEX "+this._normalIndex),be.push("#define PREPASS_NORMAL"))),this._enablePosition&&(be.push("#define POSITION"),be.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(be.push("#define VELOCITY"),be.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(Ye)===-1&&be.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(be.push("#define REFLECTIVITY"),be.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),Ye.useBones&&Ye.computeBonesUsingShaders?(ze.push(R.b.MatricesIndicesKind),ze.push(R.b.MatricesWeightsKind),Ye.numBoneInfluencers>4&&(ze.push(R.b.MatricesIndicesExtraKind),ze.push(R.b.MatricesWeightsExtraKind)),be.push("#define NUM_BONE_INFLUENCERS "+Ye.numBoneInfluencers),be.push("#define BonesPerMesh "+(Ye.skeleton?Ye.skeleton.bones.length+1:0))):be.push("#define NUM_BONE_INFLUENCERS 0");var Ue=Ye.morphTargetManager,re=0;Ue&&Ue.numInfluencers>0&&(re=Ue.numInfluencers,be.push("#define MORPHTARGETS"),be.push("#define NUM_MORPH_INFLUENCERS "+re),Ue.isUsingTextureForTargets&&be.push("#define MORPHTARGETS_TEXTURE"),x.a.PrepareAttributesForMorphTargetsInfluencers(ze,Ye,re)),ye&&(be.push("#define INSTANCES"),x.a.PushAttributesForInstances(ze),ve.getRenderingMesh().hasThinInstances&&be.push("#define THIN_INSTANCES")),this._linkedWithPrePass?be.push("#define RENDER_TARGET_COUNT "+this._attachments.length):be.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length);var Z=be.join(`
`);return this._cachedDefines!==Z&&(this._cachedDefines=Z,this._effect=this._scene.getEngine().createEffect("geometry",{attributes:ze,uniformsNames:["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],samplers:["diffuseSampler","bumpSampler","reflectivitySampler","morphTargets"],defines:Z,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:re}},this._scene.getEngine())),this._effect.isReady()},se.prototype.getGBuffer=function(){return this._multiRenderTarget},Object.defineProperty(se.prototype,"samples",{get:function(){return this._multiRenderTarget.samples},set:function(ve){this._multiRenderTarget.samples=ve},enumerable:!1,configurable:!0}),se.prototype.dispose=function(){if(this._resizeObserver){var ve=this._scene.getEngine();ve.onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null}this.getGBuffer().dispose()},se.prototype._assignRenderTargetIndices=function(){var ve=2;return this._enablePosition&&(this._positionIndex=ve,ve++),this._enableVelocity&&(this._velocityIndex=ve,ve++),this._enableReflectivity&&(this._reflectivityIndex=ve,ve++),ve},se.prototype._createRenderTargets=function(){var ve=this,ye=this._scene.getEngine(),Le=this._assignRenderTargetIndices();if(this._multiRenderTarget=new O.a("gBuffer",{width:ye.getRenderWidth()*this._ratio,height:ye.getRenderHeight()*this._ratio},Le,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:1}),!!this.isSupported){this._multiRenderTarget.wrapU=U.a.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=U.a.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null,this._multiRenderTarget.onClearObservable.add(function(ze){ze.clear(new G.b(0,0,0,1),!0,!0,!0)}),this._resizeObserver=ye.onResizeObservable.add(function(){ve._multiRenderTarget&&ve._multiRenderTarget.resize({width:ye.getRenderWidth()*ve._ratio,height:ye.getRenderHeight()*ve._ratio})});var be=function(ze){var Ye=ze.getRenderingMesh(),He=ze.getEffectiveMesh(),Ue=ve._scene,re=Ue.getEngine(),Z=ze.getMaterial();if(!!Z){if(He._internalAbstractMeshDataInfo._isActiveIntermediate=!1,ve._enableVelocity&&!ve._previousTransformationMatrices[He.uniqueId]&&(ve._previousTransformationMatrices[He.uniqueId]={world:S.a.Identity(),viewProjection:Ue.getTransformMatrix()},Ye.skeleton)){var fe=Ye.skeleton.getTransformMatrices(Ye);ve._previousBonesTransformationMatrices[Ye.uniqueId]=ve._copyBonesTransformationMatrices(fe,new Float32Array(fe.length))}var ue=Ye._getInstancesRenderList(ze._id,!!ze.getReplacementMesh());if(!ue.mustReturn){var Ge=re.getCaps().instancedArrays&&(ue.visibleInstances[ze._id]!==null||Ye.hasThinInstances),xe=He.getWorldMatrix();if(ve.isReady(ze,Ge)){if(re.enableEffect(ve._effect),Ye._bind(ze,ve._effect,Z.fillMode),ve._useUbo?(x.a.FinalizeSceneUbo(ve._scene),x.a.BindSceneUniformBuffer(ve._effect,ve._scene.getSceneUniformBuffer())):(ve._effect.setMatrix("viewProjection",Ue.getTransformMatrix()),ve._effect.setMatrix("view",Ue.getViewMatrix())),Z){var ne,Ke=Ye._instanceDataStorage;if(!Ke.isFrozen&&(Z.backFaceCulling||Z.overrideMaterialSideOrientation!==null)){var nt=He._getWorldMatrixDeterminant();ne=Z.overrideMaterialSideOrientation,ne==null&&(ne=Z.sideOrientation),nt<0&&(ne=ne===d.a.ClockWiseSideOrientation?d.a.CounterClockWiseSideOrientation:d.a.ClockWiseSideOrientation)}else ne=Ke.sideOrientation;if(Z._preBind(ve._effect,ne),Z.needAlphaTesting()){var ut=Z.getAlphaTestTexture();ut&&(ve._effect.setTexture("diffuseSampler",ut),ve._effect.setMatrix("diffuseMatrix",ut.getTextureMatrix()))}Z.bumpTexture&&Ue.getEngine().getCaps().standardDerivatives&&T.a.BumpTextureEnabled&&(ve._effect.setFloat3("vBumpInfos",Z.bumpTexture.coordinatesIndex,1/Z.bumpTexture.level,Z.parallaxScaleBias),ve._effect.setMatrix("bumpMatrix",Z.bumpTexture.getTextureMatrix()),ve._effect.setTexture("bumpSampler",Z.bumpTexture),ve._effect.setFloat2("vTangentSpaceParams",Z.invertNormalMapX?-1:1,Z.invertNormalMapY?-1:1)),ve._enableReflectivity&&(Z instanceof T.a&&Z.specularTexture?(ve._effect.setMatrix("reflectivityMatrix",Z.specularTexture.getTextureMatrix()),ve._effect.setTexture("reflectivitySampler",Z.specularTexture)):Z instanceof h.a&&Z.reflectivityTexture&&(ve._effect.setMatrix("reflectivityMatrix",Z.reflectivityTexture.getTextureMatrix()),ve._effect.setTexture("reflectivitySampler",Z.reflectivityTexture)))}Ye.useBones&&Ye.computeBonesUsingShaders&&Ye.skeleton&&(ve._effect.setMatrices("mBones",Ye.skeleton.getTransformMatrices(Ye)),ve._enableVelocity&&ve._effect.setMatrices("mPreviousBones",ve._previousBonesTransformationMatrices[Ye.uniqueId])),x.a.BindMorphTargetParameters(Ye,ve._effect),Ye.morphTargetManager&&Ye.morphTargetManager.isUsingTextureForTargets&&Ye.morphTargetManager._bind(ve._effect),ve._enableVelocity&&(ve._effect.setMatrix("previousWorld",ve._previousTransformationMatrices[He.uniqueId].world),ve._effect.setMatrix("previousViewProjection",ve._previousTransformationMatrices[He.uniqueId].viewProjection)),Ye._processRendering(He,ze,ve._effect,Z.fillMode,ue,Ge,function(pt,Tt){return ve._effect.setMatrix("world",Tt)})}ve._enableVelocity&&(ve._previousTransformationMatrices[He.uniqueId].world=xe.clone(),ve._previousTransformationMatrices[He.uniqueId].viewProjection=ve._scene.getTransformMatrix().clone(),Ye.skeleton&&ve._copyBonesTransformationMatrices(Ye.skeleton.getTransformMatrices(Ye),ve._previousBonesTransformationMatrices[He.uniqueId]))}}};this._multiRenderTarget.customRenderFunction=function(ze,Ye,He,Ue){var re;if(ve._linkedWithPrePass){if(!ve._prePassRenderer.enabled)return;ve._scene.getEngine().bindAttachments(ve._attachments)}if(Ue.length){for(ye.setColorWrite(!1),re=0;re<Ue.length;re++)be(Ue.data[re]);ye.setColorWrite(!0)}for(re=0;re<ze.length;re++)be(ze.data[re]);for(ye.setDepthWrite(!1),re=0;re<Ye.length;re++)be(Ye.data[re]);if(ve.renderTransparentMeshes)for(re=0;re<He.length;re++)be(He.data[re]);ye.setDepthWrite(!0)}}},se.prototype._copyBonesTransformationMatrices=function(ve,ye){for(var Le=0;Le<ve.length;Le++)ye[Le]=ve[Le];return ye},se.DEPTH_TEXTURE_TYPE=0,se.NORMAL_TEXTURE_TYPE=1,se.POSITION_TEXTURE_TYPE=2,se.VELOCITY_TEXTURE_TYPE=3,se.REFLECTIVITY_TEXTURE_TYPE=4,se._SceneComponentInitialization=function(ve){throw f.a.WarnImport("GeometryBufferRendererSceneComponent")},se}()},503:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(440),R=u(588),U=u(436),O=u(462),x=u(446),G=u(510),T=u(465);x.a._PhysicsImpostorParser=function(f,d,g){return new h(d,g.physicsImpostor,{mass:g.physicsMass,friction:g.physicsFriction,restitution:g.physicsRestitution},f)};var h=function(){function f(d,g,p,_){var m=this;if(p===void 0&&(p={mass:0}),this.object=d,this.type=g,this._options=p,this._scene=_,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=U.e.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new U.b,this._tmpQuat2=new U.b,this.beforeStep=function(){!m._physicsEngine||(m.object.translate(m._deltaPosition,-1),m._deltaRotationConjugated&&m.object.rotationQuaternion&&m.object.rotationQuaternion.multiplyToRef(m._deltaRotationConjugated,m.object.rotationQuaternion),m.object.computeWorldMatrix(!1),m.object.parent&&m.object.rotationQuaternion?(m.getParentsRotation(),m._tmpQuat.multiplyToRef(m.object.rotationQuaternion,m._tmpQuat)):m._tmpQuat.copyFrom(m.object.rotationQuaternion||new U.b),m._options.disableBidirectionalTransformation||m.object.rotationQuaternion&&m._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(m,m.object.getAbsolutePosition(),m._tmpQuat),m._onBeforePhysicsStepCallbacks.forEach(function(l){l(m)}))},this.afterStep=function(){!m._physicsEngine||(m._onAfterPhysicsStepCallbacks.forEach(function(l){l(m)}),m._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(m),m.object.parent&&m.object.rotationQuaternion&&(m.getParentsRotation(),m._tmpQuat.conjugateInPlace(),m._tmpQuat.multiplyToRef(m.object.rotationQuaternion,m.object.rotationQuaternion)),m.object.setAbsolutePosition(m.object.position),m._deltaRotation&&m.object.rotationQuaternion&&m.object.rotationQuaternion.multiplyToRef(m._deltaRotation,m.object.rotationQuaternion),m.object.translate(m._deltaPosition,1))},this.onCollideEvent=null,this.onCollide=function(l){if(!(!m._onPhysicsCollideCallbacks.length&&!m.onCollideEvent)&&!!m._physicsEngine){var y=m._physicsEngine.getImpostorWithPhysicsBody(l.body);y&&(m.onCollideEvent&&m.onCollideEvent(m,y),m._onPhysicsCollideCallbacks.filter(function(E){return E.otherImpostors.indexOf(y)!==-1}).forEach(function(E){E.callback(m,y,l.point)}))}},!this.object){S.a.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&p.mass!==0&&S.a.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&d.getScene&&(this._scene=d.getScene()),!!this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=U.b.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new U.b),this._options.mass=p.mass===void 0?0:p.mass,this._options.friction=p.friction===void 0?.2:p.friction,this._options.restitution=p.restitution===void 0?.2:p.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=p.pressure===void 0?200:p.pressure,this._options.stiffness=p.stiffness===void 0?1:p.stiffness,this._options.velocityIterations=p.velocityIterations===void 0?20:p.velocityIterations,this._options.positionIterations=p.positionIterations===void 0?20:p.positionIterations,this._options.fixedPoints=p.fixedPoints===void 0?0:p.fixedPoints,this._options.margin=p.margin===void 0?0:p.margin,this._options.damping=p.damping===void 0?0:p.damping,this._options.path=p.path===void 0?null:p.path,this._options.shape=p.shape===void 0?null:p.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&S.a.Warn("You must affect impostors to children before affecting impostor to parent.")):S.a.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}return Object.defineProperty(f.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"mass",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0},set:function(d){this.setMass(d)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"friction",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0},set:function(d){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,d)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"restitution",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0},set:function(d){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,d)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"pressure",{get:function(){if(!this._physicsEngine)return 0;var d=this._physicsEngine.getPhysicsPlugin();return d.setBodyPressure?d.getBodyPressure(this):0},set:function(d){if(!!this._physicsEngine){var g=this._physicsEngine.getPhysicsPlugin();!g.setBodyPressure||g.setBodyPressure(this,d)}},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"stiffness",{get:function(){if(!this._physicsEngine)return 0;var d=this._physicsEngine.getPhysicsPlugin();return d.getBodyStiffness?d.getBodyStiffness(this):0},set:function(d){if(!!this._physicsEngine){var g=this._physicsEngine.getPhysicsPlugin();!g.setBodyStiffness||g.setBodyStiffness(this,d)}},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"velocityIterations",{get:function(){if(!this._physicsEngine)return 0;var d=this._physicsEngine.getPhysicsPlugin();return d.getBodyVelocityIterations?d.getBodyVelocityIterations(this):0},set:function(d){if(!!this._physicsEngine){var g=this._physicsEngine.getPhysicsPlugin();!g.setBodyVelocityIterations||g.setBodyVelocityIterations(this,d)}},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"positionIterations",{get:function(){if(!this._physicsEngine)return 0;var d=this._physicsEngine.getPhysicsPlugin();return d.getBodyPositionIterations?d.getBodyPositionIterations(this):0},set:function(d){if(!!this._physicsEngine){var g=this._physicsEngine.getPhysicsPlugin();!g.setBodyPositionIterations||g.setBodyPositionIterations(this,d)}},enumerable:!1,configurable:!0}),f.prototype._init=function(){!this._physicsEngine||(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))},f.prototype._getPhysicsParent=function(){if(this.object.parent instanceof O.a){var d=this.object.parent;return d.physicsImpostor}return null},f.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&!this._parent},f.prototype.setScalingUpdated=function(){this.forceUpdate()},f.prototype.forceUpdate=function(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()},Object.defineProperty(f.prototype,"physicsBody",{get:function(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody},set:function(d){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=d,this.resetUpdateFlags()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"parent",{get:function(){return!this._options.ignoreParent&&this._parent?this._parent:null},set:function(d){this._parent=d},enumerable:!1,configurable:!0}),f.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=!1},f.prototype.getObjectExtendSize=function(){if(this.object.getBoundingInfo){var d=this.object.rotationQuaternion,g=this.object.scaling.clone();this.object.rotationQuaternion=f.IDENTITY_QUATERNION;var p=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);p&&p.decompose(g,void 0,void 0);var _=this.object.getBoundingInfo(),m=_.boundingBox.extendSize.scale(2).multiplyInPlace(g);return this.object.rotationQuaternion=d,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),m}else return f.DEFAULT_OBJECT_SIZE},f.prototype.getObjectCenter=function(){if(this.object.getBoundingInfo){var d=this.object.getBoundingInfo();return d.boundingBox.centerWorld}else return this.object.position},f.prototype.getParam=function(d){return this._options[d]},f.prototype.setParam=function(d,g){this._options[d]=g,this._bodyUpdateRequired=!0},f.prototype.setMass=function(d){this.getParam("mass")!==d&&this.setParam("mass",d),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,d)},f.prototype.getLinearVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):U.e.Zero()},f.prototype.setLinearVelocity=function(d){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,d)},f.prototype.getAngularVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):U.e.Zero()},f.prototype.setAngularVelocity=function(d){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,d)},f.prototype.executeNativeFunction=function(d){this._physicsEngine&&d(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)},f.prototype.registerBeforePhysicsStep=function(d){this._onBeforePhysicsStepCallbacks.push(d)},f.prototype.unregisterBeforePhysicsStep=function(d){var g=this._onBeforePhysicsStepCallbacks.indexOf(d);g>-1?this._onBeforePhysicsStepCallbacks.splice(g,1):S.a.Warn("Function to remove was not found")},f.prototype.registerAfterPhysicsStep=function(d){this._onAfterPhysicsStepCallbacks.push(d)},f.prototype.unregisterAfterPhysicsStep=function(d){var g=this._onAfterPhysicsStepCallbacks.indexOf(d);g>-1?this._onAfterPhysicsStepCallbacks.splice(g,1):S.a.Warn("Function to remove was not found")},f.prototype.registerOnPhysicsCollide=function(d,g){var p=d instanceof Array?d:[d];this._onPhysicsCollideCallbacks.push({callback:g,otherImpostors:p})},f.prototype.unregisterOnPhysicsCollide=function(d,g){var p=d instanceof Array?d:[d],_=-1,m=this._onPhysicsCollideCallbacks.some(function(l,y){if(l.callback===g&&l.otherImpostors.length===p.length){var E=l.otherImpostors.every(function(A){return p.indexOf(A)>-1});return E&&(_=y),E}return!1});m?this._onPhysicsCollideCallbacks.splice(_,1):S.a.Warn("Function to remove was not found")},f.prototype.getParentsRotation=function(){var d=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);d;)d.rotationQuaternion?this._tmpQuat2.copyFrom(d.rotationQuaternion):U.b.RotationYawPitchRollToRef(d.rotation.y,d.rotation.x,d.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),d=d.parent;return this._tmpQuat},f.prototype.applyForce=function(d,g){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,d,g),this},f.prototype.applyImpulse=function(d,g){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,d,g),this},f.prototype.createJoint=function(d,g,p){var _=new G.e(g,p);return this.addJoint(d,_),this},f.prototype.addJoint=function(d,g){return this._joints.push({otherImpostor:d,joint:g}),this._physicsEngine&&this._physicsEngine.addJoint(this,d,g),this},f.prototype.addAnchor=function(d,g,p,_,m){if(!this._physicsEngine)return this;var l=this._physicsEngine.getPhysicsPlugin();return l.appendAnchor?(this._physicsEngine&&l.appendAnchor(this,d,g,p,_,m),this):this},f.prototype.addHook=function(d,g,p,_){if(!this._physicsEngine)return this;var m=this._physicsEngine.getPhysicsPlugin();return m.appendAnchor?(this._physicsEngine&&m.appendHook(this,d,g,p,_),this):this},f.prototype.sleep=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this},f.prototype.wakeUp=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this},f.prototype.clone=function(d){return d?new f(d,this.type,this._options,this._scene):null},f.prototype.dispose=function(){var d=this;!this._physicsEngine||(this._joints.forEach(function(g){d._physicsEngine&&d._physicsEngine.removeJoint(d,g.otherImpostor,g.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)},f.prototype.setDeltaPosition=function(d){this._deltaPosition.copyFrom(d)},f.prototype.setDeltaRotation=function(d){this._deltaRotation||(this._deltaRotation=new U.b),this._deltaRotation.copyFrom(d),this._deltaRotationConjugated=this._deltaRotation.conjugate()},f.prototype.getBoxSizeToRef=function(d){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,d),this},f.prototype.getRadius=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0},f.prototype.syncBoneWithImpostor=function(d,g,p,_,m){var l=f._tmpVecs[0],y=this.object;if(y.rotationQuaternion)if(m){var E=f._tmpQuat;y.rotationQuaternion.multiplyToRef(m,E),d.setRotationQuaternion(E,T.c.WORLD,g)}else d.setRotationQuaternion(y.rotationQuaternion,T.c.WORLD,g);l.x=0,l.y=0,l.z=0,p&&(l.x=p.x,l.y=p.y,l.z=p.z,d.getDirectionToRef(l,g,l),_==null&&(_=p.length()),l.x*=_,l.y*=_,l.z*=_),d.getParent()?(l.addInPlace(y.getAbsolutePosition()),d.setAbsolutePosition(l,g)):(g.setAbsolutePosition(y.getAbsolutePosition()),g.position.x-=l.x,g.position.y-=l.y,g.position.z-=l.z)},f.prototype.syncImpostorWithBone=function(d,g,p,_,m,l){var y=this.object;if(y.rotationQuaternion)if(m){var E=f._tmpQuat;d.getRotationQuaternionToRef(T.c.WORLD,g,E),E.multiplyToRef(m,y.rotationQuaternion)}else d.getRotationQuaternionToRef(T.c.WORLD,g,y.rotationQuaternion);var A=f._tmpVecs[0],F=f._tmpVecs[1];l||(l=f._tmpVecs[2],l.x=0,l.y=1,l.z=0),d.getDirectionToRef(l,g,F),d.getAbsolutePositionToRef(g,A),_==null&&p&&(_=p.length()),_!=null&&(A.x+=F.x*_,A.y+=F.y*_,A.z+=F.z*_),y.setAbsolutePosition(A)},f.DEFAULT_OBJECT_SIZE=new U.e(1,1,1),f.IDENTITY_QUATERNION=U.b.Identity(),f._tmpVecs=R.a.BuildArray(3,U.e.Zero),f._tmpQuat=U.b.Identity(),f.NoImpostor=0,f.SphereImpostor=1,f.BoxImpostor=2,f.PlaneImpostor=3,f.MeshImpostor=4,f.CapsuleImpostor=6,f.CylinderImpostor=7,f.ParticleImpostor=8,f.HeightmapImpostor=9,f.ConvexHullImpostor=10,f.CustomImpostor=100,f.RopeImpostor=101,f.ClothImpostor=102,f.SoftbodyImpostor=103,f}()},504:function(we,P,u){"use strict";u.d(P,"a",function(){return g});var S=u(434),R=u(439),U=u(443),O=u(436),x=u(477),G=u(442),T=u(437),h=u(565),f=u(473),d=u(438),g=function(p){Object(S.d)(_,p);function _(m,l,y,E,A,F,B,L,I,z,k,j,w,Q){y===void 0&&(y=null),E===void 0&&(E=!1),A===void 0&&(A=null),F===void 0&&(F=null),B===void 0&&(B=null),L===void 0&&(L=5),I===void 0&&(I=!1),z===void 0&&(z=null),k===void 0&&(k=!1),j===void 0&&(j=.8),w===void 0&&(w=0);var W,Y=p.call(this,l)||this;if(Y.onLoadObservable=new d.c,Y.boundingBoxPosition=O.e.Zero(),Y._rotationY=0,Y._files=null,Y._forcedExtension=null,Y._extensions=null,Y.name=m,Y.url=m,Y._noMipmap=E,Y.hasAlpha=!1,Y._format=L,Y.isCube=!0,Y._textureMatrix=O.a.Identity(),Y._createPolynomials=k,Y.coordinatesMode=G.a.CUBIC_MODE,Y._extensions=y,Y._files=A,Y._forcedExtension=z,Y._loaderOptions=Q,!m&&!A)return Y;var he=m.lastIndexOf("."),le=z||(he>-1?m.substring(he).toLowerCase():""),J=le.indexOf(".dds")===0,Re=le.indexOf(".env")===0;if(Re?(Y.gammaSpace=!1,Y._prefiltered=!1,Y.anisotropicFilteringLevel=1):(Y._prefiltered=I,I&&(Y.gammaSpace=!1,Y.anisotropicFilteringLevel=1)),Y._texture=Y._getFromCache(m,E),!A&&(!Re&&!J&&!y&&(y=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),A=[],y))for(var Me=0;Me<y.length;Me++)A.push(m+y[Me]);Y._files=A;var me=function(){Y.onLoadObservable.notifyObservers(Y),F&&F()};if(Y._texture)Y._texture.isReady?U.b.SetImmediate(function(){return me()}):Y._texture.onLoadedObservable.add(function(){return me()});else{var H=Y.getScene();(H==null?void 0:H.useDelayedTextureLoading)?Y.delayLoadState=4:(I?Y._texture=Y._getEngine().createPrefilteredCubeTexture(m,H,j,w,F,B,L,z,Y._createPolynomials):Y._texture=Y._getEngine().createCubeTexture(m,H,A,E,F,B,Y._format,z,!1,j,w,null,Q),(W=Y._texture)===null||W===void 0||W.onLoadedObservable.add(function(){return Y.onLoadObservable.notifyObservers(Y)}))}return Y}return Object.defineProperty(_.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(m){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(m))){this._boundingBoxSize=m;var l=this.getScene();l&&l.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"rotationY",{get:function(){return this._rotationY},set:function(m){this._rotationY=m,this.setReflectionTextureMatrix(O.a.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"forcedExtension",{get:function(){return this._forcedExtension},enumerable:!1,configurable:!0}),_.CreateFromImages=function(m,l,y){var E="";return m.forEach(function(A){return E+=A}),new _(E,l,null,y,m)},_.CreateFromPrefilteredData=function(m,l,y,E){y===void 0&&(y=null),E===void 0&&(E=!0);var A=l.useDelayedTextureLoading;l.useDelayedTextureLoading=!1;var F=new _(m,l,null,!1,null,null,null,void 0,!0,y,E);return l.useDelayedTextureLoading=A,F},_.prototype.getClassName=function(){return"CubeTexture"},_.prototype.updateURL=function(m,l,y,E){var A;E===void 0&&(E=!1),this.url&&(this.releaseInternalTexture(),(A=this.getScene())===null||A===void 0||A.markAllMaterialsAsDirty(1)),(!this.name||f.a.StartsWith(this.name,"data:"))&&(this.name=m),this.url=m,this.delayLoadState=4,this._prefiltered=E,this._prefiltered&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1),this._forcedExtension=l||null,y&&(this._delayedOnLoad=y),this.delayLoad(l)},_.prototype.delayLoad=function(m){var l=this,y;if(this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),!this._texture)){var E=this.getScene();this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,E,.8,0,this._delayedOnLoad,void 0,this._format,m,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,E,this._files,this._noMipmap,this._delayedOnLoad,null,this._format,m,!1,0,0,null,this._loaderOptions),(y=this._texture)===null||y===void 0||y.onLoadedObservable.add(function(){return l.onLoadObservable.notifyObservers(l)})}},_.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},_.prototype.setReflectionTextureMatrix=function(m){var l=this,y;m.updateFlag!==this._textureMatrix.updateFlag&&(m.isIdentity()!==this._textureMatrix.isIdentity()&&((y=this.getScene())===null||y===void 0||y.markAllMaterialsAsDirty(1,function(E){return E.getActiveTextures().indexOf(l)!==-1})),this._textureMatrix=m)},_.Parse=function(m,l,y){var E=R.a.Parse(function(){var L=!1;return m.prefiltered&&(L=m.prefiltered),new _(y+m.name,l,m.extensions,!1,m.files||null,null,null,void 0,L,m.forcedExtension)},m,l);if(m.boundingBoxPosition&&(E.boundingBoxPosition=O.e.FromArray(m.boundingBoxPosition)),m.boundingBoxSize&&(E.boundingBoxSize=O.e.FromArray(m.boundingBoxSize)),m.animations)for(var A=0;A<m.animations.length;A++){var F=m.animations[A],B=T.a.GetClass("BABYLON.Animation");B&&E.animations.push(B.Parse(F))}return E},_.prototype.clone=function(){var m=this,l=0,y=R.a.Clone(function(){var E=new _(m.url,m.getScene()||m._getEngine(),m._extensions,m._noMipmap,m._files);return l=E.uniqueId,E},this);return y.uniqueId=l,y},Object(S.c)([Object(R.c)()],_.prototype,"url",void 0),Object(S.c)([Object(R.c)("rotationY")],_.prototype,"rotationY",null),Object(S.c)([Object(R.c)("files")],_.prototype,"_files",void 0),Object(S.c)([Object(R.c)("forcedExtension")],_.prototype,"_forcedExtension",void 0),Object(S.c)([Object(R.c)("extensions")],_.prototype,"_extensions",void 0),Object(S.c)([Object(R.j)("textureMatrix")],_.prototype,"_textureMatrix",void 0),_}(x.a);G.a._CubeTextureParser=g.Parse,T.a.RegisteredTypes["BABYLON.CubeTexture"]=g},505:function(we,P,u){"use strict";u.d(P,"a",function(){return f});var S=u(446),R=u(449),U=u(438),O=u(436),x=u(464),G=u(469),T=u(546),h=u(526),f=function(){function d(g){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this.maxDragAngle=0,this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerID=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new U.c,this.onDragStartObservable=new U.c,this.onDragEndObservable=new U.c,this.moveAttached=!0,this.enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=function(_){return!0},this._tmpVector=new O.e(0,0,0),this._alternatePickedPoint=new O.e(0,0,0),this._worldDragAxis=new O.e(0,0,0),this._targetPosition=new O.e(0,0,0),this._attachedToElement=!1,this._startDragRay=new G.a(new O.e,new O.e),this._lastPointerRay={},this._dragDelta=new O.e,this._pointA=new O.e(0,0,0),this._pointC=new O.e(0,0,0),this._localAxis=new O.e(0,0,0),this._lookAt=new O.e(0,0,0),this._options=g||{};var p=0;if(this._options.dragAxis&&p++,this._options.dragPlaneNormal&&p++,p>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}return Object.defineProperty(d.prototype,"options",{get:function(){return this._options},set:function(g){this._options=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"name",{get:function(){return"PointerDrag"},enumerable:!1,configurable:!0}),d.prototype.init=function(){},d.prototype.attach=function(g,p){var _=this;this._scene=g.getScene(),this.attachedNode=g,d._planeScene||(this._debugMode?d._planeScene=this._scene:(d._planeScene=new R.a(this._scene.getEngine(),{virtual:!0}),d._planeScene.detachControl(),this._scene.onDisposeObservable.addOnce(function(){d._planeScene.dispose(),d._planeScene=null}))),this._dragPlane=S.a.CreatePlane("pointerDragPlane",this._debugMode?1:1e4,d._planeScene,!1,S.a.DOUBLESIDE),this.lastDragPosition=new O.e(0,0,0);var m=p||function(l){return _.attachedNode==l||l.isDescendantOf(_.attachedNode)};this._pointerObserver=this._scene.onPointerObservable.add(function(l,y){if(!_.enabled){_._attachedToElement&&_.releaseDrag();return}if(l.type==x.a.POINTERDOWN)_.startAndReleaseDragOnPointerEvents&&!_.dragging&&l.pickInfo&&l.pickInfo.hit&&l.pickInfo.pickedMesh&&l.pickInfo.pickedPoint&&l.pickInfo.ray&&m(l.pickInfo.pickedMesh)&&_._startDrag(l.event.pointerId,l.pickInfo.ray,l.pickInfo.pickedPoint);else if(l.type==x.a.POINTERUP)_.startAndReleaseDragOnPointerEvents&&_.currentDraggingPointerID==l.event.pointerId&&_.releaseDrag();else if(l.type==x.a.POINTERMOVE){var E=l.event.pointerId;if(_.currentDraggingPointerID===d._AnyMouseID&&E!==d._AnyMouseID){var A=l.event,F=A.pointerType==="mouse"||!_._scene.getEngine().hostInformation.isMobile&&A instanceof MouseEvent;F&&(_._lastPointerRay[_.currentDraggingPointerID]&&(_._lastPointerRay[E]=_._lastPointerRay[_.currentDraggingPointerID],delete _._lastPointerRay[_.currentDraggingPointerID]),_.currentDraggingPointerID=E)}_._lastPointerRay[E]||(_._lastPointerRay[E]=new G.a(new O.e,new O.e)),l.pickInfo&&l.pickInfo.ray&&(_._lastPointerRay[E].origin.copyFrom(l.pickInfo.ray.origin),_._lastPointerRay[E].direction.copyFrom(l.pickInfo.ray.direction),_.currentDraggingPointerID==E&&_.dragging&&_._moveDrag(l.pickInfo.ray))}}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(function(){_._moving&&_.moveAttached&&(T.a._RemoveAndStorePivotPoint(_.attachedNode),_._targetPosition.subtractToRef(_.attachedNode.absolutePosition,_._tmpVector),_._tmpVector.scaleInPlace(_.dragDeltaRatio),_.attachedNode.getAbsolutePosition().addToRef(_._tmpVector,_._tmpVector),_.validateDrag(_._tmpVector)&&_.attachedNode.setAbsolutePosition(_._tmpVector),T.a._RestorePivotPoint(_.attachedNode))})},d.prototype.releaseDrag=function(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerID})),this.currentDraggingPointerID=-1,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if(this._scene.activeCamera.getClassName()==="ArcRotateCamera"){var g=this._scene.activeCamera;g.attachControl(g.inputs?g.inputs.noPreventDefault:!0,g._useCtrlForPanning,g._panningMouseButton)}else this._scene.activeCamera.attachControl(this._scene.activeCamera.inputs?this._scene.activeCamera.inputs.noPreventDefault:!0);this._attachedToElement=!1}},d.prototype.startDrag=function(g,p,_){g===void 0&&(g=d._AnyMouseID),this._startDrag(g,p,_);var m=this._lastPointerRay[g];g===d._AnyMouseID&&(m=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),m&&this._moveDrag(m)},d.prototype._startDrag=function(g,p,_){if(!(!this._scene.activeCamera||this.dragging||!this.attachedNode)){T.a._RemoveAndStorePivotPoint(this.attachedNode),p?(this._startDragRay.direction.copyFrom(p.direction),this._startDragRay.origin.copyFrom(p.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,_||this._tmpVector);var m=this._pickWithRayOnDragPlane(this._startDragRay);m&&(this.dragging=!0,this.currentDraggingPointerID=g,this.lastDragPosition.copyFrom(m),this.onDragStartObservable.notifyObservers({dragPlanePoint:m,pointerId:this.currentDraggingPointerID}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)),T.a._RestorePivotPoint(this.attachedNode)}},d.prototype._moveDrag=function(g){this._moving=!0;var p=this._pickWithRayOnDragPlane(g);if(p){this.updateDragPlane&&this._updateDragPlanePosition(g,p);var _=0;this._options.dragAxis?(this.useObjectOrientationForDragging?O.e.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),p.subtractToRef(this.lastDragPosition,this._tmpVector),_=O.e.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(_,this._dragDelta)):(_=this._dragDelta.length(),p.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:_,delta:this._dragDelta,dragPlanePoint:p,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerID}),this.lastDragPosition.copyFrom(p)}},d.prototype._pickWithRayOnDragPlane=function(g){var p=this;if(!g)return null;var _=Math.acos(O.e.Dot(this._dragPlane.forward,g.direction));if(_>Math.PI/2&&(_=Math.PI-_),this.maxDragAngle>0&&_>this.maxDragAngle)if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(g.direction),this.attachedNode.absolutePosition.subtractToRef(g.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*O.e.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);var m=O.e.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-m,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}else return null;var l=d._planeScene.pickWithRay(g,function(y){return y==p._dragPlane});return l&&l.hit&&l.pickedMesh&&l.pickedPoint?l.pickedPoint:null},d.prototype._updateDragPlanePosition=function(g,p){this._pointA.copyFrom(p),this._options.dragAxis?(this.useObjectOrientationForDragging?O.e.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),g.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(O.e.Dot(this._localAxis,this._pointC))>.999?Math.abs(O.e.Dot(O.e.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(O.e.Right()):this._lookAt.copyFrom(O.e.UpReadOnly):(O.e.CrossToRef(this._localAxis,this._pointC,this._lookAt),O.e.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?O.e.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(g.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)},d.prototype.detach=function(){this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this.releaseDrag()},d._AnyMouseID=-2,d}()},510:function(we,P,u){"use strict";u.d(P,"e",function(){return R}),u.d(P,"a",function(){return U}),u.d(P,"d",function(){return O}),u.d(P,"c",function(){return x}),u.d(P,"b",function(){return G});var S=u(434),R=function(){function T(h,f){this.type=h,this.jointData=f,f.nativeParams=f.nativeParams||{}}return Object.defineProperty(T.prototype,"physicsJoint",{get:function(){return this._physicsJoint},set:function(h){this._physicsJoint,this._physicsJoint=h},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"physicsPlugin",{set:function(h){this._physicsPlugin=h},enumerable:!1,configurable:!0}),T.prototype.executeNativeFunction=function(h){h(this._physicsPlugin.world,this._physicsJoint)},T.DistanceJoint=0,T.HingeJoint=1,T.BallAndSocketJoint=2,T.WheelJoint=3,T.SliderJoint=4,T.PrismaticJoint=5,T.UniversalJoint=6,T.Hinge2Joint=T.WheelJoint,T.PointToPointJoint=8,T.SpringJoint=9,T.LockJoint=10,T}(),U=function(T){Object(S.d)(h,T);function h(f){return T.call(this,R.DistanceJoint,f)||this}return h.prototype.updateDistance=function(f,d){this._physicsPlugin.updateDistanceJoint(this,f,d)},h}(R),O=function(T){Object(S.d)(h,T);function h(f,d){return T.call(this,f,d)||this}return h.prototype.setMotor=function(f,d){this._physicsPlugin.setMotor(this,f||0,d)},h.prototype.setLimit=function(f,d){this._physicsPlugin.setLimit(this,f,d)},h}(R),x=function(T){Object(S.d)(h,T);function h(f){return T.call(this,R.HingeJoint,f)||this}return h.prototype.setMotor=function(f,d){this._physicsPlugin.setMotor(this,f||0,d)},h.prototype.setLimit=function(f,d){this._physicsPlugin.setLimit(this,f,d)},h}(O),G=function(T){Object(S.d)(h,T);function h(f){return T.call(this,R.Hinge2Joint,f)||this}return h.prototype.setMotor=function(f,d,g){g===void 0&&(g=0),this._physicsPlugin.setMotor(this,f||0,d,g)},h.prototype.setLimit=function(f,d,g){g===void 0&&(g=0),this._physicsPlugin.setLimit(this,f,d,g)},h}(O)},511:function(we,P,u){"use strict";u.d(P,"a",function(){return x});var S=u(438),R=u(436),U=u(441),O=u(437),x=function(){function G(T,h){this.triggerOptions=T,this.onBeforeExecuteObservable=new S.c,T.parameter?(this.trigger=T.trigger,this._triggerParameter=T.parameter):T.trigger?this.trigger=T.trigger:this.trigger=T,this._nextActiveAction=this,this._condition=h}return G.prototype._prepare=function(){},G.prototype.getTriggerParameter=function(){return this._triggerParameter},G.prototype.setTriggerParameter=function(T){this._triggerParameter=T},G.prototype._executeCurrent=function(T){if(this._nextActiveAction._condition){var h=this._nextActiveAction._condition,f=this._actionManager.getScene().getRenderId();if(h._evaluationId===f){if(!h._currentResult)return}else{if(h._evaluationId=f,!h.isValid()){h._currentResult=!1;return}h._currentResult=!0}}this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(T),this.skipToNextActiveAction()},G.prototype.execute=function(T){},G.prototype.skipToNextActiveAction=function(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this},G.prototype.then=function(T){return this._child=T,T._actionManager=this._actionManager,T._prepare(),T},G.prototype._getProperty=function(T){return this._actionManager._getProperty(T)},G.prototype._getEffectiveTarget=function(T,h){return this._actionManager._getEffectiveTarget(T,h)},G.prototype.serialize=function(T){},G.prototype._serialize=function(T,h){var f={type:1,children:[],name:T.name,properties:T.properties||[]};if(this._child&&this._child.serialize(f),this._condition){var d=this._condition.serialize();return d.children.push(f),h&&h.children.push(d),d}return h&&h.children.push(f),f},G._SerializeValueAsString=function(T){return typeof T=="number"?T.toString():typeof T=="boolean"?T?"true":"false":T instanceof R.d?T.x+", "+T.y:T instanceof R.e?T.x+", "+T.y+", "+T.z:T instanceof U.a?T.r+", "+T.g+", "+T.b:T instanceof U.b?T.r+", "+T.g+", "+T.b+", "+T.a:T},G._GetTargetProperty=function(T){return{name:"target",targetType:T._isMesh?"MeshProperties":T._isLight?"LightProperties":T._isCamera?"CameraProperties":"SceneProperties",value:T._isScene?"Scene":T.name}},G}();O.a.RegisteredTypes["BABYLON.Action"]=x},513:function(we,P,u){"use strict";u.d(P,"a",function(){return G}),u.d(P,"b",function(){return T});var S=u(436),R=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],U=[function(h){return 1},function(h){return h.y},function(h){return h.z},function(h){return h.x},function(h){return h.x*h.y},function(h){return h.y*h.z},function(h){return 3*h.z*h.z-1},function(h){return h.x*h.z},function(h){return h.x*h.x-h.y*h.y}],O=function(h,f){return R[h]*U[h](f)},x=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4],G=function(){function h(){this.preScaled=!1,this.l00=S.e.Zero(),this.l1_1=S.e.Zero(),this.l10=S.e.Zero(),this.l11=S.e.Zero(),this.l2_2=S.e.Zero(),this.l2_1=S.e.Zero(),this.l20=S.e.Zero(),this.l21=S.e.Zero(),this.l22=S.e.Zero()}return h.prototype.addLight=function(f,d,g){var p=new S.e(d.r,d.g,d.b),_=p.scale(g);this.l00=this.l00.add(_.scale(O(0,f))),this.l1_1=this.l1_1.add(_.scale(O(1,f))),this.l10=this.l10.add(_.scale(O(2,f))),this.l11=this.l11.add(_.scale(O(3,f))),this.l2_2=this.l2_2.add(_.scale(O(4,f))),this.l2_1=this.l2_1.add(_.scale(O(5,f))),this.l20=this.l20.add(_.scale(O(6,f))),this.l21=this.l21.add(_.scale(O(7,f))),this.l22=this.l22.add(_.scale(O(8,f)))},h.prototype.scaleInPlace=function(f){this.l00.scaleInPlace(f),this.l1_1.scaleInPlace(f),this.l10.scaleInPlace(f),this.l11.scaleInPlace(f),this.l2_2.scaleInPlace(f),this.l2_1.scaleInPlace(f),this.l20.scaleInPlace(f),this.l21.scaleInPlace(f),this.l22.scaleInPlace(f)},h.prototype.convertIncidentRadianceToIrradiance=function(){this.l00.scaleInPlace(x[0]),this.l1_1.scaleInPlace(x[1]),this.l10.scaleInPlace(x[2]),this.l11.scaleInPlace(x[3]),this.l2_2.scaleInPlace(x[4]),this.l2_1.scaleInPlace(x[5]),this.l20.scaleInPlace(x[6]),this.l21.scaleInPlace(x[7]),this.l22.scaleInPlace(x[8])},h.prototype.convertIrradianceToLambertianRadiance=function(){this.scaleInPlace(1/Math.PI)},h.prototype.preScaleForRendering=function(){this.preScaled=!0,this.l00.scaleInPlace(R[0]),this.l1_1.scaleInPlace(R[1]),this.l10.scaleInPlace(R[2]),this.l11.scaleInPlace(R[3]),this.l2_2.scaleInPlace(R[4]),this.l2_1.scaleInPlace(R[5]),this.l20.scaleInPlace(R[6]),this.l21.scaleInPlace(R[7]),this.l22.scaleInPlace(R[8])},h.FromArray=function(f){var d=new h;return S.e.FromArrayToRef(f[0],0,d.l00),S.e.FromArrayToRef(f[1],0,d.l1_1),S.e.FromArrayToRef(f[2],0,d.l10),S.e.FromArrayToRef(f[3],0,d.l11),S.e.FromArrayToRef(f[4],0,d.l2_2),S.e.FromArrayToRef(f[5],0,d.l2_1),S.e.FromArrayToRef(f[6],0,d.l20),S.e.FromArrayToRef(f[7],0,d.l21),S.e.FromArrayToRef(f[8],0,d.l22),d},h.FromPolynomial=function(f){var d=new h;return d.l00=f.xx.scale(.376127).add(f.yy.scale(.376127)).add(f.zz.scale(.376126)),d.l1_1=f.y.scale(.977204),d.l10=f.z.scale(.977204),d.l11=f.x.scale(.977204),d.l2_2=f.xy.scale(1.16538),d.l2_1=f.yz.scale(1.16538),d.l20=f.zz.scale(1.34567).subtract(f.xx.scale(.672834)).subtract(f.yy.scale(.672834)),d.l21=f.zx.scale(1.16538),d.l22=f.xx.scale(1.16538).subtract(f.yy.scale(1.16538)),d.l1_1.scaleInPlace(-1),d.l11.scaleInPlace(-1),d.l2_1.scaleInPlace(-1),d.l21.scaleInPlace(-1),d.scaleInPlace(Math.PI),d},h}(),T=function(){function h(){this.x=S.e.Zero(),this.y=S.e.Zero(),this.z=S.e.Zero(),this.xx=S.e.Zero(),this.yy=S.e.Zero(),this.zz=S.e.Zero(),this.xy=S.e.Zero(),this.yz=S.e.Zero(),this.zx=S.e.Zero()}return Object.defineProperty(h.prototype,"preScaledHarmonics",{get:function(){return this._harmonics||(this._harmonics=G.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics},enumerable:!1,configurable:!0}),h.prototype.addAmbient=function(f){var d=new S.e(f.r,f.g,f.b);this.xx=this.xx.add(d),this.yy=this.yy.add(d),this.zz=this.zz.add(d)},h.prototype.scaleInPlace=function(f){this.x.scaleInPlace(f),this.y.scaleInPlace(f),this.z.scaleInPlace(f),this.xx.scaleInPlace(f),this.yy.scaleInPlace(f),this.zz.scaleInPlace(f),this.yz.scaleInPlace(f),this.zx.scaleInPlace(f),this.xy.scaleInPlace(f)},h.FromHarmonics=function(f){var d=new h;return d._harmonics=f,d.x=f.l11.scale(1.02333).scale(-1),d.y=f.l1_1.scale(1.02333).scale(-1),d.z=f.l10.scale(1.02333),d.xx=f.l00.scale(.886277).subtract(f.l20.scale(.247708)).add(f.l22.scale(.429043)),d.yy=f.l00.scale(.886277).subtract(f.l20.scale(.247708)).subtract(f.l22.scale(.429043)),d.zz=f.l00.scale(.886277).add(f.l20.scale(.495417)),d.yz=f.l2_1.scale(.858086).scale(-1),d.zx=f.l21.scale(.858086).scale(-1),d.xy=f.l2_2.scale(.858086),d.scaleInPlace(1/Math.PI),d},h.FromArray=function(f){var d=new h;return S.e.FromArrayToRef(f[0],0,d.x),S.e.FromArrayToRef(f[1],0,d.y),S.e.FromArrayToRef(f[2],0,d.z),S.e.FromArrayToRef(f[3],0,d.xx),S.e.FromArrayToRef(f[4],0,d.yy),S.e.FromArrayToRef(f[5],0,d.zz),S.e.FromArrayToRef(f[6],0,d.yz),S.e.FromArrayToRef(f[7],0,d.zx),S.e.FromArrayToRef(f[8],0,d.xy),d},h}()},514:function(we,P,u){"use strict";u.d(P,"a",function(){return U});var S=u(442),R=u(545),U=function(){function O(){}return O.GetEnvironmentBRDFTexture=function(x){if(!x.environmentBRDFTexture){var G=x.useDelayedTextureLoading;x.useDelayedTextureLoading=!1;var T=x._blockEntityCollection;x._blockEntityCollection=!1;var h=S.a.CreateFromBase64String(this._environmentBRDFBase64Texture,"EnvironmentBRDFTexture"+this._instanceNumber++,x,!0,!1,S.a.BILINEAR_SAMPLINGMODE);x._blockEntityCollection=T;var f=x.getEngine().getLoadedTexturesCache(),d=f.indexOf(h.getInternalTexture());d!==-1&&f.splice(d,1),h.isRGBD=!0,h.wrapU=S.a.CLAMP_ADDRESSMODE,h.wrapV=S.a.CLAMP_ADDRESSMODE,x.environmentBRDFTexture=h,x.useDelayedTextureLoading=G,R.a.ExpandRGBDTexture(h)}return x.environmentBRDFTexture},O._instanceNumber=0,O._environmentBRDFBase64Texture="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==",O}()},516:function(we,P,u){"use strict";u.d(P,"a",function(){return he});var S=u(434),R=u(439),U=u(443),O=u(438),x=u(441),G=u(445),T=u(448),h=u(447),f=u(442),d=u(458),g=u(459),p=u(454),_=u(435),m="glowMapGenerationPixelShader",l=`#ifdef DIFFUSE
varying vec2 vUVDiffuse;
uniform sampler2D diffuseSampler;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;
uniform sampler2D opacitySampler;
uniform float opacityIntensity;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;
uniform sampler2D emissiveSampler;
#endif
#ifdef VERTEXALPHA
varying vec4 vColor;
#endif
uniform vec4 glowColor;
void main(void)
{
vec4 finalColor=glowColor;

#ifdef DIFFUSE
vec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);
#ifdef GLOW

finalColor.a*=albedoTexture.a;
#endif
#ifdef HIGHLIGHT

finalColor.a=albedoTexture.a;
#endif
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vUVOpacity);
#ifdef OPACITYRGB
finalColor.a*=getLuminance(opacityMap.rgb);
#else
finalColor.a*=opacityMap.a;
#endif
finalColor.a*=opacityIntensity;
#endif
#ifdef VERTEXALPHA
finalColor.a*=vColor.a;
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
gl_FragColor=texture2D(emissiveSampler,vUVEmissive)*finalColor;
#else
gl_FragColor=finalColor;
#endif
#ifdef HIGHLIGHT

gl_FragColor.a=glowColor.a;
#endif
}`;_.a.ShadersStore[m]=l;var y={name:m,shader:l},E=u(487),A=u(496),F=u(497),B=u(501),L=u(507),I=u(508),z=u(488),k=u(489),j="glowMapGenerationVertexShader",w=`
attribute vec3 position;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

#include<instancesDeclaration>
uniform mat4 viewProjection;
varying vec4 vPosition;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;
uniform mat4 diffuseMatrix;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;
uniform mat4 opacityMatrix;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;
uniform mat4 emissiveMatrix;
#endif
#ifdef VERTEXALPHA
attribute vec4 color;
varying vec4 vColor;
#endif
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#ifdef CUBEMAP
vPosition=finalWorld*vec4(positionUpdated,1.0);
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#else
vPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
gl_Position=vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef DIFFUSEUV2
vUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef OPACITYUV2
vUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef EMISSIVEUV2
vUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef VERTEXALPHA
vColor=color;
#endif
}`;_.a.ShadersStore[j]=w;var Q={name:j,shader:w},W=u(476),Y=u(512),he=function(){function le(J,Re){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new x.b},this.neutralColor=new x.b,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new O.c,this.onBeforeRenderMainTextureObservable=new O.c,this.onBeforeComposeObservable=new O.c,this.onBeforeRenderMeshToEffect=new O.c,this.onAfterRenderMeshToEffect=new O.c,this.onAfterComposeObservable=new O.c,this.onSizeChangedObservable=new O.c,this.name=J,this._scene=Re||T.a.LastCreatedScene,le._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._generateIndexBuffer(),this._generateVertexBuffer()}return Object.defineProperty(le.prototype,"camera",{get:function(){return this._effectLayerOptions.camera},enumerable:!1,configurable:!0}),Object.defineProperty(le.prototype,"renderingGroupId",{get:function(){return this._effectLayerOptions.renderingGroupId},set:function(J){this._effectLayerOptions.renderingGroupId=J},enumerable:!1,configurable:!0}),le.prototype._init=function(J){this._effectLayerOptions=Object(S.a)({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1},J),this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses(),this._mergeEffect=this._createMergeEffect()},le.prototype._generateIndexBuffer=function(){var J=[];J.push(0),J.push(1),J.push(2),J.push(0),J.push(2),J.push(3),this._indexBuffer=this._engine.createIndexBuffer(J)},le.prototype._generateVertexBuffer=function(){var J=[];J.push(1,1),J.push(-1,1),J.push(-1,-1),J.push(1,-1);var Re=new h.b(this._engine,J,h.b.PositionKind,!1,!1,2);this._vertexBuffers[h.b.PositionKind]=Re},le.prototype._setMainTextureSize=function(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?G.a.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?G.a.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)},le.prototype._createMainTexture=function(){var J=this;if(this._mainTexture=new d.a("HighlightLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,0),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=f.a.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=f.a.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(f.a.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0,this._mainTexture.customRenderFunction=function(Me,me,H,q){J.onBeforeRenderMainTextureObservable.notifyObservers(J);var _e,Ee=J._scene.getEngine();if(q.length){for(Ee.setColorWrite(!1),_e=0;_e<q.length;_e++)J._renderSubMesh(q.data[_e]);Ee.setColorWrite(!0)}for(_e=0;_e<Me.length;_e++)J._renderSubMesh(Me.data[_e]);for(_e=0;_e<me.length;_e++)J._renderSubMesh(me.data[_e]);var Te=Ee.getAlphaMode();for(_e=0;_e<H.length;_e++)J._renderSubMesh(H.data[_e],!0);Ee.setAlphaMode(Te)},this._mainTexture.onClearObservable.add(function(Me){Me.clear(J.neutralColor,!0,!0,!0)}),this._scene.getBoundingBoxRenderer){var Re=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(function(){J._scene.getBoundingBoxRenderer().enabled=!J.disableBoundingBoxesFromEffectLayer&&Re}),this._mainTexture.onAfterUnbindObservable.add(function(){J._scene.getBoundingBoxRenderer().enabled=Re})}},le.prototype._addCustomEffectDefines=function(J){},le.prototype._isReady=function(J,Re,Me){var me=J.getMaterial();if(!me||!me.isReadyForSubMesh(J.getMesh(),J,Re))return!1;var H=[],q=[h.b.PositionKind],_e=J.getMesh(),Ee=!1,Te=!1;if(me){var se=me.needAlphaTesting(),ve=me.getAlphaTestTexture(),ye=ve&&ve.hasAlpha&&(me.useAlphaFromDiffuseTexture||me._useAlphaFromAlbedoTexture);ve&&(se||ye)&&(H.push("#define DIFFUSE"),_e.isVerticesDataPresent(h.b.UV2Kind)&&ve.coordinatesIndex===1?(H.push("#define DIFFUSEUV2"),Te=!0):_e.isVerticesDataPresent(h.b.UVKind)&&(H.push("#define DIFFUSEUV1"),Ee=!0),se&&(H.push("#define ALPHATEST"),H.push("#define ALPHATESTVALUE 0.4")));var Le=me.opacityTexture;Le&&(H.push("#define OPACITY"),_e.isVerticesDataPresent(h.b.UV2Kind)&&Le.coordinatesIndex===1?(H.push("#define OPACITYUV2"),Te=!0):_e.isVerticesDataPresent(h.b.UVKind)&&(H.push("#define OPACITYUV1"),Ee=!0))}Me&&(H.push("#define EMISSIVE"),_e.isVerticesDataPresent(h.b.UV2Kind)&&Me.coordinatesIndex===1?(H.push("#define EMISSIVEUV2"),Te=!0):_e.isVerticesDataPresent(h.b.UVKind)&&(H.push("#define EMISSIVEUV1"),Ee=!0)),_e.isVerticesDataPresent(h.b.ColorKind)&&_e.hasVertexAlpha&&(q.push(h.b.ColorKind),H.push("#define VERTEXALPHA")),Ee&&(q.push(h.b.UVKind),H.push("#define UV1")),Te&&(q.push(h.b.UV2Kind),H.push("#define UV2"));var be=new Y.a;if(_e.useBones&&_e.computeBonesUsingShaders){q.push(h.b.MatricesIndicesKind),q.push(h.b.MatricesWeightsKind),_e.numBoneInfluencers>4&&(q.push(h.b.MatricesIndicesExtraKind),q.push(h.b.MatricesWeightsExtraKind)),H.push("#define NUM_BONE_INFLUENCERS "+_e.numBoneInfluencers);var ze=_e.skeleton;ze&&ze.isUsingTextureForMatrices?H.push("#define BONETEXTURE"):H.push("#define BonesPerMesh "+(ze?ze.bones.length+1:0)),_e.numBoneInfluencers>0&&be.addCPUSkinningFallback(0,_e)}else H.push("#define NUM_BONE_INFLUENCERS 0");var Ye=_e.morphTargetManager,He=0;Ye&&Ye.numInfluencers>0&&(H.push("#define MORPHTARGETS"),He=Ye.numInfluencers,H.push("#define NUM_MORPH_INFLUENCERS "+He),Ye.isUsingTextureForTargets&&H.push("#define MORPHTARGETS_TEXTURE"),p.a.PrepareAttributesForMorphTargetsInfluencers(q,_e,He)),Re&&(H.push("#define INSTANCES"),p.a.PushAttributesForInstances(q),J.getRenderingMesh().hasThinInstances&&H.push("#define THIN_INSTANCES")),this._addCustomEffectDefines(H);var Ue=H.join(`
`);return this._cachedDefines!==Ue&&(this._cachedDefines=Ue,this._effectLayerMapGenerationEffect=this._scene.getEngine().createEffect("glowMapGeneration",q,["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices"],["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],Ue,be,void 0,void 0,{maxSimultaneousMorphTargets:He})),this._effectLayerMapGenerationEffect.isReady()},le.prototype.render=function(){var J=this._mergeEffect;if(!!J.isReady()){for(var Re=0;Re<this._postProcesses.length;Re++)if(!this._postProcesses[Re].isReady())return;var Me=this._scene.getEngine();this.onBeforeComposeObservable.notifyObservers(this),Me.enableEffect(J),Me.setState(!1),Me.bindBuffers(this._vertexBuffers,this._indexBuffer,J);var me=Me.getAlphaMode();Me.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(J),Me.setAlphaMode(me),this.onAfterComposeObservable.notifyObservers(this);var H=this._mainTexture.getSize();this._setMainTextureSize(),(H.width!==this._mainTextureDesiredSize.width||H.height!==this._mainTextureDesiredSize.height)&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}},le.prototype.hasMesh=function(J){return this.renderingGroupId===-1||J.renderingGroupId===this.renderingGroupId},le.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender},le.prototype._shouldRenderMesh=function(J){return!0},le.prototype._canRenderMesh=function(J,Re){return!Re.needAlphaBlendingForMesh(J)},le.prototype._shouldRenderEmissiveTextureForMesh=function(){return!0},le.prototype._renderSubMesh=function(J,Re){var Me=this,me;if(Re===void 0&&(Re=!1),!!this.shouldRender()){var H=J.getMaterial(),q=J.getMesh(),_e=J.getReplacementMesh(),Ee=J.getRenderingMesh(),Te=J.getEffectiveMesh(),se=this._scene,ve=se.getEngine();if(Te._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!!H&&!!this._canRenderMesh(Ee,H)){var ye=(me=Ee.overrideMaterialSideOrientation)!==null&&me!==void 0?me:H.sideOrientation,Le=Ee._getWorldMatrixDeterminant();Le<0&&(ye=ye===g.a.ClockWiseSideOrientation?g.a.CounterClockWiseSideOrientation:g.a.ClockWiseSideOrientation);var be=ye===g.a.ClockWiseSideOrientation;ve.setState(H.backFaceCulling,H.zOffset,void 0,be);var ze=Ee._getInstancesRenderList(J._id,!!_e);if(!ze.mustReturn&&!!this._shouldRenderMesh(Ee)){var Ye=ze.hardwareInstancedRendering[J._id]||Ee.hasThinInstances;if(this._setEmissiveTextureAndColor(Ee,J,H),this.onBeforeRenderMeshToEffect.notifyObservers(q),this._useMeshMaterial(Ee))Ee.render(J,Ye,_e||void 0);else if(this._isReady(J,Ye,this._emissiveTextureAndColor.texture)){ve.enableEffect(this._effectLayerMapGenerationEffect),Ee._bind(J,this._effectLayerMapGenerationEffect,g.a.TriangleFillMode),this._effectLayerMapGenerationEffect.setMatrix("viewProjection",se.getTransformMatrix()),this._effectLayerMapGenerationEffect.setMatrix("world",Te.getWorldMatrix()),this._effectLayerMapGenerationEffect.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a);var He=H.needAlphaTesting(),Ue=H.getAlphaTestTexture(),re=Ue&&Ue.hasAlpha&&(H.useAlphaFromDiffuseTexture||H._useAlphaFromAlbedoTexture);if(Ue&&(He||re)){this._effectLayerMapGenerationEffect.setTexture("diffuseSampler",Ue);var Z=Ue.getTextureMatrix();Z&&this._effectLayerMapGenerationEffect.setMatrix("diffuseMatrix",Z)}var fe=H.opacityTexture;if(fe){this._effectLayerMapGenerationEffect.setTexture("opacitySampler",fe),this._effectLayerMapGenerationEffect.setFloat("opacityIntensity",fe.level);var Z=fe.getTextureMatrix();Z&&this._effectLayerMapGenerationEffect.setMatrix("opacityMatrix",Z)}if(this._emissiveTextureAndColor.texture&&(this._effectLayerMapGenerationEffect.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),this._effectLayerMapGenerationEffect.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),Ee.useBones&&Ee.computeBonesUsingShaders&&Ee.skeleton){var ue=Ee.skeleton;if(ue.isUsingTextureForMatrices){var Ge=ue.getTransformMatrixTexture(Ee);if(!Ge)return;this._effectLayerMapGenerationEffect.setTexture("boneSampler",Ge),this._effectLayerMapGenerationEffect.setFloat("boneTextureWidth",4*(ue.bones.length+1))}else this._effectLayerMapGenerationEffect.setMatrices("mBones",ue.getTransformMatrices(Ee))}p.a.BindMorphTargetParameters(Ee,this._effectLayerMapGenerationEffect),Ee.morphTargetManager&&Ee.morphTargetManager.isUsingTextureForTargets&&Ee.morphTargetManager._bind(this._effectLayerMapGenerationEffect),Re&&ve.setAlphaMode(H.alphaMode),Ee._processRendering(Te,J,this._effectLayerMapGenerationEffect,H.fillMode,ze,Ye,function(xe,ne){return Me._effectLayerMapGenerationEffect.setMatrix("world",ne)})}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(q)}}}},le.prototype._useMeshMaterial=function(J){return!1},le.prototype._rebuild=function(){var J=this._vertexBuffers[h.b.PositionKind];J&&J._rebuild(),this._generateIndexBuffer()},le.prototype._disposeTextureAndPostProcesses=function(){this._mainTexture.dispose();for(var J=0;J<this._postProcesses.length;J++)this._postProcesses[J]&&this._postProcesses[J].dispose();this._postProcesses=[];for(var J=0;J<this._textures.length;J++)this._textures[J]&&this._textures[J].dispose();this._textures=[]},le.prototype.dispose=function(){var J=this._vertexBuffers[h.b.PositionKind];J&&(J.dispose(),this._vertexBuffers[h.b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._disposeTextureAndPostProcesses();var Re=this._scene.effectLayers.indexOf(this,0);Re>-1&&this._scene.effectLayers.splice(Re,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()},le.prototype.getClassName=function(){return"EffectLayer"},le.Parse=function(J,Re,Me){var me=U.b.Instantiate(J.customType);return me.Parse(J,Re,Me)},le._SceneComponentInitialization=function(J){throw W.a.WarnImport("EffectLayerSceneComponent")},Object(S.c)([Object(R.c)()],le.prototype,"name",void 0),Object(S.c)([Object(R.f)()],le.prototype,"neutralColor",void 0),Object(S.c)([Object(R.c)()],le.prototype,"isEnabled",void 0),Object(S.c)([Object(R.d)()],le.prototype,"camera",null),Object(S.c)([Object(R.c)()],le.prototype,"renderingGroupId",null),Object(S.c)([Object(R.c)()],le.prototype,"disableBoundingBoxesFromEffectLayer",void 0),le}()},517:function(we,P,u){"use strict";u.d(P,"a",function(){return _});var S=u(434),R=u(442),U=u(444),O=u(435),x="fxaaPixelShader",G=`uniform sampler2D textureSampler;
uniform vec2 texelSize;
varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const float fxaaQualitySubpix=1.0;
const float fxaaQualityEdgeThreshold=0.166;
const float fxaaQualityEdgeThresholdMin=0.0833;
const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);
#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)
void main(){
vec2 posM;
posM.x=vUV.x;
posM.y=vUV.y;
vec4 rgbyM=texture2D(textureSampler,vUV,0.0);
float lumaM=FxaaLuma(rgbyM);
float lumaS=FxaaLuma(texture2D(textureSampler,sampleCoordS,0.0));
float lumaE=FxaaLuma(texture2D(textureSampler,sampleCoordE,0.0));
float lumaN=FxaaLuma(texture2D(textureSampler,sampleCoordN,0.0));
float lumaW=FxaaLuma(texture2D(textureSampler,sampleCoordW,0.0));
float maxSM=max(lumaS,lumaM);
float minSM=min(lumaS,lumaM);
float maxESM=max(lumaE,maxSM);
float minESM=min(lumaE,minSM);
float maxWN=max(lumaN,lumaW);
float minWN=min(lumaN,lumaW);
float rangeMax=max(maxWN,maxESM);
float rangeMin=min(minWN,minESM);
float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;
float range=rangeMax-rangeMin;
float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped)
{
gl_FragColor=rgbyM;
return;
}
#endif
float lumaNW=FxaaLuma(texture2D(textureSampler,sampleCoordNW,0.0));
float lumaSE=FxaaLuma(texture2D(textureSampler,sampleCoordSE,0.0));
float lumaNE=FxaaLuma(texture2D(textureSampler,sampleCoordNE,0.0));
float lumaSW=FxaaLuma(texture2D(textureSampler,sampleCoordSW,0.0));
float lumaNS=lumaN+lumaS;
float lumaWE=lumaW+lumaE;
float subpixRcpRange=1.0/range;
float subpixNSWE=lumaNS+lumaWE;
float edgeHorz1=(-2.0*lumaM)+lumaNS;
float edgeVert1=(-2.0*lumaM)+lumaWE;
float lumaNESE=lumaNE+lumaSE;
float lumaNWNE=lumaNW+lumaNE;
float edgeHorz2=(-2.0*lumaE)+lumaNESE;
float edgeVert2=(-2.0*lumaN)+lumaNWNE;
float lumaNWSW=lumaNW+lumaSW;
float lumaSWSE=lumaSW+lumaSE;
float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);
float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);
float edgeHorz3=(-2.0*lumaW)+lumaNWSW;
float edgeVert3=(-2.0*lumaS)+lumaSWSE;
float edgeHorz=abs(edgeHorz3)+edgeHorz4;
float edgeVert=abs(edgeVert3)+edgeVert4;
float subpixNWSWNESE=lumaNWSW+lumaNESE;
float lengthSign=texelSize.x;
bool horzSpan=edgeHorz>=edgeVert;
float subpixA=subpixNSWE*2.0+subpixNWSWNESE;
if (!horzSpan)
{
lumaN=lumaW;
}
if (!horzSpan)
{
lumaS=lumaE;
}
if (horzSpan)
{
lengthSign=texelSize.y;
}
float subpixB=(subpixA*(1.0/12.0))-lumaM;
float gradientN=lumaN-lumaM;
float gradientS=lumaS-lumaM;
float lumaNN=lumaN+lumaM;
float lumaSS=lumaS+lumaM;
bool pairN=abs(gradientN)>=abs(gradientS);
float gradient=max(abs(gradientN),abs(gradientS));
if (pairN)
{
lengthSign=-lengthSign;
}
float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);
vec2 posB;
posB.x=posM.x;
posB.y=posM.y;
vec2 offNP;
offNP.x=(!horzSpan) ? 0.0 : texelSize.x;
offNP.y=(horzSpan) ? 0.0 : texelSize.y;
if (!horzSpan)
{
posB.x+=lengthSign*0.5;
}
if (horzSpan)
{
posB.y+=lengthSign*0.5;
}
vec2 posN;
posN.x=posB.x-offNP.x*1.5;
posN.y=posB.y-offNP.y*1.5;
vec2 posP;
posP.x=posB.x+offNP.x*1.5;
posP.y=posB.y+offNP.y*1.5;
float subpixD=((-2.0)*subpixC)+3.0;
float lumaEndN=FxaaLuma(texture2D(textureSampler,posN,0.0));
float subpixE=subpixC*subpixC;
float lumaEndP=FxaaLuma(texture2D(textureSampler,posP,0.0));
if (!pairN)
{
lumaNN=lumaSS;
}
float gradientScaled=gradient*1.0/4.0;
float lumaMM=lumaM-lumaNN*0.5;
float subpixF=subpixD*subpixE;
bool lumaMLTZero=lumaMM<0.0;
lumaEndN-=lumaNN*0.5;
lumaEndP-=lumaNN*0.5;
bool doneN=abs(lumaEndN)>=gradientScaled;
bool doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN)
{
posN.x-=offNP.x*3.0;
}
if (!doneN)
{
posN.y-=offNP.y*3.0;
}
bool doneNP=(!doneN) || (!doneP);
if (!doneP)
{
posP.x+=offNP.x*3.0;
}
if (!doneP)
{
posP.y+=offNP.y*3.0;
}
if (doneNP)
{
if (!doneN) lumaEndN=FxaaLuma(texture2D(textureSampler,posN.xy,0.0));
if (!doneP) lumaEndP=FxaaLuma(texture2D(textureSampler,posP.xy,0.0));
if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;
if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;
doneN=abs(lumaEndN)>=gradientScaled;
doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN) posN.x-=offNP.x*12.0;
if (!doneN) posN.y-=offNP.y*12.0;
doneNP=(!doneN) || (!doneP);
if (!doneP) posP.x+=offNP.x*12.0;
if (!doneP) posP.y+=offNP.y*12.0;
}
float dstN=posM.x-posN.x;
float dstP=posP.x-posM.x;
if (!horzSpan)
{
dstN=posM.y-posN.y;
}
if (!horzSpan)
{
dstP=posP.y-posM.y;
}
bool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;
float spanLength=(dstP+dstN);
bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;
float spanLengthRcp=1.0/spanLength;
bool directionN=dstN<dstP;
float dst=min(dstN,dstP);
bool goodSpan=directionN ? goodSpanN : goodSpanP;
float subpixG=subpixF*subpixF;
float pixelOffset=(dst*(-spanLengthRcp))+0.5;
float subpixH=subpixG*fxaaQualitySubpix;
float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;
float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);
if (!horzSpan)
{
posM.x+=pixelOffsetSubpix*lengthSign;
}
if (horzSpan)
{
posM.y+=pixelOffsetSubpix*lengthSign;
}
#ifdef MALI
if(range<rangeMaxClamped)
{
gl_FragColor=rgbyM;
}
else
{
gl_FragColor=texture2D(textureSampler,posM,0.0);
}
#else
gl_FragColor=texture2D(textureSampler,posM,0.0);
#endif
}`;O.a.ShadersStore[x]=G;var T={name:x,shader:G},h="fxaaVertexShader",f=`
attribute vec2 position;
uniform vec2 texelSize;

varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vUV=(position*madd+madd);
sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;
sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;
sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;
sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;
sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;
sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;
sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;
sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;
gl_Position=vec4(position,0.0,1.0);
}`;O.a.ShadersStore[h]=f;var d={name:h,shader:f},g=u(437),p=u(439),_=function(m){Object(S.d)(l,m);function l(y,E,A,F,B,L,I){A===void 0&&(A=null),I===void 0&&(I=0);var z=m.call(this,y,"fxaa",["texelSize"],null,E,A,F||R.a.BILINEAR_SAMPLINGMODE,B,L,null,I,"fxaa",void 0,!0)||this,k=z._getDefines();return z.updateEffect(k),z.onApplyObservable.add(function(j){var w=z.texelSize;j.setFloat2("texelSize",w.x,w.y)}),z}return l.prototype.getClassName=function(){return"FxaaPostProcess"},l.prototype._getDefines=function(){var y=this.getEngine();if(!y)return null;var E=y.getGlInfo();return E&&E.renderer&&E.renderer.toLowerCase().indexOf("mali")>-1?`#define MALI 1
`:null},l._Parse=function(y,E,A,F){return p.a.Parse(function(){return new l(y.name,y.options,E,y.renderTargetSamplingMode,A.getEngine(),y.reusable)},y,A,F)},l}(U.a);g.a.RegisteredTypes["BABYLON.FxaaPostProcess"]=_},518:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(434),R=u(439),U=u(491),O=u(444),x=u(448),G=u(644),T=u(534),h=function(f){Object(S.d)(d,f);function d(g,p,_,m,l,y,E,A){_===void 0&&(_=null),E===void 0&&(E=0);var F=f.call(this,g,"imageProcessing",[],[],p,_,m,l,y,null,E,"postprocess",null,!0)||this;return F._fromLinearSpace=!0,F._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1},A?(A.applyByPostProcess=!0,F._attachImageProcessingConfiguration(A,!0),F.fromLinearSpace=!1):(F._attachImageProcessingConfiguration(null,!0),F.imageProcessingConfiguration.applyByPostProcess=!0),F.onApply=function(B){F.imageProcessingConfiguration.bind(B,F.aspectRatio)},F}return Object.defineProperty(d.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(g){g.applyByPostProcess=!0,this._attachImageProcessingConfiguration(g)},enumerable:!1,configurable:!0}),d.prototype._attachImageProcessingConfiguration=function(g,p){var _=this;if(p===void 0&&(p=!1),g!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),g)this._imageProcessingConfiguration=g;else{var m=null,l=this.getEngine(),y=this.getCamera();if(y)m=y.getScene();else if(l&&l.scenes){var E=l.scenes;m=E[E.length-1]}else m=x.a.LastCreatedScene;m?this._imageProcessingConfiguration=m.imageProcessingConfiguration:this._imageProcessingConfiguration=new U.a}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){_._updateParameters()})),p||this._updateParameters()}},Object.defineProperty(d.prototype,"isSupported",{get:function(){var g=this.getEffect();return!g||g.isSupported},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"colorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(g){this.imageProcessingConfiguration.colorCurves=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"colorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(g){this.imageProcessingConfiguration.colorCurvesEnabled=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"colorGradingTexture",{get:function(){return this.imageProcessingConfiguration.colorGradingTexture},set:function(g){this.imageProcessingConfiguration.colorGradingTexture=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"colorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(g){this.imageProcessingConfiguration.colorGradingEnabled=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"exposure",{get:function(){return this.imageProcessingConfiguration.exposure},set:function(g){this.imageProcessingConfiguration.exposure=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"toneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(g){this._imageProcessingConfiguration.toneMappingEnabled=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"toneMappingType",{get:function(){return this._imageProcessingConfiguration.toneMappingType},set:function(g){this._imageProcessingConfiguration.toneMappingType=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"contrast",{get:function(){return this.imageProcessingConfiguration.contrast},set:function(g){this.imageProcessingConfiguration.contrast=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"vignetteStretch",{get:function(){return this.imageProcessingConfiguration.vignetteStretch},set:function(g){this.imageProcessingConfiguration.vignetteStretch=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"vignetteCentreX",{get:function(){return this.imageProcessingConfiguration.vignetteCentreX},set:function(g){this.imageProcessingConfiguration.vignetteCentreX=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"vignetteCentreY",{get:function(){return this.imageProcessingConfiguration.vignetteCentreY},set:function(g){this.imageProcessingConfiguration.vignetteCentreY=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"vignetteWeight",{get:function(){return this.imageProcessingConfiguration.vignetteWeight},set:function(g){this.imageProcessingConfiguration.vignetteWeight=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"vignetteColor",{get:function(){return this.imageProcessingConfiguration.vignetteColor},set:function(g){this.imageProcessingConfiguration.vignetteColor=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"vignetteCameraFov",{get:function(){return this.imageProcessingConfiguration.vignetteCameraFov},set:function(g){this.imageProcessingConfiguration.vignetteCameraFov=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"vignetteBlendMode",{get:function(){return this.imageProcessingConfiguration.vignetteBlendMode},set:function(g){this.imageProcessingConfiguration.vignetteBlendMode=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"vignetteEnabled",{get:function(){return this.imageProcessingConfiguration.vignetteEnabled},set:function(g){this.imageProcessingConfiguration.vignetteEnabled=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"fromLinearSpace",{get:function(){return this._fromLinearSpace},set:function(g){this._fromLinearSpace!==g&&(this._fromLinearSpace=g,this._updateParameters())},enumerable:!1,configurable:!0}),d.prototype.getClassName=function(){return"ImageProcessingPostProcess"},d.prototype._updateParameters=function(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);var g="";for(var p in this._defines)this._defines[p]&&(g+="#define "+p+`;\r
`);var _=["textureSampler"],m=["scale"];U.a&&(U.a.PrepareSamplers(_,this._defines),U.a.PrepareUniforms(m,this._defines)),this.updateEffect(g,m,_)},d.prototype.dispose=function(g){f.prototype.dispose.call(this,g),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)},Object(S.c)([Object(R.c)()],d.prototype,"_fromLinearSpace",void 0),d}(O.a)},521:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(436),R=u(450),U=u(513),O=u(515),x=u(441),G=function(){function h(f,d,g,p){this.name=f,this.worldAxisForNormal=d,this.worldAxisForFileX=g,this.worldAxisForFileY=p}return h}(),T=function(){function h(){}return h.ConvertCubeMapTextureToSphericalPolynomial=function(f){var d=this,g;if(!f.isCube)return null;(g=f.getScene())===null||g===void 0||g.getEngine().flushFramebuffer();var p=f.getSize().width,_=f.readPixels(0,void 0,void 0,!1),m=f.readPixels(1,void 0,void 0,!1),l,y;f.isRenderTarget?(l=f.readPixels(3,void 0,void 0,!1),y=f.readPixels(2,void 0,void 0,!1)):(l=f.readPixels(2,void 0,void 0,!1),y=f.readPixels(3,void 0,void 0,!1));var E=f.readPixels(4,void 0,void 0,!1),A=f.readPixels(5,void 0,void 0,!1),F=f.gammaSpace,B=5,L=0;return(f.textureType==1||f.textureType==2)&&(L=1),new Promise(function(I,z){Promise.all([m,_,l,y,E,A]).then(function(k){var j=k[0],w=k[1],Q=k[2],W=k[3],Y=k[4],he=k[5],le={size:p,right:w,left:j,up:Q,down:W,front:Y,back:he,format:B,type:L,gammaSpace:F};I(d.ConvertCubeMapToSphericalPolynomial(le))})})},h.ConvertCubeMapToSphericalPolynomial=function(f){for(var d=new U.a,g=0,p=2/f.size,_=p,m=p*.5-1,l=0;l<6;l++)for(var y=this.FileFaces[l],E=f[y.name],A=m,F=f.format===5?4:3,B=0;B<f.size;B++){for(var L=m,I=0;I<f.size;I++){var z=y.worldAxisForFileX.scale(L).add(y.worldAxisForFileY.scale(A)).add(y.worldAxisForNormal);z.normalize();var k=Math.pow(1+L*L+A*A,-3/2),j=E[B*f.size*F+I*F+0],w=E[B*f.size*F+I*F+1],Q=E[B*f.size*F+I*F+2];isNaN(j)&&(j=0),isNaN(w)&&(w=0),isNaN(Q)&&(Q=0),f.type===0&&(j/=255,w/=255,Q/=255),f.gammaSpace&&(j=Math.pow(R.a.Clamp(j),O.c),w=Math.pow(R.a.Clamp(w),O.c),Q=Math.pow(R.a.Clamp(Q),O.c));var W=4096;j=R.a.Clamp(j,0,W),w=R.a.Clamp(w,0,W),Q=R.a.Clamp(Q,0,W);var Y=new x.a(j,w,Q);d.addLight(z,Y,k),g+=k,L+=p}A+=_}var he=4*Math.PI,le=6,J=he*le/6,Re=J/g;return d.scaleInPlace(Re),d.convertIncidentRadianceToIrradiance(),d.convertIrradianceToLambertianRadiance(),U.b.FromHarmonics(d)},h.FileFaces=[new G("right",new S.e(1,0,0),new S.e(0,0,-1),new S.e(0,-1,0)),new G("left",new S.e(-1,0,0),new S.e(0,0,1),new S.e(0,-1,0)),new G("up",new S.e(0,1,0),new S.e(1,0,0),new S.e(0,0,1)),new G("down",new S.e(0,-1,0),new S.e(1,0,0),new S.e(0,0,-1)),new G("front",new S.e(0,0,1),new S.e(1,0,0),new S.e(0,-1,0)),new G("back",new S.e(0,0,-1),new S.e(-1,0,0),new S.e(0,-1,0))],h}()},522:function(we,P,u){"use strict";var S=u(434),R=u(456),U=u(440),O=u(467);O.a.prototype.createRenderTargetCubeTexture=function(x,G){var T=Object(S.a)({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},G);T.generateStencilBuffer=T.generateDepthBuffer&&T.generateStencilBuffer,(T.type===1&&!this._caps.textureFloatLinearFiltering||T.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(T.samplingMode=1);var h=this._gl,f=new R.a(this,R.b.RenderTarget);this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,f,!0);var d=this._getSamplingParameters(T.samplingMode,T.generateMipMaps);T.type===1&&!this._caps.textureFloat&&(T.type=0,U.a.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MAG_FILTER,d.mag),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MIN_FILTER,d.min),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE);for(var g=0;g<6;g++)h.texImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,this._getRGBABufferInternalSizedFormat(T.type,T.format),x,x,0,this._getInternalFormat(T.format),this._getWebGLTextureType(T.type),null);var p=h.createFramebuffer();return this._bindUnboundFramebuffer(p),f._depthStencilBuffer=this._setupFramebufferDepthAttachments(T.generateStencilBuffer,T.generateDepthBuffer,x,x),T.generateMipMaps&&h.generateMipmap(h.TEXTURE_CUBE_MAP),this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),f._framebuffer=p,f.width=x,f.height=x,f.isReady=!0,f.isCube=!0,f.samples=1,f.generateMipMaps=T.generateMipMaps,f.samplingMode=T.samplingMode,f.type=T.type,f.format=T.format,f._generateDepthBuffer=T.generateDepthBuffer,f._generateStencilBuffer=T.generateStencilBuffer,this._internalTexturesCache.push(f),f}},523:function(we,P,u){"use strict";var S=u(521),R=u(477);Object.defineProperty(R.a.prototype,"sphericalPolynomial",{get:function(){var U=this;if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=S.a.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(function(O){U._texture._sphericalPolynomial=O,U._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(U){this._texture&&(this._texture._sphericalPolynomial=U)},enumerable:!0,configurable:!0})},527:function(we,P,u){"use strict";u.d(P,"a",function(){return O});var S=u(434),R=u(442),U=u(492),O=function(x){Object(S.d)(G,x);function G(T,h,f,d,g,p,_,m,l){p===void 0&&(p=!0),_===void 0&&(_=!1),m===void 0&&(m=3),l===void 0&&(l=0);var y=x.call(this,null,g,!p,_)||this;return y.format=d,y._engine&&(y._texture=y._engine.createRawTexture(T,h,f,d,p,_,m,null,l),y.wrapU=R.a.CLAMP_ADDRESSMODE,y.wrapV=R.a.CLAMP_ADDRESSMODE),y}return G.prototype.update=function(T){this._getEngine().updateRawTexture(this._texture,T,this._texture.format,this._texture.invertY,null,this._texture.type)},G.CreateLuminanceTexture=function(T,h,f,d,g,p,_){return g===void 0&&(g=!0),p===void 0&&(p=!1),_===void 0&&(_=3),new G(T,h,f,1,d,g,p,_)},G.CreateLuminanceAlphaTexture=function(T,h,f,d,g,p,_){return g===void 0&&(g=!0),p===void 0&&(p=!1),_===void 0&&(_=3),new G(T,h,f,2,d,g,p,_)},G.CreateAlphaTexture=function(T,h,f,d,g,p,_){return g===void 0&&(g=!0),p===void 0&&(p=!1),_===void 0&&(_=3),new G(T,h,f,0,d,g,p,_)},G.CreateRGBTexture=function(T,h,f,d,g,p,_,m){return g===void 0&&(g=!0),p===void 0&&(p=!1),_===void 0&&(_=3),m===void 0&&(m=0),new G(T,h,f,4,d,g,p,_,m)},G.CreateRGBATexture=function(T,h,f,d,g,p,_,m){return g===void 0&&(g=!0),p===void 0&&(p=!1),_===void 0&&(_=3),m===void 0&&(m=0),new G(T,h,f,5,d,g,p,_,m)},G.CreateRTexture=function(T,h,f,d,g,p,_,m){return g===void 0&&(g=!0),p===void 0&&(p=!1),_===void 0&&(_=R.a.TRILINEAR_SAMPLINGMODE),m===void 0&&(m=1),new G(T,h,f,6,d,g,p,_,m)},G}(R.a)},529:function(we,P,u){"use strict";u.d(P,"b",function(){return En}),u.d(P,"a",function(){return Ka});var S=u(434),R=u(439),U=u(440),O=u(490),x=u(514),G=u(449),T=u(436),h=u(447),f=u(626),d=u(480),g=u(454),p=function(){function Ve(ce){this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new T.d(1,0),this._texture=null,this.texture=null,this._internalMarkAllSubMeshesAsTexturesDirty=ce}return Ve.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},Ve.prototype.isReadyForSubMesh=function(ce,$){return!(ce._areTexturesDirty&&$.texturesEnabled&&this._texture&&d.a.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())},Ve.prototype.prepareDefines=function(ce,$,ae){this._isEnabled?(ce.ANISOTROPIC=this._isEnabled,this._isEnabled&&!$.isVerticesDataPresent(h.b.TangentKind)&&(ce._needUVs=!0,ce.MAINUV1=!0),ce._areTexturesDirty&&ae.texturesEnabled&&(this._texture&&d.a.AnisotropicTextureEnabled?g.a.PrepareDefinesForMergedUV(this._texture,ce,"ANISOTROPIC_TEXTURE"):ce.ANISOTROPIC_TEXTURE=!1)):(ce.ANISOTROPIC=!1,ce.ANISOTROPIC_TEXTURE=!1)},Ve.prototype.bindForSubMesh=function(ce,$,ae){(!ce.useUbo||!ae||!ce.isSync)&&(this._texture&&d.a.AnisotropicTextureEnabled&&(ce.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),g.a.BindTextureMatrix(this._texture,ce,"anisotropy")),ce.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),$.texturesEnabled&&this._texture&&d.a.AnisotropicTextureEnabled&&ce.setTexture("anisotropySampler",this._texture)},Ve.prototype.hasTexture=function(ce){return this._texture===ce},Ve.prototype.getActiveTextures=function(ce){this._texture&&ce.push(this._texture)},Ve.prototype.getAnimatables=function(ce){this._texture&&this._texture.animations&&this._texture.animations.length>0&&ce.push(this._texture)},Ve.prototype.dispose=function(ce){ce&&this._texture&&this._texture.dispose()},Ve.prototype.getClassName=function(){return"PBRAnisotropicConfiguration"},Ve.AddFallbacks=function(ce,$,ae){return ce.ANISOTROPIC&&$.addFallback(ae++,"ANISOTROPIC"),ae},Ve.AddUniforms=function(ce){ce.push("vAnisotropy","vAnisotropyInfos","anisotropyMatrix")},Ve.PrepareUniformBuffer=function(ce){ce.addUniform("vAnisotropy",3),ce.addUniform("vAnisotropyInfos",2),ce.addUniform("anisotropyMatrix",16)},Ve.AddSamplers=function(ce){ce.push("anisotropySampler")},Ve.prototype.copyTo=function(ce){R.a.Clone(function(){return ce},this)},Ve.prototype.serialize=function(){return R.a.Serialize(this)},Ve.prototype.parse=function(ce,$,ae){var Ie=this;R.a.Parse(function(){return Ie},ce,$,ae)},Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"isEnabled",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"intensity",void 0),Object(S.c)([Object(R.n)()],Ve.prototype,"direction",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"texture",void 0),Ve}(),_=function(){function Ve(ce){this._useEnergyConservation=Ve.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Ve.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Ve.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Ve.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Ve.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Ve.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Ve.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Ve.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=ce}return Ve.prototype._markAllSubMeshesAsMiscDirty=function(){this._internalMarkAllSubMeshesAsMiscDirty()},Ve.prototype.prepareDefines=function(ce){ce.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,ce.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,ce.SPHERICAL_HARMONICS=this._useSphericalHarmonics,ce.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation},Ve.prototype.getClassName=function(){return"PBRBRDFConfiguration"},Ve.prototype.copyTo=function(ce){R.a.Clone(function(){return ce},this)},Ve.prototype.serialize=function(){return R.a.Serialize(this)},Ve.prototype.parse=function(ce,$,ae){var Ie=this;R.a.Parse(function(){return Ie},ce,$,ae)},Ve.DEFAULT_USE_ENERGY_CONSERVATION=!0,Ve.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,Ve.DEFAULT_USE_SPHERICAL_HARMONICS=!0,Ve.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsMiscDirty")],Ve.prototype,"useEnergyConservation",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsMiscDirty")],Ve.prototype,"useSmithVisibilityHeightCorrelated",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsMiscDirty")],Ve.prototype,"useSphericalHarmonics",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsMiscDirty")],Ve.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),Ve}(),m=u(441),l=function(){function Ve(ce){this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=m.a.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=ce}return Ve.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},Ve.prototype.isReadyForSubMesh=function(ce,$){return!(ce._areTexturesDirty&&$.texturesEnabled&&(this._texture&&d.a.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&d.a.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()))},Ve.prototype.prepareDefines=function(ce,$){var ae;this._isEnabled?(ce.SHEEN=this._isEnabled,ce.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,ce.SHEEN_ROUGHNESS=this._roughness!==null,ce.SHEEN_ALBEDOSCALING=this._albedoScaling,ce.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,ce.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((ae=this._textureRoughness)===null||ae===void 0?void 0:ae._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),ce._areTexturesDirty&&$.texturesEnabled&&(this._texture&&d.a.SheenTextureEnabled?g.a.PrepareDefinesForMergedUV(this._texture,ce,"SHEEN_TEXTURE"):ce.SHEEN_TEXTURE=!1,this._textureRoughness&&d.a.SheenTextureEnabled?g.a.PrepareDefinesForMergedUV(this._textureRoughness,ce,"SHEEN_TEXTURE_ROUGHNESS"):ce.SHEEN_TEXTURE_ROUGHNESS=!1)):(ce.SHEEN=!1,ce.SHEEN_TEXTURE=!1,ce.SHEEN_TEXTURE_ROUGHNESS=!1,ce.SHEEN_LINKWITHALBEDO=!1,ce.SHEEN_ROUGHNESS=!1,ce.SHEEN_ALBEDOSCALING=!1,ce.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,ce.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1)},Ve.prototype.bindForSubMesh=function(ce,$,ae,Ie){var ft,mt,st,kt,ht,ke,Et,Pt,ri=Ie._materialDefines,vt=ri.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!ce.useUbo||!ae||!ce.isSync)&&(vt&&d.a.SheenTextureEnabled?(ce.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),g.a.BindTextureMatrix(this._texture,ce,"sheen")):(this._texture||this._textureRoughness)&&d.a.SheenTextureEnabled&&(ce.updateFloat4("vSheenInfos",(mt=(ft=this._texture)===null||ft===void 0?void 0:ft.coordinatesIndex)!==null&&mt!==void 0?mt:0,(kt=(st=this._texture)===null||st===void 0?void 0:st.level)!==null&&kt!==void 0?kt:0,(ke=(ht=this._textureRoughness)===null||ht===void 0?void 0:ht.coordinatesIndex)!==null&&ke!==void 0?ke:0,(Pt=(Et=this._textureRoughness)===null||Et===void 0?void 0:Et.level)!==null&&Pt!==void 0?Pt:0),this._texture&&g.a.BindTextureMatrix(this._texture,ce,"sheen"),this._textureRoughness&&!vt&&!ri.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&g.a.BindTextureMatrix(this._textureRoughness,ce,"sheenRoughness")),ce.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&ce.updateFloat("vSheenRoughness",this._roughness)),$.texturesEnabled&&(this._texture&&d.a.SheenTextureEnabled&&ce.setTexture("sheenSampler",this._texture),this._textureRoughness&&!vt&&!ri.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&d.a.SheenTextureEnabled&&ce.setTexture("sheenRoughnessSampler",this._textureRoughness))},Ve.prototype.hasTexture=function(ce){return this._texture===ce||this._textureRoughness===ce},Ve.prototype.getActiveTextures=function(ce){this._texture&&ce.push(this._texture),this._textureRoughness&&ce.push(this._textureRoughness)},Ve.prototype.getAnimatables=function(ce){this._texture&&this._texture.animations&&this._texture.animations.length>0&&ce.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&ce.push(this._textureRoughness)},Ve.prototype.dispose=function(ce){var $,ae;ce&&(($=this._texture)===null||$===void 0||$.dispose(),(ae=this._textureRoughness)===null||ae===void 0||ae.dispose())},Ve.prototype.getClassName=function(){return"PBRSheenConfiguration"},Ve.AddFallbacks=function(ce,$,ae){return ce.SHEEN&&$.addFallback(ae++,"SHEEN"),ae},Ve.AddUniforms=function(ce){ce.push("vSheenColor","vSheenRoughness","vSheenInfos","sheenMatrix","sheenRoughnessMatrix")},Ve.PrepareUniformBuffer=function(ce){ce.addUniform("vSheenColor",4),ce.addUniform("vSheenRoughness",1),ce.addUniform("vSheenInfos",4),ce.addUniform("sheenMatrix",16),ce.addUniform("sheenRoughnessMatrix",16)},Ve.AddSamplers=function(ce){ce.push("sheenSampler"),ce.push("sheenRoughnessSampler")},Ve.prototype.copyTo=function(ce){R.a.Clone(function(){return ce},this)},Ve.prototype.serialize=function(){return R.a.Serialize(this)},Ve.prototype.parse=function(ce,$,ae){var Ie=this;R.a.Parse(function(){return Ie},ce,$,ae)},Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"isEnabled",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"linkSheenWithAlbedo",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"intensity",void 0),Object(S.c)([Object(R.e)()],Ve.prototype,"color",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"texture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"useRoughnessFromMainTexture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"roughness",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"textureRoughness",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"albedoScaling",void 0),Ve}(),y=u(450),E=function(){function Ve(ce,$,ae){this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.tintColor=m.a.White(),this.tintColorAtDistance=1,this.diffusionDistance=m.a.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._useMaskFromThicknessTextureGltf=!1,this.useMaskFromThicknessTextureGltf=!1,this._internalMarkAllSubMeshesAsTexturesDirty=ce,this._internalMarkScenePrePassDirty=$,this._scene=ae}return Object.defineProperty(Ve.prototype,"scatteringDiffusionProfile",{get:function(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null},set:function(ce){!this._scene.enableSubSurfaceForPrePass()||ce&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(ce))},enumerable:!1,configurable:!0}),Object.defineProperty(Ve.prototype,"volumeIndexOfRefraction",{get:function(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction},set:function(ce){ce>=1?this._volumeIndexOfRefraction=ce:this._volumeIndexOfRefraction=-1},enumerable:!1,configurable:!0}),Ve.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},Ve.prototype._markScenePrePassDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()},Ve.prototype.isReadyForSubMesh=function(ce,$){if(ce._areTexturesDirty&&$.texturesEnabled){if(this._thicknessTexture&&d.a.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;var ae=this._getRefractionTexture($);if(ae&&d.a.RefractionTextureEnabled&&!ae.isReadyOrNotBlocking())return!1}return!0},Ve.prototype.prepareDefines=function(ce,$){if(ce._areTexturesDirty&&(ce.SUBSURFACE=!1,ce.SS_TRANSLUCENCY=this._isTranslucencyEnabled,ce.SS_SCATTERING=this._isScatteringEnabled,ce.SS_THICKNESSANDMASK_TEXTURE=!1,ce.SS_MASK_FROM_THICKNESS_TEXTURE=!1,ce.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=!1,ce.SS_REFRACTION=!1,ce.SS_REFRACTIONMAP_3D=!1,ce.SS_GAMMAREFRACTION=!1,ce.SS_RGBDREFRACTION=!1,ce.SS_LINEARSPECULARREFRACTION=!1,ce.SS_REFRACTIONMAP_OPPOSITEZ=!1,ce.SS_LODINREFRACTIONALPHA=!1,ce.SS_LINKREFRACTIONTOTRANSPARENCY=!1,ce.SS_ALBEDOFORREFRACTIONTINT=!1,(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled)&&(ce.SUBSURFACE=!0,ce._areTexturesDirty&&$.texturesEnabled&&this._thicknessTexture&&d.a.ThicknessTextureEnabled&&g.a.PrepareDefinesForMergedUV(this._thicknessTexture,ce,"SS_THICKNESSANDMASK_TEXTURE"),ce.SS_MASK_FROM_THICKNESS_TEXTURE=this._useMaskFromThicknessTexture,ce.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=this._useMaskFromThicknessTextureGltf),this._isRefractionEnabled&&$.texturesEnabled)){var ae=this._getRefractionTexture($);ae&&d.a.RefractionTextureEnabled&&(ce.SS_REFRACTION=!0,ce.SS_REFRACTIONMAP_3D=ae.isCube,ce.SS_GAMMAREFRACTION=ae.gammaSpace,ce.SS_RGBDREFRACTION=ae.isRGBD,ce.SS_LINEARSPECULARREFRACTION=ae.linearSpecularLOD,ce.SS_REFRACTIONMAP_OPPOSITEZ=ae.invertZ,ce.SS_LODINREFRACTIONALPHA=ae.lodLevelInAlpha,ce.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,ce.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction)}},Ve.prototype.bindForSubMesh=function(ce,$,ae,Ie,ft,mt){var st=this._getRefractionTexture($);if(!ce.useUbo||!Ie||!ce.isSync){if(this._thicknessTexture&&d.a.ThicknessTextureEnabled&&(ce.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),g.a.BindTextureMatrix(this._thicknessTexture,ce,"thickness")),ce.updateFloat2("vThicknessParam",this.minimumThickness,this.maximumThickness-this.minimumThickness),st&&d.a.RefractionTextureEnabled){ce.updateMatrix("refractionMatrix",st.getReflectionTextureMatrix());var kt=1;st.isCube||st.depth&&(kt=st.depth);var ht=st.getSize().width,ke=this.volumeIndexOfRefraction;ce.updateFloat4("vRefractionInfos",st.level,1/ke,kt,this._invertRefractionY?-1:1),ce.updateFloat3("vRefractionMicrosurfaceInfos",ht,st.lodGenerationScale,st.lodGenerationOffset),mt&&ce.updateFloat2("vRefractionFilteringInfo",ht,y.a.Log2(ht))}this.isScatteringEnabled&&ce.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),ce.updateColor3("vDiffusionDistance",this.diffusionDistance),ce.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,this.tintColorAtDistance),ce.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}$.texturesEnabled&&(this._thicknessTexture&&d.a.ThicknessTextureEnabled&&ce.setTexture("thicknessSampler",this._thicknessTexture),st&&d.a.RefractionTextureEnabled&&(ft?ce.setTexture("refractionSampler",st):(ce.setTexture("refractionSampler",st._lodTextureMid||st),ce.setTexture("refractionSamplerLow",st._lodTextureLow||st),ce.setTexture("refractionSamplerHigh",st._lodTextureHigh||st))))},Ve.prototype.unbind=function(ce){return this._refractionTexture&&this._refractionTexture.isRenderTarget?(ce.setTexture("refractionSampler",null),!0):!1},Ve.prototype._getRefractionTexture=function(ce){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?ce.environmentTexture:null},Object.defineProperty(Ve.prototype,"disableAlphaBlending",{get:function(){return this.isRefractionEnabled&&this._linkRefractionWithTransparency},enumerable:!1,configurable:!0}),Ve.prototype.fillRenderTargetTextures=function(ce){d.a.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&ce.push(this._refractionTexture)},Ve.prototype.hasTexture=function(ce){return this._thicknessTexture===ce||this._refractionTexture===ce},Ve.prototype.hasRenderTargetTextures=function(){return!!(d.a.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)},Ve.prototype.getActiveTextures=function(ce){this._thicknessTexture&&ce.push(this._thicknessTexture),this._refractionTexture&&ce.push(this._refractionTexture)},Ve.prototype.getAnimatables=function(ce){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&ce.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&ce.push(this._refractionTexture)},Ve.prototype.dispose=function(ce){ce&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())},Ve.prototype.getClassName=function(){return"PBRSubSurfaceConfiguration"},Ve.AddFallbacks=function(ce,$,ae){return ce.SS_SCATTERING&&$.addFallback(ae++,"SS_SCATTERING"),ce.SS_TRANSLUCENCY&&$.addFallback(ae++,"SS_TRANSLUCENCY"),ae},Ve.AddUniforms=function(ce){ce.push("vDiffusionDistance","vTintColor","vSubSurfaceIntensity","vRefractionMicrosurfaceInfos","vRefractionFilteringInfo","vRefractionInfos","vThicknessInfos","vThicknessParam","refractionMatrix","thicknessMatrix","scatteringDiffusionProfile")},Ve.AddSamplers=function(ce){ce.push("thicknessSampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")},Ve.PrepareUniformBuffer=function(ce){ce.addUniform("vRefractionMicrosurfaceInfos",3),ce.addUniform("vRefractionFilteringInfo",2),ce.addUniform("vRefractionInfos",4),ce.addUniform("refractionMatrix",16),ce.addUniform("vThicknessInfos",2),ce.addUniform("thicknessMatrix",16),ce.addUniform("vThicknessParam",2),ce.addUniform("vDiffusionDistance",3),ce.addUniform("vTintColor",4),ce.addUniform("vSubSurfaceIntensity",3),ce.addUniform("scatteringDiffusionProfile",1)},Ve.prototype.copyTo=function(ce){R.a.Clone(function(){return ce},this)},Ve.prototype.serialize=function(){return R.a.Serialize(this)},Ve.prototype.parse=function(ce,$,ae){var Ie=this;R.a.Parse(function(){return Ie},ce,$,ae)},Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"isRefractionEnabled",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"isTranslucencyEnabled",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markScenePrePassDirty")],Ve.prototype,"isScatteringEnabled",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"_scatteringDiffusionProfileIndex",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"refractionIntensity",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"translucencyIntensity",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"useAlbedoToTintRefraction",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"thicknessTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"refractionTexture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"indexOfRefraction",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"_volumeIndexOfRefraction",void 0),Object(S.c)([Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"volumeIndexOfRefraction",null),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"invertRefractionY",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"linkRefractionWithTransparency",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"minimumThickness",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"maximumThickness",void 0),Object(S.c)([Object(R.e)()],Ve.prototype,"tintColor",void 0),Object(S.c)([Object(R.c)()],Ve.prototype,"tintColorAtDistance",void 0),Object(S.c)([Object(R.e)()],Ve.prototype,"diffusionDistance",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"useMaskFromThicknessTexture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"useMaskFromThicknessTextureGltf",void 0),Ve}(),A=u(744),F=u(491),B=u(459),L=u(552),I=u(553),z=u(442),k=u(523),j=u(435),w=u(746),Q="pbrFragmentDeclaration",W=`uniform vec4 vEyePosition;
uniform vec3 vReflectionColor;
uniform vec4 vAlbedoColor;

uniform vec4 vLightingIntensity;
uniform vec4 vReflectivityColor;
uniform vec4 vMetallicReflectanceFactors;
uniform vec3 vEmissiveColor;
uniform float visibility;
uniform vec3 vAmbientColor;

#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif

#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif

#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize;
#endif
#endif

#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;
uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform vec2 vClearCoatTangentSpaceParams;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;
uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif

#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif

#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif

#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec3 vRefractionMicrosurfaceInfos;
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
uniform vec2 vThicknessParam;
uniform vec3 vDiffusionDistance;
uniform vec4 vTintColor;
uniform vec3 vSubSurfaceIntensity;
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
`;j.a.IncludesShadersStore[Q]=W;var Y={name:Q,shader:W},he=u(674),le=u(745),J="pbrUboDeclaration",Re=`layout(std140,column_major) uniform;





















uniform Material {
vec2 vAlbedoInfos;
vec4 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec3 vReflectivityInfos;
vec2 vMicroSurfaceSamplerInfos;
vec2 vReflectionInfos;
vec2 vReflectionFilteringInfo;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec3 vBumpInfos;
mat4 albedoMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 reflectivityMatrix;
mat4 microSurfaceSamplerMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
mat4 reflectionMatrix;
vec3 vReflectionColor;
vec4 vAlbedoColor;
vec4 vLightingIntensity;
vec3 vReflectionMicrosurfaceInfos;
float pointSize;
vec4 vReflectivityColor;
vec3 vEmissiveColor;
vec3 vAmbientColor;
vec2 vDebugMode;
vec4 vMetallicReflectanceFactors;
vec2 vMetallicReflectanceInfos;
mat4 metallicReflectanceMatrix;
vec2 vClearCoatParams;
vec4 vClearCoatRefractionParams;
vec4 vClearCoatInfos;
mat4 clearCoatMatrix;
mat4 clearCoatRoughnessMatrix;
vec2 vClearCoatBumpInfos;
vec2 vClearCoatTangentSpaceParams;
mat4 clearCoatBumpMatrix;
vec4 vClearCoatTintParams;
float clearCoatColorAtDistance;
vec2 vClearCoatTintInfos;
mat4 clearCoatTintMatrix;
vec3 vAnisotropy;
vec2 vAnisotropyInfos;
mat4 anisotropyMatrix;
vec4 vSheenColor;
float vSheenRoughness;
vec4 vSheenInfos;
mat4 sheenMatrix;
mat4 sheenRoughnessMatrix;
vec3 vRefractionMicrosurfaceInfos;
vec2 vRefractionFilteringInfo;
vec4 vRefractionInfos;
mat4 refractionMatrix;
vec2 vThicknessInfos;
mat4 thicknessMatrix;
vec2 vThicknessParam;
vec3 vDiffusionDistance;
vec4 vTintColor;
vec3 vSubSurfaceIntensity;
float scatteringDiffusionProfile;
vec4 vDetailInfos;
mat4 detailMatrix;
vec3 vSphericalL00;
vec3 vSphericalL1_1;
vec3 vSphericalL10;
vec3 vSphericalL11;
vec3 vSphericalL2_2;
vec3 vSphericalL2_1;
vec3 vSphericalL20;
vec3 vSphericalL21;
vec3 vSphericalL22;
vec3 vSphericalX;
vec3 vSphericalY;
vec3 vSphericalZ;
vec3 vSphericalXX_ZZ;
vec3 vSphericalYY_ZZ;
vec3 vSphericalZZ;
vec3 vSphericalXY;
vec3 vSphericalYZ;
vec3 vSphericalZX;
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;j.a.IncludesShadersStore[J]=Re;var Me={name:J,shader:Re},me="pbrFragmentExtraDeclaration",H=`
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#ifdef VERTEXCOLOR
varying vec4 vColor;
#endif`;j.a.IncludesShadersStore[me]=H;var q={name:me,shader:H},_e=u(650),Ee=u(651),Te="pbrFragmentSamplersDeclaration",se=`#ifdef ALBEDO
#if ALBEDODIRECTUV == 1
#define vAlbedoUV vMainUV1
#elif ALBEDODIRECTUV == 2
#define vAlbedoUV vMainUV2
#else
varying vec2 vAlbedoUV;
#endif
uniform sampler2D albedoSampler;
#endif
#ifdef AMBIENT
#if AMBIENTDIRECTUV == 1
#define vAmbientUV vMainUV1
#elif AMBIENTDIRECTUV == 2
#define vAmbientUV vMainUV2
#else
varying vec2 vAmbientUV;
#endif
uniform sampler2D ambientSampler;
#endif
#ifdef OPACITY
#if OPACITYDIRECTUV == 1
#define vOpacityUV vMainUV1
#elif OPACITYDIRECTUV == 2
#define vOpacityUV vMainUV2
#else
varying vec2 vOpacityUV;
#endif
uniform sampler2D opacitySampler;
#endif
#ifdef EMISSIVE
#if EMISSIVEDIRECTUV == 1
#define vEmissiveUV vMainUV1
#elif EMISSIVEDIRECTUV == 2
#define vEmissiveUV vMainUV2
#else
varying vec2 vEmissiveUV;
#endif
uniform sampler2D emissiveSampler;
#endif
#ifdef LIGHTMAP
#if LIGHTMAPDIRECTUV == 1
#define vLightmapUV vMainUV1
#elif LIGHTMAPDIRECTUV == 2
#define vLightmapUV vMainUV2
#else
varying vec2 vLightmapUV;
#endif
uniform sampler2D lightmapSampler;
#endif
#ifdef REFLECTIVITY
#if REFLECTIVITYDIRECTUV == 1
#define vReflectivityUV vMainUV1
#elif REFLECTIVITYDIRECTUV == 2
#define vReflectivityUV vMainUV2
#else
varying vec2 vReflectivityUV;
#endif
uniform sampler2D reflectivitySampler;
#endif
#ifdef MICROSURFACEMAP
#if MICROSURFACEMAPDIRECTUV == 1
#define vMicroSurfaceSamplerUV vMainUV1
#elif MICROSURFACEMAPDIRECTUV == 2
#define vMicroSurfaceSamplerUV vMainUV2
#else
varying vec2 vMicroSurfaceSamplerUV;
#endif
uniform sampler2D microSurfaceSampler;
#endif
#ifdef METALLIC_REFLECTANCE
#if METALLIC_REFLECTANCEDIRECTUV == 1
#define vMetallicReflectanceUV vMainUV1
#elif METALLIC_REFLECTANCEDIRECTUV == 2
#define vMetallicReflectanceUV vMainUV2
#else
varying vec2 vMetallicReflectanceUV;
#endif
uniform sampler2D metallicReflectanceSampler;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE)
#if CLEARCOAT_TEXTUREDIRECTUV == 1
#define vClearCoatUV vMainUV1
#elif CLEARCOAT_TEXTUREDIRECTUV == 2
#define vClearCoatUV vMainUV2
#else
varying vec2 vClearCoatUV;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
#if CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 1
#define vClearCoatRoughnessUV vMainUV1
#elif CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 2
#define vClearCoatRoughnessUV vMainUV2
#else
varying vec2 vClearCoatRoughnessUV;
#endif
#endif
#ifdef CLEARCOAT_TEXTURE
uniform sampler2D clearCoatSampler;
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#ifdef CLEARCOAT_BUMP
#if CLEARCOAT_BUMPDIRECTUV == 1
#define vClearCoatBumpUV vMainUV1
#elif CLEARCOAT_BUMPDIRECTUV == 2
#define vClearCoatBumpUV vMainUV2
#else
varying vec2 vClearCoatBumpUV;
#endif
uniform sampler2D clearCoatBumpSampler;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
#if CLEARCOAT_TINT_TEXTUREDIRECTUV == 1
#define vClearCoatTintUV vMainUV1
#elif CLEARCOAT_TINT_TEXTUREDIRECTUV == 2
#define vClearCoatTintUV vMainUV2
#else
varying vec2 vClearCoatTintUV;
#endif
uniform sampler2D clearCoatTintSampler;
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_TEXTURE
#if SHEEN_TEXTUREDIRECTUV == 1
#define vSheenUV vMainUV1
#elif SHEEN_TEXTUREDIRECTUV == 2
#define vSheenUV vMainUV2
#else
varying vec2 vSheenUV;
#endif
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
#if SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 1
#define vSheenRoughnessUV vMainUV1
#elif SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 2
#define vSheenRoughnessUV vMainUV2
#else
varying vec2 vSheenRoughnessUV;
#endif
#endif
#ifdef SHEEN_TEXTURE
uniform sampler2D sheenSampler;
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
#if ANISOTROPIC_TEXTUREDIRECTUV == 1
#define vAnisotropyUV vMainUV1
#elif ANISOTROPIC_TEXTUREDIRECTUV == 2
#define vAnisotropyUV vMainUV2
#else
varying vec2 vAnisotropyUV;
#endif
uniform sampler2D anisotropySampler;
#endif
#endif

#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;
uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif

#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;
uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;
uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#if SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 1
#define vThicknessUV vMainUV1
#elif SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 2
#define vThicknessUV vMainUV2
#else
varying vec2 vThicknessUV;
#endif
uniform sampler2D thicknessSampler;
#endif
#endif`;j.a.IncludesShadersStore[Te]=se;var ve={name:Te,shader:se},ye=u(524),Le=u(592),be=u(558),ze=u(597),Ye=u(457),He=u(627),Ue=u(605),re="pbrHelperFunctions",Z=`
#define RECIPROCAL_PI2 0.15915494
#define RECIPROCAL_PI 0.31830988618

#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{

return square(roughness)+MINIMUMVARIANCE;
}
float fresnelGrazingReflectance(float reflectance0) {


float reflectance90=saturate(reflectance0*25.0);
return reflectance90;
}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);
vec3 nDfdy=dFdy(normalVector.xyz);
float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));

float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);

float geometricAlphaGFactor=sqrt(slopeSquare);

geometricAlphaGFactor*=0.75;
return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC


vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {
float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);
float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);
return vec2(alphaT,alphaB);
}


vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {
vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);
vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);
vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));
return anisotropicNormal;

}
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)



vec3 cocaLambert(vec3 alpha,float distance) {
return exp(-alpha*distance);
}

vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {
return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));
}

vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {
return -log(color)/distance;
}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);
return clearCoatAbsorption;
}
#endif




#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{
const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;
float reflectivityLuminance=getLuminance(reflectivityColor);
float reflectivityLuma=sqrt(reflectivityLuminance);
microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;
return microSurface;
}
#endif`;j.a.IncludesShadersStore[re]=Z;var fe={name:re,shader:Z},ue=u(525),Ge=u(652),xe="harmonicsFunctions",ne=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS







vec3 computeEnvironmentIrradiance(vec3 normal) {
return vSphericalL00
+vSphericalL1_1*(normal.y)
+vSphericalL10*(normal.z)
+vSphericalL11*(normal.x)
+vSphericalL2_2*(normal.y*normal.x)
+vSphericalL2_1*(normal.y*normal.z)
+vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+vSphericalL21*(normal.z*normal.x)
+vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));
}
#else

vec3 computeEnvironmentIrradiance(vec3 normal) {









float Nx=normal.x;
float Ny=normal.y;
float Nz=normal.z;
vec3 C1=vSphericalZZ.rgb;
vec3 Cx=vSphericalX.rgb;
vec3 Cy=vSphericalY.rgb;
vec3 Cz=vSphericalZ.rgb;
vec3 Cxx_zz=vSphericalXX_ZZ.rgb;
vec3 Cyy_zz=vSphericalYY_ZZ.rgb;
vec3 Cxy=vSphericalXY.rgb;
vec3 Cyz=vSphericalYZ.rgb;
vec3 Czx=vSphericalZX.rgb;
vec3 a1=Cyy_zz*Ny+Cy;
vec3 a2=Cyz*Nz+a1;
vec3 b1=Czx*Nz+Cx;
vec3 b2=Cxy*Ny+b1;
vec3 b3=Cxx_zz*Nx+b2;
vec3 t1=Cz*Nz+C1;
vec3 t2=a2*Ny+t1;
vec3 t3=b3*Nx+t2;
return t3;
}
#endif
#endif`;j.a.IncludesShadersStore[xe]=ne;var Ke={name:xe,shader:ne},nt="pbrDirectLightingSetupFunctions",ut=`
struct preLightingInfo
{

vec3 lightOffset;
float lightDistanceSquared;
float lightDistance;

float attenuation;

vec3 L;
vec3 H;
float NdotV;
float NdotLUnclamped;
float NdotL;
float VdotH;
float roughness;
};
preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;

result.lightOffset=lightData.xyz-vPositionW;
result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);

result.lightDistance=sqrt(result.lightDistanceSquared);

result.L=normalize(result.lightOffset);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;

result.lightDistance=length(-lightData.xyz);

result.L=normalize(-lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;


result.NdotL=dot(N,lightData.xyz)*0.5+0.5;
result.NdotL=saturateEps(result.NdotL);
result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
#endif
return result;
}`;j.a.IncludesShadersStore[nt]=ut;var pt={name:nt,shader:ut},Tt="pbrDirectLightingFalloffFunctions",de=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{
return max(0.,1.0-length(lightOffset)/range);
}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{
return 1.0/maxEps(lightDistanceSquared);
}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{
float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);
float factor=lightDistanceSquared*inverseSquaredRange;
float attenuation=saturate(1.0-factor*factor);
attenuation*=attenuation;

lightDistanceFalloff*=attenuation;
return lightDistanceFalloff;
}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{
float falloff=0.0;
float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));
if (cosAngle>=cosHalfAngle)
{
falloff=max(0.,pow(cosAngle,exponent));
}
return falloff;
}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{
const float kMinusLog2ConeAngleIntensityRatio=6.64385618977;





float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);


vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);
float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));
return falloff;
}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{



float cd=dot(-lightDirection,directionToLightCenterW);
float falloff=saturate(cd*lightAngleScale+lightAngleOffset);

falloff*=falloff;
return falloff;
}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;j.a.IncludesShadersStore[Tt]=de;var Ft={name:Tt,shader:de},Jt=u(606),Dt=u(607),Xt="pbrDirectLightingFunctions",Kt=`#define CLEARCOATREFLECTANCE90 1.0

struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT


vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};

float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)

float lightRoughness=lightRadius/lightDistance;

float totalRoughness=saturate(lightRoughness+roughness);
return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {
return mix(groundColor,lightColor,info.NdotL);
}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {
float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*info.attenuation*info.NdotL*lightColor;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return toLinearSpace(textureColor);
}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {
float NdotL=absEps(info.NdotLUnclamped);

float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);

float trAdapt=step(0.,info.NdotLUnclamped);
vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float TdotH=dot(T,info.H);
float BdotH=dot(B,info.H);
float TdotV=dot(T,V);
float BdotV=dot(B,V);
float TdotL=dot(T,info.L);
float BdotL=dot(B,info.L);
float alphaG=convertRoughnessToAverageSlope(info.roughness);
vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);
alphaTB=max(alphaTB,square(geometricRoughnessFactor));
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);
float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {
float NccdotL=saturateEps(dot(Ncc,info.L));
float NccdotH=saturateEps(dot(Ncc,info.H));
float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnel*=clearCoatIntensity;
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);
float kelemenVisibility=visibility_Kelemen(info.VdotH);
float clearCoatTerm=fresnel*distribution*kelemenVisibility;
return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);
}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);
float NdotLRefract=saturateEps(dot(Ncc,LRefract));
vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);
return absorption;
}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);


float fresnel=1.;
float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);

float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);

float sheenTerm=fresnel*distribution*visibility;
return sheenTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
`;j.a.IncludesShadersStore[Xt]=Kt;var Zi={name:Xt,shader:Kt},zi="pbrIBLFunctions",li=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {
float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;
float lod=log2(microsurfaceAverageSlopeTexels);
return lod;
}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {
float lod=log2(cubeMapDimensionPixels)*roughness;
return lod;
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {


float temp=NdotVUnclamped+ambientOcclusion;
return saturate(square(temp)-1.0+ambientOcclusion);
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {

vec3 reflection=reflect(view,normal);
float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));
return square(temp);
}
#endif




#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)


#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {
float microsurfaceAverageSlope=alphaG;






microsurfaceAverageSlope*=sqrt(abs(NdotV));
return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);
}
#endif`;j.a.IncludesShadersStore[zi]=li;var Di={name:zi,shader:li},Qt=u(614),_i=u(615),ji=u(653),yi="pbrBlockAlbedoOpacity",ai=`struct albedoOpacityOutParams
{
vec3 surfaceAlbedo;
float alpha;
};
#define pbr_inline
void albedoOpacityBlock(
const in vec4 vAlbedoColor,
#ifdef ALBEDO
const in vec4 albedoTexture,
const in vec2 albedoInfos,
#endif
#ifdef OPACITY
const in vec4 opacityMap,
const in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
const in vec4 detailColor,
const in vec4 vDetailInfos,
#endif
out albedoOpacityOutParams outParams
)
{

vec3 surfaceAlbedo=vAlbedoColor.rgb;
float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifdef VERTEXCOLOR
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);
surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO

#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#ifdef VERTEXALPHA
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
if (alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND

alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;
outParams.alpha=alpha;
}
`;j.a.IncludesShadersStore[yi]=ai;var Ei={name:yi,shader:ai},Ut="pbrBlockReflectivity",wi=`struct reflectivityOutParams
{
float microSurface;
float roughness;
vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
vec4 surfaceMetallicColorMap;
vec4 surfaceReflectivityColorMap;
vec2 metallicRoughness;
vec3 metallicF0;
#endif
};
#define pbr_inline
void reflectivityBlock(
const in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
const in vec3 surfaceAlbedo,
const in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
const in vec3 reflectivityInfos,
const in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
const in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
const in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
const in vec4 detailColor,
const in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{
float microSurface=vReflectivityColor.a;
vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);
outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);
float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);
float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);
metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS

microSurface=1.0-metallicRoughness.g;

vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE






outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);

surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif

outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);

surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;
microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif

microSurface=saturate(microSurface);

float roughness=1.-microSurface;
outParams.microSurface=microSurface;
outParams.roughness=roughness;
outParams.surfaceReflectivityColor=surfaceReflectivityColor;
}
`;j.a.IncludesShadersStore[Ut]=wi;var ui={name:Ut,shader:wi},Wi="pbrBlockAmbientOcclusion",Hi=`struct ambientOcclusionOutParams
{
vec3 ambientOcclusionColor;
#if DEBUGMODE>0
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
const in vec3 ambientOcclusionColorMap_,
const in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{
vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;
}
`;j.a.IncludesShadersStore[Wi]=Hi;var Pi={name:Wi,shader:Hi},xt="pbrBlockAlphaFresnel",Ji=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{
float alpha;
};
#define pbr_inline
void alphaFresnelBlock(
const in vec3 normalW,
const in vec3 viewDirectionW,
const in float alpha,
const in float microSurface,
out alphaFresnelOutParams outParams
)
{



float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);
vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);

outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND

outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;j.a.IncludesShadersStore[xt]=Ji;var Dr={name:xt,shader:Ji},Vt="pbrBlockAnisotropic",Ci=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{
float anisotropy;
vec3 anisotropicTangent;
vec3 anisotropicBitangent;
vec3 anisotropicNormal;
#if DEBUGMODE>0
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
const in vec3 vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
const in vec3 anisotropyMapData,
#endif
const in mat3 TBN,
const in vec3 normalW,
const in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{
float anisotropy=vAnisotropy.b;
vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
anisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));
vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);
vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));
outParams.anisotropy=anisotropy;
outParams.anisotropicTangent=anisotropicTangent;
outParams.anisotropicBitangent=anisotropicBitangent;
outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);
}
#endif
`;j.a.IncludesShadersStore[Vt]=Ci;var dr={name:Vt,shader:Ci},Ii="pbrBlockReflection",Wt=`#ifdef REFLECTION
struct reflectionOutParams
{
vec4 environmentRadiance;
vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
const in vec3 vPositionW,
const in vec3 normalW,
#ifdef ANISOTROPIC
const in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif

#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
const in float alphaG,
const in vec3 vReflectionMicrosurfaceInfos,
const in vec2 vReflectionInfos,
const in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
const in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
const in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
const in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSamplerLow,
const in samplerCube reflectionSamplerHigh,
#else
const in sampler2D reflectionSamplerLow,
const in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
const in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{

#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE

reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA









float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);
float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);
if (lodReflectionNormalizedDoubled<1.0){
environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);
} else {
environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif

environmentRadiance.rgb*=vReflectionInfos.x;
environmentRadiance.rgb*=vReflectionColor.rgb;
}
#define pbr_inline
#define inline
void reflectionBlock(
const in vec3 vPositionW,
const in vec3 normalW,
const in float alphaG,
const in vec3 vReflectionMicrosurfaceInfos,
const in vec2 vReflectionInfos,
const in vec3 vReflectionColor,
#ifdef ANISOTROPIC
const in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
const in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
const in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSampler,
#else
const in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
const in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
const in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
const in samplerCube irradianceSampler,
#else
const in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSamplerLow,
const in samplerCube reflectionSamplerHigh,
#else
const in sampler2D reflectionSamplerLow,
const in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
const in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{

vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);
sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);

vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;
outParams.environmentRadiance=environmentRadiance;
outParams.environmentIrradiance=environmentIrradiance;
outParams.reflectionCoords=reflectionCoords;
}
#endif
`;j.a.IncludesShadersStore[Ii]=Wt;var Nt={name:Ii,shader:Wt},sr="pbrBlockSheen",Ri=`#ifdef SHEEN
struct sheenOutParams
{
float sheenIntensity;
vec3 sheenColor;
float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
vec4 sheenMapData;
vec3 sheenEnvironmentReflectance;
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
const in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
const in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
const in vec4 sheenMapRoughnessData,
#endif
#endif
const in float roughness,
#ifdef SHEEN_TEXTURE
const in vec4 sheenMapData,
#endif
const in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
const in vec3 baseColor,
const in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
const in float NdotV,
const in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
const in vec2 AARoughnessFactors,
const in vec3 vReflectionMicrosurfaceInfos,
const in vec2 vReflectionInfos,
const in vec3 vReflectionColor,
const in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSampler,
const in vec3 reflectionCoords,
#else
const in sampler2D reflectionSampler,
const in vec2 reflectionCoords,
#endif
const in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSamplerLow,
const in samplerCube reflectionSamplerHigh,
#else
const in sampler2D reflectionSamplerLow,
const in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
const in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
const in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
const in float eho,
#endif
#endif
out sheenOutParams outParams
)
{
float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);
vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);
float sheenRoughness=sheenIntensity;
outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
sheenColor.rgb*=sheenMapData.rgb;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL
sheenRoughness*=sheenMapData.a;
#else
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif

#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif

sheenColor*=sheenIntensity;
#endif

#ifdef ENVIRONMENTBRDF

#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif

#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA

sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);
sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);
vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;





#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)



outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif

outParams.sheenIntensity=sheenIntensity;
outParams.sheenColor=sheenColor;
outParams.sheenRoughness=sheenRoughness;
}
#endif
`;j.a.IncludesShadersStore[sr]=Ri;var pr={name:sr,shader:Ri},Er="pbrBlockClearcoat",Vi=`struct clearcoatOutParams
{
vec3 specularEnvironmentR0;
float conservationFactor;
vec3 clearCoatNormalW;
vec2 clearCoatAARoughnessFactors;
float clearCoatIntensity;
float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;
float clearCoatNdotVRefract;
vec3 clearCoatColor;
float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
mat3 TBNClearCoat;
vec2 clearCoatMapData;
vec4 clearCoatTintMapData;
vec4 environmentClearCoatRadiance;
float clearCoatNdotV;
vec3 clearCoatEnvironmentReflectance;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
const in vec3 vPositionW,
const in vec3 geometricNormalW,
const in vec3 viewDirectionW,
const in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
const in vec4 clearCoatMapRoughnessData,
#endif
const in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
const in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
const in vec4 vClearCoatTintParams,
const in float clearCoatColorAtDistance,
const in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
const in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
const in vec2 vClearCoatBumpInfos,
const in vec4 clearCoatBumpMapData,
const in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
const in mat3 vTBN,
#else
const in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
const in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
const in vec3 faceNormal,
#endif
#ifdef REFLECTION
const in vec3 vReflectionMicrosurfaceInfos,
const in vec2 vReflectionInfos,
const in vec3 vReflectionColor,
const in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSampler,
#else
const in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSamplerLow,
const in samplerCube reflectionSamplerHigh,
#else
const in sampler2D reflectionSamplerLow,
const in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
const in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
const in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
const in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{

float clearCoatIntensity=vClearCoatParams.x;
float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL
clearCoatRoughness*=clearCoatMapData.y;
#else
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
#endif
outParams.clearCoatIntensity=clearCoatIntensity;
outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;
float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatColor*=clearCoatTintMapData.rgb;
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);
outParams.clearCoatThickness=clearCoatThickness;
#endif




#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);

vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else

vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;
mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz*2.0-1.0);
clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;

outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);

float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);

float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT

vec3 clearCoatVRefract=-refract(vPositionW,clearCoatNormalW,vClearCoatRefractionParams.y);

outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))

vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif

#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA

clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);
vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif

#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif

#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef RADIANCEOCCLUSION
float clearCoatSeo=environmentRadianceOcclusion(ambientMonochrome,clearCoatNdotVUnclamped);
clearCoatEnvironmentReflectance*=clearCoatSeo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);
clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else

vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)

outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif

float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnelIBLClearCoat*=clearCoatIntensity;
outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;j.a.IncludesShadersStore[Er]=Vi;var $i={name:Er,shader:Vi},Pr="pbrBlockSubSurface",gr=`struct subSurfaceOutParams
{
vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;
vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;
float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
vec4 thicknessMap;
vec4 environmentRefraction;
vec3 refractionTransmittance;
#endif
};
#ifdef SUBSURFACE
#define pbr_inline
#define inline
void subSurfaceBlock(
const in vec3 vSubSurfaceIntensity,
const in vec2 vThicknessParam,
const in vec4 vTintColor,
const in vec3 normalW,
const in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
const in vec4 thicknessMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
const in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
const in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
const in samplerCube reflectionSampler,
const in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
const in samplerCube irradianceSampler,
#else
const in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#ifdef SS_REFRACTION
const in vec3 vPositionW,
const in vec3 viewDirectionW,
const in mat4 view,
const in vec3 surfaceAlbedo,
const in vec4 vRefractionInfos,
const in mat4 refractionMatrix,
const in vec3 vRefractionMicrosurfaceInfos,
const in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
const in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
const in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
const in float roughness,
#else
const in float alphaG,
#endif
#ifdef SS_REFRACTIONMAP_3D
const in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
const in samplerCube refractionSamplerLow,
const in samplerCube refractionSamplerHigh,
#endif
#else
const in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
const in sampler2D refractionSamplerLow,
const in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
const in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
const in vec2 vRefractionFilteringInfo,
#endif
#endif
#ifdef SS_TRANSLUCENCY
const in vec3 vDiffusionDistance,
#endif
out subSurfaceOutParams outParams
)
{
outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;



#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);

outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#ifdef SS_MASK_FROM_THICKNESS_TEXTURE
#ifdef SS_REFRACTION
refractionIntensity*=thicknessMap.g;
#endif
#ifdef SS_TRANSLUCENCY
translucencyIntensity*=thicknessMap.b;
#endif
#elif defined(SS_MASK_FROM_THICKNESS_TEXTURE_GLTF)
#ifdef SS_REFRACTION
refractionIntensity*=thicknessMap.r;
#elif defined(SS_TRANSLUCENCY)
translucencyIntensity*=thicknessMap.r;
#endif
thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#endif
#else
float thickness=vThicknessParam.y;
#endif



#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);
vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);
transmittance*=translucencyIntensity;
outParams.transmittance=transmittance;
outParams.translucencyIntensity=translucencyIntensity;
#endif



#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif

#ifdef SS_REFRACTIONMAP_3D
refractionVector.y=refractionVector.y*vRefractionInfos.w;
vec3 refractionCoords=refractionVector;
refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,roughness);
#else
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE

refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA









float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);
float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));
float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;
vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);
if (lodRefractionNormalizedDoubled<1.0){
environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);
} else {
environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);
}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif

environmentRefraction.rgb*=vRefractionInfos.x;
#endif



#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);





refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)

float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);
vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);

environmentRefraction.rgb*=volumeAlbedo;
#else

vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT

environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif

outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION

outParams.refractionFactorForIrradiance=(1.-refractionIntensity);

#endif

vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);
outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);

refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif



#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;j.a.IncludesShadersStore[Pr]=gr;var Zt={name:Pr,shader:gr},Yt=u(550),Li="pbrBlockNormalGeometric",Ui=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;j.a.IncludesShadersStore[Li]=Ui;var qi={name:Li,shader:Ui},Ht=u(616),er="pbrBlockNormalFinal",Vn=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;j.a.IncludesShadersStore[er]=Vn;var tr={name:er,shader:Vn},Jr=u(747),Un="pbrBlockLightmapInit",Gn=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;j.a.IncludesShadersStore[Un]=Gn;var Da={name:Un,shader:Gn},Ir="pbrBlockGeometryInfo",ln=`float NdotVUnclamped=dot(normalW,viewDirectionW);

float NdotV=absEps(NdotVUnclamped);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA

alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)

vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;j.a.IncludesShadersStore[Ir]=ln;var yn={name:Ir,shader:ln},ii="pbrBlockReflectance0",qe=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);
vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif

#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);
specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;j.a.IncludesShadersStore[ii]=qe;var Ia={name:ii,shader:qe},zn="pbrBlockReflectance",La=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else

vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;j.a.IncludesShadersStore[zn]=La;var Fo={name:zn,shader:La},jn="pbrBlockDirectLighting",Wn=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif

preLightingInfo preInfo;
lightingInfo info;
float shadow=1.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;j.a.IncludesShadersStore[jn]=Wn;var Fa={name:jn,shader:Wn},Ba=u(654),lr="pbrBlockFinalLitComponents",Hn=`



#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif

#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);
finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;
finalIrradiance*=vLightingIntensity.z;
finalIrradiance*=aoOut.ambientOcclusionColor;
#endif

#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;
finalSpecular=max(finalSpecular,0.0);
vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif

#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;
finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;
vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif

#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;
finalSheen=max(finalSheen,0.0);
vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif

#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;
finalClearCoat=max(finalClearCoat,0.0);
vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif

#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;j.a.IncludesShadersStore[lr]=Hn;var Na={name:lr,shader:Hn},wa="pbrBlockFinalUnlitComponents",kn=`
vec3 finalDiffuse=diffuseBase;
finalDiffuse*=surfaceAlbedo.rgb;
finalDiffuse=max(finalDiffuse,0.0);
finalDiffuse*=vLightingIntensity.x;

vec3 finalAmbient=vAmbientColor;
finalAmbient*=surfaceAlbedo.rgb;

vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
finalEmissive*=vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;

#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;
finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;j.a.IncludesShadersStore[wa]=kn;var Dl={name:wa,shader:kn},Xn="pbrBlockFinalColorComposition",Yn=`vec4 finalColor=vec4(
finalAmbient +
finalDiffuse +
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalEmissive,
alpha);

#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG

finalColor=max(finalColor,0.0);
`;j.a.IncludesShadersStore[Xn]=Yn;var Va={name:Xn,shader:Yn},Ua=u(701),Ga=u(655),Lr="pbrBlockImageProcessing",Ze=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)




finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#else

finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA

finalColor.rgb*=finalColor.a;
#endif
`;j.a.IncludesShadersStore[Lr]=Ze;var za={name:Lr,shader:Ze},Kn="pbrDebug",ja=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {

#if DEBUGMODE == 1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 3 && defined(BUMP) || DEBUGMODE == 3 && defined(PARALLAX) || DEBUGMODE == 3 && defined(ANISOTROPIC)

gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 4 && defined(BUMP) || DEBUGMODE == 4 && defined(PARALLAX) || DEBUGMODE == 4 && defined(ANISOTROPIC)

gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 5

gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE == 7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE == 8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)

gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)

gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 10 && defined(CLEARCOAT)

gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE

#elif DEBUGMODE == 20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#elif DEBUGMODE == 21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE == 22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE == 23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE == 26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE == 28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE == 29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE == 30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE == 31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;

#elif DEBUGMODE == 40 && defined(SS_REFRACTION)

gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA

#elif DEBUGMODE == 50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#define DEBUGMODE_GAMMA

#elif DEBUGMODE == 60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE == 71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE == 63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE == 64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE == 65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE == 66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE == 68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE == 69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE == 70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;

#elif DEBUGMODE == 80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE == 81 && defined(HORIZONOCCLUSION)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE == 82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE == 83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE == 87
gl_FragColor.rgb=vec3(alpha);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor);
gl_FragData[1]=vec4(0.,0.,0.,0.);
#endif
return;
}
#endif`;j.a.IncludesShadersStore[Kn]=ja;var Bo={name:Kn,shader:ja},Qn="pbrPixelShader",Zn=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;

#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif

#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>

#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockSubSurface>

void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>

#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>

albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
albedoOpacityOut
);
vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;
float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS

ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else

vec3 baseColor=surfaceAlbedo;
reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);
vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
metallicReflectanceFactors*=metallicReflectanceFactorsMap;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);
float microSurface=reflectivityOut.microSurface;
float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif

#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;
alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);
alpha=alphaFresnelOut.alpha;
#endif
#endif

#include<pbrBlockGeometryInfo>

#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif

#ifdef REFLECTION
reflectionOutParams reflectionOut;
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#endif

#include<pbrBlockReflectance0>

#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=toLinearSpace(texture2D(sheenSampler,vSheenUV+uvOffset))*vSheenInfos.y;
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif

clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=toLinearSpace(texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset));
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif

#include<pbrBlockReflectance>

subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
surfaceAlbedo,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#else
alphaG,
#endif
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif

#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]

#include<pbrBlockFinalLitComponents>
#endif
#include<pbrBlockFinalUnlitComponents>
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
vec3 sqAlbedo=sqrt(surfaceAlbedo);
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a);
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor;
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),scatteringDiffusionProfile/255.);
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(sqAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(REFLECTIVITY)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(baseReflectivity.rgb,writeGeometryInfo);
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo);
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<pbrDebug>
}
`;j.a.ShadersStore[Qn]=Zn;var pp={name:Qn,shader:Zn},gt="pbrVertexDeclaration",Fr=`uniform mat4 view;
uniform mat4 viewProjection;
uniform mat4 world;
#ifdef ALBEDO
uniform mat4 albedoMatrix;
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;
uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif

#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
#endif

#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif

#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif

#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif

#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif`;j.a.IncludesShadersStore[gt]=Fr;var Cr={name:gt,shader:Fr},Wa=u(487),Il=u(748),No=u(749),Ha=u(593),Jn=u(656),ka=u(657),$n=u(658),Ll=u(496),qn=u(497),Br=u(507),ot=u(508),mr=u(488),Gt=u(489),un=u(750),Xa=u(675),Ya=u(551),eo=u(702),Tr=u(659),wo=u(703),to="pbrVertexShader",bn=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN

attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>

#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#endif
#include<prePassVertexDeclaration>
#if defined(ALBEDO) && ALBEDODIRECTUV == 0
varying vec2 vAlbedoUV;
#endif
#if defined(DETAIL) && DETAILDIRECTUV == 0
varying vec2 vDetailUV;
#endif
#if defined(AMBIENT) && AMBIENTDIRECTUV == 0
varying vec2 vAmbientUV;
#endif
#if defined(OPACITY) && OPACITYDIRECTUV == 0
varying vec2 vOpacityUV;
#endif
#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0
varying vec2 vEmissiveUV;
#endif
#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0
varying vec2 vLightmapUV;
#endif
#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0
varying vec2 vReflectivityUV;
#endif
#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0
varying vec2 vMicroSurfaceSamplerUV;
#endif
#if defined(METALLIC_REFLECTANCE) && METALLIC_REFLECTANCEDIRECTUV == 0
varying vec2 vMetallicReflectanceUV;
#endif
#if defined(BUMP) && BUMPDIRECTUV == 0
varying vec2 vBumpUV;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) && CLEARCOAT_TEXTUREDIRECTUV == 0
varying vec2 vClearCoatUV;
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 0
varying vec2 vClearCoatRoughnessUV;
#endif
#if defined(CLEARCOAT_BUMP) && CLEARCOAT_BUMPDIRECTUV == 0
varying vec2 vClearCoatBumpUV;
#endif
#if defined(CLEARCOAT_TINT_TEXTURE) && CLEARCOAT_TINT_TEXTUREDIRECTUV == 0
varying vec2 vClearCoatTintUV;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) && SHEEN_TEXTUREDIRECTUV == 0
varying vec2 vSheenUV;
#endif
#if defined(SHEEN_TEXTURE_ROUGHNESS) && SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 0
varying vec2 vSheenRoughnessUV;
#endif
#endif
#ifdef ANISOTROPIC
#if defined(ANISOTROPIC_TEXTURE) && ANISOTROPIC_TEXTUREDIRECTUV == 0
varying vec2 vAnisotropyUV;
#endif
#endif
#ifdef SUBSURFACE
#if defined(SS_THICKNESSANDMASK_TEXTURE) && SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 0
varying vec2 vThicknessUV;
#endif
#endif

varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#ifdef VERTEXCOLOR
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)

vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*previousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR == 0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif

#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(ALBEDO) && ALBEDODIRECTUV == 0
if (vAlbedoInfos.x == 0.)
{
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(DETAIL) && DETAILDIRECTUV == 0
if (vDetailInfos.x == 0.)
{
vDetailUV=vec2(detailMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vDetailUV=vec2(detailMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(AMBIENT) && AMBIENTDIRECTUV == 0
if (vAmbientInfos.x == 0.)
{
vAmbientUV=vec2(ambientMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(OPACITY) && OPACITYDIRECTUV == 0
if (vOpacityInfos.x == 0.)
{
vOpacityUV=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0
if (vEmissiveInfos.x == 0.)
{
vEmissiveUV=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0
if (vLightmapInfos.x == 0.)
{
vLightmapUV=vec2(lightmapMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0
if (vReflectivityInfos.x == 0.)
{
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0
if (vMicroSurfaceSamplerInfos.x == 0.)
{
vMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(METALLIC_REFLECTANCE) && METALLIC_REFLECTANCEDIRECTUV == 0
if (vMetallicReflectanceInfos.x == 0.)
{
vMetallicReflectanceUV=vec2(metallicReflectanceMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vMetallicReflectanceUV=vec2(metallicReflectanceMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(BUMP) && BUMPDIRECTUV == 0
if (vBumpInfos.x == 0.)
{
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) && CLEARCOAT_TEXTUREDIRECTUV == 0
if (vClearCoatInfos.x == 0.)
{
vClearCoatUV=vec2(clearCoatMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vClearCoatUV=vec2(clearCoatMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 0
if (vClearCoatInfos.z == 0.)
{
vClearCoatRoughnessUV=vec2(clearCoatRoughnessMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vClearCoatRoughnessUV=vec2(clearCoatRoughnessMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(CLEARCOAT_BUMP) && CLEARCOAT_BUMPDIRECTUV == 0
if (vClearCoatBumpInfos.x == 0.)
{
vClearCoatBumpUV=vec2(clearCoatBumpMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vClearCoatBumpUV=vec2(clearCoatBumpMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(CLEARCOAT_TINT_TEXTURE) && CLEARCOAT_TINT_TEXTUREDIRECTUV == 0
if (vClearCoatTintInfos.x == 0.)
{
vClearCoatTintUV=vec2(clearCoatTintMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vClearCoatTintUV=vec2(clearCoatTintMatrix*vec4(uv2,1.0,0.0));
}
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) && SHEEN_TEXTUREDIRECTUV == 0
if (vSheenInfos.x == 0.)
{
vSheenUV=vec2(sheenMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vSheenUV=vec2(sheenMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(SHEEN_TEXTURE_ROUGHNESS) && SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 0
if (vSheenInfos.z == 0.)
{
vSheenRoughnessUV=vec2(sheenRoughnessMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vSheenRoughnessUV=vec2(sheenRoughnessMatrix*vec4(uv2,1.0,0.0));
}
#endif
#endif
#ifdef ANISOTROPIC
#if defined(ANISOTROPIC_TEXTURE) && ANISOTROPIC_TEXTUREDIRECTUV == 0
if (vAnisotropyInfos.x == 0.)
{
vAnisotropyUV=vec2(anisotropyMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vAnisotropyUV=vec2(anisotropyMatrix*vec4(uv2,1.0,0.0));
}
#endif
#endif
#ifdef SUBSURFACE
#if defined(SS_THICKNESSANDMASK_TEXTURE) && SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 0
if (vThicknessInfos.x == 0.)
{
vThicknessUV=vec2(thicknessMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vThicknessUV=vec2(thicknessMatrix*vec4(uv2,1.0,0.0));
}
#endif
#endif

#include<bumpVertex>

#include<clipPlaneVertex>

#include<fogVertex>

#include<shadowsVertex>[0..maxSimultaneousLights]

#ifdef VERTEXCOLOR
vColor=color;
#endif

#ifdef POINTSIZE
gl_PointSize=pointSize;
#endif

#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;j.a.ShadersStore[to]=bn;var pi={name:to,shader:bn},Nr=u(512),cn=u(751),$r={effect:null,subMesh:null},En=function(Ve){Object(S.d)(ce,Ve);function ce(){var $=Ve.call(this)||this;return $.PBR=!0,$.NUM_SAMPLES="0",$.REALTIME_FILTERING=!1,$.MAINUV1=!1,$.MAINUV2=!1,$.UV1=!1,$.UV2=!1,$.ALBEDO=!1,$.GAMMAALBEDO=!1,$.ALBEDODIRECTUV=0,$.VERTEXCOLOR=!1,$.DETAIL=!1,$.DETAILDIRECTUV=0,$.DETAIL_NORMALBLENDMETHOD=0,$.AMBIENT=!1,$.AMBIENTDIRECTUV=0,$.AMBIENTINGRAYSCALE=!1,$.OPACITY=!1,$.VERTEXALPHA=!1,$.OPACITYDIRECTUV=0,$.OPACITYRGB=!1,$.ALPHATEST=!1,$.DEPTHPREPASS=!1,$.ALPHABLEND=!1,$.ALPHAFROMALBEDO=!1,$.ALPHATESTVALUE="0.5",$.SPECULAROVERALPHA=!1,$.RADIANCEOVERALPHA=!1,$.ALPHAFRESNEL=!1,$.LINEARALPHAFRESNEL=!1,$.PREMULTIPLYALPHA=!1,$.EMISSIVE=!1,$.EMISSIVEDIRECTUV=0,$.REFLECTIVITY=!1,$.REFLECTIVITYDIRECTUV=0,$.SPECULARTERM=!1,$.MICROSURFACEFROMREFLECTIVITYMAP=!1,$.MICROSURFACEAUTOMATIC=!1,$.LODBASEDMICROSFURACE=!1,$.MICROSURFACEMAP=!1,$.MICROSURFACEMAPDIRECTUV=0,$.METALLICWORKFLOW=!1,$.ROUGHNESSSTOREINMETALMAPALPHA=!1,$.ROUGHNESSSTOREINMETALMAPGREEN=!1,$.METALLNESSSTOREINMETALMAPBLUE=!1,$.AOSTOREINMETALMAPRED=!1,$.METALLIC_REFLECTANCE=!1,$.METALLIC_REFLECTANCEDIRECTUV=0,$.ENVIRONMENTBRDF=!1,$.ENVIRONMENTBRDF_RGBD=!1,$.NORMAL=!1,$.TANGENT=!1,$.BUMP=!1,$.BUMPDIRECTUV=0,$.OBJECTSPACE_NORMALMAP=!1,$.PARALLAX=!1,$.PARALLAXOCCLUSION=!1,$.NORMALXYSCALE=!0,$.LIGHTMAP=!1,$.LIGHTMAPDIRECTUV=0,$.USELIGHTMAPASSHADOWMAP=!1,$.GAMMALIGHTMAP=!1,$.RGBDLIGHTMAP=!1,$.REFLECTION=!1,$.REFLECTIONMAP_3D=!1,$.REFLECTIONMAP_SPHERICAL=!1,$.REFLECTIONMAP_PLANAR=!1,$.REFLECTIONMAP_CUBIC=!1,$.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,$.REFLECTIONMAP_PROJECTION=!1,$.REFLECTIONMAP_SKYBOX=!1,$.REFLECTIONMAP_EXPLICIT=!1,$.REFLECTIONMAP_EQUIRECTANGULAR=!1,$.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,$.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,$.INVERTCUBICMAP=!1,$.USESPHERICALFROMREFLECTIONMAP=!1,$.USEIRRADIANCEMAP=!1,$.SPHERICAL_HARMONICS=!1,$.USESPHERICALINVERTEX=!1,$.REFLECTIONMAP_OPPOSITEZ=!1,$.LODINREFLECTIONALPHA=!1,$.GAMMAREFLECTION=!1,$.RGBDREFLECTION=!1,$.LINEARSPECULARREFLECTION=!1,$.RADIANCEOCCLUSION=!1,$.HORIZONOCCLUSION=!1,$.INSTANCES=!1,$.THIN_INSTANCES=!1,$.PREPASS=!1,$.PREPASS_IRRADIANCE=!1,$.PREPASS_IRRADIANCE_INDEX=-1,$.PREPASS_ALBEDO=!1,$.PREPASS_ALBEDO_INDEX=-1,$.PREPASS_DEPTH=!1,$.PREPASS_DEPTH_INDEX=-1,$.PREPASS_NORMAL=!1,$.PREPASS_NORMAL_INDEX=-1,$.PREPASS_POSITION=!1,$.PREPASS_POSITION_INDEX=-1,$.PREPASS_VELOCITY=!1,$.PREPASS_VELOCITY_INDEX=-1,$.PREPASS_REFLECTIVITY=!1,$.PREPASS_REFLECTIVITY_INDEX=-1,$.SCENE_MRT_COUNT=0,$.NUM_BONE_INFLUENCERS=0,$.BonesPerMesh=0,$.BONETEXTURE=!1,$.BONES_VELOCITY_ENABLED=!1,$.NONUNIFORMSCALING=!1,$.MORPHTARGETS=!1,$.MORPHTARGETS_NORMAL=!1,$.MORPHTARGETS_TANGENT=!1,$.MORPHTARGETS_UV=!1,$.NUM_MORPH_INFLUENCERS=0,$.MORPHTARGETS_TEXTURE=!1,$.IMAGEPROCESSING=!1,$.VIGNETTE=!1,$.VIGNETTEBLENDMODEMULTIPLY=!1,$.VIGNETTEBLENDMODEOPAQUE=!1,$.TONEMAPPING=!1,$.TONEMAPPING_ACES=!1,$.CONTRAST=!1,$.COLORCURVES=!1,$.COLORGRADING=!1,$.COLORGRADING3D=!1,$.SAMPLER3DGREENDEPTH=!1,$.SAMPLER3DBGRMAP=!1,$.IMAGEPROCESSINGPOSTPROCESS=!1,$.EXPOSURE=!1,$.MULTIVIEW=!1,$.USEPHYSICALLIGHTFALLOFF=!1,$.USEGLTFLIGHTFALLOFF=!1,$.TWOSIDEDLIGHTING=!1,$.SHADOWFLOAT=!1,$.CLIPPLANE=!1,$.CLIPPLANE2=!1,$.CLIPPLANE3=!1,$.CLIPPLANE4=!1,$.CLIPPLANE5=!1,$.CLIPPLANE6=!1,$.POINTSIZE=!1,$.FOG=!1,$.LOGARITHMICDEPTH=!1,$.FORCENORMALFORWARD=!1,$.SPECULARAA=!1,$.CLEARCOAT=!1,$.CLEARCOAT_DEFAULTIOR=!1,$.CLEARCOAT_TEXTURE=!1,$.CLEARCOAT_TEXTURE_ROUGHNESS=!1,$.CLEARCOAT_TEXTUREDIRECTUV=0,$.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,$.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,$.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,$.CLEARCOAT_BUMP=!1,$.CLEARCOAT_BUMPDIRECTUV=0,$.CLEARCOAT_REMAP_F0=!0,$.CLEARCOAT_TINT=!1,$.CLEARCOAT_TINT_TEXTURE=!1,$.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,$.ANISOTROPIC=!1,$.ANISOTROPIC_TEXTURE=!1,$.ANISOTROPIC_TEXTUREDIRECTUV=0,$.BRDF_V_HEIGHT_CORRELATED=!1,$.MS_BRDF_ENERGY_CONSERVATION=!1,$.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,$.SHEEN=!1,$.SHEEN_TEXTURE=!1,$.SHEEN_TEXTURE_ROUGHNESS=!1,$.SHEEN_TEXTUREDIRECTUV=0,$.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,$.SHEEN_LINKWITHALBEDO=!1,$.SHEEN_ROUGHNESS=!1,$.SHEEN_ALBEDOSCALING=!1,$.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,$.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,$.SUBSURFACE=!1,$.SS_REFRACTION=!1,$.SS_TRANSLUCENCY=!1,$.SS_SCATTERING=!1,$.SS_THICKNESSANDMASK_TEXTURE=!1,$.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,$.SS_REFRACTIONMAP_3D=!1,$.SS_REFRACTIONMAP_OPPOSITEZ=!1,$.SS_LODINREFRACTIONALPHA=!1,$.SS_GAMMAREFRACTION=!1,$.SS_RGBDREFRACTION=!1,$.SS_LINEARSPECULARREFRACTION=!1,$.SS_LINKREFRACTIONTOTRANSPARENCY=!1,$.SS_ALBEDOFORREFRACTIONTINT=!1,$.SS_MASK_FROM_THICKNESS_TEXTURE=!1,$.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=!1,$.UNLIT=!1,$.DEBUGMODE=0,$.rebuild(),$}return ce.prototype.reset=function(){Ve.prototype.reset.call(this),this.ALPHATESTVALUE="0.5",this.PBR=!0},ce}(L.a),Ka=function(Ve){Object(S.d)(ce,Ve);function ce($,ae){var Ie=Ve.call(this,$,ae)||this;return Ie._directIntensity=1,Ie._emissiveIntensity=1,Ie._environmentIntensity=1,Ie._specularIntensity=1,Ie._lightingInfos=new T.f(Ie._directIntensity,Ie._emissiveIntensity,Ie._environmentIntensity,Ie._specularIntensity),Ie._disableBumpMap=!1,Ie._albedoTexture=null,Ie._ambientTexture=null,Ie._ambientTextureStrength=1,Ie._ambientTextureImpactOnAnalyticalLights=ce.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,Ie._opacityTexture=null,Ie._reflectionTexture=null,Ie._emissiveTexture=null,Ie._reflectivityTexture=null,Ie._metallicTexture=null,Ie._metallic=null,Ie._roughness=null,Ie._metallicF0Factor=1,Ie._metallicReflectanceColor=m.a.White(),Ie._metallicReflectanceTexture=null,Ie._microSurfaceTexture=null,Ie._bumpTexture=null,Ie._lightmapTexture=null,Ie._ambientColor=new m.a(0,0,0),Ie._albedoColor=new m.a(1,1,1),Ie._reflectivityColor=new m.a(1,1,1),Ie._reflectionColor=new m.a(1,1,1),Ie._emissiveColor=new m.a(0,0,0),Ie._microSurface=.9,Ie._useLightmapAsShadowmap=!1,Ie._useHorizonOcclusion=!0,Ie._useRadianceOcclusion=!0,Ie._useAlphaFromAlbedoTexture=!1,Ie._useSpecularOverAlpha=!0,Ie._useMicroSurfaceFromReflectivityMapAlpha=!1,Ie._useRoughnessFromMetallicTextureAlpha=!0,Ie._useRoughnessFromMetallicTextureGreen=!1,Ie._useMetallnessFromMetallicTextureBlue=!1,Ie._useAmbientOcclusionFromMetallicTextureRed=!1,Ie._useAmbientInGrayScale=!1,Ie._useAutoMicroSurfaceFromReflectivityMap=!1,Ie._lightFalloff=ce.LIGHTFALLOFF_PHYSICAL,Ie._useRadianceOverAlpha=!0,Ie._useObjectSpaceNormalMap=!1,Ie._useParallax=!1,Ie._useParallaxOcclusion=!1,Ie._parallaxScaleBias=.05,Ie._disableLighting=!1,Ie._maxSimultaneousLights=4,Ie._invertNormalMapX=!1,Ie._invertNormalMapY=!1,Ie._twoSidedLighting=!1,Ie._alphaCutOff=.4,Ie._forceAlphaTest=!1,Ie._useAlphaFresnel=!1,Ie._useLinearAlphaFresnel=!1,Ie._environmentBRDFTexture=null,Ie._forceIrradianceInFragment=!1,Ie._realTimeFiltering=!1,Ie._realTimeFilteringQuality=8,Ie._forceNormalForward=!1,Ie._enableSpecularAntiAliasing=!1,Ie._imageProcessingObserver=null,Ie._renderTargets=new O.a(16),Ie._globalAmbientColor=new m.a(0,0,0),Ie._useLogarithmicDepth=!1,Ie._unlit=!1,Ie._debugMode=0,Ie.debugMode=0,Ie.debugLimit=-1,Ie.debugFactor=1,Ie.clearCoat=new f.a(Ie._markAllSubMeshesAsTexturesDirty.bind(Ie)),Ie.anisotropy=new p(Ie._markAllSubMeshesAsTexturesDirty.bind(Ie)),Ie.brdf=new _(Ie._markAllSubMeshesAsMiscDirty.bind(Ie)),Ie.sheen=new l(Ie._markAllSubMeshesAsTexturesDirty.bind(Ie)),Ie.detailMap=new cn.a(Ie._markAllSubMeshesAsTexturesDirty.bind(Ie)),Ie._rebuildInParallel=!1,Ie._attachImageProcessingConfiguration(null),Ie.getRenderTargetTextures=function(){return Ie._renderTargets.reset(),d.a.ReflectionTextureEnabled&&Ie._reflectionTexture&&Ie._reflectionTexture.isRenderTarget&&Ie._renderTargets.push(Ie._reflectionTexture),Ie.subSurface.fillRenderTargetTextures(Ie._renderTargets),Ie._renderTargets},Ie._environmentBRDFTexture=x.a.GetEnvironmentBRDFTexture(ae),Ie.subSurface=new E(Ie._markAllSubMeshesAsTexturesDirty.bind(Ie),Ie._markScenePrePassDirty.bind(Ie),ae),Ie.prePassConfiguration=new A.a,Ie}return Object.defineProperty(ce.prototype,"realTimeFiltering",{get:function(){return this._realTimeFiltering},set:function($){this._realTimeFiltering=$,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(ce.prototype,"realTimeFilteringQuality",{get:function(){return this._realTimeFilteringQuality},set:function($){this._realTimeFilteringQuality=$,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(ce.prototype,"canRenderToMRT",{get:function(){return!0},enumerable:!1,configurable:!0}),ce.prototype._attachImageProcessingConfiguration=function($){var ae=this;$!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),$?this._imageProcessingConfiguration=$:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){ae._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(ce.prototype,"hasRenderTargetTextures",{get:function(){return d.a.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this.subSurface.hasRenderTargetTextures()},enumerable:!1,configurable:!0}),Object.defineProperty(ce.prototype,"isPrePassCapable",{get:function(){return!0},enumerable:!1,configurable:!0}),ce.prototype.getClassName=function(){return"PBRBaseMaterial"},Object.defineProperty(ce.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function($){this._useLogarithmicDepth=$&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!1,configurable:!0}),Object.defineProperty(ce.prototype,"_disableAlphaBlending",{get:function(){return this.subSurface.disableAlphaBlending||this._transparencyMode===ce.PBRMATERIAL_OPAQUE||this._transparencyMode===ce.PBRMATERIAL_ALPHATEST},enumerable:!1,configurable:!0}),ce.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()},ce.prototype.needAlphaTesting=function(){return this._forceAlphaTest?!0:this.subSurface.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===ce.PBRMATERIAL_ALPHATEST)},ce.prototype._shouldUseAlphaFromAlbedoTexture=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==ce.PBRMATERIAL_OPAQUE},ce.prototype._hasAlphaChannel=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null},ce.prototype.getAlphaTestTexture=function(){return this._albedoTexture},ce.prototype.isReadyForSubMesh=function($,ae,Ie){if(ae.effect&&this.isFrozen&&ae.effect._wasPreviouslyReady)return!0;ae._materialDefines||(ae._materialDefines=new En);var ft=ae._materialDefines;if(this._isReadyForSubMesh(ae))return!0;var mt=this.getScene(),st=mt.getEngine();if(ft._areTexturesDirty&&mt.texturesEnabled){if(this._albedoTexture&&d.a.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&d.a.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&d.a.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;var kt=this._getReflectionTexture();if(kt&&d.a.ReflectionTextureEnabled&&(!kt.isReadyOrNotBlocking()||kt.irradianceTexture&&!kt.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&d.a.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&d.a.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(d.a.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(st.getCaps().standardDerivatives&&this._bumpTexture&&d.a.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&d.a.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(!this.subSurface.isReadyForSubMesh(ft,mt)||!this.clearCoat.isReadyForSubMesh(ft,mt,st,this._disableBumpMap)||!this.sheen.isReadyForSubMesh(ft,mt)||!this.anisotropy.isReadyForSubMesh(ft,mt)||!this.detailMap.isReadyForSubMesh(ft,mt)||ft._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!st.getCaps().standardDerivatives&&!$.isVerticesDataPresent(h.b.NormalKind)&&($.createNormals(!0),U.a.Warn("PBRMaterial: Normals have been created for the mesh: "+$.name));var ht=ae.effect,ke=ft._areLightsDisposed,Et=this._prepareEffect($,ft,this.onCompiled,this.onError,Ie,null,ae.getRenderingMesh().hasThinInstances);if(Et)if(this._onEffectCreatedObservable&&($r.effect=Et,$r.subMesh=ae,this._onEffectCreatedObservable.notifyObservers($r)),this.allowShaderHotSwapping&&ht&&!Et.isReady()){if(Et=ht,this._rebuildInParallel=!0,ft.markAsUnprocessed(),ke)return ft._areLightsDisposed=!0,!1}else this._rebuildInParallel=!1,mt.resetCachedMaterial(),ae.setEffect(Et,ft),this.buildUniformLayout();return!ae.effect||!ae.effect.isReady()?!1:(ft._renderId=mt.getRenderId(),ae.effect._wasPreviouslyReady=!0,!0)},ce.prototype.isMetallicWorkflow=function(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)},ce.prototype._prepareEffect=function($,ae,Ie,ft,mt,st,kt){if(Ie===void 0&&(Ie=null),ft===void 0&&(ft=null),mt===void 0&&(mt=null),st===void 0&&(st=null),this._prepareDefines($,ae,mt,st,kt),!ae.isDirty)return null;ae.markAsProcessed();var ht=this.getScene(),ke=ht.getEngine(),Et=new Nr.a,Pt=0;ae.USESPHERICALINVERTEX&&Et.addFallback(Pt++,"USESPHERICALINVERTEX"),ae.FOG&&Et.addFallback(Pt,"FOG"),ae.SPECULARAA&&Et.addFallback(Pt,"SPECULARAA"),ae.POINTSIZE&&Et.addFallback(Pt,"POINTSIZE"),ae.LOGARITHMICDEPTH&&Et.addFallback(Pt,"LOGARITHMICDEPTH"),ae.PARALLAX&&Et.addFallback(Pt,"PARALLAX"),ae.PARALLAXOCCLUSION&&Et.addFallback(Pt++,"PARALLAXOCCLUSION"),Pt=p.AddFallbacks(ae,Et,Pt),Pt=p.AddFallbacks(ae,Et,Pt),Pt=E.AddFallbacks(ae,Et,Pt),Pt=l.AddFallbacks(ae,Et,Pt),ae.ENVIRONMENTBRDF&&Et.addFallback(Pt++,"ENVIRONMENTBRDF"),ae.TANGENT&&Et.addFallback(Pt++,"TANGENT"),ae.BUMP&&Et.addFallback(Pt++,"BUMP"),Pt=g.a.HandleFallbacksForShadows(ae,Et,this._maxSimultaneousLights,Pt++),ae.SPECULARTERM&&Et.addFallback(Pt++,"SPECULARTERM"),ae.USESPHERICALFROMREFLECTIONMAP&&Et.addFallback(Pt++,"USESPHERICALFROMREFLECTIONMAP"),ae.USEIRRADIANCEMAP&&Et.addFallback(Pt++,"USEIRRADIANCEMAP"),ae.LIGHTMAP&&Et.addFallback(Pt++,"LIGHTMAP"),ae.NORMAL&&Et.addFallback(Pt++,"NORMAL"),ae.AMBIENT&&Et.addFallback(Pt++,"AMBIENT"),ae.EMISSIVE&&Et.addFallback(Pt++,"EMISSIVE"),ae.VERTEXCOLOR&&Et.addFallback(Pt++,"VERTEXCOLOR"),ae.MORPHTARGETS&&Et.addFallback(Pt++,"MORPHTARGETS"),ae.MULTIVIEW&&Et.addFallback(0,"MULTIVIEW");var ri=[h.b.PositionKind];ae.NORMAL&&ri.push(h.b.NormalKind),ae.TANGENT&&ri.push(h.b.TangentKind),ae.UV1&&ri.push(h.b.UVKind),ae.UV2&&ri.push(h.b.UV2Kind),ae.VERTEXCOLOR&&ri.push(h.b.ColorKind),g.a.PrepareAttributesForBones(ri,$,ae,Et),g.a.PrepareAttributesForInstances(ri,ae),g.a.PrepareAttributesForMorphTargets(ri,$,ae);var vt="pbr",qt=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],gi=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","morphTargets"],wr=["Material","Scene","Mesh"];cn.a.AddUniforms(qt),cn.a.AddSamplers(gi),E.AddUniforms(qt),E.AddSamplers(gi),f.a.AddUniforms(qt),f.a.AddSamplers(gi),p.AddUniforms(qt),p.AddSamplers(gi),l.AddUniforms(qt),l.AddSamplers(gi),A.a.AddUniforms(qt),A.a.AddSamplers(qt),F.a&&(F.a.PrepareUniforms(qt,ae),F.a.PrepareSamplers(gi,ae)),g.a.PrepareUniformsAndSamplersList({uniformsNames:qt,uniformBuffersNames:wr,samplers:gi,defines:ae,maxSimultaneousLights:this._maxSimultaneousLights});var Ai={};this.customShaderNameResolve&&(vt=this.customShaderNameResolve(vt,qt,wr,gi,ae,ri,Ai));var Pn=ae.toString();return ke.createEffect(vt,{attributes:ri,uniformsNames:qt,uniformBuffersNames:wr,samplers:gi,defines:Pn,fallbacks:Et,onCompiled:Ie,onError:ft,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:ae.NUM_MORPH_INFLUENCERS},processFinalCode:Ai.processFinalCode,multiTarget:ae.PREPASS},ke)},ce.prototype._prepareDefines=function($,ae,Ie,ft,mt){Ie===void 0&&(Ie=null),ft===void 0&&(ft=null),mt===void 0&&(mt=!1);var st=this.getScene(),kt=st.getEngine();if(g.a.PrepareDefinesForLights(st,$,ae,!0,this._maxSimultaneousLights,this._disableLighting),ae._needNormals=!0,g.a.PrepareDefinesForMultiview(st,ae),g.a.PrepareDefinesForPrePass(st,ae,this.canRenderToMRT),ae.METALLICWORKFLOW=this.isMetallicWorkflow(),ae._areTexturesDirty){if(ae._needUVs=!1,st.texturesEnabled){st.getEngine().getCaps().textureLOD&&(ae.LODBASEDMICROSFURACE=!0),this._albedoTexture&&d.a.DiffuseTextureEnabled?(g.a.PrepareDefinesForMergedUV(this._albedoTexture,ae,"ALBEDO"),ae.GAMMAALBEDO=this._albedoTexture.gammaSpace):ae.ALBEDO=!1,this._ambientTexture&&d.a.AmbientTextureEnabled?(g.a.PrepareDefinesForMergedUV(this._ambientTexture,ae,"AMBIENT"),ae.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):ae.AMBIENT=!1,this._opacityTexture&&d.a.OpacityTextureEnabled?(g.a.PrepareDefinesForMergedUV(this._opacityTexture,ae,"OPACITY"),ae.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):ae.OPACITY=!1;var ht=this._getReflectionTexture();if(ht&&d.a.ReflectionTextureEnabled){switch(ae.REFLECTION=!0,ae.GAMMAREFLECTION=ht.gammaSpace,ae.RGBDREFLECTION=ht.isRGBD,ae.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!ht.invertZ:ht.invertZ,ae.LODINREFLECTIONALPHA=ht.lodLevelInAlpha,ae.LINEARSPECULARREFLECTION=ht.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(ae.NUM_SAMPLES=""+this.realTimeFilteringQuality,kt._features.needTypeSuffixInShaderConstants&&(ae.NUM_SAMPLES=ae.NUM_SAMPLES+"u"),ae.REALTIME_FILTERING=!0):ae.REALTIME_FILTERING=!1,ht.coordinatesMode===z.a.INVCUBIC_MODE&&(ae.INVERTCUBICMAP=!0),ae.REFLECTIONMAP_3D=ht.isCube,ae.REFLECTIONMAP_CUBIC=!1,ae.REFLECTIONMAP_EXPLICIT=!1,ae.REFLECTIONMAP_PLANAR=!1,ae.REFLECTIONMAP_PROJECTION=!1,ae.REFLECTIONMAP_SKYBOX=!1,ae.REFLECTIONMAP_SPHERICAL=!1,ae.REFLECTIONMAP_EQUIRECTANGULAR=!1,ae.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,ae.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,ht.coordinatesMode){case z.a.EXPLICIT_MODE:ae.REFLECTIONMAP_EXPLICIT=!0;break;case z.a.PLANAR_MODE:ae.REFLECTIONMAP_PLANAR=!0;break;case z.a.PROJECTION_MODE:ae.REFLECTIONMAP_PROJECTION=!0;break;case z.a.SKYBOX_MODE:ae.REFLECTIONMAP_SKYBOX=!0;break;case z.a.SPHERICAL_MODE:ae.REFLECTIONMAP_SPHERICAL=!0;break;case z.a.EQUIRECTANGULAR_MODE:ae.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case z.a.FIXED_EQUIRECTANGULAR_MODE:ae.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case z.a.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:ae.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case z.a.CUBIC_MODE:case z.a.INVCUBIC_MODE:default:ae.REFLECTIONMAP_CUBIC=!0,ae.USE_LOCAL_REFLECTIONMAP_CUBIC=!!ht.boundingBoxSize;break}ht.coordinatesMode!==z.a.SKYBOX_MODE&&(ht.irradianceTexture?(ae.USEIRRADIANCEMAP=!0,ae.USESPHERICALFROMREFLECTIONMAP=!1):ht.isCube&&(ae.USESPHERICALFROMREFLECTIONMAP=!0,ae.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||st.getEngine().getCaps().maxVaryingVectors<=8?ae.USESPHERICALINVERTEX=!1:ae.USESPHERICALINVERTEX=!0))}else ae.REFLECTION=!1,ae.REFLECTIONMAP_3D=!1,ae.REFLECTIONMAP_SPHERICAL=!1,ae.REFLECTIONMAP_PLANAR=!1,ae.REFLECTIONMAP_CUBIC=!1,ae.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,ae.REFLECTIONMAP_PROJECTION=!1,ae.REFLECTIONMAP_SKYBOX=!1,ae.REFLECTIONMAP_EXPLICIT=!1,ae.REFLECTIONMAP_EQUIRECTANGULAR=!1,ae.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,ae.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,ae.INVERTCUBICMAP=!1,ae.USESPHERICALFROMREFLECTIONMAP=!1,ae.USEIRRADIANCEMAP=!1,ae.USESPHERICALINVERTEX=!1,ae.REFLECTIONMAP_OPPOSITEZ=!1,ae.LODINREFLECTIONALPHA=!1,ae.GAMMAREFLECTION=!1,ae.RGBDREFLECTION=!1,ae.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&d.a.LightmapTextureEnabled?(g.a.PrepareDefinesForMergedUV(this._lightmapTexture,ae,"LIGHTMAP"),ae.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,ae.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,ae.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):ae.LIGHTMAP=!1,this._emissiveTexture&&d.a.EmissiveTextureEnabled?g.a.PrepareDefinesForMergedUV(this._emissiveTexture,ae,"EMISSIVE"):ae.EMISSIVE=!1,d.a.SpecularTextureEnabled?(this._metallicTexture?(g.a.PrepareDefinesForMergedUV(this._metallicTexture,ae,"REFLECTIVITY"),ae.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,ae.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,ae.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,ae.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed):this._reflectivityTexture?(g.a.PrepareDefinesForMergedUV(this._reflectivityTexture,ae,"REFLECTIVITY"),ae.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,ae.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap):ae.REFLECTIVITY=!1,this._metallicReflectanceTexture?g.a.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,ae,"METALLIC_REFLECTANCE"):ae.METALLIC_REFLECTANCE=!1,this._microSurfaceTexture?g.a.PrepareDefinesForMergedUV(this._microSurfaceTexture,ae,"MICROSURFACEMAP"):ae.MICROSURFACEMAP=!1):(ae.REFLECTIVITY=!1,ae.MICROSURFACEMAP=!1),st.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&d.a.BumpTextureEnabled&&!this._disableBumpMap?(g.a.PrepareDefinesForMergedUV(this._bumpTexture,ae,"BUMP"),this._useParallax&&this._albedoTexture&&d.a.DiffuseTextureEnabled?(ae.PARALLAX=!0,ae.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):ae.PARALLAX=!1,ae.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):ae.BUMP=!1,this._environmentBRDFTexture&&d.a.ReflectionTextureEnabled?(ae.ENVIRONMENTBRDF=!0,ae.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(ae.ENVIRONMENTBRDF=!1,ae.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?ae.ALPHAFROMALBEDO=!0:ae.ALPHAFROMALBEDO=!1}ae.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===ce.LIGHTFALLOFF_STANDARD?(ae.USEPHYSICALLIGHTFALLOFF=!1,ae.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===ce.LIGHTFALLOFF_GLTF?(ae.USEPHYSICALLIGHTFALLOFF=!1,ae.USEGLTFLIGHTFALLOFF=!0):(ae.USEPHYSICALLIGHTFALLOFF=!0,ae.USEGLTFLIGHTFALLOFF=!1),ae.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?ae.TWOSIDEDLIGHTING=!0:ae.TWOSIDEDLIGHTING=!1,ae.SPECULARAA=st.getEngine().getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(ae._areTexturesDirty||ae._areMiscDirty)&&(ae.ALPHATESTVALUE=""+this._alphaCutOff+(this._alphaCutOff%1==0?".":""),ae.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,ae.ALPHABLEND=this.needAlphaBlendingForMesh($),ae.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,ae.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),ae._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(ae),ae.FORCENORMALFORWARD=this._forceNormalForward,ae.RADIANCEOCCLUSION=this._useRadianceOcclusion,ae.HORIZONOCCLUSION=this._useHorizonOcclusion,ae._areMiscDirty&&(g.a.PrepareDefinesForMisc($,st,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn($)||this._forceAlphaTest,ae),ae.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!$.isVerticesDataPresent(h.b.NormalKind),ae.DEBUGMODE=this._debugMode),this.detailMap.prepareDefines(ae,st),this.subSurface.prepareDefines(ae,st),this.clearCoat.prepareDefines(ae,st),this.anisotropy.prepareDefines(ae,$,st),this.brdf.prepareDefines(ae),this.sheen.prepareDefines(ae,st),g.a.PrepareDefinesForFrameBoundValues(st,kt,ae,!!Ie,ft,mt),g.a.PrepareDefinesForAttributes($,ae,!0,!0,!0,this._transparencyMode!==ce.PBRMATERIAL_OPAQUE)},ce.prototype.forceCompilation=function($,ae,Ie){var ft=this,mt=Object(S.a)({clipPlane:!1,useInstances:!1},Ie),st=new En,kt=this._prepareEffect($,st,void 0,void 0,mt.useInstances,mt.clipPlane,$.hasThinInstances);this._onEffectCreatedObservable&&($r.effect=kt,$r.subMesh=null,this._onEffectCreatedObservable.notifyObservers($r)),kt.isReady()?ae&&ae(this):kt.onCompileObservable.add(function(){ae&&ae(ft)})},ce.prototype.buildUniformLayout=function(){var $=this._uniformBuffer;$.addUniform("vAlbedoInfos",2),$.addUniform("vAmbientInfos",4),$.addUniform("vOpacityInfos",2),$.addUniform("vEmissiveInfos",2),$.addUniform("vLightmapInfos",2),$.addUniform("vReflectivityInfos",3),$.addUniform("vMicroSurfaceSamplerInfos",2),$.addUniform("vReflectionInfos",2),$.addUniform("vReflectionFilteringInfo",2),$.addUniform("vReflectionPosition",3),$.addUniform("vReflectionSize",3),$.addUniform("vBumpInfos",3),$.addUniform("albedoMatrix",16),$.addUniform("ambientMatrix",16),$.addUniform("opacityMatrix",16),$.addUniform("emissiveMatrix",16),$.addUniform("lightmapMatrix",16),$.addUniform("reflectivityMatrix",16),$.addUniform("microSurfaceSamplerMatrix",16),$.addUniform("bumpMatrix",16),$.addUniform("vTangentSpaceParams",2),$.addUniform("reflectionMatrix",16),$.addUniform("vReflectionColor",3),$.addUniform("vAlbedoColor",4),$.addUniform("vLightingIntensity",4),$.addUniform("vReflectionMicrosurfaceInfos",3),$.addUniform("pointSize",1),$.addUniform("vReflectivityColor",4),$.addUniform("vEmissiveColor",3),$.addUniform("vAmbientColor",3),$.addUniform("vDebugMode",2),$.addUniform("vMetallicReflectanceFactors",4),$.addUniform("vMetallicReflectanceInfos",2),$.addUniform("metallicReflectanceMatrix",16),f.a.PrepareUniformBuffer($),p.PrepareUniformBuffer($),l.PrepareUniformBuffer($),E.PrepareUniformBuffer($),cn.a.PrepareUniformBuffer($),$.addUniform("vSphericalL00",3),$.addUniform("vSphericalL1_1",3),$.addUniform("vSphericalL10",3),$.addUniform("vSphericalL11",3),$.addUniform("vSphericalL2_2",3),$.addUniform("vSphericalL2_1",3),$.addUniform("vSphericalL20",3),$.addUniform("vSphericalL21",3),$.addUniform("vSphericalL22",3),$.addUniform("vSphericalX",3),$.addUniform("vSphericalY",3),$.addUniform("vSphericalZ",3),$.addUniform("vSphericalXX_ZZ",3),$.addUniform("vSphericalYY_ZZ",3),$.addUniform("vSphericalZZ",3),$.addUniform("vSphericalXY",3),$.addUniform("vSphericalYZ",3),$.addUniform("vSphericalZX",3),$.create()},ce.prototype.unbind=function(){if(this._activeEffect){var $=!1;this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&(this._activeEffect.setTexture("reflection2DSampler",null),$=!0),this.subSurface.unbind(this._activeEffect)&&($=!0),$&&this._markAllSubMeshesAsTexturesDirty()}Ve.prototype.unbind.call(this)},ce.prototype.bindForSubMesh=function($,ae,Ie){var ft=this.getScene(),mt=Ie._materialDefines;if(!!mt){var st=Ie.effect;if(!!st){this._activeEffect=st,ae.getMeshUniformBuffer().bindToEffect(st,"Mesh"),ae.transferToEffect($),this.prePassConfiguration.bindForSubMesh(this._activeEffect,ft,ae,$,this.isFrozen),mt.OBJECTSPACE_NORMALMAP&&($.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var kt=this._mustRebind(ft,st,ae.visibility);g.a.BindBonesParameters(ae,this._activeEffect,this.prePassConfiguration);var ht=null,ke=this._uniformBuffer;if(kt){var Et=ft.getEngine();if(ke.bindToEffect(st,"Material"),this.bindViewProjection(st),ht=this._getReflectionTexture(),!ke.useUbo||!this.isFrozen||!ke.isSync){if(ft.texturesEnabled){if(this._albedoTexture&&d.a.DiffuseTextureEnabled&&(ke.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),g.a.BindTextureMatrix(this._albedoTexture,ke,"albedo")),this._ambientTexture&&d.a.AmbientTextureEnabled&&(ke.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),g.a.BindTextureMatrix(this._ambientTexture,ke,"ambient")),this._opacityTexture&&d.a.OpacityTextureEnabled&&(ke.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),g.a.BindTextureMatrix(this._opacityTexture,ke,"opacity")),ht&&d.a.ReflectionTextureEnabled){if(ke.updateMatrix("reflectionMatrix",ht.getReflectionTextureMatrix()),ke.updateFloat2("vReflectionInfos",ht.level,0),ht.boundingBoxSize){var Pt=ht;ke.updateVector3("vReflectionPosition",Pt.boundingBoxPosition),ke.updateVector3("vReflectionSize",Pt.boundingBoxSize)}if(this.realTimeFiltering){var ri=ht.getSize().width;ke.updateFloat2("vReflectionFilteringInfo",ri,y.a.Log2(ri))}if(!mt.USEIRRADIANCEMAP){var vt=ht.sphericalPolynomial;if(mt.USESPHERICALFROMREFLECTIONMAP&&vt)if(mt.SPHERICAL_HARMONICS){var qt=vt.preScaledHarmonics;ke.updateVector3("vSphericalL00",qt.l00),ke.updateVector3("vSphericalL1_1",qt.l1_1),ke.updateVector3("vSphericalL10",qt.l10),ke.updateVector3("vSphericalL11",qt.l11),ke.updateVector3("vSphericalL2_2",qt.l2_2),ke.updateVector3("vSphericalL2_1",qt.l2_1),ke.updateVector3("vSphericalL20",qt.l20),ke.updateVector3("vSphericalL21",qt.l21),ke.updateVector3("vSphericalL22",qt.l22)}else ke.updateFloat3("vSphericalX",vt.x.x,vt.x.y,vt.x.z),ke.updateFloat3("vSphericalY",vt.y.x,vt.y.y,vt.y.z),ke.updateFloat3("vSphericalZ",vt.z.x,vt.z.y,vt.z.z),ke.updateFloat3("vSphericalXX_ZZ",vt.xx.x-vt.zz.x,vt.xx.y-vt.zz.y,vt.xx.z-vt.zz.z),ke.updateFloat3("vSphericalYY_ZZ",vt.yy.x-vt.zz.x,vt.yy.y-vt.zz.y,vt.yy.z-vt.zz.z),ke.updateFloat3("vSphericalZZ",vt.zz.x,vt.zz.y,vt.zz.z),ke.updateFloat3("vSphericalXY",vt.xy.x,vt.xy.y,vt.xy.z),ke.updateFloat3("vSphericalYZ",vt.yz.x,vt.yz.y,vt.yz.z),ke.updateFloat3("vSphericalZX",vt.zx.x,vt.zx.y,vt.zx.z)}ke.updateFloat3("vReflectionMicrosurfaceInfos",ht.getSize().width,ht.lodGenerationScale,ht.lodGenerationOffset)}this._emissiveTexture&&d.a.EmissiveTextureEnabled&&(ke.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),g.a.BindTextureMatrix(this._emissiveTexture,ke,"emissive")),this._lightmapTexture&&d.a.LightmapTextureEnabled&&(ke.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),g.a.BindTextureMatrix(this._lightmapTexture,ke,"lightmap")),d.a.SpecularTextureEnabled&&(this._metallicTexture?(ke.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),g.a.BindTextureMatrix(this._metallicTexture,ke,"reflectivity")):this._reflectivityTexture&&(ke.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),g.a.BindTextureMatrix(this._reflectivityTexture,ke,"reflectivity")),this._metallicReflectanceTexture&&(ke.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),g.a.BindTextureMatrix(this._metallicReflectanceTexture,ke,"metallicReflectance")),this._microSurfaceTexture&&(ke.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),g.a.BindTextureMatrix(this._microSurfaceTexture,ke,"microSurfaceSampler"))),this._bumpTexture&&Et.getCaps().standardDerivatives&&d.a.BumpTextureEnabled&&!this._disableBumpMap&&(ke.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),g.a.BindTextureMatrix(this._bumpTexture,ke,"bump"),ft._mirroredCameraPosition?ke.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):ke.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&ke.updateFloat("pointSize",this.pointSize),mt.METALLICWORKFLOW){m.c.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,m.c.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,ke.updateColor4("vReflectivityColor",m.c.Color3[0],1);var gi=this.subSurface.indexOfRefraction,wr=1,Ai=Math.pow((gi-wr)/(gi+wr),2);this._metallicReflectanceColor.scaleToRef(Ai*this._metallicF0Factor,m.c.Color3[0]);var Pn=this._metallicF0Factor;ke.updateColor4("vMetallicReflectanceFactors",m.c.Color3[0],Pn)}else ke.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);ke.updateColor3("vEmissiveColor",d.a.EmissiveTextureEnabled?this._emissiveColor:m.a.BlackReadOnly),ke.updateColor3("vReflectionColor",this._reflectionColor),!mt.SS_REFRACTION&&this.subSurface.linkRefractionWithTransparency?ke.updateColor4("vAlbedoColor",this._albedoColor,1):ke.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*ft.environmentIntensity,this._lightingInfos.w=this._specularIntensity,ke.updateVector4("vLightingIntensity",this._lightingInfos),ft.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),ke.updateColor3("vAmbientColor",this._globalAmbientColor),ke.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}ft.texturesEnabled&&(this._albedoTexture&&d.a.DiffuseTextureEnabled&&ke.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&d.a.AmbientTextureEnabled&&ke.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&d.a.OpacityTextureEnabled&&ke.setTexture("opacitySampler",this._opacityTexture),ht&&d.a.ReflectionTextureEnabled&&(mt.LODBASEDMICROSFURACE?ke.setTexture("reflectionSampler",ht):(ke.setTexture("reflectionSampler",ht._lodTextureMid||ht),ke.setTexture("reflectionSamplerLow",ht._lodTextureLow||ht),ke.setTexture("reflectionSamplerHigh",ht._lodTextureHigh||ht)),mt.USEIRRADIANCEMAP&&ke.setTexture("irradianceSampler",ht.irradianceTexture)),mt.ENVIRONMENTBRDF&&ke.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&d.a.EmissiveTextureEnabled&&ke.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&d.a.LightmapTextureEnabled&&ke.setTexture("lightmapSampler",this._lightmapTexture),d.a.SpecularTextureEnabled&&(this._metallicTexture?ke.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&ke.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&ke.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._microSurfaceTexture&&ke.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&Et.getCaps().standardDerivatives&&d.a.BumpTextureEnabled&&!this._disableBumpMap&&ke.setTexture("bumpSampler",this._bumpTexture)),this.detailMap.bindForSubMesh(ke,ft,this.isFrozen),this.subSurface.bindForSubMesh(ke,ft,Et,this.isFrozen,mt.LODBASEDMICROSFURACE,this.realTimeFiltering),this.clearCoat.bindForSubMesh(ke,ft,Et,this._disableBumpMap,this.isFrozen,this._invertNormalMapX,this._invertNormalMapY,Ie),this.anisotropy.bindForSubMesh(ke,ft,this.isFrozen),this.sheen.bindForSubMesh(ke,ft,this.isFrozen,Ie),g.a.BindClipPlane(this._activeEffect,ft),this.bindEyePosition(st)}(kt||!this.isFrozen)&&(ft.lightsEnabled&&!this._disableLighting&&g.a.BindLights(ft,ae,this._activeEffect,mt,this._maxSimultaneousLights,this._rebuildInParallel),(ft.fogEnabled&&ae.applyFog&&ft.fogMode!==G.a.FOGMODE_NONE||ht)&&this.bindView(st),g.a.BindFogParameters(ft,ae,this._activeEffect,!0),mt.NUM_MORPH_INFLUENCERS&&g.a.BindMorphTargetParameters(ae,this._activeEffect),this._imageProcessingConfiguration.bind(this._activeEffect),g.a.BindLogDepth(mt,this._activeEffect,ft)),this._afterBind(ae,this._activeEffect),ke.update()}}},ce.prototype.getAnimatables=function(){var $=[];return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&$.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&$.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&$.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&$.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&$.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?$.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&$.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&$.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&$.push(this._lightmapTexture),this.detailMap.getAnimatables($),this.subSurface.getAnimatables($),this.clearCoat.getAnimatables($),this.sheen.getAnimatables($),this.anisotropy.getAnimatables($),$},ce.prototype._getReflectionTexture=function(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture},ce.prototype.getActiveTextures=function(){var $=Ve.prototype.getActiveTextures.call(this);return this._albedoTexture&&$.push(this._albedoTexture),this._ambientTexture&&$.push(this._ambientTexture),this._opacityTexture&&$.push(this._opacityTexture),this._reflectionTexture&&$.push(this._reflectionTexture),this._emissiveTexture&&$.push(this._emissiveTexture),this._reflectivityTexture&&$.push(this._reflectivityTexture),this._metallicTexture&&$.push(this._metallicTexture),this._metallicReflectanceTexture&&$.push(this._metallicReflectanceTexture),this._microSurfaceTexture&&$.push(this._microSurfaceTexture),this._bumpTexture&&$.push(this._bumpTexture),this._lightmapTexture&&$.push(this._lightmapTexture),this.detailMap.getActiveTextures($),this.subSurface.getActiveTextures($),this.clearCoat.getActiveTextures($),this.sheen.getActiveTextures($),this.anisotropy.getActiveTextures($),$},ce.prototype.hasTexture=function($){return Ve.prototype.hasTexture.call(this,$)||this._albedoTexture===$||this._ambientTexture===$||this._opacityTexture===$||this._reflectionTexture===$||this._reflectivityTexture===$||this._metallicTexture===$||this._metallicReflectanceTexture===$||this._microSurfaceTexture===$||this._bumpTexture===$||this._lightmapTexture===$?!0:this.detailMap.hasTexture($)||this.subSurface.hasTexture($)||this.clearCoat.hasTexture($)||this.sheen.hasTexture($)||this.anisotropy.hasTexture($)},ce.prototype.setPrePassRenderer=function($){if(this.subSurface.isScatteringEnabled){var ae=this.getScene().enableSubSurfaceForPrePass();return ae&&(ae.enabled=!0),!0}return!1},ce.prototype.dispose=function($,ae){var Ie,ft,mt,st,kt,ht,ke,Et,Pt,ri,vt;ae&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(Ie=this._albedoTexture)===null||Ie===void 0||Ie.dispose(),(ft=this._ambientTexture)===null||ft===void 0||ft.dispose(),(mt=this._opacityTexture)===null||mt===void 0||mt.dispose(),(st=this._reflectionTexture)===null||st===void 0||st.dispose(),(kt=this._emissiveTexture)===null||kt===void 0||kt.dispose(),(ht=this._metallicTexture)===null||ht===void 0||ht.dispose(),(ke=this._reflectivityTexture)===null||ke===void 0||ke.dispose(),(Et=this._bumpTexture)===null||Et===void 0||Et.dispose(),(Pt=this._lightmapTexture)===null||Pt===void 0||Pt.dispose(),(ri=this._metallicReflectanceTexture)===null||ri===void 0||ri.dispose(),(vt=this._microSurfaceTexture)===null||vt===void 0||vt.dispose()),this.detailMap.dispose(ae),this.subSurface.dispose(ae),this.clearCoat.dispose(ae),this.sheen.dispose(ae),this.anisotropy.dispose(ae),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),Ve.prototype.dispose.call(this,$,ae)},ce.PBRMATERIAL_OPAQUE=B.a.MATERIAL_OPAQUE,ce.PBRMATERIAL_ALPHATEST=B.a.MATERIAL_ALPHATEST,ce.PBRMATERIAL_ALPHABLEND=B.a.MATERIAL_ALPHABLEND,ce.PBRMATERIAL_ALPHATESTANDBLEND=B.a.MATERIAL_ALPHATESTANDBLEND,ce.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,ce.LIGHTFALLOFF_PHYSICAL=0,ce.LIGHTFALLOFF_GLTF=1,ce.LIGHTFALLOFF_STANDARD=2,Object(S.c)([Object(R.i)()],ce.prototype,"_imageProcessingConfiguration",void 0),Object(S.c)([Object(R.b)("_markAllSubMeshesAsMiscDirty")],ce.prototype,"debugMode",void 0),Object(S.c)([Object(R.c)()],ce.prototype,"useLogarithmicDepth",null),ce}(I.a)},530:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(483),R=u(572),U=u(438),O=u(449),x=u(436),G=u(589),T=u(542),h=function(){function f(d,g,p,_,m,l,y,E,A,F){p===void 0&&(p=0),_===void 0&&(_=100),m===void 0&&(m=!1),l===void 0&&(l=1),F===void 0&&(F=!1),this.target=g,this.fromFrame=p,this.toFrame=_,this.loopAnimation=m,this.onAnimationEnd=y,this.onAnimationLoop=A,this.isAdditive=F,this._localDelayOffset=null,this._pausedDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new U.c,this.onAnimationLoopObservable=new U.c,this._scene=d,E&&this.appendAnimations(g,E),this._speedRatio=l,d._activeAnimatables.push(this)}return Object.defineProperty(f.prototype,"syncRoot",{get:function(){return this._syncRoot},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"masterFrame",{get:function(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"weight",{get:function(){return this._weight},set:function(d){if(d===-1){this._weight=-1;return}this._weight=Math.min(Math.max(d,0),1)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(d){for(var g=0;g<this._runtimeAnimations.length;g++){var p=this._runtimeAnimations[g];p._prepareForSpeedRatioChange(d)}this._speedRatio=d},enumerable:!1,configurable:!0}),f.prototype.syncWith=function(d){if(this._syncRoot=d,d){var g=this._scene._activeAnimatables.indexOf(this);g>-1&&(this._scene._activeAnimatables.splice(g,1),this._scene._activeAnimatables.push(this))}return this},f.prototype.getAnimations=function(){return this._runtimeAnimations},f.prototype.appendAnimations=function(d,g){for(var p=this,_=0;_<g.length;_++){var m=g[_],l=new R.a(d,m,this._scene,this);l._onLoop=function(){p.onAnimationLoopObservable.notifyObservers(p),p.onAnimationLoop&&p.onAnimationLoop()},this._runtimeAnimations.push(l)}},f.prototype.getAnimationByTargetProperty=function(d){for(var g=this._runtimeAnimations,p=0;p<g.length;p++)if(g[p].animation.targetProperty===d)return g[p].animation;return null},f.prototype.getRuntimeAnimationByTargetProperty=function(d){for(var g=this._runtimeAnimations,p=0;p<g.length;p++)if(g[p].animation.targetProperty===d)return g[p];return null},f.prototype.reset=function(){for(var d=this._runtimeAnimations,g=0;g<d.length;g++)d[g].reset(!0);this._localDelayOffset=null,this._pausedDelay=null},f.prototype.enableBlending=function(d){for(var g=this._runtimeAnimations,p=0;p<g.length;p++)g[p].animation.enableBlending=!0,g[p].animation.blendingSpeed=d},f.prototype.disableBlending=function(){for(var d=this._runtimeAnimations,g=0;g<d.length;g++)d[g].animation.enableBlending=!1},f.prototype.goToFrame=function(d){var g=this._runtimeAnimations;if(g[0]){var p=g[0].animation.framePerSecond,_=g[0].currentFrame,m=this.speedRatio===0?0:(d-_)/p*1e3/this.speedRatio;this._localDelayOffset===null&&(this._localDelayOffset=0),this._localDelayOffset-=m}for(var l=0;l<g.length;l++)g[l].goToFrame(d)},f.prototype.pause=function(){this._paused||(this._paused=!0)},f.prototype.restart=function(){this._paused=!1},f.prototype._raiseOnAnimationEnd=function(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)},f.prototype.stop=function(d,g){if(d||g){var p=this._scene._activeAnimatables.indexOf(this);if(p>-1){for(var _=this._runtimeAnimations,m=_.length-1;m>=0;m--){var l=_[m];d&&l.animation.name!=d||g&&!g(l.target)||(l.dispose(),_.splice(m,1))}_.length==0&&(this._scene._activeAnimatables.splice(p,1),this._raiseOnAnimationEnd())}}else{var m=this._scene._activeAnimatables.indexOf(this);if(m>-1){this._scene._activeAnimatables.splice(m,1);for(var _=this._runtimeAnimations,m=0;m<_.length;m++)_[m].dispose();this._raiseOnAnimationEnd()}}},f.prototype.waitAsync=function(){var d=this;return new Promise(function(g,p){d.onAnimationEndObservable.add(function(){g(d)},void 0,void 0,d,!0)})},f.prototype._animate=function(d){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=d),!0;if(this._localDelayOffset===null?(this._localDelayOffset=d,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=d-this._pausedDelay,this._pausedDelay=null),this._weight===0)return!0;var g=!1,p=this._runtimeAnimations,_;for(_=0;_<p.length;_++){var m=p[_],l=m.animate(d-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);g=g||l}if(this.animationStarted=g,!g){if(this.disposeOnEnd)for(_=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(_,1),_=0;_<p.length;_++)p[_].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return g},f}();O.a.prototype._animate=function(){if(!!this.animationsEnabled){var f=G.a.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=f}this.deltaTime=this.useConstantAnimationDeltaTime?16:(f-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=f;var d=this._activeAnimatables;if(d.length!==0){this._animationTime+=this.deltaTime;for(var g=this._animationTime,p=0;p<d.length;p++){var _=d[p];!_._animate(g)&&_.disposeOnEnd&&p--}this._processLateAnimationBindings()}}},O.a.prototype.beginWeightedAnimation=function(f,d,g,p,_,m,l,y,E,A,F){p===void 0&&(p=1),m===void 0&&(m=1),F===void 0&&(F=!1);var B=this.beginAnimation(f,d,g,_,m,l,y,!1,E,A,F);return B.weight=p,B},O.a.prototype.beginAnimation=function(f,d,g,p,_,m,l,y,E,A,F){_===void 0&&(_=1),y===void 0&&(y=!0),F===void 0&&(F=!1),d>g&&_>0&&(_*=-1),y&&this.stopAnimation(f,void 0,E),l||(l=new h(this,f,d,g,p,_,m,void 0,A,F));var B=E?E(f):!0;if(f.animations&&B&&l.appendAnimations(f,f.animations),f.getAnimatables)for(var L=f.getAnimatables(),I=0;I<L.length;I++)this.beginAnimation(L[I],d,g,p,_,m,l,y,E,A);return l.reset(),l},O.a.prototype.beginHierarchyAnimation=function(f,d,g,p,_,m,l,y,E,A,F,B){m===void 0&&(m=1),E===void 0&&(E=!0),B===void 0&&(B=!1);var L=f.getDescendants(d),I=[];I.push(this.beginAnimation(f,g,p,_,m,l,y,E,A,void 0,B));for(var z=0,k=L;z<k.length;z++){var j=k[z];I.push(this.beginAnimation(j,g,p,_,m,l,y,E,A,void 0,B))}return I},O.a.prototype.beginDirectAnimation=function(f,d,g,p,_,m,l,y,E){E===void 0&&(E=!1),m===void 0&&(m=1),g>p&&m>0&&(m*=-1);var A=new h(this,f,g,p,_,m,l,d,y,E);return A},O.a.prototype.beginDirectHierarchyAnimation=function(f,d,g,p,_,m,l,y,E,A){A===void 0&&(A=!1);var F=f.getDescendants(d),B=[];B.push(this.beginDirectAnimation(f,g,p,_,m,l,y,E,A));for(var L=0,I=F;L<I.length;L++){var z=I[L];B.push(this.beginDirectAnimation(z,g,p,_,m,l,y,E,A))}return B},O.a.prototype.getAnimatableByTarget=function(f){for(var d=0;d<this._activeAnimatables.length;d++)if(this._activeAnimatables[d].target===f)return this._activeAnimatables[d];return null},O.a.prototype.getAllAnimatablesByTarget=function(f){for(var d=[],g=0;g<this._activeAnimatables.length;g++)this._activeAnimatables[g].target===f&&d.push(this._activeAnimatables[g]);return d},O.a.prototype.stopAnimation=function(f,d,g){for(var p=this.getAllAnimatablesByTarget(f),_=0,m=p;_<m.length;_++){var l=m[_];l.stop(d,g)}},O.a.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(var f=0;f<this._activeAnimatables.length;f++)this._activeAnimatables[f].stop();this._activeAnimatables=[]}for(var d=0,g=this.animationGroups;d<g.length;d++){var p=g[d];p.stop()}},O.a.prototype._registerTargetForLateAnimationBinding=function(f,d){var g=f.target;this._registeredForLateAnimationBindings.pushNoDuplicate(g),g._lateAnimationHolders||(g._lateAnimationHolders={}),g._lateAnimationHolders[f.targetPath]||(g._lateAnimationHolders[f.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:d}),f.isAdditive?(g._lateAnimationHolders[f.targetPath].additiveAnimations.push(f),g._lateAnimationHolders[f.targetPath].totalAdditiveWeight+=f.weight):(g._lateAnimationHolders[f.targetPath].animations.push(f),g._lateAnimationHolders[f.targetPath].totalWeight+=f.weight)},O.a.prototype._processLateAnimationBindingsForMatrices=function(f){if(f.totalWeight===0&&f.totalAdditiveWeight===0)return f.originalValue;var d=1,g=x.c.Vector3[0],p=x.c.Vector3[1],_=x.c.Quaternion[0],m=0,l=f.animations[0],y=f.originalValue,E=1,A=!1;if(f.totalWeight<1)E=1-f.totalWeight,y.decompose(p,_,g);else{if(m=1,d=f.totalWeight,E=l.weight/d,E==1)if(f.totalAdditiveWeight)A=!0;else return l.currentValue;l.currentValue.decompose(p,_,g)}if(!A){p.scaleInPlace(E),g.scaleInPlace(E),_.scaleInPlace(E);for(var F=m;F<f.animations.length;F++){var B=f.animations[F];if(B.weight!==0){var E=B.weight/d,L=x.c.Vector3[2],I=x.c.Vector3[3],z=x.c.Quaternion[1];B.currentValue.decompose(I,z,L),I.scaleAndAddToRef(E,p),z.scaleAndAddToRef(E,_),L.scaleAndAddToRef(E,g)}}}for(var k=0;k<f.additiveAnimations.length;k++){var B=f.additiveAnimations[k];if(B.weight!==0){var L=x.c.Vector3[2],I=x.c.Vector3[3],z=x.c.Quaternion[1];B.currentValue.decompose(I,z,L),I.multiplyToRef(p,I),x.e.LerpToRef(p,I,B.weight,p),_.multiplyToRef(z,z),x.b.SlerpToRef(_,z,B.weight,_),L.scaleAndAddToRef(B.weight,g)}}var j=l?l._animationState.workValue:x.c.Matrix[0].clone();return x.a.ComposeToRef(p,_,g,j),j},O.a.prototype._processLateAnimationBindingsForQuaternions=function(f,d){if(f.totalWeight===0&&f.totalAdditiveWeight===0)return d;var g=f.animations[0],p=f.originalValue,_=d;if(f.totalWeight===0&&f.totalAdditiveWeight>0)_.copyFrom(p);else if(f.animations.length===1){if(x.b.SlerpToRef(p,g.currentValue,Math.min(1,f.totalWeight),_),f.totalAdditiveWeight===0)return _}else if(f.animations.length>1){var m=1,l=void 0,y=void 0;if(f.totalWeight<1){var E=1-f.totalWeight;l=[],y=[],l.push(p),y.push(E)}else{if(f.animations.length===2&&(x.b.SlerpToRef(f.animations[0].currentValue,f.animations[1].currentValue,f.animations[1].weight/f.totalWeight,d),f.totalAdditiveWeight===0))return d;l=[],y=[],m=f.totalWeight}for(var A=0;A<f.animations.length;A++){var F=f.animations[A];l.push(F.currentValue),y.push(F.weight/m)}for(var B=0,L=0;L<l.length;){if(!L){x.b.SlerpToRef(l[L],l[L+1],y[L+1]/(y[L]+y[L+1]),d),_=d,B=y[L]+y[L+1],L+=2;continue}B+=y[L],x.b.SlerpToRef(_,l[L],y[L]/B,_),L++}}for(var I=0;I<f.additiveAnimations.length;I++){var F=f.additiveAnimations[I];F.weight!==0&&(_.multiplyToRef(F.currentValue,x.c.Quaternion[0]),x.b.SlerpToRef(_,x.c.Quaternion[0],F.weight,_))}return _},O.a.prototype._processLateAnimationBindings=function(){if(!!this._registeredForLateAnimationBindings.length){for(var f=0;f<this._registeredForLateAnimationBindings.length;f++){var d=this._registeredForLateAnimationBindings.data[f];for(var g in d._lateAnimationHolders){var p=d._lateAnimationHolders[g],_=p.animations[0],m=p.originalValue,l=S.a.AllowMatrixDecomposeForInterpolation&&m.m,y=d[g];if(l)y=this._processLateAnimationBindingsForMatrices(p);else{var E=m.w!==void 0;if(E)y=this._processLateAnimationBindingsForQuaternions(p,y||x.b.Identity());else{var A=0,F=1;if(p.totalWeight<1)_&&m.scale?y=m.scale(1-p.totalWeight):_?y=m*(1-p.totalWeight):m.clone?y=m.clone():y=m;else if(_){F=p.totalWeight;var B=_.weight/F;B!==1?_.currentValue.scale?y=_.currentValue.scale(B):y=_.currentValue*B:y=_.currentValue,A=1}for(var L=A;L<p.animations.length;L++){var I=p.animations[L],z=I.weight/F;if(z)I.currentValue.scaleAndAddToRef?I.currentValue.scaleAndAddToRef(z,y):y+=I.currentValue*z;else continue}for(var k=0;k<p.additiveAnimations.length;k++){var I=p.additiveAnimations[k],z=I.weight;if(z)I.currentValue.scaleAndAddToRef?I.currentValue.scaleAndAddToRef(z,y):y+=I.currentValue*z;else continue}}}d[g]=y}d._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},T.a.prototype.copyAnimationRange=function(f,d,g,p,_){p===void 0&&(p=!1),_===void 0&&(_=null),this.animations.length===0&&(this.animations.push(new S.a(this.name,"_matrix",f.animations[0].framePerSecond,S.a.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));var m=f.animations[0].getRange(d);if(!m)return!1;for(var l=m.from,y=m.to,E=f.animations[0].getKeys(),A=f.length,F=f.getParent(),B=this.getParent(),L=p&&F&&A&&this.length&&A!==this.length,I=L&&B&&F?B.length/F.length:1,z=p&&!B&&_&&(_.x!==1||_.y!==1||_.z!==1),k=this.animations[0].getKeys(),j,w,Q,W=0,Y=E.length;W<Y;W++)j=E[W],j.frame>=l&&j.frame<=y&&(p?(Q=j.value.clone(),L?(w=Q.getTranslation(),Q.setTranslation(w.scaleInPlace(I))):z&&_?(w=Q.getTranslation(),Q.setTranslation(w.multiplyInPlace(_))):Q=j.value):Q=j.value,k.push({frame:j.frame+g,value:Q}));return this.animations[0].createRange(d,l+g,y+g),!0}},531:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(460),U=u(640),O=u(641),x=u(642),G=u(643),T=function(h){Object(S.d)(f,h);function f(d){var g=h.call(this,d)||this;return g._mouseInput=null,g._mouseWheelInput=null,g}return f.prototype.addKeyboard=function(){return this.add(new U.a),this},f.prototype.addMouse=function(d){return d===void 0&&(d=!0),this._mouseInput||(this._mouseInput=new O.a(d),this.add(this._mouseInput)),this},f.prototype.removeMouse=function(){return this._mouseInput&&this.remove(this._mouseInput),this},f.prototype.addMouseWheel=function(){return this._mouseWheelInput||(this._mouseWheelInput=new x.a,this.add(this._mouseWheelInput)),this},f.prototype.removeMouseWheel=function(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this},f.prototype.addTouch=function(){return this.add(new G.a),this},f.prototype.clear=function(){h.prototype.clear.call(this),this._mouseInput=null},f}(R.b)},532:function(we,P,u){"use strict";var S=u(467),R=u(456);S.a.prototype.createDynamicTexture=function(U,O,x,G){var T=new R.a(this,R.b.Dynamic);return T.baseWidth=U,T.baseHeight=O,x&&(U=this.needPOTTextures?S.a.GetExponentOfTwo(U,this._caps.maxTextureSize):U,O=this.needPOTTextures?S.a.GetExponentOfTwo(O,this._caps.maxTextureSize):O),T.width=U,T.height=O,T.isReady=!1,T.generateMipMaps=x,T.samplingMode=G,this.updateTextureSamplingMode(G,T),this._internalTexturesCache.push(T),T},S.a.prototype.updateDynamicTexture=function(U,O,x,G,T,h){if(G===void 0&&(G=!1),h===void 0&&(h=!1),!!U){var f=this._gl,d=f.TEXTURE_2D,g=this._bindTextureDirectly(d,U,!0,h);this._unpackFlipY(x===void 0?U.invertY:x),G&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);var p=this._getWebGLTextureType(U.type),_=this._getInternalFormat(T||U.format),m=this._getRGBABufferInternalSizedFormat(U.type,_);f.texImage2D(d,0,m,_,p,O),U.generateMipMaps&&f.generateMipmap(d),g||this._bindTextureDirectly(d,null),G&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),U.isReady=!0}}},533:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(439),U=u(514),O=u(441),x=u(529),G=u(437),T=function(h){Object(S.d)(f,h);function f(d,g){var p=h.call(this,d,g)||this;return p.directIntensity=1,p.emissiveIntensity=1,p.environmentIntensity=1,p.specularIntensity=1,p.disableBumpMap=!1,p.ambientTextureStrength=1,p.ambientTextureImpactOnAnalyticalLights=f.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,p.metallicF0Factor=1,p.metallicReflectanceColor=O.a.White(),p.ambientColor=new O.a(0,0,0),p.albedoColor=new O.a(1,1,1),p.reflectivityColor=new O.a(1,1,1),p.reflectionColor=new O.a(1,1,1),p.emissiveColor=new O.a(0,0,0),p.microSurface=1,p.useLightmapAsShadowmap=!1,p.useAlphaFromAlbedoTexture=!1,p.forceAlphaTest=!1,p.alphaCutOff=.4,p.useSpecularOverAlpha=!0,p.useMicroSurfaceFromReflectivityMapAlpha=!1,p.useRoughnessFromMetallicTextureAlpha=!0,p.useRoughnessFromMetallicTextureGreen=!1,p.useMetallnessFromMetallicTextureBlue=!1,p.useAmbientOcclusionFromMetallicTextureRed=!1,p.useAmbientInGrayScale=!1,p.useAutoMicroSurfaceFromReflectivityMap=!1,p.useRadianceOverAlpha=!0,p.useObjectSpaceNormalMap=!1,p.useParallax=!1,p.useParallaxOcclusion=!1,p.parallaxScaleBias=.05,p.disableLighting=!1,p.forceIrradianceInFragment=!1,p.maxSimultaneousLights=4,p.invertNormalMapX=!1,p.invertNormalMapY=!1,p.twoSidedLighting=!1,p.useAlphaFresnel=!1,p.useLinearAlphaFresnel=!1,p.environmentBRDFTexture=null,p.forceNormalForward=!1,p.enableSpecularAntiAliasing=!1,p.useHorizonOcclusion=!0,p.useRadianceOcclusion=!0,p.unlit=!1,p._environmentBRDFTexture=U.a.GetEnvironmentBRDFTexture(g),p}return Object.defineProperty(f.prototype,"refractionTexture",{get:function(){return this.subSurface.refractionTexture},set:function(d){this.subSurface.refractionTexture=d,d?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"indexOfRefraction",{get:function(){return this.subSurface.indexOfRefraction},set:function(d){this.subSurface.indexOfRefraction=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"invertRefractionY",{get:function(){return this.subSurface.invertRefractionY},set:function(d){this.subSurface.invertRefractionY=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"linkRefractionWithTransparency",{get:function(){return this.subSurface.linkRefractionWithTransparency},set:function(d){this.subSurface.linkRefractionWithTransparency=d,d&&(this.subSurface.isRefractionEnabled=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"usePhysicalLightFalloff",{get:function(){return this._lightFalloff===x.a.LIGHTFALLOFF_PHYSICAL},set:function(d){d!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),d?this._lightFalloff=x.a.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=x.a.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"useGLTFLightFalloff",{get:function(){return this._lightFalloff===x.a.LIGHTFALLOFF_GLTF},set:function(d){d!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),d?this._lightFalloff=x.a.LIGHTFALLOFF_GLTF:this._lightFalloff=x.a.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(d){this._attachImageProcessingConfiguration(d),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(d){this.imageProcessingConfiguration.colorCurvesEnabled=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(d){this.imageProcessingConfiguration.colorGradingEnabled=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(d){this._imageProcessingConfiguration.toneMappingEnabled=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(d){this._imageProcessingConfiguration.exposure=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(d){this._imageProcessingConfiguration.contrast=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(d){this._imageProcessingConfiguration.colorGradingTexture=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(d){this._imageProcessingConfiguration.colorCurves=d},enumerable:!1,configurable:!0}),f.prototype.getClassName=function(){return"PBRMaterial"},f.prototype.clone=function(d){var g=this,p=R.a.Clone(function(){return new f(d,g.getScene())},this);return p.id=d,p.name=d,this.clearCoat.copyTo(p.clearCoat),this.anisotropy.copyTo(p.anisotropy),this.brdf.copyTo(p.brdf),this.sheen.copyTo(p.sheen),this.subSurface.copyTo(p.subSurface),p},f.prototype.serialize=function(){var d=R.a.Serialize(this);return d.customType="BABYLON.PBRMaterial",d.clearCoat=this.clearCoat.serialize(),d.anisotropy=this.anisotropy.serialize(),d.brdf=this.brdf.serialize(),d.sheen=this.sheen.serialize(),d.subSurface=this.subSurface.serialize(),d},f.Parse=function(d,g,p){var _=R.a.Parse(function(){return new f(d.name,g)},d,g,p);return d.clearCoat&&_.clearCoat.parse(d.clearCoat,g,p),d.anisotropy&&_.anisotropy.parse(d.anisotropy,g,p),d.brdf&&_.brdf.parse(d.brdf,g,p),d.sheen&&_.sheen.parse(d.sheen,g,p),d.subSurface&&_.subSurface.parse(d.subSurface,g,p),_},f.PBRMATERIAL_OPAQUE=x.a.PBRMATERIAL_OPAQUE,f.PBRMATERIAL_ALPHATEST=x.a.PBRMATERIAL_ALPHATEST,f.PBRMATERIAL_ALPHABLEND=x.a.PBRMATERIAL_ALPHABLEND,f.PBRMATERIAL_ALPHATESTANDBLEND=x.a.PBRMATERIAL_ALPHATESTANDBLEND,f.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=x.a.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"directIntensity",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"emissiveIntensity",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"environmentIntensity",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"specularIntensity",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"disableBumpMap",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"albedoTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"ambientTexture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"ambientTextureStrength",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesAndMiscDirty")],f.prototype,"opacityTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"reflectionTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"emissiveTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"reflectivityTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallicTexture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallic",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"roughness",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallicF0Factor",void 0),Object(S.c)([Object(R.e)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallicReflectanceColor",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallicReflectanceTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"microSurfaceTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"bumpTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty",null)],f.prototype,"lightmapTexture",void 0),Object(S.c)([Object(R.e)("ambient"),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"ambientColor",void 0),Object(S.c)([Object(R.e)("albedo"),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"albedoColor",void 0),Object(S.c)([Object(R.e)("reflectivity"),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"reflectivityColor",void 0),Object(S.c)([Object(R.e)("reflection"),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"reflectionColor",void 0),Object(S.c)([Object(R.e)("emissive"),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"emissiveColor",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"microSurface",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useLightmapAsShadowmap",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesAndMiscDirty")],f.prototype,"useAlphaFromAlbedoTexture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesAndMiscDirty")],f.prototype,"forceAlphaTest",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesAndMiscDirty")],f.prototype,"alphaCutOff",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useSpecularOverAlpha",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useRoughnessFromMetallicTextureGreen",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useMetallnessFromMetallicTextureBlue",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useAmbientInGrayScale",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),Object(S.c)([Object(R.c)()],f.prototype,"usePhysicalLightFalloff",null),Object(S.c)([Object(R.c)()],f.prototype,"useGLTFLightFalloff",null),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useRadianceOverAlpha",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useObjectSpaceNormalMap",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useParallax",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useParallaxOcclusion",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"parallaxScaleBias",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsLightsDirty")],f.prototype,"disableLighting",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"forceIrradianceInFragment",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsLightsDirty")],f.prototype,"maxSimultaneousLights",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"invertNormalMapX",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"invertNormalMapY",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"twoSidedLighting",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useAlphaFresnel",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useLinearAlphaFresnel",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"environmentBRDFTexture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"forceNormalForward",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"enableSpecularAntiAliasing",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useHorizonOcclusion",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useRadianceOcclusion",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsMiscDirty")],f.prototype,"unlit",void 0),f}(x.a);G.a.RegisteredTypes["BABYLON.PBRMaterial"]=T},534:function(we,P,u){"use strict";var S=u(435),R="postprocessVertexShader",U=`
attribute vec2 position;
uniform vec2 scale;

varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vUV=(position*madd+madd)*scale;
gl_Position=vec4(position,0.0,1.0);
}`;S.a.ShadersStore[R]=U;var O={name:R,shader:U}},535:function(we,P,u){"use strict";var S=u(435),R="packingFunctions",U=`vec4 pack(float depth)
{
const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);
const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);
vec4 res=fract(depth*bit_shift);
res-=res.xxyz*bit_mask;
return res;
}
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}`;S.a.IncludesShadersStore[R]=U;var O={name:R,shader:U}},537:function(we,P,u){"use strict";u.d(P,"a",function(){return G});var S=u(434),R=u(439),U=u(436),O=u(484),x=u(465),G=function(T){Object(S.d)(h,T);function h(){var f=T!==null&&T.apply(this,arguments)||this;return f._needProjectionMatrixCompute=!0,f}return h.prototype._setPosition=function(f){this._position=f},Object.defineProperty(h.prototype,"position",{get:function(){return this._position},set:function(f){this._setPosition(f)},enumerable:!1,configurable:!0}),h.prototype._setDirection=function(f){this._direction=f},Object.defineProperty(h.prototype,"direction",{get:function(){return this._direction},set:function(f){this._setDirection(f)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"shadowMinZ",{get:function(){return this._shadowMinZ},set:function(f){this._shadowMinZ=f,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"shadowMaxZ",{get:function(){return this._shadowMaxZ},set:function(f){this._shadowMaxZ=f,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),h.prototype.computeTransformedInformation=function(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=U.e.Zero()),U.e.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=U.e.Zero()),U.e.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1},h.prototype.getDepthScale=function(){return 50},h.prototype.getShadowDirection=function(f){return this.transformedDirection?this.transformedDirection:this.direction},h.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},h.prototype.setDirectionToTarget=function(f){return this.direction=U.e.Normalize(f.subtract(this.position)),this.direction},h.prototype.getRotation=function(){this.direction.normalize();var f=U.e.Cross(this.direction,x.a.Y),d=U.e.Cross(f,this.direction);return U.e.RotationFromAxis(f,d,this.direction)},h.prototype.needCube=function(){return!1},h.prototype.needProjectionMatrixCompute=function(){return this._needProjectionMatrixCompute},h.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=!0},h.prototype._initCache=function(){T.prototype._initCache.call(this),this._cache.position=U.e.Zero()},h.prototype._isSynchronized=function(){return!!this._cache.position.equals(this.position)},h.prototype.computeWorldMatrix=function(f){return!f&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=U.a.Identity()),U.a.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)},h.prototype.getDepthMinZ=function(f){return this.shadowMinZ!==void 0?this.shadowMinZ:f.minZ},h.prototype.getDepthMaxZ=function(f){return this.shadowMaxZ!==void 0?this.shadowMaxZ:f.maxZ},h.prototype.setShadowProjectionMatrix=function(f,d,g){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(d,g,f):this._setDefaultShadowProjectionMatrix(f,d,g),this},Object(S.c)([Object(R.o)()],h.prototype,"position",null),Object(S.c)([Object(R.o)()],h.prototype,"direction",null),Object(S.c)([Object(R.c)()],h.prototype,"shadowMinZ",null),Object(S.c)([Object(R.c)()],h.prototype,"shadowMaxZ",null),h}(O.a)},538:function(we,P,u){"use strict";u.d(P,"a",function(){return x});var S=u(434),R=u(442),U=u(458),O=u(574),x=function(G){Object(S.d)(T,G);function T(h,f,d,g,p){var _=this,m=p&&p.generateMipMaps?p.generateMipMaps:!1,l=p&&p.generateDepthTexture?p.generateDepthTexture:!1,y=!p||p.doNotChangeAspectRatio===void 0?!0:p.doNotChangeAspectRatio,E=p&&p.drawOnlyOnFirstAttachmentByDefault?p.drawOnlyOnFirstAttachmentByDefault:!1;if(_=G.call(this,h,f,g,m,y,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0)||this,!_.isSupported){_.dispose();return}var A=[],F=[];_._initTypes(d,A,F,p);var B=!p||p.generateDepthBuffer===void 0?!0:p.generateDepthBuffer,L=!p||p.generateStencilBuffer===void 0?!1:p.generateStencilBuffer;return _._size=f,_._multiRenderTargetOptions={samplingModes:F,generateMipMaps:m,generateDepthBuffer:B,generateStencilBuffer:L,generateDepthTexture:l,types:A,textureCount:d},_._count=d,_._drawOnlyOnFirstAttachmentByDefault=E,d>0&&(_._createInternalTextures(),_._createTextures()),_}return Object.defineProperty(T.prototype,"isSupported",{get:function(){var h,f;return(f=(h=this._engine)===null||h===void 0?void 0:h.getCaps().drawBuffersExtension)!==null&&f!==void 0?f:!1},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"textures",{get:function(){return this._textures},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"depthTexture",{get:function(){return this._textures[this._textures.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"wrapU",{set:function(h){if(this._textures)for(var f=0;f<this._textures.length;f++)this._textures[f].wrapU=h},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"wrapV",{set:function(h){if(this._textures)for(var f=0;f<this._textures.length;f++)this._textures[f].wrapV=h},enumerable:!1,configurable:!0}),T.prototype._initTypes=function(h,f,d,g){for(var p=0;p<h;p++)g&&g.types&&g.types[p]!==void 0?f.push(g.types[p]):f.push(g&&g.defaultType?g.defaultType:0),g&&g.samplingModes&&g.samplingModes[p]!==void 0?d.push(g.samplingModes[p]):d.push(R.a.BILINEAR_SAMPLINGMODE)},T.prototype._rebuild=function(h){if(h===void 0&&(h=!1),!(this._count<1)){this.releaseInternalTextures(),this._createInternalTextures(),h&&this._createTextures();for(var f=0;f<this._internalTextures.length;f++){var d=this._textures[f];d._texture=this._internalTextures[f]}this.samples!==1&&this._getEngine().updateMultipleRenderTargetTextureSampleCount(this._internalTextures,this.samples,!this._drawOnlyOnFirstAttachmentByDefault)}},T.prototype._createInternalTextures=function(){this._internalTextures=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._internalTextures[0]},T.prototype._createTextures=function(){this._textures=[];for(var h=0;h<this._internalTextures.length;h++){var f=new R.a(null,this.getScene());f._texture=this._internalTextures[h],this._textures.push(f)}},T.prototype.replaceTexture=function(h,f){h._texture&&(this._textures[f]=h,this._internalTextures[f]=h._texture,f===0&&(this._texture=this._internalTextures[f]))},Object.defineProperty(T.prototype,"samples",{get:function(){return this._samples},set:function(h){this._samples!==h&&(this._internalTextures?this._samples=this._getEngine().updateMultipleRenderTargetTextureSampleCount(this._internalTextures,h):this._samples=h)},enumerable:!1,configurable:!0}),T.prototype.resize=function(h){this._size=h,this._rebuild()},T.prototype.updateCount=function(h,f){this._multiRenderTargetOptions.textureCount=h,this._count=h;var d=[],g=[];this._initTypes(h,d,g,f),this._multiRenderTargetOptions.types=d,this._multiRenderTargetOptions.samplingModes=g,this._rebuild(!0)},T.prototype.unbindFrameBuffer=function(h,f){var d=this;h.unBindMultiColorAttachmentFramebuffer(this._internalTextures,this.isCube,function(){d.onAfterRenderObservable.notifyObservers(f)})},T.prototype.dispose=function(){this.releaseInternalTextures(),G.prototype.dispose.call(this)},T.prototype.releaseInternalTextures=function(){if(!!this._internalTextures)for(var h=this._internalTextures.length-1;h>=0;h--)this._internalTextures[h]!==void 0&&(this._internalTextures[h].dispose(),this._internalTextures.splice(h,1))},T}(U.a)},540:function(we,P,u){"use strict";u.d(P,"b",function(){return x}),u.d(P,"a",function(){return G});var S=u(483),R=u(438),U=u(448),O=u(530),x=function(){function T(){}return T.prototype.getClassName=function(){return"TargetedAnimation"},T.prototype.serialize=function(){var h={};return h.animation=this.animation.serialize(),h.targetId=this.target.id,h},T}(),G=function(){function T(h,f){f===void 0&&(f=null),this.name=h,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this.onAnimationEndObservable=new R.c,this.onAnimationLoopObservable=new R.c,this.onAnimationGroupLoopObservable=new R.c,this.onAnimationGroupEndObservable=new R.c,this.onAnimationGroupPauseObservable=new R.c,this.onAnimationGroupPlayObservable=new R.c,this._scene=f||U.a.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}return Object.defineProperty(T.prototype,"from",{get:function(){return this._from},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"to",{get:function(){return this._to},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"isStarted",{get:function(){return this._isStarted},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"isPlaying",{get:function(){return this._isStarted&&!this._isPaused},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(h){if(this._speedRatio!==h){this._speedRatio=h;for(var f=0;f<this._animatables.length;f++){var d=this._animatables[f];d.speedRatio=this._speedRatio}}},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"loopAnimation",{get:function(){return this._loopAnimation},set:function(h){if(this._loopAnimation!==h){this._loopAnimation=h;for(var f=0;f<this._animatables.length;f++){var d=this._animatables[f];d.loopAnimation=this._loopAnimation}}},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"isAdditive",{get:function(){return this._isAdditive},set:function(h){if(this._isAdditive!==h){this._isAdditive=h;for(var f=0;f<this._animatables.length;f++){var d=this._animatables[f];d.isAdditive=this._isAdditive}}},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"targetedAnimations",{get:function(){return this._targetedAnimations},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"animatables",{get:function(){return this._animatables},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"children",{get:function(){return this._targetedAnimations},enumerable:!1,configurable:!0}),T.prototype.addTargetedAnimation=function(h,f){var d=new x;d.animation=h,d.target=f;var g=h.getKeys();return this._from>g[0].frame&&(this._from=g[0].frame),this._to<g[g.length-1].frame&&(this._to=g[g.length-1].frame),this._targetedAnimations.push(d),d},T.prototype.normalize=function(h,f){h===void 0&&(h=null),f===void 0&&(f=null),h==null&&(h=this._from),f==null&&(f=this._to);for(var d=0;d<this._targetedAnimations.length;d++){var g=this._targetedAnimations[d],p=g.animation.getKeys(),_=p[0],m=p[p.length-1];if(_.frame>h){var l={frame:h,value:_.value,inTangent:_.inTangent,outTangent:_.outTangent,interpolation:_.interpolation};p.splice(0,0,l)}if(m.frame<f){var l={frame:f,value:m.value,inTangent:m.inTangent,outTangent:m.outTangent,interpolation:m.interpolation};p.push(l)}}return this._from=h,this._to=f,this},T.prototype._processLoop=function(h,f,d){var g=this;h.onAnimationLoop=function(){g.onAnimationLoopObservable.notifyObservers(f),!g._animationLoopFlags[d]&&(g._animationLoopFlags[d]=!0,g._animationLoopCount++,g._animationLoopCount===g._targetedAnimations.length&&(g.onAnimationGroupLoopObservable.notifyObservers(g),g._animationLoopCount=0,g._animationLoopFlags=[]))}},T.prototype.start=function(h,f,d,g,p){var _=this;if(h===void 0&&(h=!1),f===void 0&&(f=1),this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=h,this._animationLoopCount=0,this._animationLoopFlags=[];for(var m=function(){var A=l._targetedAnimations[y],F=l._scene.beginDirectAnimation(A.target,[A.animation],d!==void 0?d:l._from,g!==void 0?g:l._to,h,f,void 0,void 0,p!==void 0?p:l._isAdditive);F.onAnimationEnd=function(){_.onAnimationEndObservable.notifyObservers(A),_._checkAnimationGroupEnded(F)},l._processLoop(F,A,y),l._animatables.push(F)},l=this,y=0;y<this._targetedAnimations.length;y++)m();if(this._speedRatio=f,d!==void 0&&g!==void 0)if(d<g&&this._speedRatio<0){var E=g;g=d,d=E}else d>g&&this._speedRatio>0&&(this._speedRatio=-f);return this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this},T.prototype.pause=function(){if(!this._isStarted)return this;this._isPaused=!0;for(var h=0;h<this._animatables.length;h++){var f=this._animatables[h];f.pause()}return this.onAnimationGroupPauseObservable.notifyObservers(this),this},T.prototype.play=function(h){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(h!==void 0&&(this.loopAnimation=h),this.restart()):(this.stop(),this.start(h,this._speedRatio)),this._isPaused=!1,this},T.prototype.reset=function(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(var h=0;h<this._animatables.length;h++){var f=this._animatables[h];f.reset()}return this},T.prototype.restart=function(){if(!this._isStarted)return this;for(var h=0;h<this._animatables.length;h++){var f=this._animatables[h];f.restart()}return this.onAnimationGroupPlayObservable.notifyObservers(this),this},T.prototype.stop=function(){if(!this._isStarted)return this;for(var h=this._animatables.slice(),f=0;f<h.length;f++)h[f].stop();return this._isStarted=!1,this},T.prototype.setWeightForAllAnimatables=function(h){for(var f=0;f<this._animatables.length;f++){var d=this._animatables[f];d.weight=h}return this},T.prototype.syncAllAnimationsWith=function(h){for(var f=0;f<this._animatables.length;f++){var d=this._animatables[f];d.syncWith(h)}return this},T.prototype.goToFrame=function(h){if(!this._isStarted)return this;for(var f=0;f<this._animatables.length;f++){var d=this._animatables[f];d.goToFrame(h)}return this},T.prototype.dispose=function(){this._targetedAnimations=[],this._animatables=[];var h=this._scene.animationGroups.indexOf(this);h>-1&&this._scene.animationGroups.splice(h,1),this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()},T.prototype._checkAnimationGroupEnded=function(h){var f=this._animatables.indexOf(h);f>-1&&this._animatables.splice(f,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))},T.prototype.clone=function(h,f){for(var d=new T(h||this.name,this._scene),g=0,p=this._targetedAnimations;g<p.length;g++){var _=p[g];d.addTargetedAnimation(_.animation.clone(),f?f(_.target):_.target)}return d},T.prototype.serialize=function(){var h={};h.name=this.name,h.from=this.from,h.to=this.to,h.targetedAnimations=[];for(var f=0;f<this.targetedAnimations.length;f++){var d=this.targetedAnimations[f];h.targetedAnimations[f]=d.serialize()}return h},T.Parse=function(h,f){for(var d=new T(h.name,f),g=0;g<h.targetedAnimations.length;g++){var p=h.targetedAnimations[g],_=S.a.Parse(p.animation),m=p.targetId;if(p.animation.property==="influence"){var l=f.getMorphTargetById(m);l&&d.addTargetedAnimation(_,l)}else{var y=f.getNodeByID(m);y!=null&&d.addTargetedAnimation(_,y)}}return h.from!==null&&h.to!==null&&d.normalize(h.from,h.to),d},T.MakeAnimationAdditive=function(h,f,d,g,p){f===void 0&&(f=0),g===void 0&&(g=!1);var _=h;g&&(_=h.clone(p||_.name));for(var m=_.targetedAnimations,l=0;l<m.length;l++){var y=m[l];S.a.MakeAnimationAdditive(y.animation,f,d)}return _.isAdditive=!0,_},T.prototype.getClassName=function(){return"AnimationGroup"},T.prototype.toString=function(h){var f="Name: "+this.name;return f+=", type: "+this.getClassName(),h&&(f+=", from: "+this._from,f+=", to: "+this._to,f+=", isStarted: "+this._isStarted,f+=", speedRatio: "+this._speedRatio,f+=", targetedAnimations length: "+this._targetedAnimations.length,f+=", animatables length: "+this._animatables),f},T}()},541:function(we,P,u){"use strict";u.d(P,"a",function(){return k});var S=u(434),R=u(436),U=u(441),O=u(447),x=u(484),G=u(454),T=u(442),h=u(458),f=u(444),d=u(472),g=u(679),p=u(680),_=u(676),m=u(435),l="shadowMapFragmentSoftTransparentShadow",y=`#if SM_SOFTTRANSPARENTSHADOW == 1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;m.a.IncludesShadersStore[l]=y;var E={name:l,shader:y},A=u(438),F=u(476),B=u(512),L=u(591),I=new R.a,z=new R.a,k=function(){function j(w,Q,W){this.onBeforeShadowMapRenderObservable=new A.c,this.onAfterShadowMapRenderObservable=new A.c,this.onBeforeShadowMapRenderMeshObservable=new A.c,this.onAfterShadowMapRenderMeshObservable=new A.c,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=j.FILTER_NONE,this._filteringQuality=j.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=R.e.Zero(),this._viewMatrix=R.a.Zero(),this._projectionMatrix=R.a.Zero(),this._transformMatrix=R.a.Zero(),this._cachedPosition=new R.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new R.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=R.a.Identity(),this._mapSize=w,this._light=Q,this._scene=Q.getScene(),Q._shadowGenerator=this,this.id=Q.id,this._nameForCustomEffect="bjs_shadowgenerator_"+j._Counter++,j._SceneComponentInitialization(this._scene);var Y=this._scene.getEngine().getCaps();W?Y.textureFloatRender&&Y.textureFloatLinearFiltering?this._textureType=1:Y.textureHalfFloatRender&&Y.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:Y.textureHalfFloatRender&&Y.textureHalfFloatLinearFiltering?this._textureType=2:Y.textureFloatRender&&Y.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}return Object.defineProperty(j.prototype,"bias",{get:function(){return this._bias},set:function(w){this._bias=w},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"normalBias",{get:function(){return this._normalBias},set:function(w){this._normalBias=w},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(w){this._blurBoxOffset!==w&&(this._blurBoxOffset=w,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"blurScale",{get:function(){return this._blurScale},set:function(w){this._blurScale!==w&&(this._blurScale=w,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"blurKernel",{get:function(){return this._blurKernel},set:function(w){this._blurKernel!==w&&(this._blurKernel=w,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"useKernelBlur",{get:function(){return this._useKernelBlur},set:function(w){this._useKernelBlur!==w&&(this._useKernelBlur=w,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"depthScale",{get:function(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()},set:function(w){this._depthScale=w},enumerable:!1,configurable:!0}),j.prototype._validateFilter=function(w){return w},Object.defineProperty(j.prototype,"filter",{get:function(){return this._filter},set:function(w){if(w=this._validateFilter(w),this._light.needCube()){if(w===j.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(w===j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(w===j.FILTER_PCF||w===j.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((w===j.FILTER_PCF||w===j.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==w&&(this._filter=w,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"usePoissonSampling",{get:function(){return this.filter===j.FILTER_POISSONSAMPLING},set:function(w){var Q=this._validateFilter(j.FILTER_POISSONSAMPLING);!w&&this.filter!==j.FILTER_POISSONSAMPLING||(this.filter=w?Q:j.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"useExponentialShadowMap",{get:function(){return this.filter===j.FILTER_EXPONENTIALSHADOWMAP},set:function(w){var Q=this._validateFilter(j.FILTER_EXPONENTIALSHADOWMAP);!w&&this.filter!==j.FILTER_EXPONENTIALSHADOWMAP||(this.filter=w?Q:j.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"useBlurExponentialShadowMap",{get:function(){return this.filter===j.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(w){var Q=this._validateFilter(j.FILTER_BLUREXPONENTIALSHADOWMAP);!w&&this.filter!==j.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=w?Q:j.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"useCloseExponentialShadowMap",{get:function(){return this.filter===j.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(w){var Q=this._validateFilter(j.FILTER_CLOSEEXPONENTIALSHADOWMAP);!w&&this.filter!==j.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=w?Q:j.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"useBlurCloseExponentialShadowMap",{get:function(){return this.filter===j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(w){var Q=this._validateFilter(j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!w&&this.filter!==j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=w?Q:j.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"usePercentageCloserFiltering",{get:function(){return this.filter===j.FILTER_PCF},set:function(w){var Q=this._validateFilter(j.FILTER_PCF);!w&&this.filter!==j.FILTER_PCF||(this.filter=w?Q:j.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"filteringQuality",{get:function(){return this._filteringQuality},set:function(w){this._filteringQuality!==w&&(this._filteringQuality=w,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"useContactHardeningShadow",{get:function(){return this.filter===j.FILTER_PCSS},set:function(w){var Q=this._validateFilter(j.FILTER_PCSS);!w&&this.filter!==j.FILTER_PCSS||(this.filter=w?Q:j.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"contactHardeningLightSizeUVRatio",{get:function(){return this._contactHardeningLightSizeUVRatio},set:function(w){this._contactHardeningLightSizeUVRatio=w},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"darkness",{get:function(){return this._darkness},set:function(w){this.setDarkness(w)},enumerable:!1,configurable:!0}),j.prototype.getDarkness=function(){return this._darkness},j.prototype.setDarkness=function(w){return w>=1?this._darkness=1:w<=0?this._darkness=0:this._darkness=w,this},Object.defineProperty(j.prototype,"transparencyShadow",{get:function(){return this._transparencyShadow},set:function(w){this.setTransparencyShadow(w)},enumerable:!1,configurable:!0}),j.prototype.setTransparencyShadow=function(w){return this._transparencyShadow=w,this},j.prototype.getShadowMap=function(){return this._shadowMap},j.prototype.getShadowMapForRendering=function(){return this._shadowMap2?this._shadowMap2:this._shadowMap},j.prototype.getClassName=function(){return j.CLASSNAME},j.prototype.addShadowCaster=function(w,Q){var W;return Q===void 0&&(Q=!0),this._shadowMap?(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.push(w),Q&&(W=this._shadowMap.renderList).push.apply(W,w.getChildMeshes()),this):this},j.prototype.removeShadowCaster=function(w,Q){if(Q===void 0&&(Q=!0),!this._shadowMap||!this._shadowMap.renderList)return this;var W=this._shadowMap.renderList.indexOf(w);if(W!==-1&&this._shadowMap.renderList.splice(W,1),Q)for(var Y=0,he=w.getChildren();Y<he.length;Y++){var le=he[Y];this.removeShadowCaster(le)}return this},j.prototype.getLight=function(){return this._light},Object.defineProperty(j.prototype,"mapSize",{get:function(){return this._mapSize},set:function(w){this._mapSize=w,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()},enumerable:!1,configurable:!0}),j.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()},j.prototype._createTargetRenderTexture=function(){this._scene.getEngine()._features.supportDepthStencilTexture?(this._shadowMap=new h.a(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(513,!0)):this._shadowMap=new h.a(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())},j.prototype._initializeShadowMap=function(){var w=this;if(this._createTargetRenderTexture(),this._shadowMap!==null){this._shadowMap.wrapU=T.a.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=T.a.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(T.a.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=function(le,J){return!0};var Q=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(function(){Q._debugPushGroup("shadow map generation for "+w._nameForCustomEffect,1)}),this._shadowMap.onBeforeRenderObservable.add(function(le){w._currentFaceIndex=le,w._filter===j.FILTER_PCF&&Q.setColorWrite(!1),w.getTransformMatrix(),w._scene.setTransformMatrix(w._viewMatrix,w._projectionMatrix)}),this._shadowMap.onAfterUnbindObservable.add(function(){if(w._scene.updateTransformMatrix(),w._filter===j.FILTER_PCF&&Q.setColorWrite(!0),!w.useBlurExponentialShadowMap&&!w.useBlurCloseExponentialShadowMap){Q._debugPopGroup(1);return}var le=w.getShadowMapForRendering();if(le){var J=le.getInternalTexture();w._scene.postProcessManager.directRender(w._blurPostProcesses,J,!0),Q.unBindFramebuffer(J,!0),Q._debugPopGroup(1)}});var W=new U.b(0,0,0,0),Y=new U.b(1,1,1,1);this._shadowMap.onClearObservable.add(function(le){w._filter===j.FILTER_PCF?le.clear(Y,!1,!0,!1):w.useExponentialShadowMap||w.useBlurExponentialShadowMap?le.clear(W,!0,!0,!1):le.clear(Y,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(function(le){w._storedUniqueId=w._shadowMap.uniqueId,w._mapSize=le.getRenderSize(),w._light._markMeshesAsLightDirty(),w.recreateShadowMap()});for(var he=L.b.MIN_RENDERINGGROUPS;he<L.b.MAX_RENDERINGGROUPS;he++)this._shadowMap.setRenderingAutoClearDepthStencil(he,!1)}},j.prototype._initializeBlurRTTAndPostProcesses=function(){var w=this,Q=this._scene.getEngine(),W=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new h.a(this._light.name+"_shadowMap2",W,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=T.a.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=T.a.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(T.a.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new d.a(this._light.name+"KernelBlurX",new R.d(1,0),this.blurKernel,1,null,T.a.BILINEAR_SAMPLINGMODE,Q,!1,this._textureType),this._kernelBlurXPostprocess.width=W,this._kernelBlurXPostprocess.height=W,this._kernelBlurXPostprocess.onApplyObservable.add(function(Y){Y.setTexture("textureSampler",w._shadowMap)}),this._kernelBlurYPostprocess=new d.a(this._light.name+"KernelBlurY",new R.d(0,1),this.blurKernel,1,null,T.a.BILINEAR_SAMPLINGMODE,Q,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new f.a(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,T.a.BILINEAR_SAMPLINGMODE,Q,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.onApplyObservable.add(function(Y){Y.setFloat2("screenSize",W,W),Y.setTexture("textureSampler",w._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])},j.prototype._renderForShadowMap=function(w,Q,W,Y){var he,le=this._scene.getEngine(),J=le.getColorWrite();if(Y.length){for(le.setColorWrite(!1),he=0;he<Y.length;he++)this._renderSubMeshForShadowMap(Y.data[he]);le.setColorWrite(J)}for(he=0;he<w.length;he++)this._renderSubMeshForShadowMap(w.data[he]);for(he=0;he<Q.length;he++)this._renderSubMeshForShadowMap(Q.data[he]);if(this._transparencyShadow)for(he=0;he<W.length;he++)this._renderSubMeshForShadowMap(W.data[he],!0);else for(he=0;he<W.length;he++)W.data[he].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1},j.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(w,Q,W,Y){var he,le,J,Re,Me,me;Q.setMatrix((he=W==null?void 0:W.viewProjection)!==null&&he!==void 0?he:"viewProjection",this.getTransformMatrix()),Q.setMatrix((le=W==null?void 0:W.view)!==null&&le!==void 0?le:"view",this._viewMatrix),Q.setMatrix((J=W==null?void 0:W.projection)!==null&&J!==void 0?J:"projection",this._projectionMatrix);var H=Y.getWorldMatrix();Q.setMatrix((Re=W==null?void 0:W.world)!==null&&Re!==void 0?Re:"world",H),H.multiplyToRef(this.getTransformMatrix(),I),Q.setMatrix((Me=W==null?void 0:W.worldViewProjection)!==null&&Me!==void 0?Me:"worldViewProjection",I),H.multiplyToRef(this._viewMatrix,z),Q.setMatrix((me=W==null?void 0:W.worldView)!==null&&me!==void 0?me:"worldView",z)},j.prototype._renderSubMeshForShadowMap=function(w,Q){var W;Q===void 0&&(Q=!1);var Y=w.getRenderingMesh(),he=w.getEffectiveMesh(),le=this._scene,J=le.getEngine(),Re=w.getMaterial();if(he._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!Re||w.verticesCount===0||w._renderId===le.getRenderId())){J.setState(Re.backFaceCulling);var Me=Y._getInstancesRenderList(w._id,!!w.getReplacementMesh());if(!Me.mustReturn){var me=J.getCaps().instancedArrays&&(Me.visibleInstances[w._id]!==null&&Me.visibleInstances[w._id]!==void 0||Y.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(w)))if(this.isReady(w,me,Q)){w._renderId=le.getRenderId();var H=Re.shadowDepthWrapper,q=(W=H==null?void 0:H.getEffect(w,this))!==null&&W!==void 0?W:w._getCustomEffect(this._nameForCustomEffect,!1).effect;if(J.enableEffect(q),Y._bind(w,q,Re.fillMode),this.getTransformMatrix(),q.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===x.a.LIGHTTYPEID_DIRECTIONALLIGHT?q.setVector3("lightDataSM",this._cachedDirection):q.setVector3("lightDataSM",this._cachedPosition),le.activeCamera&&q.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(le.activeCamera),this.getLight().getDepthMinZ(le.activeCamera)+this.getLight().getDepthMaxZ(le.activeCamera)),Q&&this.enableSoftTransparentShadow&&q.setFloat("softTransparentShadowSM",he.visibility*Re.alpha),H)w._effectOverride=q,H.standalone?H.baseMaterial.bindForSubMesh(he.getWorldMatrix(),Y,w):Re.bindForSubMesh(he.getWorldMatrix(),Y,w),w._effectOverride=null;else{if(q.setMatrix("viewProjection",this.getTransformMatrix()),Re&&Re.needAlphaTesting()){var _e=Re.getAlphaTestTexture();_e&&(q.setTexture("diffuseSampler",_e),q.setMatrix("diffuseMatrix",_e.getTextureMatrix()||this._defaultTextureMatrix))}if(Y.useBones&&Y.computeBonesUsingShaders&&Y.skeleton){var Ee=Y.skeleton;if(Ee.isUsingTextureForMatrices){var Te=Ee.getTransformMatrixTexture(Y);if(!Te)return;q.setTexture("boneSampler",Te),q.setFloat("boneTextureWidth",4*(Ee.bones.length+1))}else q.setMatrices("mBones",Ee.getTransformMatrices(Y))}G.a.BindMorphTargetParameters(Y,q),Y.morphTargetManager&&Y.morphTargetManager.isUsingTextureForTargets&&Y.morphTargetManager._bind(q),G.a.BindClipPlane(q,le)}this._bindCustomEffectForRenderSubMeshForShadowMap(w,q,H==null?void 0:H._matriceNames,he),this.forceBackFacesOnly&&J.setState(!0,0,!1,!0),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(Y),this.onBeforeShadowMapRenderObservable.notifyObservers(q),Y._processRendering(he,w,q,Re.fillMode,Me,me,function(se,ve){return q.setMatrix("world",ve)}),this.forceBackFacesOnly&&J.setState(!0,0,!1,!1),this.onAfterShadowMapRenderObservable.notifyObservers(q),this.onAfterShadowMapRenderMeshObservable.notifyObservers(Y)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}},j.prototype._applyFilterValues=function(){!this._shadowMap||(this.filter===j.FILTER_NONE||this.filter===j.FILTER_PCSS?this._shadowMap.updateSamplingMode(T.a.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(T.a.BILINEAR_SAMPLINGMODE))},j.prototype.forceCompilation=function(w,Q){var W=this,Y=Object(S.a)({useInstances:!1},Q),he=this.getShadowMap();if(!he){w&&w(this);return}var le=he.renderList;if(!le){w&&w(this);return}for(var J=new Array,Re=0,Me=le;Re<Me.length;Re++){var me=Me[Re];J.push.apply(J,me.subMeshes)}if(J.length===0){w&&w(this);return}var H=0,q=function(){var _e,Ee;if(!(!W._scene||!W._scene.getEngine())){for(;W.isReady(J[H],Y.useInstances,(Ee=(_e=J[H].getMaterial())===null||_e===void 0?void 0:_e.needAlphaBlendingForMesh(J[H].getMesh()))!==null&&Ee!==void 0?Ee:!1);)if(H++,H>=J.length){w&&w(W);return}setTimeout(q,16)}};q()},j.prototype.forceCompilationAsync=function(w){var Q=this;return new Promise(function(W){Q.forceCompilation(function(){W()},w)})},j.prototype._isReadyCustomDefines=function(w,Q,W){},j.prototype._prepareShadowDefines=function(w,Q,W,Y){W.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),W.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),W.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));var he=w.getMesh();return W.push("#define SM_NORMALBIAS "+(this.normalBias&&he.isVerticesDataPresent(O.b.NormalKind)?"1":"0")),W.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===x.a.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),W.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),W.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&Y?"1":"0")),this._isReadyCustomDefines(W,w,Q),W},j.prototype.isReady=function(w,Q,W){var Y=w.getMaterial(),he=Y==null?void 0:Y.shadowDepthWrapper,le=[];this._prepareShadowDefines(w,Q,le,W);var J=w._getCustomEffect(this._nameForCustomEffect),Re=J.effect,Me=J.defines;if(he){if(!he.isReadyForSubMesh(w,le,this,Q))return!1}else{var me=[O.b.PositionKind],H=w.getMesh();if(this.normalBias&&H.isVerticesDataPresent(O.b.NormalKind)&&(me.push(O.b.NormalKind),le.push("#define NORMAL"),H.nonUniformScaling&&le.push("#define NONUNIFORMSCALING")),Y&&Y.needAlphaTesting()){var q=Y.getAlphaTestTexture();if(q){if(!q.isReady())return!1;le.push("#define ALPHATEST"),H.isVerticesDataPresent(O.b.UVKind)&&(me.push(O.b.UVKind),le.push("#define UV1")),H.isVerticesDataPresent(O.b.UV2Kind)&&q.coordinatesIndex===1&&(me.push(O.b.UV2Kind),le.push("#define UV2"))}}var _e=new B.a;if(H.useBones&&H.computeBonesUsingShaders&&H.skeleton){me.push(O.b.MatricesIndicesKind),me.push(O.b.MatricesWeightsKind),H.numBoneInfluencers>4&&(me.push(O.b.MatricesIndicesExtraKind),me.push(O.b.MatricesWeightsExtraKind));var Ee=H.skeleton;le.push("#define NUM_BONE_INFLUENCERS "+H.numBoneInfluencers),H.numBoneInfluencers>0&&_e.addCPUSkinningFallback(0,H),Ee.isUsingTextureForMatrices?le.push("#define BONETEXTURE"):le.push("#define BonesPerMesh "+(Ee.bones.length+1))}else le.push("#define NUM_BONE_INFLUENCERS 0");var Te=H.morphTargetManager,se=0;Te&&Te.numInfluencers>0&&(le.push("#define MORPHTARGETS"),se=Te.numInfluencers,le.push("#define NUM_MORPH_INFLUENCERS "+se),Te.isUsingTextureForTargets&&le.push("#define MORPHTARGETS_TEXTURE"),G.a.PrepareAttributesForMorphTargetsInfluencers(me,H,se));var ve=this._scene;if(ve.clipPlane&&le.push("#define CLIPPLANE"),ve.clipPlane2&&le.push("#define CLIPPLANE2"),ve.clipPlane3&&le.push("#define CLIPPLANE3"),ve.clipPlane4&&le.push("#define CLIPPLANE4"),ve.clipPlane5&&le.push("#define CLIPPLANE5"),ve.clipPlane6&&le.push("#define CLIPPLANE6"),Q&&(le.push("#define INSTANCES"),G.a.PushAttributesForInstances(me),w.getRenderingMesh().hasThinInstances&&le.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(var ye=0,Le=this.customShaderOptions.defines;ye<Le.length;ye++){var be=Le[ye];le.indexOf(be)===-1&&le.push(be)}var ze=le.join(`
`);if(Me!==ze){Me=ze;var Ye="shadowMap",He=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],Ue=["diffuseSampler","boneSampler","morphTargets"];if(this.customShaderOptions){if(Ye=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(var re=0,Z=this.customShaderOptions.attributes;re<Z.length;re++){var fe=Z[re];me.indexOf(fe)===-1&&me.push(fe)}if(this.customShaderOptions.uniforms)for(var ue=0,Ge=this.customShaderOptions.uniforms;ue<Ge.length;ue++){var xe=Ge[ue];He.indexOf(xe)===-1&&He.push(xe)}if(this.customShaderOptions.samplers)for(var ne=0,Ke=this.customShaderOptions.samplers;ne<Ke.length;ne++){var nt=Ke[ne];Ue.indexOf(nt)===-1&&Ue.push(nt)}}var ut=this._scene.getEngine();Re=ut.createEffect(Ye,{attributes:me,uniformsNames:He,uniformBuffersNames:[],samplers:Ue,defines:ze,fallbacks:_e,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:se}},ut)}if(J.effect=Re,J.defines=Me,!Re.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())},j.prototype.prepareDefines=function(w,Q){var W=this._scene,Y=this._light;!W.shadowsEnabled||!Y.shadowEnabled||(w["SHADOW"+Q]=!0,this.useContactHardeningShadow?(w["SHADOWPCSS"+Q]=!0,this._filteringQuality===j.QUALITY_LOW?w["SHADOWLOWQUALITY"+Q]=!0:this._filteringQuality===j.QUALITY_MEDIUM&&(w["SHADOWMEDIUMQUALITY"+Q]=!0)):this.usePercentageCloserFiltering?(w["SHADOWPCF"+Q]=!0,this._filteringQuality===j.QUALITY_LOW?w["SHADOWLOWQUALITY"+Q]=!0:this._filteringQuality===j.QUALITY_MEDIUM&&(w["SHADOWMEDIUMQUALITY"+Q]=!0)):this.usePoissonSampling?w["SHADOWPOISSON"+Q]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?w["SHADOWESM"+Q]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(w["SHADOWCLOSEESM"+Q]=!0),Y.needCube()&&(w["SHADOWCUBE"+Q]=!0))},j.prototype.bindShadowLight=function(w,Q){var W=this._light,Y=this._scene;if(!(!Y.shadowsEnabled||!W.shadowEnabled)){var he=Y.activeCamera;if(!!he){var le=this.getShadowMap();!le||(W.needCube()||Q.setMatrix("lightMatrix"+w,this.getTransformMatrix()),this._filter===j.FILTER_PCF?(Q.setDepthStencilTexture("shadowSampler"+w,this.getShadowMapForRendering()),W._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),le.getSize().width,1/le.getSize().width,this.frustumEdgeFalloff,w)):this._filter===j.FILTER_PCSS?(Q.setDepthStencilTexture("shadowSampler"+w,this.getShadowMapForRendering()),Q.setTexture("depthSampler"+w,this.getShadowMapForRendering()),W._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/le.getSize().width,this._contactHardeningLightSizeUVRatio*le.getSize().width,this.frustumEdgeFalloff,w)):(Q.setTexture("shadowSampler"+w,this.getShadowMapForRendering()),W._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/le.getSize().width,this.depthScale,this.frustumEdgeFalloff,w)),W._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(he),this.getLight().getDepthMinZ(he)+this.getLight().getDepthMaxZ(he),w))}}},j.prototype.getTransformMatrix=function(){var w=this._scene;if(this._currentRenderID===w.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderID=w.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;var Q=this._light.position;if(this._light.computeTransformedInformation()&&(Q=this._light.transformedPosition),R.e.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(R.e.Dot(this._lightDirection,R.e.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!Q.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(Q),this._cachedDirection.copyFrom(this._lightDirection),R.a.LookAtLHToRef(Q,Q.add(this._lightDirection),R.e.Up(),this._viewMatrix);var W=this.getShadowMap();if(W){var Y=W.renderList;Y&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,Y)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},j.prototype.recreateShadowMap=function(){var w=this._shadowMap;if(!!w){var Q=w.renderList;this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this.filter,this._applyFilterValues(),this._shadowMap.renderList=Q}},j.prototype._disposeBlurPostProcesses=function(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]},j.prototype._disposeRTTandPostProcesses=function(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()},j.prototype.dispose=function(){this._disposeRTTandPostProcesses(),this._light&&(this._light._shadowGenerator=null,this._light._markMeshesAsLightDirty()),this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()},j.prototype.serialize=function(){var w={},Q=this.getShadowMap();if(!Q)return w;if(w.className=this.getClassName(),w.lightId=this._light.id,w.id=this.id,w.mapSize=Q.getRenderSize(),w.forceBackFacesOnly=this.forceBackFacesOnly,w.darkness=this.getDarkness(),w.transparencyShadow=this._transparencyShadow,w.frustumEdgeFalloff=this.frustumEdgeFalloff,w.bias=this.bias,w.normalBias=this.normalBias,w.usePercentageCloserFiltering=this.usePercentageCloserFiltering,w.useContactHardeningShadow=this.useContactHardeningShadow,w.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,w.filteringQuality=this.filteringQuality,w.useExponentialShadowMap=this.useExponentialShadowMap,w.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,w.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,w.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,w.usePoissonSampling=this.usePoissonSampling,w.depthScale=this.depthScale,w.blurBoxOffset=this.blurBoxOffset,w.blurKernel=this.blurKernel,w.blurScale=this.blurScale,w.useKernelBlur=this.useKernelBlur,w.renderList=[],Q.renderList)for(var W=0;W<Q.renderList.length;W++){var Y=Q.renderList[W];w.renderList.push(Y.id)}return w},j.Parse=function(w,Q,W){for(var Y=Q.getLightByID(w.lightId),he=W?W(w.mapSize,Y):new j(w.mapSize,Y),le=he.getShadowMap(),J=0;J<w.renderList.length;J++){var Re=Q.getMeshesByID(w.renderList[J]);Re.forEach(function(Me){!le||(le.renderList||(le.renderList=[]),le.renderList.push(Me))})}return w.id!==void 0&&(he.id=w.id),he.forceBackFacesOnly=!!w.forceBackFacesOnly,w.darkness!==void 0&&he.setDarkness(w.darkness),w.transparencyShadow&&he.setTransparencyShadow(!0),w.frustumEdgeFalloff!==void 0&&(he.frustumEdgeFalloff=w.frustumEdgeFalloff),w.bias!==void 0&&(he.bias=w.bias),w.normalBias!==void 0&&(he.normalBias=w.normalBias),w.usePercentageCloserFiltering?he.usePercentageCloserFiltering=!0:w.useContactHardeningShadow?he.useContactHardeningShadow=!0:w.usePoissonSampling?he.usePoissonSampling=!0:w.useExponentialShadowMap?he.useExponentialShadowMap=!0:w.useBlurExponentialShadowMap?he.useBlurExponentialShadowMap=!0:w.useCloseExponentialShadowMap?he.useCloseExponentialShadowMap=!0:w.useBlurCloseExponentialShadowMap?he.useBlurCloseExponentialShadowMap=!0:w.useVarianceShadowMap?he.useExponentialShadowMap=!0:w.useBlurVarianceShadowMap&&(he.useBlurExponentialShadowMap=!0),w.contactHardeningLightSizeUVRatio!==void 0&&(he.contactHardeningLightSizeUVRatio=w.contactHardeningLightSizeUVRatio),w.filteringQuality!==void 0&&(he.filteringQuality=w.filteringQuality),w.depthScale&&(he.depthScale=w.depthScale),w.blurScale&&(he.blurScale=w.blurScale),w.blurBoxOffset&&(he.blurBoxOffset=w.blurBoxOffset),w.useKernelBlur&&(he.useKernelBlur=w.useKernelBlur),w.blurKernel&&(he.blurKernel=w.blurKernel),he},j._Counter=0,j.CLASSNAME="ShadowGenerator",j.FILTER_NONE=0,j.FILTER_EXPONENTIALSHADOWMAP=1,j.FILTER_POISSONSAMPLING=2,j.FILTER_BLUREXPONENTIALSHADOWMAP=3,j.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,j.FILTER_PCF=6,j.FILTER_PCSS=7,j.QUALITY_HIGH=0,j.QUALITY_MEDIUM=1,j.QUALITY_LOW=2,j._SceneComponentInitialization=function(w){throw F.a.WarnImport("ShadowGeneratorSceneComponent")},j}()},542:function(we,P,u){"use strict";u.d(P,"a",function(){return G});var S=u(434),R=u(436),U=u(588),O=u(453),x=u(465),G=function(T){Object(S.d)(h,T);function h(f,d,g,p,_,m,l){g===void 0&&(g=null),p===void 0&&(p=null),_===void 0&&(_=null),m===void 0&&(m=null),l===void 0&&(l=null);var y=T.call(this,f,d.getScene())||this;return y.name=f,y.children=new Array,y.animations=new Array,y._index=null,y._absoluteTransform=new R.a,y._invertedAbsoluteTransform=new R.a,y._scalingDeterminant=1,y._worldTransform=new R.a,y._needToDecompose=!0,y._needToCompose=!1,y._linkedTransformNode=null,y._waitingTransformNodeId=null,y._skeleton=d,y._localMatrix=p?p.clone():R.a.Identity(),y._restPose=_||y._localMatrix.clone(),y._bindPose=y._localMatrix.clone(),y._baseMatrix=m||y._localMatrix.clone(),y._index=l,d.bones.push(y),y.setParent(g,!1),(m||p)&&y._updateDifferenceMatrix(),y}return Object.defineProperty(h.prototype,"_matrix",{get:function(){return this._compose(),this._localMatrix},set:function(f){this._localMatrix.copyFrom(f),this._needToDecompose=!0},enumerable:!1,configurable:!0}),h.prototype.getClassName=function(){return"Bone"},h.prototype.getSkeleton=function(){return this._skeleton},h.prototype.getParent=function(){return this._parent},h.prototype.getChildren=function(){return this.children},h.prototype.getIndex=function(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index},h.prototype.setParent=function(f,d){if(d===void 0&&(d=!0),this._parent!==f){if(this._parent){var g=this._parent.children.indexOf(this);g!==-1&&this._parent.children.splice(g,1)}this._parent=f,this._parent&&this._parent.children.push(this),d&&this._updateDifferenceMatrix(),this.markAsDirty()}},h.prototype.getLocalMatrix=function(){return this._compose(),this._localMatrix},h.prototype.getBaseMatrix=function(){return this._baseMatrix},h.prototype.getRestPose=function(){return this._restPose},h.prototype.setRestPose=function(f){this._restPose.copyFrom(f)},h.prototype.getBindPose=function(){return this._bindPose},h.prototype.setBindPose=function(f){this._bindPose.copyFrom(f)},h.prototype.getWorldMatrix=function(){return this._worldTransform},h.prototype.returnToRest=function(){this._skeleton._numBonesWithLinkedTransformNode>0?this.updateMatrix(this._restPose,!1,!1):this.updateMatrix(this._restPose,!1,!0)},h.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},h.prototype.getAbsoluteTransform=function(){return this._absoluteTransform},h.prototype.linkTransformNode=function(f){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=f,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++},h.prototype.getTransformNode=function(){return this._linkedTransformNode},Object.defineProperty(h.prototype,"position",{get:function(){return this._decompose(),this._localPosition},set:function(f){this._decompose(),this._localPosition.copyFrom(f),this._markAsDirtyAndCompose()},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"rotation",{get:function(){return this.getRotation()},set:function(f){this.setRotation(f)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"rotationQuaternion",{get:function(){return this._decompose(),this._localRotation},set:function(f){this.setRotationQuaternion(f)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"scaling",{get:function(){return this.getScale()},set:function(f){this.setScale(f)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"animationPropertiesOverride",{get:function(){return this._skeleton.animationPropertiesOverride},enumerable:!1,configurable:!0}),h.prototype._decompose=function(){!this._needToDecompose||(this._needToDecompose=!1,this._localScaling||(this._localScaling=R.e.Zero(),this._localRotation=R.b.Zero(),this._localPosition=R.e.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))},h.prototype._compose=function(){if(!!this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,R.a.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}},h.prototype.updateMatrix=function(f,d,g){d===void 0&&(d=!0),g===void 0&&(g=!0),this._baseMatrix.copyFrom(f),d&&this._updateDifferenceMatrix(),g?(this._needToCompose=!1,this._localMatrix.copyFrom(f),this._markAsDirtyAndDecompose()):this.markAsDirty()},h.prototype._updateDifferenceMatrix=function(f,d){if(d===void 0&&(d=!0),f||(f=this._baseMatrix),this._parent?f.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(f),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),d)for(var g=0;g<this.children.length;g++)this.children[g]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1},h.prototype.markAsDirty=function(){this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty()},h.prototype._markAsDirtyAndCompose=function(){this.markAsDirty(),this._needToCompose=!0},h.prototype._markAsDirtyAndDecompose=function(){this.markAsDirty(),this._needToDecompose=!0},h.prototype.translate=function(f,d,g){d===void 0&&(d=x.c.LOCAL);var p=this.getLocalMatrix();if(d==x.c.LOCAL)p.addAtIndex(12,f.x),p.addAtIndex(13,f.y),p.addAtIndex(14,f.z);else{var _=null;g&&(_=g.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var m=h._tmpMats[0],l=h._tmpVecs[0];this._parent?g&&_?(m.copyFrom(this._parent.getAbsoluteTransform()),m.multiplyToRef(_,m)):m.copyFrom(this._parent.getAbsoluteTransform()):R.a.IdentityToRef(m),m.setTranslationFromFloats(0,0,0),m.invert(),R.e.TransformCoordinatesToRef(f,m,l),p.addAtIndex(12,l.x),p.addAtIndex(13,l.y),p.addAtIndex(14,l.z)}this._markAsDirtyAndDecompose()},h.prototype.setPosition=function(f,d,g){d===void 0&&(d=x.c.LOCAL);var p=this.getLocalMatrix();if(d==x.c.LOCAL)p.setTranslationFromFloats(f.x,f.y,f.z);else{var _=null;g&&(_=g.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var m=h._tmpMats[0],l=h._tmpVecs[0];this._parent?(g&&_?(m.copyFrom(this._parent.getAbsoluteTransform()),m.multiplyToRef(_,m)):m.copyFrom(this._parent.getAbsoluteTransform()),m.invert()):R.a.IdentityToRef(m),R.e.TransformCoordinatesToRef(f,m,l),p.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()},h.prototype.setAbsolutePosition=function(f,d){this.setPosition(f,x.c.WORLD,d)},h.prototype.scale=function(f,d,g,p){p===void 0&&(p=!1);var _=this.getLocalMatrix(),m=h._tmpMats[0];R.a.ScalingToRef(f,d,g,m),m.multiplyToRef(_,_),m.invert();for(var l=0,y=this.children;l<y.length;l++){var E=y[l],A=E.getLocalMatrix();A.multiplyToRef(m,A),A.multiplyAtIndex(12,f),A.multiplyAtIndex(13,d),A.multiplyAtIndex(14,g),E._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),p)for(var F=0,B=this.children;F<B.length;F++){var E=B[F];E.scale(f,d,g,p)}},h.prototype.setScale=function(f){this._decompose(),this._localScaling.copyFrom(f),this._markAsDirtyAndCompose()},h.prototype.getScale=function(){return this._decompose(),this._localScaling},h.prototype.getScaleToRef=function(f){this._decompose(),f.copyFrom(this._localScaling)},h.prototype.setYawPitchRoll=function(f,d,g,p,_){if(p===void 0&&(p=x.c.LOCAL),p===x.c.LOCAL){var m=h._tmpQuat;R.b.RotationYawPitchRollToRef(f,d,g,m),this.setRotationQuaternion(m,p,_);return}var l=h._tmpMats[0];if(!!this._getNegativeRotationToRef(l,_)){var y=h._tmpMats[1];R.a.RotationYawPitchRollToRef(f,d,g,y),l.multiplyToRef(y,y),this._rotateWithMatrix(y,p,_)}},h.prototype.rotate=function(f,d,g,p){g===void 0&&(g=x.c.LOCAL);var _=h._tmpMats[0];_.setTranslationFromFloats(0,0,0),R.a.RotationAxisToRef(f,d,_),this._rotateWithMatrix(_,g,p)},h.prototype.setAxisAngle=function(f,d,g,p){if(g===void 0&&(g=x.c.LOCAL),g===x.c.LOCAL){var _=h._tmpQuat;R.b.RotationAxisToRef(f,d,_),this.setRotationQuaternion(_,g,p);return}var m=h._tmpMats[0];if(!!this._getNegativeRotationToRef(m,p)){var l=h._tmpMats[1];R.a.RotationAxisToRef(f,d,l),m.multiplyToRef(l,l),this._rotateWithMatrix(l,g,p)}},h.prototype.setRotation=function(f,d,g){d===void 0&&(d=x.c.LOCAL),this.setYawPitchRoll(f.y,f.x,f.z,d,g)},h.prototype.setRotationQuaternion=function(f,d,g){if(d===void 0&&(d=x.c.LOCAL),d===x.c.LOCAL){this._decompose(),this._localRotation.copyFrom(f),this._markAsDirtyAndCompose();return}var p=h._tmpMats[0];if(!!this._getNegativeRotationToRef(p,g)){var _=h._tmpMats[1];R.a.FromQuaternionToRef(f,_),p.multiplyToRef(_,_),this._rotateWithMatrix(_,d,g)}},h.prototype.setRotationMatrix=function(f,d,g){if(d===void 0&&(d=x.c.LOCAL),d===x.c.LOCAL){var p=h._tmpQuat;R.b.FromRotationMatrixToRef(f,p),this.setRotationQuaternion(p,d,g);return}var _=h._tmpMats[0];if(!!this._getNegativeRotationToRef(_,g)){var m=h._tmpMats[1];m.copyFrom(f),_.multiplyToRef(f,m),this._rotateWithMatrix(m,d,g)}},h.prototype._rotateWithMatrix=function(f,d,g){d===void 0&&(d=x.c.LOCAL);var p=this.getLocalMatrix(),_=p.m[12],m=p.m[13],l=p.m[14],y=this.getParent(),E=h._tmpMats[3],A=h._tmpMats[4];y&&d==x.c.WORLD?(g?(E.copyFrom(g.getWorldMatrix()),y.getAbsoluteTransform().multiplyToRef(E,E)):E.copyFrom(y.getAbsoluteTransform()),A.copyFrom(E),A.invert(),p.multiplyToRef(E,p),p.multiplyToRef(f,p),p.multiplyToRef(A,p)):d==x.c.WORLD&&g?(E.copyFrom(g.getWorldMatrix()),A.copyFrom(E),A.invert(),p.multiplyToRef(E,p),p.multiplyToRef(f,p),p.multiplyToRef(A,p)):p.multiplyToRef(f,p),p.setTranslationFromFloats(_,m,l),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()},h.prototype._getNegativeRotationToRef=function(f,d){var g=h._tmpMats[2];return f.copyFrom(this.getAbsoluteTransform()),d&&(f.multiplyToRef(d.getWorldMatrix(),f),R.a.ScalingToRef(d.scaling.x,d.scaling.y,d.scaling.z,g)),f.invert(),isNaN(f.m[0])?!1:(g.multiplyAtIndex(0,this._scalingDeterminant),f.multiplyToRef(g,f),!0)},h.prototype.getPosition=function(f,d){f===void 0&&(f=x.c.LOCAL),d===void 0&&(d=null);var g=R.e.Zero();return this.getPositionToRef(f,d,g),g},h.prototype.getPositionToRef=function(f,d,g){if(f===void 0&&(f=x.c.LOCAL),f==x.c.LOCAL){var p=this.getLocalMatrix();g.x=p.m[12],g.y=p.m[13],g.z=p.m[14]}else{var _=null;d&&(_=d.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var m=h._tmpMats[0];d&&_?(m.copyFrom(this.getAbsoluteTransform()),m.multiplyToRef(_,m)):m=this.getAbsoluteTransform(),g.x=m.m[12],g.y=m.m[13],g.z=m.m[14]}},h.prototype.getAbsolutePosition=function(f){f===void 0&&(f=null);var d=R.e.Zero();return this.getPositionToRef(x.c.WORLD,f,d),d},h.prototype.getAbsolutePositionToRef=function(f,d){this.getPositionToRef(x.c.WORLD,f,d)},h.prototype.computeAbsoluteTransforms=function(){if(this._compose(),this._parent)this._localMatrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);var f=this._skeleton.getPoseMatrix();f&&this._absoluteTransform.multiplyToRef(f,this._absoluteTransform)}for(var d=this.children,g=d.length,p=0;p<g;p++)d[p].computeAbsoluteTransforms()},h.prototype.getDirection=function(f,d){d===void 0&&(d=null);var g=R.e.Zero();return this.getDirectionToRef(f,d,g),g},h.prototype.getDirectionToRef=function(f,d,g){d===void 0&&(d=null);var p=null;d&&(p=d.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var _=h._tmpMats[0];_.copyFrom(this.getAbsoluteTransform()),d&&p&&_.multiplyToRef(p,_),R.e.TransformNormalToRef(f,_,g),g.normalize()},h.prototype.getRotation=function(f,d){f===void 0&&(f=x.c.LOCAL),d===void 0&&(d=null);var g=R.e.Zero();return this.getRotationToRef(f,d,g),g},h.prototype.getRotationToRef=function(f,d,g){f===void 0&&(f=x.c.LOCAL),d===void 0&&(d=null);var p=h._tmpQuat;this.getRotationQuaternionToRef(f,d,p),p.toEulerAnglesToRef(g)},h.prototype.getRotationQuaternion=function(f,d){f===void 0&&(f=x.c.LOCAL),d===void 0&&(d=null);var g=R.b.Identity();return this.getRotationQuaternionToRef(f,d,g),g},h.prototype.getRotationQuaternionToRef=function(f,d,g){if(f===void 0&&(f=x.c.LOCAL),d===void 0&&(d=null),f==x.c.LOCAL)this._decompose(),g.copyFrom(this._localRotation);else{var p=h._tmpMats[0],_=this.getAbsoluteTransform();d?_.multiplyToRef(d.getWorldMatrix(),p):p.copyFrom(_),p.multiplyAtIndex(0,this._scalingDeterminant),p.multiplyAtIndex(1,this._scalingDeterminant),p.multiplyAtIndex(2,this._scalingDeterminant),p.decompose(void 0,g,void 0)}},h.prototype.getRotationMatrix=function(f,d){f===void 0&&(f=x.c.LOCAL);var g=R.a.Identity();return this.getRotationMatrixToRef(f,d,g),g},h.prototype.getRotationMatrixToRef=function(f,d,g){if(f===void 0&&(f=x.c.LOCAL),f==x.c.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(g);else{var p=h._tmpMats[0],_=this.getAbsoluteTransform();d?_.multiplyToRef(d.getWorldMatrix(),p):p.copyFrom(_),p.multiplyAtIndex(0,this._scalingDeterminant),p.multiplyAtIndex(1,this._scalingDeterminant),p.multiplyAtIndex(2,this._scalingDeterminant),p.getRotationMatrixToRef(g)}},h.prototype.getAbsolutePositionFromLocal=function(f,d){d===void 0&&(d=null);var g=R.e.Zero();return this.getAbsolutePositionFromLocalToRef(f,d,g),g},h.prototype.getAbsolutePositionFromLocalToRef=function(f,d,g){d===void 0&&(d=null);var p=null;d&&(p=d.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var _=h._tmpMats[0];d&&p?(_.copyFrom(this.getAbsoluteTransform()),_.multiplyToRef(p,_)):_=this.getAbsoluteTransform(),R.e.TransformCoordinatesToRef(f,_,g)},h.prototype.getLocalPositionFromAbsolute=function(f,d){d===void 0&&(d=null);var g=R.e.Zero();return this.getLocalPositionFromAbsoluteToRef(f,d,g),g},h.prototype.getLocalPositionFromAbsoluteToRef=function(f,d,g){d===void 0&&(d=null);var p=null;d&&(p=d.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var _=h._tmpMats[0];_.copyFrom(this.getAbsoluteTransform()),d&&p&&_.multiplyToRef(p,_),_.invert(),R.e.TransformCoordinatesToRef(f,_,g)},h.prototype.setCurrentPoseAsRest=function(){this.setRestPose(this.getLocalMatrix())},h._tmpVecs=U.a.BuildArray(2,R.e.Zero),h._tmpQuat=R.b.Identity(),h._tmpMats=U.a.BuildArray(5,R.a.Identity),h}(O.a)},544:function(we,P,u){"use strict";u.d(P,"a",function(){return U});var S=u(436),R=u(476),U=function(){function O(x,G){if(G===void 0&&(G=O.DefaultPluginFactory()),this._physicsPlugin=G,this._impostors=[],this._joints=[],this._subTimeStep=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");x=x||new S.e(0,-9.807,0),this.setGravity(x),this.setTimeStep()}return O.DefaultPluginFactory=function(){throw R.a.WarnImport("CannonJSPlugin")},O.prototype.setGravity=function(x){this.gravity=x,this._physicsPlugin.setGravity(this.gravity)},O.prototype.setTimeStep=function(x){x===void 0&&(x=1/60),this._physicsPlugin.setTimeStep(x)},O.prototype.getTimeStep=function(){return this._physicsPlugin.getTimeStep()},O.prototype.setSubTimeStep=function(x){x===void 0&&(x=0),this._subTimeStep=x},O.prototype.getSubTimeStep=function(){return this._subTimeStep},O.prototype.dispose=function(){this._impostors.forEach(function(x){x.dispose()}),this._physicsPlugin.dispose()},O.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name},O.prototype.addImpostor=function(x){x.uniqueId=this._impostors.push(x),x.parent||this._physicsPlugin.generatePhysicsBody(x)},O.prototype.removeImpostor=function(x){var G=this._impostors.indexOf(x);if(G>-1){var T=this._impostors.splice(G,1);T.length&&this.getPhysicsPlugin().removePhysicsBody(x)}},O.prototype.addJoint=function(x,G,T){var h={mainImpostor:x,connectedImpostor:G,joint:T};T.physicsPlugin=this._physicsPlugin,this._joints.push(h),this._physicsPlugin.generateJoint(h)},O.prototype.removeJoint=function(x,G,T){var h=this._joints.filter(function(f){return f.connectedImpostor===G&&f.joint===T&&f.mainImpostor===x});h.length&&this._physicsPlugin.removeJoint(h[0])},O.prototype._step=function(x){var G=this;this._impostors.forEach(function(T){T.isBodyInitRequired()&&G._physicsPlugin.generatePhysicsBody(T)}),x>.1?x=.1:x<=0&&(x=1/60),this._physicsPlugin.executeStep(x,this._impostors)},O.prototype.getPhysicsPlugin=function(){return this._physicsPlugin},O.prototype.getImpostors=function(){return this._impostors},O.prototype.getImpostorForPhysicsObject=function(x){for(var G=0;G<this._impostors.length;++G)if(this._impostors[G].object===x)return this._impostors[G];return null},O.prototype.getImpostorWithPhysicsBody=function(x){for(var G=0;G<this._impostors.length;++G)if(this._impostors[G].physicsBody===x)return this._impostors[G];return null},O.prototype.raycast=function(x,G){return this._physicsPlugin.raycast(x,G)},O.Epsilon=.001,O}()},545:function(we,P,u){"use strict";u.d(P,"a",function(){return x});var S=u(444),R=u(625),U=u(500),O=u(566),x=function(){function G(){}return G.ExpandRGBDTexture=function(T){var h=T._texture;if(!(!h||!T.isRGBD)){var f=h.getEngine(),d=f.getCaps(),g=!1;d.textureHalfFloatRender&&d.textureHalfFloatLinearFiltering?(g=!0,h.type=2):d.textureFloatRender&&d.textureFloatLinearFiltering&&(g=!0,h.type=1),g&&(h.isReady=!1,h._isRGBD=!1,h.invertY=!1),T.onLoadObservable.addOnce(function(){if(g){var p=new S.a("rgbdDecode","rgbdDecode",null,null,1,null,3,f,!1,void 0,h.type,void 0,null,!1),_=f.createRenderTargetTexture(h.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:h.samplingMode,type:h.type,format:5});p.getEffect().executeWhenCompiled(function(){p.onApply=function(m){m._bindTexture("textureSampler",h),m.setFloat2("scale",1,1)},T.getScene().postProcessManager.directRender([p],_,!0),f.restoreDefaultFramebuffer(),f._releaseTexture(h),f._releaseFramebufferObjects(_),p&&p.dispose(),_._swapAndDie(h),h.isReady=!0})}})}},G.EncodeTextureToRGBD=function(T,h,f){return f===void 0&&(f=0),O.a.ApplyPostProcess("rgbdEncode",T,h,f,1,5)},G}()},546:function(we,P,u){"use strict";u.d(P,"a",function(){return R});var S=u(436),R=function(){function U(){}return U._RemoveAndStorePivotPoint=function(O){O&&U._PivotCached===0&&(O.getPivotPointToRef(U._OldPivotPoint),U._PivotPostMultiplyPivotMatrix=O._postMultiplyPivotMatrix,U._OldPivotPoint.equalsToFloats(0,0,0)||(O.setPivotMatrix(S.a.IdentityReadOnly),U._OldPivotPoint.subtractToRef(O.getPivotPoint(),U._PivotTranslation),U._PivotTmpVector.copyFromFloats(1,1,1),U._PivotTmpVector.subtractInPlace(O.scaling),U._PivotTmpVector.multiplyInPlace(U._PivotTranslation),O.position.addInPlace(U._PivotTmpVector))),U._PivotCached++},U._RestorePivotPoint=function(O){O&&!U._OldPivotPoint.equalsToFloats(0,0,0)&&U._PivotCached===1&&(O.setPivotPoint(U._OldPivotPoint),O._postMultiplyPivotMatrix=U._PivotPostMultiplyPivotMatrix,U._PivotTmpVector.copyFromFloats(1,1,1),U._PivotTmpVector.subtractInPlace(O.scaling),U._PivotTmpVector.multiplyInPlace(U._PivotTranslation),O.position.subtractInPlace(U._PivotTmpVector)),this._PivotCached--},U._PivotCached=0,U._OldPivotPoint=new S.e,U._PivotTranslation=new S.e,U._PivotTmpVector=new S.e,U._PivotPostMultiplyPivotMatrix=!1,U}()},547:function(we,P,u){"use strict";u.d(P,"a",function(){return O});var S=u(449),R=u(452),U=u(502);Object.defineProperty(S.a.prototype,"geometryBufferRenderer",{get:function(){this._geometryBufferRenderer},set:function(x){x&&x.isSupported&&(this._geometryBufferRenderer=x)},enumerable:!0,configurable:!0}),S.a.prototype.enableGeometryBufferRenderer=function(x){return x===void 0&&(x=1),this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new U.a(this,x),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)},S.a.prototype.disableGeometryBufferRenderer=function(){!this._geometryBufferRenderer||(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};var O=function(){function x(G){this.name=R.a.NAME_GEOMETRYBUFFERRENDERER,this.scene=G}return x.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(R.a.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)},x.prototype.rebuild=function(){},x.prototype.dispose=function(){},x.prototype._gatherRenderTargets=function(G){this.scene._geometryBufferRenderer&&G.push(this.scene._geometryBufferRenderer.getGBuffer())},x}();U.a._SceneComponentInitialization=function(x){var G=x._getComponent(R.a.NAME_GEOMETRYBUFFERRENDERER);G||(G=new O(x),x._addComponent(G))}},548:function(we,P,u){"use strict";u.d(P,"a",function(){return S});var S=function(){function R(){this._renderPipelines={}}return Object.defineProperty(R.prototype,"supportedPipelines",{get:function(){var U=[];for(var O in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(O)){var x=this._renderPipelines[O];x.isSupported&&U.push(x)}return U},enumerable:!1,configurable:!0}),R.prototype.addPipeline=function(U){this._renderPipelines[U._name]=U},R.prototype.attachCamerasToRenderPipeline=function(U,O,x){x===void 0&&(x=!1);var G=this._renderPipelines[U];!G||G._attachCameras(O,x)},R.prototype.detachCamerasFromRenderPipeline=function(U,O){var x=this._renderPipelines[U];!x||x._detachCameras(O)},R.prototype.enableEffectInPipeline=function(U,O,x){var G=this._renderPipelines[U];!G||G._enableEffect(O,x)},R.prototype.disableEffectInPipeline=function(U,O,x){var G=this._renderPipelines[U];!G||G._disableEffect(O,x)},R.prototype.update=function(){for(var U in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(U)){var O=this._renderPipelines[U];O.isSupported?O._update():(O.dispose(),delete this._renderPipelines[U])}},R.prototype._rebuild=function(){for(var U in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(U)){var O=this._renderPipelines[U];O._rebuild()}},R.prototype.dispose=function(){for(var U in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(U)){var O=this._renderPipelines[U];O.dispose()}},R}()},549:function(we,P,u){"use strict";u.d(P,"a",function(){return R});const S=()=>!!document.createElement("canvas").getContext("webgl2"),R=()=>S()?"webgl2":"webgl"},554:function(we,P,u){"use strict";u.d(P,"a",function(){return S});var S=function(){function R(U,O){O===void 0&&(O=20),this.debug=!1,this._sourceCode=U,this._numMaxIterations=O,this._functionDescr=[],this.inlineToken="#define inline"}return Object.defineProperty(R.prototype,"code",{get:function(){return this._sourceCode},enumerable:!1,configurable:!0}),R.prototype.processCode=function(){this.debug&&console.log("Start inlining process (code size="+this._sourceCode.length+")..."),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&console.log("End of inlining process.")},R.prototype._collectFunctions=function(){for(var U=0;U<this._sourceCode.length;){var O=this._sourceCode.indexOf(this.inlineToken,U);if(O<0)break;var x=this._sourceCode.indexOf("(",O+this.inlineToken.length);if(x<0){this.debug&&console.warn("Could not find the opening parenthesis after the token. startIndex="+U),U=O+this.inlineToken.length;continue}var G=R._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(O+this.inlineToken.length,x));if(!G){this.debug&&console.warn("Could not extract the name/type of the function from: "+this._sourceCode.substring(O+this.inlineToken.length,x)),U=O+this.inlineToken.length;continue}var T=[G[3],G[4]],h=T[0],f=T[1],d=this._extractBetweenMarkers("(",")",this._sourceCode,x);if(d<0){this.debug&&console.warn("Could not extract the parameters the function '"+f+"' (type="+h+"). funcParamsStartIndex="+x),U=O+this.inlineToken.length;continue}var g=this._sourceCode.substring(x+1,d),p=this._skipWhitespaces(this._sourceCode,d+1);if(p===this._sourceCode.length){this.debug&&console.warn("Could not extract the body of the function '"+f+"' (type="+h+"). funcParamsEndIndex="+d),U=O+this.inlineToken.length;continue}var _=this._extractBetweenMarkers("{","}",this._sourceCode,p);if(_<0){this.debug&&console.warn("Could not extract the body of the function '"+f+"' (type="+h+"). funcBodyStartIndex="+p),U=O+this.inlineToken.length;continue}for(var m=this._sourceCode.substring(p,_+1),l=this._removeComments(g).split(","),y=[],E=0;E<l.length;++E){var A=l[E].trim(),F=A.lastIndexOf(" ");F>=0&&y.push(A.substring(F+1))}h!=="void"&&y.push("return"),this._functionDescr.push({name:f,type:h,parameters:y,body:m,callIndex:0}),U=_+1;var B=O>0?this._sourceCode.substring(0,O):"",L=_+1<this._sourceCode.length-1?this._sourceCode.substring(_+1):"";this._sourceCode=B+L,U-=_+1-O}this.debug&&console.log("Collect functions: "+this._functionDescr.length+" functions found. functionDescr=",this._functionDescr)},R.prototype._processInlining=function(U){for(U===void 0&&(U=20);U-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&console.log("numMaxIterations is "+U+" after inlining process"),U>=0},R.prototype._extractBetweenMarkers=function(U,O,x,G){for(var T=G,h=0,f="";T<x.length;){var d=x.charAt(T);if(f)d===f?f==='"'||f==="'"?x.charAt(T-1)!=="\\"&&(f=""):f="":f==="*/"&&d==="*"&&T+1<x.length&&(x.charAt(T+1)==="/"&&(f=""),f===""&&T++);else switch(d){case U:h++;break;case O:h--;break;case'"':case"'":case"`":f=d;break;case"/":if(T+1<x.length){var g=x.charAt(T+1);g==="/"?f=`
`:g==="*"&&(f="*/")}break}if(T++,h===0)break}return h===0?T-1:-1},R.prototype._skipWhitespaces=function(U,O){for(;O<U.length;){var x=U[O];if(x!==" "&&x!==`
`&&x!=="\r"&&x!=="	"&&x!==`
`&&x!=="\xA0")break;O++}return O},R.prototype._isIdentifierChar=function(U){var O=U.charCodeAt(0);return O>=48&&O<=57||O>=65&&O<=90||O>=97&&O<=122||O==95},R.prototype._removeComments=function(U){for(var O=0,x="",G=!1,T=[];O<U.length;){var h=U.charAt(O);if(x)h===x?x==='"'||x==="'"?(U.charAt(O-1)!=="\\"&&(x=""),T.push(h)):(x="",G=!1):x==="*/"&&h==="*"&&O+1<U.length?(U.charAt(O+1)==="/"&&(x=""),x===""&&(G=!1,O++)):G||T.push(h);else{switch(h){case'"':case"'":case"`":x=h;break;case"/":if(O+1<U.length){var f=U.charAt(O+1);f==="/"?(x=`
`,G=!0):f==="*"&&(x="*/",G=!0)}break}G||T.push(h)}O++}return T.join("")},R.prototype._replaceFunctionCallsByCode=function(){for(var U=this,O=!1,x=0,G=this._functionDescr;x<G.length;x++)for(var T=G[x],h=T.name,f=T.type,d=T.parameters,g=T.body,p=0;p<this._sourceCode.length;){var _=this._sourceCode.indexOf(h,p);if(_<0)break;if(_===0||this._isIdentifierChar(this._sourceCode.charAt(_-1))){p=_+h.length;continue}var m=this._skipWhitespaces(this._sourceCode,_+h.length);if(m===this._sourceCode.length||this._sourceCode.charAt(m)!=="("){p=_+h.length;continue}var l=this._extractBetweenMarkers("(",")",this._sourceCode,m);if(l<0){this.debug&&console.warn("Could not extract the parameters of the function call. Function '"+h+"' (type="+f+"). callParamsStartIndex="+m),p=_+h.length;continue}var y=this._sourceCode.substring(m+1,l),E=function(W){for(var Y=[],he=0,le=0;he<W.length;){if(W.charAt(he)==="("){var J=U._extractBetweenMarkers("(",")",W,he);if(J<0)return null;he=J}else W.charAt(he)===","&&(Y.push(W.substring(le,he)),le=he+1);he++}return le<he&&Y.push(W.substring(le,he)),Y},A=E(this._removeComments(y));if(A===null){this.debug&&console.warn("Invalid function call: can't extract the parameters of the function call. Function '"+h+"' (type="+f+"). callParamsStartIndex="+m+", callParams="+y),p=_+h.length;continue}for(var F=[],B=0;B<A.length;++B){var L=A[B].trim();F.push(L)}var I=f!=="void"?h+"_"+T.callIndex++:null;if(I&&F.push(I+" ="),F.length!==d.length){this.debug&&console.warn("Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '"+h+"' (type="+f+"). function parameters="+d+", call parameters="+F),p=_+h.length;continue}p=l+1;var z=this._replaceNames(g,d,F),k=_>0?this._sourceCode.substring(0,_):"",j=l+1<this._sourceCode.length-1?this._sourceCode.substring(l+1):"";if(I){var w=this._findBackward(this._sourceCode,_-1,`
`);k=this._sourceCode.substring(0,w+1);var Q=this._sourceCode.substring(w+1,_);this._sourceCode=k+f+" "+I+`;
`+z+`
`+Q+I+j,this.debug&&console.log("Replace function call by code. Function '"+h+"' (type="+f+"). injectDeclarationIndex="+w+", call parameters="+F)}else this._sourceCode=k+z+j,p+=z.length-(l+1-_),this.debug&&console.log("Replace function call by code. Function '"+h+"' (type="+f+"). functionCallIndex="+_+", call parameters="+F);O=!0}return O},R.prototype._findBackward=function(U,O,x){for(;O>=0&&U.charAt(O)!==x;)O--;return O},R.prototype._escapeRegExp=function(U){return U.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},R.prototype._replaceNames=function(U,O,x){for(var G=this,T=function(d){var g=new RegExp(h._escapeRegExp(O[d]),"g"),p=O[d].length,_=x[d];U=U.replace(g,function(m){for(var l=[],y=1;y<arguments.length;y++)l[y-1]=arguments[y];var E=l[0];return G._isIdentifierChar(U.charAt(E-1))||G._isIdentifierChar(U.charAt(E+p))?O[d]:_})},h=this,f=0;f<O.length;++f)T(f);return U},R._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/,R}()},555:function(we,P,u){"use strict";var S=u(446),R=u(447),U=u(436);S.a.prototype.thinInstanceAdd=function(O,x){x===void 0&&(x=!0),this._thinInstanceUpdateBufferSize("matrix",Array.isArray(O)?O.length:1);var G=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(O))for(var T=0;T<O.length;++T)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,O[T],T===O.length-1&&x);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,O,x);return G},S.a.prototype.thinInstanceAddSelf=function(O){return O===void 0&&(O=!0),this.thinInstanceAdd(U.a.IdentityReadOnly,O)},S.a.prototype.thinInstanceRegisterAttribute=function(O,x){this.removeVerticesData(O),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[O]=x,this._userThinInstanceBuffersStorage.sizes[O]=x*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[O]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[O]),this._userThinInstanceBuffersStorage.vertexBuffers[O]=new R.b(this.getEngine(),this._userThinInstanceBuffersStorage.data[O],O,!0,!1,x,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[O])},S.a.prototype.thinInstanceSetMatrixAt=function(O,x,G){if(G===void 0&&(G=!0),!this._thinInstanceDataStorage.matrixData||O>=this._thinInstanceDataStorage.instancesCount)return!1;var T=this._thinInstanceDataStorage.matrixData;return x.copyToArray(T,O*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[O]=x),G&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},S.a.prototype.thinInstanceSetAttributeAt=function(O,x,G,T){return T===void 0&&(T=!0),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[O]||x>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(O,0),this._userThinInstanceBuffersStorage.data[O].set(G,x*this._userThinInstanceBuffersStorage.strides[O]),T&&this.thinInstanceBufferUpdated(O),!0)},Object.defineProperty(S.a.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(O){var x,G,T=((G=(x=this._thinInstanceDataStorage.matrixData)===null||x===void 0?void 0:x.length)!==null&&G!==void 0?G:0)/16;O<=T&&(this._thinInstanceDataStorage.instancesCount=O)},enumerable:!0,configurable:!0}),S.a.prototype.thinInstanceSetBuffer=function(O,x,G,T){var h,f;if(G===void 0&&(G=0),T===void 0&&(T=!1),G=G||16,O==="matrix")if((h=this._thinInstanceDataStorage.matrixBuffer)===null||h===void 0||h.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=x?x.length:32*G,this._thinInstanceDataStorage.matrixData=x,this._thinInstanceDataStorage.worldMatrices=null,x!==null){this._thinInstanceDataStorage.instancesCount=x.length/G;var d=new R.a(this.getEngine(),x,!T,G,!1,!0);this._thinInstanceDataStorage.matrixBuffer=d,this.setVerticesBuffer(d.createVertexBuffer("world0",0,4)),this.setVerticesBuffer(d.createVertexBuffer("world1",4,4)),this.setVerticesBuffer(d.createVertexBuffer("world2",8,4)),this.setVerticesBuffer(d.createVertexBuffer("world3",12,4)),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)}else this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo(!0);else x===null?((f=this._userThinInstanceBuffersStorage)===null||f===void 0?void 0:f.data[O])&&(this.removeVerticesData(O),delete this._userThinInstanceBuffersStorage.data[O],delete this._userThinInstanceBuffersStorage.strides[O],delete this._userThinInstanceBuffersStorage.sizes[O],delete this._userThinInstanceBuffersStorage.vertexBuffers[O]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[O]=x,this._userThinInstanceBuffersStorage.strides[O]=G,this._userThinInstanceBuffersStorage.sizes[O]=x.length,this._userThinInstanceBuffersStorage.vertexBuffers[O]=new R.b(this.getEngine(),x,O,!T,!1,G,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[O]))},S.a.prototype.thinInstanceBufferUpdated=function(O){var x;O==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):((x=this._userThinInstanceBuffersStorage)===null||x===void 0?void 0:x.vertexBuffers[O])&&this._userThinInstanceBuffersStorage.vertexBuffers[O].updateDirectly(this._userThinInstanceBuffersStorage.data[O],0)},S.a.prototype.thinInstancePartialBufferUpdate=function(O,x,G){var T;O==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(x,G):((T=this._userThinInstanceBuffersStorage)===null||T===void 0?void 0:T.vertexBuffers[O])&&this._userThinInstanceBuffersStorage.vertexBuffers[O].updateDirectly(x,G)},S.a.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];var O=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(var x=0;x<this._thinInstanceDataStorage.instancesCount;++x)this._thinInstanceDataStorage.worldMatrices[x]=U.a.FromArray(O,x*16)}return this._thinInstanceDataStorage.worldMatrices},S.a.prototype.thinInstanceRefreshBoundingInfo=function(O){if(O===void 0&&(O=!1),!(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)){var x=this._thinInstanceDataStorage.boundingVectors;O&&(x.length=0,this.refreshBoundingInfo(!0));var G=this.getBoundingInfo(),T=this._thinInstanceDataStorage.matrixData;if(x.length===0)for(var h=0;h<G.boundingBox.vectors.length;++h)x.push(G.boundingBox.vectors[h].clone());U.c.Vector3[0].setAll(Number.POSITIVE_INFINITY),U.c.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(var f=0;f<this._thinInstanceDataStorage.instancesCount;++f){U.a.FromArrayToRef(T,f*16,U.c.Matrix[0]);for(var h=0;h<x.length;++h)U.e.TransformCoordinatesToRef(x[h],U.c.Matrix[0],U.c.Vector3[2]),U.c.Vector3[0].minimizeInPlace(U.c.Vector3[2]),U.c.Vector3[1].maximizeInPlace(U.c.Vector3[2])}G.reConstruct(U.c.Vector3[0],U.c.Vector3[1]),this._updateBoundingInfo()}},S.a.prototype._thinInstanceUpdateBufferSize=function(O,x){var G,T;x===void 0&&(x=1);var h=O==="matrix";if(!(!h&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[O]))){for(var f=h?16:this._userThinInstanceBuffersStorage.strides[O],d=h?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[O],g=h?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[O],p=(this._thinInstanceDataStorage.instancesCount+x)*f,_=d;_<p;)_*=2;if(!g||d!=_){if(!g)g=new Float32Array(_);else{var m=new Float32Array(_);m.set(g,0),g=m}if(h){(G=this._thinInstanceDataStorage.matrixBuffer)===null||G===void 0||G.dispose();var l=new R.a(this.getEngine(),g,!0,f,!1,!0);this._thinInstanceDataStorage.matrixBuffer=l,this._thinInstanceDataStorage.matrixData=g,this._thinInstanceDataStorage.matrixBufferSize=_,this.setVerticesBuffer(l.createVertexBuffer("world0",0,4)),this.setVerticesBuffer(l.createVertexBuffer("world1",4,4)),this.setVerticesBuffer(l.createVertexBuffer("world2",8,4)),this.setVerticesBuffer(l.createVertexBuffer("world3",12,4))}else(T=this._userThinInstanceBuffersStorage.vertexBuffers[O])===null||T===void 0||T.dispose(),this._userThinInstanceBuffersStorage.data[O]=g,this._userThinInstanceBuffersStorage.sizes[O]=_,this._userThinInstanceBuffersStorage.vertexBuffers[O]=new R.b(this.getEngine(),g,O,!0,!1,f,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[O])}}},S.a.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},S.a.prototype._disposeThinInstanceSpecificData=function(){var O;((O=this._thinInstanceDataStorage)===null||O===void 0?void 0:O.matrixBuffer)&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)}},556:function(we,P,u){"use strict";u.d(P,"a",function(){return _});var S=u(441),R=u(447),U=u(442),O=u(458),x=u(454),G=u(435),T=u(535),h="depthPixelShader",f=`#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
void main(void)
{
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
}`;G.a.ShadersStore[h]=f;var d={name:h,shader:f},g=u(664),p=u(476),_=function(){function m(l,y,E,A){var F=this;y===void 0&&(y=1),E===void 0&&(E=null),A===void 0&&(A=!1),this.enabled=!0,this.useOnlyInActiveCamera=!1,this._scene=l,this._storeNonLinearDepth=A,this.isPacked=y===0,this.isPacked?this._clearColor=new S.b(1,1,1,1):this._clearColor=new S.b(1,0,0,1),m._SceneComponentInitialization(this._scene),this._camera=E;var B=l.getEngine(),L=this.isPacked||!B._features.supportExtendedTextureFormats?5:6;this._depthMap=new O.a("depthMap",{width:B.getRenderWidth(),height:B.getRenderHeight()},this._scene,!1,!0,y,!1,void 0,void 0,void 0,void 0,L),this._depthMap.wrapU=U.a.CLAMP_ADDRESSMODE,this._depthMap.wrapV=U.a.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(function(z){z.clear(F._clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(function(){B._debugPushGroup("depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(function(){B._debugPopGroup(1)});var I=function(z){var k=z.getRenderingMesh(),j=z.getEffectiveMesh(),w=F._scene,Q=w.getEngine(),W=z.getMaterial();if(j._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!W||j.infiniteDistance||W.disableDepthWrite||z.verticesCount===0||z._renderId===w.getRenderId())){Q.setState(W.backFaceCulling,0,!1,w.useRightHandedSystem);var Y=k._getInstancesRenderList(z._id,!!z.getReplacementMesh());if(!Y.mustReturn){var he=Q.getCaps().instancedArrays&&(Y.visibleInstances[z._id]!==null&&Y.visibleInstances[z._id]!==void 0||k.hasThinInstances),le=F._camera||w.activeCamera;if(F.isReady(z,he)&&le){if(z._renderId=w.getRenderId(),Q.enableEffect(F._effect),k._bind(z,F._effect,W.fillMode),F._effect.setMatrix("viewProjection",w.getTransformMatrix()),F._effect.setMatrix("world",j.getWorldMatrix()),F._effect.setFloat2("depthValues",le.minZ,le.minZ+le.maxZ),W&&W.needAlphaTesting()){var J=W.getAlphaTestTexture();J&&(F._effect.setTexture("diffuseSampler",J),F._effect.setMatrix("diffuseMatrix",J.getTextureMatrix()))}if(k.useBones&&k.computeBonesUsingShaders&&k.skeleton){var Re=k.skeleton;if(Re.isUsingTextureForMatrices){var Me=Re.getTransformMatrixTexture(k);if(!Me)return;F._effect.setTexture("boneSampler",Me),F._effect.setFloat("boneTextureWidth",4*(Re.bones.length+1))}else F._effect.setMatrices("mBones",Re.getTransformMatrices(k))}x.a.BindMorphTargetParameters(k,F._effect),k.morphTargetManager&&k.morphTargetManager.isUsingTextureForTargets&&k.morphTargetManager._bind(F._effect),k._processRendering(j,z,F._effect,W.fillMode,Y,he,function(me,H){return F._effect.setMatrix("world",H)})}}}};this._depthMap.customRenderFunction=function(z,k,j,w){var Q;if(w.length){for(B.setColorWrite(!1),Q=0;Q<w.length;Q++)I(w.data[Q]);B.setColorWrite(!0)}for(Q=0;Q<z.length;Q++)I(z.data[Q]);for(Q=0;Q<k.length;Q++)I(k.data[Q])}}return m.prototype.isReady=function(l,y){var E=l.getMaterial();if(E.disableDepthWrite)return!1;var A=[],F=[R.b.PositionKind],B=l.getMesh();E&&E.needAlphaTesting()&&E.getAlphaTestTexture()&&(A.push("#define ALPHATEST"),B.isVerticesDataPresent(R.b.UVKind)&&(F.push(R.b.UVKind),A.push("#define UV1")),B.isVerticesDataPresent(R.b.UV2Kind)&&(F.push(R.b.UV2Kind),A.push("#define UV2"))),B.useBones&&B.computeBonesUsingShaders?(F.push(R.b.MatricesIndicesKind),F.push(R.b.MatricesWeightsKind),B.numBoneInfluencers>4&&(F.push(R.b.MatricesIndicesExtraKind),F.push(R.b.MatricesWeightsExtraKind)),A.push("#define NUM_BONE_INFLUENCERS "+B.numBoneInfluencers),A.push("#define BonesPerMesh "+(B.skeleton?B.skeleton.bones.length+1:0))):A.push("#define NUM_BONE_INFLUENCERS 0");var L=B.morphTargetManager,I=0;L&&L.numInfluencers>0&&(I=L.numInfluencers,A.push("#define MORPHTARGETS"),A.push("#define NUM_MORPH_INFLUENCERS "+I),L.isUsingTextureForTargets&&A.push("#define MORPHTARGETS_TEXTURE"),x.a.PrepareAttributesForMorphTargetsInfluencers(F,B,I)),y&&(A.push("#define INSTANCES"),x.a.PushAttributesForInstances(F),l.getRenderingMesh().hasThinInstances&&A.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&A.push("#define NONLINEARDEPTH"),this.isPacked&&A.push("#define PACKED");var z=A.join(`
`);return this._cachedDefines!==z&&(this._cachedDefines=z,this._effect=this._scene.getEngine().createEffect("depth",F,["world","mBones","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],["diffuseSampler","morphTargets"],z,void 0,void 0,void 0,{maxSimultaneousMorphTargets:I})),this._effect.isReady()},m.prototype.getDepthMap=function(){return this._depthMap},m.prototype.dispose=function(){this._depthMap.dispose()},m._SceneComponentInitialization=function(l){throw p.a.WarnImport("DepthRendererSceneComponent")},m}()},560:function(we,P,u){"use strict";u.d(P,"a",function(){return d});var S=u(542),R=u(438),U=u(436),O=u(527),x=u(483),G=u(672),T=u(448),h=u(440),f=u(474),d=function(){function g(p,_,m){this.name=p,this.id=_,this.bones=new Array,this.needInitialSkinMatrix=!1,this.overrideMesh=null,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=U.a.Identity(),this._ranges={},this._lastAbsoluteTransformsUpdateId=-1,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._waitingOverrideMeshId=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new R.c,this.bones=[],this._scene=m||T.a.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;var l=this._scene.getEngine().getCaps();this._canUseTextureForBones=l.textureFloat&&l.maxVertexTextureImageUnits>0}return Object.defineProperty(g.prototype,"useTextureToStoreBoneMatrices",{get:function(){return this._useTextureToStoreBoneMatrices},set:function(p){this._useTextureToStoreBoneMatrices=p,this._markAsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(p){this._animationPropertiesOverride=p},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"isUsingTextureForMatrices",{get:function(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),g.prototype.getClassName=function(){return"Skeleton"},g.prototype.getChildren=function(){return this.bones.filter(function(p){return!p.getParent()})},g.prototype.getTransformMatrices=function(p){return this.needInitialSkinMatrix&&p._bonesTransformMatrices?p._bonesTransformMatrices:(this._transformMatrices||this.prepare(),this._transformMatrices)},g.prototype.getTransformMatrixTexture=function(p){return this.needInitialSkinMatrix&&p._transformMatrixTexture?p._transformMatrixTexture:this._transformMatrixTexture},g.prototype.getScene=function(){return this._scene},g.prototype.toString=function(p){var _="Name: "+this.name+", nBones: "+this.bones.length;if(_+=", nAnimationRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),p){_+=", Ranges: {";var m=!0;for(var l in this._ranges)m&&(_+=", ",m=!1),_+=l;_+="}"}return _},g.prototype.getBoneIndexByName=function(p){for(var _=0,m=this.bones.length;_<m;_++)if(this.bones[_].name===p)return _;return-1},g.prototype.createAnimationRange=function(p,_,m){if(!this._ranges[p]){this._ranges[p]=new G.a(p,_,m);for(var l=0,y=this.bones.length;l<y;l++)this.bones[l].animations[0]&&this.bones[l].animations[0].createRange(p,_,m)}},g.prototype.deleteAnimationRange=function(p,_){_===void 0&&(_=!0);for(var m=0,l=this.bones.length;m<l;m++)this.bones[m].animations[0]&&this.bones[m].animations[0].deleteRange(p,_);this._ranges[p]=null},g.prototype.getAnimationRange=function(p){return this._ranges[p]||null},g.prototype.getAnimationRanges=function(){var p=[],_;for(_ in this._ranges)p.push(this._ranges[_]);return p},g.prototype.copyAnimationRange=function(p,_,m){if(m===void 0&&(m=!1),this._ranges[_]||!p.getAnimationRange(_))return!1;var l=!0,y=this._getHighestAnimationFrame()+1,E={},A=p.bones,F,B;for(B=0,F=A.length;B<F;B++)E[A[B].name]=A[B];this.bones.length!==A.length&&(h.a.Warn("copyAnimationRange: this rig has "+this.bones.length+" bones, while source as "+A.length),l=!1);var L=m&&this.dimensionsAtRest&&p.dimensionsAtRest?this.dimensionsAtRest.divide(p.dimensionsAtRest):null;for(B=0,F=this.bones.length;B<F;B++){var I=this.bones[B].name,z=E[I];z?l=l&&this.bones[B].copyAnimationRange(z,_,y,m,L):(h.a.Warn("copyAnimationRange: not same rig, missing source bone "+I),l=!1)}var k=p.getAnimationRange(_);return k&&(this._ranges[_]=new G.a(_,k.from+y,k.to+y)),l},g.prototype.returnToRest=function(){for(var p=U.c.Vector3[0],_=U.c.Quaternion[0],m=U.c.Vector3[1],l=0;l<this.bones.length;l++){var y=this.bones[l];y._index!==-1&&(y.returnToRest(),y._linkedTransformNode&&(y.getRestPose().decompose(p,_,m),y._linkedTransformNode.position=m.clone(),y._linkedTransformNode.rotationQuaternion=_.clone(),y._linkedTransformNode.scaling=p.clone()))}},g.prototype._getHighestAnimationFrame=function(){for(var p=0,_=0,m=this.bones.length;_<m;_++)if(this.bones[_].animations[0]){var l=this.bones[_].animations[0].getHighestFrame();p<l&&(p=l)}return p},g.prototype.beginAnimation=function(p,_,m,l){var y=this.getAnimationRange(p);return y?this._scene.beginAnimation(this,y.from,y.to,_,m,l):null},g.MakeAnimationAdditive=function(p,_,m){_===void 0&&(_=0);var l=p.getAnimationRange(m);if(!l)return null;for(var y=p._scene.getAllAnimatablesByTarget(p),E=null,A=0;A<y.length;A++){var F=y[A];if(F.fromFrame===(l==null?void 0:l.from)&&F.toFrame===(l==null?void 0:l.to)){E=F;break}}for(var B=p.getAnimatables(),A=0;A<B.length;A++){var L=B[A],I=L.animations;if(!!I)for(var z=0;z<I.length;z++)x.a.MakeAnimationAdditive(I[z],_,m)}return E&&(E.isAdditive=!0),p},g.prototype._markAsDirty=function(){this._isDirty=!0},g.prototype._registerMeshWithPoseMatrix=function(p){this._meshesWithPoseMatrix.push(p)},g.prototype._unregisterMeshWithPoseMatrix=function(p){var _=this._meshesWithPoseMatrix.indexOf(p);_>-1&&this._meshesWithPoseMatrix.splice(_,1)},g.prototype._computeTransformMatrices=function(p,_){this.onBeforeComputeObservable.notifyObservers(this);for(var m=0;m<this.bones.length;m++){var l=this.bones[m];l._childUpdateId++;var y=l.getParent();if(y?l.getLocalMatrix().multiplyToRef(y.getWorldMatrix(),l.getWorldMatrix()):_?l.getLocalMatrix().multiplyToRef(_,l.getWorldMatrix()):l.getWorldMatrix().copyFrom(l.getLocalMatrix()),l._index!==-1){var E=l._index===null?m:l._index;l.getInvertedAbsoluteTransform().multiplyToArray(l.getWorldMatrix(),p,E*16)}}this._identity.copyToArray(p,this.bones.length*16)},g.prototype.prepare=function(){if(this._numBonesWithLinkedTransformNode>0)for(var p=0,_=this.bones;p<_.length;p++){var m=_[p];m._linkedTransformNode&&(m._linkedTransformNode.computeWorldMatrix(),m._matrix=m._linkedTransformNode._localMatrix,m.markAsDirty())}if(!!this._isDirty){if(this.needInitialSkinMatrix)for(var l=0;l<this._meshesWithPoseMatrix.length;l++){var y=this._meshesWithPoseMatrix[l],E=y.getPoseMatrix();if((!y._bonesTransformMatrices||y._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(y._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1))),this._synchronizedWithMesh!==y){this._synchronizedWithMesh=y;for(var A=0;A<this.bones.length;A++){var F=this.bones[A];if(!F.getParent()){var B=F.getBaseMatrix();B.multiplyToRef(E,U.c.Matrix[1]),F._updateDifferenceMatrix(U.c.Matrix[1])}}if(this.isUsingTextureForMatrices){var L=(this.bones.length+1)*4;(!y._transformMatrixTexture||y._transformMatrixTexture.getSize().width!==L)&&(y._transformMatrixTexture&&y._transformMatrixTexture.dispose(),y._transformMatrixTexture=O.a.CreateRGBATexture(y._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(y._bonesTransformMatrices,E),this.isUsingTextureForMatrices&&y._transformMatrixTexture&&y._transformMatrixTexture.update(y._bonesTransformMatrices)}else(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=O.a.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices);this._isDirty=!1,this._scene._activeBones.addCount(this.bones.length,!1)}},g.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var p=0;p<this.bones.length;p++)this._animatables.push(this.bones[p])}return this._animatables},g.prototype.clone=function(p,_){var m=new g(p,_||p,this._scene);m.needInitialSkinMatrix=this.needInitialSkinMatrix,m.overrideMesh=this.overrideMesh;for(var l=0;l<this.bones.length;l++){var y=this.bones[l],E=null,A=y.getParent();if(A){var F=this.bones.indexOf(A);E=m.bones[F]}var B=new S.a(y.name,m,E,y.getBaseMatrix().clone(),y.getRestPose().clone());B._index=y._index,y._linkedTransformNode&&B.linkTransformNode(y._linkedTransformNode),f.a.DeepCopy(y.animations,B.animations)}if(this._ranges){m._ranges={};for(var L in this._ranges){var I=this._ranges[L];I&&(m._ranges[L]=I.clone())}}return this._isDirty=!0,m},g.prototype.enableBlending=function(p){p===void 0&&(p=.01),this.bones.forEach(function(_){_.animations.forEach(function(m){m.enableBlending=!0,m.blendingSpeed=p})})},g.prototype.dispose=function(){this._meshesWithPoseMatrix=[],this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)},g.prototype.serialize=function(){var p,_,m={};m.name=this.name,m.id=this.id,this.dimensionsAtRest&&(m.dimensionsAtRest=this.dimensionsAtRest.asArray()),m.bones=[],m.needInitialSkinMatrix=this.needInitialSkinMatrix,m.overrideMeshId=(p=this.overrideMesh)===null||p===void 0?void 0:p.id;for(var l=0;l<this.bones.length;l++){var y=this.bones[l],E=y.getParent(),A={parentBoneIndex:E?this.bones.indexOf(E):-1,index:y.getIndex(),name:y.name,id:y.id,matrix:y.getBaseMatrix().toArray(),rest:y.getRestPose().toArray(),linkedTransformNodeId:(_=y.getTransformNode())===null||_===void 0?void 0:_.id};m.bones.push(A),y.length&&(A.length=y.length),y.metadata&&(A.metadata=y.metadata),y.animations&&y.animations.length>0&&(A.animation=y.animations[0].serialize()),m.ranges=[];for(var F in this._ranges){var B=this._ranges[F];if(!!B){var L={};L.name=F,L.from=B.from,L.to=B.to,m.ranges.push(L)}}}return m},g.Parse=function(p,_){var m=new g(p.name,p.id,_);p.dimensionsAtRest&&(m.dimensionsAtRest=U.e.FromArray(p.dimensionsAtRest)),m.needInitialSkinMatrix=p.needInitialSkinMatrix,p.overrideMeshId&&(m._hasWaitingData=!0,m._waitingOverrideMeshId=p.overrideMeshId);var l;for(l=0;l<p.bones.length;l++){var y=p.bones[l],E=p.bones[l].index,A=null;y.parentBoneIndex>-1&&(A=m.bones[y.parentBoneIndex]);var F=y.rest?U.a.FromArray(y.rest):null,B=new S.a(y.name,m,A,U.a.FromArray(y.matrix),F,null,E);y.id!==void 0&&y.id!==null&&(B.id=y.id),y.length&&(B.length=y.length),y.metadata&&(B.metadata=y.metadata),y.animation&&B.animations.push(x.a.Parse(y.animation)),y.linkedTransformNodeId!==void 0&&y.linkedTransformNodeId!==null&&(m._hasWaitingData=!0,B._waitingTransformNodeId=y.linkedTransformNodeId)}if(p.ranges)for(l=0;l<p.ranges.length;l++){var L=p.ranges[l];m.createAnimationRange(L.name,L.from,L.to)}return m},g.prototype.computeAbsoluteTransforms=function(p){p===void 0&&(p=!1);var _=this._scene.getRenderId();(this._lastAbsoluteTransformsUpdateId!=_||p)&&(this.bones[0].computeAbsoluteTransforms(),this._lastAbsoluteTransformsUpdateId=_)},g.prototype.getPoseMatrix=function(){var p=null;return this._meshesWithPoseMatrix.length>0&&(p=this._meshesWithPoseMatrix[0].getPoseMatrix()),p},g.prototype.sortBones=function(){for(var p=new Array,_=new Array(this.bones.length),m=0;m<this.bones.length;m++)this._sortBones(m,p,_);this.bones=p},g.prototype._sortBones=function(p,_,m){if(!m[p]){m[p]=!0;var l=this.bones[p];l._index===void 0&&(l._index=p);var y=l.getParent();y&&this._sortBones(this.bones.indexOf(y),_,m),_.push(l)}},g.prototype.setCurrentPoseAsRest=function(){this.bones.forEach(function(p){p.setCurrentPoseAsRest()})},g}()},561:function(we,P,u){"use strict";u.d(P,"a",function(){return G});var S=u(490),R=u(440),U=u(448),O=u(608),x=u(631),G=function(){function T(h){if(h===void 0&&(h=null),this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new S.a(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,h||(h=U.a.LastCreatedScene),this._scene=h,this._scene){this._scene.morphTargetManagers.push(this),this._uniqueId=this._scene.getUniqueId();var f=this._scene.getEngine().getCaps();this._canUseTextureForTargets=f.canUseGLVertexID&&f.textureFloat&&f.maxVertexTextureImageUnits>0}}return Object.defineProperty(T.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"vertexCount",{get:function(){return this._vertexCount},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"supportsNormals",{get:function(){return this._supportsNormals&&this.enableNormalMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"supportsTangents",{get:function(){return this._supportsTangents&&this.enableTangentMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"supportsUVs",{get:function(){return this._supportsUVs&&this.enableUVMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"numTargets",{get:function(){return this._targets.length},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"numInfluencers",{get:function(){return this._activeTargets.length},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"influences",{get:function(){return this._influences},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"useTextureToStoreTargets",{get:function(){return this._useTextureToStoreTargets},set:function(h){this._useTextureToStoreTargets=h},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"isUsingTextureForTargets",{get:function(){return this.useTextureToStoreTargets&&this._canUseTextureForTargets},enumerable:!1,configurable:!0}),T.prototype.getActiveTarget=function(h){return this._activeTargets.data[h]},T.prototype.getTarget=function(h){return this._targets[h]},T.prototype.addTarget=function(h){var f=this;this._targets.push(h),this._targetInfluenceChangedObservers.push(h.onInfluenceChanged.add(function(d){f._syncActiveTargets(d)})),this._targetDataLayoutChangedObservers.push(h._onDataLayoutChanged.add(function(){f._syncActiveTargets(!0)})),this._syncActiveTargets(!0)},T.prototype.removeTarget=function(h){var f=this._targets.indexOf(h);f>=0&&(this._targets.splice(f,1),h.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(f,1)[0]),h._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(f,1)[0]),this._syncActiveTargets(!0))},T.prototype._bind=function(h){h.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),h.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),h.setTexture("morphTargets",this._targetStoreTexture)},T.prototype.clone=function(){for(var h=new T(this._scene),f=0,d=this._targets;f<d.length;f++){var g=d[f];h.addTarget(g.clone())}return h.enableNormalMorphing=this.enableNormalMorphing,h.enableTangentMorphing=this.enableTangentMorphing,h.enableUVMorphing=this.enableUVMorphing,h},T.prototype.serialize=function(){var h={};h.id=this.uniqueId,h.targets=[];for(var f=0,d=this._targets;f<d.length;f++){var g=d[f];h.targets.push(g.serialize())}return h},T.prototype._syncActiveTargets=function(h){var f=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));for(var d=-1,g=0,p=this._targets;g<p.length;g++){var _=p[g];if(d++,!(_.influence===0&&this.optimizeInfluencers)){this._activeTargets.push(_),this._morphTargetTextureIndices[f]=d,this._tempInfluences[f++]=_.influence,this._supportsNormals=this._supportsNormals&&_.hasNormals,this._supportsTangents=this._supportsTangents&&_.hasTangents,this._supportsUVs=this._supportsUVs&&_.hasUVs;var m=_.getPositions();if(m){var l=m.length/3;if(this._vertexCount===0)this._vertexCount=l;else if(this._vertexCount!==l){R.a.Error("Incompatible target. Targets must all have the same vertices count.");return}}}}(!this._influences||this._influences.length!==f)&&(this._influences=new Float32Array(f));for(var y=0;y<f;y++)this._influences[y]=this._tempInfluences[y];h&&this.synchronize()},T.prototype.synchronize=function(){if(!!this._scene){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;var h=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>h&&(this._textureHeight=Math.ceil(this._textureWidth/h),this._textureWidth=h);var f=!0;if(this._targetStoreTexture){var d=this._targetStoreTexture.getSize();d.width===this._textureWidth&&d.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(f=!1)}if(f){this._targetStoreTexture&&this._targetStoreTexture.dispose();for(var g=this._targets.length,p=new Float32Array(g*this._textureWidth*this._textureHeight*4),_=0,m=0;m<g;m++){var l=this._targets[m],y=l.getPositions(),E=l.getNormals(),A=l.getUVs(),F=l.getTangents();if(!y){m===0&&R.a.Error("Invalid morph target. Target must have positions.");return}_=m*this._textureWidth*this._textureHeight*4;for(var B=0;B<this._vertexCount;B++)p[_]=y[B*3],p[_+1]=y[B*3+1],p[_+2]=y[B*3+2],_+=4,E&&(p[_]=E[B*3],p[_+1]=E[B*3+1],p[_+2]=E[B*3+2],_+=4),A&&(p[_]=A[B*2],p[_+1]=A[B*2+1],_+=4),F&&(p[_]=F[B*3],p[_+1]=F[B*3+1],p[_+2]=F[B*3+2],_+=4)}this._targetStoreTexture=x.a.CreateRGBATexture(p,this._textureWidth,this._textureHeight,g,this._scene,!1,!1,1,1)}}for(var L=0,I=this._scene.meshes;L<I.length;L++){var z=I[L];z.morphTargetManager===this&&z._syncGeometryWithMorphTargetManager()}}},T.prototype.dispose=function(){this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null},T.Parse=function(h,f){var d=new T(f);d._uniqueId=h.id;for(var g=0,p=h.targets;g<p.length;g++){var _=p[g];d.addTarget(O.a.Parse(_))}return d},T}()},565:function(we,P,u){"use strict";var S=u(434),R=u(467),U=u(456),O=u(440),x=u(662),G=u(709);R.a.prototype._createDepthStencilCubeTexture=function(T,h){var f=new U.a(this,U.b.Unknown);if(f.isCube=!0,this.webGLVersion===1)return O.a.Error("Depth cube texture is not supported by WebGL 1."),f;var d=Object(S.a)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},h),g=this._gl;this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,f,!0),this._setupDepthStencilTexture(f,T,d.generateStencil,d.bilinearFiltering,d.comparisonFunction);for(var p=0;p<6;p++)d.generateStencil?g.texImage2D(g.TEXTURE_CUBE_MAP_POSITIVE_X+p,0,g.DEPTH24_STENCIL8,T,T,0,g.DEPTH_STENCIL,g.UNSIGNED_INT_24_8,null):g.texImage2D(g.TEXTURE_CUBE_MAP_POSITIVE_X+p,0,g.DEPTH_COMPONENT24,T,T,0,g.DEPTH_COMPONENT,g.UNSIGNED_INT,null);return this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,null),f},R.a.prototype._partialLoadFile=function(T,h,f,d,g){g===void 0&&(g=null);var p=function(m){f[h]=m,f._internalCount++,f._internalCount===6&&d(f)},_=function(m,l){g&&m&&g(m.status+" "+m.statusText,l)};this._loadFile(T,p,void 0,void 0,!0,_)},R.a.prototype._cascadeLoadFiles=function(T,h,f,d){d===void 0&&(d=null);var g=[];g._internalCount=0;for(var p=0;p<6;p++)this._partialLoadFile(f[p],p,g,h,d)},R.a.prototype._cascadeLoadImgs=function(T,h,f,d,g,p){g===void 0&&(g=null);var _=[];_._internalCount=0;for(var m=0;m<6;m++)this._partialLoadImg(d[m],m,_,T,h,f,g,p)},R.a.prototype._partialLoadImg=function(T,h,f,d,g,p,_,m){_===void 0&&(_=null);var l=G.a.RandomId(),y=function(A){f[h]=A,f._internalCount++,d&&d._removePendingData(l),f._internalCount===6&&p&&p(g,f)},E=function(A,F){d&&d._removePendingData(l),_&&_(A,F)};x.a.LoadImage(T,y,E,d?d.offlineProvider:null,m),d&&d._addPendingData(l)},R.a.prototype._setCubeMapTextureParams=function(T,h){var f=this._gl;f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,h?f.LINEAR_MIPMAP_LINEAR:f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),T.samplingMode=h?3:2,this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null)},R.a.prototype.createCubeTextureBase=function(T,h,f,d,g,p,_,m,l,y,E,A,F,B){var L=this;g===void 0&&(g=null),p===void 0&&(p=null),m===void 0&&(m=null),l===void 0&&(l=!1),y===void 0&&(y=0),E===void 0&&(E=0),A===void 0&&(A=null),F===void 0&&(F=null),B===void 0&&(B=null);var I=A||new U.a(this,U.b.Cube);I.isCube=!0,I.url=T,I.generateMipMaps=!d,I._lodGenerationScale=y,I._lodGenerationOffset=E,this._doNotHandleContextLost||(I._extension=m,I._files=f);var z=T;this._transformTextureUrl&&!A&&(T=this._transformTextureUrl(T));for(var k=T.lastIndexOf("."),j=m||(k>-1?T.substring(k).toLowerCase():""),w=null,Q=0,W=R.a._TextureLoaders;Q<W.length;Q++){var Y=W[Q];if(Y.canLoad(j)){w=Y;break}}var he=function(J,Re){T===z?p&&J&&p(J.status+" "+J.statusText,Re):(O.a.Warn("Failed to load "+T+", falling back to the "+z),L.createCubeTextureBase(z,h,f,!!d,g,p,_,m,l,y,E,I,F,B))};if(w){var le=function(J){F&&F(I,J),w.loadCubeData(J,I,l,g,p)};f&&f.length===6?w.supportCascades?this._cascadeLoadFiles(h,function(J){return le(J.map(function(Re){return new Uint8Array(Re)}))},f,p):p?p("Textures type does not support cascades."):O.a.Warn("Texture loader does not support cascades."):this._loadFile(T,function(J){return le(new Uint8Array(J))},void 0,void 0,!0,he)}else{if(!f)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(h,I,function(J,Re){B&&B(J,Re)},f,p)}return this._internalTexturesCache.push(I),I},R.a.prototype.createCubeTexture=function(T,h,f,d,g,p,_,m,l,y,E,A){var F=this;g===void 0&&(g=null),p===void 0&&(p=null),m===void 0&&(m=null),l===void 0&&(l=!1),y===void 0&&(y=0),E===void 0&&(E=0),A===void 0&&(A=null);var B=this._gl;return this.createCubeTextureBase(T,h,f,!!d,g,p,_,m,l,y,E,A,function(L,I){return F._bindTextureDirectly(B.TEXTURE_CUBE_MAP,L,!0)},function(L,I){var z=F.needPOTTextures?R.a.GetExponentOfTwo(I[0].width,F._caps.maxCubemapTextureSize):I[0].width,k=z,j=[B.TEXTURE_CUBE_MAP_POSITIVE_X,B.TEXTURE_CUBE_MAP_POSITIVE_Y,B.TEXTURE_CUBE_MAP_POSITIVE_Z,B.TEXTURE_CUBE_MAP_NEGATIVE_X,B.TEXTURE_CUBE_MAP_NEGATIVE_Y,B.TEXTURE_CUBE_MAP_NEGATIVE_Z];F._bindTextureDirectly(B.TEXTURE_CUBE_MAP,L,!0),F._unpackFlipY(!1);for(var w=_?F._getInternalFormat(_):F._gl.RGBA,Q=0;Q<j.length;Q++)if(I[Q].width!==z||I[Q].height!==k){if(F._prepareWorkingCanvas(),!F._workingCanvas||!F._workingContext){O.a.Warn("Cannot create canvas to resize texture.");return}F._workingCanvas.width=z,F._workingCanvas.height=k,F._workingContext.drawImage(I[Q],0,0,I[Q].width,I[Q].height,0,0,z,k),B.texImage2D(j[Q],0,w,w,B.UNSIGNED_BYTE,F._workingCanvas)}else B.texImage2D(j[Q],0,w,w,B.UNSIGNED_BYTE,I[Q]);d||B.generateMipmap(B.TEXTURE_CUBE_MAP),F._setCubeMapTextureParams(L,!d),L.width=z,L.height=k,L.isReady=!0,_&&(L.format=_),L.onLoadedObservable.notifyObservers(L),L.onLoadedObservable.clear(),g&&g()})}},566:function(we,P,u){"use strict";u.d(P,"a",function(){return x});var S=u(442),R=u(458),U=u(486),O=u(444),x=function(){function G(){}return G.CreateResizedCopy=function(T,h,f,d){d===void 0&&(d=!0);var g=T.getScene(),p=g.getEngine(),_=new R.a("resized"+T.name,{width:h,height:f},g,!T.noMipmap,!0,T._texture.type,!1,T.samplingMode,!1);_.wrapU=T.wrapU,_.wrapV=T.wrapV,_.uOffset=T.uOffset,_.vOffset=T.vOffset,_.uScale=T.uScale,_.vScale=T.vScale,_.uAng=T.uAng,_.vAng=T.vAng,_.wAng=T.wAng,_.coordinatesIndex=T.coordinatesIndex,_.level=T.level,_.anisotropicFilteringLevel=T.anisotropicFilteringLevel,_._texture.isReady=!1,T.wrapU=S.a.CLAMP_ADDRESSMODE,T.wrapV=S.a.CLAMP_ADDRESSMODE;var m=new U.b("pass",1,null,d?S.a.BILINEAR_SAMPLINGMODE:S.a.NEAREST_SAMPLINGMODE,p,!1,0);return m.getEffect().executeWhenCompiled(function(){m.onApply=function(y){y.setTexture("textureSampler",T)};var l=_.getInternalTexture();l&&(g.postProcessManager.directRender([m],l),p.unBindFramebuffer(l),_.disposeFramebufferObjects(),m.dispose(),l.isReady=!0)}),_},G.ApplyPostProcess=function(T,h,f,d,g,p){var _=h.getEngine();return h.isReady=!1,g=g!=null?g:h.samplingMode,d=d!=null?d:h.type,p=p!=null?p:h.format,d===-1&&(d=0),new Promise(function(m){var l=new O.a("postprocess",T,null,null,1,null,g,_,!1,void 0,d,void 0,null,!1,p),y=_.createRenderTargetTexture({width:h.width,height:h.height},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:g,type:d,format:p});l.getEffect().executeWhenCompiled(function(){l.onApply=function(E){E._bindTexture("textureSampler",h),E.setFloat2("scale",1,1)},f.postProcessManager.directRender([l],y,!0),_.restoreDefaultFramebuffer(),_._releaseTexture(h),_._releaseFramebufferObjects(y),l&&l.dispose(),y._swapAndDie(h),h.type=d,h.format=5,h.isReady=!0,m(h)})})},G}()},567:function(we,P,u){"use strict";u.d(P,"a",function(){return _});var S=u(434),R=u(436),U=u(477),O=u(442),x=u(568),G=u(521),T=u(437),h=u(443),f=u(515),d=u(637),g=u(492),p=u(523),_=function(m){Object(S.d)(l,m);function l(y,E,A,F,B,L,I,z,k){F===void 0&&(F=!1),B===void 0&&(B=!0),L===void 0&&(L=!1),I===void 0&&(I=!1),z===void 0&&(z=null),k===void 0&&(k=null);var j,w=m.call(this,E)||this;return w._generateHarmonics=!0,w._onLoad=null,w._onError=null,w._isBlocking=!0,w._rotationY=0,w.boundingBoxPosition=R.e.Zero(),y&&(w._coordinatesMode=O.a.CUBIC_MODE,w.name=y,w.url=y,w.hasAlpha=!1,w.isCube=!0,w._textureMatrix=R.a.Identity(),w._prefilterOnLoad=I,w._onLoad=z,w._onError=k,w.gammaSpace=L,w._noMipmap=F,w._size=A,w._generateHarmonics=B,w._texture=w._getFromCache(y,w._noMipmap),w._texture?z&&(w._texture.isReady?h.b.SetImmediate(function(){return z()}):w._texture.onLoadedObservable.add(z)):((j=w.getScene())===null||j===void 0?void 0:j.useDelayedTextureLoading)?w.delayLoadState=4:w.loadTexture()),w}return Object.defineProperty(l.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(y){this._isBlocking=y},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"rotationY",{get:function(){return this._rotationY},set:function(y){this._rotationY=y,this.setReflectionTextureMatrix(R.a.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(y){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(y))){this._boundingBoxSize=y;var E=this.getScene();E&&E.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),l.prototype.getClassName=function(){return"HDRCubeTexture"},l.prototype.loadTexture=function(){var y=this,E=this._getEngine(),A=function(L){y.lodGenerationOffset=0,y.lodGenerationScale=.8;var I=x.a.GetCubeMapTextureData(L,y._size);if(y._generateHarmonics){var z=G.a.ConvertCubeMapToSphericalPolynomial(I);y.sphericalPolynomial=z}for(var k=[],j=null,w=0;w<6;w++){if(!E.getCaps().textureFloat){var Q=new ArrayBuffer(y._size*y._size*3);j=new Uint8Array(Q)}var W=I[l._facesMapping[w]];if(y.gammaSpace||j){for(var Y=0;Y<y._size*y._size;Y++)if(y.gammaSpace&&(W[Y*3+0]=Math.pow(W[Y*3+0],f.b),W[Y*3+1]=Math.pow(W[Y*3+1],f.b),W[Y*3+2]=Math.pow(W[Y*3+2],f.b)),j){var he=Math.max(W[Y*3+0]*255,0),le=Math.max(W[Y*3+1]*255,0),J=Math.max(W[Y*3+2]*255,0),Re=Math.max(Math.max(he,le),J);if(Re>255){var Me=255/Re;he*=Me,le*=Me,J*=Me}j[Y*3+0]=he,j[Y*3+1]=le,j[Y*3+2]=J}}j?k.push(j):k.push(W)}return k};if(E._features.allowTexturePrefiltering&&this._prefilterOnLoad){var F=this._onLoad,B=new d.a(E);this._onLoad=function(){B.prefilter(y,F)}}this._texture=E.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,E.getCaps().textureFloat?1:0,this._noMipmap,A,null,this._onLoad,this._onError)},l.prototype.clone=function(){var y=new l(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return y.level=this.level,y.wrapU=this.wrapU,y.wrapV=this.wrapV,y.coordinatesIndex=this.coordinatesIndex,y.coordinatesMode=this.coordinatesMode,y},l.prototype.delayLoad=function(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this.loadTexture())},l.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},l.prototype.setReflectionTextureMatrix=function(y){var E=this,A;this._textureMatrix=y,y.updateFlag!==this._textureMatrix.updateFlag&&y.isIdentity()!==this._textureMatrix.isIdentity()&&((A=this.getScene())===null||A===void 0||A.markAllMaterialsAsDirty(1,function(F){return F.getActiveTextures().indexOf(E)!==-1}))},l.Parse=function(y,E,A){var F=null;return y.name&&!y.isRenderTarget&&(F=new l(A+y.name,E,y.size,y.noMipmap,y.generateHarmonics,y.useInGammaSpace),F.name=y.name,F.hasAlpha=y.hasAlpha,F.level=y.level,F.coordinatesMode=y.coordinatesMode,F.isBlocking=y.isBlocking),F&&(y.boundingBoxPosition&&(F.boundingBoxPosition=R.e.FromArray(y.boundingBoxPosition)),y.boundingBoxSize&&(F.boundingBoxSize=R.e.FromArray(y.boundingBoxSize)),y.rotationY&&(F.rotationY=y.rotationY)),F},l.prototype.serialize=function(){if(!this.name)return null;var y={};return y.name=this.name,y.hasAlpha=this.hasAlpha,y.isCube=!0,y.level=this.level,y.size=this._size,y.coordinatesMode=this.coordinatesMode,y.useInGammaSpace=this.gammaSpace,y.generateHarmonics=this._generateHarmonics,y.customType="BABYLON.HDRCubeTexture",y.noMipmap=this._noMipmap,y.isBlocking=this._isBlocking,y.rotationY=this._rotationY,y},l._facesMapping=["right","left","up","down","front","back"],l}(U.a);T.a.RegisteredTypes["BABYLON.HDRCubeTexture"]=_},568:function(we,P,u){"use strict";u.d(P,"a",function(){return R});var S=u(569),R=function(){function U(){}return U.Ldexp=function(O,x){return x>1023?O*Math.pow(2,1023)*Math.pow(2,x-1023):x<-1074?O*Math.pow(2,-1074)*Math.pow(2,x+1074):O*Math.pow(2,x)},U.Rgbe2float=function(O,x,G,T,h,f){h>0?(h=this.Ldexp(1,h-(128+8)),O[f+0]=x*h,O[f+1]=G*h,O[f+2]=T*h):(O[f+0]=0,O[f+1]=0,O[f+2]=0)},U.readStringLine=function(O,x){for(var G="",T="",h=x;h<O.length-x&&(T=String.fromCharCode(O[h]),T!=`
`);h++)G+=T;return G},U.RGBE_ReadHeader=function(O){var x=0,G=0,T=this.readStringLine(O,0);if(T[0]!="#"||T[1]!="?")throw"Bad HDR Format.";var h=!1,f=!1,d=0;do d+=T.length+1,T=this.readStringLine(O,d),T=="FORMAT=32-bit_rle_rgbe"?f=!0:T.length==0&&(h=!0);while(!h);if(!f)throw"HDR Bad header format, unsupported FORMAT";d+=T.length+1,T=this.readStringLine(O,d);var g=/^\-Y (.*) \+X (.*)$/g,p=g.exec(T);if(!p||p.length<3)throw"HDR Bad header format, no size";if(G=parseInt(p[2]),x=parseInt(p[1]),G<8||G>32767)throw"HDR Bad header format, unsupported size";return d+=T.length+1,{height:x,width:G,dataPosition:d}},U.GetCubeMapTextureData=function(O,x){var G=new Uint8Array(O),T=this.RGBE_ReadHeader(G),h=this.RGBE_ReadPixels(G,T),f=S.a.ConvertPanoramaToCubemap(h,T.width,T.height,x);return f},U.RGBE_ReadPixels=function(O,x){return this.RGBE_ReadPixels_RLE(O,x)},U.RGBE_ReadPixels_RLE=function(O,x){for(var G=x.height,T=x.width,h,f,d,g,p,_=x.dataPosition,m=0,l=0,y=0,E=new ArrayBuffer(T*4),A=new Uint8Array(E),F=new ArrayBuffer(x.width*x.height*4*3),B=new Float32Array(F);G>0;){if(h=O[_++],f=O[_++],d=O[_++],g=O[_++],h!=2||f!=2||d&128||x.width<8||x.width>32767)return this.RGBE_ReadPixels_NOT_RLE(O,x);if((d<<8|g)!=T)throw"HDR Bad header format, wrong scan line width";for(m=0,y=0;y<4;y++)for(l=(y+1)*T;m<l;)if(h=O[_++],f=O[_++],h>128){if(p=h-128,p==0||p>l-m)throw"HDR Bad Format, bad scanline data (run)";for(;p-- >0;)A[m++]=f}else{if(p=h,p==0||p>l-m)throw"HDR Bad Format, bad scanline data (non-run)";if(A[m++]=f,--p>0)for(var L=0;L<p;L++)A[m++]=O[_++]}for(y=0;y<T;y++)h=A[y],f=A[y+T],d=A[y+2*T],g=A[y+3*T],this.Rgbe2float(B,h,f,d,g,(x.height-G)*T*3+y*3);G--}return B},U.RGBE_ReadPixels_NOT_RLE=function(O,x){for(var G=x.height,T=x.width,h,f,d,g,p,_=x.dataPosition,m=new ArrayBuffer(x.width*x.height*4*3),l=new Float32Array(m);G>0;){for(p=0;p<x.width;p++)h=O[_++],f=O[_++],d=O[_++],g=O[_++],this.Rgbe2float(l,h,f,d,g,(x.height-G)*T*3+p*3);G--}return l},U}()},569:function(we,P,u){"use strict";u.d(P,"a",function(){return R});var S=u(436),R=function(){function U(){}return U.ConvertPanoramaToCubemap=function(O,x,G,T){if(!O)throw"ConvertPanoramaToCubemap: input cannot be null";if(O.length!=x*G*3)throw"ConvertPanoramaToCubemap: input size is wrong";var h=this.CreateCubemapTexture(T,this.FACE_FRONT,O,x,G),f=this.CreateCubemapTexture(T,this.FACE_BACK,O,x,G),d=this.CreateCubemapTexture(T,this.FACE_LEFT,O,x,G),g=this.CreateCubemapTexture(T,this.FACE_RIGHT,O,x,G),p=this.CreateCubemapTexture(T,this.FACE_UP,O,x,G),_=this.CreateCubemapTexture(T,this.FACE_DOWN,O,x,G);return{front:h,back:f,left:d,right:g,up:p,down:_,size:T,type:1,format:4,gammaSpace:!1}},U.CreateCubemapTexture=function(O,x,G,T,h){for(var f=new ArrayBuffer(O*O*4*3),d=new Float32Array(f),g=x[1].subtract(x[0]).scale(1/O),p=x[3].subtract(x[2]).scale(1/O),_=1/O,m=0,l=0;l<O;l++){for(var y=x[0],E=x[2],A=0;A<O;A++){var F=E.subtract(y).scale(m).add(y);F.normalize();var B=this.CalcProjectionSpherical(F,G,T,h);d[l*O*3+A*3+0]=B.r,d[l*O*3+A*3+1]=B.g,d[l*O*3+A*3+2]=B.b,y=y.add(g),E=E.add(p)}m+=_}return d},U.CalcProjectionSpherical=function(O,x,G,T){for(var h=Math.atan2(O.z,O.x),f=Math.acos(O.y);h<-Math.PI;)h+=2*Math.PI;for(;h>Math.PI;)h-=2*Math.PI;var d=h/Math.PI,g=f/Math.PI;d=d*.5+.5;var p=Math.round(d*G);p<0?p=0:p>=G&&(p=G-1);var _=Math.round(g*T);_<0?_=0:_>=T&&(_=T-1);var m=T-_-1,l=x[m*G*3+p*3+0],y=x[m*G*3+p*3+1],E=x[m*G*3+p*3+2];return{r:l,g:y,b:E}},U.FACE_LEFT=[new S.e(-1,-1,-1),new S.e(1,-1,-1),new S.e(-1,1,-1),new S.e(1,1,-1)],U.FACE_RIGHT=[new S.e(1,-1,1),new S.e(-1,-1,1),new S.e(1,1,1),new S.e(-1,1,1)],U.FACE_FRONT=[new S.e(1,-1,-1),new S.e(1,-1,1),new S.e(1,1,-1),new S.e(1,1,1)],U.FACE_BACK=[new S.e(-1,-1,1),new S.e(-1,-1,-1),new S.e(-1,1,1),new S.e(-1,1,-1)],U.FACE_DOWN=[new S.e(1,1,-1),new S.e(1,1,1),new S.e(-1,1,-1),new S.e(-1,1,1)],U.FACE_UP=[new S.e(-1,-1,-1),new S.e(-1,-1,1),new S.e(1,-1,-1),new S.e(1,-1,1)],U}()},570:function(we,P,u){"use strict";u.d(P,"b",function(){return h}),u.d(P,"a",function(){return f});var S=u(434),R=u(436),U=u(442),O=u(466),x=u(582),G=u(580),T=u(583),h;(function(d){d[d.Low=0]="Low",d[d.Medium=1]="Medium",d[d.High=2]="High"})(h||(h={}));var f=function(d){Object(S.d)(g,d);function g(p,_,m,l,y){m===void 0&&(m=h.Low),l===void 0&&(l=0),y===void 0&&(y=!1);var E=d.call(this,p.getEngine(),"depth of field",function(){return E._effects},!0)||this;E._effects=[],E._circleOfConfusion=new x.a("circleOfConfusion",_,1,null,U.a.BILINEAR_SAMPLINGMODE,p.getEngine(),!1,l,y),E._depthOfFieldBlurY=[],E._depthOfFieldBlurX=[];var A=1,F=15;switch(m){case h.High:{A=3,F=51;break}case h.Medium:{A=2,F=31;break}default:{F=15,A=1;break}}for(var B=F/Math.pow(2,A-1),L=1,I=0;I<A;I++){var z=new G.a("vertical blur",p,new R.d(0,1),B,L,null,E._circleOfConfusion,I==0?E._circleOfConfusion:null,U.a.BILINEAR_SAMPLINGMODE,p.getEngine(),!1,l,y);z.autoClear=!1,L=.75/Math.pow(2,I);var k=new G.a("horizontal blur",p,new R.d(1,0),B,L,null,E._circleOfConfusion,null,U.a.BILINEAR_SAMPLINGMODE,p.getEngine(),!1,l,y);k.autoClear=!1,E._depthOfFieldBlurY.push(z),E._depthOfFieldBlurX.push(k)}E._effects=[E._circleOfConfusion];for(var I=0;I<E._depthOfFieldBlurX.length;I++)E._effects.push(E._depthOfFieldBlurY[I]),E._effects.push(E._depthOfFieldBlurX[I]);return E._dofMerge=new T.a("dofMerge",E._circleOfConfusion,E._circleOfConfusion,E._depthOfFieldBlurX,L,null,U.a.BILINEAR_SAMPLINGMODE,p.getEngine(),!1,l,y),E._dofMerge.autoClear=!1,E._effects.push(E._dofMerge),E}return Object.defineProperty(g.prototype,"focalLength",{get:function(){return this._circleOfConfusion.focalLength},set:function(p){this._circleOfConfusion.focalLength=p},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"fStop",{get:function(){return this._circleOfConfusion.fStop},set:function(p){this._circleOfConfusion.fStop=p},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"focusDistance",{get:function(){return this._circleOfConfusion.focusDistance},set:function(p){this._circleOfConfusion.focusDistance=p},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"lensSize",{get:function(){return this._circleOfConfusion.lensSize},set:function(p){this._circleOfConfusion.lensSize=p},enumerable:!1,configurable:!0}),g.prototype.getClassName=function(){return"DepthOfFieldEffect"},Object.defineProperty(g.prototype,"depthTexture",{set:function(p){this._circleOfConfusion.depthTexture=p},enumerable:!1,configurable:!0}),g.prototype.disposeEffects=function(p){for(var _=0;_<this._effects.length;_++)this._effects[_].dispose(p)},g.prototype._updateEffects=function(){for(var p=0;p<this._effects.length;p++)this._effects[p].updateEffect()},g.prototype._isReady=function(){for(var p=0;p<this._effects.length;p++)if(!this._effects[p].isReady())return!1;return!0},g}(O.a)},571:function(we,P,u){"use strict";u.d(P,"a",function(){return l});var S=u(434),R=u(440),U=u(436),O=u(444),x=u(502),G=function(){function y(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}return y}(),T=u(530),h=u(547),f=u(435),d="motionBlurPixelShader",g=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float motionStrength;
uniform float motionScale;
uniform vec2 screenSize;
#ifdef OBJECT_BASED
uniform sampler2D velocitySampler;
#else
uniform sampler2D depthSampler;
uniform mat4 inverseViewProjection;
uniform mat4 prevViewProjection;
#endif
void main(void)
{
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
vec2 texelSize=1.0/screenSize;
vec2 velocityColor=texture2D(velocitySampler,vUV).rg*2.0-1.0;
vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0));
velocity*=motionScale*motionStrength;
float speed=length(velocity/texelSize);
int samplesCount=int(clamp(speed,1.0,SAMPLES));
velocity=normalize(velocity)*texelSize;
float hlim=float(-samplesCount)*0.5+0.5;
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(SAMPLES); ++i)
{
if (i>=samplesCount)
break;
vec2 offset=vUV+velocity*(hlim+float(i));
result+=texture2D(textureSampler,offset);
}
gl_FragColor=result/float(samplesCount);
gl_FragColor.a=1.0;
#else
vec2 texelSize=1.0/screenSize;
float depth=texture2D(depthSampler,vUV).r;
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);
cpos=cpos*inverseViewProjection;
vec4 ppos=cpos*prevViewProjection;
ppos.xyz/=ppos.w;
ppos.xy=ppos.xy*0.5+0.5;
vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;
float speed=length(velocity/texelSize);
int nSamples=int(clamp(speed,1.0,SAMPLES));
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(SAMPLES); ++i) {
if (i>=nSamples)
break;
vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
result+=texture2D(textureSampler,offset1);
}
gl_FragColor=result/float(nSamples);
#endif
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;f.a.ShadersStore[d]=g;var p={name:d,shader:g},_=u(439),m=u(437),l=function(y){Object(S.d)(E,y);function E(A,F,B,L,I,z,k,j,w,Q){j===void 0&&(j=0),w===void 0&&(w=!1),Q===void 0&&(Q=!1);var W=y.call(this,A,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection"],["velocitySampler"],B,L,I,z,k,`#define GEOMETRY_SUPPORTED
#define SAMPLES 64.0
#define OBJECT_BASED`,j,void 0,null,w)||this;return W.motionStrength=1,W._motionBlurSamples=32,W._isObjectBased=!0,W._forceGeometryBuffer=!1,W._geometryBufferRenderer=null,W._prePassRenderer=null,W._invViewProjection=null,W._previousViewProjection=null,W._forceGeometryBuffer=Q,W._forceGeometryBuffer?(W._geometryBufferRenderer=F.enableGeometryBufferRenderer(),W._geometryBufferRenderer&&(W._geometryBufferRenderer.enableVelocity=!0)):(W._prePassRenderer=F.enablePrePassRenderer(),W._prePassRenderer&&(W._prePassRenderer.markAsDirty(),W._prePassEffectConfiguration=new G)),W._applyMode(),W}return Object.defineProperty(E.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(A){this._motionBlurSamples=A,this._updateEffect()},enumerable:!1,configurable:!0}),Object.defineProperty(E.prototype,"isObjectBased",{get:function(){return this._isObjectBased},set:function(A){this._isObjectBased!==A&&(this._isObjectBased=A,this._applyMode())},enumerable:!1,configurable:!0}),E.prototype.getClassName=function(){return"MotionBlurPostProcess"},E.prototype.excludeSkinnedMesh=function(A){if(A.skeleton){var F=void 0;if(this._geometryBufferRenderer)F=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)F=this._prePassRenderer.excludedSkinnedMesh;else return;F.push(A)}},E.prototype.removeExcludedSkinnedMesh=function(A){if(A.skeleton){var F=void 0;if(this._geometryBufferRenderer)F=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)F=this._prePassRenderer.excludedSkinnedMesh;else return;var B=F.indexOf(A);B!==-1&&F.splice(B,1)}},E.prototype.dispose=function(A){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),y.prototype.dispose.call(this,A)},E.prototype._applyMode=function(){var A=this;if(!this._geometryBufferRenderer&&!this._prePassRenderer)return R.a.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=function(F){return A._onApplyObjectBased(F)}):(this._invViewProjection=U.a.Identity(),this._previousViewProjection=U.a.Identity(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=function(F){return A._onApplyScreenBased(F)})},E.prototype._onApplyObjectBased=function(A){if(A.setVector2("screenSize",new U.d(this.width,this.height)),A.setFloat("motionScale",this._scene.getAnimationRatio()),A.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){var F=this._geometryBufferRenderer.getTextureIndex(x.a.VELOCITY_TEXTURE_TYPE);A.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[F])}else if(this._prePassRenderer){var F=this._prePassRenderer.getIndex(2);A.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[F])}},E.prototype._onApplyScreenBased=function(A){var F=this._scene.getProjectionMatrix().multiply(this._scene.getViewMatrix());if(F.invertToRef(this._invViewProjection),A.setMatrix("inverseViewProjection",this._invViewProjection),A.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection=F,A.setVector2("screenSize",new U.d(this.width,this.height)),A.setFloat("motionScale",this._scene.getAnimationRatio()),A.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){var B=this._geometryBufferRenderer.getTextureIndex(x.a.DEPTH_TEXTURE_TYPE);A.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[B])}else if(this._prePassRenderer){var B=this._prePassRenderer.getIndex(5);A.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[B])}},E.prototype._updateEffect=function(){if(this._geometryBufferRenderer||this._prePassRenderer){var A=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(A.join(`
`))}},E._Parse=function(A,F,B,L){return _.a.Parse(function(){return new E(A.name,B,A.options,F,A.renderTargetSamplingMode,B.getEngine(),A.reusable,A.textureType,!1)},A,B,L)},Object(S.c)([Object(_.c)()],E.prototype,"motionStrength",void 0),Object(S.c)([Object(_.c)()],E.prototype,"motionBlurSamples",null),Object(S.c)([Object(_.c)()],E.prototype,"isObjectBased",null),E}(O.a);m.a.RegisteredTypes["BABYLON.MotionBlurPostProcess"]=l},572:function(we,P,u){"use strict";u.d(P,"a",function(){return d});var S=u(436),R=u(441),U=u(483),O=u(700),x=Object.freeze(new S.b(0,0,0,0)),G=Object.freeze(S.e.Zero()),T=Object.freeze(S.d.Zero()),h=Object.freeze(O.a.Zero()),f=Object.freeze(R.a.Black()),d=function(){function g(p,_,m,l){var y=this;if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=_,this._target=p,this._scene=m,this._host=l,this._activeTargets=[],_._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===U.a.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=S.a.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){var E={frame:0,value:this._minValue};this._keys.splice(0,0,E)}if(this._target instanceof Array){for(var A=0,F=0,B=this._target;F<B.length;F++){var L=B[F];this._preparePath(L,A),this._getOriginalValues(A),A++}this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];var I=_.getEvents();I&&I.length>0&&I.forEach(function(z){y._events.push(z._clone())}),this._enableBlending=p&&p.animationPropertiesOverride?p.animationPropertiesOverride.enableBlending:this._animation.enableBlending}return Object.defineProperty(g.prototype,"currentFrame",{get:function(){return this._currentFrame},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"weight",{get:function(){return this._weight},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"currentValue",{get:function(){return this._currentValue},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"targetPath",{get:function(){return this._targetPath},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"target",{get:function(){return this._currentActiveTarget},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"isAdditive",{get:function(){return this._host&&this._host.isAdditive},enumerable:!1,configurable:!0}),g.prototype._preparePath=function(p,_){_===void 0&&(_=0);var m=this._animation.targetPropertyPath;if(m.length>1){for(var l=p[m[0]],y=1;y<m.length-1;y++)l=l[m[y]];this._targetPath=m[m.length-1],this._activeTargets[_]=l}else this._targetPath=m[0],this._activeTargets[_]=p},Object.defineProperty(g.prototype,"animation",{get:function(){return this._animation},enumerable:!1,configurable:!0}),g.prototype.reset=function(p){if(p===void 0&&(p=!1),p)if(this._target instanceof Array)for(var _=0,m=0,l=this._target;m<l.length;m++){var y=l[m];this._originalValue[_]!==void 0&&this._setValue(y,this._activeTargets[_],this._originalValue[_],-1,_),_++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(var _=0;_<this._events.length;_++)this._events[_].isDone=!1},g.prototype.isStopped=function(){return this._stopped},g.prototype.dispose=function(){var p=this._animation.runtimeAnimations.indexOf(this);p>-1&&this._animation.runtimeAnimations.splice(p,1)},g.prototype.setValue=function(p,_){if(this._targetIsArray){for(var m=0;m<this._target.length;m++){var l=this._target[m];this._setValue(l,this._activeTargets[m],p,_,m)}return}this._setValue(this._target,this._directTarget,p,_,0)},g.prototype._getOriginalValues=function(p){p===void 0&&(p=0);var _,m=this._activeTargets[p];m.getRestPose&&this._targetPath==="_matrix"?_=m.getRestPose():_=m[this._targetPath],_&&_.clone?this._originalValue[p]=_.clone():this._originalValue[p]=_},g.prototype._setValue=function(p,_,m,l,y){if(this._currentActiveTarget=_,this._weight=l,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){var E=_[this._targetPath];E.clone?this._originalBlendValue=E.clone():this._originalBlendValue=E}this._originalBlendValue.m?U.a.AllowMatrixDecomposeForInterpolation?this._currentValue?S.a.DecomposeLerpToRef(this._originalBlendValue,m,this._blendingFactor,this._currentValue):this._currentValue=S.a.DecomposeLerp(this._originalBlendValue,m,this._blendingFactor):this._currentValue?S.a.LerpToRef(this._originalBlendValue,m,this._blendingFactor,this._currentValue):this._currentValue=S.a.Lerp(this._originalBlendValue,m,this._blendingFactor):this._currentValue=U.a._UniversalLerp(this._originalBlendValue,m,this._blendingFactor);var A=p&&p.animationPropertiesOverride?p.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=A}else this._currentValue=m;l!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[y]):_[this._targetPath]=this._currentValue,p.markAsDirty&&p.markAsDirty(this._animation.targetProperty)},g.prototype._getCorrectLoopMode=function(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode},g.prototype.goToFrame=function(p){var _=this._animation.getKeys();p<_[0].frame?p=_[0].frame:p>_[_.length-1].frame&&(p=_[_.length-1].frame);var m=this._events;if(m.length)for(var l=0;l<m.length;l++)m[l].onlyOnce||(m[l].isDone=m[l].frame<p);this._currentFrame=p;var y=this._animation._interpolate(p,this._animationState);this.setValue(y,-1)},g.prototype._prepareForSpeedRatioChange=function(p){var _=this._previousDelay*(this._animation.framePerSecond*p)/1e3;this._ratioOffset=this._previousRatio-_},g.prototype.animate=function(p,_,m,l,y,E){E===void 0&&(E=-1);var A=this._animation,F=A.targetPropertyPath;if(!F||F.length<1)return this._stopped=!0,!1;var B=!0;(_<this._minFrame||_>this._maxFrame)&&(_=this._minFrame),(m<this._minFrame||m>this._maxFrame)&&(m=this._maxFrame);var L=m-_,I,z=p*(A.framePerSecond*y)/1e3+this._ratioOffset,k=0;if(this._previousDelay=p,this._previousRatio=z,!l&&m>=_&&z>=L)B=!1,k=A._getKeyValue(this._maxValue);else if(!l&&_>=m&&z<=L)B=!1,k=A._getKeyValue(this._minValue);else if(this._animationState.loopMode!==U.a.ANIMATIONLOOPMODE_CYCLE){var j=m.toString()+_.toString();if(!this._offsetsCache[j]){this._animationState.repeatCount=0,this._animationState.loopMode=U.a.ANIMATIONLOOPMODE_CYCLE;var w=A._interpolate(_,this._animationState),Q=A._interpolate(m,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),A.dataType){case U.a.ANIMATIONTYPE_FLOAT:this._offsetsCache[j]=Q-w;break;case U.a.ANIMATIONTYPE_QUATERNION:this._offsetsCache[j]=Q.subtract(w);break;case U.a.ANIMATIONTYPE_VECTOR3:this._offsetsCache[j]=Q.subtract(w);break;case U.a.ANIMATIONTYPE_VECTOR2:this._offsetsCache[j]=Q.subtract(w);break;case U.a.ANIMATIONTYPE_SIZE:this._offsetsCache[j]=Q.subtract(w);break;case U.a.ANIMATIONTYPE_COLOR3:this._offsetsCache[j]=Q.subtract(w);break;default:break}this._highLimitsCache[j]=Q}k=this._highLimitsCache[j],I=this._offsetsCache[j]}if(I===void 0)switch(A.dataType){case U.a.ANIMATIONTYPE_FLOAT:I=0;break;case U.a.ANIMATIONTYPE_QUATERNION:I=x;break;case U.a.ANIMATIONTYPE_VECTOR3:I=G;break;case U.a.ANIMATIONTYPE_VECTOR2:I=T;break;case U.a.ANIMATIONTYPE_SIZE:I=h;break;case U.a.ANIMATIONTYPE_COLOR3:I=f}var W;if(this._host&&this._host.syncRoot){var Y=this._host.syncRoot,he=(Y.masterFrame-Y.fromFrame)/(Y.toFrame-Y.fromFrame);W=_+(m-_)*he}else W=B&&L!==0?_+z%L:m;var le=this._events;if((L>0&&this.currentFrame>W||L<0&&this.currentFrame<W)&&(this._onLoop(),le.length))for(var J=0;J<le.length;J++)le[J].onlyOnce||(le[J].isDone=!1);this._currentFrame=W,this._animationState.repeatCount=L===0?0:z/L>>0,this._animationState.highLimitValue=k,this._animationState.offsetValue=I;var Re=A._interpolate(W,this._animationState);if(this.setValue(Re,E),le.length){for(var J=0;J<le.length;J++)if(L>0&&W>=le[J].frame&&le[J].frame>=_||L<0&&W<=le[J].frame&&le[J].frame<=_){var Me=le[J];Me.isDone||(Me.onlyOnce&&(le.splice(J,1),J--),Me.isDone=!0,Me.action(W))}}return B||(this._stopped=!0),B},g}()},573:function(we,P,u){"use strict";u.d(P,"a",function(){return p});var S=u(434),R=u(438),U=u(436),O=u(499),x=u(446),G=u(494),T=u(505),h=u(471),f=u(461),d=u(455),g=u(441),p=function(_){Object(S.d)(m,_);function m(l,y,E,A,F){y===void 0&&(y=g.a.Gray()),E===void 0&&(E=f.a.DefaultUtilityLayer),A===void 0&&(A=null),F===void 0&&(F=1);var B,L=_.call(this,E)||this;L._pointerObserver=null,L.snapDistance=0,L.onSnapObservable=new R.c,L._isEnabled=!0,L._parent=null,L._dragging=!1,L._parent=A,L._coloredMaterial=new d.a("",E.utilityLayerScene),L._coloredMaterial.diffuseColor=y,L._coloredMaterial.specularColor=y.subtract(new g.a(.1,.1,.1)),L._hoverMaterial=new d.a("",E.utilityLayerScene),L._hoverMaterial.diffuseColor=g.a.Yellow(),L._disableMaterial=new d.a("",E.utilityLayerScene),L._disableMaterial.diffuseColor=g.a.Gray(),L._disableMaterial.alpha=.4;var I=m._CreateArrow(E.utilityLayerScene,L._coloredMaterial,F),z=m._CreateArrow(E.utilityLayerScene,L._coloredMaterial,F+4,!0);L._gizmoMesh=new x.a("",E.utilityLayerScene),L._gizmoMesh.addChild(I),L._gizmoMesh.addChild(z),L._gizmoMesh.lookAt(L._rootMesh.position.add(l)),L._gizmoMesh.scaling.scaleInPlace(1/3),L._gizmoMesh.parent=L._rootMesh;var k=0,j=new U.e,w={snapDistance:0};L.dragBehavior=new T.a({dragAxis:l}),L.dragBehavior.moveAttached=!1,L._rootMesh.addBehavior(L.dragBehavior),L.dragBehavior.onDragObservable.add(function(Y){if(L.attachedNode){if(L.snapDistance==0)L.attachedNode.position&&L.attachedNode.position.addInPlaceFromFloats(Y.delta.x,Y.delta.y,Y.delta.z),L.attachedNode.getWorldMatrix().addTranslationFromFloats(Y.delta.x,Y.delta.y,Y.delta.z),L.attachedNode.updateCache();else if(k+=Y.dragDistance,Math.abs(k)>L.snapDistance){var he=Math.floor(Math.abs(k)/L.snapDistance);k=k%L.snapDistance,Y.delta.normalizeToRef(j),j.scaleInPlace(L.snapDistance*he),L.attachedNode.getWorldMatrix().addTranslationFromFloats(j.x,j.y,j.z),L.attachedNode.updateCache(),w.snapDistance=L.snapDistance*he,L.onSnapObservable.notifyObservers(w)}L._matrixChanged()}}),L.dragBehavior.onDragStartObservable.add(function(){L._dragging=!0}),L.dragBehavior.onDragEndObservable.add(function(){L._dragging=!1});var Q=E._getSharedGizmoLight();Q.includedOnlyMeshes=Q.includedOnlyMeshes.concat(L._rootMesh.getChildMeshes(!1));var W={gizmoMeshes:I.getChildMeshes(),colliderMeshes:z.getChildMeshes(),material:L._coloredMaterial,hoverMaterial:L._hoverMaterial,disableMaterial:L._disableMaterial,active:!1};return(B=L._parent)===null||B===void 0||B.addToAxisCache(z,W),L._pointerObserver=E.utilityLayerScene.onPointerObservable.add(function(Y){var he;if(!L._customMeshSet&&(L._isHovered=W.colliderMeshes.indexOf((he=Y==null?void 0:Y.pickInfo)===null||he===void 0?void 0:he.pickedMesh)!=-1,!L._parent)){var le=L._isHovered||L._dragging?L._hoverMaterial:L._coloredMaterial;W.gizmoMeshes.forEach(function(J){J.material=le,J.color&&(J.color=le.diffuseColor)})}}),L}return m._CreateArrow=function(l,y,E,A){E===void 0&&(E=1),A===void 0&&(A=!1);var F=new O.a("arrow",l),B=G.a.CreateCylinder("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(E-1)/4),tessellation:96},l),L=G.a.CreateCylinder("cylinder",{diameterTop:.005*E,height:.275,diameterBottom:.005*E,tessellation:96},l);return B.parent=F,B.material=y,B.rotation.x=Math.PI/2,B.position.z+=.3,L.parent=F,L.material=y,L.position.z+=.275/2,L.rotation.x=Math.PI/2,A&&(L.visibility=0,B.visibility=0),F},m._CreateArrowInstance=function(l,y){for(var E=new O.a("arrow",l),A=0,F=y.getChildMeshes();A<F.length;A++){var B=F[A],L=B.createInstance(B.name);L.parent=E}return E},m.prototype._attachedNodeChanged=function(l){this.dragBehavior&&(this.dragBehavior.enabled=!!l)},Object.defineProperty(m.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(l){this._isEnabled=l,l?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)},enumerable:!1,configurable:!0}),m.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(l){l&&l.dispose()}),_.prototype.dispose.call(this)},m}(h.a)},574:function(we,P,u){"use strict";var S=u(456),R=u(440),U=u(467);U.a.prototype.restoreSingleAttachment=function(){var O=this._gl;this.bindAttachments([O.BACK])},U.a.prototype.restoreSingleAttachmentForRenderTarget=function(){var O=this._gl;this.bindAttachments([O.COLOR_ATTACHMENT0])},U.a.prototype.buildTextureLayout=function(O){for(var x=this._gl,G=[],T=0;T<O.length;T++)O[T]?G.push(x["COLOR_ATTACHMENT"+T]):G.push(x.NONE);return G},U.a.prototype.bindAttachments=function(O){var x=this._gl;x.drawBuffers(O)},U.a.prototype.clearAttachments=function(O,x,G,T,h){if(O.length!==0){var f=this._gl;f.drawBuffers([O[0]]),this.clear(x,x!==null,T,h);var d=O[0];O[0]=f.NONE,f.drawBuffers(O),this.clear(G,G!==null,!1,!1),O[0]=d}},U.a.prototype.unBindMultiColorAttachmentFramebuffer=function(O,x,G){x===void 0&&(x=!1),this._currentRenderTarget=null;var T=this._gl,h=O[0]._attachments,f=h.length;if(O[0]._MSAAFramebuffer){T.bindFramebuffer(T.READ_FRAMEBUFFER,O[0]._MSAAFramebuffer),T.bindFramebuffer(T.DRAW_FRAMEBUFFER,O[0]._framebuffer);for(var d=0;d<f;d++){for(var g=O[d],p=0;p<f;p++)h[p]=T.NONE;h[d]=T[this.webGLVersion>1?"COLOR_ATTACHMENT"+d:"COLOR_ATTACHMENT"+d+"_WEBGL"],T.readBuffer(h[d]),T.drawBuffers(h),T.blitFramebuffer(0,0,g.width,g.height,0,0,g.width,g.height,T.COLOR_BUFFER_BIT,T.NEAREST)}for(var d=0;d<f;d++)h[d]=T[this.webGLVersion>1?"COLOR_ATTACHMENT"+d:"COLOR_ATTACHMENT"+d+"_WEBGL"];T.drawBuffers(h)}for(var d=0;d<f;d++){var g=O[d];g.generateMipMaps&&!x&&!g.isCube&&(this._bindTextureDirectly(T.TEXTURE_2D,g,!0),T.generateMipmap(T.TEXTURE_2D),this._bindTextureDirectly(T.TEXTURE_2D,null))}G&&(O[0]._MSAAFramebuffer&&this._bindUnboundFramebuffer(O[0]._framebuffer),G()),this._bindUnboundFramebuffer(null)},U.a.prototype.createMultipleRenderTarget=function(O,x,G){G===void 0&&(G=!0);var T=!1,h=!0,f=!1,d=!1,g=1,p=0,_=3,m=new Array,l=new Array;x!==void 0&&(T=x.generateMipMaps===void 0?!1:x.generateMipMaps,h=x.generateDepthBuffer===void 0?!0:x.generateDepthBuffer,f=x.generateStencilBuffer===void 0?!1:x.generateStencilBuffer,d=x.generateDepthTexture===void 0?!1:x.generateDepthTexture,g=x.textureCount||1,x.types&&(m=x.types),x.samplingModes&&(l=x.samplingModes));var y=this._gl,E=y.createFramebuffer();this._bindUnboundFramebuffer(E);for(var A=O.width||O,F=O.height||O,B=[],L=[],I=this._setupFramebufferDepthAttachments(f,h,A,F),z=0;z<g;z++){var k=l[z]||_,j=m[z]||p;(j===1&&!this._caps.textureFloatLinearFiltering||j===2&&!this._caps.textureHalfFloatLinearFiltering)&&(k=1);var w=this._getSamplingParameters(k,T);j===1&&!this._caps.textureFloat&&(j=0,R.a.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var Q=new S.a(this,S.b.MultiRenderTarget),W=y[this.webGLVersion>1?"COLOR_ATTACHMENT"+z:"COLOR_ATTACHMENT"+z+"_WEBGL"];B.push(Q),L.push(W),y.activeTexture(y["TEXTURE"+z]),y.bindTexture(y.TEXTURE_2D,Q._hardwareTexture.underlyingResource),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,w.mag),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,w.min),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texImage2D(y.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(j),A,F,0,y.RGBA,this._getWebGLTextureType(j),null),y.framebufferTexture2D(y.DRAW_FRAMEBUFFER,W,y.TEXTURE_2D,Q._hardwareTexture.underlyingResource,0),T&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(y.TEXTURE_2D,null),Q._framebuffer=E,Q._depthStencilBuffer=I,Q.baseWidth=A,Q.baseHeight=F,Q.width=A,Q.height=F,Q.isReady=!0,Q.samples=1,Q.generateMipMaps=T,Q.samplingMode=k,Q.type=j,Q._generateDepthBuffer=h,Q._generateStencilBuffer=f,Q._attachments=L,Q._textureArray=B,this._internalTexturesCache.push(Q)}if(d&&this._caps.depthTextureExtension){var Y=new S.a(this,S.b.MultiRenderTarget);y.activeTexture(y.TEXTURE0),y.bindTexture(y.TEXTURE_2D,Y._hardwareTexture.underlyingResource),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,y.NEAREST),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,y.NEAREST),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texImage2D(y.TEXTURE_2D,0,this.webGLVersion<2?y.DEPTH_COMPONENT:y.DEPTH_COMPONENT16,A,F,0,y.DEPTH_COMPONENT,y.UNSIGNED_SHORT,null),y.framebufferTexture2D(y.FRAMEBUFFER,y.DEPTH_ATTACHMENT,y.TEXTURE_2D,Y._hardwareTexture.underlyingResource,0),Y._framebuffer=E,Y.baseWidth=A,Y.baseHeight=F,Y.width=A,Y.height=F,Y.isReady=!0,Y.samples=1,Y.generateMipMaps=T,Y.samplingMode=y.NEAREST,Y._generateDepthBuffer=h,Y._generateStencilBuffer=f,B.push(Y),this._internalTexturesCache.push(Y)}return G&&y.drawBuffers(L),this._bindUnboundFramebuffer(null),this.resetTextureCache(),B},U.a.prototype.updateMultipleRenderTargetTextureSampleCount=function(O,x,G){if(G===void 0&&(G=!0),this.webGLVersion<2||!O)return 1;if(O[0].samples===x)return x;var T=O[0]._attachments.length;if(T===0)return 1;var h=this._gl;x=Math.min(x,this.getCaps().maxMSAASamples),O[0]._depthStencilBuffer&&(h.deleteRenderbuffer(O[0]._depthStencilBuffer),O[0]._depthStencilBuffer=null),O[0]._MSAAFramebuffer&&(h.deleteFramebuffer(O[0]._MSAAFramebuffer),O[0]._MSAAFramebuffer=null);for(var f=0;f<T;f++)O[f]._MSAARenderBuffer&&(h.deleteRenderbuffer(O[f]._MSAARenderBuffer),O[f]._MSAARenderBuffer=null);if(x>1&&h.renderbufferStorageMultisample){var d=h.createFramebuffer();if(!d)throw new Error("Unable to create multi sampled framebuffer");this._bindUnboundFramebuffer(d);for(var g=this._setupFramebufferDepthAttachments(O[0]._generateStencilBuffer,O[0]._generateDepthBuffer,O[0].width,O[0].height,x),p=[],f=0;f<T;f++){var _=O[f],m=h[this.webGLVersion>1?"COLOR_ATTACHMENT"+f:"COLOR_ATTACHMENT"+f+"_WEBGL"],l=h.createRenderbuffer();if(!l)throw new Error("Unable to create multi sampled framebuffer");h.bindRenderbuffer(h.RENDERBUFFER,l),h.renderbufferStorageMultisample(h.RENDERBUFFER,x,this._getRGBAMultiSampleBufferFormat(_.type),_.width,_.height),h.framebufferRenderbuffer(h.FRAMEBUFFER,m,h.RENDERBUFFER,l),_._MSAAFramebuffer=d,_._MSAARenderBuffer=l,_.samples=x,_._depthStencilBuffer=g,h.bindRenderbuffer(h.RENDERBUFFER,null),p.push(m)}G&&h.drawBuffers(p)}else this._bindUnboundFramebuffer(O[0]._framebuffer);return this._bindUnboundFramebuffer(null),x}},575:function(we,P,u){"use strict";u.d(P,"a",function(){return S});var S=function(){function R(U){this._pendingActions=new Array,this._workerInfos=U.map(function(O){return{worker:O,active:!1}})}return R.prototype.dispose=function(){for(var U=0,O=this._workerInfos;U<O.length;U++){var x=O[U];x.worker.terminate()}this._workerInfos=[],this._pendingActions=[]},R.prototype.push=function(U){for(var O=0,x=this._workerInfos;O<x.length;O++){var G=x[O];if(!G.active){this._execute(G,U);return}}this._pendingActions.push(U)},R.prototype._execute=function(U,O){var x=this;U.active=!0,O(U.worker,function(){U.active=!1;var G=x._pendingActions.shift();G&&x._execute(U,G)})},R}()},576:function(we,P,u){"use strict";u.d(P,"a",function(){return x});var S=u(451),R=u(452),U=u(516),O=u(468);O.a.AddParser(R.a.NAME_EFFECTLAYER,function(G,T,h,f){if(G.effectLayers){h.effectLayers||(h.effectLayers=new Array);for(var d=0;d<G.effectLayers.length;d++){var g=U.a.Parse(G.effectLayers[d],T,f);h.effectLayers.push(g)}}}),O.a.prototype.removeEffectLayer=function(G){var T=this.effectLayers.indexOf(G);return T!==-1&&this.effectLayers.splice(T,1),T},O.a.prototype.addEffectLayer=function(G){this.effectLayers.push(G)};var x=function(){function G(T){this.name=R.a.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=T,this._engine=T.getEngine(),T.effectLayers=new Array}return G.prototype.register=function(){this.scene._isReadyForMeshStage.registerStep(R.a.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(R.a.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(R.a.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(R.a.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(R.a.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(R.a.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)},G.prototype.rebuild=function(){for(var T=this.scene.effectLayers,h=0,f=T;h<f.length;h++){var d=f[h];d._rebuild()}},G.prototype.serialize=function(T){T.effectLayers=[];for(var h=this.scene.effectLayers,f=0,d=h;f<d.length;f++){var g=d[f];g.serialize&&T.effectLayers.push(g.serialize())}},G.prototype.addFromContainer=function(T){var h=this;!T.effectLayers||T.effectLayers.forEach(function(f){h.scene.addEffectLayer(f)})},G.prototype.removeFromContainer=function(T,h){var f=this;!T.effectLayers||T.effectLayers.forEach(function(d){f.scene.removeEffectLayer(d),h&&d.dispose()})},G.prototype.dispose=function(){for(var T=this.scene.effectLayers;T.length;)T[0].dispose()},G.prototype._isReadyForMesh=function(T,h){for(var f=this.scene.effectLayers,d=0,g=f;d<g.length;d++){var p=g[d];if(!!p.hasMesh(T))for(var _=0,m=T.subMeshes;_<m.length;_++){var l=m[_];if(!p.isReady(l,h))return!1}}return!0},G.prototype._renderMainTexture=function(T){this._renderEffects=!1,this._needStencil=!1;var h=!1,f=this.scene.effectLayers;if(f&&f.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(var d=0,g=f;d<g.length;d++){var p=g[d];if(p.shouldRender()&&(!p.camera||p.camera.cameraRigMode===S.a.RIG_MODE_NONE&&T===p.camera||p.camera.cameraRigMode!==S.a.RIG_MODE_NONE&&p.camera._rigCameras.indexOf(T)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||p.needStencil();var _=p._mainTexture;_._shouldRender()&&(this.scene.incrementRenderId(),_.render(!1,!1),h=!0)}}this.scene.incrementRenderId()}return h},G.prototype._setStencil=function(){this._needStencil&&this._engine.setStencilBuffer(!0)},G.prototype._setStencilBack=function(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)},G.prototype._draw=function(T){if(this._renderEffects){this._engine.setDepthBuffer(!1);for(var h=this.scene.effectLayers,f=0;f<h.length;f++){var d=h[f];d.renderingGroupId===T&&d.shouldRender()&&d.render()}this._engine.setDepthBuffer(!0)}},G.prototype._drawCamera=function(){this._renderEffects&&this._draw(-1)},G.prototype._drawRenderingGroup=function(T){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(T)},G}();U.a._SceneComponentInitialization=function(G){var T=G._getComponent(R.a.NAME_EFFECTLAYER);T||(T=new x(G),G._addComponent(T))}},577:function(we,P,u){"use strict";u.d(P,"a",function(){return E});var S=u(434),R=u(439),U=u(436),O=u(447),x=u(442),G=u(458),T=u(459),h=u(472),f=u(516),d=u(468),g=u(437),p=u(445),_=u(441),m=u(646),l=u(647),y=u(576);d.a.prototype.getGlowLayerByName=function(A){for(var F=0;F<this.effectLayers.length;F++)if(this.effectLayers[F].name===A&&this.effectLayers[F].getEffectName()===E.EffectName)return this.effectLayers[F];return null};var E=function(A){Object(S.d)(F,A);function F(B,L,I){var z=A.call(this,B,L)||this;return z._intensity=1,z._includedOnlyMeshes=[],z._excludedMeshes=[],z._meshesUsingTheirOwnMaterials=[],z.neutralColor=new _.b(0,0,0,1),z._options=Object(S.a)({mainTextureRatio:F.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1},I),z._init({alphaBlendingMode:1,camera:z._options.camera,mainTextureFixedSize:z._options.mainTextureFixedSize,mainTextureRatio:z._options.mainTextureRatio,renderingGroupId:z._options.renderingGroupId}),z}return Object.defineProperty(F.prototype,"blurKernelSize",{get:function(){return this._horizontalBlurPostprocess1.kernel},set:function(B){this._horizontalBlurPostprocess1.kernel=B,this._verticalBlurPostprocess1.kernel=B,this._horizontalBlurPostprocess2.kernel=B,this._verticalBlurPostprocess2.kernel=B},enumerable:!1,configurable:!0}),Object.defineProperty(F.prototype,"intensity",{get:function(){return this._intensity},set:function(B){this._intensity=B},enumerable:!1,configurable:!0}),F.prototype.getEffectName=function(){return F.EffectName},F.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[O.b.PositionKind],["offset"],["textureSampler","textureSampler2"],`#define EMISSIVE 
`)},F.prototype._createTextureAndPostProcesses=function(){var B=this,L=this._mainTextureDesiredSize.width,I=this._mainTextureDesiredSize.height;L=this._engine.needPOTTextures?p.a.GetExponentOfTwo(L,this._maxSize):L,I=this._engine.needPOTTextures?p.a.GetExponentOfTwo(I,this._maxSize):I;var z=0;this._engine.getCaps().textureHalfFloatRender?z=2:z=0,this._blurTexture1=new G.a("GlowLayerBlurRTT",{width:L,height:I},this._scene,!1,!0,z),this._blurTexture1.wrapU=x.a.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=x.a.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(x.a.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;var k=Math.floor(L/2),j=Math.floor(I/2);this._blurTexture2=new G.a("GlowLayerBlurRTT2",{width:k,height:j},this._scene,!1,!0,z),this._blurTexture2.wrapU=x.a.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=x.a.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(x.a.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2],this._horizontalBlurPostprocess1=new h.a("GlowLayerHBP1",new U.d(1,0),this._options.blurKernelSize/2,{width:L,height:I},null,x.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,z),this._horizontalBlurPostprocess1.width=L,this._horizontalBlurPostprocess1.height=I,this._horizontalBlurPostprocess1.onApplyObservable.add(function(w){w.setTexture("textureSampler",B._mainTexture)}),this._verticalBlurPostprocess1=new h.a("GlowLayerVBP1",new U.d(0,1),this._options.blurKernelSize/2,{width:L,height:I},null,x.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,z),this._horizontalBlurPostprocess2=new h.a("GlowLayerHBP2",new U.d(1,0),this._options.blurKernelSize/2,{width:k,height:j},null,x.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,z),this._horizontalBlurPostprocess2.width=k,this._horizontalBlurPostprocess2.height=j,this._horizontalBlurPostprocess2.onApplyObservable.add(function(w){w.setTexture("textureSampler",B._blurTexture1)}),this._verticalBlurPostprocess2=new h.a("GlowLayerVBP2",new U.d(0,1),this._options.blurKernelSize/2,{width:k,height:j},null,x.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,z),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(function(){var w=B._blurTexture1.getInternalTexture();if(w){B._scene.postProcessManager.directRender(B._postProcesses1,w,!0);var Q=B._blurTexture2.getInternalTexture();Q&&B._scene.postProcessManager.directRender(B._postProcesses2,Q,!0),B._engine.unBindFramebuffer(Q!=null?Q:w,!0)}}),this._postProcesses.map(function(w){w.autoClear=!1})},F.prototype.isReady=function(B,L){var I=B.getMaterial(),z=B.getRenderingMesh();if(!I||!z)return!1;var k=I.emissiveTexture;return A.prototype._isReady.call(this,B,L,k)},F.prototype.needStencil=function(){return!1},F.prototype._canRenderMesh=function(B,L){return!0},F.prototype._internalRender=function(B){B.setTexture("textureSampler",this._blurTexture1),B.setTexture("textureSampler2",this._blurTexture2),B.setFloat("offset",this._intensity);var L=this._engine,I=L.getStencilBuffer();L.setStencilBuffer(!1),L.drawElementsType(T.a.TriangleFillMode,0,6),L.setStencilBuffer(I)},F.prototype._setEmissiveTextureAndColor=function(B,L,I){var z=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(B,L,I):I?(this._emissiveTextureAndColor.texture=I.emissiveTexture,this._emissiveTextureAndColor.texture&&(z=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(B,L,I,this._emissiveTextureAndColor.color):I.emissiveColor?this._emissiveTextureAndColor.color.set(I.emissiveColor.r*z,I.emissiveColor.g*z,I.emissiveColor.b*z,I.alpha):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)},F.prototype._shouldRenderMesh=function(B){return this.hasMesh(B)},F.prototype._addCustomEffectDefines=function(B){B.push("#define GLOW")},F.prototype.addExcludedMesh=function(B){this._excludedMeshes.indexOf(B.uniqueId)===-1&&this._excludedMeshes.push(B.uniqueId)},F.prototype.removeExcludedMesh=function(B){var L=this._excludedMeshes.indexOf(B.uniqueId);L!==-1&&this._excludedMeshes.splice(L,1)},F.prototype.addIncludedOnlyMesh=function(B){this._includedOnlyMeshes.indexOf(B.uniqueId)===-1&&this._includedOnlyMeshes.push(B.uniqueId)},F.prototype.removeIncludedOnlyMesh=function(B){var L=this._includedOnlyMeshes.indexOf(B.uniqueId);L!==-1&&this._includedOnlyMeshes.splice(L,1)},F.prototype.hasMesh=function(B){return A.prototype.hasMesh.call(this,B)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(B.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(B.uniqueId)===-1:!0:!1},F.prototype._useMeshMaterial=function(B){return this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(B.uniqueId)>-1},F.prototype.referenceMeshToUseItsOwnMaterial=function(B){this._meshesUsingTheirOwnMaterials.push(B.uniqueId)},F.prototype.unReferenceMeshFromUsingItsOwnMaterial=function(B){for(var L=this._meshesUsingTheirOwnMaterials.indexOf(B.uniqueId);L>=0;)this._meshesUsingTheirOwnMaterials.splice(L,1),L=this._meshesUsingTheirOwnMaterials.indexOf(B.uniqueId)},F.prototype._disposeMesh=function(B){this.removeIncludedOnlyMesh(B),this.removeExcludedMesh(B)},F.prototype.getClassName=function(){return"GlowLayer"},F.prototype.serialize=function(){var B=R.a.Serialize(this);B.customType="BABYLON.GlowLayer";var L;if(B.includedMeshes=[],this._includedOnlyMeshes.length)for(L=0;L<this._includedOnlyMeshes.length;L++){var I=this._scene.getMeshByUniqueID(this._includedOnlyMeshes[L]);I&&B.includedMeshes.push(I.id)}if(B.excludedMeshes=[],this._excludedMeshes.length)for(L=0;L<this._excludedMeshes.length;L++){var I=this._scene.getMeshByUniqueID(this._excludedMeshes[L]);I&&B.excludedMeshes.push(I.id)}return B},F.Parse=function(B,L,I){var z=R.a.Parse(function(){return new F(B.name,L,B.options)},B,L,I),k;for(k=0;k<B.excludedMeshes.length;k++){var j=L.getMeshByID(B.excludedMeshes[k]);j&&z.addExcludedMesh(j)}for(k=0;k<B.includedMeshes.length;k++){var j=L.getMeshByID(B.includedMeshes[k]);j&&z.addIncludedOnlyMesh(j)}return z},F.EffectName="GlowLayer",F.DefaultBlurKernelSize=32,F.DefaultTextureRatio=.5,Object(S.c)([Object(R.c)()],F.prototype,"blurKernelSize",null),Object(S.c)([Object(R.c)()],F.prototype,"intensity",null),Object(S.c)([Object(R.c)("options")],F.prototype,"_options",void 0),F}(f.a);g.a.RegisteredTypes["BABYLON.GlowLayer"]=E},578:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(434),R=u(466),U=u(584),O=u(472),x=u(585),G=u(436),T=u(442),h=function(f){Object(S.d)(d,f);function d(g,p,_,m,l,y){l===void 0&&(l=0),y===void 0&&(y=!1);var E=f.call(this,g.getEngine(),"bloom",function(){return E._effects},!0)||this;return E.bloomScale=p,E._effects=[],E._downscale=new U.a("highlights",1,null,T.a.BILINEAR_SAMPLINGMODE,g.getEngine(),!1,l,y),E._blurX=new O.a("horizontal blur",new G.d(1,0),10,p,null,T.a.BILINEAR_SAMPLINGMODE,g.getEngine(),!1,l,void 0,y),E._blurX.alwaysForcePOT=!0,E._blurX.autoClear=!1,E._blurY=new O.a("vertical blur",new G.d(0,1),10,p,null,T.a.BILINEAR_SAMPLINGMODE,g.getEngine(),!1,l,void 0,y),E._blurY.alwaysForcePOT=!0,E._blurY.autoClear=!1,E.kernel=m,E._effects=[E._downscale,E._blurX,E._blurY],E._merge=new x.a("bloomMerge",E._downscale,E._blurY,_,p,null,T.a.BILINEAR_SAMPLINGMODE,g.getEngine(),!1,l,y),E._merge.autoClear=!1,E._effects.push(E._merge),E}return Object.defineProperty(d.prototype,"threshold",{get:function(){return this._downscale.threshold},set:function(g){this._downscale.threshold=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"weight",{get:function(){return this._merge.weight},set:function(g){this._merge.weight=g},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"kernel",{get:function(){return this._blurX.kernel/this.bloomScale},set:function(g){this._blurX.kernel=g*this.bloomScale,this._blurY.kernel=g*this.bloomScale},enumerable:!1,configurable:!0}),d.prototype.disposeEffects=function(g){for(var p=0;p<this._effects.length;p++)this._effects[p].dispose(g)},d.prototype._updateEffects=function(){for(var g=0;g<this._effects.length;g++)this._effects[g].updateEffect()},d.prototype._isReady=function(){for(var g=0;g<this._effects.length;g++)if(!this._effects[g].isReady())return!1;return!0},d}(R.a)},579:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(436),U=u(444),O=u(600),x=u(437),G=u(439),T=function(h){Object(S.d)(f,h);function f(d,g,p,_,m,l,y,E,A,F){A===void 0&&(A=0),F===void 0&&(F=!1);var B=h.call(this,d,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],_,m,l,y,E,null,A,void 0,null,F)||this;return B.aberrationAmount=30,B.radialIntensity=0,B.direction=new R.d(.707,.707),B.centerPosition=new R.d(.5,.5),B.screenWidth=g,B.screenHeight=p,B.onApplyObservable.add(function(L){L.setFloat("chromatic_aberration",B.aberrationAmount),L.setFloat("screen_width",g),L.setFloat("screen_height",p),L.setFloat("radialIntensity",B.radialIntensity),L.setFloat2("direction",B.direction.x,B.direction.y),L.setFloat2("centerPosition",B.centerPosition.x,B.centerPosition.y)}),B}return f.prototype.getClassName=function(){return"ChromaticAberrationPostProcess"},f._Parse=function(d,g,p,_){return G.a.Parse(function(){return new f(d.name,d.screenWidth,d.screenHeight,d.options,g,d.renderTargetSamplingMode,p.getEngine(),d.reusable,d.textureType,!1)},d,p,_)},Object(S.c)([Object(G.c)()],f.prototype,"aberrationAmount",void 0),Object(S.c)([Object(G.c)()],f.prototype,"radialIntensity",void 0),Object(S.c)([Object(G.c)()],f.prototype,"direction",void 0),Object(S.c)([Object(G.c)()],f.prototype,"centerPosition",void 0),Object(S.c)([Object(G.c)()],f.prototype,"screenWidth",void 0),Object(S.c)([Object(G.c)()],f.prototype,"screenHeight",void 0),f}(U.a);x.a.RegisteredTypes["BABYLON.ChromaticAberrationPostProcess"]=T},580:function(we,P,u){"use strict";u.d(P,"a",function(){return G});var S=u(434),R=u(442),U=u(472),O=u(437),x=u(439),G=function(T){Object(S.d)(h,T);function h(f,d,g,p,_,m,l,y,E,A,F,B,L){y===void 0&&(y=null),E===void 0&&(E=R.a.BILINEAR_SAMPLINGMODE),B===void 0&&(B=0),L===void 0&&(L=!1);var I=T.call(this,f,g,p,_,m,E=2,A,F,B=0,`#define DOF 1\r
`,L)||this;return I.direction=g,I.onApplyObservable.add(function(z){y!=null&&z.setTextureFromPostProcess("textureSampler",y),z.setTextureFromPostProcessOutput("circleOfConfusionSampler",l),d.activeCamera&&z.setFloat2("cameraMinMaxZ",d.activeCamera.minZ,d.activeCamera.maxZ)}),I}return h.prototype.getClassName=function(){return"DepthOfFieldBlurPostProcess"},Object(S.c)([Object(x.c)()],h.prototype,"direction",void 0),h}(U.a);O.a.RegisteredTypes["BABYLON.DepthOfFieldBlurPostProcess"]=G},581:function(we,P,u){"use strict";u.d(P,"a",function(){return g});var S=u(434),R=u(444),U=u(502),O=u(439),x=function(){function p(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}return p}(),G=u(435),T="screenSpaceReflectionPixelShader",h=`

uniform sampler2D textureSampler;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;
uniform sampler2D normalSampler;
uniform sampler2D positionSampler;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform float step;
uniform float strength;
uniform float threshold;
uniform float roughnessFactor;
uniform float reflectionSpecularFalloffExponent;

varying vec2 vUV;
#ifdef SSR_SUPPORTED

struct ReflectionInfo {
vec3 color;
vec4 coords;
};

vec3 fresnelSchlick(float cosTheta,vec3 F0)
{
return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);
}

ReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)
{
ReflectionInfo info;
info.color=vec3(0.0);
vec4 projectedCoord;
float sampledDepth;
for(int i=0; i<SMOOTH_STEPS; i++)
{
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;
float depth=sampledDepth-hitCoord.z;
dir*=0.5;
if(depth>0.0)
hitCoord-=dir;
else
hitCoord+=dir;
info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;
}
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);

info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);
info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;
info.color/=float(SMOOTH_STEPS+1);
return info;
}

ReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)
{
ReflectionInfo info;
vec4 projectedCoord;
float sampledDepth;
dir*=step;
for(int i=0; i<REFLECTION_SAMPLES; i++)
{
hitCoord+=dir;
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;
float depth=sampledDepth-hitCoord.z;
if(((depth-dir.z)<threshold) && depth<=0.0)
{
#ifdef ENABLE_SMOOTH_REFLECTIONS
return smoothReflectionInfo(dir,hitCoord);
#else
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;
info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);
return info;
#endif
}
}
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;
info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);
return info;
}
vec3 hash(vec3 a)
{
a=fract(a*0.8);
a+=dot(a,a.yxz+19.19);
return fract((a.xxy+a.yxx)*a.zyx);
}
#endif
void main()
{
#ifdef SSR_SUPPORTED

vec4 albedoFull=texture2D(textureSampler,vUV);
vec3 albedo=albedoFull.rgb;
float spec=texture2D(reflectivitySampler,vUV).r;
if (spec == 0.0) {
gl_FragColor=albedoFull;
return;
}

vec3 normal=(texture2D(normalSampler,vUV)).xyz;
vec3 position=(view*texture2D(positionSampler,vUV)).xyz;
vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));
float roughness=1.0-texture2D(reflectivitySampler,vUV).a;
vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;
ReflectionInfo info=getReflectionInfo(jitt+reflected,position);

vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));
float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);

vec3 F0=vec3(0.04);
F0=mix(F0,albedo,spec);
vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);

float reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);
float albedoMultiplier=1.0-reflectionMultiplier;
vec3 SSR=info.color*fresnel;
gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;G.a.ShadersStore[T]=h;var f={name:T,shader:h},d=u(437),g=function(p){Object(S.d)(_,p);function _(m,l,y,E,A,F,B,L,I,z){L===void 0&&(L=0),I===void 0&&(I=!1),z===void 0&&(z=!1);var k=p.call(this,m,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","step","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],y,E,A,F,B,`#define SSR_SUPPORTED
#define REFLECTION_SAMPLES 64
#define SMOOTH_STEPS 5
`,L,void 0,null,I)||this;if(k.threshold=1.2,k.strength=1,k.reflectionSpecularFalloffExponent=3,k.step=1,k.roughnessFactor=.2,k._forceGeometryBuffer=!1,k._enableSmoothReflections=!1,k._reflectionSamples=64,k._smoothSteps=5,k._forceGeometryBuffer=z,k._forceGeometryBuffer){var j=l.enableGeometryBufferRenderer();j&&j.isSupported&&(j.enablePosition=!0,j.enableReflectivity=!0,k._geometryBufferRenderer=j)}else k._prePassRenderer=l.enablePrePassRenderer(),k._prePassRenderer.markAsDirty(),k._prePassEffectConfiguration=new x;return k._updateEffectDefines(),k.onApply=function(w){var Q=k._geometryBufferRenderer,W=k._prePassRenderer;if(!(!W&&!Q)){if(Q){var Y=Q.getTextureIndex(U.a.POSITION_TEXTURE_TYPE),he=Q.getTextureIndex(U.a.REFLECTIVITY_TEXTURE_TYPE);w.setTexture("normalSampler",Q.getGBuffer().textures[1]),w.setTexture("positionSampler",Q.getGBuffer().textures[Y]),w.setTexture("reflectivitySampler",Q.getGBuffer().textures[he])}else{var Y=W.getIndex(1),he=W.getIndex(3),le=W.getIndex(6);w.setTexture("normalSampler",W.getRenderTarget().textures[le]),w.setTexture("positionSampler",W.getRenderTarget().textures[Y]),w.setTexture("reflectivitySampler",W.getRenderTarget().textures[he])}var J=l.activeCamera;if(!!J){var Re=J.getViewMatrix(!0),Me=J.getProjectionMatrix(!0);w.setMatrix("projection",Me),w.setMatrix("view",Re),w.setFloat("threshold",k.threshold),w.setFloat("reflectionSpecularFalloffExponent",k.reflectionSpecularFalloffExponent),w.setFloat("strength",k.strength),w.setFloat("step",k.step),w.setFloat("roughnessFactor",k.roughnessFactor)}}},k}return _.prototype.getClassName=function(){return"ScreenSpaceReflectionPostProcess"},Object.defineProperty(_.prototype,"enableSmoothReflections",{get:function(){return this._enableSmoothReflections},set:function(m){m!==this._enableSmoothReflections&&(this._enableSmoothReflections=m,this._updateEffectDefines())},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"reflectionSamples",{get:function(){return this._reflectionSamples},set:function(m){m!==this._reflectionSamples&&(this._reflectionSamples=m,this._updateEffectDefines())},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"smoothSteps",{get:function(){return this._smoothSteps},set:function(m){m!==this._smoothSteps&&(this._smoothSteps=m,this._updateEffectDefines())},enumerable:!1,configurable:!0}),_.prototype._updateEffectDefines=function(){var m=[];(this._geometryBufferRenderer||this._prePassRenderer)&&m.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&m.push("#define ENABLE_SMOOTH_REFLECTIONS"),m.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),m.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(m.join(`
`))},_._Parse=function(m,l,y,E){return O.a.Parse(function(){return new _(m.name,y,m.options,l,m.renderTargetSamplingMode,y.getEngine(),m.textureType,m.reusable)},m,y,E)},Object(S.c)([Object(O.c)()],_.prototype,"threshold",void 0),Object(S.c)([Object(O.c)()],_.prototype,"strength",void 0),Object(S.c)([Object(O.c)()],_.prototype,"reflectionSpecularFalloffExponent",void 0),Object(S.c)([Object(O.c)()],_.prototype,"step",void 0),Object(S.c)([Object(O.c)()],_.prototype,"roughnessFactor",void 0),Object(S.c)([Object(O.c)()],_.prototype,"enableSmoothReflections",null),Object(S.c)([Object(O.c)()],_.prototype,"reflectionSamples",null),Object(S.c)([Object(O.c)()],_.prototype,"smoothSteps",null),_}(R.a);d.a.RegisteredTypes["BABYLON.ScreenSpaceReflectionPostProcess"]=g},582:function(we,P,u){"use strict";u.d(P,"a",function(){return d});var S=u(434),R=u(444),U=u(440),O=u(435),x="circleOfConfusionPixelShader",G=`
uniform sampler2D depthSampler;

varying vec2 vUV;

uniform vec2 cameraMinMaxZ;

uniform float focusDistance;
uniform float cocPrecalculation;
void main(void)
{
float depth=texture2D(depthSampler,vUV).r;
float pixelDistance=(cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth)*1000.0;
float coc=abs(cocPrecalculation* ((focusDistance-pixelDistance)/pixelDistance));
coc=clamp(coc,0.0,1.0);
gl_FragColor=vec4(coc,depth,coc,1.0);
}
`;O.a.ShadersStore[x]=G;var T={name:x,shader:G},h=u(437),f=u(439),d=function(g){Object(S.d)(p,g);function p(_,m,l,y,E,A,F,B,L){B===void 0&&(B=0),L===void 0&&(L=!1);var I=g.call(this,_,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],l,y,E,A,F,null,B,void 0,null,L)||this;return I.lensSize=50,I.fStop=1.4,I.focusDistance=2e3,I.focalLength=50,I._depthTexture=null,I._depthTexture=m,I.onApplyObservable.add(function(z){if(!I._depthTexture){U.a.Warn("No depth texture set on CircleOfConfusionPostProcess");return}z.setTexture("depthSampler",I._depthTexture);var k=I.lensSize/I.fStop,j=k*I.focalLength/(I.focusDistance-I.focalLength);z.setFloat("focusDistance",I.focusDistance),z.setFloat("cocPrecalculation",j),z.setFloat2("cameraMinMaxZ",I._depthTexture.activeCamera.minZ,I._depthTexture.activeCamera.maxZ)}),I}return p.prototype.getClassName=function(){return"CircleOfConfusionPostProcess"},Object.defineProperty(p.prototype,"depthTexture",{set:function(_){this._depthTexture=_},enumerable:!1,configurable:!0}),Object(S.c)([Object(f.c)()],p.prototype,"lensSize",void 0),Object(S.c)([Object(f.c)()],p.prototype,"fStop",void 0),Object(S.c)([Object(f.c)()],p.prototype,"focusDistance",void 0),Object(S.c)([Object(f.c)()],p.prototype,"focalLength",void 0),p}(R.a);h.a.RegisteredTypes["BABYLON.CircleOfConfusionPostProcess"]=d},583:function(we,P,u){"use strict";u.d(P,"b",function(){return T}),u.d(P,"a",function(){return h});var S=u(434),R=u(444),U=u(435),O="depthOfFieldMergePixelShader",x=`uniform sampler2D textureSampler;
varying vec2 vUV;
uniform sampler2D circleOfConfusionSampler;
uniform sampler2D blurStep0;
#if BLUR_LEVEL>0
uniform sampler2D blurStep1;
#endif
#if BLUR_LEVEL>1
uniform sampler2D blurStep2;
#endif
void main(void)
{
float coc=texture2D(circleOfConfusionSampler,vUV).r;
#if BLUR_LEVEL == 0
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred0=texture2D(blurStep0,vUV);
gl_FragColor=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL == 1
if(coc<0.5){
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(original,blurred1,coc/0.5);
}else{
vec4 blurred0=texture2D(blurStep0,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);
}
#endif
#if BLUR_LEVEL == 2
if(coc<0.33){
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred2=texture2D(blurStep2,vUV);
gl_FragColor=mix(original,blurred2,coc/0.33);
}else if(coc<0.66){
vec4 blurred1=texture2D(blurStep1,vUV);
vec4 blurred2=texture2D(blurStep2,vUV);
gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);
}else{
vec4 blurred0=texture2D(blurStep0,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);
}
#endif
}
`;U.a.ShadersStore[O]=x;var G={name:O,shader:x},T=function(){function f(){}return f}(),h=function(f){Object(S.d)(d,f);function d(g,p,_,m,l,y,E,A,F,B,L){B===void 0&&(B=0),L===void 0&&(L=!1);var I=f.call(this,g,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],l,y,E,A,F,null,B,void 0,null,!0)||this;return I.blurSteps=m,I.onApplyObservable.add(function(z){z.setTextureFromPostProcess("textureSampler",p),z.setTextureFromPostProcessOutput("circleOfConfusionSampler",_),m.forEach(function(k,j){z.setTextureFromPostProcessOutput("blurStep"+(m.length-j-1),k)})}),L||I.updateEffect(),I}return d.prototype.getClassName=function(){return"DepthOfFieldMergePostProcess"},d.prototype.updateEffect=function(g,p,_,m,l,y){g===void 0&&(g=null),p===void 0&&(p=null),_===void 0&&(_=null),g||(g="",g+="#define BLUR_LEVEL "+(this.blurSteps.length-1)+`
`),f.prototype.updateEffect.call(this,g,p,_,m,l,y)},d}(R.a)},584:function(we,P,u){"use strict";u.d(P,"a",function(){return g});var S=u(434),R=u(444),U=u(515),O=u(435),x=u(457),G="extractHighlightsPixelShader",T=`#include<helperFunctions>

varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float threshold;
uniform float exposure;
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
float luma=getLuminance(gl_FragColor.rgb*exposure);
gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;
}`;O.a.ShadersStore[G]=T;var h={name:G,shader:T},f=u(439),d=u(437),g=function(p){Object(S.d)(_,p);function _(m,l,y,E,A,F,B,L){B===void 0&&(B=0),L===void 0&&(L=!1);var I=p.call(this,m,"extractHighlights",["threshold","exposure"],null,l,y,E,A,F,null,B,void 0,null,L)||this;return I.threshold=.9,I._exposure=1,I._inputPostProcess=null,I.onApplyObservable.add(function(z){I._inputPostProcess&&z.setTextureFromPostProcess("textureSampler",I._inputPostProcess),z.setFloat("threshold",Math.pow(I.threshold,U.b)),z.setFloat("exposure",I._exposure)}),I}return _.prototype.getClassName=function(){return"ExtractHighlightsPostProcess"},Object(S.c)([Object(f.c)()],_.prototype,"threshold",void 0),_}(R.a);d.a.RegisteredTypes["BABYLON.ExtractHighlightsPostProcess"]=g},585:function(we,P,u){"use strict";u.d(P,"a",function(){return f});var S=u(434),R=u(444),U=u(435),O="bloomMergePixelShader",x=`uniform sampler2D textureSampler;
uniform sampler2D bloomBlur;
varying vec2 vUV;
uniform float bloomWeight;
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
vec3 blurred=texture2D(bloomBlur,vUV).rgb;
gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight);
}
`;U.a.ShadersStore[O]=x;var G={name:O,shader:x},T=u(437),h=u(439),f=function(d){Object(S.d)(g,d);function g(p,_,m,l,y,E,A,F,B,L,I){L===void 0&&(L=0),I===void 0&&(I=!1);var z=d.call(this,p,"bloomMerge",["bloomWeight"],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2","bloomBlur"],y,E,A,F,B,null,L,void 0,null,!0)||this;return z.weight=1,z.weight=l,z.onApplyObservable.add(function(k){k.setTextureFromPostProcess("textureSampler",_),k.setTextureFromPostProcessOutput("bloomBlur",m),k.setFloat("bloomWeight",z.weight)}),I||z.updateEffect(),z}return g.prototype.getClassName=function(){return"BloomMergePostProcess"},Object(S.c)([Object(h.c)()],g.prototype,"weight",void 0),g}(R.a);T.a.RegisteredTypes["BABYLON.BloomMergePostProcess"]=f},586:function(we,P,u){"use strict";u.d(P,"a",function(){return d});var S=u(434),R=u(444),U=u(435),O=u(457),x="grainPixelShader",G=`#include<helperFunctions>

uniform sampler2D textureSampler;

uniform float intensity;
uniform float animatedSeed;

varying vec2 vUV;
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
vec2 seed=vUV*(animatedSeed);
float grain=dither(seed,intensity);

float lum=getLuminance(gl_FragColor.rgb);
float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;
gl_FragColor.rgb+=grain*grainAmount;
gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);
}`;U.a.ShadersStore[x]=G;var T={name:x,shader:G},h=u(437),f=u(439),d=function(g){Object(S.d)(p,g);function p(_,m,l,y,E,A,F,B){F===void 0&&(F=0),B===void 0&&(B=!1);var L=g.call(this,_,"grain",["intensity","animatedSeed"],[],m,l,y,E,A,null,F,void 0,null,B)||this;return L.intensity=30,L.animated=!1,L.onApplyObservable.add(function(I){I.setFloat("intensity",L.intensity),I.setFloat("animatedSeed",L.animated?Math.random()+1:1)}),L}return p.prototype.getClassName=function(){return"GrainPostProcess"},p._Parse=function(_,m,l,y){return f.a.Parse(function(){return new p(_.name,_.options,m,_.renderTargetSamplingMode,l.getEngine(),_.reusable)},_,l,y)},Object(S.c)([Object(f.c)()],p.prototype,"intensity",void 0),Object(S.c)([Object(f.c)()],p.prototype,"animated",void 0),p}(R.a);h.a.RegisteredTypes["BABYLON.GrainPostProcess"]=d},587:function(we,P,u){"use strict";u.d(P,"a",function(){return f});var S=u(434),R=u(444),U=u(435),O="sharpenPixelShader",x=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform vec2 sharpnessAmounts;
void main(void)
{
vec2 onePixel=vec2(1.0,1.0)/screenSize;
vec4 color=texture2D(textureSampler,vUV);
vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(0,1)) -
color*4.0;
gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);
}`;U.a.ShadersStore[O]=x;var G={name:O,shader:x},T=u(437),h=u(439),f=function(d){Object(S.d)(g,d);function g(p,_,m,l,y,E,A,F){A===void 0&&(A=0),F===void 0&&(F=!1);var B=d.call(this,p,"sharpen",["sharpnessAmounts","screenSize"],null,_,m,l,y,E,null,A,void 0,null,F)||this;return B.colorAmount=1,B.edgeAmount=.3,B.onApply=function(L){L.setFloat2("screenSize",B.width,B.height),L.setFloat2("sharpnessAmounts",B.edgeAmount,B.colorAmount)},B}return g.prototype.getClassName=function(){return"SharpenPostProcess"},g._Parse=function(p,_,m,l){return h.a.Parse(function(){return new g(p.name,p.options,_,p.renderTargetSamplingMode,m.getEngine(),p.textureType,p.reusable)},p,m,l)},Object(S.c)([Object(h.c)()],g.prototype,"colorAmount",void 0),Object(S.c)([Object(h.c)()],g.prototype,"edgeAmount",void 0),g}(R.a);T.a.RegisteredTypes["BABYLON.SharpenPostProcess"]=f},594:function(we,P,u){"use strict";u.d(P,"a",function(){return L});var S=u(434),R=u(440),U=u(439),O=u(436),x=u(451),G=u(442),T=u(479),h=u(444),f=u(481),d=u(466),g=u(486),p=u(437),_=u(448),m=function(){function I(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}return I}(),l=u(482),y=u(435),E="ssao2PixelShader",A=`
precision highp float;
uniform sampler2D textureSampler;
uniform float near;
uniform float far;
uniform float radius;
float scales[16]=float[16](
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);
varying vec2 vUV;
float perspectiveDepthToViewZ( const in float invClipZ,const in float near,const in float far ) {
return ( near*far )/( ( far-near )*invClipZ-far );
}
float viewZToPerspectiveDepth( const in float viewZ,const in float near,const in float far ) {
return ( near*far/viewZ+far)/( far-near );
}
float viewZToOrthographicDepth( const in float viewZ,const in float near,const in float far ) {
return ( viewZ+near )/( near-far );
}
#ifdef SSAO
uniform sampler2D randomSampler;
uniform sampler2D depthSampler;
uniform sampler2D normalSampler;
uniform float randTextureTiles;
uniform float samplesFactor;
uniform vec3 sampleSphere[SAMPLES];
uniform float totalStrength;
uniform float base;
uniform float xViewport;
uniform float yViewport;
uniform mat3 depthProjection;
uniform float maxZ;
uniform float minZAspect;
uniform vec2 texelSize;
uniform mat4 projection;
void main()
{
vec3 random=texture2D(randomSampler,vUV*randTextureTiles).rgb;
float depth=texture2D(depthSampler,vUV).r;
float depthSign=depth/abs(depth);
depth=depth*depthSign;
vec3 normal=texture2D(normalSampler,vUV).rgb;
float occlusion=0.0;
float correctedRadius=min(radius,minZAspect*depth/near);
vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);
vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);
vec3 origin=vViewRay*vDepthFactor;
vec3 rvec=random*2.0-1.0;
rvec.z=0.0;

float dotProduct=dot(rvec,normal);
rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);
vec3 tangent=normalize(rvec-normal*dot(rvec,normal));
vec3 bitangent=cross(normal,tangent);
mat3 tbn=mat3(tangent,bitangent,normal);
float difference;
for (int i=0; i<SAMPLES; ++i) {

vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];
samplePosition=samplePosition*correctedRadius+origin;

vec4 offset=vec4(samplePosition,1.0);
offset=projection*offset;
offset.xyz/=offset.w;
offset.xy=offset.xy*0.5+0.5;
if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {
continue;
}

float sampleDepth=abs(texture2D(depthSampler,offset.xy).r);

difference=depthSign*samplePosition.z-sampleDepth;
float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);
occlusion+=(difference>=0.0 ? 1.0 : 0.0)*rangeCheck;
}
occlusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));
float ao=1.0-totalStrength*occlusion*samplesFactor;
float result=clamp(ao+base,0.0,1.0);
gl_FragColor=vec4(vec3(result),1.0);
}
#endif
#ifdef BILATERAL_BLUR
uniform sampler2D depthSampler;
uniform float outSize;
uniform float samplerOffsets[SAMPLES];
vec4 blur9(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.3846153846)*direction;
vec2 off2=vec2(3.2307692308)*direction;
color+=texture2D(image,uv)*0.2270270270;
color+=texture2D(image,uv+(off1/resolution))*0.3162162162;
color+=texture2D(image,uv-(off1/resolution))*0.3162162162;
color+=texture2D(image,uv+(off2/resolution))*0.0702702703;
color+=texture2D(image,uv-(off2/resolution))*0.0702702703;
return color;
}
vec4 blur13(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.411764705882353)*direction;
vec2 off2=vec2(3.2941176470588234)*direction;
vec2 off3=vec2(5.176470588235294)*direction;
color+=texture2D(image,uv)*0.1964825501511404;
color+=texture2D(image,uv+(off1/resolution))*0.2969069646728344;
color+=texture2D(image,uv-(off1/resolution))*0.2969069646728344;
color+=texture2D(image,uv+(off2/resolution))*0.09447039785044732;
color+=texture2D(image,uv-(off2/resolution))*0.09447039785044732;
color+=texture2D(image,uv+(off3/resolution))*0.010381362401148057;
color+=texture2D(image,uv-(off3/resolution))*0.010381362401148057;
return color;
}
vec4 blur13Bilateral(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.411764705882353)*direction;
vec2 off2=vec2(3.2941176470588234)*direction;
vec2 off3=vec2(5.176470588235294)*direction;
float compareDepth=abs(texture2D(depthSampler,uv).r);
float sampleDepth;
float weight;
float weightSum=30.0;
color+=texture2D(image,uv)*30.0;
sampleDepth=abs(texture2D(depthSampler,uv+(off1/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off1/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off1/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off1/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv+(off2/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off2/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off2/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off2/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv+(off3/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off3/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off3/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off3/resolution))*weight;
return color/weightSum;
}
void main()
{
#if EXPENSIVE
float compareDepth=abs(texture2D(depthSampler,vUV).r);
float texelsize=1.0/outSize;
float result=0.0;
float weightSum=0.0;
for (int i=0; i<SAMPLES; ++i)
{
#ifdef BILATERAL_BLUR_H
vec2 direction=vec2(1.0,0.0);
vec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);
#else
vec2 direction=vec2(0.0,1.0);
vec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);
#endif
vec2 samplePos=vUV+sampleOffset;
float sampleDepth=abs(texture2D(depthSampler,samplePos).r);
float weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30000.0);
result+=texture2D(textureSampler,samplePos).r*weight;
weightSum+=weight;
}
result/=weightSum;
gl_FragColor.rgb=vec3(result);
gl_FragColor.a=1.0;
#else
vec4 color;
#ifdef BILATERAL_BLUR_H
vec2 direction=vec2(1.0,0.0);
color=blur13Bilateral(textureSampler,vUV,outSize,direction);
#else
vec2 direction=vec2(0.0,1.0);
color=blur13Bilateral(textureSampler,vUV,outSize,direction);
#endif
gl_FragColor.rgb=vec3(color.r);
gl_FragColor.a=1.0;
#endif
}
#endif
`;y.a.ShadersStore[E]=A;var F={name:E,shader:A},B=u(601),L=function(I){Object(S.d)(z,I);function z(k,j,w,Q,W){W===void 0&&(W=!1);var Y=I.call(this,j.getEngine(),k)||this;if(Y.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",Y.SSAORenderEffect="SSAORenderEffect",Y.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",Y.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",Y.SSAOCombineRenderEffect="SSAOCombineRenderEffect",Y.totalStrength=1,Y.maxZ=100,Y.minZAspect=.2,Y._samples=8,Y._textureSamples=1,Y._forceGeometryBuffer=!1,Y._expensiveBlur=!0,Y.radius=2,Y.base=0,Y._bits=new Uint32Array(1),Y._scene=j,Y._ratio=w,Y._forceGeometryBuffer=W,!Y.isSupported)return R.a.Error("The current engine does not support SSAO 2."),Y;var he=Y._ratio.ssaoRatio||w,le=Y._ratio.blurRatio||w;return Y._forceGeometryBuffer?j.enableGeometryBufferRenderer():Y._prePassRenderer=j.enablePrePassRenderer(),Y._createRandomTexture(),Y._originalColorPostProcess=new g.b("SSAOOriginalSceneColor",1,null,G.a.BILINEAR_SAMPLINGMODE,j.getEngine(),!1),Y._originalColorPostProcess.samples=Y.textureSamples,Y._createSSAOPostProcess(1),Y._createBlurPostProcess(he,le),Y._createSSAOCombinePostProcess(le),Y.addEffect(new d.a(j.getEngine(),Y.SSAOOriginalSceneColorEffect,function(){return Y._originalColorPostProcess},!0)),Y.addEffect(new d.a(j.getEngine(),Y.SSAORenderEffect,function(){return Y._ssaoPostProcess},!0)),Y.addEffect(new d.a(j.getEngine(),Y.SSAOBlurHRenderEffect,function(){return Y._blurHPostProcess},!0)),Y.addEffect(new d.a(j.getEngine(),Y.SSAOBlurVRenderEffect,function(){return Y._blurVPostProcess},!0)),Y.addEffect(new d.a(j.getEngine(),Y.SSAOCombineRenderEffect,function(){return Y._ssaoCombinePostProcess},!0)),j.postProcessRenderPipelineManager.addPipeline(Y),Q&&j.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(k,Q),Y}return Object.defineProperty(z.prototype,"samples",{get:function(){return this._samples},set:function(k){this._samples=k,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()},enumerable:!1,configurable:!0}),Object.defineProperty(z.prototype,"textureSamples",{get:function(){return this._textureSamples},set:function(k){this._textureSamples=k,this._prePassRenderer?this._prePassRenderer.samples=k:this._originalColorPostProcess.samples=k},enumerable:!1,configurable:!0}),Object.defineProperty(z.prototype,"expensiveBlur",{get:function(){return this._expensiveBlur},set:function(k){this._blurHPostProcess.updateEffect(`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(k?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._blurVPostProcess.updateEffect(`#define BILATERAL_BLUR
#define SAMPLES 16
#define EXPENSIVE `+(k?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._expensiveBlur=k},enumerable:!1,configurable:!0}),Object.defineProperty(z,"IsSupported",{get:function(){var k=_.a.LastCreatedEngine;return k?k._features.supportSSAO2:!1},enumerable:!1,configurable:!0}),Object.defineProperty(z.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),z.prototype.getClassName=function(){return"SSAO2RenderingPipeline"},z.prototype.dispose=function(k){k===void 0&&(k=!1);for(var j=0;j<this._scene.cameras.length;j++){var w=this._scene.cameras[j];this._originalColorPostProcess.dispose(w),this._ssaoPostProcess.dispose(w),this._blurHPostProcess.dispose(w),this._blurVPostProcess.dispose(w),this._ssaoCombinePostProcess.dispose(w)}this._randomTexture.dispose(),k&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),I.prototype.dispose.call(this)},z.prototype._createBlurPostProcess=function(k,j){var w=this;this._samplerOffsets=[];for(var Q=this.expensiveBlur,W=-8;W<8;W++)this._samplerOffsets.push(W*2+.5);this._blurHPostProcess=new h.a("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],k,null,G.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(Q?"1":"0")+`
`),this._blurHPostProcess.onApply=function(Y){!w._scene.activeCamera||(Y.setFloat("outSize",w._ssaoCombinePostProcess.width>0?w._ssaoCombinePostProcess.width:w._originalColorPostProcess.width),Y.setFloat("near",w._scene.activeCamera.minZ),Y.setFloat("far",w._scene.activeCamera.maxZ),Y.setFloat("radius",w.radius),w._forceGeometryBuffer?Y.setTexture("depthSampler",w._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]):Y.setTexture("depthSampler",w._prePassRenderer.getRenderTarget().textures[w._prePassRenderer.getIndex(5)]),Y.setArray("samplerOffsets",w._samplerOffsets))},this._blurVPostProcess=new h.a("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],j,null,G.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_V
#define SAMPLES 16
#define EXPENSIVE `+(Q?"1":"0")+`
`),this._blurVPostProcess.onApply=function(Y){!w._scene.activeCamera||(Y.setFloat("outSize",w._ssaoCombinePostProcess.height>0?w._ssaoCombinePostProcess.height:w._originalColorPostProcess.height),Y.setFloat("near",w._scene.activeCamera.minZ),Y.setFloat("far",w._scene.activeCamera.maxZ),Y.setFloat("radius",w.radius),w._forceGeometryBuffer?Y.setTexture("depthSampler",w._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]):Y.setTexture("depthSampler",w._prePassRenderer.getRenderTarget().textures[w._prePassRenderer.getIndex(5)]),Y.setArray("samplerOffsets",w._samplerOffsets))},this._blurHPostProcess.samples=this.textureSamples,this._blurVPostProcess.samples=this.textureSamples},z.prototype._rebuild=function(){I.prototype._rebuild.call(this)},z.prototype._radicalInverse_VdC=function(k){return this._bits[0]=k,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(this._bits[0]&1431655765)<<1|(this._bits[0]&2863311530)>>>1>>>0,this._bits[0]=(this._bits[0]&858993459)<<2|(this._bits[0]&3435973836)>>>2>>>0,this._bits[0]=(this._bits[0]&252645135)<<4|(this._bits[0]&4042322160)>>>4>>>0,this._bits[0]=(this._bits[0]&16711935)<<8|(this._bits[0]&4278255360)>>>8>>>0,this._bits[0]*23283064365386963e-26},z.prototype._hammersley=function(k,j){return[k/j,this._radicalInverse_VdC(k)]},z.prototype._hemisphereSample_uniform=function(k,j){var w=j*2*Math.PI,Q=1-(k*.85+.15),W=Math.sqrt(1-Q*Q);return new O.e(Math.cos(w)*W,Math.sin(w)*W,Q)},z.prototype._generateHemisphere=function(){for(var k=this.samples,j=[],w,Q=0;Q<k;){if(k<16)w=this._hemisphereSample_uniform(Math.random(),Math.random());else{var W=this._hammersley(Q,k);w=this._hemisphereSample_uniform(W[0],W[1])}j.push(w.x,w.y,w.z),Q++}return j},z.prototype._getDefinesForSSAO=function(){var k="#define SAMPLES "+this.samples+`
#define SSAO`;return k},z.prototype._createSSAOPostProcess=function(k){var j=this;this._sampleSphere=this._generateHemisphere();var w=this._getDefinesForSSAO(),Q=["randomSampler","depthSampler","normalSampler"];this._ssaoPostProcess=new h.a("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],Q,k,null,G.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,w),this._ssaoPostProcess.onApply=function(W){var Y,he,le,J;if(!!j._scene.activeCamera){if(W.setArray3("sampleSphere",j._sampleSphere),W.setFloat("randTextureTiles",32),W.setFloat("samplesFactor",1/j.samples),W.setFloat("totalStrength",j.totalStrength),W.setFloat2("texelSize",1/j._ssaoPostProcess.width,1/j._ssaoPostProcess.height),W.setFloat("radius",j.radius),W.setFloat("maxZ",j.maxZ),W.setFloat("minZAspect",j.minZAspect),W.setFloat("base",j.base),W.setFloat("near",j._scene.activeCamera.minZ),W.setFloat("far",j._scene.activeCamera.maxZ),j._scene.activeCamera.mode===x.a.PERSPECTIVE_CAMERA)W.setMatrix3x3("depthProjection",z.PERSPECTIVE_DEPTH_PROJECTION),W.setFloat("xViewport",Math.tan(j._scene.activeCamera.fov/2)*j._scene.getEngine().getAspectRatio(j._scene.activeCamera,!0)),W.setFloat("yViewport",Math.tan(j._scene.activeCamera.fov/2));else{var Re=j._scene.getEngine().getRenderWidth()/2,Me=j._scene.getEngine().getRenderHeight()/2,me=(Y=j._scene.activeCamera.orthoLeft)!==null&&Y!==void 0?Y:-Re,H=(he=j._scene.activeCamera.orthoRight)!==null&&he!==void 0?he:Re,q=(le=j._scene.activeCamera.orthoBottom)!==null&&le!==void 0?le:-Me,_e=(J=j._scene.activeCamera.orthoTop)!==null&&J!==void 0?J:Me;W.setMatrix3x3("depthProjection",z.ORTHO_DEPTH_PROJECTION),W.setFloat("xViewport",(H-me)*.5),W.setFloat("yViewport",(_e-q)*.5)}W.setMatrix("projection",j._scene.getProjectionMatrix()),j._forceGeometryBuffer?(W.setTexture("depthSampler",j._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]),W.setTexture("normalSampler",j._scene.enableGeometryBufferRenderer().getGBuffer().textures[1])):(W.setTexture("depthSampler",j._prePassRenderer.getRenderTarget().textures[j._prePassRenderer.getIndex(5)]),W.setTexture("normalSampler",j._prePassRenderer.getRenderTarget().textures[j._prePassRenderer.getIndex(6)])),W.setTexture("randomSampler",j._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples},z.prototype._createSSAOCombinePostProcess=function(k){var j=this;this._ssaoCombinePostProcess=new h.a("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],k,null,G.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(w){var Q=j._scene.activeCamera.viewport;w.setVector4("viewport",O.c.Vector4[0].copyFromFloats(Q.x,Q.y,Q.width,Q.height)),w.setTextureFromPostProcessOutput("originalColor",j._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoCombinePostProcess._prePassEffectConfiguration=new m)},z.prototype._createRandomTexture=function(){var k=128;this._randomTexture=new T.a("SSAORandomTexture",k,this._scene,!1,G.a.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=G.a.WRAP_ADDRESSMODE,this._randomTexture.wrapV=G.a.WRAP_ADDRESSMODE;for(var j=this._randomTexture.getContext(),w=function(he,le){return Math.random()*(le-he)+he},Q=O.e.Zero(),W=0;W<k;W++)for(var Y=0;Y<k;Y++)Q.x=w(0,1),Q.y=w(0,1),Q.z=0,Q.normalize(),Q.scaleInPlace(255),Q.x=Math.floor(Q.x),Q.y=Math.floor(Q.y),j.fillStyle="rgb("+Q.x+", "+Q.y+", "+Q.z+")",j.fillRect(W,Y,1,1);this._randomTexture.update(!1)},z.prototype.serialize=function(){var k=U.a.Serialize(this);return k.customType="SSAO2RenderingPipeline",k},z.Parse=function(k,j,w){return U.a.Parse(function(){return new z(k._name,j,k._ratio)},k,j,w)},z.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],z.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],Object(S.c)([Object(U.c)()],z.prototype,"totalStrength",void 0),Object(S.c)([Object(U.c)()],z.prototype,"maxZ",void 0),Object(S.c)([Object(U.c)()],z.prototype,"minZAspect",void 0),Object(S.c)([Object(U.c)("samples")],z.prototype,"_samples",void 0),Object(S.c)([Object(U.c)("textureSamples")],z.prototype,"_textureSamples",void 0),Object(S.c)([Object(U.c)()],z.prototype,"_ratio",void 0),Object(S.c)([Object(U.c)("expensiveBlur")],z.prototype,"_expensiveBlur",void 0),Object(S.c)([Object(U.c)()],z.prototype,"radius",void 0),Object(S.c)([Object(U.c)()],z.prototype,"base",void 0),z}(f.a);p.a.RegisteredTypes["BABYLON.SSAO2RenderingPipeline"]=L},598:function(we,P,u){"use strict";u.d(P,"a",function(){return f});var S=u(434),R=u(538),U=u(518),O=function(d){Object(S.d)(g,d);function g(p,_,m,l,y,E){var A=d.call(this,p,m,l,y,E)||this;return A._beforeCompositionPostProcesses=[],A._internalTextureDirty=!1,A.enabled=!1,A.renderTargetTexture=null,A.renderTargetTexture=_,A}return g.prototype._createCompositionEffect=function(){this.imageProcessingPostProcess=new U.a("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()},g.prototype._checkSize=function(){var p=this._engine.getRenderWidth(!0),_=this._engine.getRenderHeight(!0),m=this.getRenderWidth(),l=this.getRenderHeight();(m!==p||l!==_)&&(this.resize({width:p,height:_}),this._internalTextureDirty=!0)},g.prototype.updateCount=function(p,_){d.prototype.updateCount.call(this,p,_),this._internalTextureDirty=!0},g.prototype._resetPostProcessChain=function(){this._beforeCompositionPostProcesses=[]},g.prototype.dispose=function(){var p=this._scene;if(d.prototype.dispose.call(this),p&&p.prePassRenderer){var _=p.prePassRenderer.renderTargets.indexOf(this);_!==-1&&p.prePassRenderer.renderTargets.splice(_,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose()},g}(R.a),x=u(476),G=u(441),T=u(459),h=u(502),f=function(){function d(g){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtFormats=[],this._mrtLayout=[],this._textureIndices=[],this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!1,this.renderTargets=[],this._clearColor=new G.b(0,0,0,0),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=g,this._engine=g.getEngine(),d._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._setRenderTarget(null)}return d.prototype.getIndex=function(g){return this._textureIndices[g]},Object.defineProperty(d.prototype,"samples",{get:function(){return this.defaultRT.samples},set:function(g){this.defaultRT.samples=g},enumerable:!1,configurable:!0}),d.prototype.getRenderTarget=function(){return this._currentTarget},d.prototype._setRenderTarget=function(g){g?this._currentTarget=g:this._currentTarget=this.defaultRT},Object.defineProperty(d.prototype,"currentRTisSceneRT",{get:function(){return this._currentTarget===this.defaultRT},enumerable:!1,configurable:!0}),d.prototype._refreshGeometryBufferRendererLink=function(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}},Object.defineProperty(d.prototype,"enabled",{get:function(){return this._enabled},enumerable:!1,configurable:!0}),d.prototype._createRenderTarget=function(g,p){var _=new O(g,p,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(_),_},Object.defineProperty(d.prototype,"isSupported",{get:function(){return this._scene.getEngine().getCaps().drawBuffersExtension},enumerable:!1,configurable:!0}),d.prototype.bindAttachmentsForEffect=function(g,p){if(this.enabled&&this._currentTarget.enabled){if(g._multiTarget)this._engine.bindAttachments(this._multiRenderAttachments);else if(this._engine.bindAttachments(this._defaultAttachments),this._geometryBuffer&&this.currentRTisSceneRT){var _=p.getMaterial();_&&!_.isPrePassCapable&&this.excludedMaterials.indexOf(_)===-1&&this._geometryBuffer.renderList.push(p.getRenderingMesh())}}},d.prototype._reinitializeAttachments=function(){for(var g=[],p=[!1],_=[!0],m=0;m<this.mrtCount;m++)g.push(!0),m>0&&(p.push(!0),_.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(g),this._clearAttachments=this._engine.buildTextureLayout(p),this._defaultAttachments=this._engine.buildTextureLayout(_)},d.prototype._resetLayout=function(){for(var g=0;g<d._textureFormats.length;g++)this._textureIndices[d._textureFormats[g].type]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtFormats=[2],this.mrtCount=1},d.prototype._updateGeometryBufferLayout=function(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();for(var g=[],p=0;p<this._mrtLayout.length;p++)g.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());for(var _=[{prePassConstant:5,geometryBufferConstant:h.a.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:h.a.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:h.a.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:h.a.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:h.a.VELOCITY_TEXTURE_TYPE}],p=0;p<_.length;p++){var m=this._mrtLayout.indexOf(_[p].prePassConstant);m!==-1&&(this._geometryBuffer._forceTextureType(_[p].geometryBufferConstant,m),g[m]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(g))}},d.prototype.restoreAttachments=function(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&this._engine.bindAttachments(this._defaultAttachments)},d.prototype._beforeDraw=function(g,p,_){this._isDirty&&this._update(),!(!this._enabled||!this._currentTarget.enabled)&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,g))},d.prototype._prepareFrame=function(g,p,_){g.renderTargetTexture?g.renderTargetTexture._prepareFrame(this._scene,p,_,g.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()},d.prototype._renderPostProcesses=function(g,p){var _=this._postProcessesSourceForThisPass[0],m=_?_.inputTexture:g.renderTargetTexture?g.renderTargetTexture.getInternalTexture():null,l=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(l=l.concat([this._currentTarget.imageProcessingPostProcess])),l.length&&(this._scene.postProcessManager._prepareFrame(this._currentTarget.getInternalTexture(),l),this._scene.postProcessManager.directRender(l,m,!1,p))},d.prototype._afterDraw=function(g,p){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,g,p),this._renderPostProcesses(this._currentTarget,g))},d.prototype._clear=function(){this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(this._currentTarget),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._engine.bindAttachments(this._defaultAttachments))},d.prototype._bindFrameBuffer=function(g){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();var p=this._currentTarget.getInternalTexture();p&&this._engine.bindFramebuffer(p)}},d.prototype._setEnabled=function(g){this._enabled=g},d.prototype._setRenderTargetEnabled=function(g,p){g.enabled=p},d.prototype.addEffectConfiguration=function(g){for(var p=0;p<this._effectConfigurations.length;p++)if(this._effectConfigurations[p].name===g.name)return this._effectConfigurations[p];return this._effectConfigurations.push(g),g},d.prototype._enable=function(){for(var g=this.mrtCount,p=0;p<this._effectConfigurations.length;p++)this._effectConfigurations[p].enabled&&this._enableTextures(this._effectConfigurations[p].texturesRequired);for(var p=0;p<this.renderTargets.length;p++){this.mrtCount!==g&&this.renderTargets[p].updateCount(this.mrtCount,{types:this._mrtFormats}),this.renderTargets[p]._resetPostProcessChain();for(var _=0;_<this._effectConfigurations.length;_++)this._effectConfigurations[_].enabled&&(!this._effectConfigurations[_].postProcess&&this._effectConfigurations[_].createPostProcess&&this._effectConfigurations[_].createPostProcess(),this._effectConfigurations[_].postProcess&&this.renderTargets[p]._beforeCompositionPostProcesses.push(this._effectConfigurations[_].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()},d.prototype._disable=function(){this._setEnabled(!1);for(var g=0;g<this.renderTargets.length;g++)this._setRenderTargetEnabled(this.renderTargets[g],!1);this._resetLayout();for(var g=0;g<this._effectConfigurations.length;g++)this._effectConfigurations[g].enabled=!1},d.prototype._getPostProcessesSource=function(g,p){if(p)return p._postProcesses;if(g.renderTargetTexture)if(g.renderTargetTexture.useCameraPostProcesses){var _=g.renderTargetTexture.activeCamera?g.renderTargetTexture.activeCamera:this._scene.activeCamera;return _?_._postProcesses:[]}else return g.renderTargetTexture.postProcesses?g.renderTargetTexture.postProcesses:[];else return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]},d.prototype._setupOutputForThisPass=function(g,p){var _=p&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&this._scene.activeCameras.indexOf(p)!==0;this._postProcessesSourceForThisPass=this._getPostProcessesSource(g,p),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(function(A){return A!=null}),this._scene.autoClear=!0;var m=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!m&&!this.disableGammaTransform&&this._needsImageProcessing()&&!_;var l=this._getFirstPostProcess(this._postProcessesSourceForThisPass),y=g._beforeCompositionPostProcesses&&g._beforeCompositionPostProcesses[0],E=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||m,this._needsCompositionForThisPass&&!g.imageProcessingPostProcess&&g._createCompositionEffect(),y?E=y:this._needsCompositionForThisPass?E=g.imageProcessingPostProcess:l&&(E=l),this._bindFrameBuffer(g),this._linkInternalTexture(g,E)},d.prototype._linkInternalTexture=function(g,p){p&&(p.autoClear=!1,p.inputTexture=g.getInternalTexture()),g._outputPostProcess!==p&&(g._outputPostProcess&&g._outputPostProcess.restoreDefaultInputTexture(),g._outputPostProcess=p),g._internalTextureDirty&&(this._updateGeometryBufferLayout(),g._internalTextureDirty=!1)},d.prototype._needsImageProcessing=function(){for(var g=0;g<this._effectConfigurations.length;g++)if(this._effectConfigurations[g].enabled&&this._effectConfigurations[g].needsImageProcessing)return!0;return!1},d.prototype._hasImageProcessing=function(g){var p,_=!1;if(g){for(var m=0;m<g.length;m++)if(((p=g[m])===null||p===void 0?void 0:p.getClassName())==="ImageProcessingPostProcess"){_=!0;break}}return _},d.prototype._getFirstPostProcess=function(g){for(var p=0;p<g.length;p++)if(g[p]!==null)return g[p];return null},d.prototype.markAsDirty=function(){this._isDirty=!0},d.prototype._enableTextures=function(g){for(var p=0;p<g.length;p++){var _=g[p];this._textureIndices[_]===-1&&(this._textureIndices[_]=this._mrtLayout.length,this._mrtLayout.push(_),this._mrtFormats.push(d._textureFormats[_].format),this.mrtCount++)}},d.prototype._update=function(){this._disable();var g=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1;for(var p=0;p<this._scene.materials.length;p++)this._scene.materials[p].setPrePassRenderer(this)&&(g=!0);g&&this._setRenderTargetEnabled(this.defaultRT,!0);for(var _,p=0;p<this.renderTargets.length;p++){if(this.renderTargets[p].renderTargetTexture)_=this._getPostProcessesSource(this.renderTargets[p]);else{var m=this._scene.activeCamera;if(!m)continue;_=m._postProcesses}if(!!_&&(_=_.filter(function(E){return E!=null}),_)){for(var l=0;l<_.length;l++)_[l].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[p],!0),g=!0);this._hasImageProcessing(_)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,g&&this._enable()},d.prototype._markAllMaterialsAsPrePassDirty=function(){for(var g=this._scene.materials,p=0;p<g.length;p++)g[p].markAsDirty(T.a.PrePassDirtyFlag)},d.prototype.dispose=function(){for(var g=this.renderTargets.length-1;g>=0;g--)this.renderTargets[g].dispose();for(var g=0;g<this._effectConfigurations.length;g++)this._effectConfigurations[g].dispose&&this._effectConfigurations[g].dispose()},d._SceneComponentInitialization=function(g){throw x.a.WarnImport("PrePassRendererSceneComponent")},d._textureFormats=[{type:0,format:2},{type:1,format:2},{type:2,format:2},{type:3,format:0},{type:4,format:2},{type:5,format:2},{type:6,format:2},{type:7,format:0}],d}()},599:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(439),U=u(436),O=u(453),x=u(484),G=u(537);O.a.AddNodeConstructor("Light_Type_1",function(h,f){return function(){return new T(h,U.e.Zero(),f)}});var T=function(h){Object(S.d)(f,h);function f(d,g,p){var _=h.call(this,d,p)||this;return _._shadowFrustumSize=0,_._shadowOrthoScale=.1,_.autoUpdateExtends=!0,_.autoCalcShadowZBounds=!1,_._orthoLeft=Number.MAX_VALUE,_._orthoRight=Number.MIN_VALUE,_._orthoTop=Number.MIN_VALUE,_._orthoBottom=Number.MAX_VALUE,_.position=g.scale(-1),_.direction=g,_}return Object.defineProperty(f.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(d){this._shadowFrustumSize=d,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(d){this._shadowOrthoScale=d,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"orthoLeft",{get:function(){return this._orthoLeft},set:function(d){this._orthoLeft=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"orthoRight",{get:function(){return this._orthoRight},set:function(d){this._orthoRight=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"orthoTop",{get:function(){return this._orthoTop},set:function(d){this._orthoTop=d},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"orthoBottom",{get:function(){return this._orthoBottom},set:function(d){this._orthoBottom=d},enumerable:!1,configurable:!0}),f.prototype.getClassName=function(){return"DirectionalLight"},f.prototype.getTypeID=function(){return x.a.LIGHTTYPEID_DIRECTIONALLIGHT},f.prototype._setDefaultShadowProjectionMatrix=function(d,g,p){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(d):this._setDefaultAutoExtendShadowProjectionMatrix(d,g,p)},f.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(d){var g=this.getScene().activeCamera;!g||U.a.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:g.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:g.maxZ,d)},f.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(d,g,p){var _=this.getScene().activeCamera;if(!!_){if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var m=U.e.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;for(var l=Number.MAX_VALUE,y=Number.MIN_VALUE,E=0;E<p.length;E++){var A=p[E];if(!!A)for(var F=A.getBoundingInfo(),B=F.boundingBox,L=0;L<B.vectorsWorld.length;L++)U.e.TransformCoordinatesToRef(B.vectorsWorld[L],g,m),m.x<this._orthoLeft&&(this._orthoLeft=m.x),m.y<this._orthoBottom&&(this._orthoBottom=m.y),m.x>this._orthoRight&&(this._orthoRight=m.x),m.y>this._orthoTop&&(this._orthoTop=m.y),this.autoCalcShadowZBounds&&(m.z<l&&(l=m.z),m.z>y&&(y=m.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=l,this._shadowMaxZ=y)}var I=this._orthoRight-this._orthoLeft,z=this._orthoTop-this._orthoBottom;U.a.OrthoOffCenterLHToRef(this._orthoLeft-I*this.shadowOrthoScale,this._orthoRight+I*this.shadowOrthoScale,this._orthoBottom-z*this.shadowOrthoScale,this._orthoTop+z*this.shadowOrthoScale,this.shadowMinZ!==void 0?this.shadowMinZ:_.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:_.maxZ,d)}},f.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},f.prototype.transferToEffect=function(d,g){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,g),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,g),this)},f.prototype.transferToNodeMaterialEffect=function(d,g){return this.computeTransformedInformation()?(d.setFloat3(g,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(d.setFloat3(g,this.direction.x,this.direction.y,this.direction.z),this)},f.prototype.getDepthMinZ=function(d){return 1},f.prototype.getDepthMaxZ=function(d){return 1},f.prototype.prepareLightSpecificDefines=function(d,g){d["DIRLIGHT"+g]=!0},Object(S.c)([Object(R.c)()],f.prototype,"shadowFrustumSize",null),Object(S.c)([Object(R.c)()],f.prototype,"shadowOrthoScale",null),Object(S.c)([Object(R.c)()],f.prototype,"autoUpdateExtends",void 0),Object(S.c)([Object(R.c)()],f.prototype,"autoCalcShadowZBounds",void 0),Object(S.c)([Object(R.c)("orthoLeft")],f.prototype,"_orthoLeft",void 0),Object(S.c)([Object(R.c)("orthoRight")],f.prototype,"_orthoRight",void 0),Object(S.c)([Object(R.c)("orthoTop")],f.prototype,"_orthoTop",void 0),Object(S.c)([Object(R.c)("orthoBottom")],f.prototype,"_orthoBottom",void 0),f}(G.a)},600:function(we,P,u){"use strict";var S=u(435),R="chromaticAberrationPixelShader",U=`
uniform sampler2D textureSampler;

uniform float chromatic_aberration;
uniform float radialIntensity;
uniform vec2 direction;
uniform vec2 centerPosition;
uniform float screen_width;
uniform float screen_height;

varying vec2 vUV;
void main(void)
{
vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);
vec2 directionOfEffect=direction;
if(directionOfEffect.x == 0. && directionOfEffect.y == 0.){
directionOfEffect=normalize(centered_screen_pos);
}
float radius2=centered_screen_pos.x*centered_screen_pos.x
+centered_screen_pos.y*centered_screen_pos.y;
float radius=sqrt(radius2);
vec4 original=texture2D(textureSampler,vUV);

vec3 ref_indices=vec3(-0.3,0.0,0.3);
float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;
float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;

vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);
vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);
vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);
original.r=texture2D(textureSampler,ref_coords_r).r;
original.g=texture2D(textureSampler,ref_coords_g).g;
original.b=texture2D(textureSampler,ref_coords_b).b;
original.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);
gl_FragColor=original;
}`;S.a.ShadersStore[R]=U;var O={name:R,shader:U}},601:function(we,P,u){"use strict";var S=u(435),R="ssaoCombinePixelShader",U=`uniform sampler2D textureSampler;
uniform sampler2D originalColor;
uniform vec4 viewport;
varying vec2 vUV;
void main(void) {
vec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);
vec4 sceneColor=texture2D(originalColor,vUV);
gl_FragColor=sceneColor*ssaoColor;
}
`;S.a.ShadersStore[R]=U;var O={name:R,shader:U}},602:function(we,P,u){"use strict";u.d(P,"a",function(){return F}),u.d(P,"b",function(){return he}),u.d(P,"g",function(){return le.a}),u.d(P,"h",function(){return Ee}),u.d(P,"i",function(){return Ye}),u.d(P,"c",function(){return _.a}),u.d(P,"d",function(){return p.a}),u.d(P,"e",function(){return He.a}),u.d(P,"f",function(){return A.a});var S=u(434),R=u(439),U=u(438),O=u(440),x=u(442),G=u(577),T=u(587),h=u(518),f=u(579),d=u(586),g=u(517),p=u(481),_=u(466),m=u(570),l=u(578),y=u(437),E=u(448),A=u(482),F=function(Ue){Object(S.d)(re,Ue);function re(Z,fe,ue,Ge,xe){Z===void 0&&(Z=""),fe===void 0&&(fe=!0),ue===void 0&&(ue=E.a.LastCreatedScene),xe===void 0&&(xe=!0);var ne=Ue.call(this,ue.getEngine(),Z)||this;ne._camerasToBeAttached=[],ne.SharpenPostProcessId="SharpenPostProcessEffect",ne.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",ne.FxaaPostProcessId="FxaaPostProcessEffect",ne.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",ne.GrainPostProcessId="GrainPostProcessEffect",ne._glowLayer=null,ne.animations=[],ne._imageProcessingConfigurationObserver=null,ne._sharpenEnabled=!1,ne._bloomEnabled=!1,ne._depthOfFieldEnabled=!1,ne._depthOfFieldBlurLevel=m.b.Low,ne._fxaaEnabled=!1,ne._imageProcessingEnabled=!0,ne._bloomScale=.5,ne._chromaticAberrationEnabled=!1,ne._grainEnabled=!1,ne._buildAllowed=!0,ne.onBuildObservable=new U.c,ne._resizeObserver=null,ne._hardwareScaleLevel=1,ne._bloomKernel=64,ne._bloomWeight=.15,ne._bloomThreshold=.9,ne._samples=1,ne._hasCleared=!1,ne._prevPostProcess=null,ne._prevPrevPostProcess=null,ne._depthOfFieldSceneObserver=null,ne._cameras=Ge||ue.cameras,ne._cameras=ne._cameras.slice(),ne._camerasToBeAttached=ne._cameras.slice(),ne._buildAllowed=xe,ne._scene=ue;var Ke=ne._scene.getEngine().getCaps();ne._hdr=fe&&(Ke.textureHalfFloatRender||Ke.textureFloatRender),ne._hdr?Ke.textureHalfFloatRender?ne._defaultPipelineTextureType=2:Ke.textureFloatRender&&(ne._defaultPipelineTextureType=1):ne._defaultPipelineTextureType=0,ue.postProcessRenderPipelineManager.addPipeline(ne);var nt=ne._scene.getEngine();return ne.sharpen=new T.a("sharpen",1,null,x.a.BILINEAR_SAMPLINGMODE,nt,!1,ne._defaultPipelineTextureType,!0),ne._sharpenEffect=new _.a(nt,ne.SharpenPostProcessId,function(){return ne.sharpen},!0),ne.depthOfField=new m.a(ne._scene,null,ne._depthOfFieldBlurLevel,ne._defaultPipelineTextureType,!0),ne.bloom=new l.a(ne._scene,ne._bloomScale,ne._bloomWeight,ne.bloomKernel,ne._defaultPipelineTextureType,!0),ne.chromaticAberration=new f.a("ChromaticAberration",nt.getRenderWidth(),nt.getRenderHeight(),1,null,x.a.BILINEAR_SAMPLINGMODE,nt,!1,ne._defaultPipelineTextureType,!0),ne._chromaticAberrationEffect=new _.a(nt,ne.ChromaticAberrationPostProcessId,function(){return ne.chromaticAberration},!0),ne.grain=new d.a("Grain",1,null,x.a.BILINEAR_SAMPLINGMODE,nt,!1,ne._defaultPipelineTextureType,!0),ne._grainEffect=new _.a(nt,ne.GrainPostProcessId,function(){return ne.grain},!0),ne._resizeObserver=nt.onResizeObservable.add(function(){ne._hardwareScaleLevel=nt.getHardwareScalingLevel(),ne.bloomKernel=ne.bloomKernel}),ne._imageProcessingConfigurationObserver=ne._scene.imageProcessingConfiguration.onUpdateParameters.add(function(){ne.bloom._downscale._exposure=ne._scene.imageProcessingConfiguration.exposure,ne.imageProcessingEnabled!==ne._scene.imageProcessingConfiguration.isEnabled&&(ne._imageProcessingEnabled=ne._scene.imageProcessingConfiguration.isEnabled,ne._buildPipeline())}),ne._buildPipeline(),ne}return Object.defineProperty(re.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"sharpenEnabled",{get:function(){return this._sharpenEnabled},set:function(Z){this._sharpenEnabled!==Z&&(this._sharpenEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"bloomKernel",{get:function(){return this._bloomKernel},set:function(Z){this._bloomKernel=Z,this.bloom.kernel=Z/this._hardwareScaleLevel},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"bloomWeight",{get:function(){return this._bloomWeight},set:function(Z){this._bloomWeight!==Z&&(this.bloom.weight=Z,this._bloomWeight=Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"bloomThreshold",{get:function(){return this._bloomThreshold},set:function(Z){this._bloomThreshold!==Z&&(this.bloom.threshold=Z,this._bloomThreshold=Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"bloomScale",{get:function(){return this._bloomScale},set:function(Z){this._bloomScale!==Z&&(this._bloomScale=Z,this._rebuildBloom(),this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"bloomEnabled",{get:function(){return this._bloomEnabled},set:function(Z){this._bloomEnabled!==Z&&(this._bloomEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),re.prototype._rebuildBloom=function(){var Z=this.bloom;this.bloom=new l.a(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel,this._defaultPipelineTextureType,!1),this.bloom.threshold=Z.threshold;for(var fe=0;fe<this._cameras.length;fe++)Z.disposeEffects(this._cameras[fe])},Object.defineProperty(re.prototype,"depthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(Z){this._depthOfFieldEnabled!==Z&&(this._depthOfFieldEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"depthOfFieldBlurLevel",{get:function(){return this._depthOfFieldBlurLevel},set:function(Z){if(this._depthOfFieldBlurLevel!==Z){this._depthOfFieldBlurLevel=Z;var fe=this.depthOfField;this.depthOfField=new m.a(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=fe.focalLength,this.depthOfField.focusDistance=fe.focusDistance,this.depthOfField.fStop=fe.fStop,this.depthOfField.lensSize=fe.lensSize;for(var ue=0;ue<this._cameras.length;ue++)fe.disposeEffects(this._cameras[ue]);this._buildPipeline()}},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(Z){this._fxaaEnabled!==Z&&(this._fxaaEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"samples",{get:function(){return this._samples},set:function(Z){this._samples!==Z&&(this._samples=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"imageProcessingEnabled",{get:function(){return this._imageProcessingEnabled},set:function(Z){this._imageProcessingEnabled!==Z&&(this._scene.imageProcessingConfiguration.isEnabled=Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"glowLayerEnabled",{get:function(){return this._glowLayer!=null},set:function(Z){Z&&!this._glowLayer?this._glowLayer=new G.a("",this._scene):!Z&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"glowLayer",{get:function(){return this._glowLayer},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"chromaticAberrationEnabled",{get:function(){return this._chromaticAberrationEnabled},set:function(Z){this._chromaticAberrationEnabled!==Z&&(this._chromaticAberrationEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"grainEnabled",{get:function(){return this._grainEnabled},set:function(Z){this._grainEnabled!==Z&&(this._grainEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),re.prototype.getClassName=function(){return"DefaultRenderingPipeline"},re.prototype.prepare=function(){var Z=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=Z},re.prototype._setAutoClearAndTextureSharing=function(Z,fe){fe===void 0&&(fe=!1),this._hasCleared?Z.autoClear=!1:(Z.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),fe||(this._prevPrevPostProcess?Z.shareOutputWith(this._prevPrevPostProcess):Z.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=Z)},re.prototype._buildPipeline=function(){var Z=this;if(!!this._buildAllowed){this._scene.autoClear=!0;var fe=this._scene.getEngine();if(this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(var ue=0,Ge=this._cameras;ue<Ge.length;ue++){var xe=Ge[ue],ne=this._scene.enableDepthRenderer(xe);ne.useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(function(Ke){Z._cameras.indexOf(Ke.activeCamera)>-1&&(Z.depthOfField.depthTexture=Ke.enableDepthRenderer(Ke.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);var ne=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=ne.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new h.a("imageProcessing",1,null,x.a.BILINEAR_SAMPLINGMODE,fe,!1,this._defaultPipelineTextureType),this._hdr?(this.addEffect(new _.a(fe,this.ImageProcessingPostProcessId,function(){return Z.imageProcessing},!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,(!this.cameras||this.cameras.length===0)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new g.a("fxaa",1,null,x.a.BILINEAR_SAMPLINGMODE,fe,!1,this._defaultPipelineTextureType),this.addEffect(new _.a(fe,this.FxaaPostProcessId,function(){return Z.fxaa},!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&O.a.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}},re.prototype._disposePostProcesses=function(Z){Z===void 0&&(Z=!1);for(var fe=0;fe<this._cameras.length;fe++){var ue=this._cameras[fe];this.imageProcessing&&this.imageProcessing.dispose(ue),this.fxaa&&this.fxaa.dispose(ue),Z&&(this.sharpen&&this.sharpen.dispose(ue),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(ue)),this.bloom&&this.bloom.disposeEffects(ue),this.chromaticAberration&&this.chromaticAberration.dispose(ue),this.grain&&this.grain.dispose(ue),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,Z&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)},re.prototype.addCamera=function(Z){this._camerasToBeAttached.push(Z),this._buildPipeline()},re.prototype.removeCamera=function(Z){var fe=this._camerasToBeAttached.indexOf(Z);this._camerasToBeAttached.splice(fe,1),this._buildPipeline()},re.prototype.dispose=function(){this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),Ue.prototype.dispose.call(this)},re.prototype.serialize=function(){var Z=R.a.Serialize(this);return Z.customType="DefaultRenderingPipeline",Z},re.Parse=function(Z,fe,ue){return R.a.Parse(function(){return new re(Z._name,Z._name._hdr,fe)},Z,fe,ue)},Object(S.c)([Object(R.c)()],re.prototype,"sharpenEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"bloomKernel",null),Object(S.c)([Object(R.c)()],re.prototype,"_bloomWeight",void 0),Object(S.c)([Object(R.c)()],re.prototype,"_bloomThreshold",void 0),Object(S.c)([Object(R.c)()],re.prototype,"_hdr",void 0),Object(S.c)([Object(R.c)()],re.prototype,"bloomWeight",null),Object(S.c)([Object(R.c)()],re.prototype,"bloomThreshold",null),Object(S.c)([Object(R.c)()],re.prototype,"bloomScale",null),Object(S.c)([Object(R.c)()],re.prototype,"bloomEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"depthOfFieldEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"depthOfFieldBlurLevel",null),Object(S.c)([Object(R.c)()],re.prototype,"fxaaEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"samples",null),Object(S.c)([Object(R.c)()],re.prototype,"imageProcessingEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"glowLayerEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"chromaticAberrationEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"grainEnabled",null),re}(p.a);y.a.RegisteredTypes["BABYLON.DefaultRenderingPipeline"]=F;var B=u(479),L=u(444),I=u(600),z=u(435),k="lensHighlightsPixelShader",j=`
uniform sampler2D textureSampler;

uniform float gain;
uniform float threshold;
uniform float screen_width;
uniform float screen_height;

varying vec2 vUV;

vec4 highlightColor(vec4 color) {
vec4 highlight=color;
float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));
float lum_threshold;
if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }
else { lum_threshold=0.5+0.44*threshold; }
luminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);
highlight*=luminance*gain;
highlight.a=1.0;
return highlight;
}
void main(void)
{
vec4 original=texture2D(textureSampler,vUV);

if (gain == -1.0) {
gl_FragColor=vec4(0.0,0.0,0.0,1.0);
return;
}
float w=2.0/screen_width;
float h=2.0/screen_height;
float weight=1.0;

vec4 blurred=vec4(0.0,0.0,0.0,0.0);
#ifdef PENTAGON
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));
#else
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));
#endif
blurred/=39.0;
gl_FragColor=blurred;

}`;z.a.ShadersStore[k]=j;var w={name:k,shader:j},Q="depthOfFieldPixelShader",W=`




uniform sampler2D textureSampler;
uniform sampler2D highlightsSampler;
uniform sampler2D depthSampler;
uniform sampler2D grainSampler;

uniform float grain_amount;
uniform bool blur_noise;
uniform float screen_width;
uniform float screen_height;
uniform float distortion;
uniform bool dof_enabled;

uniform float screen_distance;
uniform float aperture;
uniform float darken;
uniform float edge_blur;
uniform bool highlights;

uniform float near;
uniform float far;

varying vec2 vUV;

#define PI 3.14159265
#define TWOPI 6.28318530
#define inverse_focal_length 0.1

vec2 centered_screen_pos;
vec2 distorted_coords;
float radius2;
float radius;

vec2 rand(vec2 co)
{
float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));
float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));
return clamp(vec2(noise1,noise2),0.0,1.0);
}

vec2 getDistortedCoords(vec2 coords) {
if (distortion == 0.0) { return coords; }
vec2 direction=1.0*normalize(centered_screen_pos);
vec2 dist_coords=vec2(0.5,0.5);
dist_coords.x=0.5+direction.x*radius2*1.0;
dist_coords.y=0.5+direction.y*radius2*1.0;
float dist_amount=clamp(distortion*0.23,0.0,1.0);
dist_coords=mix(coords,dist_coords,dist_amount);
return dist_coords;
}

float sampleScreen(inout vec4 color,const in vec2 offset,const in float weight) {

vec2 coords=distorted_coords;
float angle=rand(coords*100.0).x*TWOPI;
coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));
color+=texture2D(textureSampler,coords)*weight;
return weight;
}

float getBlurLevel(float size) {
return min(3.0,ceil(size/1.0));
}

vec4 getBlurColor(float size) {
vec4 col=texture2D(textureSampler,distorted_coords);


float blur_level=getBlurLevel(size);
float w=(size/screen_width);
float h=(size/screen_height);
float total_weight=1.0;
vec2 sample_coords;
total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);
total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);
total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);
total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);
total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);
total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);
total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);
total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);
total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);
total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);
if (blur_level>1.0) {
total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);
total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);
total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);
total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);
total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);
total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);
total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);
total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);
total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);
total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);
}
if (blur_level>2.0) {
total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);
total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);
total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);
total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);
total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);
total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);
total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);
total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);
total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);
}
col/=total_weight;

if (darken>0.0) {
col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);
}




return col;
}
void main(void)
{

centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);
radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;
radius=sqrt(radius2);
distorted_coords=getDistortedCoords(vUV);
vec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height);
float depth=texture2D(depthSampler,distorted_coords).r;
float distance=near+(far-near)*depth;
vec4 color=texture2D(textureSampler,vUV);


float coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));

if (dof_enabled == false || coc<0.07) { coc=0.0; }

float edge_blur_amount=0.0;
if (edge_blur>0.0) {
edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;
}

float blur_amount=max(edge_blur_amount,coc);

if (blur_amount == 0.0) {
gl_FragColor=texture2D(textureSampler,distorted_coords);
}
else {

gl_FragColor=getBlurColor(blur_amount*1.7);

if (highlights) {
gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;
}
if (blur_noise) {

vec2 noise=rand(distorted_coords)*0.01*blur_amount;
vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);
gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;
}
}

if (grain_amount>0.0) {
vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);
gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;
}
}
`;z.a.ShadersStore[Q]=W;var Y={name:Q,shader:W},he=function(Ue){Object(S.d)(re,Ue);function re(Z,fe,ue,Ge,xe){Ge===void 0&&(Ge=1);var ne=Ue.call(this,ue.getEngine(),Z)||this;return ne.LensChromaticAberrationEffect="LensChromaticAberrationEffect",ne.HighlightsEnhancingEffect="HighlightsEnhancingEffect",ne.LensDepthOfFieldEffect="LensDepthOfFieldEffect",ne._pentagonBokehIsEnabled=!1,ne._scene=ue,ne._depthTexture=ue.enableDepthRenderer().getDepthMap(),fe.grain_texture?ne._grainTexture=fe.grain_texture:ne._createGrainTexture(),ne._edgeBlur=fe.edge_blur?fe.edge_blur:0,ne._grainAmount=fe.grain_amount?fe.grain_amount:0,ne._chromaticAberration=fe.chromatic_aberration?fe.chromatic_aberration:0,ne._distortion=fe.distortion?fe.distortion:0,ne._highlightsGain=fe.dof_gain!==void 0?fe.dof_gain:-1,ne._highlightsThreshold=fe.dof_threshold?fe.dof_threshold:1,ne._dofDistance=fe.dof_focus_distance!==void 0?fe.dof_focus_distance:-1,ne._dofAperture=fe.dof_aperture?fe.dof_aperture:1,ne._dofDarken=fe.dof_darken?fe.dof_darken:0,ne._dofPentagon=fe.dof_pentagon!==void 0?fe.dof_pentagon:!0,ne._blurNoise=fe.blur_noise!==void 0?fe.blur_noise:!0,ne._createChromaticAberrationPostProcess(Ge),ne._createHighlightsPostProcess(Ge),ne._createDepthOfFieldPostProcess(Ge/4),ne.addEffect(new _.a(ue.getEngine(),ne.LensChromaticAberrationEffect,function(){return ne._chromaticAberrationPostProcess},!0)),ne.addEffect(new _.a(ue.getEngine(),ne.HighlightsEnhancingEffect,function(){return ne._highlightsPostProcess},!0)),ne.addEffect(new _.a(ue.getEngine(),ne.LensDepthOfFieldEffect,function(){return ne._depthOfFieldPostProcess},!0)),ne._highlightsGain===-1&&ne._disableEffect(ne.HighlightsEnhancingEffect,null),ue.postProcessRenderPipelineManager.addPipeline(ne),xe&&ue.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(Z,xe),ne}return re.prototype.getClassName=function(){return"LensRenderingPipeline"},Object.defineProperty(re.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"edgeBlur",{get:function(){return this._edgeBlur},set:function(Z){this.setEdgeBlur(Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"grainAmount",{get:function(){return this._grainAmount},set:function(Z){this.setGrainAmount(Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"chromaticAberration",{get:function(){return this._chromaticAberration},set:function(Z){this.setChromaticAberration(Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"dofAperture",{get:function(){return this._dofAperture},set:function(Z){this.setAperture(Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"edgeDistortion",{get:function(){return this._distortion},set:function(Z){this.setEdgeDistortion(Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"dofDistortion",{get:function(){return this._dofDistance},set:function(Z){this.setFocusDistance(Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"darkenOutOfFocus",{get:function(){return this._dofDarken},set:function(Z){this.setDarkenOutOfFocus(Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"blurNoise",{get:function(){return this._blurNoise},set:function(Z){this._blurNoise=Z},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"pentagonBokeh",{get:function(){return this._pentagonBokehIsEnabled},set:function(Z){Z?this.enablePentagonBokeh():this.disablePentagonBokeh()},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"highlightsGain",{get:function(){return this._highlightsGain},set:function(Z){this.setHighlightsGain(Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"highlightsThreshold",{get:function(){return this._highlightsThreshold},set:function(Z){this.setHighlightsThreshold(Z)},enumerable:!1,configurable:!0}),re.prototype.setEdgeBlur=function(Z){this._edgeBlur=Z},re.prototype.disableEdgeBlur=function(){this._edgeBlur=0},re.prototype.setGrainAmount=function(Z){this._grainAmount=Z},re.prototype.disableGrain=function(){this._grainAmount=0},re.prototype.setChromaticAberration=function(Z){this._chromaticAberration=Z},re.prototype.disableChromaticAberration=function(){this._chromaticAberration=0},re.prototype.setEdgeDistortion=function(Z){this._distortion=Z},re.prototype.disableEdgeDistortion=function(){this._distortion=0},re.prototype.setFocusDistance=function(Z){this._dofDistance=Z},re.prototype.disableDepthOfField=function(){this._dofDistance=-1},re.prototype.setAperture=function(Z){this._dofAperture=Z},re.prototype.setDarkenOutOfFocus=function(Z){this._dofDarken=Z},re.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect(`#define PENTAGON
`),this._pentagonBokehIsEnabled=!0},re.prototype.disablePentagonBokeh=function(){this._pentagonBokehIsEnabled=!1,this._highlightsPostProcess.updateEffect()},re.prototype.enableNoiseBlur=function(){this._blurNoise=!0},re.prototype.disableNoiseBlur=function(){this._blurNoise=!1},re.prototype.setHighlightsGain=function(Z){this._highlightsGain=Z},re.prototype.setHighlightsThreshold=function(Z){this._highlightsGain===-1&&(this._highlightsGain=1),this._highlightsThreshold=Z},re.prototype.disableHighlights=function(){this._highlightsGain=-1},re.prototype.dispose=function(Z){Z===void 0&&(Z=!1),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=null,this._highlightsPostProcess=null,this._depthOfFieldPostProcess=null,this._grainTexture.dispose(),Z&&this._scene.disableDepthRenderer()},re.prototype._createChromaticAberrationPostProcess=function(Z){var fe=this;this._chromaticAberrationPostProcess=new L.a("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],Z,null,x.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=function(ue){ue.setFloat("chromatic_aberration",fe._chromaticAberration),ue.setFloat("screen_width",fe._scene.getEngine().getRenderWidth()),ue.setFloat("screen_height",fe._scene.getEngine().getRenderHeight()),ue.setFloat("radialIntensity",1),ue.setFloat2("direction",17,17),ue.setFloat2("centerPosition",.5,.5)}},re.prototype._createHighlightsPostProcess=function(Z){var fe=this;this._highlightsPostProcess=new L.a("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],Z,null,x.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?`#define PENTAGON
`:""),this._highlightsPostProcess.onApply=function(ue){ue.setFloat("gain",fe._highlightsGain),ue.setFloat("threshold",fe._highlightsThreshold),ue.setTextureFromPostProcess("textureSampler",fe._chromaticAberrationPostProcess),ue.setFloat("screen_width",fe._scene.getEngine().getRenderWidth()),ue.setFloat("screen_height",fe._scene.getEngine().getRenderHeight())}},re.prototype._createDepthOfFieldPostProcess=function(Z){var fe=this;this._depthOfFieldPostProcess=new L.a("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],Z,null,x.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.onApply=function(ue){ue.setTexture("depthSampler",fe._depthTexture),ue.setTexture("grainSampler",fe._grainTexture),ue.setTextureFromPostProcess("textureSampler",fe._highlightsPostProcess),ue.setTextureFromPostProcess("highlightsSampler",fe._depthOfFieldPostProcess),ue.setFloat("grain_amount",fe._grainAmount),ue.setBool("blur_noise",fe._blurNoise),ue.setFloat("screen_width",fe._scene.getEngine().getRenderWidth()),ue.setFloat("screen_height",fe._scene.getEngine().getRenderHeight()),ue.setFloat("distortion",fe._distortion),ue.setBool("dof_enabled",fe._dofDistance!==-1),ue.setFloat("screen_distance",1/(.1-1/fe._dofDistance)),ue.setFloat("aperture",fe._dofAperture),ue.setFloat("darken",fe._dofDarken),ue.setFloat("edge_blur",fe._edgeBlur),ue.setBool("highlights",fe._highlightsGain!==-1),fe._scene.activeCamera&&(ue.setFloat("near",fe._scene.activeCamera.minZ),ue.setFloat("far",fe._scene.activeCamera.maxZ))}},re.prototype._createGrainTexture=function(){var Z=512;this._grainTexture=new B.a("LensNoiseTexture",Z,this._scene,!1,x.a.BILINEAR_SAMPLINGMODE),this._grainTexture.wrapU=x.a.WRAP_ADDRESSMODE,this._grainTexture.wrapV=x.a.WRAP_ADDRESSMODE;for(var fe=this._grainTexture.getContext(),ue=function(Ke,nt){return Math.random()*(nt-Ke)+Ke},Ge,xe=0;xe<Z;xe++)for(var ne=0;ne<Z;ne++)Ge=Math.floor(ue(.42,.58)*255),fe.fillStyle="rgb("+Ge+", "+Ge+", "+Ge+")",fe.fillRect(xe,ne,1,1);this._grainTexture.update(!1)},re}(p.a),le=u(594),J=u(436),Re=u(486),Me=u(472),me="ssaoPixelShader",H=`
uniform sampler2D textureSampler;
varying vec2 vUV;
#ifdef SSAO
uniform sampler2D randomSampler;
uniform float randTextureTiles;
uniform float samplesFactor;
uniform vec3 sampleSphere[SAMPLES];
uniform float totalStrength;
uniform float radius;
uniform float area;
uniform float fallOff;
uniform float base;
vec3 normalFromDepth(float depth,vec2 coords)
{
vec2 offset1=vec2(0.0,radius);
vec2 offset2=vec2(radius,0.0);
float depth1=texture2D(textureSampler,coords+offset1).r;
float depth2=texture2D(textureSampler,coords+offset2).r;
vec3 p1=vec3(offset1,depth1-depth);
vec3 p2=vec3(offset2,depth2-depth);
vec3 normal=cross(p1,p2);
normal.z=-normal.z;
return normalize(normal);
}
void main()
{
vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);
float depth=texture2D(textureSampler,vUV).r;
vec3 position=vec3(vUV,depth);
vec3 normal=normalFromDepth(depth,vUV);
float radiusDepth=radius/depth;
float occlusion=0.0;
vec3 ray;
vec3 hemiRay;
float occlusionDepth;
float difference;
for (int i=0; i<SAMPLES; i++)
{
ray=radiusDepth*reflect(sampleSphere[i],random);
hemiRay=position+sign(dot(ray,normal))*ray;
occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;
difference=depth-occlusionDepth;
occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));
}
float ao=1.0-totalStrength*occlusion*samplesFactor;
float result=clamp(ao+base,0.0,1.0);
gl_FragColor.r=result;
gl_FragColor.g=result;
gl_FragColor.b=result;
gl_FragColor.a=1.0;
}
#endif
`;z.a.ShadersStore[me]=H;var q={name:me,shader:H},_e=u(601),Ee=function(Ue){Object(S.d)(re,Ue);function re(Z,fe,ue,Ge){var xe=Ue.call(this,fe.getEngine(),Z)||this;xe.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",xe.SSAORenderEffect="SSAORenderEffect",xe.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",xe.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",xe.SSAOCombineRenderEffect="SSAOCombineRenderEffect",xe.totalStrength=1,xe.radius=1e-4,xe.area=.0075,xe.fallOff=1e-6,xe.base=.5,xe._firstUpdate=!0,xe._scene=fe,xe._createRandomTexture(),xe._depthTexture=fe.enableDepthRenderer().getDepthMap();var ne=ue.ssaoRatio||ue,Ke=ue.combineRatio||ue;return xe._originalColorPostProcess=new Re.b("SSAOOriginalSceneColor",Ke,null,x.a.BILINEAR_SAMPLINGMODE,fe.getEngine(),!1),xe._createSSAOPostProcess(ne),xe._createBlurPostProcess(ne),xe._createSSAOCombinePostProcess(Ke),xe.addEffect(new _.a(fe.getEngine(),xe.SSAOOriginalSceneColorEffect,function(){return xe._originalColorPostProcess},!0)),xe.addEffect(new _.a(fe.getEngine(),xe.SSAORenderEffect,function(){return xe._ssaoPostProcess},!0)),xe.addEffect(new _.a(fe.getEngine(),xe.SSAOBlurHRenderEffect,function(){return xe._blurHPostProcess},!0)),xe.addEffect(new _.a(fe.getEngine(),xe.SSAOBlurVRenderEffect,function(){return xe._blurVPostProcess},!0)),xe.addEffect(new _.a(fe.getEngine(),xe.SSAOCombineRenderEffect,function(){return xe._ssaoCombinePostProcess},!0)),fe.postProcessRenderPipelineManager.addPipeline(xe),Ge&&fe.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(Z,Ge),xe}return Object.defineProperty(re.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),re.prototype.getClassName=function(){return"SSAORenderingPipeline"},re.prototype.dispose=function(Z){Z===void 0&&(Z=!1);for(var fe=0;fe<this._scene.cameras.length;fe++){var ue=this._scene.cameras[fe];this._originalColorPostProcess.dispose(ue),this._ssaoPostProcess.dispose(ue),this._blurHPostProcess.dispose(ue),this._blurVPostProcess.dispose(ue),this._ssaoCombinePostProcess.dispose(ue)}this._randomTexture.dispose(),Z&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),Ue.prototype.dispose.call(this)},re.prototype._createBlurPostProcess=function(Z){var fe=this,ue=16;this._blurHPostProcess=new Me.a("BlurH",new J.d(1,0),ue,Z,null,x.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new Me.a("BlurV",new J.d(0,1),ue,Z,null,x.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(function(){var Ge=fe._blurHPostProcess.width/fe._scene.getEngine().getRenderWidth();fe._blurHPostProcess.kernel=ue*Ge}),this._blurVPostProcess.onActivateObservable.add(function(){var Ge=fe._blurVPostProcess.height/fe._scene.getEngine().getRenderHeight();fe._blurVPostProcess.kernel=ue*Ge})},re.prototype._rebuild=function(){this._firstUpdate=!0,Ue.prototype._rebuild.call(this)},re.prototype._createSSAOPostProcess=function(Z){var fe=this,ue=16,Ge=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],xe=1/ue;this._ssaoPostProcess=new L.a("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],Z,null,x.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES "+ue+`
#define SSAO`),this._ssaoPostProcess.onApply=function(ne){fe._firstUpdate&&(ne.setArray3("sampleSphere",Ge),ne.setFloat("samplesFactor",xe),ne.setFloat("randTextureTiles",4)),ne.setFloat("totalStrength",fe.totalStrength),ne.setFloat("radius",fe.radius),ne.setFloat("area",fe.area),ne.setFloat("fallOff",fe.fallOff),ne.setFloat("base",fe.base),ne.setTexture("textureSampler",fe._depthTexture),ne.setTexture("randomSampler",fe._randomTexture)}},re.prototype._createSSAOCombinePostProcess=function(Z){var fe=this;this._ssaoCombinePostProcess=new L.a("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],Z,null,x.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(ue){ue.setVector4("viewport",J.c.Vector4[0].copyFromFloats(0,0,1,1)),ue.setTextureFromPostProcess("originalColor",fe._originalColorPostProcess)}},re.prototype._createRandomTexture=function(){var Z=512;this._randomTexture=new B.a("SSAORandomTexture",Z,this._scene,!1,x.a.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=x.a.WRAP_ADDRESSMODE,this._randomTexture.wrapV=x.a.WRAP_ADDRESSMODE;for(var fe=this._randomTexture.getContext(),ue=function(Ke,nt){return Math.random()*(nt-Ke)+Ke},Ge=J.e.Zero(),xe=0;xe<Z;xe++)for(var ne=0;ne<Z;ne++)Ge.x=Math.floor(ue(-1,1)*255),Ge.y=Math.floor(ue(-1,1)*255),Ge.z=Math.floor(ue(-1,1)*255),fe.fillStyle="rgb("+Ge.x+", "+Ge.y+", "+Ge.z+")",fe.fillRect(xe,ne,1,1);this._randomTexture.update(!1)},Object(S.c)([Object(R.c)()],re.prototype,"totalStrength",void 0),Object(S.c)([Object(R.c)()],re.prototype,"radius",void 0),Object(S.c)([Object(R.c)()],re.prototype,"area",void 0),Object(S.c)([Object(R.c)()],re.prototype,"fallOff",void 0),Object(S.c)([Object(R.c)()],re.prototype,"base",void 0),re}(p.a),Te=u(450),se=u(571),ve=u(581),ye=u(535),Le="standardPixelShader",be=`uniform sampler2D textureSampler;
varying vec2 vUV;
#if defined(PASS_POST_PROCESS)
void main(void)
{
vec4 color=texture2D(textureSampler,vUV);
gl_FragColor=color;
}
#endif
#if defined(DOWN_SAMPLE_X4)
uniform vec2 dsOffsets[16];
void main(void)
{
vec4 average=vec4(0.0,0.0,0.0,0.0);
average=texture2D(textureSampler,vUV+dsOffsets[0]);
average+=texture2D(textureSampler,vUV+dsOffsets[1]);
average+=texture2D(textureSampler,vUV+dsOffsets[2]);
average+=texture2D(textureSampler,vUV+dsOffsets[3]);
average+=texture2D(textureSampler,vUV+dsOffsets[4]);
average+=texture2D(textureSampler,vUV+dsOffsets[5]);
average+=texture2D(textureSampler,vUV+dsOffsets[6]);
average+=texture2D(textureSampler,vUV+dsOffsets[7]);
average+=texture2D(textureSampler,vUV+dsOffsets[8]);
average+=texture2D(textureSampler,vUV+dsOffsets[9]);
average+=texture2D(textureSampler,vUV+dsOffsets[10]);
average+=texture2D(textureSampler,vUV+dsOffsets[11]);
average+=texture2D(textureSampler,vUV+dsOffsets[12]);
average+=texture2D(textureSampler,vUV+dsOffsets[13]);
average+=texture2D(textureSampler,vUV+dsOffsets[14]);
average+=texture2D(textureSampler,vUV+dsOffsets[15]);
average/=16.0;
gl_FragColor=average;
}
#endif
#if defined(BRIGHT_PASS)
uniform vec2 dsOffsets[4];
uniform float brightThreshold;
void main(void)
{
vec4 average=vec4(0.0,0.0,0.0,0.0);
average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));
average*=0.25;
float luminance=length(average.rgb);
if (luminance<brightThreshold) {
average=vec4(0.0,0.0,0.0,1.0);
}
gl_FragColor=average;
}
#endif
#if defined(TEXTURE_ADDER)
uniform sampler2D otherSampler;
uniform sampler2D lensSampler;
uniform float exposure;
void main(void)
{
vec3 colour=texture2D(textureSampler,vUV).rgb;
colour*=exposure;
vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);
vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);
colour=retColor*retColor;
colour+=colour*texture2D(lensSampler,vUV).rgb;
vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);
gl_FragColor=finalColor;
}
#endif
#if defined(VLS)
#define PI 3.1415926535897932384626433832795
uniform mat4 shadowViewProjection;
uniform mat4 lightWorld;
uniform vec3 cameraPosition;
uniform vec3 sunDirection;
uniform vec3 sunColor;
uniform vec2 depthValues;
uniform float scatteringCoefficient;
uniform float scatteringPower;
uniform sampler2D shadowMapSampler;
uniform sampler2D positionSampler;
float computeScattering(float lightDotView)
{
float result=1.0-scatteringCoefficient*scatteringCoefficient;
result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));
return result;
}
void main(void)
{

vec3 worldPos=texture2D(positionSampler,vUV).rgb;
vec3 startPosition=cameraPosition;
vec3 rayVector=worldPos-startPosition;
float rayLength=length(rayVector);
vec3 rayDirection=rayVector/rayLength;
float stepLength=rayLength/NB_STEPS;
vec3 stepL=rayDirection*stepLength;
vec3 currentPosition=startPosition;
vec3 accumFog=vec3(0.0);
for (int i=0; i<int(NB_STEPS); i++)
{
vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);
float depthMetric=(worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depthMetric,0.0,1.0);
worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;
worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);
float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;
if (shadowMapValue>shadowPixelDepth)
accumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));
currentPosition+=stepL;
}
accumFog/=NB_STEPS;
vec3 color=accumFog*scatteringPower;
gl_FragColor=vec4(color*exp(color) ,1.0);
}
#endif
#if defined(VLSMERGE)
uniform sampler2D originalSampler;
void main(void)
{
gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);
}
#endif
#if defined(LUMINANCE)
uniform vec2 lumOffsets[4];
void main()
{
float average=0.0;
vec4 color=vec4(0.0);
float maximum=-1e20;
vec3 weight=vec3(0.299,0.587,0.114);
for (int i=0; i<4; i++)
{
color=texture2D(textureSampler,vUV+ lumOffsets[i]);

float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));

#ifdef WEIGHTED_AVERAGE
float GreyValue=dot(color.rgb,weight);
#endif
#ifdef BRIGHTNESS
float GreyValue=max(color.r,max(color.g,color.b));
#endif
#ifdef HSL_COMPONENT
float GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));
#endif
#ifdef MAGNITUDE
float GreyValue=length(color.rgb);
#endif
maximum=max(maximum,GreyValue);
average+=(0.25*log(1e-5+GreyValue));
}
average=exp(average);
gl_FragColor=vec4(average,maximum,0.0,1.0);
}
#endif
#if defined(LUMINANCE_DOWN_SAMPLE)
uniform vec2 dsOffsets[9];
uniform float halfDestPixelSize;
#ifdef FINAL_DOWN_SAMPLER
#include<packingFunctions>
#endif
void main()
{
vec4 color=vec4(0.0);
float average=0.0;
for (int i=0; i<9; i++)
{
color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);
average+=color.r;
}
average/=9.0;
#ifdef FINAL_DOWN_SAMPLER
gl_FragColor=pack(average);
#else
gl_FragColor=vec4(average,average,0.0,1.0);
#endif
}
#endif
#if defined(HDR)
uniform sampler2D textureAdderSampler;
uniform float averageLuminance;
void main()
{
vec4 color=texture2D(textureAdderSampler,vUV);
#ifndef AUTO_EXPOSURE
vec4 adjustedColor=color/averageLuminance;
color=adjustedColor;
color.a=1.0;
#endif
gl_FragColor=color;
}
#endif
#if defined(LENS_FLARE)
#define GHOSTS 3
uniform sampler2D lensColorSampler;
uniform float strength;
uniform float ghostDispersal;
uniform float haloWidth;
uniform vec2 resolution;
uniform float distortionStrength;
float hash(vec2 p)
{
float h=dot(p,vec2(127.1,311.7));
return -1.0+2.0*fract(sin(h)*43758.5453123);
}
float noise(in vec2 p)
{
vec2 i=floor(p);
vec2 f=fract(p);
vec2 u=f*f*(3.0-2.0*f);
return mix(mix(hash(i+vec2(0.0,0.0)),
hash(i+vec2(1.0,0.0)),u.x),
mix(hash(i+vec2(0.0,1.0)),
hash(i+vec2(1.0,1.0)),u.x),u.y);
}
float fbm(vec2 p)
{
float f=0.0;
f+=0.5000*noise(p); p*=2.02;
f+=0.2500*noise(p); p*=2.03;
f+=0.1250*noise(p); p*=2.01;
f+=0.0625*noise(p); p*=2.04;
f/=0.9375;
return f;
}
vec3 pattern(vec2 uv)
{
vec2 p=-1.0+2.0*uv;
float p2=dot(p,p);
float f=fbm(vec2(15.0*p2))/2.0;
float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));
float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));
float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));
return (1.0-f)*vec3(r,g,b);
}
float luminance(vec3 color)
{
return dot(color.rgb,vec3(0.2126,0.7152,0.0722));
}
vec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)
{
return vec4(
texture2D(tex,texcoord+direction*distortion.r).r,
texture2D(tex,texcoord+direction*distortion.g).g,
texture2D(tex,texcoord+direction*distortion.b).b,
1.0
);
}
void main(void)
{
vec2 uv=-vUV+vec2(1.0);
vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;
vec2 texelSize=1.0/resolution;
vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);
vec4 result=vec4(0.0);
float ghostIndice=1.0;
for (int i=0; i<GHOSTS; ++i)
{
vec2 offset=fract(uv+ghostDir*ghostIndice);
float weight=length(vec2(0.5)-offset)/length(vec2(0.5));
weight=pow(1.0-weight,10.0);
result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;
ghostIndice+=1.0;
}
vec2 haloVec=normalize(ghostDir)*haloWidth;
float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));
weight=pow(1.0-weight,10.0);
result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;
result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));
gl_FragColor=result;
}
#endif
#if defined(LENS_FLARE_COMPOSE)
uniform sampler2D otherSampler;
uniform sampler2D lensDirtSampler;
uniform sampler2D lensStarSampler;
uniform mat4 lensStarMatrix;
void main(void)
{
vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;
vec4 lensMod=texture2D(lensDirtSampler,vUV);
lensMod+=texture2D(lensStarSampler,vUV);
vec4 result=texture2D(textureSampler,vUV)*lensMod;
gl_FragColor=texture2D(otherSampler,vUV)+result;
}
#endif
#if defined(DEPTH_OF_FIELD)
uniform sampler2D otherSampler;
uniform sampler2D depthSampler;
uniform float distance;
void main(void)
{
vec4 sharp=texture2D(otherSampler,vUV);
vec4 blur=texture2D(textureSampler,vUV);
float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);
float factor=0.0;
if (dist<0.05)
factor=1.0;
else if (dist<0.1)
factor=20.0*(0.1-dist);
else if (dist<0.5)
factor=0.0;
else
factor=2.0*(dist-0.5);
factor=clamp(factor,0.0,0.90);
gl_FragColor=mix(sharp,blur,factor);
}
#endif
#if defined(MOTION_BLUR)
uniform mat4 inverseViewProjection;
uniform mat4 prevViewProjection;
uniform vec2 screenSize;
uniform float motionScale;
uniform float motionStrength;
uniform sampler2D depthSampler;
void main(void)
{
vec2 texelSize=1.0/screenSize;
float depth=texture2D(depthSampler,vUV).r;
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);
cpos=cpos*inverseViewProjection;
vec4 ppos=cpos*prevViewProjection;
ppos.xyz/=ppos.w;
ppos.xy=ppos.xy*0.5+0.5;
vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;
float speed=length(velocity/texelSize);
int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {
if (i>=nSamples)
break;
vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
result+=texture2D(textureSampler,offset1);
}
gl_FragColor=result/float(nSamples);
}
#endif
`;z.a.ShadersStore[Le]=be;var ze={name:Le,shader:be},Ye=function(Ue){Object(S.d)(re,Ue);function re(Z,fe,ue,Ge,xe){Ge===void 0&&(Ge=null);var ne=Ue.call(this,fe.getEngine(),Z)||this;return ne.downSampleX4PostProcess=null,ne.brightPassPostProcess=null,ne.blurHPostProcesses=[],ne.blurVPostProcesses=[],ne.textureAdderPostProcess=null,ne.volumetricLightPostProcess=null,ne.volumetricLightSmoothXPostProcess=null,ne.volumetricLightSmoothYPostProcess=null,ne.volumetricLightMergePostProces=null,ne.volumetricLightFinalPostProcess=null,ne.luminancePostProcess=null,ne.luminanceDownSamplePostProcesses=[],ne.hdrPostProcess=null,ne.textureAdderFinalPostProcess=null,ne.lensFlareFinalPostProcess=null,ne.hdrFinalPostProcess=null,ne.lensFlarePostProcess=null,ne.lensFlareComposePostProcess=null,ne.motionBlurPostProcess=null,ne.depthOfFieldPostProcess=null,ne.fxaaPostProcess=null,ne.screenSpaceReflectionPostProcess=null,ne.brightThreshold=1,ne.blurWidth=512,ne.horizontalBlur=!1,ne.lensTexture=null,ne.volumetricLightCoefficient=.2,ne.volumetricLightPower=4,ne.volumetricLightBlurScale=64,ne.sourceLight=null,ne.hdrMinimumLuminance=1,ne.hdrDecreaseRate=.5,ne.hdrIncreaseRate=.5,ne.lensColorTexture=null,ne.lensFlareStrength=20,ne.lensFlareGhostDispersal=1.4,ne.lensFlareHaloWidth=.7,ne.lensFlareDistortionStrength=16,ne.lensFlareBlurWidth=512,ne.lensStarTexture=null,ne.lensFlareDirtTexture=null,ne.depthOfFieldDistance=10,ne.depthOfFieldBlurWidth=64,ne.animations=[],ne._currentDepthOfFieldSource=null,ne._fixedExposure=1,ne._currentExposure=1,ne._hdrAutoExposure=!1,ne._hdrCurrentLuminance=1,ne._motionStrength=1,ne._isObjectBasedMotionBlur=!1,ne._camerasToBeAttached=[],ne._bloomEnabled=!1,ne._depthOfFieldEnabled=!1,ne._vlsEnabled=!1,ne._lensFlareEnabled=!1,ne._hdrEnabled=!1,ne._motionBlurEnabled=!1,ne._fxaaEnabled=!1,ne._screenSpaceReflectionsEnabled=!1,ne._motionBlurSamples=64,ne._volumetricLightStepsCount=50,ne._samples=1,ne._cameras=xe||fe.cameras,ne._cameras=ne._cameras.slice(),ne._camerasToBeAttached=ne._cameras.slice(),ne._scene=fe,ne._basePostProcess=Ge,ne._ratio=ue,ne._floatTextureType=fe.getEngine().getCaps().textureFloatRender?1:2,fe.postProcessRenderPipelineManager.addPipeline(ne),ne._buildPipeline(),ne}return Object.defineProperty(re.prototype,"exposure",{get:function(){return this._fixedExposure},set:function(Z){this._fixedExposure=Z,this._currentExposure=Z},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"hdrAutoExposure",{get:function(){return this._hdrAutoExposure},set:function(Z){if(this._hdrAutoExposure=Z,this.hdrPostProcess){var fe=["#define HDR"];Z&&fe.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(fe.join(`
`))}},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"motionStrength",{get:function(){return this._motionStrength},set:function(Z){this._motionStrength=Z,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=Z)},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"objectBasedMotionBlur",{get:function(){return this._isObjectBasedMotionBlur},set:function(Z){var fe=this._isObjectBasedMotionBlur!==Z;this._isObjectBasedMotionBlur=Z,fe&&this._buildPipeline()},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"BloomEnabled",{get:function(){return this._bloomEnabled},set:function(Z){this._bloomEnabled!==Z&&(this._bloomEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"DepthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(Z){this._depthOfFieldEnabled!==Z&&(this._depthOfFieldEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"LensFlareEnabled",{get:function(){return this._lensFlareEnabled},set:function(Z){this._lensFlareEnabled!==Z&&(this._lensFlareEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"HDREnabled",{get:function(){return this._hdrEnabled},set:function(Z){this._hdrEnabled!==Z&&(this._hdrEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"VLSEnabled",{get:function(){return this._vlsEnabled},set:function(Z){if(this._vlsEnabled!==Z){if(Z){var fe=this._scene.enableGeometryBufferRenderer();if(!fe){O.a.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}}this._vlsEnabled=Z,this._buildPipeline()}},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"MotionBlurEnabled",{get:function(){return this._motionBlurEnabled},set:function(Z){this._motionBlurEnabled!==Z&&(this._motionBlurEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(Z){this._fxaaEnabled!==Z&&(this._fxaaEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"screenSpaceReflectionsEnabled",{get:function(){return this._screenSpaceReflectionsEnabled},set:function(Z){this._screenSpaceReflectionsEnabled!==Z&&(this._screenSpaceReflectionsEnabled=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"volumetricLightStepsCount",{get:function(){return this._volumetricLightStepsCount},set:function(Z){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect(`#define VLS
#define NB_STEPS `+Z.toFixed(1)),this._volumetricLightStepsCount=Z},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(Z){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=Z:this.motionBlurPostProcess.updateEffect(`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+Z.toFixed(1))),this._motionBlurSamples=Z},enumerable:!1,configurable:!0}),Object.defineProperty(re.prototype,"samples",{get:function(){return this._samples},set:function(Z){this._samples!==Z&&(this._samples=Z,this._buildPipeline())},enumerable:!1,configurable:!0}),re.prototype._buildPipeline=function(){var Z=this,fe=this._ratio,ue=this._scene;this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new ve.a("HDRPass",ue,fe,null,x.a.BILINEAR_SAMPLINGMODE,ue.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(function(){Z._currentDepthOfFieldSource=Z.screenSpaceReflectionPostProcess}),this.addEffect(new _.a(ue.getEngine(),"HDRScreenSpaceReflections",function(){return Z.screenSpaceReflectionPostProcess},!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new L.a("HDRPass","standard",[],[],fe,null,x.a.BILINEAR_SAMPLINGMODE,ue.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(function(){Z._currentDepthOfFieldSource=Z.originalPostProcess}),this.addEffect(new _.a(ue.getEngine(),"HDRPassPostProcess",function(){return Z.originalPostProcess},!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(ue,fe/4),this._createBrightPassPostProcess(ue,fe/4),this._createBlurPostProcesses(ue,fe/4,1),this._createTextureAdderPostProcess(ue,fe),this.textureAdderFinalPostProcess=new L.a("HDRDepthOfFieldSource","standard",[],[],fe,null,x.a.BILINEAR_SAMPLINGMODE,ue.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new _.a(ue.getEngine(),"HDRBaseDepthOfFieldSource",function(){return Z.textureAdderFinalPostProcess},!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(ue,fe),this.volumetricLightFinalPostProcess=new L.a("HDRVLSFinal","standard",[],[],fe,null,x.a.BILINEAR_SAMPLINGMODE,ue.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new _.a(ue.getEngine(),"HDRVLSFinal",function(){return Z.volumetricLightFinalPostProcess},!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(ue,fe),this.lensFlareFinalPostProcess=new L.a("HDRPostLensFlareDepthOfFieldSource","standard",[],[],fe,null,x.a.BILINEAR_SAMPLINGMODE,ue.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new _.a(ue.getEngine(),"HDRPostLensFlareDepthOfFieldSource",function(){return Z.lensFlareFinalPostProcess},!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(ue,this._floatTextureType),this._createHdrPostProcess(ue,fe),this.hdrFinalPostProcess=new L.a("HDRPostHDReDepthOfFieldSource","standard",[],[],fe,null,x.a.BILINEAR_SAMPLINGMODE,ue.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new _.a(ue.getEngine(),"HDRPostHDReDepthOfFieldSource",function(){return Z.hdrFinalPostProcess},!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(ue,fe/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(ue,fe)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(ue,fe),this._fxaaEnabled&&(this.fxaaPostProcess=new g.a("fxaa",1,null,x.a.BILINEAR_SAMPLINGMODE,ue.getEngine(),!1,0),this.addEffect(new _.a(ue.getEngine(),"HDRFxaa",function(){return Z.fxaaPostProcess},!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&O.a.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")},re.prototype._createDownSampleX4PostProcess=function(Z,fe){var ue=this,Ge=new Array(32);this.downSampleX4PostProcess=new L.a("HDRDownSampleX4","standard",["dsOffsets"],[],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=function(xe){for(var ne=0,Ke=ue.downSampleX4PostProcess.width,nt=ue.downSampleX4PostProcess.height,ut=-2;ut<2;ut++)for(var pt=-2;pt<2;pt++)Ge[ne]=(ut+.5)*(1/Ke),Ge[ne+1]=(pt+.5)*(1/nt),ne+=2;xe.setArray2("dsOffsets",Ge)},this.addEffect(new _.a(Z.getEngine(),"HDRDownSampleX4",function(){return ue.downSampleX4PostProcess},!0))},re.prototype._createBrightPassPostProcess=function(Z,fe){var ue=this,Ge=new Array(8);this.brightPassPostProcess=new L.a("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=function(xe){var ne=1/ue.brightPassPostProcess.width,Ke=1/ue.brightPassPostProcess.height;Ge[0]=-.5*ne,Ge[1]=.5*Ke,Ge[2]=.5*ne,Ge[3]=.5*Ke,Ge[4]=-.5*ne,Ge[5]=-.5*Ke,Ge[6]=.5*ne,Ge[7]=-.5*Ke,xe.setArray2("dsOffsets",Ge),xe.setFloat("brightThreshold",ue.brightThreshold)},this.addEffect(new _.a(Z.getEngine(),"HDRBrightPass",function(){return ue.brightPassPostProcess},!0))},re.prototype._createBlurPostProcesses=function(Z,fe,ue,Ge){var xe=this;Ge===void 0&&(Ge="blurWidth");var ne=Z.getEngine(),Ke=new Me.a("HDRBlurH_"+ue,new J.d(1,0),this[Ge],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,this._floatTextureType),nt=new Me.a("HDRBlurV_"+ue,new J.d(0,1),this[Ge],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,this._floatTextureType);Ke.onActivateObservable.add(function(){var ut=Ke.width/ne.getRenderWidth();Ke.kernel=xe[Ge]*ut}),nt.onActivateObservable.add(function(){var ut=nt.height/ne.getRenderHeight();nt.kernel=xe.horizontalBlur?64*ut:xe[Ge]*ut}),this.addEffect(new _.a(Z.getEngine(),"HDRBlurH"+ue,function(){return Ke},!0)),this.addEffect(new _.a(Z.getEngine(),"HDRBlurV"+ue,function(){return nt},!0)),this.blurHPostProcesses.push(Ke),this.blurVPostProcesses.push(nt)},re.prototype._createTextureAdderPostProcess=function(Z,fe){var ue=this;this.textureAdderPostProcess=new L.a("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=function(Ge){Ge.setTextureFromPostProcess("otherSampler",ue._vlsEnabled?ue._currentDepthOfFieldSource:ue.originalPostProcess),Ge.setTexture("lensSampler",ue.lensTexture),Ge.setFloat("exposure",ue._currentExposure),ue._currentDepthOfFieldSource=ue.textureAdderFinalPostProcess},this.addEffect(new _.a(Z.getEngine(),"HDRTextureAdder",function(){return ue.textureAdderPostProcess},!0))},re.prototype._createVolumetricLightPostProcess=function(Z,fe){var ue=this,Ge=Z.enableGeometryBufferRenderer();Ge.enablePosition=!0;var xe=Ge.getGBuffer();this.volumetricLightPostProcess=new L.a("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],fe/8,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,`#define VLS
#define NB_STEPS `+this._volumetricLightStepsCount.toFixed(1));var ne=J.d.Zero();this.volumetricLightPostProcess.onApply=function(Ke){if(ue.sourceLight&&ue.sourceLight.getShadowGenerator()&&ue._scene.activeCamera){var nt=ue.sourceLight.getShadowGenerator();Ke.setTexture("shadowMapSampler",nt.getShadowMap()),Ke.setTexture("positionSampler",xe.textures[2]),Ke.setColor3("sunColor",ue.sourceLight.diffuse),Ke.setVector3("sunDirection",ue.sourceLight.getShadowDirection()),Ke.setVector3("cameraPosition",ue._scene.activeCamera.globalPosition),Ke.setMatrix("shadowViewProjection",nt.getTransformMatrix()),Ke.setFloat("scatteringCoefficient",ue.volumetricLightCoefficient),Ke.setFloat("scatteringPower",ue.volumetricLightPower),ne.x=ue.sourceLight.getDepthMinZ(ue._scene.activeCamera),ne.y=ue.sourceLight.getDepthMaxZ(ue._scene.activeCamera),Ke.setVector2("depthValues",ne)}},this.addEffect(new _.a(Z.getEngine(),"HDRVLS",function(){return ue.volumetricLightPostProcess},!0)),this._createBlurPostProcesses(Z,fe/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new L.a("HDRVLSMerge","standard",[],["originalSampler"],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=function(Ke){Ke.setTextureFromPostProcess("originalSampler",ue._bloomEnabled?ue.textureAdderFinalPostProcess:ue.originalPostProcess),ue._currentDepthOfFieldSource=ue.volumetricLightFinalPostProcess},this.addEffect(new _.a(Z.getEngine(),"HDRVLSMerge",function(){return ue.volumetricLightMergePostProces},!0))},re.prototype._createLuminancePostProcesses=function(Z,fe){var ue=this,Ge=Math.pow(3,re.LuminanceSteps);this.luminancePostProcess=new L.a("HDRLuminance","standard",["lumOffsets"],[],{width:Ge,height:Ge},null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,"#define LUMINANCE",fe);var xe=[];this.luminancePostProcess.onApply=function(pt){var Tt=1/ue.luminancePostProcess.width,de=1/ue.luminancePostProcess.height;xe[0]=-.5*Tt,xe[1]=.5*de,xe[2]=.5*Tt,xe[3]=.5*de,xe[4]=-.5*Tt,xe[5]=-.5*de,xe[6]=.5*Tt,xe[7]=-.5*de,pt.setArray2("lumOffsets",xe)},this.addEffect(new _.a(Z.getEngine(),"HDRLuminance",function(){return ue.luminancePostProcess},!0));for(var ne=re.LuminanceSteps-1;ne>=0;ne--){var Ge=Math.pow(3,ne),Ke=`#define LUMINANCE_DOWN_SAMPLE
`;ne===0&&(Ke+="#define FINAL_DOWN_SAMPLER");var nt=new L.a("HDRLuminanceDownSample"+ne,"standard",["dsOffsets","halfDestPixelSize"],[],{width:Ge,height:Ge},null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,Ke,fe);this.luminanceDownSamplePostProcesses.push(nt)}var ut=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(function(pt,Tt){var de=new Array(18);pt.onApply=function(Ft){if(!!ut){for(var Jt=0,Dt=-1;Dt<2;Dt++)for(var Xt=-1;Xt<2;Xt++)de[Jt]=Dt/ut.width,de[Jt+1]=Xt/ut.height,Jt+=2;Ft.setArray2("dsOffsets",de),Ft.setFloat("halfDestPixelSize",.5/ut.width),Tt===ue.luminanceDownSamplePostProcesses.length-1?ut=ue.luminancePostProcess:ut=pt}},Tt===ue.luminanceDownSamplePostProcesses.length-1&&(pt.onAfterRender=function(){var Ft=Z.getEngine().readPixels(0,0,1,1),Jt=new J.f(1/(255*255*255),1/(255*255),1/255,1);Ft.then(function(Dt){var Xt=new Uint8Array(Dt.buffer);ue._hdrCurrentLuminance=(Xt[0]*Jt.x+Xt[1]*Jt.y+Xt[2]*Jt.z+Xt[3]*Jt.w)/100})}),ue.addEffect(new _.a(Z.getEngine(),"HDRLuminanceDownSample"+Tt,function(){return pt},!0))})},re.prototype._createHdrPostProcess=function(Z,fe){var ue=this,Ge=["#define HDR"];this._hdrAutoExposure&&Ge.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new L.a("HDR","standard",["averageLuminance"],["textureAdderSampler"],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,Ge.join(`
`),0);var xe=1,ne=0,Ke=0;this.hdrPostProcess.onApply=function(nt){if(nt.setTextureFromPostProcess("textureAdderSampler",ue._currentDepthOfFieldSource),ne+=Z.getEngine().getDeltaTime(),xe<0)xe=ue._hdrCurrentLuminance;else{var ut=(Ke-ne)/1e3;ue._hdrCurrentLuminance<xe+ue.hdrDecreaseRate*ut?xe+=ue.hdrDecreaseRate*ut:ue._hdrCurrentLuminance>xe-ue.hdrIncreaseRate*ut?xe-=ue.hdrIncreaseRate*ut:xe=ue._hdrCurrentLuminance}ue.hdrAutoExposure?ue._currentExposure=ue._fixedExposure/xe:(xe=Te.a.Clamp(xe,ue.hdrMinimumLuminance,1e20),nt.setFloat("averageLuminance",xe)),Ke=ne,ue._currentDepthOfFieldSource=ue.hdrFinalPostProcess},this.addEffect(new _.a(Z.getEngine(),"HDR",function(){return ue.hdrPostProcess},!0))},re.prototype._createLensFlarePostProcess=function(Z,fe){var ue=this;this.lensFlarePostProcess=new L.a("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],fe/2,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new _.a(Z.getEngine(),"HDRLensFlare",function(){return ue.lensFlarePostProcess},!0)),this._createBlurPostProcesses(Z,fe/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new L.a("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new _.a(Z.getEngine(),"HDRLensFlareCompose",function(){return ue.lensFlareComposePostProcess},!0));var Ge=new J.d(0,0);this.lensFlarePostProcess.onApply=function(Ke){Ke.setTextureFromPostProcess("textureSampler",ue._bloomEnabled?ue.blurHPostProcesses[0]:ue.originalPostProcess),Ke.setTexture("lensColorSampler",ue.lensColorTexture),Ke.setFloat("strength",ue.lensFlareStrength),Ke.setFloat("ghostDispersal",ue.lensFlareGhostDispersal),Ke.setFloat("haloWidth",ue.lensFlareHaloWidth),Ge.x=ue.lensFlarePostProcess.width,Ge.y=ue.lensFlarePostProcess.height,Ke.setVector2("resolution",Ge),Ke.setFloat("distortionStrength",ue.lensFlareDistortionStrength)};var xe=J.a.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),ne=J.a.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(Ke){if(!!ue._scene.activeCamera){Ke.setTextureFromPostProcess("otherSampler",ue.lensFlarePostProcess),Ke.setTexture("lensDirtSampler",ue.lensFlareDirtTexture),Ke.setTexture("lensStarSampler",ue.lensStarTexture);var nt=ue._scene.activeCamera.getViewMatrix().getRow(0),ut=ue._scene.activeCamera.getViewMatrix().getRow(2),pt=J.e.Dot(nt.toVector3(),new J.e(1,0,0))+J.e.Dot(ut.toVector3(),new J.e(0,0,1));pt*=4;var Tt=J.a.FromValues(Math.cos(pt)*.5,-Math.sin(pt),0,0,Math.sin(pt),Math.cos(pt)*.5,0,0,0,0,1,0,0,0,0,1),de=ne.multiply(Tt).multiply(xe);Ke.setMatrix("lensStarMatrix",de),ue._currentDepthOfFieldSource=ue.lensFlareFinalPostProcess}}},re.prototype._createDepthOfFieldPostProcess=function(Z,fe){var ue=this;this.depthOfFieldPostProcess=new L.a("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=function(Ge){Ge.setTextureFromPostProcess("otherSampler",ue._currentDepthOfFieldSource),Ge.setTexture("depthSampler",ue._getDepthTexture()),Ge.setFloat("distance",ue.depthOfFieldDistance)},this.addEffect(new _.a(Z.getEngine(),"HDRDepthOfField",function(){return ue.depthOfFieldPostProcess},!0))},re.prototype._createMotionBlurPostProcess=function(Z,fe){var ue=this;if(this._isObjectBasedMotionBlur){var Ge=new se.a("HDRMotionBlur",Z,fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,0);Ge.motionStrength=this.motionStrength,Ge.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=Ge}else{this.motionBlurPostProcess=new L.a("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],fe,null,x.a.BILINEAR_SAMPLINGMODE,Z.getEngine(),!1,`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+this.motionBlurSamples.toFixed(1),0);var xe=0,ne=J.a.Identity(),Ke=J.a.Identity(),nt=J.a.Identity(),ut=J.d.Zero();this.motionBlurPostProcess.onApply=function(pt){nt=Z.getProjectionMatrix().multiply(Z.getViewMatrix()),nt.invertToRef(Ke),pt.setMatrix("inverseViewProjection",Ke),pt.setMatrix("prevViewProjection",ne),ne=nt,ut.x=ue.motionBlurPostProcess.width,ut.y=ue.motionBlurPostProcess.height,pt.setVector2("screenSize",ut),xe=Z.getEngine().getFps()/60,pt.setFloat("motionScale",xe),pt.setFloat("motionStrength",ue.motionStrength),pt.setTexture("depthSampler",ue._getDepthTexture())}}this.addEffect(new _.a(Z.getEngine(),"HDRMotionBlur",function(){return ue.motionBlurPostProcess},!0))},re.prototype._getDepthTexture=function(){if(this._scene.getEngine().getCaps().drawBuffersExtension){var Z=this._scene.enableGeometryBufferRenderer();return Z.getGBuffer().textures[0]}return this._scene.enableDepthRenderer().getDepthMap()},re.prototype._disposePostProcesses=function(){for(var Z=0;Z<this._cameras.length;Z++){var fe=this._cameras[Z];this.originalPostProcess&&this.originalPostProcess.dispose(fe),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(fe),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(fe),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(fe),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(fe),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(fe),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(fe),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(fe),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(fe),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(fe),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(fe),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(fe);for(var ue=0;ue<this.luminanceDownSamplePostProcesses.length;ue++)this.luminanceDownSamplePostProcesses[ue].dispose(fe);this.luminancePostProcess&&this.luminancePostProcess.dispose(fe),this.hdrPostProcess&&this.hdrPostProcess.dispose(fe),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(fe),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(fe),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(fe),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(fe);for(var ue=0;ue<this.blurHPostProcesses.length;ue++)this.blurHPostProcesses[ue].dispose(fe);for(var ue=0;ue<this.blurVPostProcesses.length;ue++)this.blurVPostProcesses[ue].dispose(fe)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses=[],this.blurHPostProcesses=[],this.blurVPostProcesses=[]},re.prototype.dispose=function(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),Ue.prototype.dispose.call(this)},re.prototype.serialize=function(){var Z=R.a.Serialize(this);return this.sourceLight&&(Z.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(Z.screenSpaceReflectionPostProcess=R.a.Serialize(this.screenSpaceReflectionPostProcess)),Z.customType="StandardRenderingPipeline",Z},re.Parse=function(Z,fe,ue){var Ge=R.a.Parse(function(){return new re(Z._name,fe,Z._ratio)},Z,fe,ue);return Z.sourceLightId&&(Ge.sourceLight=fe.getLightByID(Z.sourceLightId)),Z.screenSpaceReflectionPostProcess&&R.a.Parse(function(){return Ge.screenSpaceReflectionPostProcess},Z.screenSpaceReflectionPostProcess,fe,ue),Ge},re.LuminanceSteps=6,Object(S.c)([Object(R.c)()],re.prototype,"brightThreshold",void 0),Object(S.c)([Object(R.c)()],re.prototype,"blurWidth",void 0),Object(S.c)([Object(R.c)()],re.prototype,"horizontalBlur",void 0),Object(S.c)([Object(R.c)()],re.prototype,"exposure",null),Object(S.c)([Object(R.m)("lensTexture")],re.prototype,"lensTexture",void 0),Object(S.c)([Object(R.c)()],re.prototype,"volumetricLightCoefficient",void 0),Object(S.c)([Object(R.c)()],re.prototype,"volumetricLightPower",void 0),Object(S.c)([Object(R.c)()],re.prototype,"volumetricLightBlurScale",void 0),Object(S.c)([Object(R.c)()],re.prototype,"hdrMinimumLuminance",void 0),Object(S.c)([Object(R.c)()],re.prototype,"hdrDecreaseRate",void 0),Object(S.c)([Object(R.c)()],re.prototype,"hdrIncreaseRate",void 0),Object(S.c)([Object(R.c)()],re.prototype,"hdrAutoExposure",null),Object(S.c)([Object(R.m)("lensColorTexture")],re.prototype,"lensColorTexture",void 0),Object(S.c)([Object(R.c)()],re.prototype,"lensFlareStrength",void 0),Object(S.c)([Object(R.c)()],re.prototype,"lensFlareGhostDispersal",void 0),Object(S.c)([Object(R.c)()],re.prototype,"lensFlareHaloWidth",void 0),Object(S.c)([Object(R.c)()],re.prototype,"lensFlareDistortionStrength",void 0),Object(S.c)([Object(R.c)()],re.prototype,"lensFlareBlurWidth",void 0),Object(S.c)([Object(R.m)("lensStarTexture")],re.prototype,"lensStarTexture",void 0),Object(S.c)([Object(R.m)("lensFlareDirtTexture")],re.prototype,"lensFlareDirtTexture",void 0),Object(S.c)([Object(R.c)()],re.prototype,"depthOfFieldDistance",void 0),Object(S.c)([Object(R.c)()],re.prototype,"depthOfFieldBlurWidth",void 0),Object(S.c)([Object(R.c)()],re.prototype,"motionStrength",null),Object(S.c)([Object(R.c)()],re.prototype,"objectBasedMotionBlur",null),Object(S.c)([Object(R.c)()],re.prototype,"_ratio",void 0),Object(S.c)([Object(R.c)()],re.prototype,"BloomEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"DepthOfFieldEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"LensFlareEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"HDREnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"VLSEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"MotionBlurEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"fxaaEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"screenSpaceReflectionsEnabled",null),Object(S.c)([Object(R.c)()],re.prototype,"volumetricLightStepsCount",null),Object(S.c)([Object(R.c)()],re.prototype,"motionBlurSamples",null),Object(S.c)([Object(R.c)()],re.prototype,"samples",null),re}(p.a);y.a.RegisteredTypes["BABYLON.StandardRenderingPipeline"]=Ye;var He=u(548)},604:function(we,P,u){"use strict";u.d(P,"c",function(){return G}),u.d(P,"b",function(){return T}),u.d(P,"a",function(){return h});var S=u(434),R=u(468),U=u(446),O=u(440),x=u(448),G=function(f){Object(S.d)(d,f);function d(){return f!==null&&f.apply(this,arguments)||this}return d}(R.a),T=function(){function f(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}return f}(),h=function(f){Object(S.d)(d,f);function d(g){var p=f.call(this)||this;return p._wasAddedToScene=!1,p.scene=g,p.sounds=[],p.effectLayers=[],p.layers=[],p.lensFlareSystems=[],p.proceduralTextures=[],p.reflectionProbes=[],g.onDisposeObservable.add(function(){p._wasAddedToScene||p.dispose()}),p}return d.prototype.instantiateModelsToScene=function(g,p,_){var m=this;p===void 0&&(p=!1);var l={},y={},E=new T,A=[],F=[];_||(_={doNotInstantiate:!1});var B=function(L,I){if(l[L.uniqueId]=I.uniqueId,y[I.uniqueId]=I,g&&(I.name=g(L.name)),I instanceof U.a){var z=I;if(z.morphTargetManager){var k=L.morphTargetManager;z.morphTargetManager=k.clone();for(var j=0;j<k.numTargets;j++){var w=k.getTarget(j),Q=z.morphTargetManager.getTarget(j);l[w.uniqueId]=Q.uniqueId,y[Q.uniqueId]=Q}}}};return this.transformNodes.forEach(function(L){if(!L.parent){var I=L.instantiateHierarchy(null,_,function(z,k){B(z,k)});I&&E.rootNodes.push(I)}}),this.meshes.forEach(function(L){if(!L.parent){var I=L.instantiateHierarchy(null,_,function(z,k){if(B(z,k),k.material){var j=k;if(j.material)if(p){var w=z.material;if(F.indexOf(w)===-1){var Q=w.clone(g?g(w.name):"Clone of "+w.name);if(F.push(w),l[w.uniqueId]=Q.uniqueId,y[Q.uniqueId]=Q,w.getClassName()==="MultiMaterial"){for(var W=w,Y=0,he=W.subMaterials;Y<he.length;Y++){var le=he[Y];!le||(Q=le.clone(g?g(le.name):"Clone of "+le.name),F.push(le),l[le.uniqueId]=Q.uniqueId,y[Q.uniqueId]=Q)}W.subMaterials=W.subMaterials.map(function(J){return J&&y[l[J.uniqueId]]})}}j.getClassName()!=="InstancedMesh"&&(j.material=y[l[w.uniqueId]])}else j.material.getClassName()==="MultiMaterial"?m.scene.multiMaterials.indexOf(j.material)===-1&&m.scene.addMultiMaterial(j.material):m.scene.materials.indexOf(j.material)===-1&&m.scene.addMaterial(j.material)}});I&&E.rootNodes.push(I)}}),this.skeletons.forEach(function(L){var I=L.clone(g?g(L.name):"Clone of "+L.name);L.overrideMesh&&(I.overrideMesh=y[l[L.overrideMesh.uniqueId]]);for(var z=0,k=m.meshes;z<k.length;z++){var j=k[z];if(j.skeleton===L&&!j.isAnInstance){var w=y[l[j.uniqueId]];if(w.skeleton=I,A.indexOf(I)!==-1)continue;A.push(I);for(var Q=0,W=I.bones;Q<W.length;Q++){var Y=W[Q];Y._linkedTransformNode&&(Y._linkedTransformNode=y[l[Y._linkedTransformNode.uniqueId]])}}}E.skeletons.push(I)}),this.animationGroups.forEach(function(L){var I=L.clone(L.name,function(z){var k=y[l[z.uniqueId]];return k||z});E.animationGroups.push(I)}),E},d.prototype.addAllToScene=function(){var g=this;this._wasAddedToScene=!0,this.cameras.forEach(function(l){g.scene.addCamera(l)}),this.lights.forEach(function(l){g.scene.addLight(l)}),this.meshes.forEach(function(l){g.scene.addMesh(l)}),this.skeletons.forEach(function(l){g.scene.addSkeleton(l)}),this.animations.forEach(function(l){g.scene.addAnimation(l)}),this.animationGroups.forEach(function(l){g.scene.addAnimationGroup(l)}),this.multiMaterials.forEach(function(l){g.scene.addMultiMaterial(l)}),this.materials.forEach(function(l){g.scene.addMaterial(l)}),this.morphTargetManagers.forEach(function(l){g.scene.addMorphTargetManager(l)}),this.geometries.forEach(function(l){g.scene.addGeometry(l)}),this.transformNodes.forEach(function(l){g.scene.addTransformNode(l)}),this.actionManagers.forEach(function(l){g.scene.addActionManager(l)}),this.textures.forEach(function(l){g.scene.addTexture(l)}),this.reflectionProbes.forEach(function(l){g.scene.addReflectionProbe(l)}),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(var p=0,_=this.scene._serializableComponents;p<_.length;p++){var m=_[p];m.addFromContainer(this)}},d.prototype.removeAllFromScene=function(){var g=this;this._wasAddedToScene=!1,this.cameras.forEach(function(l){g.scene.removeCamera(l)}),this.lights.forEach(function(l){g.scene.removeLight(l)}),this.meshes.forEach(function(l){g.scene.removeMesh(l)}),this.skeletons.forEach(function(l){g.scene.removeSkeleton(l)}),this.animations.forEach(function(l){g.scene.removeAnimation(l)}),this.animationGroups.forEach(function(l){g.scene.removeAnimationGroup(l)}),this.multiMaterials.forEach(function(l){g.scene.removeMultiMaterial(l)}),this.materials.forEach(function(l){g.scene.removeMaterial(l)}),this.morphTargetManagers.forEach(function(l){g.scene.removeMorphTargetManager(l)}),this.geometries.forEach(function(l){g.scene.removeGeometry(l)}),this.transformNodes.forEach(function(l){g.scene.removeTransformNode(l)}),this.actionManagers.forEach(function(l){g.scene.removeActionManager(l)}),this.textures.forEach(function(l){g.scene.removeTexture(l)}),this.reflectionProbes.forEach(function(l){g.scene.removeReflectionProbe(l)}),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(var p=0,_=this.scene._serializableComponents;p<_.length;p++){var m=_[p];m.removeFromContainer(this)}},d.prototype.dispose=function(){this.cameras.forEach(function(m){m.dispose()}),this.cameras=[],this.lights.forEach(function(m){m.dispose()}),this.lights=[],this.meshes.forEach(function(m){m.dispose()}),this.meshes=[],this.skeletons.forEach(function(m){m.dispose()}),this.skeletons=[],this.animationGroups.forEach(function(m){m.dispose()}),this.animationGroups=[],this.multiMaterials.forEach(function(m){m.dispose()}),this.multiMaterials=[],this.materials.forEach(function(m){m.dispose()}),this.materials=[],this.geometries.forEach(function(m){m.dispose()}),this.geometries=[],this.transformNodes.forEach(function(m){m.dispose()}),this.transformNodes=[],this.actionManagers.forEach(function(m){m.dispose()}),this.actionManagers=[],this.textures.forEach(function(m){m.dispose()}),this.textures=[],this.reflectionProbes.forEach(function(m){m.dispose()}),this.reflectionProbes=[],this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(var g=0,p=this.scene._serializableComponents;g<p.length;g++){var _=p[g];_.removeFromContainer(this,!0)}},d.prototype._moveAssets=function(g,p,_){if(!!g)for(var m=0,l=g;m<l.length;m++){var y=l[m],E=!0;if(_)for(var A=0,F=_;A<F.length;A++){var B=F[A];if(y===B){E=!1;break}}E&&p.push(y)}},d.prototype.moveAllFromScene=function(g){this._wasAddedToScene=!1,g===void 0&&(g=new G);for(var p in this)this.hasOwnProperty(p)&&(this[p]=this[p]||(p==="environmentTexture"?null:[]),this._moveAssets(this.scene[p],this[p],g[p]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()},d.prototype.createRootMesh=function(){var g=new U.a("assetContainerRootMesh",this.scene);return this.meshes.forEach(function(p){p.parent||g.addChild(p)}),this.meshes.unshift(g),g},d.prototype.mergeAnimationsTo=function(g,p,_){if(g===void 0&&(g=x.a.LastCreatedScene),_===void 0&&(_=null),!g)return O.a.Error("No scene available to merge animations to"),[];var m=_||function(E){var A=null,F=E.animations.length?E.animations[0].targetProperty:"",B=E.name.split(".").join("").split("_primitive")[0];switch(F){case"position":case"rotationQuaternion":A=g.getTransformNodeByName(E.name)||g.getTransformNodeByName(B);break;case"influence":A=g.getMorphTargetByName(E.name)||g.getMorphTargetByName(B);break;default:A=g.getNodeByName(E.name)||g.getNodeByName(B)}return A},l=this.getNodes();l.forEach(function(E){var A=m(E);if(A!==null){for(var F=function(z){for(var k=A.animations.filter(function(Y){return Y.targetProperty===z.targetProperty}),j=0,w=k;j<w.length;j++){var Q=w[j],W=A.animations.indexOf(Q,0);W>-1&&A.animations.splice(W,1)}},B=0,L=E.animations;B<L.length;B++){var I=L[B];F(I)}A.animations=A.animations.concat(E.animations)}});var y=new Array;return this.animationGroups.slice().forEach(function(E){y.push(E.clone(E.name,m)),E.animatables.forEach(function(A){A.stop()})}),p.forEach(function(E){var A=m(E.target);A&&(g.beginAnimation(A,E.fromFrame,E.toFrame,E.loopAnimation,E.speedRatio,E.onAnimationEnd?E.onAnimationEnd:void 0,void 0,!0,void 0,E.onAnimationLoop?E.onAnimationLoop:void 0),g.stopAnimation(E.target))}),y},d}(R.a)},605:function(we,P,u){"use strict";var S=u(435),R="importanceSampling",U=`




























vec3 hemisphereCosSample(vec2 u) {

float phi=2.*PI*u.x;
float cosTheta2=1.-u.y;
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}





































vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {

float phi=2.*PI*u.x;

float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}

























































vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) {

float phi=2.*PI*u.x;
float sinTheta=pow(u.y,a/(2.*a+1.));
float cosTheta=sqrt(1.-sinTheta*sinTheta);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}`;S.a.IncludesShadersStore[R]=U;var O={name:R,shader:U}},606:function(we,P,u){"use strict";var S=u(435),R="pbrBRDFFunctions",U=`
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25




#ifdef MS_BRDF_ENERGY_CONSERVATION


vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);
}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {

vec2 UV=vec2(NdotV,perceptualRoughness);

vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;

#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;
}
#endif

#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{

float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)

vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {
vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;
return sheenEnvironmentReflectance;
}
#endif
























vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
#ifdef CLEARCOAT





vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);
vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);
return t*t;
#endif
}
#endif






float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{



float a2=square(alphaG);
float d=NdotH*NdotH*(a2-1.0)+1.0;
return a2/(PI*d*d);
}
#ifdef SHEEN


float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{
float invR=1./alphaG;
float cos2h=NdotH*NdotH;
float sin2h=1.-cos2h;
return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);
}
#endif
#ifdef ANISOTROPIC


float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {
float a2=alphaTB.x*alphaTB.y;
vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x*BdotH,a2*NdotH);
float v2=dot(v,v);
float w2=a2/v2;
return a2*w2*w2*RECIPROCAL_PI;
}
#endif




#ifdef BRDF_V_HEIGHT_CORRELATED



float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE

float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);
float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);
return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;
float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);
float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);
return 0.5/(GGXV+GGXL);
#endif
}
#else















float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE

return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;
return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{
float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);

return visibility;
}
#endif
#ifdef ANISOTROPIC


float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {
float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));
float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));
float v=0.5/(lambdaV+lambdaL);
return v;
}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {



return 0.25/(VdotH*VdotH);
}
#endif
#ifdef SHEEN



float visibility_Ashikhmin(float NdotL,float NdotV)
{
return 1./(4.*(NdotL+NdotV-NdotL*NdotV));
}

#endif







float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {


float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));
float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));
float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;
float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);
return fresnel/PI;
}
#ifdef SS_TRANSLUCENCY


vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {
vec3 S=1./maxEps(diffusionDistance);
vec3 temp=exp((-0.333333333*thickness)*S);
return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);
}


float computeWrappedDiffuseNdotL(float NdotL,float w) {
float t=1.0+w;
float invt2=1.0/square(t);
return saturate((NdotL+w)*invt2);
}
#endif
`;S.a.IncludesShadersStore[R]=U;var O={name:R,shader:U}},607:function(we,P,u){"use strict";var S=u(435),R="hdrFilteringFunctions",U=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU)


float radicalInverse_VdC(uint bits)
{
bits=(bits << 16u) | (bits >> 16u);
bits=((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);
bits=((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);
bits=((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);
bits=((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);
return float(bits)*2.3283064365386963e-10;
}
vec2 hammersley(uint i,uint N)
{
return vec2(float(i)/float(N),radicalInverse_VdC(i));
}
#else
float vanDerCorpus(int n,int base)
{
float invBase=1.0/float(base);
float denom=1.0;
float result=0.0;
for(int i=0; i<32; ++i)
{
if(n>0)
{
denom=mod(float(n),2.0);
result+=denom*invBase;
invBase=invBase/2.0;
n=int(float(n)/2.0);
}
}
return result;
}
vec2 hammersley(int i,int N)
{
return vec2(float(i)/float(N),vanDerCorpus(i,2));
}
#endif
float log4(float x) {
return log2(x)/2.;
}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);
const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;
const float K=4.;



















































































































#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
vec3 result=vec3(0.0);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 Ls=hemisphereCosSample(Xi);
Ls=normalize(Ls);
vec3 Ns=vec3(0.,0.,1.);
float NoL=dot(Ns,Ls);
if (NoL>0.) {
float pdf_inversed=PI/NoL;
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(l,0.0,maxLevel);
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;
}
}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
return result;
}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
if (alphaG == 0.) {
vec3 c=textureCube(inputTexture,n).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;
} else {
vec3 result=vec3(0.);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);
float NoV=1.;
float NoH=H.z;
float NoH2=H.z*H.z;
float NoL=2.*NoH2-1.;
vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);
L=normalize(L);
if (NoL>0.) {
float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(float(l),0.0,maxLevel);
weight+=NoL;
vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;
}
}
result=result/weight;
return result;
}
}
#endif
#endif`;S.a.IncludesShadersStore[R]=U;var O={name:R,shader:U}},608:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(438),U=u(448),O=u(447),x=u(439),G=u(437),T=function(){function h(f,d,g){d===void 0&&(d=0),g===void 0&&(g=null),this.name=f,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new R.c,this._onDataLayoutChanged=new R.c,this._animationPropertiesOverride=null,this._scene=g||U.a.LastCreatedScene,this.influence=d,this._scene&&(this._uniqueId=this._scene.getUniqueId())}return Object.defineProperty(h.prototype,"influence",{get:function(){return this._influence},set:function(f){if(this._influence!==f){var d=this._influence;this._influence=f,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(d===0||f===0)}},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"animationPropertiesOverride",{get:function(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride},set:function(f){this._animationPropertiesOverride=f},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"hasPositions",{get:function(){return!!this._positions},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"hasNormals",{get:function(){return!!this._normals},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"hasTangents",{get:function(){return!!this._tangents},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"hasUVs",{get:function(){return!!this._uvs},enumerable:!1,configurable:!0}),h.prototype.setPositions=function(f){var d=this.hasPositions;this._positions=f,d!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)},h.prototype.getPositions=function(){return this._positions},h.prototype.setNormals=function(f){var d=this.hasNormals;this._normals=f,d!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)},h.prototype.getNormals=function(){return this._normals},h.prototype.setTangents=function(f){var d=this.hasTangents;this._tangents=f,d!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)},h.prototype.getTangents=function(){return this._tangents},h.prototype.setUVs=function(f){var d=this.hasUVs;this._uvs=f,d!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)},h.prototype.getUVs=function(){return this._uvs},h.prototype.clone=function(){var f=this,d=x.a.Clone(function(){return new h(f.name,f.influence,f._scene)},this);return d._positions=this._positions,d._normals=this._normals,d._tangents=this._tangents,d._uvs=this._uvs,d},h.prototype.serialize=function(){var f={};return f.name=this.name,f.influence=this.influence,f.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(f.id=this.id),this.hasNormals&&(f.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(f.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(f.uvs=Array.prototype.slice.call(this.getUVs())),x.a.AppendSerializedAnimations(this,f),f},h.prototype.getClassName=function(){return"MorphTarget"},h.Parse=function(f){var d=new h(f.name,f.influence);if(d.setPositions(f.positions),f.id!=null&&(d.id=f.id),f.normals&&d.setNormals(f.normals),f.tangents&&d.setTangents(f.tangents),f.uvs&&d.setUVs(f.uvs),f.animations)for(var g=0;g<f.animations.length;g++){var p=f.animations[g],_=G.a.GetClass("BABYLON.Animation");_&&d.animations.push(_.Parse(p))}return d},h.FromMesh=function(f,d,g){d||(d=f.name);var p=new h(d,g,f.getScene());return p.setPositions(f.getVerticesData(O.b.PositionKind)),f.isVerticesDataPresent(O.b.NormalKind)&&p.setNormals(f.getVerticesData(O.b.NormalKind)),f.isVerticesDataPresent(O.b.TangentKind)&&p.setTangents(f.getVerticesData(O.b.TangentKind)),f.isVerticesDataPresent(O.b.UVKind)&&p.setUVs(f.getVerticesData(O.b.UVKind)),p},Object(S.c)([Object(x.c)()],h.prototype,"id",void 0),h}()},609:function(we,P,u){"use strict";u.d(P,"a",function(){return R});var S=u(436),R=function(){function U(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=S.e.Zero(),this._hitPointWorld=S.e.Zero(),this._rayFromWorld=S.e.Zero(),this._rayToWorld=S.e.Zero()}return Object.defineProperty(U.prototype,"hasHit",{get:function(){return this._hasHit},enumerable:!1,configurable:!0}),Object.defineProperty(U.prototype,"hitDistance",{get:function(){return this._hitDistance},enumerable:!1,configurable:!0}),Object.defineProperty(U.prototype,"hitNormalWorld",{get:function(){return this._hitNormalWorld},enumerable:!1,configurable:!0}),Object.defineProperty(U.prototype,"hitPointWorld",{get:function(){return this._hitPointWorld},enumerable:!1,configurable:!0}),Object.defineProperty(U.prototype,"rayFromWorld",{get:function(){return this._rayFromWorld},enumerable:!1,configurable:!0}),Object.defineProperty(U.prototype,"rayToWorld",{get:function(){return this._rayToWorld},enumerable:!1,configurable:!0}),U.prototype.setHitData=function(O,x){this._hasHit=!0,this._hitNormalWorld=new S.e(O.x,O.y,O.z),this._hitPointWorld=new S.e(x.x,x.y,x.z)},U.prototype.setHitDistance=function(O){this._hitDistance=O},U.prototype.calculateHitDistance=function(){this._hitDistance=S.e.Distance(this._rayFromWorld,this._hitPointWorld)},U.prototype.reset=function(O,x){O===void 0&&(O=S.e.Zero()),x===void 0&&(x=S.e.Zero()),this._rayFromWorld=O,this._rayToWorld=x,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=S.e.Zero(),this._hitPointWorld=S.e.Zero()},U}()},610:function(we,P,u){"use strict";u.d(P,"a",function(){return R}),u.d(P,"b",function(){return U});var S=u(475),R=function(){function O(x,G,T,h,f){this.idx=0,this.color=new S.f(1,1,1,1),this.position=S.z.Zero(),this.rotation=S.z.Zero(),this.uv=new S.y(0,0),this.velocity=S.z.Zero(),this.pivot=S.z.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=S.z.Zero(),this.idx=x,this._group=G,this.groupId=T,this.idxInGroup=h,this._pcs=f}return Object.defineProperty(O.prototype,"size",{get:function(){return this.size},set:function(x){this.size=x},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(x){this.rotationQuaternion=x},enumerable:!1,configurable:!0}),O.prototype.intersectsMesh=function(x,G){if(!x._boundingInfo)return!1;if(G=G||!1,G)return x.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));var T=0,h=0,f=0,d=0,g=0,p=0;T=x.getBoundingInfo().boundingBox.maximumWorld.x,h=x.getBoundingInfo().boundingBox.minimumWorld.x,f=x.getBoundingInfo().boundingBox.maximumWorld.y,d=x.getBoundingInfo().boundingBox.minimumWorld.y,g=x.getBoundingInfo().boundingBox.maximumWorld.z,p=x.getBoundingInfo().boundingBox.minimumWorld.z;var _=this.position.x+this._pcs.mesh.position.x,m=this.position.y+this._pcs.mesh.position.y,l=this.position.z+this._pcs.mesh.position.z;return h<=_&&_<=T&&d<=m&&m<=f&&p<=l&&l<=g},O.prototype.getRotationMatrix=function(x){var G;if(this.rotationQuaternion)G=this.rotationQuaternion;else{G=S.v.Quaternion[0];var T=this.rotation;S.r.RotationYawPitchRollToRef(T.y,T.x,T.z,G)}G.toRotationMatrix(x)},O}(),U=function(){function O(x,G){this.groupID=x,this._positionFunction=G}return O}()},618:function(we,P,u){"use strict";u.d(P,"a",function(){return p});var S=u(434),R=u(436),U=u(441),O=u(619),x=u(511),G=u(620),T=u(448),h=u(440),f=u(474),d=u(437),g=u(669),p=function(_){Object(S.d)(m,_);function m(l){var y=_.call(this)||this;return y._scene=l||T.a.LastCreatedScene,l.actionManagers.push(y),y}return m.prototype.dispose=function(){for(var l=this._scene.actionManagers.indexOf(this),y=0;y<this.actions.length;y++){var E=this.actions[y];m.Triggers[E.trigger]--,m.Triggers[E.trigger]===0&&delete m.Triggers[E.trigger]}l>-1&&this._scene.actionManagers.splice(l,1)},m.prototype.getScene=function(){return this._scene},m.prototype.hasSpecificTriggers=function(l){for(var y=0;y<this.actions.length;y++){var E=this.actions[y];if(l.indexOf(E.trigger)>-1)return!0}return!1},m.prototype.hasSpecificTriggers2=function(l,y){for(var E=0;E<this.actions.length;E++){var A=this.actions[E];if(l==A.trigger||y==A.trigger)return!0}return!1},m.prototype.hasSpecificTrigger=function(l,y){for(var E=0;E<this.actions.length;E++){var A=this.actions[E];if(A.trigger===l)if(y){if(y(A.getTriggerParameter()))return!0}else return!0}return!1},Object.defineProperty(m.prototype,"hasPointerTriggers",{get:function(){for(var l=0;l<this.actions.length;l++){var y=this.actions[l];if(y.trigger>=m.OnPickTrigger&&y.trigger<=m.OnPointerOutTrigger)return!0}return!1},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"hasPickTriggers",{get:function(){for(var l=0;l<this.actions.length;l++){var y=this.actions[l];if(y.trigger>=m.OnPickTrigger&&y.trigger<=m.OnPickUpTrigger)return!0}return!1},enumerable:!1,configurable:!0}),m.prototype.registerAction=function(l){return l.trigger===m.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(h.a.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(l),m.Triggers[l.trigger]?m.Triggers[l.trigger]++:m.Triggers[l.trigger]=1,l._actionManager=this,l._prepare(),l)},m.prototype.unregisterAction=function(l){var y=this.actions.indexOf(l);return y!==-1?(this.actions.splice(y,1),m.Triggers[l.trigger]-=1,m.Triggers[l.trigger]===0&&delete m.Triggers[l.trigger],l._actionManager=null,!0):!1},m.prototype.processTrigger=function(l,y){for(var E=0;E<this.actions.length;E++){var A=this.actions[E];if(A.trigger===l){if(y&&(l===m.OnKeyUpTrigger||l===m.OnKeyDownTrigger)){var F=A.getTriggerParameter();if(F&&F!==y.sourceEvent.keyCode){if(!F.toLowerCase)continue;var B=F.toLowerCase();if(B!==y.sourceEvent.key){var L=y.sourceEvent.charCode?y.sourceEvent.charCode:y.sourceEvent.keyCode,I=String.fromCharCode(L).toLowerCase();if(I!==B)continue}}}A._executeCurrent(y)}}},m.prototype._getEffectiveTarget=function(l,y){for(var E=y.split("."),A=0;A<E.length-1;A++)l=l[E[A]];return l},m.prototype._getProperty=function(l){var y=l.split(".");return y[y.length-1]},m.prototype.serialize=function(l){for(var y={children:new Array,name:l,type:3,properties:new Array},E=0;E<this.actions.length;E++){var A={type:0,children:new Array,name:m.GetTriggerName(this.actions[E].trigger),properties:new Array},F=this.actions[E].triggerOptions;if(F&&typeof F!="number")if(F.parameter instanceof Node)A.properties.push(x.a._GetTargetProperty(F.parameter));else{var B={};f.a.DeepCopy(F.parameter,B,["mesh"]),F.parameter&&F.parameter.mesh&&(B._meshId=F.parameter.mesh.id),A.properties.push({name:"parameter",targetType:null,value:B})}this.actions[E].serialize(A),y.children.push(A)}return y},m.Parse=function(l,y,E){var A=new m(E);y===null?E.actionManager=A:y.actionManager=A;for(var F=function(W,Y){var he=d.a.GetClass("BABYLON."+W);if(he){var le=Object.create(he.prototype);return le.constructor.apply(le,Y),le}},B=function(W,Y,he,le){if(le===null){var J=parseFloat(Y);return Y==="true"||Y==="false"?Y==="true":isNaN(J)?Y:J}for(var Re=le.split("."),Me=Y.split(","),me=0;me<Re.length;me++)he=he[Re[me]];if(typeof he=="boolean")return Me[0]==="true";if(typeof he=="string")return Me[0];for(var H=new Array,me=0;me<Me.length;me++)H.push(parseFloat(Me[me]));return he instanceof R.e?R.e.FromArray(H):he instanceof R.f?R.f.FromArray(H):he instanceof U.a?U.a.FromArray(H):he instanceof U.b?U.b.FromArray(H):parseFloat(Me[0])},L=function(W,Y,he,le,J){if(J===void 0&&(J=null),!W.detached){var Re=new Array,Me=null,me=null,H=W.combine&&W.combine.length>0;if(W.type===2?Re.push(A):Re.push(Y),H){for(var q=new Array,_e=0;_e<W.combine.length;_e++)L(W.combine[_e],m.NothingTrigger,he,le,q);Re.push(q)}else for(var Ee=0;Ee<W.properties.length;Ee++){var Te=W.properties[Ee].value,se=W.properties[Ee].name,ve=W.properties[Ee].targetType;se==="target"?ve!==null&&ve==="SceneProperties"?Te=Me=E:Te=Me=E.getNodeByName(Te):se==="parent"?Te=E.getNodeByName(Te):se==="sound"?E.getSoundByName&&(Te=E.getSoundByName(Te)):se!=="propertyPath"?W.type===2&&se==="operator"?Te=O.d[Te]:Te=B(se,Te,Me,se==="value"?me:null):me=Te,Re.push(Te)}if(J===null?Re.push(he):Re.push(null),W.name==="InterpolateValueAction"){var ye=Re[Re.length-2];Re[Re.length-1]=ye,Re[Re.length-2]=he}var Le=F(W.name,Re);if(Le instanceof O.a&&he!==null){var be=new G.b(Y,he);le?le.then(be):A.registerAction(be),le=be}J===null?Le instanceof O.a?(he=Le,Le=le):(he=null,le?le.then(Le):A.registerAction(Le)):J.push(Le);for(var Ee=0;Ee<W.children.length;Ee++)L(W.children[Ee],Y,he,Le,null)}},I=0;I<l.children.length;I++){var z,k=l.children[I];if(k.properties.length>0){var j=k.properties[0].value,w=k.properties[0].targetType===null?j:E.getMeshByName(j);w._meshId&&(w.mesh=E.getMeshByID(w._meshId)),z={trigger:m[k.name],parameter:w}}else z=m[k.name];for(var Q=0;Q<k.children.length;Q++)k.detached||L(k.children[Q],z,null,null)}},m.GetTriggerName=function(l){switch(l){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnPickUpTrigger";case 7:return"OnLongPressTrigger";case 8:return"OnPointerOverTrigger";case 9:return"OnPointerOutTrigger";case 10:return"OnEveryFrameTrigger";case 11:return"OnIntersectionEnterTrigger";case 12:return"OnIntersectionExitTrigger";case 13:return"OnKeyDownTrigger";case 14:return"OnKeyUpTrigger";case 15:return"OnPickOutTrigger";default:return""}},m.NothingTrigger=0,m.OnPickTrigger=1,m.OnLeftPickTrigger=2,m.OnRightPickTrigger=3,m.OnCenterPickTrigger=4,m.OnPickDownTrigger=5,m.OnDoublePickTrigger=6,m.OnPickUpTrigger=7,m.OnPickOutTrigger=16,m.OnLongPressTrigger=8,m.OnPointerOverTrigger=9,m.OnPointerOutTrigger=10,m.OnEveryFrameTrigger=11,m.OnIntersectionEnterTrigger=12,m.OnIntersectionExitTrigger=13,m.OnKeyDownTrigger=14,m.OnKeyUpTrigger=15,m}(g.a)},619:function(we,P,u){"use strict";u.d(P,"a",function(){return O}),u.d(P,"d",function(){return x}),u.d(P,"b",function(){return G}),u.d(P,"c",function(){return T});var S=u(434),R=u(511),U=u(437),O=function(){function h(f){this._actionManager=f}return h.prototype.isValid=function(){return!0},h.prototype._getProperty=function(f){return this._actionManager._getProperty(f)},h.prototype._getEffectiveTarget=function(f,d){return this._actionManager._getEffectiveTarget(f,d)},h.prototype.serialize=function(){},h.prototype._serialize=function(f){return{type:2,children:[],name:f.name,properties:f.properties}},h}(),x=function(h){Object(S.d)(f,h);function f(d,g,p,_,m){m===void 0&&(m=f.IsEqual);var l=h.call(this,d)||this;return l.propertyPath=p,l.value=_,l.operator=m,l._target=g,l._effectiveTarget=l._getEffectiveTarget(g,l.propertyPath),l._property=l._getProperty(l.propertyPath),l}return Object.defineProperty(f,"IsEqual",{get:function(){return f._IsEqual},enumerable:!1,configurable:!0}),Object.defineProperty(f,"IsDifferent",{get:function(){return f._IsDifferent},enumerable:!1,configurable:!0}),Object.defineProperty(f,"IsGreater",{get:function(){return f._IsGreater},enumerable:!1,configurable:!0}),Object.defineProperty(f,"IsLesser",{get:function(){return f._IsLesser},enumerable:!1,configurable:!0}),f.prototype.isValid=function(){switch(this.operator){case f.IsGreater:return this._effectiveTarget[this._property]>this.value;case f.IsLesser:return this._effectiveTarget[this._property]<this.value;case f.IsEqual:case f.IsDifferent:var d;return this.value.equals?d=this.value.equals(this._effectiveTarget[this._property]):d=this.value===this._effectiveTarget[this._property],this.operator===f.IsEqual?d:!d}return!1},f.prototype.serialize=function(){return this._serialize({name:"ValueCondition",properties:[R.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:R.a._SerializeValueAsString(this.value)},{name:"operator",value:f.GetOperatorName(this.operator)}]})},f.GetOperatorName=function(d){switch(d){case f._IsEqual:return"IsEqual";case f._IsDifferent:return"IsDifferent";case f._IsGreater:return"IsGreater";case f._IsLesser:return"IsLesser";default:return""}},f._IsEqual=0,f._IsDifferent=1,f._IsGreater=2,f._IsLesser=3,f}(O),G=function(h){Object(S.d)(f,h);function f(d,g){var p=h.call(this,d)||this;return p.predicate=g,p}return f.prototype.isValid=function(){return this.predicate()},f}(O),T=function(h){Object(S.d)(f,h);function f(d,g,p){var _=h.call(this,d)||this;return _.value=p,_._target=g,_}return f.prototype.isValid=function(){return this._target.state===this.value},f.prototype.serialize=function(){return this._serialize({name:"StateCondition",properties:[R.a._GetTargetProperty(this._target),{name:"value",value:this.value}]})},f}(O);U.a.RegisteredTypes["BABYLON.ValueCondition"]=x,U.a.RegisteredTypes["BABYLON.PredicateCondition"]=G,U.a.RegisteredTypes["BABYLON.StateCondition"]=T},620:function(we,P,u){"use strict";u.d(P,"j",function(){return G}),u.d(P,"g",function(){return T}),u.d(P,"h",function(){return h}),u.d(P,"d",function(){return f}),u.d(P,"e",function(){return d}),u.d(P,"i",function(){return g}),u.d(P,"b",function(){return p}),u.d(P,"a",function(){return _}),u.d(P,"c",function(){return m}),u.d(P,"f",function(){return l});var S=u(434),R=u(440),U=u(436),O=u(511),x=u(437),G=function(y){Object(S.d)(E,y);function E(A,F,B,L){var I=y.call(this,A,L)||this;return I.propertyPath=B,I._target=I._effectiveTarget=F,I}return E.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},E.prototype.execute=function(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]},E.prototype.serialize=function(A){return y.prototype._serialize.call(this,{name:"SwitchBooleanAction",properties:[O.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},A)},E}(O.a),T=function(y){Object(S.d)(E,y);function E(A,F,B,L){var I=y.call(this,A,L)||this;return I.value=B,I._target=F,I}return E.prototype.execute=function(){this._target.state=this.value},E.prototype.serialize=function(A){return y.prototype._serialize.call(this,{name:"SetStateAction",properties:[O.a._GetTargetProperty(this._target),{name:"value",value:this.value}]},A)},E}(O.a),h=function(y){Object(S.d)(E,y);function E(A,F,B,L,I){var z=y.call(this,A,I)||this;return z.propertyPath=B,z.value=L,z._target=z._effectiveTarget=F,z}return E.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},E.prototype.execute=function(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)},E.prototype.serialize=function(A){return y.prototype._serialize.call(this,{name:"SetValueAction",properties:[O.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:O.a._SerializeValueAsString(this.value)}]},A)},E}(O.a),f=function(y){Object(S.d)(E,y);function E(A,F,B,L,I){var z=y.call(this,A,I)||this;return z.propertyPath=B,z.value=L,z._target=z._effectiveTarget=F,z}return E.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&R.a.Warn("Warning: IncrementValueAction can only be used with number values")},E.prototype.execute=function(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)},E.prototype.serialize=function(A){return y.prototype._serialize.call(this,{name:"IncrementValueAction",properties:[O.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:O.a._SerializeValueAsString(this.value)}]},A)},E}(O.a),d=function(y){Object(S.d)(E,y);function E(A,F,B,L,I,z){var k=y.call(this,A,z)||this;return k.from=B,k.to=L,k.loop=I,k._target=F,k}return E.prototype._prepare=function(){},E.prototype.execute=function(){var A=this._actionManager.getScene();A.beginAnimation(this._target,this.from,this.to,this.loop)},E.prototype.serialize=function(A){return y.prototype._serialize.call(this,{name:"PlayAnimationAction",properties:[O.a._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:O.a._SerializeValueAsString(this.loop)||!1}]},A)},E}(O.a),g=function(y){Object(S.d)(E,y);function E(A,F,B){var L=y.call(this,A,B)||this;return L._target=F,L}return E.prototype._prepare=function(){},E.prototype.execute=function(){var A=this._actionManager.getScene();A.stopAnimation(this._target)},E.prototype.serialize=function(A){return y.prototype._serialize.call(this,{name:"StopAnimationAction",properties:[O.a._GetTargetProperty(this._target)]},A)},E}(O.a),p=function(y){Object(S.d)(E,y);function E(A,F){return A===void 0&&(A=0),y.call(this,A,F)||this}return E.prototype.execute=function(){},E.prototype.serialize=function(A){return y.prototype._serialize.call(this,{name:"DoNothingAction",properties:[]},A)},E}(O.a),_=function(y){Object(S.d)(E,y);function E(A,F,B){var L=y.call(this,A,B)||this;return L.children=F,L}return E.prototype._prepare=function(){for(var A=0;A<this.children.length;A++)this.children[A]._actionManager=this._actionManager,this.children[A]._prepare()},E.prototype.execute=function(A){for(var F=0;F<this.children.length;F++)this.children[F].execute(A)},E.prototype.serialize=function(A){for(var F=y.prototype._serialize.call(this,{name:"CombineAction",properties:[],combine:[]},A),B=0;B<this.children.length;B++)F.combine.push(this.children[B].serialize(null));return F},E}(O.a),m=function(y){Object(S.d)(E,y);function E(A,F,B){var L=y.call(this,A,B)||this;return L.func=F,L}return E.prototype.execute=function(A){this.func(A)},E}(O.a),l=function(y){Object(S.d)(E,y);function E(A,F,B,L){var I=y.call(this,A,L)||this;return I._target=F,I._parent=B,I}return E.prototype._prepare=function(){},E.prototype.execute=function(){if(this._target.parent!==this._parent){var A=this._parent.getWorldMatrix().clone();A.invert(),this._target.position=U.e.TransformCoordinates(this._target.position,A),this._target.parent=this._parent}},E.prototype.serialize=function(A){return y.prototype._serialize.call(this,{name:"SetParentAction",properties:[O.a._GetTargetProperty(this._target),O.a._GetTargetProperty(this._parent)]},A)},E}(O.a);x.a.RegisteredTypes["BABYLON.SetParentAction"]=l,x.a.RegisteredTypes["BABYLON.ExecuteCodeAction"]=m,x.a.RegisteredTypes["BABYLON.DoNothingAction"]=p,x.a.RegisteredTypes["BABYLON.StopAnimationAction"]=g,x.a.RegisteredTypes["BABYLON.PlayAnimationAction"]=d,x.a.RegisteredTypes["BABYLON.IncrementValueAction"]=f,x.a.RegisteredTypes["BABYLON.SetValueAction"]=h,x.a.RegisteredTypes["BABYLON.SetStateAction"]=T,x.a.RegisteredTypes["BABYLON.SetParentAction"]=l},625:function(we,P,u){"use strict";var S=u(435),R=u(457),U="rgbdDecodePixelShader",O=`
varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
void main(void)
{
gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);
}`;S.a.ShadersStore[U]=O;var x={name:U,shader:O}},626:function(we,P,u){"use strict";u.d(P,"a",function(){return G});var S=u(434),R=u(439),U=u(441),O=u(480),x=u(454),G=function(){function T(h){this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=T._DefaultIndexOfRefraction,this.indexOfRefraction=T._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=U.a.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=h}return T.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},T.prototype.isReadyForSubMesh=function(h,f,d,g){return!(h._areTexturesDirty&&f.texturesEnabled&&(this._texture&&O.a.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&O.a.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||d.getCaps().standardDerivatives&&this._bumpTexture&&O.a.ClearCoatBumpTextureEnabled&&!g&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&O.a.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))},T.prototype.prepareDefines=function(h,f){var d;this._isEnabled?(h.CLEARCOAT=!0,h.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,h.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((d=this._textureRoughness)===null||d===void 0?void 0:d._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),h.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,h._areTexturesDirty&&f.texturesEnabled&&(this._texture&&O.a.ClearCoatTextureEnabled?x.a.PrepareDefinesForMergedUV(this._texture,h,"CLEARCOAT_TEXTURE"):h.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&O.a.ClearCoatTextureEnabled?x.a.PrepareDefinesForMergedUV(this._textureRoughness,h,"CLEARCOAT_TEXTURE_ROUGHNESS"):h.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&O.a.ClearCoatBumpTextureEnabled?x.a.PrepareDefinesForMergedUV(this._bumpTexture,h,"CLEARCOAT_BUMP"):h.CLEARCOAT_BUMP=!1,h.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===T._DefaultIndexOfRefraction,this._isTintEnabled?(h.CLEARCOAT_TINT=!0,this._tintTexture&&O.a.ClearCoatTintTextureEnabled?x.a.PrepareDefinesForMergedUV(this._tintTexture,h,"CLEARCOAT_TINT_TEXTURE"):h.CLEARCOAT_TINT_TEXTURE=!1):(h.CLEARCOAT_TINT=!1,h.CLEARCOAT_TINT_TEXTURE=!1))):(h.CLEARCOAT=!1,h.CLEARCOAT_TEXTURE=!1,h.CLEARCOAT_TEXTURE_ROUGHNESS=!1,h.CLEARCOAT_BUMP=!1,h.CLEARCOAT_TINT=!1,h.CLEARCOAT_TINT_TEXTURE=!1,h.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,h.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1)},T.prototype.bindForSubMesh=function(h,f,d,g,p,_,m,l){var y,E,A,F,B,L,I,z,k=l._materialDefines,j=k.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!h.useUbo||!p||!h.isSync){j&&O.a.ClearCoatTextureEnabled?(h.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),x.a.BindTextureMatrix(this._texture,h,"clearCoat")):(this._texture||this._textureRoughness)&&O.a.ClearCoatTextureEnabled&&(h.updateFloat4("vClearCoatInfos",(E=(y=this._texture)===null||y===void 0?void 0:y.coordinatesIndex)!==null&&E!==void 0?E:0,(F=(A=this._texture)===null||A===void 0?void 0:A.level)!==null&&F!==void 0?F:0,(L=(B=this._textureRoughness)===null||B===void 0?void 0:B.coordinatesIndex)!==null&&L!==void 0?L:0,(z=(I=this._textureRoughness)===null||I===void 0?void 0:I.level)!==null&&z!==void 0?z:0),this._texture&&x.a.BindTextureMatrix(this._texture,h,"clearCoat"),this._textureRoughness&&!j&&!k.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&x.a.BindTextureMatrix(this._textureRoughness,h,"clearCoatRoughness")),this._bumpTexture&&d.getCaps().standardDerivatives&&O.a.ClearCoatTextureEnabled&&!g&&(h.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),x.a.BindTextureMatrix(this._bumpTexture,h,"clearCoatBump"),f._mirroredCameraPosition?h.updateFloat2("vClearCoatTangentSpaceParams",_?1:-1,m?1:-1):h.updateFloat2("vClearCoatTangentSpaceParams",_?-1:1,m?-1:1)),this._tintTexture&&O.a.ClearCoatTintTextureEnabled&&(h.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),x.a.BindTextureMatrix(this._tintTexture,h,"clearCoatTint")),h.updateFloat2("vClearCoatParams",this.intensity,this.roughness);var w=1-this._indexOfRefraction,Q=1+this._indexOfRefraction,W=Math.pow(-w/Q,2),Y=1/this._indexOfRefraction;h.updateFloat4("vClearCoatRefractionParams",W,Y,w,Q),this._isTintEnabled&&(h.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),h.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}f.texturesEnabled&&(this._texture&&O.a.ClearCoatTextureEnabled&&h.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!j&&!k.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&O.a.ClearCoatTextureEnabled&&h.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&d.getCaps().standardDerivatives&&O.a.ClearCoatBumpTextureEnabled&&!g&&h.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&O.a.ClearCoatTintTextureEnabled&&h.setTexture("clearCoatTintSampler",this._tintTexture))},T.prototype.hasTexture=function(h){return this._texture===h||this._textureRoughness===h||this._bumpTexture===h||this._tintTexture===h},T.prototype.getActiveTextures=function(h){this._texture&&h.push(this._texture),this._textureRoughness&&h.push(this._textureRoughness),this._bumpTexture&&h.push(this._bumpTexture),this._tintTexture&&h.push(this._tintTexture)},T.prototype.getAnimatables=function(h){this._texture&&this._texture.animations&&this._texture.animations.length>0&&h.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&h.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&h.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&h.push(this._tintTexture)},T.prototype.dispose=function(h){var f,d,g,p;h&&((f=this._texture)===null||f===void 0||f.dispose(),(d=this._textureRoughness)===null||d===void 0||d.dispose(),(g=this._bumpTexture)===null||g===void 0||g.dispose(),(p=this._tintTexture)===null||p===void 0||p.dispose())},T.prototype.getClassName=function(){return"PBRClearCoatConfiguration"},T.AddFallbacks=function(h,f,d){return h.CLEARCOAT_BUMP&&f.addFallback(d++,"CLEARCOAT_BUMP"),h.CLEARCOAT_TINT&&f.addFallback(d++,"CLEARCOAT_TINT"),h.CLEARCOAT&&f.addFallback(d++,"CLEARCOAT"),d},T.AddUniforms=function(h){h.push("vClearCoatTangentSpaceParams","vClearCoatParams","vClearCoatRefractionParams","vClearCoatTintParams","clearCoatColorAtDistance","clearCoatMatrix","clearCoatRoughnessMatrix","clearCoatBumpMatrix","clearCoatTintMatrix","vClearCoatInfos","vClearCoatBumpInfos","vClearCoatTintInfos")},T.AddSamplers=function(h){h.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")},T.PrepareUniformBuffer=function(h){h.addUniform("vClearCoatParams",2),h.addUniform("vClearCoatRefractionParams",4),h.addUniform("vClearCoatInfos",4),h.addUniform("clearCoatMatrix",16),h.addUniform("clearCoatRoughnessMatrix",16),h.addUniform("vClearCoatBumpInfos",2),h.addUniform("vClearCoatTangentSpaceParams",2),h.addUniform("clearCoatBumpMatrix",16),h.addUniform("vClearCoatTintParams",4),h.addUniform("clearCoatColorAtDistance",1),h.addUniform("vClearCoatTintInfos",2),h.addUniform("clearCoatTintMatrix",16)},T.prototype.copyTo=function(h){R.a.Clone(function(){return h},this)},T.prototype.serialize=function(){return R.a.Serialize(this)},T.prototype.parse=function(h,f,d){var g=this;R.a.Parse(function(){return g},h,f,d)},T._DefaultIndexOfRefraction=1.5,Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"isEnabled",void 0),Object(S.c)([Object(R.c)()],T.prototype,"intensity",void 0),Object(S.c)([Object(R.c)()],T.prototype,"roughness",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"indexOfRefraction",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"texture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"useRoughnessFromMainTexture",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"textureRoughness",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"remapF0OnInterfaceChange",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"bumpTexture",void 0),Object(S.c)([Object(R.c)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"isTintEnabled",void 0),Object(S.c)([Object(R.e)()],T.prototype,"tintColor",void 0),Object(S.c)([Object(R.c)()],T.prototype,"tintColorAtDistance",void 0),Object(S.c)([Object(R.c)()],T.prototype,"tintThickness",void 0),Object(S.c)([Object(R.m)(),Object(R.b)("_markAllSubMeshesAsTexturesDirty")],T.prototype,"tintTexture",void 0),T}()},627:function(we,P,u){"use strict";var S=u(435),R="subSurfaceScatteringFunctions",U=`bool testLightingForSSS(float diffusionProfile)
{
return diffusionProfile<1.;
}`;S.a.IncludesShadersStore[R]=U;var O={name:R,shader:U}},628:function(we,P,u){"use strict";u.d(P,"a",function(){return F});var S=u(434),R=u(436),U=u(458),O=u(679),x=u(680),G=u(676),T=u(476),h=u(541),f=u(536),d=u(629),g=u(440),p=u(448),_=R.e.Up(),m=R.e.Zero(),l=new R.e,y=new R.e,E=new R.a,A=new R.a,F=function(B){Object(S.d)(L,B);function L(I,z,k){var j=this;if(!L.IsSupported){g.a.Error("CascadedShadowMap is not supported by the current engine.");return}return j=B.call(this,I,z,k)||this,j.usePercentageCloserFiltering=!0,j}return L.prototype._validateFilter=function(I){return I===h.a.FILTER_NONE||I===h.a.FILTER_PCF||I===h.a.FILTER_PCSS?I:(console.error('Unsupported filter "'+I+'"!'),h.a.FILTER_NONE)},Object.defineProperty(L.prototype,"numCascades",{get:function(){return this._numCascades},set:function(I){I=Math.min(Math.max(I,L.MIN_CASCADES_COUNT),L.MAX_CASCADES_COUNT),I!==this._numCascades&&(this._numCascades=I,this.recreateShadowMap())},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"freezeShadowCastersBoundingInfo",{get:function(){return this._freezeShadowCastersBoundingInfo},set:function(I){this._freezeShadowCastersBoundingInfoObservable&&I&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!I&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=I,I&&this._computeShadowCastersBoundingInfo()},enumerable:!1,configurable:!0}),L.prototype._computeShadowCastersBoundingInfo=function(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){for(var I=this._shadowMap.renderList,z=0;z<I.length;z++){var k=I[z];if(!!k){var j=k.getBoundingInfo(),w=j.boundingBox;this._scbiMin.minimizeInPlace(w.minimumWorld),this._scbiMax.maximizeInPlace(w.maximumWorld)}}for(var Q=this._scene.meshes,z=0;z<Q.length;z++){var k=Q[z];if(!(!k||!k.isVisible||!k.isEnabled||!k.receiveShadows)){var j=k.getBoundingInfo(),w=j.boundingBox;this._scbiMin.minimizeInPlace(w.minimumWorld),this._scbiMax.maximizeInPlace(w.maximumWorld)}}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)},Object.defineProperty(L.prototype,"shadowCastersBoundingInfo",{get:function(){return this._shadowCastersBoundingInfo},set:function(I){this._shadowCastersBoundingInfo=I},enumerable:!1,configurable:!0}),L.prototype.setMinMaxDistance=function(I,z){this._minDistance===I&&this._maxDistance===z||(I>z&&(I=0,z=1),I<0&&(I=0),z>1&&(z=1),this._minDistance=I,this._maxDistance=z,this._breaksAreDirty=!0)},Object.defineProperty(L.prototype,"minDistance",{get:function(){return this._minDistance},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"maxDistance",{get:function(){return this._maxDistance},enumerable:!1,configurable:!0}),L.prototype.getClassName=function(){return L.CLASSNAME},L.prototype.getCascadeMinExtents=function(I){return I>=0&&I<this._numCascades?this._cascadeMinExtents[I]:null},L.prototype.getCascadeMaxExtents=function(I){return I>=0&&I<this._numCascades?this._cascadeMaxExtents[I]:null},Object.defineProperty(L.prototype,"shadowMaxZ",{get:function(){return!this._scene||!this._scene.activeCamera?0:this._shadowMaxZ},set:function(I){if(!this._scene||!this._scene.activeCamera){this._shadowMaxZ=I;return}this._shadowMaxZ===I||I<this._scene.activeCamera.minZ||I>this._scene.activeCamera.maxZ||(this._shadowMaxZ=I,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"debug",{get:function(){return this._debug},set:function(I){this._debug=I,this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"depthClamp",{get:function(){return this._depthClamp},set:function(I){this._depthClamp=I},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"cascadeBlendPercentage",{get:function(){return this._cascadeBlendPercentage},set:function(I){this._cascadeBlendPercentage=I,this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"lambda",{get:function(){return this._lambda},set:function(I){var z=Math.min(Math.max(I,0),1);this._lambda!=z&&(this._lambda=z,this._breaksAreDirty=!0)},enumerable:!1,configurable:!0}),L.prototype.getCascadeViewMatrix=function(I){return I>=0&&I<this._numCascades?this._viewMatrices[I]:null},L.prototype.getCascadeProjectionMatrix=function(I){return I>=0&&I<this._numCascades?this._projectionMatrices[I]:null},L.prototype.getCascadeTransformMatrix=function(I){return I>=0&&I<this._numCascades?this._transformMatrices[I]:null},L.prototype.setDepthRenderer=function(I){this._depthRenderer=I,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)},Object.defineProperty(L.prototype,"autoCalcDepthBounds",{get:function(){return this._autoCalcDepthBounds},set:function(I){var z=this,k=this._scene.activeCamera;if(!!k){if(this._autoCalcDepthBounds=I,!I){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new d.a(k),this._depthReducer.onAfterReductionPerformed.add(function(j){var w=j.min,Q=j.max;w>=Q&&(w=0,Q=1),(w!=z._minDistance||Q!=z._maxDistance)&&z.setMinMaxDistance(w,Q)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"autoCalcDepthBoundsRefreshRate",{get:function(){var I,z,k;return(k=(z=(I=this._depthReducer)===null||I===void 0?void 0:I.depthRenderer)===null||z===void 0?void 0:z.getDepthMap().refreshRate)!==null&&k!==void 0?k:-1},set:function(I){var z;((z=this._depthReducer)===null||z===void 0?void 0:z.depthRenderer)&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=I)},enumerable:!1,configurable:!0}),L.prototype.splitFrustum=function(){this._breaksAreDirty=!0},L.prototype._splitFrustum=function(){var I=this._scene.activeCamera;if(!!I){for(var z=I.minZ,k=I.maxZ,j=k-z,w=this._minDistance,Q=this._shadowMaxZ<k&&this._shadowMaxZ>=z?Math.min((this._shadowMaxZ-z)/(k-z),this._maxDistance):this._maxDistance,W=z+w*j,Y=z+Q*j,he=Y-W,le=Y/W,J=0;J<this._cascades.length;++J){var Re=(J+1)/this._numCascades,Me=W*Math.pow(le,Re),me=W+he*Re,H=this._lambda*(Me-me)+me;this._cascades[J].prevBreakDistance=J===0?w:this._cascades[J-1].breakDistance,this._cascades[J].breakDistance=(H-z)/j,this._viewSpaceFrustumsZ[J]=z+this._cascades[J].breakDistance*j,this._frustumLengths[J]=(this._cascades[J].breakDistance-this._cascades[J].prevBreakDistance)*j}this._breaksAreDirty=!1}},L.prototype._computeMatrices=function(){var I=this._scene,z=I.activeCamera;if(!!z){R.e.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(R.e.Dot(this._lightDirection,R.e.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);for(var k=0;k<this._numCascades;++k){this._computeFrustumInWorldSpace(k),this._computeCascadeFrustum(k),this._cascadeMaxExtents[k].subtractToRef(this._cascadeMinExtents[k],l),this._frustumCenter[k].addToRef(this._lightDirection.scale(this._cascadeMinExtents[k].z),this._shadowCameraPos[k]),R.a.LookAtLHToRef(this._shadowCameraPos[k],this._frustumCenter[k],_,this._viewMatrices[k]);var j=0,w=l.z,Q=this._shadowCastersBoundingInfo;Q.update(this._viewMatrices[k]),w=Math.min(w,Q.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===h.a.FILTER_PCSS?j=Math.min(j,Q.boundingBox.minimumWorld.z):j=Math.max(j,Q.boundingBox.minimumWorld.z),R.a.OrthoOffCenterLHToRef(this._cascadeMinExtents[k].x,this._cascadeMaxExtents[k].x,this._cascadeMinExtents[k].y,this._cascadeMaxExtents[k].y,j,w,this._projectionMatrices[k]),this._cascadeMinExtents[k].z=j,this._cascadeMaxExtents[k].z=w,this._viewMatrices[k].multiplyToRef(this._projectionMatrices[k],this._transformMatrices[k]),R.e.TransformCoordinatesToRef(m,this._transformMatrices[k],l),l.scaleInPlace(this._mapSize/2),y.copyFromFloats(Math.round(l.x),Math.round(l.y),Math.round(l.z)),y.subtractInPlace(l).scaleInPlace(2/this._mapSize),R.a.TranslationToRef(y.x,y.y,0,E),this._projectionMatrices[k].multiplyToRef(E,this._projectionMatrices[k]),this._viewMatrices[k].multiplyToRef(this._projectionMatrices[k],this._transformMatrices[k]),this._transformMatrices[k].copyToArray(this._transformMatricesAsArray,k*16)}}},L.prototype._computeFrustumInWorldSpace=function(I){if(!!this._scene.activeCamera){var z=this._cascades[I].prevBreakDistance,k=this._cascades[I].breakDistance;this._scene.activeCamera.getViewMatrix();for(var j=R.a.Invert(this._scene.activeCamera.getTransformationMatrix()),w=0;w<L.frustumCornersNDCSpace.length;++w)R.e.TransformCoordinatesToRef(L.frustumCornersNDCSpace[w],j,this._frustumCornersWorldSpace[I][w]);for(var w=0;w<L.frustumCornersNDCSpace.length/2;++w)l.copyFrom(this._frustumCornersWorldSpace[I][w+4]).subtractInPlace(this._frustumCornersWorldSpace[I][w]),y.copyFrom(l).scaleInPlace(z),l.scaleInPlace(k),l.addInPlace(this._frustumCornersWorldSpace[I][w]),this._frustumCornersWorldSpace[I][w+4].copyFrom(l),this._frustumCornersWorldSpace[I][w].addInPlace(y)}},L.prototype._computeCascadeFrustum=function(I){this._cascadeMinExtents[I].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[I].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[I].copyFromFloats(0,0,0);var z=this._scene.activeCamera;if(!!z){for(var k=0;k<this._frustumCornersWorldSpace[I].length;++k)this._frustumCenter[I].addInPlace(this._frustumCornersWorldSpace[I][k]);if(this._frustumCenter[I].scaleInPlace(1/this._frustumCornersWorldSpace[I].length),this.stabilizeCascades){for(var j=0,k=0;k<this._frustumCornersWorldSpace[I].length;++k){var w=this._frustumCornersWorldSpace[I][k].subtractToRef(this._frustumCenter[I],l).length();j=Math.max(j,w)}j=Math.ceil(j*16)/16,this._cascadeMaxExtents[I].copyFromFloats(j,j,j),this._cascadeMinExtents[I].copyFromFloats(-j,-j,-j)}else{var Q=this._frustumCenter[I];this._frustumCenter[I].addToRef(this._lightDirection,l),R.a.LookAtLHToRef(Q,l,_,E);for(var k=0;k<this._frustumCornersWorldSpace[I].length;++k)R.e.TransformCoordinatesToRef(this._frustumCornersWorldSpace[I][k],E,l),this._cascadeMinExtents[I].minimizeInPlace(l),this._cascadeMaxExtents[I].maximizeInPlace(l)}}},Object.defineProperty(L,"IsSupported",{get:function(){var I=p.a.LastCreatedEngine;return I?I._features.supportCSM:!1},enumerable:!1,configurable:!0}),L.prototype._initializeGenerator=function(){var I,z,k,j,w,Q,W,Y,he,le,J,Re,Me,me,H,q,_e,Ee,Te,se;this.penumbraDarkness=(I=this.penumbraDarkness)!==null&&I!==void 0?I:1,this._numCascades=(z=this._numCascades)!==null&&z!==void 0?z:L.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=(k=this.stabilizeCascades)!==null&&k!==void 0?k:!1,this._freezeShadowCastersBoundingInfoObservable=(j=this._freezeShadowCastersBoundingInfoObservable)!==null&&j!==void 0?j:null,this.freezeShadowCastersBoundingInfo=(w=this.freezeShadowCastersBoundingInfo)!==null&&w!==void 0?w:!1,this._scbiMin=(Q=this._scbiMin)!==null&&Q!==void 0?Q:new R.e(0,0,0),this._scbiMax=(W=this._scbiMax)!==null&&W!==void 0?W:new R.e(0,0,0),this._shadowCastersBoundingInfo=(Y=this._shadowCastersBoundingInfo)!==null&&Y!==void 0?Y:new f.a(new R.e(0,0,0),new R.e(0,0,0)),this._breaksAreDirty=(he=this._breaksAreDirty)!==null&&he!==void 0?he:!0,this._minDistance=(le=this._minDistance)!==null&&le!==void 0?le:0,this._maxDistance=(J=this._maxDistance)!==null&&J!==void 0?J:1,this._currentLayer=(Re=this._currentLayer)!==null&&Re!==void 0?Re:0,this._shadowMaxZ=(H=(Me=this._shadowMaxZ)!==null&&Me!==void 0?Me:(me=this._scene.activeCamera)===null||me===void 0?void 0:me.maxZ)!==null&&H!==void 0?H:1e4,this._debug=(q=this._debug)!==null&&q!==void 0?q:!1,this._depthClamp=(_e=this._depthClamp)!==null&&_e!==void 0?_e:!0,this._cascadeBlendPercentage=(Ee=this._cascadeBlendPercentage)!==null&&Ee!==void 0?Ee:.1,this._lambda=(Te=this._lambda)!==null&&Te!==void 0?Te:.5,this._autoCalcDepthBounds=(se=this._autoCalcDepthBounds)!==null&&se!==void 0?se:!1,B.prototype._initializeGenerator.call(this)},L.prototype._createTargetRenderTexture=function(){var I={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new U.a(this._light.name+"_shadowMap",I,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(513,!0)},L.prototype._initializeShadowMap=function(){var I=this;if(B.prototype._initializeShadowMap.call(this),this._shadowMap!==null){this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(var z=0;z<this._numCascades;++z){this._cascades[z]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[z]=R.a.Zero(),this._projectionMatrices[z]=R.a.Zero(),this._transformMatrices[z]=R.a.Zero(),this._cascadeMinExtents[z]=new R.e,this._cascadeMaxExtents[z]=new R.e,this._frustumCenter[z]=new R.e,this._shadowCameraPos[z]=new R.e,this._frustumCornersWorldSpace[z]=new Array(L.frustumCornersNDCSpace.length);for(var k=0;k<L.frustumCornersNDCSpace.length;++k)this._frustumCornersWorldSpace[z][k]=new R.e}var j=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(function(w){I._currentLayer=w,I._filter===h.a.FILTER_PCF&&j.setColorWrite(!1),I._scene.setTransformMatrix(I.getCascadeViewMatrix(w),I.getCascadeProjectionMatrix(w))}),this._shadowMap.onBeforeBindObservable.add(function(){j._debugPushGroup("cascaded shadow map generation for "+I._nameForCustomEffect,1),I._breaksAreDirty&&I._splitFrustum(),I._computeMatrices()}),this._splitFrustum()}},L.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(I,z,k,j){var w,Q,W,Y,he,le;z.setMatrix((w=k==null?void 0:k.viewProjection)!==null&&w!==void 0?w:"viewProjection",this.getCascadeTransformMatrix(this._currentLayer)),z.setMatrix((Q=k==null?void 0:k.view)!==null&&Q!==void 0?Q:"view",this.getCascadeViewMatrix(this._currentLayer)),z.setMatrix((W=k==null?void 0:k.projection)!==null&&W!==void 0?W:"projection",this.getCascadeProjectionMatrix(this._currentLayer));var J=j.getWorldMatrix();z.setMatrix((Y=k==null?void 0:k.world)!==null&&Y!==void 0?Y:"world",J),J.multiplyToRef(this.getCascadeTransformMatrix(this._currentLayer),E),z.setMatrix((he=k==null?void 0:k.worldViewProjection)!==null&&he!==void 0?he:"worldViewProjection",E),J.multiplyToRef(this.getCascadeViewMatrix(this._currentLayer),A),z.setMatrix((le=k==null?void 0:k.worldView)!==null&&le!==void 0?le:"worldView",A)},L.prototype._isReadyCustomDefines=function(I,z,k){I.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==h.a.FILTER_PCSS?"1":"0"))},L.prototype.prepareDefines=function(I,z){B.prototype.prepareDefines.call(this,I,z);var k=this._scene,j=this._light;if(!(!k.shadowsEnabled||!j.shadowEnabled)){I["SHADOWCSM"+z]=!0,I["SHADOWCSMDEBUG"+z]=this.debug,I["SHADOWCSMNUM_CASCADES"+z]=this.numCascades,I["SHADOWCSM_RIGHTHANDED"+z]=k.useRightHandedSystem;var w=k.activeCamera;w&&this._shadowMaxZ<w.maxZ&&(I["SHADOWCSMUSESHADOWMAXZ"+z]=!0),this.cascadeBlendPercentage===0&&(I["SHADOWCSMNOBLEND"+z]=!0)}},L.prototype.bindShadowLight=function(I,z){var k=this._light,j=this._scene;if(!(!j.shadowsEnabled||!k.shadowEnabled)){var w=j.activeCamera;if(!!w){var Q=this.getShadowMap();if(!!Q){var W=Q.getSize().width;if(z.setMatrices("lightMatrix"+I,this._transformMatricesAsArray),z.setArray("viewFrustumZ"+I,this._viewSpaceFrustumsZ),z.setFloat("cascadeBlendFactor"+I,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),z.setArray("frustumLengths"+I,this._frustumLengths),this._filter===h.a.FILTER_PCF)z.setDepthStencilTexture("shadowSampler"+I,Q),k._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),W,1/W,this.frustumEdgeFalloff,I);else if(this._filter===h.a.FILTER_PCSS){for(var Y=0;Y<this._numCascades;++Y)this._lightSizeUVCorrection[Y*2+0]=Y===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[Y].x-this._cascadeMinExtents[Y].x),this._lightSizeUVCorrection[Y*2+1]=Y===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[Y].y-this._cascadeMinExtents[Y].y),this._depthCorrection[Y]=Y===0?1:(this._cascadeMaxExtents[Y].z-this._cascadeMinExtents[Y].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);z.setDepthStencilTexture("shadowSampler"+I,Q),z.setTexture("depthSampler"+I,Q),z.setArray2("lightSizeUVCorrection"+I,this._lightSizeUVCorrection),z.setArray("depthCorrection"+I,this._depthCorrection),z.setFloat("penumbraDarkness"+I,this.penumbraDarkness),k._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/W,this._contactHardeningLightSizeUVRatio*W,this.frustumEdgeFalloff,I)}else z.setTexture("shadowSampler"+I,Q),k._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),W,1/W,this.frustumEdgeFalloff,I);k._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(w),this.getLight().getDepthMinZ(w)+this.getLight().getDepthMaxZ(w),I)}}}},L.prototype.getTransformMatrix=function(){return this.getCascadeTransformMatrix(0)},L.prototype.dispose=function(){B.prototype.dispose.call(this),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)},L.prototype.serialize=function(){var I=B.prototype.serialize.call(this),z=this.getShadowMap();if(!z)return I;if(I.numCascades=this._numCascades,I.debug=this._debug,I.stabilizeCascades=this.stabilizeCascades,I.lambda=this._lambda,I.cascadeBlendPercentage=this.cascadeBlendPercentage,I.depthClamp=this._depthClamp,I.autoCalcDepthBounds=this.autoCalcDepthBounds,I.shadowMaxZ=this._shadowMaxZ,I.penumbraDarkness=this.penumbraDarkness,I.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,I.minDistance=this.minDistance,I.maxDistance=this.maxDistance,I.renderList=[],z.renderList)for(var k=0;k<z.renderList.length;k++){var j=z.renderList[k];I.renderList.push(j.id)}return I},L.Parse=function(I,z){var k=h.a.Parse(I,z,function(j,w){return new L(j,w)});return I.numCascades!==void 0&&(k.numCascades=I.numCascades),I.debug!==void 0&&(k.debug=I.debug),I.stabilizeCascades!==void 0&&(k.stabilizeCascades=I.stabilizeCascades),I.lambda!==void 0&&(k.lambda=I.lambda),I.cascadeBlendPercentage!==void 0&&(k.cascadeBlendPercentage=I.cascadeBlendPercentage),I.depthClamp!==void 0&&(k.depthClamp=I.depthClamp),I.autoCalcDepthBounds!==void 0&&(k.autoCalcDepthBounds=I.autoCalcDepthBounds),I.shadowMaxZ!==void 0&&(k.shadowMaxZ=I.shadowMaxZ),I.penumbraDarkness!==void 0&&(k.penumbraDarkness=I.penumbraDarkness),I.freezeShadowCastersBoundingInfo!==void 0&&(k.freezeShadowCastersBoundingInfo=I.freezeShadowCastersBoundingInfo),I.minDistance!==void 0&&I.maxDistance!==void 0&&k.setMinMaxDistance(I.minDistance,I.maxDistance),k},L.frustumCornersNDCSpace=[new R.e(-1,1,-1),new R.e(1,1,-1),new R.e(1,-1,-1),new R.e(-1,-1,-1),new R.e(-1,1,1),new R.e(1,1,1),new R.e(1,-1,1),new R.e(-1,-1,1)],L.CLASSNAME="CascadedShadowGenerator",L.DEFAULT_CASCADES_COUNT=4,L.MIN_CASCADES_COUNT=2,L.MAX_CASCADES_COUNT=4,L._SceneComponentInitialization=function(I){throw T.a.WarnImport("ShadowGeneratorSceneComponent")},L}(h.a)},629:function(we,P,u){"use strict";u.d(P,"a",function(){return O});var S=u(434),R=u(556),U=u(638),O=function(x){Object(S.d)(G,x);function G(T){return x.call(this,T)||this}return Object.defineProperty(G.prototype,"depthRenderer",{get:function(){return this._depthRenderer},enumerable:!1,configurable:!0}),G.prototype.setDepthRenderer=function(T,h,f){T===void 0&&(T=null),h===void 0&&(h=2),f===void 0&&(f=!0);var d=this._camera.getScene();this._depthRenderer&&(delete d._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),T===null&&(d._depthRenderer||(d._depthRenderer={}),T=this._depthRenderer=new R.a(d,h,this._camera,!1),T.enabled=!1,this._depthRendererId="minmax"+this._camera.id,d._depthRenderer[this._depthRendererId]=T),x.prototype.setSourceTexture.call(this,T.getDepthMap(),!0,h,f)},G.prototype.setSourceTexture=function(T,h,f,d){f===void 0&&(f=2),d===void 0&&(d=!0),x.prototype.setSourceTexture.call(this,T,h,f,d)},G.prototype.activate=function(){this._depthRenderer&&(this._depthRenderer.enabled=!0),x.prototype.activate.call(this)},G.prototype.deactivate=function(){x.prototype.deactivate.call(this),this._depthRenderer&&(this._depthRenderer.enabled=!1)},G.prototype.dispose=function(T){if(T===void 0&&(T=!0),x.prototype.dispose.call(this,T),this._depthRenderer&&T){var h=this._depthRenderer.getDepthMap().getScene();h&&delete h._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}},G}(U.a)},630:function(we,P,u){"use strict";u.d(P,"a",function(){return T}),u.d(P,"b",function(){return h});var S=u(434),R=u(447),U=u(520),O=u(438),x=u(435),G=u(534),T=function(){function f(d,g){var p;g===void 0&&(g=f._DefaultOptions),this.engine=d,this._fullscreenViewport=new U.a(0,0,1,1),g=Object(S.a)(Object(S.a)({},f._DefaultOptions),g),this._vertexBuffers=(p={},p[R.b.PositionKind]=new R.b(d,g.positions,R.b.PositionKind,!1,!1,2),p),this._indexBuffer=d.createIndexBuffer(g.indices)}return f.prototype.setViewport=function(d){d===void 0&&(d=this._fullscreenViewport),this.engine.setViewport(d)},f.prototype.bindBuffers=function(d){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,d)},f.prototype.applyEffectWrapper=function(d){this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(d.effect),this.bindBuffers(d.effect),d.onApplyObservable.notifyObservers({})},f.prototype.restoreStates=function(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0},f.prototype.draw=function(){this.engine.drawElementsType(0,0,6)},f.prototype.isRenderTargetTexture=function(d){return d.renderList!==void 0},f.prototype.render=function(d,g){if(g===void 0&&(g=null),!!d.effect.isReady()){this.setViewport();var p=g===null?null:this.isRenderTargetTexture(g)?g.getInternalTexture():g;p&&this.engine.bindFramebuffer(p),this.applyEffectWrapper(d),this.draw(),p&&this.engine.unBindFramebuffer(p),this.restoreStates()}},f.prototype.dispose=function(){var d=this._vertexBuffers[R.b.PositionKind];d&&(d.dispose(),delete this._vertexBuffers[R.b.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer)},f._DefaultOptions={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},f}(),h=function(){function f(d){var g=this;this.onApplyObservable=new O.c;var p,_=d.uniformNames||[];d.vertexShader?p={fragmentSource:d.fragmentShader,vertexSource:d.vertexShader,spectorName:d.name||"effectWrapper"}:(_.push("scale"),p={fragmentSource:d.fragmentShader,vertex:"postprocess",spectorName:d.name||"effectWrapper"},this.onApplyObservable.add(function(){g.effect.setFloat2("scale",1,1)}));var m=d.defines?d.defines.join(`
`):"";d.useShaderStore?(p.fragment=p.fragmentSource,p.vertex||(p.vertex=p.vertexSource),delete p.fragmentSource,delete p.vertexSource,this.effect=d.engine.createEffect(p.spectorName,d.attributeNames||["position"],_,d.samplerNames,m,void 0,d.onCompiled)):this.effect=new x.a(p,d.attributeNames||["position"],_,d.samplerNames,d.engine,m,void 0,d.onCompiled)}return f.prototype.dispose=function(){this.effect.dispose()},f}()},631:function(we,P,u){"use strict";u.d(P,"a",function(){return O});var S=u(434),R=u(442),U=u(492),O=function(x){Object(S.d)(G,x);function G(T,h,f,d,g,p,_,m,l,y){_===void 0&&(_=!0),m===void 0&&(m=!1),l===void 0&&(l=R.a.TRILINEAR_SAMPLINGMODE),y===void 0&&(y=0);var E=x.call(this,null,p,!_,m)||this;return E.format=g,E._texture=p.getEngine().createRawTexture2DArray(T,h,f,d,g,_,m,l,null,y),E._depth=d,E.is2DArray=!0,E}return Object.defineProperty(G.prototype,"depth",{get:function(){return this._depth},enumerable:!1,configurable:!0}),G.prototype.update=function(T){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,T,this._texture.format,this._texture.invertY,null,this._texture.type)},G.CreateRGBATexture=function(T,h,f,d,g,p,_,m,l){return p===void 0&&(p=!0),_===void 0&&(_=!1),m===void 0&&(m=3),l===void 0&&(l=0),new G(T,h,f,d,5,g,p,_,m,l)},G}(R.a)},632:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(440),R=u(436),U=u(447),O=u(503),x=u(510),G=u(544),T=u(609),h=function(){function f(d,g,p){if(d===void 0&&(d=!0),g===void 0&&(g=10),p===void 0&&(p=CANNON),this._useDeltaForWorldStep=d,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodysToRemoveAfterStep=new Array,this._firstFrame=!0,this._minus90X=new R.b(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new R.b(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=R.e.Zero(),this._tmpDeltaPosition=R.e.Zero(),this._tmpUnityRotation=new R.b,this.BJSCANNON=p,!this.isSupported()){S.a.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=g,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new T.a}return f.prototype.setGravity=function(d){var g=d;this.world.gravity.set(g.x,g.y,g.z)},f.prototype.setTimeStep=function(d){this._fixedTimeStep=d},f.prototype.getTimeStep=function(){return this._fixedTimeStep},f.prototype.executeStep=function(d,g){if(this._firstFrame){this._firstFrame=!1;for(var p=0,_=g;p<_.length;p++){var m=_[p];m.type==O.a.HeightmapImpostor||m.type===O.a.PlaneImpostor||m.beforeStep()}}this.world.step(this._useDeltaForWorldStep?d:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()},f.prototype._removeMarkedPhysicsBodiesFromWorld=function(){var d=this;this._physicsBodysToRemoveAfterStep.length>0&&(this._physicsBodysToRemoveAfterStep.forEach(function(g){d.world.remove(g)}),this._physicsBodysToRemoveAfterStep=[])},f.prototype.applyImpulse=function(d,g,p){var _=new this.BJSCANNON.Vec3(p.x,p.y,p.z),m=new this.BJSCANNON.Vec3(g.x,g.y,g.z);d.physicsBody.applyImpulse(m,_)},f.prototype.applyForce=function(d,g,p){var _=new this.BJSCANNON.Vec3(p.x,p.y,p.z),m=new this.BJSCANNON.Vec3(g.x,g.y,g.z);d.physicsBody.applyForce(m,_)},f.prototype.generatePhysicsBody=function(d){if(this._removeMarkedPhysicsBodiesFromWorld(),d.parent){d.physicsBody&&(this.removePhysicsBody(d),d.forceUpdate());return}if(d.isBodyInitRequired()){var g=this._createShape(d),p=d.physicsBody;p&&this.removePhysicsBody(d);var _=this._addMaterial("mat-"+d.uniqueId,d.getParam("friction"),d.getParam("restitution")),m={mass:d.getParam("mass"),material:_},l=d.getParam("nativeOptions");for(var y in l)l.hasOwnProperty(y)&&(m[y]=l[y]);d.physicsBody=new this.BJSCANNON.Body(m),d.physicsBody.addEventListener("collide",d.onCollide),this.world.addEventListener("preStep",d.beforeStep),this.world.addEventListener("postStep",d.afterStep),d.physicsBody.addShape(g),this.world.add(d.physicsBody),p&&["force","torque","velocity","angularVelocity"].forEach(function(E){var A=p[E];d.physicsBody[E].set(A.x,A.y,A.z)}),this._processChildMeshes(d)}this._updatePhysicsBodyTransformation(d)},f.prototype._processChildMeshes=function(d){var g=this,p=d.object.getChildMeshes?d.object.getChildMeshes(!0):[],_=d.object.rotationQuaternion;if(p.length){var m=function(l){if(!(!_||!l.rotationQuaternion)){var y=l.getPhysicsImpostor();if(y){var E=y.parent;if(E!==d){var A=l.getAbsolutePosition().subtract(l.parent.getAbsolutePosition()),F=l.rotationQuaternion;y.physicsBody&&(g.removePhysicsBody(y),y.physicsBody=null),y.parent=d,y.resetUpdateFlags(),d.physicsBody.addShape(g._createShape(y),new g.BJSCANNON.Vec3(A.x,A.y,A.z),new g.BJSCANNON.Quaternion(F.x,F.y,F.z,F.w)),d.physicsBody.mass+=y.getParam("mass")}}_.multiplyInPlace(l.rotationQuaternion),l.getChildMeshes(!0).filter(function(B){return!!B.physicsImpostor}).forEach(m)}};p.filter(function(l){return!!l.physicsImpostor}).forEach(m)}},f.prototype.removePhysicsBody=function(d){d.physicsBody.removeEventListener("collide",d.onCollide),this.world.removeEventListener("preStep",d.beforeStep),this.world.removeEventListener("postStep",d.afterStep),this._physicsBodysToRemoveAfterStep.indexOf(d.physicsBody)===-1&&this._physicsBodysToRemoveAfterStep.push(d.physicsBody)},f.prototype.generateJoint=function(d){var g=d.mainImpostor.physicsBody,p=d.connectedImpostor.physicsBody;if(!(!g||!p)){var _,m=d.joint.jointData,l={pivotA:m.mainPivot?new this.BJSCANNON.Vec3().set(m.mainPivot.x,m.mainPivot.y,m.mainPivot.z):null,pivotB:m.connectedPivot?new this.BJSCANNON.Vec3().set(m.connectedPivot.x,m.connectedPivot.y,m.connectedPivot.z):null,axisA:m.mainAxis?new this.BJSCANNON.Vec3().set(m.mainAxis.x,m.mainAxis.y,m.mainAxis.z):null,axisB:m.connectedAxis?new this.BJSCANNON.Vec3().set(m.connectedAxis.x,m.connectedAxis.y,m.connectedAxis.z):null,maxForce:m.nativeParams.maxForce,collideConnected:!!m.collision};switch(d.joint.type){case x.e.HingeJoint:case x.e.Hinge2Joint:_=new this.BJSCANNON.HingeConstraint(g,p,l);break;case x.e.DistanceJoint:_=new this.BJSCANNON.DistanceConstraint(g,p,m.maxDistance||2);break;case x.e.SpringJoint:var y=m;_=new this.BJSCANNON.Spring(g,p,{restLength:y.length,stiffness:y.stiffness,damping:y.damping,localAnchorA:l.pivotA,localAnchorB:l.pivotB});break;case x.e.LockJoint:_=new this.BJSCANNON.LockConstraint(g,p,l);break;case x.e.PointToPointJoint:case x.e.BallAndSocketJoint:default:_=new this.BJSCANNON.PointToPointConstraint(g,l.pivotA,p,l.pivotB,l.maxForce);break}_.collideConnected=!!m.collision,d.joint.physicsJoint=_,d.joint.type!==x.e.SpringJoint?this.world.addConstraint(_):(d.joint.jointData.forceApplicationCallback=d.joint.jointData.forceApplicationCallback||function(){_.applyForce()},d.mainImpostor.registerAfterPhysicsStep(d.joint.jointData.forceApplicationCallback))}},f.prototype.removeJoint=function(d){d.joint.type!==x.e.SpringJoint?this.world.removeConstraint(d.joint.physicsJoint):d.mainImpostor.unregisterAfterPhysicsStep(d.joint.jointData.forceApplicationCallback)},f.prototype._addMaterial=function(d,g,p){var _,m;for(_=0;_<this._physicsMaterials.length;_++)if(m=this._physicsMaterials[_],m.friction===g&&m.restitution===p)return m;var l=new this.BJSCANNON.Material(d);return l.friction=g,l.restitution=p,this._physicsMaterials.push(l),l},f.prototype._checkWithEpsilon=function(d){return d<G.a.Epsilon?G.a.Epsilon:d},f.prototype._createShape=function(d){var g=d.object,p,_=d.getObjectExtendSize();switch(d.type){case O.a.SphereImpostor:var m=_.x,l=_.y,y=_.z;p=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(m),this._checkWithEpsilon(l),this._checkWithEpsilon(y))/2);break;case O.a.CylinderImpostor:var E=d.getParam("nativeOptions");E||(E={});var A=E.radiusTop!==void 0?E.radiusTop:this._checkWithEpsilon(_.x)/2,F=E.radiusBottom!==void 0?E.radiusBottom:this._checkWithEpsilon(_.x)/2,B=E.height!==void 0?E.height:this._checkWithEpsilon(_.y),L=E.numSegments!==void 0?E.numSegments:16;p=new this.BJSCANNON.Cylinder(A,F,B,L);var I=new this.BJSCANNON.Quaternion;I.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);var z=new this.BJSCANNON.Vec3(0,0,0);p.transformAllPoints(z,I);break;case O.a.BoxImpostor:var k=_.scale(.5);p=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(k.x),this._checkWithEpsilon(k.y),this._checkWithEpsilon(k.z)));break;case O.a.PlaneImpostor:S.a.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),p=new this.BJSCANNON.Plane;break;case O.a.MeshImpostor:var j=g.getVerticesData?g.getVerticesData(U.b.PositionKind):[],w=g.getIndices?g.getIndices():[];if(!j)return;var Q=g.position.clone(),W=g.rotation&&g.rotation.clone(),Y=g.rotationQuaternion&&g.rotationQuaternion.clone();g.position.copyFromFloats(0,0,0),g.rotation&&g.rotation.copyFromFloats(0,0,0),g.rotationQuaternion&&g.rotationQuaternion.copyFrom(d.getParentsRotation()),g.rotationQuaternion&&g.parent&&g.rotationQuaternion.conjugateInPlace();var he=g.computeWorldMatrix(!0),le=new Array,J;for(J=0;J<j.length;J+=3)R.e.TransformCoordinates(R.e.FromArray(j,J),he).toArray(le,J);S.a.Warn("MeshImpostor only collides against spheres."),p=new this.BJSCANNON.Trimesh(le,w),g.position.copyFrom(Q),W&&g.rotation&&g.rotation.copyFrom(W),Y&&g.rotationQuaternion&&g.rotationQuaternion.copyFrom(Y);break;case O.a.HeightmapImpostor:var Re=g.position.clone(),Me=g.rotation&&g.rotation.clone(),me=g.rotationQuaternion&&g.rotationQuaternion.clone();g.position.copyFromFloats(0,0,0),g.rotation&&g.rotation.copyFromFloats(0,0,0),g.rotationQuaternion&&g.rotationQuaternion.copyFrom(d.getParentsRotation()),g.rotationQuaternion&&g.parent&&g.rotationQuaternion.conjugateInPlace(),g.rotationQuaternion&&g.rotationQuaternion.multiplyInPlace(this._minus90X),p=this._createHeightmap(g),g.position.copyFrom(Re),Me&&g.rotation&&g.rotation.copyFrom(Me),me&&g.rotationQuaternion&&g.rotationQuaternion.copyFrom(me),g.computeWorldMatrix(!0);break;case O.a.ParticleImpostor:p=new this.BJSCANNON.Particle;break;case O.a.NoImpostor:p=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return p},f.prototype._createHeightmap=function(d,g){var p=d.getVerticesData(U.b.PositionKind),_=d.computeWorldMatrix(!0),m=new Array,l;for(l=0;l<p.length;l+=3)R.e.TransformCoordinates(R.e.FromArray(p,l),_).toArray(m,l);p=m;for(var y=new Array,E=g||~~(Math.sqrt(p.length/3)-1),A=d.getBoundingInfo(),F=Math.min(A.boundingBox.extendSizeWorld.x,A.boundingBox.extendSizeWorld.y),B=A.boundingBox.extendSizeWorld.z,L=F*2/E,I=0;I<p.length;I=I+3){var z=Math.round(p[I+0]/L+E/2),k=Math.round((p[I+1]/L-E/2)*-1),j=-p[I+2]+B;y[z]||(y[z]=[]),y[z][k]||(y[z][k]=j),y[z][k]=Math.max(j,y[z][k])}for(var z=0;z<=E;++z){if(!y[z]){for(var w=1;!y[(z+w)%E];)w++;y[z]=y[(z+w)%E].slice()}for(var k=0;k<=E;++k)if(!y[z][k]){for(var w=1,Q;Q===void 0;)Q=y[z][(k+w++)%E];y[z][k]=Q}}var W=new this.BJSCANNON.Heightfield(y,{elementSize:L});return W.minY=B,W},f.prototype._updatePhysicsBodyTransformation=function(d){var g=d.object;if(g.computeWorldMatrix&&g.computeWorldMatrix(!0),!!g.getBoundingInfo()){var p=d.getObjectCenter();this._tmpDeltaPosition.copyFrom(g.getAbsolutePivotPoint().subtract(p)),this._tmpDeltaPosition.divideInPlace(d.object.scaling),this._tmpPosition.copyFrom(p);var _=g.rotationQuaternion;if(!!_){if((d.type===O.a.PlaneImpostor||d.type===O.a.HeightmapImpostor)&&(_=_.multiply(this._minus90X),d.setDeltaRotation(this._plus90X)),d.type===O.a.HeightmapImpostor){var m=g,l=m.getBoundingInfo(),y=m.rotationQuaternion;m.rotationQuaternion=this._tmpUnityRotation,m.computeWorldMatrix(!0);var E=p.clone(),A=m.getPivotMatrix();A?A=A.clone():A=R.a.Identity();var F=R.a.Translation(l.boundingBox.extendSizeWorld.x,0,-l.boundingBox.extendSizeWorld.z);m.setPreTransformMatrix(F),m.computeWorldMatrix(!0);var B=l.boundingBox.centerWorld.subtract(p).subtract(m.position).negate();this._tmpPosition.copyFromFloats(B.x,B.y-l.boundingBox.extendSizeWorld.y,B.z),this._tmpDeltaPosition.copyFrom(l.boundingBox.centerWorld.subtract(E)),this._tmpDeltaPosition.y+=l.boundingBox.extendSizeWorld.y,m.rotationQuaternion=y,m.setPreTransformMatrix(A),m.computeWorldMatrix(!0)}else d.type===O.a.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);d.setDeltaPosition(this._tmpDeltaPosition),d.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),d.physicsBody.quaternion.set(_.x,_.y,_.z,_.w)}}},f.prototype.setTransformationFromPhysicsBody=function(d){if(d.object.position.set(d.physicsBody.position.x,d.physicsBody.position.y,d.physicsBody.position.z),d.object.rotationQuaternion){var g=d.physicsBody.quaternion;d.object.rotationQuaternion.set(g.x,g.y,g.z,g.w)}},f.prototype.setPhysicsBodyTransformation=function(d,g,p){d.physicsBody.position.set(g.x,g.y,g.z),d.physicsBody.quaternion.set(p.x,p.y,p.z,p.w)},f.prototype.isSupported=function(){return this.BJSCANNON!==void 0},f.prototype.setLinearVelocity=function(d,g){d.physicsBody.velocity.set(g.x,g.y,g.z)},f.prototype.setAngularVelocity=function(d,g){d.physicsBody.angularVelocity.set(g.x,g.y,g.z)},f.prototype.getLinearVelocity=function(d){var g=d.physicsBody.velocity;return g?new R.e(g.x,g.y,g.z):null},f.prototype.getAngularVelocity=function(d){var g=d.physicsBody.angularVelocity;return g?new R.e(g.x,g.y,g.z):null},f.prototype.setBodyMass=function(d,g){d.physicsBody.mass=g,d.physicsBody.updateMassProperties()},f.prototype.getBodyMass=function(d){return d.physicsBody.mass},f.prototype.getBodyFriction=function(d){return d.physicsBody.material.friction},f.prototype.setBodyFriction=function(d,g){d.physicsBody.material.friction=g},f.prototype.getBodyRestitution=function(d){return d.physicsBody.material.restitution},f.prototype.setBodyRestitution=function(d,g){d.physicsBody.material.restitution=g},f.prototype.sleepBody=function(d){d.physicsBody.sleep()},f.prototype.wakeUpBody=function(d){d.physicsBody.wakeUp()},f.prototype.updateDistanceJoint=function(d,g){d.physicsJoint.distance=g},f.prototype.setMotor=function(d,g,p,_){_||(d.physicsJoint.enableMotor(),d.physicsJoint.setMotorSpeed(g),p&&this.setLimit(d,p))},f.prototype.setLimit=function(d,g,p){d.physicsJoint.motorEquation.maxForce=g,d.physicsJoint.motorEquation.minForce=p===void 0?-g:p},f.prototype.syncMeshWithImpostor=function(d,g){var p=g.physicsBody;d.position.x=p.position.x,d.position.y=p.position.y,d.position.z=p.position.z,d.rotationQuaternion&&(d.rotationQuaternion.x=p.quaternion.x,d.rotationQuaternion.y=p.quaternion.y,d.rotationQuaternion.z=p.quaternion.z,d.rotationQuaternion.w=p.quaternion.w)},f.prototype.getRadius=function(d){var g=d.physicsBody.shapes[0];return g.boundingSphereRadius},f.prototype.getBoxSizeToRef=function(d,g){var p=d.physicsBody.shapes[0];g.x=p.halfExtents.x*2,g.y=p.halfExtents.y*2,g.z=p.halfExtents.z*2},f.prototype.dispose=function(){},f.prototype._extendNamespace=function(){var d=new this.BJSCANNON.Vec3,g=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(p,_,m){if(m=m||10,_=_||0,_===0)this.internalStep(p),this.time+=p;else{var l=Math.floor((this.time+_)/p)-Math.floor(this.time/p);l=Math.min(l,m)||1;for(var y=performance.now(),E=0;E!==l&&(this.internalStep(p),!(performance.now()-y>p*1e3));E++);this.time+=_;for(var A=this.time%p,F=A/p,B=d,L=this.bodies,I=0;I!==L.length;I++){var z=L[I];z.type!==g.Body.STATIC&&z.sleepState!==g.Body.SLEEPING?(z.position.vsub(z.previousPosition,B),B.scale(F,B),z.position.vadd(B,z.interpolatedPosition)):(z.interpolatedPosition.set(z.position.x,z.position.y,z.position.z),z.interpolatedQuaternion.set(z.quaternion.x,z.quaternion.y,z.quaternion.z,z.quaternion.w))}}}},f.prototype.raycast=function(d,g){return this._cannonRaycastResult.reset(),this.world.raycastClosest(d,g,{},this._cannonRaycastResult),this._raycastResult.reset(d,g),this._cannonRaycastResult.hasHit&&(this._raycastResult.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),this._raycastResult.setHitDistance(this._cannonRaycastResult.distance)),this._raycastResult},f}();G.a.DefaultPluginFactory=function(){return new h}},633:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(503),R=u(510),U=u(544),O=u(436),x=u(440),G=u(609),T=function(){function h(f,d,g){f===void 0&&(f=!0),g===void 0&&(g=OIMO),this._useDeltaForWorldStep=f,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=O.e.Zero(),this.BJSOIMO=g,this.world=new this.BJSOIMO.World({iterations:d}),this.world.clear(),this._raycastResult=new G.a}return h.prototype.setGravity=function(f){this.world.gravity.set(f.x,f.y,f.z)},h.prototype.setTimeStep=function(f){this.world.timeStep=f},h.prototype.getTimeStep=function(){return this.world.timeStep},h.prototype.executeStep=function(f,d){var g=this;d.forEach(function(l){l.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?f:this._fixedTimeStep,this.world.step(),d.forEach(function(l){l.afterStep(),g._tmpImpostorsArray[l.uniqueId]=l});for(var p=this.world.contacts;p!==null;){if(p.touching&&!p.body1.sleeping&&!p.body2.sleeping){p=p.next;continue}var _=this._tmpImpostorsArray[+p.body1.name],m=this._tmpImpostorsArray[+p.body2.name];if(!_||!m){p=p.next;continue}_.onCollide({body:m.physicsBody,point:null}),m.onCollide({body:_.physicsBody,point:null}),p=p.next}},h.prototype.applyImpulse=function(f,d,g){var p=f.physicsBody.mass;f.physicsBody.applyImpulse(g.scale(this.world.invScale),d.scale(this.world.invScale*p))},h.prototype.applyForce=function(f,d,g){x.a.Warn("Oimo doesn't support applying force. Using impule instead."),this.applyImpulse(f,d,g)},h.prototype.generatePhysicsBody=function(f){var d=this;if(f.parent){f.physicsBody&&(this.removePhysicsBody(f),f.forceUpdate());return}if(f.isBodyInitRequired()){var g={name:f.uniqueId,config:[f.getParam("mass")||.001,f.getParam("friction"),f.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:f.getParam("mass")!==0,density:f.getParam("mass"),friction:f.getParam("friction"),restitution:f.getParam("restitution"),world:this.world},p=[f],_=function(y){!y.getChildMeshes||y.getChildMeshes().forEach(function(E){E.physicsImpostor&&p.push(E.physicsImpostor)})};_(f.object);var m=function(y){return Math.max(y,U.a.Epsilon)},l=new O.b;p.forEach(function(y){if(!!y.object.rotationQuaternion){var E=y.object.rotationQuaternion;l.copyFrom(E),y.object.rotationQuaternion.set(0,0,0,1),y.object.computeWorldMatrix(!0);var A=l.toEulerAngles(),F=y.getObjectExtendSize(),B=57.29577951308232;if(y===f){var L=f.getObjectCenter();f.object.getAbsolutePivotPoint().subtractToRef(L,d._tmpPositionVector),d._tmpPositionVector.divideInPlace(f.object.scaling),g.pos.push(L.x),g.pos.push(L.y),g.pos.push(L.z),g.posShape.push(0,0,0),g.rotShape.push(0,0,0)}else{var I=y.object.position.clone();g.posShape.push(I.x),g.posShape.push(I.y),g.posShape.push(I.z),g.rotShape.push(A.x*B,A.y*B,A.z*B)}switch(y.object.rotationQuaternion.copyFrom(l),y.type){case S.a.ParticleImpostor:x.a.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case S.a.SphereImpostor:var z=F.x,k=F.y,j=F.z,w=Math.max(m(z),m(k),m(j))/2;g.type.push("sphere"),g.size.push(w),g.size.push(w),g.size.push(w);break;case S.a.CylinderImpostor:var Q=m(F.x)/2,W=m(F.y);g.type.push("cylinder"),g.size.push(Q),g.size.push(W),g.size.push(W);break;case S.a.PlaneImpostor:case S.a.BoxImpostor:default:var Q=m(F.x),W=m(F.y),Y=m(F.z);g.type.push("box"),g.size.push(Q),g.size.push(W),g.size.push(Y);break}y.object.rotationQuaternion=E}}),f.physicsBody=this.world.add(g),f.physicsBody.resetQuaternion(l),f.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);f.setDeltaPosition(this._tmpPositionVector)},h.prototype.removePhysicsBody=function(f){this.world.removeRigidBody(f.physicsBody)},h.prototype.generateJoint=function(f){var d=f.mainImpostor.physicsBody,g=f.connectedImpostor.physicsBody;if(!(!d||!g)){var p=f.joint.jointData,_=p.nativeParams||{},m,l={body1:d,body2:g,axe1:_.axe1||(p.mainAxis?p.mainAxis.asArray():null),axe2:_.axe2||(p.connectedAxis?p.connectedAxis.asArray():null),pos1:_.pos1||(p.mainPivot?p.mainPivot.asArray():null),pos2:_.pos2||(p.connectedPivot?p.connectedPivot.asArray():null),min:_.min,max:_.max,collision:_.collision||p.collision,spring:_.spring,world:this.world};switch(f.joint.type){case R.e.BallAndSocketJoint:m="jointBall";break;case R.e.SpringJoint:x.a.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");var y=p;l.min=y.length||l.min,l.max=Math.max(l.min,l.max);case R.e.DistanceJoint:m="jointDistance",l.max=p.maxDistance;break;case R.e.PrismaticJoint:m="jointPrisme";break;case R.e.SliderJoint:m="jointSlide";break;case R.e.WheelJoint:m="jointWheel";break;case R.e.HingeJoint:default:m="jointHinge";break}l.type=m,f.joint.physicsJoint=this.world.add(l)}},h.prototype.removeJoint=function(f){try{this.world.removeJoint(f.joint.physicsJoint)}catch(d){x.a.Warn(d)}},h.prototype.isSupported=function(){return this.BJSOIMO!==void 0},h.prototype.setTransformationFromPhysicsBody=function(f){if(!f.physicsBody.sleeping){if(f.physicsBody.shapes.next){for(var d=f.physicsBody.shapes;d.next;)d=d.next;f.object.position.set(d.position.x,d.position.y,d.position.z)}else{var g=f.physicsBody.getPosition();f.object.position.set(g.x,g.y,g.z)}if(f.object.rotationQuaternion){var p=f.physicsBody.getQuaternion();f.object.rotationQuaternion.set(p.x,p.y,p.z,p.w)}}},h.prototype.setPhysicsBodyTransformation=function(f,d,g){var p=f.physicsBody;f.physicsBody.shapes.next||(p.position.set(d.x,d.y,d.z),p.orientation.set(g.x,g.y,g.z,g.w),p.syncShapes(),p.awake())},h.prototype.setLinearVelocity=function(f,d){f.physicsBody.linearVelocity.set(d.x,d.y,d.z)},h.prototype.setAngularVelocity=function(f,d){f.physicsBody.angularVelocity.set(d.x,d.y,d.z)},h.prototype.getLinearVelocity=function(f){var d=f.physicsBody.linearVelocity;return d?new O.e(d.x,d.y,d.z):null},h.prototype.getAngularVelocity=function(f){var d=f.physicsBody.angularVelocity;return d?new O.e(d.x,d.y,d.z):null},h.prototype.setBodyMass=function(f,d){var g=d===0;f.physicsBody.shapes.density=g?1:d,f.physicsBody.setupMass(g?2:1)},h.prototype.getBodyMass=function(f){return f.physicsBody.shapes.density},h.prototype.getBodyFriction=function(f){return f.physicsBody.shapes.friction},h.prototype.setBodyFriction=function(f,d){f.physicsBody.shapes.friction=d},h.prototype.getBodyRestitution=function(f){return f.physicsBody.shapes.restitution},h.prototype.setBodyRestitution=function(f,d){f.physicsBody.shapes.restitution=d},h.prototype.sleepBody=function(f){f.physicsBody.sleep()},h.prototype.wakeUpBody=function(f){f.physicsBody.awake()},h.prototype.updateDistanceJoint=function(f,d,g){f.physicsJoint.limitMotor.upperLimit=d,g!==void 0&&(f.physicsJoint.limitMotor.lowerLimit=g)},h.prototype.setMotor=function(f,d,g,p){g!==void 0?x.a.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):g=1e6,d*=-1;var _=p?f.physicsJoint.rotationalLimitMotor2:f.physicsJoint.rotationalLimitMotor1||f.physicsJoint.rotationalLimitMotor||f.physicsJoint.limitMotor;_&&_.setMotor(d,g)},h.prototype.setLimit=function(f,d,g,p){var _=p?f.physicsJoint.rotationalLimitMotor2:f.physicsJoint.rotationalLimitMotor1||f.physicsJoint.rotationalLimitMotor||f.physicsJoint.limitMotor;_&&_.setLimit(d,g===void 0?-d:g)},h.prototype.syncMeshWithImpostor=function(f,d){var g=d.physicsBody;f.position.x=g.position.x,f.position.y=g.position.y,f.position.z=g.position.z,f.rotationQuaternion&&(f.rotationQuaternion.x=g.orientation.x,f.rotationQuaternion.y=g.orientation.y,f.rotationQuaternion.z=g.orientation.z,f.rotationQuaternion.w=g.orientation.s)},h.prototype.getRadius=function(f){return f.physicsBody.shapes.radius},h.prototype.getBoxSizeToRef=function(f,d){var g=f.physicsBody.shapes;d.x=g.halfWidth*2,d.y=g.halfHeight*2,d.z=g.halfDepth*2},h.prototype.dispose=function(){this.world.clear()},h.prototype.raycast=function(f,d){return x.a.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(f,d),this._raycastResult},h}()},634:function(we,P,u){"use strict";u.d(P,"a",function(){return p});var S=u(436),R=u(440),U=u(503),O=u(510),x=u(447),G=u(485),T=u(617),h=u(493),f=u(609),d=u(450),g=u(515),p=function(){function _(m,l,y){var E=this;if(m===void 0&&(m=!0),l===void 0&&(l=Ammo),y===void 0&&(y=null),this._useDeltaForWorldStep=m,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new S.b,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new S.e,this._tmpMatrix=new S.a,typeof l=="function"){R.a.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=l;if(!this.isSupported()){R.a.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=y||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=function(A,F,B,L){A=E.bjsAMMO.wrapPointer(A,Ammo.btManifoldPoint);var I=A.getPositionWorldOnA();E._tmpContactPoint.x=I.x(),E._tmpContactPoint.y=I.y(),E._tmpContactPoint.z=I.z(),E._tmpContactCallbackResult=!0},this._raycastResult=new f.a,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}return _.prototype.setGravity=function(m){this._tmpAmmoVectorA.setValue(m.x,m.y,m.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)},_.prototype.setTimeStep=function(m){this._timeStep=m},_.prototype.setFixedTimeStep=function(m){this._fixedTimeStep=m},_.prototype.setMaxSteps=function(m){this._maxSteps=m},_.prototype.getTimeStep=function(){return this._timeStep},_.prototype._isImpostorInContact=function(m){return this._tmpContactCallbackResult=!1,this.world.contactTest(m.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},_.prototype._isImpostorPairInContact=function(m,l){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(m.physicsBody,l.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},_.prototype._stepSimulation=function(m,l,y){if(m===void 0&&(m=1/60),l===void 0&&(l=10),y===void 0&&(y=1/60),l==0)this.world.stepSimulation(m,0);else for(;l>0&&m>0;)m-y<y?(this.world.stepSimulation(m,0),m=0):(m-=y,this.world.stepSimulation(y,0)),l--},_.prototype.executeStep=function(m,l){for(var y=0,E=l;y<E.length;y++){var A=E[y];A.soft||A.beforeStep()}this._stepSimulation(this._useDeltaForWorldStep?m:this._timeStep,this._maxSteps,this._fixedTimeStep);for(var F=0,B=l;F<B.length;F++){var L=B[F];if(L.soft?this._afterSoftStep(L):L.afterStep(),L._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(L))for(var I=0,z=L._onPhysicsCollideCallbacks;I<z.length;I++)for(var k=z[I],j=0,w=k.otherImpostors;j<w.length;j++){var Q=w[j];(L.physicsBody.isActive()||Q.physicsBody.isActive())&&this._isImpostorPairInContact(L,Q)&&(L.onCollide({body:Q.physicsBody,point:this._tmpContactPoint}),Q.onCollide({body:L.physicsBody,point:this._tmpContactPoint}))}}},_.prototype._afterSoftStep=function(m){m.type===U.a.RopeImpostor?this._ropeStep(m):this._softbodyOrClothStep(m)},_.prototype._ropeStep=function(m){for(var l=m.physicsBody.get_m_nodes(),y=l.size(),E,A,F,B,L,I=new Array,z=0;z<y;z++)E=l.at(z),A=E.get_m_x(),F=A.x(),B=A.y(),L=A.z(),I.push(new S.e(F,B,L));var k=m.object,j=m.getParam("shape");m._isFromLine?m.object=h.a.CreateLines("lines",{points:I,instance:k}):m.object=T.a.ExtrudeShape("ext",{shape:j,path:I,instance:k})},_.prototype._softbodyOrClothStep=function(m){var l=m.type===U.a.ClothImpostor?1:-1,y=m.object,E=y.getVerticesData(x.b.PositionKind);E||(E=[]);var A=y.getVerticesData(x.b.NormalKind);A||(A=[]);for(var F=E.length/3,B=m.physicsBody.get_m_nodes(),L,I,z,k,j,w,Q,W,Y,he=0;he<F;he++){L=B.at(he),I=L.get_m_x(),k=I.x(),j=I.y(),w=I.z()*l;var z=L.get_m_n();Q=z.x(),W=z.y(),Y=z.z()*l,E[3*he]=k,E[3*he+1]=j,E[3*he+2]=w,A[3*he]=Q,A[3*he+1]=W,A[3*he+2]=Y}var le=new G.a;le.positions=E,le.normals=A,le.uvs=y.getVerticesData(x.b.UVKind),le.colors=y.getVerticesData(x.b.ColorKind),y&&y.getIndices&&(le.indices=y.getIndices()),le.applyToMesh(y)},_.prototype.applyImpulse=function(m,l,y){if(m.soft)R.a.Warn("Cannot be applied to a soft body");else{m.physicsBody.activate();var E=this._tmpAmmoVectorA,A=this._tmpAmmoVectorB;m.object&&m.object.getWorldMatrix&&y.subtractInPlace(m.object.getWorldMatrix().getTranslation()),E.setValue(y.x,y.y,y.z),A.setValue(l.x,l.y,l.z),m.physicsBody.applyImpulse(A,E)}},_.prototype.applyForce=function(m,l,y){if(m.soft)R.a.Warn("Cannot be applied to a soft body");else{m.physicsBody.activate();var E=this._tmpAmmoVectorA,A=this._tmpAmmoVectorB;if(E.setValue(y.x,y.y,y.z),m.object&&m.object.getWorldMatrix){var F=m.object.getWorldMatrix().getTranslation();E.x-=F.x,E.y-=F.y,E.z-=F.z}A.setValue(l.x,l.y,l.z),m.physicsBody.applyForce(A,E)}},_.prototype.generatePhysicsBody=function(m){if(m._pluginData.toDispose=[],m.parent){m.physicsBody&&(this.removePhysicsBody(m),m.forceUpdate());return}if(m.isBodyInitRequired()){var l=this._createShape(m),y=m.getParam("mass");if(m._pluginData.mass=y,m.soft)l.get_m_cfg().set_collisions(17),l.get_m_cfg().set_kDP(m.getParam("damping")),this.bjsAMMO.castObject(l,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(m.getParam("margin")),l.setActivationState(_.DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(l,1,-1),m.physicsBody=l,m._pluginData.toDispose.push(l),this.setBodyPressure(m,0),m.type===U.a.SoftbodyImpostor&&this.setBodyPressure(m,m.getParam("pressure")),this.setBodyStiffness(m,m.getParam("stiffness")),this.setBodyVelocityIterations(m,m.getParam("velocityIterations")),this.setBodyPositionIterations(m,m.getParam("positionIterations"));else{var E=new this.bjsAMMO.btVector3(0,0,0),A=new this.bjsAMMO.btTransform;A.setIdentity(),y!==0&&l.calculateLocalInertia(y,E),this._tmpAmmoVectorA.setValue(m.object.position.x,m.object.position.y,m.object.position.z),this._tmpAmmoQuaternion.setValue(m.object.rotationQuaternion.x,m.object.rotationQuaternion.y,m.object.rotationQuaternion.z,m.object.rotationQuaternion.w),A.setOrigin(this._tmpAmmoVectorA),A.setRotation(this._tmpAmmoQuaternion);var F=new this.bjsAMMO.btDefaultMotionState(A),B=new this.bjsAMMO.btRigidBodyConstructionInfo(y,F,l,E),L=new this.bjsAMMO.btRigidBody(B);y===0&&(L.setCollisionFlags(L.getCollisionFlags()|_.KINEMATIC_FLAG),L.setActivationState(_.DISABLE_DEACTIVATION_FLAG)),m.type==U.a.NoImpostor&&!l.getChildShape&&L.setCollisionFlags(L.getCollisionFlags()|_.DISABLE_COLLISION_FLAG);var I=m.getParam("group"),z=m.getParam("mask");I&&z?this.world.addRigidBody(L,I,z):this.world.addRigidBody(L),m.physicsBody=L,m._pluginData.toDispose=m._pluginData.toDispose.concat([L,B,F,A,E,l])}this.setBodyRestitution(m,m.getParam("restitution")),this.setBodyFriction(m,m.getParam("friction"))}},_.prototype.removePhysicsBody=function(m){var l=this;this.world&&(m.soft?this.world.removeSoftBody(m.physicsBody):this.world.removeRigidBody(m.physicsBody),m._pluginData&&(m._pluginData.toDispose.forEach(function(y){l.bjsAMMO.destroy(y)}),m._pluginData.toDispose=[]))},_.prototype.generateJoint=function(m){var l=m.mainImpostor.physicsBody,y=m.connectedImpostor.physicsBody;if(!(!l||!y)){var E=m.joint.jointData;E.mainPivot||(E.mainPivot=new S.e(0,0,0)),E.connectedPivot||(E.connectedPivot=new S.e(0,0,0));var A;switch(m.joint.type){case O.e.DistanceJoint:var F=E.maxDistance;F&&(E.mainPivot=new S.e(0,-F/2,0),E.connectedPivot=new S.e(0,F/2,0)),A=new this.bjsAMMO.btPoint2PointConstraint(l,y,new this.bjsAMMO.btVector3(E.mainPivot.x,E.mainPivot.y,E.mainPivot.z),new this.bjsAMMO.btVector3(E.connectedPivot.x,E.connectedPivot.y,E.connectedPivot.z));break;case O.e.HingeJoint:E.mainAxis||(E.mainAxis=new S.e(0,0,0)),E.connectedAxis||(E.connectedAxis=new S.e(0,0,0));var B=new this.bjsAMMO.btVector3(E.mainAxis.x,E.mainAxis.y,E.mainAxis.z),L=new this.bjsAMMO.btVector3(E.connectedAxis.x,E.connectedAxis.y,E.connectedAxis.z);A=new this.bjsAMMO.btHingeConstraint(l,y,new this.bjsAMMO.btVector3(E.mainPivot.x,E.mainPivot.y,E.mainPivot.z),new this.bjsAMMO.btVector3(E.connectedPivot.x,E.connectedPivot.y,E.connectedPivot.z),B,L);break;case O.e.BallAndSocketJoint:A=new this.bjsAMMO.btPoint2PointConstraint(l,y,new this.bjsAMMO.btVector3(E.mainPivot.x,E.mainPivot.y,E.mainPivot.z),new this.bjsAMMO.btVector3(E.connectedPivot.x,E.connectedPivot.y,E.connectedPivot.z));break;default:R.a.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),A=new this.bjsAMMO.btPoint2PointConstraint(l,y,new this.bjsAMMO.btVector3(E.mainPivot.x,E.mainPivot.y,E.mainPivot.z),new this.bjsAMMO.btVector3(E.connectedPivot.x,E.connectedPivot.y,E.connectedPivot.z));break}this.world.addConstraint(A,!m.joint.jointData.collision),m.joint.physicsJoint=A}},_.prototype.removeJoint=function(m){this.world&&this.world.removeConstraint(m.joint.physicsJoint)},_.prototype._addMeshVerts=function(m,l,y){var E=this,A=0;if(y&&y.getIndices&&y.getWorldMatrix&&y.getChildMeshes){var F=y.getIndices();F||(F=[]);var B=y.getVerticesData(x.b.PositionKind);B||(B=[]),y.computeWorldMatrix(!1);for(var L=F.length/3,I=0;I<L;I++){for(var z=[],k=0;k<3;k++){var j=new S.e(B[F[I*3+k]*3+0],B[F[I*3+k]*3+1],B[F[I*3+k]*3+2]);S.a.ScalingToRef(y.scaling.x,y.scaling.y,y.scaling.z,this._tmpMatrix),j=S.e.TransformCoordinates(j,this._tmpMatrix);var w;k==0?w=this._tmpAmmoVectorA:k==1?w=this._tmpAmmoVectorB:w=this._tmpAmmoVectorC,w.setValue(j.x,j.y,j.z),z.push(w)}m.addTriangle(z[0],z[1],z[2]),A++}y.getChildMeshes().forEach(function(Q){A+=E._addMeshVerts(m,l,Q)})}return A},_.prototype._softVertexData=function(m){var l=m.object;if(l&&l.getIndices&&l.getWorldMatrix&&l.getChildMeshes){var y=l.getIndices();y||(y=[]);var E=l.getVerticesData(x.b.PositionKind);E||(E=[]);var A=l.getVerticesData(x.b.NormalKind);A||(A=[]),l.computeWorldMatrix(!1);for(var F=[],B=[],L=0;L<E.length;L+=3){var I=new S.e(E[L],E[L+1],E[L+2]),z=new S.e(A[L],A[L+1],A[L+2]);I=S.e.TransformCoordinates(I,l.getWorldMatrix()),z=S.e.TransformNormal(z,l.getWorldMatrix()),F.push(I.x,I.y,I.z),B.push(z.x,z.y,z.z)}var k=new G.a;return k.positions=F,k.normals=B,k.uvs=l.getVerticesData(x.b.UVKind),k.colors=l.getVerticesData(x.b.ColorKind),l&&l.getIndices&&(k.indices=l.getIndices()),k.applyToMesh(l),l.position=S.e.Zero(),l.rotationQuaternion=null,l.rotation=S.e.Zero(),l.computeWorldMatrix(!0),k}return G.a.ExtractFromMesh(l)},_.prototype._createSoftbody=function(m){var l=m.object;if(l&&l.getIndices){var y=l.getIndices();y||(y=[]);var E=this._softVertexData(m),A=E.positions,F=E.normals;if(A===null||F===null)return new this.bjsAMMO.btCompoundShape;for(var B=[],L=[],I=0;I<A.length;I+=3){var z=new S.e(A[I],A[I+1],A[I+2]),k=new S.e(F[I],F[I+1],F[I+2]);B.push(z.x,z.y,-z.z),L.push(k.x,k.y,-k.z)}for(var j=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),B,l.getIndices(),y.length/3,!0),w=A.length/3,Q=j.get_m_nodes(),W,Y,I=0;I<w;I++){W=Q.at(I);var Y=W.get_m_n();Y.setX(L[3*I]),Y.setY(L[3*I+1]),Y.setZ(L[3*I+2])}return j}},_.prototype._createCloth=function(m){var l=m.object;if(l&&l.getIndices){var y=l.getIndices();y||(y=[]);var E=this._softVertexData(m),A=E.positions,F=E.normals;if(A===null||F===null)return new this.bjsAMMO.btCompoundShape;var B=A.length,L=Math.sqrt(B/3);m.segments=L;var I=L-1;this._tmpAmmoVectorA.setValue(A[0],A[1],A[2]),this._tmpAmmoVectorB.setValue(A[3*I],A[3*I+1],A[3*I+2]),this._tmpAmmoVectorD.setValue(A[B-3],A[B-2],A[B-1]),this._tmpAmmoVectorC.setValue(A[B-3-3*I],A[B-2-3*I],A[B-1-3*I]);var z=new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,L,L,m.getParam("fixedPoints"),!0);return z}},_.prototype._createRope=function(m){var l,y,E=this._softVertexData(m),A=E.positions,F=E.normals;if(A===null||F===null)return new this.bjsAMMO.btCompoundShape;E.applyToMesh(m.object,!0),m._isFromLine=!0;var B=F.map(function(Q){return Q*Q}),L=function(Q,W){return Q+W},I=B.reduce(L);if(I===0)l=A.length,y=l/3-1,this._tmpAmmoVectorA.setValue(A[0],A[1],A[2]),this._tmpAmmoVectorB.setValue(A[l-3],A[l-2],A[l-1]);else{m._isFromLine=!1;var z=m.getParam("path"),k=m.getParam("shape");if(k===null)return R.a.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;l=z.length,y=l-1,this._tmpAmmoVectorA.setValue(z[0].x,z[0].y,z[0].z),this._tmpAmmoVectorB.setValue(z[l-1].x,z[l-1].y,z[l-1].z)}m.segments=y;var j=m.getParam("fixedPoints");j=j>3?3:j;var w=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,y-1,j);return w.get_m_cfg().set_collisions(17),w},_.prototype._createCustom=function(m){var l=null;return this.onCreateCustomShape&&(l=this.onCreateCustomShape(m)),l==null&&(l=new this.bjsAMMO.btCompoundShape),l},_.prototype._addHullVerts=function(m,l,y){var E=this,A=0;if(y&&y.getIndices&&y.getWorldMatrix&&y.getChildMeshes){var F=y.getIndices();F||(F=[]);var B=y.getVerticesData(x.b.PositionKind);B||(B=[]),y.computeWorldMatrix(!1);for(var L=F.length/3,I=0;I<L;I++){for(var z=[],k=0;k<3;k++){var j=new S.e(B[F[I*3+k]*3+0],B[F[I*3+k]*3+1],B[F[I*3+k]*3+2]);S.a.ScalingToRef(y.scaling.x,y.scaling.y,y.scaling.z,this._tmpMatrix),j=S.e.TransformCoordinates(j,this._tmpMatrix);var w;k==0?w=this._tmpAmmoVectorA:k==1?w=this._tmpAmmoVectorB:w=this._tmpAmmoVectorC,w.setValue(j.x,j.y,j.z),z.push(w)}m.addPoint(z[0],!0),m.addPoint(z[1],!0),m.addPoint(z[2],!0),A++}y.getChildMeshes().forEach(function(Q){A+=E._addHullVerts(m,l,Q)})}return A},_.prototype._createShape=function(m,l){var y=this;l===void 0&&(l=!1);var E=m.object,A,F=m.getObjectExtendSize();if(!l){var B=m.object.getChildMeshes?m.object.getChildMeshes(!0):[];A=new this.bjsAMMO.btCompoundShape;var L=0;if(B.forEach(function(Y){var he=Y.getPhysicsImpostor();if(he){if(he.type==U.a.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";var le=y._createShape(he),J=Y.parent.getWorldMatrix().clone(),Re=new S.e;J.decompose(Re),y._tmpAmmoTransform.getOrigin().setValue(Y.position.x*Re.x,Y.position.y*Re.y,Y.position.z*Re.z),y._tmpAmmoQuaternion.setValue(Y.rotationQuaternion.x,Y.rotationQuaternion.y,Y.rotationQuaternion.z,Y.rotationQuaternion.w),y._tmpAmmoTransform.setRotation(y._tmpAmmoQuaternion),A.addChildShape(y._tmpAmmoTransform,le),he.dispose(),L++}}),L>0){if(m.type!=U.a.NoImpostor){var I=this._createShape(m,!0);I&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),A.addChildShape(this._tmpAmmoTransform,I))}return A}else this.bjsAMMO.destroy(A),A=null}switch(m.type){case U.a.SphereImpostor:if(d.a.WithinEpsilon(F.x,F.y,1e-4)&&d.a.WithinEpsilon(F.x,F.z,1e-4))A=new this.bjsAMMO.btSphereShape(F.x/2);else{var z=[new this.bjsAMMO.btVector3(0,0,0)],k=[1];A=new this.bjsAMMO.btMultiSphereShape(z,k,1),A.setLocalScaling(new this.bjsAMMO.btVector3(F.x/2,F.y/2,F.z/2))}break;case U.a.CapsuleImpostor:var j=F.x/2;A=new this.bjsAMMO.btCapsuleShape(j,F.y-j*2);break;case U.a.CylinderImpostor:this._tmpAmmoVectorA.setValue(F.x/2,F.y/2,F.z/2),A=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case U.a.PlaneImpostor:case U.a.BoxImpostor:this._tmpAmmoVectorA.setValue(F.x/2,F.y/2,F.z/2),A=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case U.a.MeshImpostor:if(m.getParam("mass")==0){var w=new this.bjsAMMO.btTriangleMesh;m._pluginData.toDispose.push(w);var W=this._addMeshVerts(w,E,E);W==0?A=new this.bjsAMMO.btCompoundShape:A=new this.bjsAMMO.btBvhTriangleMeshShape(w);break}case U.a.ConvexHullImpostor:var Q=new this.bjsAMMO.btConvexHullShape,W=this._addHullVerts(Q,E,E);W==0?(m._pluginData.toDispose.push(Q),A=new this.bjsAMMO.btCompoundShape):A=Q;break;case U.a.NoImpostor:A=new this.bjsAMMO.btSphereShape(F.x/2);break;case U.a.CustomImpostor:A=this._createCustom(m);break;case U.a.SoftbodyImpostor:A=this._createSoftbody(m);break;case U.a.ClothImpostor:A=this._createCloth(m);break;case U.a.RopeImpostor:A=this._createRope(m);break;default:R.a.Warn("The impostor type is not currently supported by the ammo plugin.");break}return A},_.prototype.setTransformationFromPhysicsBody=function(m){m.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),m.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),m.object.rotationQuaternion?m.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):m.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(m.object.rotation))},_.prototype.setPhysicsBodyTransformation=function(m,l,y){var E=m.physicsBody.getWorldTransform();if(Math.abs(E.getOrigin().x()-l.x)>g.a||Math.abs(E.getOrigin().y()-l.y)>g.a||Math.abs(E.getOrigin().z()-l.z)>g.a||Math.abs(E.getRotation().x()-y.x)>g.a||Math.abs(E.getRotation().y()-y.y)>g.a||Math.abs(E.getRotation().z()-y.z)>g.a||Math.abs(E.getRotation().w()-y.w)>g.a)if(this._tmpAmmoVectorA.setValue(l.x,l.y,l.z),E.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(y.x,y.y,y.z,y.w),E.setRotation(this._tmpAmmoQuaternion),m.physicsBody.setWorldTransform(E),m.mass==0){var A=m.physicsBody.getMotionState();A&&A.setWorldTransform(E)}else m.physicsBody.activate()},_.prototype.isSupported=function(){return this.bjsAMMO!==void 0},_.prototype.setLinearVelocity=function(m,l){this._tmpAmmoVectorA.setValue(l.x,l.y,l.z),m.soft?m.physicsBody.linearVelocity(this._tmpAmmoVectorA):m.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)},_.prototype.setAngularVelocity=function(m,l){this._tmpAmmoVectorA.setValue(l.x,l.y,l.z),m.soft?m.physicsBody.angularVelocity(this._tmpAmmoVectorA):m.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)},_.prototype.getLinearVelocity=function(m){if(m.soft)var l=m.physicsBody.linearVelocity();else var l=m.physicsBody.getLinearVelocity();if(!l)return null;var y=new S.e(l.x(),l.y(),l.z());return this.bjsAMMO.destroy(l),y},_.prototype.getAngularVelocity=function(m){if(m.soft)var l=m.physicsBody.angularVelocity();else var l=m.physicsBody.getAngularVelocity();if(!l)return null;var y=new S.e(l.x(),l.y(),l.z());return this.bjsAMMO.destroy(l),y},_.prototype.setBodyMass=function(m,l){m.soft?m.physicsBody.setTotalMass(l,!1):m.physicsBody.setMassProps(l),m._pluginData.mass=l},_.prototype.getBodyMass=function(m){return m._pluginData.mass||0},_.prototype.getBodyFriction=function(m){return m._pluginData.friction||0},_.prototype.setBodyFriction=function(m,l){m.soft?m.physicsBody.get_m_cfg().set_kDF(l):m.physicsBody.setFriction(l),m._pluginData.friction=l},_.prototype.getBodyRestitution=function(m){return m._pluginData.restitution||0},_.prototype.setBodyRestitution=function(m,l){m.physicsBody.setRestitution(l),m._pluginData.restitution=l},_.prototype.getBodyPressure=function(m){return m.soft?m._pluginData.pressure||0:(R.a.Warn("Pressure is not a property of a rigid body"),0)},_.prototype.setBodyPressure=function(m,l){m.soft?m.type===U.a.SoftbodyImpostor?(m.physicsBody.get_m_cfg().set_kPR(l),m._pluginData.pressure=l):(m.physicsBody.get_m_cfg().set_kPR(0),m._pluginData.pressure=0):R.a.Warn("Pressure can only be applied to a softbody")},_.prototype.getBodyStiffness=function(m){return m.soft?m._pluginData.stiffness||0:(R.a.Warn("Stiffness is not a property of a rigid body"),0)},_.prototype.setBodyStiffness=function(m,l){m.soft?(l=l<0?0:l,l=l>1?1:l,m.physicsBody.get_m_materials().at(0).set_m_kLST(l),m._pluginData.stiffness=l):R.a.Warn("Stiffness cannot be applied to a rigid body")},_.prototype.getBodyVelocityIterations=function(m){return m.soft?m._pluginData.velocityIterations||0:(R.a.Warn("Velocity iterations is not a property of a rigid body"),0)},_.prototype.setBodyVelocityIterations=function(m,l){m.soft?(l=l<0?0:l,m.physicsBody.get_m_cfg().set_viterations(l),m._pluginData.velocityIterations=l):R.a.Warn("Velocity iterations cannot be applied to a rigid body")},_.prototype.getBodyPositionIterations=function(m){return m.soft?m._pluginData.positionIterations||0:(R.a.Warn("Position iterations is not a property of a rigid body"),0)},_.prototype.setBodyPositionIterations=function(m,l){m.soft?(l=l<0?0:l,m.physicsBody.get_m_cfg().set_piterations(l),m._pluginData.positionIterations=l):R.a.Warn("Position iterations cannot be applied to a rigid body")},_.prototype.appendAnchor=function(m,l,y,E,A,F){A===void 0&&(A=1),F===void 0&&(F=!1);var B=m.segments,L=Math.round((B-1)*y),I=Math.round((B-1)*E),z=B-1-I,k=L+B*z;m.physicsBody.appendAnchor(k,l.physicsBody,F,A)},_.prototype.appendHook=function(m,l,y,E,A){E===void 0&&(E=1),A===void 0&&(A=!1);var F=Math.round(m.segments*y);m.physicsBody.appendAnchor(F,l.physicsBody,A,E)},_.prototype.sleepBody=function(m){R.a.Warn("sleepBody is not currently supported by the Ammo physics plugin")},_.prototype.wakeUpBody=function(m){m.physicsBody.activate()},_.prototype.updateDistanceJoint=function(m,l,y){R.a.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")},_.prototype.setMotor=function(m,l,y,E){m.physicsJoint.enableAngularMotor(!0,l,y)},_.prototype.setLimit=function(m,l,y){R.a.Warn("setLimit is not currently supported by the Ammo physics plugin")},_.prototype.syncMeshWithImpostor=function(m,l){var y=l.physicsBody;y.getMotionState().getWorldTransform(this._tmpAmmoTransform),m.position.x=this._tmpAmmoTransform.getOrigin().x(),m.position.y=this._tmpAmmoTransform.getOrigin().y(),m.position.z=this._tmpAmmoTransform.getOrigin().z(),m.rotationQuaternion&&(m.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),m.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),m.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),m.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())},_.prototype.getRadius=function(m){var l=m.getObjectExtendSize();return l.x/2},_.prototype.getBoxSizeToRef=function(m,l){var y=m.getObjectExtendSize();l.x=y.x,l.y=y.y,l.z=y.z},_.prototype.dispose=function(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null},_.prototype.raycast=function(m,l){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(m.x,m.y,m.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(l.x,l.y,l.z);var y=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);return this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,y),this._raycastResult.reset(m,l),y.hasHit()&&(this._raycastResult.setHitData({x:y.get_m_hitNormalWorld().x(),y:y.get_m_hitNormalWorld().y(),z:y.get_m_hitNormalWorld().z()},{x:y.get_m_hitPointWorld().x(),y:y.get_m_hitPointWorld().y(),z:y.get_m_hitPointWorld().z()}),this._raycastResult.calculateHitDistance()),this.bjsAMMO.destroy(y),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB),this._raycastResult},_.DISABLE_COLLISION_FLAG=4,_.KINEMATIC_FLAG=2,_.DISABLE_DEACTIVATION_FLAG=4,_}()},635:function(we,P,u){"use strict";u.d(P,"a",function(){return G});var S=u(434),R=u(439),U=u(458),O=u(436),x=u(468);x.a.prototype.removeReflectionProbe=function(T){if(!this.reflectionProbes)return-1;var h=this.reflectionProbes.indexOf(T);return h!==-1&&this.reflectionProbes.splice(h,1),h},x.a.prototype.addReflectionProbe=function(T){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(T)};var G=function(){function T(h,f,d,g,p,_){var m=this;g===void 0&&(g=!0),p===void 0&&(p=!1),_===void 0&&(_=!1),this.name=h,this._viewMatrix=O.a.Identity(),this._target=O.e.Zero(),this._add=O.e.Zero(),this._invertYAxis=!1,this.position=O.e.Zero(),this._scene=d,this._scene.reflectionProbes||(this._scene.reflectionProbes=new Array),this._scene.reflectionProbes.push(this);var l=0;if(p){var y=this._scene.getEngine().getCaps();y.textureHalfFloatRender?l=2:y.textureFloatRender&&(l=1)}this._renderTargetTexture=new U.a(h,f,d,g,!0,l,!0),this._renderTargetTexture.gammaSpace=!_,this._renderTargetTexture.onBeforeRenderObservable.add(function(A){switch(A){case 0:m._add.copyFromFloats(1,0,0);break;case 1:m._add.copyFromFloats(-1,0,0);break;case 2:m._add.copyFromFloats(0,m._invertYAxis?1:-1,0);break;case 3:m._add.copyFromFloats(0,m._invertYAxis?-1:1,0);break;case 4:m._add.copyFromFloats(0,0,d.useRightHandedSystem?-1:1);break;case 5:m._add.copyFromFloats(0,0,d.useRightHandedSystem?1:-1);break}m._attachedMesh&&m.position.copyFrom(m._attachedMesh.getAbsolutePosition()),m.position.addToRef(m._add,m._target),d.useRightHandedSystem?(O.a.LookAtRHToRef(m.position,m._target,O.e.Up(),m._viewMatrix),d.activeCamera&&(m._projectionMatrix=O.a.PerspectiveFovRH(Math.PI/2,1,d.activeCamera.minZ,d.activeCamera.maxZ),d.setTransformMatrix(m._viewMatrix,m._projectionMatrix))):(O.a.LookAtLHToRef(m.position,m._target,O.e.Up(),m._viewMatrix),d.activeCamera&&(m._projectionMatrix=O.a.PerspectiveFovLH(Math.PI/2,1,d.activeCamera.minZ,d.activeCamera.maxZ),d.setTransformMatrix(m._viewMatrix,m._projectionMatrix))),d._forcedViewPosition=m.position});var E;this._renderTargetTexture.onBeforeBindObservable.add(function(){d.getEngine()._debugPushGroup("reflection probe generation for "+h,1),E=m._scene.imageProcessingConfiguration.applyByPostProcess,_&&(d.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(function(){d.imageProcessingConfiguration.applyByPostProcess=E,d._forcedViewPosition=null,d.updateTransformMatrix(!0),d.getEngine()._debugPopGroup(1)})}return Object.defineProperty(T.prototype,"samples",{get:function(){return this._renderTargetTexture.samples},set:function(h){this._renderTargetTexture.samples=h},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"refreshRate",{get:function(){return this._renderTargetTexture.refreshRate},set:function(h){this._renderTargetTexture.refreshRate=h},enumerable:!1,configurable:!0}),T.prototype.getScene=function(){return this._scene},Object.defineProperty(T.prototype,"cubeTexture",{get:function(){return this._renderTargetTexture},enumerable:!1,configurable:!0}),Object.defineProperty(T.prototype,"renderList",{get:function(){return this._renderTargetTexture.renderList},enumerable:!1,configurable:!0}),T.prototype.attachToMesh=function(h){this._attachedMesh=h},T.prototype.setRenderingAutoClearDepthStencil=function(h,f){this._renderTargetTexture.setRenderingAutoClearDepthStencil(h,f)},T.prototype.dispose=function(){var h=this._scene.reflectionProbes.indexOf(this);h!==-1&&this._scene.reflectionProbes.splice(h,1),this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null)},T.prototype.toString=function(h){var f="Name: "+this.name;return h&&(f+=", position: "+this.position.toString(),this._attachedMesh&&(f+=", attached mesh: "+this._attachedMesh.name)),f},T.prototype.getClassName=function(){return"ReflectionProbe"},T.prototype.serialize=function(){var h=R.a.Serialize(this,this._renderTargetTexture.serialize());return h.isReflectionProbe=!0,h},T.Parse=function(h,f,d){var g=null;if(f.reflectionProbes)for(var p=0;p<f.reflectionProbes.length;p++){var _=f.reflectionProbes[p];if(_.name===h.name){g=_;break}}return g=R.a.Parse(function(){return g||new T(h.name,h.renderTargetSize,f,h._generateMipMaps)},h,f,d),g.cubeTexture._waitingRenderList=h.renderList,h._attachedMesh&&g.attachToMesh(f.getMeshByID(h._attachedMesh)),g},Object(S.c)([Object(R.k)()],T.prototype,"_attachedMesh",void 0),Object(S.c)([Object(R.o)()],T.prototype,"position",void 0),T}()},637:function(we,P,u){"use strict";u.d(P,"a",function(){return y});var S=u(475),R=u(450),U=u(630),O=u(435),x="hdrFilteringVertexShader",G=`
attribute vec2 position;

varying vec3 direction;

uniform vec3 up;
uniform vec3 right;
uniform vec3 front;
void main(void) {
mat3 view=mat3(up,right,front);
direction=view*vec3(position,1.0);
gl_Position=vec4(position,0.0,1.0);
}`;O.a.ShadersStore[x]=G;var T={name:x,shader:G},h=u(457),f=u(605),d=u(606),g=u(607),p="hdrFilteringPixelShader",_=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;
uniform samplerCube inputTexture;
uniform vec2 vFilteringInfo;
uniform float hdrScale;
varying vec3 direction;
void main() {
vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);
gl_FragColor=vec4(color*hdrScale,1.0);
}`;O.a.ShadersStore[p]=_;var m={name:p,shader:_},l=u(440),y=function(){function E(A,F){F===void 0&&(F={}),this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=A,this.hdrScale=F.hdrScale||this.hdrScale,this.quality=F.hdrScale||this.quality}return E.prototype._createRenderTarget=function(A){var F=0;this._engine.getCaps().textureHalfFloatRender?F=2:this._engine.getCaps().textureFloatRender&&(F=1);var B=this._engine.createRenderTargetCubeTexture(A,{format:5,type:F,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(B,0,0,0),this._engine.updateTextureSamplingMode(3,B,!0),B},E.prototype._prefilterInternal=function(A){var F=A.getSize().width,B=R.a.ILog2(F)+1,L=this._effectWrapper.effect,I=this._createRenderTarget(F);this._effectRenderer.setViewport();var z=A.getInternalTexture();z&&this._engine.updateTextureSamplingMode(3,z,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);var k=[[new S.z(0,0,-1),new S.z(0,-1,0),new S.z(1,0,0)],[new S.z(0,0,1),new S.z(0,-1,0),new S.z(-1,0,0)],[new S.z(1,0,0),new S.z(0,0,1),new S.z(0,1,0)],[new S.z(1,0,0),new S.z(0,0,-1),new S.z(0,-1,0)],[new S.z(1,0,0),new S.z(0,-1,0),new S.z(0,0,1)],[new S.z(-1,0,0),new S.z(0,-1,0),new S.z(0,0,-1)]];L.setFloat("hdrScale",this.hdrScale),L.setFloat2("vFilteringInfo",A.getSize().width,B),L.setTexture("inputTexture",A);for(var j=0;j<6;j++){L.setVector3("up",k[j][0]),L.setVector3("right",k[j][1]),L.setVector3("front",k[j][2]);for(var w=0;w<B;w++){this._engine.bindFramebuffer(I,j,void 0,void 0,!0,w),this._effectRenderer.applyEffectWrapper(this._effectWrapper);var Q=Math.pow(2,(w-this._lodGenerationOffset)/this._lodGenerationScale)/F;w===0&&(Q=0),L.setFloat("alphaG",Q),this._effectRenderer.draw()}}return this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseFramebufferObjects(I),this._engine._releaseTexture(A._texture),I._swapAndDie(A._texture),A._prefiltered=!0,A},E.prototype._createEffect=function(A,F){var B=[];A.gammaSpace&&B.push("#define GAMMA_INPUT"),B.push("#define NUM_SAMPLES "+this.quality+"u");var L=new U.b({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:B,onCompiled:F});return L},E.prototype.isReady=function(A){return A.isReady()&&this._effectWrapper.effect.isReady()},E.prototype.prefilter=function(A,F){var B=this;return F===void 0&&(F=null),this._engine._features.allowTexturePrefiltering?new Promise(function(L){B._effectRenderer=new U.a(B._engine),B._effectWrapper=B._createEffect(A),B._effectWrapper.effect.executeWhenCompiled(function(){B._prefilterInternal(A),B._effectRenderer.dispose(),B._effectWrapper.dispose(),L(),F&&F()})}):(l.a.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))},E}()},638:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(444),R=u(590),U=u(438),O=u(435),x="minmaxReduxPixelShader",G=`varying vec2 vUV;
uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
float f1=texelFetch(sourceTexture,coord,0).r;
float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;
float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;
float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;
float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(MAIN)
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
vec2 f1=texelFetch(textureSampler,coord,0).rg;
vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;
vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;
vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;
float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);
float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*vec2(texSize-1));
vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;
vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;
vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;
vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;
float minz=min(f1.x,f2.x);
float maxz=max(f1.y,f2.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(LAST)
void main(void)
{
discard;
glFragColor=vec4(0.);
}
#endif
`;O.a.ShadersStore[x]=G;var T={name:x,shader:G},h=function(){function f(d){this.onAfterReductionPerformed=new U.c,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=d,this._postProcessManager=new R.a(d.getScene())}return Object.defineProperty(f.prototype,"sourceTexture",{get:function(){return this._sourceTexture},enumerable:!1,configurable:!0}),f.prototype.setSourceTexture=function(d,g,p,_){var m=this;if(p===void 0&&(p=2),_===void 0&&(_=!0),d!==this._sourceTexture){this.dispose(!1),this._sourceTexture=d,this._reductionSteps=[],this._forceFullscreenViewport=_;var l=this._camera.getScene(),y=new S.a("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,l.getEngine(),!1,"#define INITIAL"+(g?`
#define DEPTH_REDUX`:""),p,void 0,void 0,void 0,7);y.autoClear=!1,y.forceFullscreenViewport=_;var E=this._sourceTexture.getRenderWidth(),A=this._sourceTexture.getRenderHeight();y.onApply=function(I,z){return function(k){k.setTexture("sourceTexture",m._sourceTexture),k.setFloat2("texSize",I,z)}}(E,A),this._reductionSteps.push(y);for(var F=1;E>1||A>1;){E=Math.max(Math.round(E/2),1),A=Math.max(Math.round(A/2),1);var B=new S.a("Reduction phase "+F,"minmaxRedux",["texSize"],null,{width:E,height:A},null,1,l.getEngine(),!1,"#define "+(E==1&&A==1?"LAST":E==1||A==1?"ONEBEFORELAST":"MAIN"),p,void 0,void 0,void 0,7);if(B.autoClear=!1,B.forceFullscreenViewport=_,B.onApply=function(I,z){return function(k){I==1||z==1?k.setInt2("texSize",I,z):k.setFloat2("texSize",I,z)}}(E,A),this._reductionSteps.push(B),F++,E==1&&A==1){var L=function(I,z,k){var j=new Float32Array(4*I*z),w={min:0,max:0};return function(){l.getEngine()._readTexturePixels(k.inputTexture,I,z,-1,0,j,!1),w.min=j[0],w.max=j[1],m.onAfterReductionPerformed.notifyObservers(w)}};B.onAfterRenderObservable.add(L(E,A,B))}}}},Object.defineProperty(f.prototype,"refreshRate",{get:function(){return this._sourceTexture?this._sourceTexture.refreshRate:-1},set:function(d){this._sourceTexture&&(this._sourceTexture.refreshRate=d)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"activated",{get:function(){return this._activated},enumerable:!1,configurable:!0}),f.prototype.activate=function(){var d=this;this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(function(){var g=d._camera.getScene().getEngine();g._debugPushGroup("min max reduction",1),d._reductionSteps[0].activate(d._camera),d._postProcessManager.directRender(d._reductionSteps,d._reductionSteps[0].inputTexture,d._forceFullscreenViewport),g.unBindFramebuffer(d._reductionSteps[0].inputTexture,!1),g._debugPopGroup(1)}),this._activated=!0)},f.prototype.deactivate=function(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)},f.prototype.dispose=function(d){if(d===void 0&&(d=!0),d&&this.onAfterReductionPerformed.clear(),this.deactivate(),this._reductionSteps){for(var g=0;g<this._reductionSteps.length;++g)this._reductionSteps[g].dispose();this._reductionSteps=null}this._postProcessManager&&d&&this._postProcessManager.dispose(),this._sourceTexture=null},f}()},639:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(439),U=u(438),O=u(464),x=u(443),G=u(688),T=function(){function h(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new U.c,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}return h.prototype.attachControl=function(f){var d=this;f=x.b.BackCompatCameraNoPreventDefault(arguments),this._wheel=function(g){if(g.type===O.a.POINTERWHEEL){var p=g.event,_=p.deltaMode===G.b.DOM_DELTA_LINE?d._ffMultiplier:1;p.deltaY!==void 0?(d._wheelDeltaX+=d.wheelPrecisionX*_*p.deltaX/d._normalize,d._wheelDeltaY-=d.wheelPrecisionY*_*p.deltaY/d._normalize,d._wheelDeltaZ+=d.wheelPrecisionZ*_*p.deltaZ/d._normalize):p.wheelDeltaY!==void 0?(d._wheelDeltaX+=d.wheelPrecisionX*_*p.wheelDeltaX/d._normalize,d._wheelDeltaY-=d.wheelPrecisionY*_*p.wheelDeltaY/d._normalize,d._wheelDeltaZ+=d.wheelPrecisionZ*_*p.wheelDeltaZ/d._normalize):p.wheelDelta&&(d._wheelDeltaY-=d.wheelPrecisionY*p.wheelDelta/d._normalize),p.preventDefault&&(f||p.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,O.a.POINTERWHEEL)},h.prototype.detachControl=function(f){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()},h.prototype.checkInputs=function(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0},h.prototype.getClassName=function(){return"BaseCameraMouseWheelInput"},h.prototype.getSimpleName=function(){return"mousewheel"},Object(S.c)([Object(R.c)()],h.prototype,"wheelPrecisionX",void 0),Object(S.c)([Object(R.c)()],h.prototype,"wheelPrecisionY",void 0),Object(S.c)([Object(R.c)()],h.prototype,"wheelPrecisionZ",void 0),h}()},640:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(439),U=u(460),O=u(562),x=u(436),G=u(443),T=function(){function h(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this._keys=new Array}return h.prototype.attachControl=function(f){var d=this;f=G.b.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){d._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(g){var p=g.event;if(!p.metaKey){if(g.type===O.a.KEYDOWN){if(d.keysUp.indexOf(p.keyCode)!==-1||d.keysDown.indexOf(p.keyCode)!==-1||d.keysLeft.indexOf(p.keyCode)!==-1||d.keysRight.indexOf(p.keyCode)!==-1||d.keysUpward.indexOf(p.keyCode)!==-1||d.keysDownward.indexOf(p.keyCode)!==-1){var _=d._keys.indexOf(p.keyCode);_===-1&&d._keys.push(p.keyCode),f||p.preventDefault()}}else if(d.keysUp.indexOf(p.keyCode)!==-1||d.keysDown.indexOf(p.keyCode)!==-1||d.keysLeft.indexOf(p.keyCode)!==-1||d.keysRight.indexOf(p.keyCode)!==-1||d.keysUpward.indexOf(p.keyCode)!==-1||d.keysDownward.indexOf(p.keyCode)!==-1){var _=d._keys.indexOf(p.keyCode);_>=0&&d._keys.splice(_,1),f||p.preventDefault()}}}))},h.prototype.detachControl=function(f){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},h.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var f=this.camera,d=0;d<this._keys.length;d++){var g=this._keys[d],p=f._computeLocalCameraSpeed();this.keysLeft.indexOf(g)!==-1?f._localDirection.copyFromFloats(-p,0,0):this.keysUp.indexOf(g)!==-1?f._localDirection.copyFromFloats(0,0,p):this.keysRight.indexOf(g)!==-1?f._localDirection.copyFromFloats(p,0,0):this.keysDown.indexOf(g)!==-1?f._localDirection.copyFromFloats(0,0,-p):this.keysUpward.indexOf(g)!==-1?f._localDirection.copyFromFloats(0,p,0):this.keysDownward.indexOf(g)!==-1&&f._localDirection.copyFromFloats(0,-p,0),f.getScene().useRightHandedSystem&&(f._localDirection.z*=-1),f.getViewMatrix().invertToRef(f._cameraTransformMatrix),x.e.TransformNormalToRef(f._localDirection,f._cameraTransformMatrix,f._transformedDirection),f.cameraDirection.addInPlace(f._transformedDirection)}},h.prototype.getClassName=function(){return"FreeCameraKeyboardMoveInput"},h.prototype._onLostFocus=function(){this._keys=[]},h.prototype.getSimpleName=function(){return"keyboard"},Object(S.c)([Object(R.c)()],h.prototype,"keysUp",void 0),Object(S.c)([Object(R.c)()],h.prototype,"keysUpward",void 0),Object(S.c)([Object(R.c)()],h.prototype,"keysDown",void 0),Object(S.c)([Object(R.c)()],h.prototype,"keysDownward",void 0),Object(S.c)([Object(R.c)()],h.prototype,"keysLeft",void 0),Object(S.c)([Object(R.c)()],h.prototype,"keysRight",void 0),h}();U.a.FreeCameraKeyboardMoveInput=T},641:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(438),U=u(439),O=u(460),x=u(464),G=u(443),T=function(){function h(f){f===void 0&&(f=!0),this.touchEnabled=f,this.buttons=[0,1,2],this.angularSensibility=2e3,this.previousPosition=null,this.onPointerMovedObservable=new R.c,this._allowCameraRotation=!0}return h.prototype.attachControl=function(f){var d=this;f=G.b.BackCompatCameraNoPreventDefault(arguments);var g=this.camera.getEngine(),p=g.getInputElement();this._pointerInput||(this._pointerInput=function(_){var m=_.event;if(!g.isInVRExclusivePointerMode&&!(!d.touchEnabled&&m.pointerType==="touch")&&!(_.type!==x.a.POINTERMOVE&&d.buttons.indexOf(m.button)===-1)){var l=m.srcElement||m.target;if(_.type===x.a.POINTERDOWN&&l){try{l.setPointerCapture(m.pointerId)}catch(A){}d.previousPosition={x:m.clientX,y:m.clientY},f||(m.preventDefault(),p&&p.focus()),g.isPointerLock&&d._onMouseMove&&d._onMouseMove(_.event)}else if(_.type===x.a.POINTERUP&&l){try{l.releasePointerCapture(m.pointerId)}catch(A){}d.previousPosition=null,f||m.preventDefault()}else if(_.type===x.a.POINTERMOVE){if(!d.previousPosition){g.isPointerLock&&d._onMouseMove&&d._onMouseMove(_.event);return}var y=m.clientX-d.previousPosition.x,E=m.clientY-d.previousPosition.y;d.camera.getScene().useRightHandedSystem&&(y*=-1),d.camera.parent&&d.camera.parent._getWorldMatrixDeterminant()<0&&(y*=-1),d._allowCameraRotation&&(d.camera.cameraRotation.y+=y/d.angularSensibility,d.camera.cameraRotation.x+=E/d.angularSensibility),d.onPointerMovedObservable.notifyObservers({offsetX:y,offsetY:E}),d.previousPosition={x:m.clientX,y:m.clientY},f||m.preventDefault()}}}),this._onMouseMove=function(_){if(!!g.isPointerLock&&!g.isInVRExclusivePointerMode){var m=_.movementX||_.mozMovementX||_.webkitMovementX||_.msMovementX||0;d.camera.getScene().useRightHandedSystem&&(m*=-1),d.camera.parent&&d.camera.parent._getWorldMatrixDeterminant()<0&&(m*=-1),d.camera.cameraRotation.y+=m/d.angularSensibility;var l=_.movementY||_.mozMovementY||_.webkitMovementY||_.msMovementY||0;d.camera.cameraRotation.x+=l/d.angularSensibility,d.previousPosition=null,f||_.preventDefault()}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,x.a.POINTERDOWN|x.a.POINTERUP|x.a.POINTERMOVE),p&&p.addEventListener("contextmenu",this.onContextMenu.bind(this),!1)},h.prototype.onContextMenu=function(f){f.preventDefault()},h.prototype.detachControl=function(f){if(this._observer){if(this.camera.getScene().onPointerObservable.remove(this._observer),this.onContextMenu){var d=this.camera.getEngine(),g=d.getInputElement();g&&g.removeEventListener("contextmenu",this.onContextMenu)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this.previousPosition=null}},h.prototype.getClassName=function(){return"FreeCameraMouseInput"},h.prototype.getSimpleName=function(){return"mouse"},Object(S.c)([Object(U.c)()],h.prototype,"buttons",void 0),Object(S.c)([Object(U.c)()],h.prototype,"angularSensibility",void 0),h}();O.a.FreeCameraMouseInput=T},642:function(we,P,u){"use strict";u.d(P,"a",function(){return h});var S=u(434),R=u(439),U=u(460),O=u(639),x=u(436),G=u(465),T;(function(f){f[f.MoveRelative=0]="MoveRelative",f[f.RotateRelative=1]="RotateRelative",f[f.MoveScene=2]="MoveScene"})(T||(T={}));var h=function(f){Object(S.d)(d,f);function d(){var g=f!==null&&f.apply(this,arguments)||this;return g._moveRelative=x.e.Zero(),g._rotateRelative=x.e.Zero(),g._moveScene=x.e.Zero(),g._wheelXAction=T.MoveRelative,g._wheelXActionCoordinate=G.b.X,g._wheelYAction=T.MoveRelative,g._wheelYActionCoordinate=G.b.Z,g._wheelZAction=null,g._wheelZActionCoordinate=null,g}return d.prototype.getClassName=function(){return"FreeCameraMouseWheelInput"},Object.defineProperty(d.prototype,"wheelXMoveRelative",{get:function(){return this._wheelXAction!==T.MoveRelative?null:this._wheelXActionCoordinate},set:function(g){g===null&&this._wheelXAction!==T.MoveRelative||(this._wheelXAction=T.MoveRelative,this._wheelXActionCoordinate=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"wheelYMoveRelative",{get:function(){return this._wheelYAction!==T.MoveRelative?null:this._wheelYActionCoordinate},set:function(g){g===null&&this._wheelYAction!==T.MoveRelative||(this._wheelYAction=T.MoveRelative,this._wheelYActionCoordinate=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"wheelZMoveRelative",{get:function(){return this._wheelZAction!==T.MoveRelative?null:this._wheelZActionCoordinate},set:function(g){g===null&&this._wheelZAction!==T.MoveRelative||(this._wheelZAction=T.MoveRelative,this._wheelZActionCoordinate=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"wheelXRotateRelative",{get:function(){return this._wheelXAction!==T.RotateRelative?null:this._wheelXActionCoordinate},set:function(g){g===null&&this._wheelXAction!==T.RotateRelative||(this._wheelXAction=T.RotateRelative,this._wheelXActionCoordinate=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"wheelYRotateRelative",{get:function(){return this._wheelYAction!==T.RotateRelative?null:this._wheelYActionCoordinate},set:function(g){g===null&&this._wheelYAction!==T.RotateRelative||(this._wheelYAction=T.RotateRelative,this._wheelYActionCoordinate=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"wheelZRotateRelative",{get:function(){return this._wheelZAction!==T.RotateRelative?null:this._wheelZActionCoordinate},set:function(g){g===null&&this._wheelZAction!==T.RotateRelative||(this._wheelZAction=T.RotateRelative,this._wheelZActionCoordinate=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"wheelXMoveScene",{get:function(){return this._wheelXAction!==T.MoveScene?null:this._wheelXActionCoordinate},set:function(g){g===null&&this._wheelXAction!==T.MoveScene||(this._wheelXAction=T.MoveScene,this._wheelXActionCoordinate=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"wheelYMoveScene",{get:function(){return this._wheelYAction!==T.MoveScene?null:this._wheelYActionCoordinate},set:function(g){g===null&&this._wheelYAction!==T.MoveScene||(this._wheelYAction=T.MoveScene,this._wheelYActionCoordinate=g)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"wheelZMoveScene",{get:function(){return this._wheelZAction!==T.MoveScene?null:this._wheelZActionCoordinate},set:function(g){g===null&&this._wheelZAction!==T.MoveScene||(this._wheelZAction=T.MoveScene,this._wheelZActionCoordinate=g)},enumerable:!1,configurable:!0}),d.prototype.checkInputs=function(){if(!(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)){this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);var g=x.a.Zero();this.camera.getViewMatrix().invertToRef(g);var p=x.e.Zero();x.e.TransformNormalToRef(this._moveRelative,g,p),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(p),this.camera.cameraDirection.addInPlace(this._moveScene),f.prototype.checkInputs.call(this)}},d.prototype._updateCamera=function(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)},d.prototype._updateCameraProperty=function(g,p,_){if(g!==0&&!(p===null||_===null)){var m=null;switch(p){case T.MoveRelative:m=this._moveRelative;break;case T.RotateRelative:m=this._rotateRelative;break;case T.MoveScene:m=this._moveScene;break}switch(_){case G.b.X:m.set(g,0,0);break;case G.b.Y:m.set(0,g,0);break;case G.b.Z:m.set(0,0,g);break}}},Object(S.c)([Object(R.c)()],d.prototype,"wheelXMoveRelative",null),Object(S.c)([Object(R.c)()],d.prototype,"wheelYMoveRelative",null),Object(S.c)([Object(R.c)()],d.prototype,"wheelZMoveRelative",null),Object(S.c)([Object(R.c)()],d.prototype,"wheelXRotateRelative",null),Object(S.c)([Object(R.c)()],d.prototype,"wheelYRotateRelative",null),Object(S.c)([Object(R.c)()],d.prototype,"wheelZRotateRelative",null),Object(S.c)([Object(R.c)()],d.prototype,"wheelXMoveScene",null),Object(S.c)([Object(R.c)()],d.prototype,"wheelYMoveScene",null),Object(S.c)([Object(R.c)()],d.prototype,"wheelZMoveScene",null),d}(O.a);U.a.FreeCameraMouseWheelInput=h},643:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(434),R=u(439),U=u(460),O=u(464),x=u(436),G=u(443),T=function(){function h(f){f===void 0&&(f=!1),this.allowMouse=f,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array}return h.prototype.attachControl=function(f){var d=this;f=G.b.BackCompatCameraNoPreventDefault(arguments);var g=null;if(this._pointerInput===void 0&&(this._onLostFocus=function(){d._offsetX=null,d._offsetY=null},this._pointerInput=function(m){var l=m.event,y=!d.camera.getEngine().hostInformation.isMobile&&l instanceof MouseEvent;if(!(!d.allowMouse&&(l.pointerType==="mouse"||y))){if(m.type===O.a.POINTERDOWN){if(f||l.preventDefault(),d._pointerPressed.push(l.pointerId),d._pointerPressed.length!==1)return;g={x:l.clientX,y:l.clientY}}else if(m.type===O.a.POINTERUP){f||l.preventDefault();var E=d._pointerPressed.indexOf(l.pointerId);if(E===-1||(d._pointerPressed.splice(E,1),E!=0))return;g=null,d._offsetX=null,d._offsetY=null}else if(m.type===O.a.POINTERMOVE){if(f||l.preventDefault(),!g)return;var E=d._pointerPressed.indexOf(l.pointerId);if(E!=0)return;d._offsetX=l.clientX-g.x,d._offsetY=-(l.clientY-g.y)}}}),this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,O.a.POINTERDOWN|O.a.POINTERUP|O.a.POINTERMOVE),this._onLostFocus){var p=this.camera.getEngine(),_=p.getInputElement();_&&_.addEventListener("blur",this._onLostFocus)}},h.prototype.detachControl=function(f){if(this._pointerInput){if(this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null),this._onLostFocus){var d=this.camera.getEngine(),g=d.getInputElement();g&&g.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed=[],this._offsetX=null,this._offsetY=null}},h.prototype.checkInputs=function(){if(!(this._offsetX===null||this._offsetY===null)&&!(this._offsetX===0&&this._offsetY===0)){var f=this.camera;if(f.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this._pointerPressed.length>1)f.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{var d=f._computeLocalCameraSpeed(),g=new x.e(0,0,d*this._offsetY/this.touchMoveSensibility);x.a.RotationYawPitchRollToRef(f.rotation.y,f.rotation.x,0,f._cameraRotationMatrix),f.cameraDirection.addInPlace(x.e.TransformCoordinates(g,f._cameraRotationMatrix))}}},h.prototype.getClassName=function(){return"FreeCameraTouchInput"},h.prototype.getSimpleName=function(){return"touch"},Object(S.c)([Object(R.c)()],h.prototype,"touchAngularSensibility",void 0),Object(S.c)([Object(R.c)()],h.prototype,"touchMoveSensibility",void 0),h}();U.a.FreeCameraTouchInput=T},644:function(we,P,u){"use strict";var S=u(435),R=u(524),U=u(457),O=u(525),x="imageProcessingPixelShader",G=`
varying vec2 vUV;
uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
void main(void)
{
vec4 result=texture2D(textureSampler,vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE

result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else

#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;
}`;S.a.ShadersStore[x]=G;var T={name:x,shader:G}},645:function(we,P,u){"use strict";(function(S){u.d(P,"b",function(){return f}),u.d(P,"a",function(){return d});var R=u(434),U=u(440),O=u(445),x=u(595),G=u(456),T=u(563),h=u(670),f=function(){function g(){this.renderWidth=512,this.renderHeight=256,this.textureSize=512,this.deterministicLockstep=!1,this.lockstepMaxSteps=4}return g}(),d=function(g){Object(R.d)(p,g);function p(_){_===void 0&&(_=new f);var m=g.call(this,null)||this;O.a.Instances.push(m),_.deterministicLockstep===void 0&&(_.deterministicLockstep=!1),_.lockstepMaxSteps===void 0&&(_.lockstepMaxSteps=4),m._options=_,h.a.SetMatrixPrecision(!!_.useHighPrecisionMatrix),m._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:512,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!1,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:0,uintIndices:!1,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!1,instancedArrays:!1,canUseTimestampForTimerQuery:!1,maxMSAASamples:1,blendMinMax:!1,canUseGLInstanceID:!1,canUseGLVertexID:!1},m._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!1,_collectUbosUpdatedInFrame:!1},U.a.Log("Babylon.js v"+O.a.Version+" - Null engine");var l=typeof self!="undefined"?self:typeof S!="undefined"?S:window;return typeof URL=="undefined"&&(l.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob=="undefined"&&(l.Blob=function(){}),m}return p.prototype.isDeterministicLockStep=function(){return this._options.deterministicLockstep},p.prototype.getLockstepMaxSteps=function(){return this._options.lockstepMaxSteps},p.prototype.getHardwareScalingLevel=function(){return 1},p.prototype.createVertexBuffer=function(_){var m=new T.a;return m.references=1,m},p.prototype.createIndexBuffer=function(_){var m=new T.a;return m.references=1,m},p.prototype.clear=function(_,m,l,y){y===void 0&&(y=!1)},p.prototype.getRenderWidth=function(_){return _===void 0&&(_=!1),!_&&this._currentRenderTarget?this._currentRenderTarget.width:this._options.renderWidth},p.prototype.getRenderHeight=function(_){return _===void 0&&(_=!1),!_&&this._currentRenderTarget?this._currentRenderTarget.height:this._options.renderHeight},p.prototype.setViewport=function(_,m,l){this._cachedViewport=_},p.prototype.createShaderProgram=function(_,m,l,y,E){return{__SPECTOR_rebuildProgram:null}},p.prototype.getUniforms=function(_,m){return[]},p.prototype.getAttributes=function(_,m){return[]},p.prototype.bindSamplers=function(_){this._currentEffect=null},p.prototype.enableEffect=function(_){this._currentEffect=_,_.onBind&&_.onBind(_),_._onBindObservable&&_._onBindObservable.notifyObservers(_)},p.prototype.setState=function(_,m,l,y){m===void 0&&(m=0),y===void 0&&(y=!1)},p.prototype.setIntArray=function(_,m){return!0},p.prototype.setIntArray2=function(_,m){return!0},p.prototype.setIntArray3=function(_,m){return!0},p.prototype.setIntArray4=function(_,m){return!0},p.prototype.setFloatArray=function(_,m){return!0},p.prototype.setFloatArray2=function(_,m){return!0},p.prototype.setFloatArray3=function(_,m){return!0},p.prototype.setFloatArray4=function(_,m){return!0},p.prototype.setArray=function(_,m){return!0},p.prototype.setArray2=function(_,m){return!0},p.prototype.setArray3=function(_,m){return!0},p.prototype.setArray4=function(_,m){return!0},p.prototype.setMatrices=function(_,m){return!0},p.prototype.setMatrix3x3=function(_,m){return!0},p.prototype.setMatrix2x2=function(_,m){return!0},p.prototype.setFloat=function(_,m){return!0},p.prototype.setFloat2=function(_,m,l){return!0},p.prototype.setFloat3=function(_,m,l,y){return!0},p.prototype.setBool=function(_,m){return!0},p.prototype.setFloat4=function(_,m,l,y,E){return!0},p.prototype.setAlphaMode=function(_,m){m===void 0&&(m=!1),this._alphaMode!==_&&(this.alphaState.alphaBlend=_!==0,m||this.setDepthWrite(_===0),this._alphaMode=_)},p.prototype.bindBuffers=function(_,m,l){},p.prototype.wipeCaches=function(_){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,_&&(this._currentProgram=null,this.stencilState.reset(),this.depthCullingState.reset(),this.alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},p.prototype.draw=function(_,m,l,y){},p.prototype.drawElementsType=function(_,m,l,y){},p.prototype.drawArraysType=function(_,m,l,y){},p.prototype._createTexture=function(){return{}},p.prototype._releaseTexture=function(_){},p.prototype.createTexture=function(_,m,l,y,E,A,F,B,L,I,z,k){E===void 0&&(E=3),A===void 0&&(A=null),F===void 0&&(F=null),B===void 0&&(B=null),L===void 0&&(L=null),I===void 0&&(I=null),z===void 0&&(z=null);var j=new G.a(this,G.b.Url),w=String(_);return j.url=w,j.generateMipMaps=!m,j.samplingMode=E,j.invertY=l,j.baseWidth=this._options.textureSize,j.baseHeight=this._options.textureSize,j.width=this._options.textureSize,j.height=this._options.textureSize,I&&(j.format=I),j.isReady=!0,A&&A(),this._internalTexturesCache.push(j),j},p.prototype.createRenderTargetTexture=function(_,m){var l=new x.a;m!==void 0&&typeof m=="object"?(l.generateMipMaps=m.generateMipMaps,l.generateDepthBuffer=m.generateDepthBuffer===void 0?!0:m.generateDepthBuffer,l.generateStencilBuffer=l.generateDepthBuffer&&m.generateStencilBuffer,l.type=m.type===void 0?0:m.type,l.samplingMode=m.samplingMode===void 0?3:m.samplingMode):(l.generateMipMaps=m,l.generateDepthBuffer=!0,l.generateStencilBuffer=!1,l.type=0,l.samplingMode=3);var y=new G.a(this,G.b.RenderTarget),E=_.width||_,A=_.height||_;return y._depthStencilBuffer={},y._framebuffer={},y.baseWidth=E,y.baseHeight=A,y.width=E,y.height=A,y.isReady=!0,y.samples=1,y.generateMipMaps=!!l.generateMipMaps,y.samplingMode=l.samplingMode,y.type=l.type,y._generateDepthBuffer=l.generateDepthBuffer,y._generateStencilBuffer=!!l.generateStencilBuffer,this._internalTexturesCache.push(y),y},p.prototype.updateTextureSamplingMode=function(_,m){m.samplingMode=_},p.prototype.bindFramebuffer=function(_,m,l,y,E){this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=_,this._currentFramebuffer=_._MSAAFramebuffer?_._MSAAFramebuffer:_._framebuffer,this._cachedViewport&&!E&&this.setViewport(this._cachedViewport,l,y)},p.prototype.unBindFramebuffer=function(_,m,l){m===void 0&&(m=!1),this._currentRenderTarget=null,l&&(_._MSAAFramebuffer&&(this._currentFramebuffer=_._framebuffer),l()),this._currentFramebuffer=null},p.prototype.createDynamicVertexBuffer=function(_){var m=new T.a;return m.references=1,m.capacity=1,m},p.prototype.updateDynamicTexture=function(_,m,l,y,E){y===void 0&&(y=!1)},p.prototype.areAllEffectsReady=function(){return!0},p.prototype.getError=function(){return 0},p.prototype._getUnpackAlignement=function(){return 1},p.prototype._unpackFlipY=function(_){},p.prototype.updateDynamicIndexBuffer=function(_,m,l){l===void 0&&(l=0)},p.prototype.updateDynamicVertexBuffer=function(_,m,l,y){},p.prototype._bindTextureDirectly=function(_,m){return this._boundTexturesCache[this._activeChannel]!==m?(this._boundTexturesCache[this._activeChannel]=m,!0):!1},p.prototype._bindTexture=function(_,m){_<0||this._bindTextureDirectly(0,m)},p.prototype._deleteBuffer=function(_){},p.prototype.releaseEffects=function(){},p.prototype.displayLoadingUI=function(){},p.prototype.hideLoadingUI=function(){},p.prototype._uploadCompressedDataToTextureDirectly=function(_,m,l,y,E,A,F){A===void 0&&(A=0),F===void 0&&(F=0)},p.prototype._uploadDataToTextureDirectly=function(_,m,l,y){l===void 0&&(l=0),y===void 0&&(y=0)},p.prototype._uploadArrayBufferViewToTexture=function(_,m,l,y){l===void 0&&(l=0),y===void 0&&(y=0)},p.prototype._uploadImageToTexture=function(_,m,l,y){l===void 0&&(l=0),y===void 0&&(y=0)},p}(O.a)}).call(this,u(15))},646:function(we,P,u){"use strict";var S=u(435),R="glowMapMergePixelShader",U=`
varying vec2 vUV;
uniform sampler2D textureSampler;
#ifdef EMISSIVE
uniform sampler2D textureSampler2;
#endif

uniform float offset;
void main(void) {
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef EMISSIVE
baseColor+=texture2D(textureSampler2,vUV);
baseColor*=offset;
#else
baseColor.a=abs(offset-baseColor.a);
#ifdef STROKE
float alpha=smoothstep(.0,.1,baseColor.a);
baseColor.a=alpha;
baseColor.rgb=baseColor.rgb*alpha;
#endif
#endif
gl_FragColor=baseColor;
}`;S.a.ShadersStore[R]=U;var O={name:R,shader:U}},647:function(we,P,u){"use strict";var S=u(435),R="glowMapMergeVertexShader",U=`
attribute vec2 position;

varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
}`;S.a.ShadersStore[R]=U;var O={name:R,shader:U}},649:function(we,P,u){"use strict";u.d(P,"a",function(){return x});var S=u(449),R=u(452),U=u(598),O=u(440);Object.defineProperty(S.a.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(G){G&&G.isSupported&&(this._prePassRenderer=G)},enumerable:!0,configurable:!0}),S.a.prototype.enablePrePassRenderer=function(){return this._prePassRenderer?this._prePassRenderer:(this._prePassRenderer=new U.a(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,O.a.Error(`PrePassRenderer needs WebGL 2 support.
Maybe you tried to use the following features that need the PrePassRenderer :
 + Subsurface Scattering`)),this._prePassRenderer)},S.a.prototype.disablePrePassRenderer=function(){!this._prePassRenderer||(this._prePassRenderer.dispose(),this._prePassRenderer=null)};var x=function(){function G(T){this.name=R.a.NAME_PREPASSRENDERER,this.scene=T}return G.prototype.register=function(){this.scene._beforeCameraDrawStage.registerStep(R.a.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(R.a.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(R.a.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(R.a.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(R.a.STEP_BEFORECLEARSTAGE_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(R.a.STEP_BEFORERENDERTARGETCLEARSTAGE_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(R.a.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(R.a.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)},G.prototype._beforeRenderTargetDraw=function(T,h,f){this.scene.prePassRenderer&&(T._prePassRenderTarget||(T._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(T.name+"_prePassRTT",T)),this.scene.prePassRenderer._setRenderTarget(T._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,h,f))},G.prototype._afterRenderTargetDraw=function(T,h,f){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw(h,f)},G.prototype._beforeRenderTargetClearStage=function(T,h,f){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(T._prePassRenderTarget),this.scene.prePassRenderer._clear())},G.prototype._beforeCameraDraw=function(T){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(T))},G.prototype._afterCameraDraw=function(T){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()},G.prototype._beforeClearStage=function(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())},G.prototype._beforeRenderingMeshStage=function(T,h,f,d){if(!!d){var g=T.getScene();g.prePassRenderer&&g.prePassRenderer.bindAttachmentsForEffect(d,h)}},G.prototype._afterRenderingMeshStage=function(T){var h=T.getScene();h.prePassRenderer&&h.prePassRenderer.restoreAttachments()},G.prototype.rebuild=function(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()},G.prototype.dispose=function(){this.scene.disablePrePassRenderer()},G}();U.a._SceneComponentInitialization=function(G){var T=G._getComponent(R.a.NAME_PREPASSRENDERER);T||(T=new x(G),G._addComponent(T))}},664:function(we,P,u){"use strict";var S=u(435),R=u(487),U=u(496),O=u(497),x=u(501),G=u(507),T=u(508),h=u(488),f=u(489),d="depthVertexShader",g=`
attribute vec3 position;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
varying float vDepthMetric;
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;S.a.ShadersStore[d]=g;var p={name:d,shader:g}},665:function(we,P,u){"use strict";u.d(P,"a",function(){return m}),u.d(P,"b",function(){return l});var S=u(475),R=u(436),U=u(440),O=u(447),x=u(485),G=u(446),T=u(448),h=u(610),f=u(536),d=u(469),g=u(455),p=u(477),_=u(450),m;(function(y){y[y.Color=2]="Color",y[y.UV=1]="UV",y[y.Random=0]="Random",y[y.Stated=3]="Stated"})(m||(m={}));var l=function(){function y(E,A,F,B){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=E,this._size=A,this._scene=F||T.a.LastCreatedScene,B&&B.updatable!==void 0?this._updatable=B.updatable:this._updatable=!0}return y.prototype.buildMeshAsync=function(){var E=this;return Promise.all(this._promises).then(function(){return E._isReady=!0,E._buildMesh()})},y.prototype._buildMesh=function(){this.nbParticles===0&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);var E=new x.a;E.set(this._positions32,O.b.PositionKind),this._uvs32.length>0&&E.set(this._uvs32,O.b.UVKind);var A=0;this._colors32.length>0&&(A=1,E.set(this._colors32,O.b.ColorKind));var F=new G.a(this.name,this._scene);E.applyToMesh(F,this._updatable),this.mesh=F,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);var B=new g.a("point cloud material",this._scene);return B.emissiveColor=new S.e(A,A,A),B.disableLighting=!0,B.pointsCloud=!0,B.pointSize=this._size,F.material=B,new Promise(function(L){return L(F)})},y.prototype._addParticle=function(E,A,F,B){var L=new h.a(E,A,F,B,this);return this.particles.push(L),L},y.prototype._randomUnitVector=function(E){E.position=new R.e(Math.random(),Math.random(),Math.random()),E.color=new S.f(1,1,1,1)},y.prototype._getColorIndicesForCoord=function(E,A,F,B){var L=E._groupImageData,I=F*(B*4)+A*4,z=[I,I+1,I+2,I+3],k=z[0],j=z[1],w=z[2],Q=z[3],W=L[k],Y=L[j],he=L[w],le=L[Q];return new S.f(W/255,Y/255,he/255,le)},y.prototype._setPointsColorOrUV=function(E,A,F,B,L,I,z){F&&E.updateFacetData();var k=E.getBoundingInfo(),j=2*k.boundingSphere.radius,w=E.getVerticesData(O.b.PositionKind),Q=E.getIndices(),W=E.getVerticesData(O.b.UVKind),Y=E.getVerticesData(O.b.ColorKind),he=R.e.Zero();E.computeWorldMatrix();var le=E.getWorldMatrix();if(!le.isIdentity())for(var J=0;J<w.length/3;J++)R.e.TransformCoordinatesFromFloatsToRef(w[3*J],w[3*J+1],w[3*J+2],le,he),w[3*J]=he.x,w[3*J+1]=he.y,w[3*J+2]=he.z;var Re=0,Me=0,me=0,H=0,q=0,_e=0,Ee=0,Te=0,se=0,ve=0,ye=0,Le=0,be=0,ze=0,Ye=R.e.Zero(),He=R.e.Zero(),Ue=R.e.Zero(),re=R.e.Zero(),Z=R.e.Zero(),fe=0,ue=0,Ge=0,xe=0,ne=0,Ke=0,nt=R.d.Zero(),ut=R.d.Zero(),pt=R.d.Zero(),Tt=R.d.Zero(),de=R.d.Zero(),Ft=0,Jt=0,Dt=0,Xt=0,Kt=0,Zi=0,zi=0,li=0,Di=0,Qt=0,_i=0,ji=0,yi=R.f.Zero(),ai=R.f.Zero(),Ei=R.f.Zero(),Ut=R.f.Zero(),wi=R.f.Zero(),ui=0,Wi=0;z=z||0;for(var Hi,Pi,xt=new R.f(0,0,0,0),Ji=R.e.Zero(),Dr=R.e.Zero(),Vt=R.e.Zero(),Ci=0,dr=R.e.Zero(),Ii=0,Wt=0,Nt=new d.a(R.e.Zero(),new R.e(1,0,0)),sr,Ri=R.e.Zero(),Me=0;Me<Q.length/3;Me++){me=Q[3*Me],H=Q[3*Me+1],q=Q[3*Me+2],_e=w[3*me],Ee=w[3*me+1],Te=w[3*me+2],se=w[3*H],ve=w[3*H+1],ye=w[3*H+2],Le=w[3*q],be=w[3*q+1],ze=w[3*q+2],Ye.set(_e,Ee,Te),He.set(se,ve,ye),Ue.set(Le,be,ze),He.subtractToRef(Ye,re),Ue.subtractToRef(He,Z),W&&(fe=W[2*me],ue=W[2*me+1],Ge=W[2*H],xe=W[2*H+1],ne=W[2*q],Ke=W[2*q+1],nt.set(fe,ue),ut.set(Ge,xe),pt.set(ne,Ke),ut.subtractToRef(nt,Tt),pt.subtractToRef(ut,de)),Y&&B&&(Ft=Y[4*me],Jt=Y[4*me+1],Dt=Y[4*me+2],Xt=Y[4*me+3],Kt=Y[4*H],Zi=Y[4*H+1],zi=Y[4*H+2],li=Y[4*H+3],Di=Y[4*q],Qt=Y[4*q+1],_i=Y[4*q+2],ji=Y[4*q+3],yi.set(Ft,Jt,Dt,Xt),ai.set(Kt,Zi,zi,li),Ei.set(Di,Qt,_i,ji),ai.subtractToRef(yi,Ut),Ei.subtractToRef(ai,wi));for(var pr,Er,Vi,$i,Pr,gr,Zt,Yt,Li=new S.e(0,0,0),Ui=new S.e(0,0,0),qi,Ht,er=0;er<A._groupDensity[Me];er++)Re=this.particles.length,this._addParticle(Re,A,this._groupCounter,Me+er),Ht=this.particles[Re],ui=_.a.RandomRange(0,1),Wi=_.a.RandomRange(0,1),Hi=Ye.add(re.scale(ui)).add(Z.scale(ui*Wi)),F&&(Ji=E.getFacetNormal(Me).normalize().scale(-1),Dr=re.clone().normalize(),Vt=R.e.Cross(Ji,Dr),Ci=_.a.RandomRange(0,2*Math.PI),dr=Dr.scale(Math.cos(Ci)).add(Vt.scale(Math.sin(Ci))),Ci=_.a.RandomRange(.1,Math.PI/2),Ri=dr.scale(Math.cos(Ci)).add(Ji.scale(Math.sin(Ci))),Nt.origin=Hi.add(Ri.scale(1e-5)),Nt.direction=Ri,Nt.length=j,sr=Nt.intersectsMesh(E),sr.hit&&(Wt=sr.pickedPoint.subtract(Hi).length(),Ii=_.a.RandomRange(0,1)*Wt,Hi.addInPlace(Ri.scale(Ii)))),Ht.position=Hi.clone(),this._positions.push(Ht.position.x,Ht.position.y,Ht.position.z),B!==void 0?W&&(Pi=nt.add(Tt.scale(ui)).add(de.scale(ui*Wi)),B?L&&A._groupImageData!==null?(pr=A._groupImgWidth,Er=A._groupImgHeight,qi=this._getColorIndicesForCoord(A,Math.round(Pi.x*pr),Math.round(Pi.y*Er),pr),Ht.color=qi,this._colors.push(qi.r,qi.g,qi.b,qi.a)):Y?(xt=yi.add(Ut.scale(ui)).add(wi.scale(ui*Wi)),Ht.color=new S.f(xt.x,xt.y,xt.z,xt.w),this._colors.push(xt.x,xt.y,xt.z,xt.w)):(xt=yi.set(Math.random(),Math.random(),Math.random(),1),Ht.color=new S.f(xt.x,xt.y,xt.z,xt.w),this._colors.push(xt.x,xt.y,xt.z,xt.w)):(Ht.uv=Pi.clone(),this._uvs.push(Ht.uv.x,Ht.uv.y))):(I?(Li.set(I.r,I.g,I.b),Vi=_.a.RandomRange(-z,z),$i=_.a.RandomRange(-z,z),Yt=Li.toHSV(),Pr=Yt.r,gr=Yt.g+Vi,Zt=Yt.b+$i,gr<0&&(gr=0),gr>1&&(gr=1),Zt<0&&(Zt=0),Zt>1&&(Zt=1),S.e.HSVtoRGBToRef(Pr,gr,Zt,Ui),xt.set(Ui.r,Ui.g,Ui.b,1)):xt=yi.set(Math.random(),Math.random(),Math.random(),1),Ht.color=new S.f(xt.x,xt.y,xt.z,xt.w),this._colors.push(xt.x,xt.y,xt.z,xt.w))}},y.prototype._colorFromTexture=function(E,A,F){var B=this;if(E.material===null){U.a.Warn(E.name+"has no material."),A._groupImageData=null,this._setPointsColorOrUV(E,A,F,!0,!1);return}var L=E.material,I=L.getActiveTextures();if(I.length===0){U.a.Warn(E.name+"has no usable texture."),A._groupImageData=null,this._setPointsColorOrUV(E,A,F,!0,!1);return}var z=E.clone();z.setEnabled(!1),this._promises.push(new Promise(function(k){p.a.WhenAllReady(I,function(){var j=A._textureNb;j<0&&(j=0),j>I.length-1&&(j=I.length-1);var w=function(){A._groupImgWidth=I[j].getSize().width,A._groupImgHeight=I[j].getSize().height,B._setPointsColorOrUV(z,A,F,!0,!0),z.dispose(),k()};A._groupImageData=null;var Q=I[j].readPixels();Q?Q.then(function(W){A._groupImageData=W,w()}):w()})}))},y.prototype._calculateDensity=function(E,A,F){for(var B=new Array,L,I,z,k,j,w,Q,W,Y,he,le,J,Re,Me=R.e.Zero(),me=R.e.Zero(),H=R.e.Zero(),q=R.e.Zero(),_e=R.e.Zero(),Ee=R.e.Zero(),Te,se,ve,ye,Le,be=new Array,ze=0,Ye=F.length/3,L=0;L<Ye;L++)I=F[3*L],z=F[3*L+1],k=F[3*L+2],j=A[3*I],w=A[3*I+1],Q=A[3*I+2],W=A[3*z],Y=A[3*z+1],he=A[3*z+2],le=A[3*k],J=A[3*k+1],Re=A[3*k+2],Me.set(j,w,Q),me.set(W,Y,he),H.set(le,J,Re),me.subtractToRef(Me,q),H.subtractToRef(me,_e),H.subtractToRef(Me,Ee),Te=q.length(),se=_e.length(),ve=Ee.length(),ye=(Te+se+ve)/2,Le=Math.sqrt(ye*(ye-Te)*(ye-se)*(ye-ve)),ze+=Le,be[L]=Le;for(var He=0,L=0;L<Ye;L++)B[L]=Math.floor(E*be[L]/ze),He+=B[L];var Ue=E-He,re=Math.floor(Ue/Ye),Z=Ue%Ye;re>0&&(B=B.map(function(fe){return fe+re}));for(var L=0;L<Z;L++)B[L]+=1;return B},y.prototype.addPoints=function(E,A){A===void 0&&(A=this._randomUnitVector);for(var F=new h.b(this._groupCounter,A),B,L=this.nbParticles,I=0;I<E;I++)B=this._addParticle(L,F,this._groupCounter,I),F&&F._positionFunction&&F._positionFunction(B,L,I),this._positions.push(B.position.x,B.position.y,B.position.z),B.color&&this._colors.push(B.color.r,B.color.g,B.color.b,B.color.a),B.uv&&this._uvs.push(B.uv.x,B.uv.y),L++;return this.nbParticles+=E,this._groupCounter++,this._groupCounter},y.prototype.addSurfacePoints=function(E,A,F,B,L){var I=F||m.Random;(isNaN(I)||I<0||I>3)&&(I=m.Random);var z=E.getVerticesData(O.b.PositionKind),k=E.getIndices();this._groups.push(this._groupCounter);var j=new h.b(this._groupCounter,null);switch(j._groupDensity=this._calculateDensity(A,z,k),I===m.Color?j._textureNb=B||0:B=B||new S.f(1,1,1,1),I){case m.Color:this._colorFromTexture(E,j,!1);break;case m.UV:this._setPointsColorOrUV(E,j,!1,!1,!1);break;case m.Random:this._setPointsColorOrUV(E,j,!1);break;case m.Stated:this._setPointsColorOrUV(E,j,!1,void 0,void 0,B,L);break}return this.nbParticles+=A,this._groupCounter++,this._groupCounter-1},y.prototype.addVolumePoints=function(E,A,F,B,L){var I=F||m.Random;(isNaN(I)||I<0||I>3)&&(I=m.Random);var z=E.getVerticesData(O.b.PositionKind),k=E.getIndices();this._groups.push(this._groupCounter);var j=new h.b(this._groupCounter,null);switch(j._groupDensity=this._calculateDensity(A,z,k),I===m.Color?j._textureNb=B||0:B=B||new S.f(1,1,1,1),I){case m.Color:this._colorFromTexture(E,j,!0);break;case m.UV:this._setPointsColorOrUV(E,j,!0,!1,!1);break;case m.Random:this._setPointsColorOrUV(E,j,!0);break;case m.Stated:this._setPointsColorOrUV(E,j,!0,void 0,void 0,B,L);break}return this.nbParticles+=A,this._groupCounter++,this._groupCounter-1},y.prototype.setParticles=function(E,A,F){if(E===void 0&&(E=0),A===void 0&&(A=this.nbParticles-1),F===void 0&&(F=!0),!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(E,A,F);var B=R.c.Matrix[0],L=this.mesh,I=this._colors32,z=this._positions32,k=this._uvs32,j=R.c.Vector3,w=j[5].copyFromFloats(1,0,0),Q=j[6].copyFromFloats(0,1,0),W=j[7].copyFromFloats(0,0,1),Y=j[8].setAll(Number.MAX_VALUE),he=j[9].setAll(-Number.MAX_VALUE);R.a.IdentityToRef(B);var le=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),A=A>=this.nbParticles?this.nbParticles-1:A,this._computeBoundingBox&&(E!=0||A!=this.nbParticles-1)){var J=this.mesh._boundingInfo;J&&(Y.copyFrom(J.minimum),he.copyFrom(J.maximum))}for(var le=0,Re=0,Me=0,me=0,H=E;H<=A;H++){var q=this.particles[H];le=q.idx,Re=3*le,Me=4*le,me=2*le,this.updateParticle(q);var _e=q._rotationMatrix,Ee=q.position,Te=q._globalPosition;this._computeParticleRotation&&q.getRotationMatrix(B);var se=q.parentId!==null;if(se){var ve=this.particles[q.parentId],ye=ve._rotationMatrix,Le=ve._globalPosition,be=Ee.x*ye[1]+Ee.y*ye[4]+Ee.z*ye[7],ze=Ee.x*ye[0]+Ee.y*ye[3]+Ee.z*ye[6],Ye=Ee.x*ye[2]+Ee.y*ye[5]+Ee.z*ye[8];if(Te.x=Le.x+ze,Te.y=Le.y+be,Te.z=Le.z+Ye,this._computeParticleRotation){var He=B.m;_e[0]=He[0]*ye[0]+He[1]*ye[3]+He[2]*ye[6],_e[1]=He[0]*ye[1]+He[1]*ye[4]+He[2]*ye[7],_e[2]=He[0]*ye[2]+He[1]*ye[5]+He[2]*ye[8],_e[3]=He[4]*ye[0]+He[5]*ye[3]+He[6]*ye[6],_e[4]=He[4]*ye[1]+He[5]*ye[4]+He[6]*ye[7],_e[5]=He[4]*ye[2]+He[5]*ye[5]+He[6]*ye[8],_e[6]=He[8]*ye[0]+He[9]*ye[3]+He[10]*ye[6],_e[7]=He[8]*ye[1]+He[9]*ye[4]+He[10]*ye[7],_e[8]=He[8]*ye[2]+He[9]*ye[5]+He[10]*ye[8]}}else if(Te.x=0,Te.y=0,Te.z=0,this._computeParticleRotation){var He=B.m;_e[0]=He[0],_e[1]=He[1],_e[2]=He[2],_e[3]=He[4],_e[4]=He[5],_e[5]=He[6],_e[6]=He[8],_e[7]=He[9],_e[8]=He[10]}var Ue=j[11];q.translateFromPivot?Ue.setAll(0):Ue.copyFrom(q.pivot);var re=j[0];re.copyFrom(q.position);var Z=re.x-q.pivot.x,fe=re.y-q.pivot.y,ue=re.z-q.pivot.z,Ge=Z*_e[0]+fe*_e[3]+ue*_e[6],xe=Z*_e[1]+fe*_e[4]+ue*_e[7],ne=Z*_e[2]+fe*_e[5]+ue*_e[8];Ge+=Ue.x,xe+=Ue.y,ne+=Ue.z;var Ke=z[Re]=Te.x+w.x*Ge+Q.x*xe+W.x*ne,nt=z[Re+1]=Te.y+w.y*Ge+Q.y*xe+W.y*ne,ut=z[Re+2]=Te.z+w.z*Ge+Q.z*xe+W.z*ne;if(this._computeBoundingBox&&(Y.minimizeInPlaceFromFloats(Ke,nt,ut),he.maximizeInPlaceFromFloats(Ke,nt,ut)),this._computeParticleColor&&q.color){var pt=q.color,Tt=this._colors32;Tt[Me]=pt.r,Tt[Me+1]=pt.g,Tt[Me+2]=pt.b,Tt[Me+3]=pt.a}if(this._computeParticleTexture&&q.uv){var de=q.uv,Ft=this._uvs32;Ft[me]=de.x,Ft[me+1]=de.y}}return F&&(this._computeParticleColor&&L.updateVerticesData(O.b.ColorKind,I,!1,!1),this._computeParticleTexture&&L.updateVerticesData(O.b.UVKind,k,!1,!1),L.updateVerticesData(O.b.PositionKind,z,!1,!1)),this._computeBoundingBox&&(L._boundingInfo?L._boundingInfo.reConstruct(Y,he,L._worldMatrix):L._boundingInfo=new f.a(Y,he,L._worldMatrix)),this.afterUpdateParticles(E,A,F),this},y.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null},y.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},y.prototype.setVisibilityBox=function(E){var A=E/2;this.mesh._boundingInfo=new f.a(new R.e(-A,-A,-A),new R.e(A,A,A))},Object.defineProperty(y.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(E){this._alwaysVisible=E,this.mesh.alwaysSelectAsActiveMesh=E},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"computeParticleRotation",{set:function(E){this._computeParticleRotation=E},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(E){this._computeParticleColor=E},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(E){this._computeParticleTexture=E},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(E){this._computeBoundingBox=E},enumerable:!1,configurable:!0}),y.prototype.initParticles=function(){},y.prototype.recycleParticle=function(E){return E},y.prototype.updateParticle=function(E){return E},y.prototype.beforeUpdateParticles=function(E,A,F){},y.prototype.afterUpdateParticles=function(E,A,F){},y}()},666:function(we,P,u){"use strict";u.d(P,"a",function(){return O});var S=u(449),R=u(556),U=u(452);S.a.prototype.enableDepthRenderer=function(x,G,T){if(G===void 0&&(G=!1),T===void 0&&(T=!1),x=x||this.activeCamera,!x)throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[x.id]){var h=!!this.getEngine().getCaps().textureFloatRender,f=0;this.getEngine().getCaps().textureHalfFloatRender&&(!T||!h)?f=2:h?f=1:f=0,this._depthRenderer[x.id]=new R.a(this,f,x,G)}return this._depthRenderer[x.id]},S.a.prototype.disableDepthRenderer=function(x){x=x||this.activeCamera,!(!x||!this._depthRenderer||!this._depthRenderer[x.id])&&(this._depthRenderer[x.id].dispose(),delete this._depthRenderer[x.id])};var O=function(){function x(G){this.name=U.a.NAME_DEPTHRENDERER,this.scene=G}return x.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(U.a.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(U.a.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)},x.prototype.rebuild=function(){},x.prototype.dispose=function(){for(var G in this.scene._depthRenderer)this.scene._depthRenderer[G].dispose()},x.prototype._gatherRenderTargets=function(G){if(this.scene._depthRenderer)for(var T in this.scene._depthRenderer){var h=this.scene._depthRenderer[T];h.enabled&&!h.useOnlyInActiveCamera&&G.push(h.getDepthMap())}},x.prototype._gatherActiveCameraRenderTargets=function(G){if(this.scene._depthRenderer)for(var T in this.scene._depthRenderer){var h=this.scene._depthRenderer[T];h.enabled&&h.useOnlyInActiveCamera&&this.scene.activeCamera.id===T&&G.push(h.getDepthMap())}},x}();R.a._SceneComponentInitialization=function(x){var G=x._getComponent(U.a.NAME_DEPTHRENDERER);G||(G=new O(x),x._addComponent(G))}},676:function(we,P,u){"use strict";var S=u(435),R="depthBoxBlurPixelShader",U=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform vec2 screenSize;
void main(void)
{
vec4 colorDepth=vec4(0.0);
for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);
gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));
}`;S.a.ShadersStore[R]=U;var O={name:R,shader:U}},677:function(we,P,u){"use strict";u.d(P,"b",function(){return Y}),u.d(P,"a",function(){return he});var S=u(440),R=u(451),U=u(436),O=u(441),x=u(446),G=u(661),T=u(499),h=u(459),f=u(543),d=u(504),g=u(567),p=u(540),_=u(484),m=u(452),l=u(463),y=u(468),E=u(604),A=u(618),F=u(560),B=u(561),L=u(632),I=u(633),z=u(634),k=u(635),j=u(437),w=u(443),Q=u(473),W=u(444),Y=!0,he=function(){function H(){}return H.LoaderInjectedPhysicsEngine=void 0,H}(),le=function(H,q,_e,Ee){for(var Te=0,se=q.materials.length;Te<se;Te++){var ve=q.materials[Te];if(ve.id===H)return h.a.Parse(ve,_e,Ee)}return null},J=function(H,q,_e){for(var Ee in q)if(H.name===q[Ee])return _e.push(H.id),!0;return H.parentId&&_e.indexOf(H.parentId)!==-1?(_e.push(H.id),!0):!1},Re=function(H,q){return H+" of "+(q?q.file+" from "+q.name+" version: "+q.version+", exporter version: "+q.exporter_version:"unknown")},Me=function(H,q){var _e=q;if(q._waitingData.lods){if(q._waitingData.lods.ids&&q._waitingData.lods.ids.length>0){var Ee=q._waitingData.lods.ids,Te=_e.isEnabled(!1);if(q._waitingData.lods.distances){var se=q._waitingData.lods.distances;if(se.length>=Ee.length){var ve=se.length>Ee.length?se[se.length-1]:0;_e.setEnabled(!1);for(var ye=0;ye<Ee.length;ye++){var Le=Ee[ye],be=H.getMeshByID(Le);be!=null&&_e.addLODLevel(se[ye],be)}ve>0&&_e.addLODLevel(ve,null),Te===!0&&_e.setEnabled(!0)}else w.b.Warn("Invalid level of detail distances for "+q.name)}}q._waitingData.lods=null}},me=function(H,q,_e,Ee,Te){Te===void 0&&(Te=!1);var se=new E.a(H),ve="importScene has failed JSON parse";try{var ye=JSON.parse(q);ve="";var Le=l.a.loggingLevel===l.a.DETAILED_LOGGING,be,ze;if(ye.environmentTexture!==void 0&&ye.environmentTexture!==null){var Ye=ye.isPBR!==void 0?ye.isPBR:!0;if(ye.environmentTextureType&&ye.environmentTextureType==="BABYLON.HDRCubeTexture"){var He=ye.environmentTextureSize?ye.environmentTextureSize:128,Ue=new g.a((ye.environmentTexture.match(/https?:\/\//g)?"":_e)+ye.environmentTexture,H,He,!0,!Ye);ye.environmentTextureRotationY&&(Ue.rotationY=ye.environmentTextureRotationY),H.environmentTexture=Ue}else if(Q.a.EndsWith(ye.environmentTexture,".env")){var re=new d.a((ye.environmentTexture.match(/https?:\/\//g)?"":_e)+ye.environmentTexture,H);ye.environmentTextureRotationY&&(re.rotationY=ye.environmentTextureRotationY),H.environmentTexture=re}else{var Z=d.a.CreateFromPrefilteredData((ye.environmentTexture.match(/https?:\/\//g)?"":_e)+ye.environmentTexture,H);ye.environmentTextureRotationY&&(Z.rotationY=ye.environmentTextureRotationY),H.environmentTexture=Z}if(ye.createDefaultSkybox===!0){var fe=H.activeCamera!==void 0&&H.activeCamera!==null?(H.activeCamera.maxZ-H.activeCamera.minZ)/2:1e3,ue=ye.skyboxBlurLevel||0;H.createDefaultSkybox(H.environmentTexture,Ye,fe,ue)}se.environmentTexture=H.environmentTexture}if(ye.environmentIntensity!==void 0&&ye.environmentIntensity!==null&&(H.environmentIntensity=ye.environmentIntensity),ye.lights!==void 0&&ye.lights!==null)for(be=0,ze=ye.lights.length;be<ze;be++){var Ge=ye.lights[be],xe=_.a.Parse(Ge,H);xe&&(se.lights.push(xe),ve+=be===0?`
	Lights:`:"",ve+=`
		`+xe.toString(Le))}if(ye.reflectionProbes!==void 0&&ye.reflectionProbes!==null)for(be=0,ze=ye.reflectionProbes.length;be<ze;be++){var ne=ye.reflectionProbes[be],Ke=k.a.Parse(ne,H,_e);Ke&&(se.reflectionProbes.push(Ke),ve+=be===0?`
	Reflection Probes:`:"",ve+=`
		`+Ke.toString(Le))}if(ye.animations!==void 0&&ye.animations!==null)for(be=0,ze=ye.animations.length;be<ze;be++){var nt=ye.animations[be],ut=j.a.GetClass("BABYLON.Animation");if(ut){var pt=ut.Parse(nt);H.animations.push(pt),se.animations.push(pt),ve+=be===0?`
	Animations:`:"",ve+=`
		`+pt.toString(Le)}}if(ye.materials!==void 0&&ye.materials!==null)for(be=0,ze=ye.materials.length;be<ze;be++){var Tt=ye.materials[be],de=h.a.Parse(Tt,H,_e);if(de){se.materials.push(de),ve+=be===0?`
	Materials:`:"",ve+=`
		`+de.toString(Le);var Ft=de.getActiveTextures();Ft.forEach(function(Vi){se.textures.indexOf(Vi)==-1&&se.textures.push(Vi)})}}if(ye.multiMaterials!==void 0&&ye.multiMaterials!==null)for(be=0,ze=ye.multiMaterials.length;be<ze;be++){var Jt=ye.multiMaterials[be],Dt=f.a.ParseMultiMaterial(Jt,H);se.multiMaterials.push(Dt),ve+=be===0?`
	MultiMaterials:`:"",ve+=`
		`+Dt.toString(Le);var Ft=Dt.getActiveTextures();Ft.forEach(function($i){se.textures.indexOf($i)==-1&&se.textures.push($i)})}if(ye.morphTargetManagers!==void 0&&ye.morphTargetManagers!==null)for(var Xt=0,Kt=ye.morphTargetManagers;Xt<Kt.length;Xt++){var Zi=Kt[Xt];se.morphTargetManagers.push(B.a.Parse(Zi,H))}if(ye.skeletons!==void 0&&ye.skeletons!==null)for(be=0,ze=ye.skeletons.length;be<ze;be++){var zi=ye.skeletons[be],li=F.a.Parse(zi,H);se.skeletons.push(li),ve+=be===0?`
	Skeletons:`:"",ve+=`
		`+li.toString(Le)}var Di=ye.geometries;if(Di!=null){var Qt=new Array,_i=Di.vertexData;if(_i!=null)for(be=0,ze=_i.length;be<ze;be++){var ji=_i[be];Qt.push(G.a.Parse(ji,H,_e))}Qt.forEach(function(Vi){Vi&&se.geometries.push(Vi)})}if(ye.transformNodes!==void 0&&ye.transformNodes!==null)for(be=0,ze=ye.transformNodes.length;be<ze;be++){var yi=ye.transformNodes[be],ai=T.a.Parse(yi,H,_e);se.transformNodes.push(ai)}if(ye.meshes!==void 0&&ye.meshes!==null)for(be=0,ze=ye.meshes.length;be<ze;be++){var Ei=ye.meshes[be],Ut=x.a.Parse(Ei,H,_e);if(se.meshes.push(Ut),Ut.hasInstances)for(var wi=0,ui=Ut.instances;wi<ui.length;wi++){var Wi=ui[wi];se.meshes.push(Wi)}ve+=be===0?`
	Meshes:`:"",ve+=`
		`+Ut.toString(Le)}if(ye.cameras!==void 0&&ye.cameras!==null)for(be=0,ze=ye.cameras.length;be<ze;be++){var Hi=ye.cameras[be],Pi=R.a.Parse(Hi,H);se.cameras.push(Pi),ve+=be===0?`
	Cameras:`:"",ve+=`
		`+Pi.toString(Le)}if(ye.postProcesses!==void 0&&ye.postProcesses!==null)for(be=0,ze=ye.postProcesses.length;be<ze;be++){var xt=ye.postProcesses[be],Ji=W.a.Parse(xt,H,_e);Ji&&(se.postProcesses.push(Ji),ve+=be===0?`
Postprocesses:`:"",ve+=`
		`+Ji.toString())}if(ye.animationGroups!==void 0&&ye.animationGroups!==null)for(be=0,ze=ye.animationGroups.length;be<ze;be++){var Dr=ye.animationGroups[be],Vt=p.a.Parse(Dr,H);se.animationGroups.push(Vt),ve+=be===0?`
	AnimationGroups:`:"",ve+=`
		`+Vt.toString(Le)}for(be=0,ze=H.cameras.length;be<ze;be++){var Pi=H.cameras[be];Pi._waitingParentId&&(Pi.parent=H.getLastEntryByID(Pi._waitingParentId),Pi._waitingParentId=null)}for(be=0,ze=H.lights.length;be<ze;be++){var Ci=H.lights[be];Ci&&Ci._waitingParentId&&(Ci.parent=H.getLastEntryByID(Ci._waitingParentId),Ci._waitingParentId=null)}for(be=0,ze=H.transformNodes.length;be<ze;be++){var dr=H.transformNodes[be];dr._waitingParentId&&(dr.parent=H.getLastEntryByID(dr._waitingParentId),dr._waitingParentId=null)}for(be=0,ze=H.meshes.length;be<ze;be++){var Ut=H.meshes[be];Ut._waitingParentId&&(Ut.parent=H.getLastEntryByID(Ut._waitingParentId),Ut._waitingParentId=null),Ut._waitingData.lods&&Me(H,Ut)}for(be=0,ze=H.skeletons.length;be<ze;be++){var li=H.skeletons[be];li._hasWaitingData&&(li.bones!=null&&li.bones.forEach(function($i){if($i._waitingTransformNodeId){var Pr=H.getLastEntryByID($i._waitingTransformNodeId);Pr&&$i.linkTransformNode(Pr),$i._waitingTransformNodeId=null}}),li._waitingOverrideMeshId&&(li.overrideMesh=H.getMeshByID(li._waitingOverrideMeshId),li._waitingOverrideMeshId=null),li._hasWaitingData=null)}for(be=0,ze=H.meshes.length;be<ze;be++){var Ii=H.meshes[be];Ii._waitingData.freezeWorldMatrix?(Ii.freezeWorldMatrix(),Ii._waitingData.freezeWorldMatrix=null):Ii.computeWorldMatrix(!0)}for(be=0,ze=H.lights.length;be<ze;be++){var Wt=H.lights[be];if(Wt._excludedMeshesIds.length>0){for(var Nt=0;Nt<Wt._excludedMeshesIds.length;Nt++){var sr=H.getMeshByID(Wt._excludedMeshesIds[Nt]);sr&&Wt.excludedMeshes.push(sr)}Wt._excludedMeshesIds=[]}if(Wt._includedOnlyMeshesIds.length>0){for(var Ri=0;Ri<Wt._includedOnlyMeshesIds.length;Ri++){var pr=H.getMeshByID(Wt._includedOnlyMeshesIds[Ri]);pr&&Wt.includedOnlyMeshes.push(pr)}Wt._includedOnlyMeshesIds=[]}}for(y.a.Parse(ye,H,se,_e),be=0,ze=H.meshes.length;be<ze;be++){var Ut=H.meshes[be];Ut._waitingData.actions&&(A.a.Parse(Ut._waitingData.actions,Ut,H),Ut._waitingData.actions=null)}ye.actions!==void 0&&ye.actions!==null&&A.a.Parse(ye.actions,null,H)}catch(Vi){var Er=Re("loadAssets",ye?ye.producer:"Unknown")+ve;if(Ee)Ee(Er,Vi);else throw S.a.Log(Er),Vi}finally{Te||se.removeAllFromScene(),ve!==null&&l.a.loggingLevel!==l.a.NO_LOGGING&&S.a.Log(Re("loadAssets",ye?ye.producer:"Unknown")+(l.a.loggingLevel!==l.a.MINIMAL_LOGGING?ve:""))}return se};l.a.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:function(H){return H.indexOf("babylon")!==-1},importMesh:function(H,q,_e,Ee,Te,se,ve,ye){var Le="importMesh has failed JSON parse";try{var be=JSON.parse(_e);Le="";var ze=l.a.loggingLevel===l.a.DETAILED_LOGGING;H?Array.isArray(H)||(H=[H]):H=null;var Ye=new Array;if(be.meshes!==void 0&&be.meshes!==null){var He=[],Ue=[],re,Z;for(re=0,Z=be.meshes.length;re<Z;re++){var fe=be.meshes[re];if(H===null||J(fe,H,Ye)){if(H!==null&&delete H[H.indexOf(fe.name)],fe.geometryId!==void 0&&fe.geometryId!==null&&be.geometries!==void 0&&be.geometries!==null){var ue=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(function(ai){ue===!0||!be.geometries[ai]||!Array.isArray(be.geometries[ai])||be.geometries[ai].forEach(function(Ei){if(Ei.id===fe.geometryId){switch(ai){case"vertexData":G.a.Parse(Ei,q,Ee);break}ue=!0}})}),ue===!1&&S.a.Warn("Geometry not found for mesh "+fe.id)}if(fe.materialId){var Ge=Ue.indexOf(fe.materialId)!==-1;if(Ge===!1&&be.multiMaterials!==void 0&&be.multiMaterials!==null)for(var xe=0,ne=be.multiMaterials.length;xe<ne;xe++){var Ke=be.multiMaterials[xe];if(Ke.id===fe.materialId){for(var nt=0,ut=Ke.materials.length;nt<ut;nt++){var pt=Ke.materials[nt];Ue.push(pt);var Tt=le(pt,be,q,Ee);Tt&&(Le+=`
	Material `+Tt.toString(ze))}Ue.push(Ke.id);var de=f.a.ParseMultiMaterial(Ke,q);de&&(Ge=!0,Le+=`
	Multi-Material `+de.toString(ze));break}}if(Ge===!1){Ue.push(fe.materialId);var Tt=le(fe.materialId,be,q,Ee);Tt?Le+=`
	Material `+Tt.toString(ze):S.a.Warn("Material not found for mesh "+fe.id)}}if(fe.skeletonId>-1&&be.skeletons!==void 0&&be.skeletons!==null){var Ft=He.indexOf(fe.skeletonId)>-1;if(Ft===!1)for(var Jt=0,Dt=be.skeletons.length;Jt<Dt;Jt++){var Xt=be.skeletons[Jt];if(Xt.id===fe.skeletonId){var Kt=F.a.Parse(Xt,q);ve.push(Kt),He.push(Xt.id),Le+=`
	Skeleton `+Kt.toString(ze)}}}if(be.morphTargetManagers!==void 0&&be.morphTargetManagers!==null)for(var Zi=0,zi=be.morphTargetManagers;Zi<zi.length;Zi++){var li=zi[Zi];B.a.Parse(li,q)}var Di=x.a.Parse(fe,q,Ee);Te.push(Di),Le+=`
	Mesh `+Di.toString(ze)}}var Qt;for(re=0,Z=q.meshes.length;re<Z;re++)Qt=q.meshes[re],Qt._waitingParentId&&(Qt.parent=q.getLastEntryByID(Qt._waitingParentId),Qt._waitingParentId=null),Qt._waitingData.lods&&Me(q,Qt);for(re=0,Z=q.skeletons.length;re<Z;re++){var Kt=q.skeletons[re];Kt._hasWaitingData&&(Kt.bones!=null&&Kt.bones.forEach(function(Ei){if(Ei._waitingTransformNodeId){var Ut=q.getLastEntryByID(Ei._waitingTransformNodeId);Ut&&Ei.linkTransformNode(Ut),Ei._waitingTransformNodeId=null}}),Kt._waitingOverrideMeshId&&(Kt.overrideMesh=q.getMeshByID(Kt._waitingOverrideMeshId),Kt._waitingOverrideMeshId=null),Kt._hasWaitingData=null)}for(re=0,Z=q.meshes.length;re<Z;re++)Qt=q.meshes[re],Qt._waitingData.freezeWorldMatrix?(Qt.freezeWorldMatrix(),Qt._waitingData.freezeWorldMatrix=null):Qt.computeWorldMatrix(!0)}if(be.particleSystems!==void 0&&be.particleSystems!==null){var _i=y.a.GetIndividualParser(m.a.NAME_PARTICLESYSTEM);if(_i)for(re=0,Z=be.particleSystems.length;re<Z;re++){var ji=be.particleSystems[re];Ye.indexOf(ji.emitterId)!==-1&&se.push(_i(ji,q,Ee))}}return!0}catch(ai){var yi=Re("importMesh",be?be.producer:"Unknown")+Le;if(ye)ye(yi,ai);else throw S.a.Log(yi),ai}finally{Le!==null&&l.a.loggingLevel!==l.a.NO_LOGGING&&S.a.Log(Re("importMesh",be?be.producer:"Unknown")+(l.a.loggingLevel!==l.a.MINIMAL_LOGGING?Le:""))}return!1},load:function(H,q,_e,Ee){var Te="importScene has failed JSON parse";try{var se=JSON.parse(q);if(Te="",se.useDelayedTextureLoading!==void 0&&se.useDelayedTextureLoading!==null&&(H.useDelayedTextureLoading=se.useDelayedTextureLoading&&!l.a.ForceFullSceneLoadingForIncremental),se.autoClear!==void 0&&se.autoClear!==null&&(H.autoClear=se.autoClear),se.clearColor!==void 0&&se.clearColor!==null&&(H.clearColor=O.b.FromArray(se.clearColor)),se.ambientColor!==void 0&&se.ambientColor!==null&&(H.ambientColor=O.a.FromArray(se.ambientColor)),se.gravity!==void 0&&se.gravity!==null&&(H.gravity=U.e.FromArray(se.gravity)),se.fogMode&&se.fogMode!==0)switch(H.fogMode=se.fogMode,H.fogColor=O.a.FromArray(se.fogColor),H.fogStart=se.fogStart,H.fogEnd=se.fogEnd,H.fogDensity=se.fogDensity,Te+="	Fog mode for scene:  ",H.fogMode){case 1:Te+=`exp
`;break;case 2:Te+=`exp2
`;break;case 3:Te+=`linear
`;break}if(se.physicsEnabled){var ve;se.physicsEngine==="cannon"?ve=new L.a(void 0,void 0,he.LoaderInjectedPhysicsEngine):se.physicsEngine==="oimo"?ve=new I.a(void 0,he.LoaderInjectedPhysicsEngine):se.physicsEngine==="ammo"&&(ve=new z.a(void 0,he.LoaderInjectedPhysicsEngine,void 0)),Te="	Physics engine "+(se.physicsEngine?se.physicsEngine:"oimo")+` enabled
`;var ye=se.physicsGravity?U.e.FromArray(se.physicsGravity):null;H.enablePhysics(ye,ve)}se.metadata!==void 0&&se.metadata!==null&&(H.metadata=se.metadata),se.collisionsEnabled!==void 0&&se.collisionsEnabled!==null&&(H.collisionsEnabled=se.collisionsEnabled);var Le=me(H,q,_e,Ee,!0);return Le?(se.autoAnimate&&H.beginAnimation(H,se.autoAnimateFrom,se.autoAnimateTo,se.autoAnimateLoop,se.autoAnimateSpeed||1),se.activeCameraID!==void 0&&se.activeCameraID!==null&&H.setActiveCameraByID(se.activeCameraID),!0):!1}catch(ze){var be=Re("importScene",se?se.producer:"Unknown")+Te;if(Ee)Ee(be,ze);else throw S.a.Log(be),ze}finally{Te!==null&&l.a.loggingLevel!==l.a.NO_LOGGING&&S.a.Log(Re("importScene",se?se.producer:"Unknown")+(l.a.loggingLevel!==l.a.MINIMAL_LOGGING?Te:""))}return!1},loadAssetContainer:function(H,q,_e,Ee){var Te=me(H,q,_e,Ee);return Te}})},678:function(we,P,u){"use strict";u.r(P),u.d(P,"AxesViewer",function(){return x}),u.d(P,"BoneAxesViewer",function(){return h}),u.d(P,"DebugLayerTab",function(){return _}),u.d(P,"DebugLayer",function(){return m}),u.d(P,"PhysicsViewer",function(){return I}),u.d(P,"RayHelper",function(){return k}),u.d(P,"SkeletonViewer",function(){return le}),u.d(P,"DirectionalLightFrustumViewer",function(){return Me});var S=u(436),R=u(455),U=u(573),O=u(441),x=function(){function me(H,q,_e,Ee,Te,se){if(q===void 0&&(q=1),_e===void 0&&(_e=2),this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this.scaleLines=1,this.scaleLines=q,!Ee){var ve=new R.a("",H);ve.disableLighting=!0,ve.emissiveColor=O.a.Red().scale(.5),Ee=U.a._CreateArrow(H,ve)}if(!Te){var ye=new R.a("",H);ye.disableLighting=!0,ye.emissiveColor=O.a.Green().scale(.5),Te=U.a._CreateArrow(H,ye)}if(!se){var Le=new R.a("",H);Le.disableLighting=!0,Le.emissiveColor=O.a.Blue().scale(.5),se=U.a._CreateArrow(H,Le)}this._xAxis=Ee,this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis=Te,this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis=se,this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),_e!=null&&(me._SetRenderingGroupId(this._xAxis,_e),me._SetRenderingGroupId(this._yAxis,_e),me._SetRenderingGroupId(this._zAxis,_e)),this.scene=H,this.update(new S.e,S.e.Right(),S.e.Up(),S.e.Forward())}return Object.defineProperty(me.prototype,"xAxis",{get:function(){return this._xAxis},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"yAxis",{get:function(){return this._yAxis},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"zAxis",{get:function(){return this._zAxis},enumerable:!1,configurable:!0}),me.prototype.update=function(H,q,_e,Ee){this._xAxis.position.copyFrom(H),this._xAxis.setDirection(q),this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis.position.copyFrom(H),this._yAxis.setDirection(_e),this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis.position.copyFrom(H),this._zAxis.setDirection(Ee),this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor)},me.prototype.createInstance=function(){var H=U.a._CreateArrowInstance(this.scene,this._xAxis),q=U.a._CreateArrowInstance(this.scene,this._yAxis),_e=U.a._CreateArrowInstance(this.scene,this._zAxis),Ee=new me(this.scene,this.scaleLines,null,H,q,_e);return Ee._instanced=!0,Ee},me.prototype.dispose=function(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null},me._SetRenderingGroupId=function(H,q){H.getChildMeshes().forEach(function(_e){_e.renderingGroupId=q})},me}(),G=u(434),T=u(465),h=function(me){Object(G.d)(H,me);function H(q,_e,Ee,Te){Te===void 0&&(Te=1);var se=me.call(this,q,Te)||this;return se.pos=S.e.Zero(),se.xaxis=S.e.Zero(),se.yaxis=S.e.Zero(),se.zaxis=S.e.Zero(),se.mesh=Ee,se.bone=_e,se}return H.prototype.update=function(){if(!(!this.mesh||!this.bone)){var q=this.bone;q._markAsDirtyAndCompose(),q.getAbsolutePositionToRef(this.mesh,this.pos),q.getDirectionToRef(T.a.X,this.mesh,this.xaxis),q.getDirectionToRef(T.a.Y,this.mesh,this.yaxis),q.getDirectionToRef(T.a.Z,this.mesh,this.zaxis),me.prototype.update.call(this,this.pos,this.xaxis,this.yaxis,this.zaxis)}},H.prototype.dispose=function(){this.mesh&&(this.mesh=null,this.bone=null,me.prototype.dispose.call(this))},H}(x),f=u(443),d=u(438),g=u(449),p=u(445);Object.defineProperty(g.a.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new m(this)),this._debugLayer},enumerable:!0,configurable:!0});var _;(function(me){me[me.Properties=0]="Properties",me[me.Debug=1]="Debug",me[me.Statistics=2]="Statistics",me[me.Tools=3]="Tools",me[me.Settings=4]="Settings"})(_||(_={}));var m=function(){function me(H){var q=this;this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=H,this._scene.onDisposeObservable.add(function(){q._scene._debugLayer&&q._scene._debugLayer.hide()})}return Object.defineProperty(me.prototype,"onPropertyChangedObservable",{get:function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new d.c),this._onPropertyChangedObservable)},enumerable:!1,configurable:!0}),me.prototype._createInspector=function(H){if(!this.isVisible()){if(this._onPropertyChangedObservable){for(var q=0,_e=this._onPropertyChangedObservable.observers;q<_e.length;q++){var Ee=_e[q];this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(Ee)}this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}var Te=Object(G.a)({overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0},H);this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,Te)}},me.prototype.select=function(H,q){this.BJSINSPECTOR&&(q&&(Object.prototype.toString.call(q)=="[object String]"?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(q):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(q)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(H))},me.prototype._getGlobalInspector=function(){if(typeof INSPECTOR!="undefined")return INSPECTOR;if(typeof BABYLON!="undefined"&&typeof BABYLON.Inspector!="undefined")return BABYLON},me.prototype.isVisible=function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible},me.prototype.hide=function(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()},me.prototype.setAsActiveScene=function(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)},me.prototype.show=function(H){var q=this;return new Promise(function(_e,Ee){if(typeof q.BJSINSPECTOR=="undefined"){var Te=H&&H.inspectorURL?H.inspectorURL:me.InspectorURL;f.b.LoadScript(Te,function(){q._createInspector(H),_e(q)})}else q._createInspector(H),_e(q)})},me.InspectorURL="https://unpkg.com/babylonjs-inspector@"+p.a.Version+"/babylon.inspector.bundle.js",me}(),l=u(446),y=u(495),E=u(470),A=u(448),F=u(503),B=u(461),L=u(494),I=function(){function me(H){this._impostors=[],this._meshes=[],this._numMeshes=0,this._debugMeshMeshes=new Array,this._scene=H||A.a.LastCreatedScene;var q=this._scene.getPhysicsEngine();q&&(this._physicsEnginePlugin=q.getPhysicsPlugin()),this._utilityLayer=new B.a(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0}return me.prototype._updateDebugMeshes=function(){for(var H=this._physicsEnginePlugin,q=0;q<this._numMeshes;q++){var _e=this._impostors[q];if(!!_e)if(_e.isDisposed)this.hideImpostor(this._impostors[q--]);else{if(_e.type===F.a.MeshImpostor)continue;var Ee=this._meshes[q];Ee&&H&&H.syncMeshWithImpostor(Ee,_e)}}},me.prototype.showImpostor=function(H,q){if(!this._scene)return null;for(var _e=0;_e<this._numMeshes;_e++)if(this._impostors[_e]==H)return null;var Ee=this._getDebugMesh(H,q);return Ee&&(this._impostors[this._numMeshes]=H,this._meshes[this._numMeshes]=Ee,this._numMeshes===0&&(this._renderFunction=this._updateDebugMeshes.bind(this),this._scene.registerBeforeRender(this._renderFunction)),this._numMeshes++),Ee},me.prototype.hideImpostor=function(H){if(!(!H||!this._scene||!this._utilityLayer)){for(var q=!1,_e=this._utilityLayer.utilityLayerScene,Ee=0;Ee<this._numMeshes;Ee++)if(this._impostors[Ee]==H){var Te=this._meshes[Ee];if(!Te)continue;_e.removeMesh(Te),Te.dispose();var se=this._debugMeshMeshes.indexOf(Te);se>-1&&this._debugMeshMeshes.splice(se,1),this._numMeshes--,this._numMeshes>0?(this._meshes[Ee]=this._meshes[this._numMeshes],this._impostors[Ee]=this._impostors[this._numMeshes],this._meshes[this._numMeshes]=null,this._impostors[this._numMeshes]=null):(this._meshes[0]=null,this._impostors[0]=null),q=!0;break}q&&this._numMeshes===0&&this._scene.unregisterBeforeRender(this._renderFunction)}},me.prototype._getDebugMaterial=function(H){return this._debugMaterial||(this._debugMaterial=new R.a("",H),this._debugMaterial.wireframe=!0,this._debugMaterial.emissiveColor=O.a.White(),this._debugMaterial.disableLighting=!0),this._debugMaterial},me.prototype._getDebugBoxMesh=function(H){return this._debugBoxMesh||(this._debugBoxMesh=y.a.CreateBox("physicsBodyBoxViewMesh",{size:1},H),this._debugBoxMesh.rotationQuaternion=S.b.Identity(),this._debugBoxMesh.material=this._getDebugMaterial(H),this._debugBoxMesh.setEnabled(!1)),this._debugBoxMesh.createInstance("physicsBodyBoxViewInstance")},me.prototype._getDebugSphereMesh=function(H){return this._debugSphereMesh||(this._debugSphereMesh=E.a.CreateSphere("physicsBodySphereViewMesh",{diameter:1},H),this._debugSphereMesh.rotationQuaternion=S.b.Identity(),this._debugSphereMesh.material=this._getDebugMaterial(H),this._debugSphereMesh.setEnabled(!1)),this._debugSphereMesh.createInstance("physicsBodyBoxViewInstance")},me.prototype._getDebugCylinderMesh=function(H){return this._debugCylinderMesh||(this._debugCylinderMesh=L.a.CreateCylinder("physicsBodyCylinderViewMesh",{diameterTop:1,diameterBottom:1,height:1},H),this._debugCylinderMesh.rotationQuaternion=S.b.Identity(),this._debugCylinderMesh.material=this._getDebugMaterial(H),this._debugCylinderMesh.setEnabled(!1)),this._debugCylinderMesh.createInstance("physicsBodyBoxViewInstance")},me.prototype._getDebugMeshMesh=function(H,q){var _e=new l.a(H.name,q,null,H);return _e.position=S.e.Zero(),_e.setParent(H),_e.material=this._getDebugMaterial(q),this._debugMeshMeshes.push(_e),_e},me.prototype._getDebugMesh=function(H,q){var _e=this;if(!this._utilityLayer||q&&q.parent&&q.parent.physicsImpostor)return null;var Ee=null,Te=this._utilityLayer.utilityLayerScene;switch(H.type){case F.a.BoxImpostor:Ee=this._getDebugBoxMesh(Te),H.getBoxSizeToRef(Ee.scaling);break;case F.a.SphereImpostor:Ee=this._getDebugSphereMesh(Te);var se=H.getRadius();Ee.scaling.x=se*2,Ee.scaling.y=se*2,Ee.scaling.z=se*2;break;case F.a.MeshImpostor:q&&(Ee=this._getDebugMeshMesh(q,Te));break;case F.a.NoImpostor:if(q){var ve=q.getChildMeshes().filter(function(Le){return Le.physicsImpostor?1:0});ve.forEach(function(Le){var be=_e._getDebugBoxMesh(Te);be.parent=Le})}break;case F.a.CylinderImpostor:Ee=this._getDebugCylinderMesh(Te);var ye=H.object.getBoundingInfo();Ee.scaling.x=ye.boundingBox.maximum.x-ye.boundingBox.minimum.x,Ee.scaling.y=ye.boundingBox.maximum.y-ye.boundingBox.minimum.y,Ee.scaling.z=ye.boundingBox.maximum.z-ye.boundingBox.minimum.z;break}return Ee},me.prototype.dispose=function(){for(var H=this._numMeshes,q=0;q<H;q++)this.hideImpostor(this._impostors[0]);this._debugBoxMesh&&this._debugBoxMesh.dispose(),this._debugSphereMesh&&this._debugSphereMesh.dispose(),this._debugCylinderMesh&&this._debugCylinderMesh.dispose(),this._debugMaterial&&this._debugMaterial.dispose(),this._impostors.length=0,this._scene=null,this._physicsEnginePlugin=null,this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null)},me}(),z=u(493),k=function(){function me(H){this.ray=H}return me.CreateAndShow=function(H,q,_e){var Ee=new me(H);return Ee.show(q,_e),Ee},me.prototype.show=function(H,q){if(!this._renderFunction&&this.ray){var _e=this.ray;this._renderFunction=this._render.bind(this),this._scene=H,this._renderPoints=[_e.origin,_e.origin.add(_e.direction.scale(_e.length))],this._renderLine=l.a.CreateLines("ray",this._renderPoints,H,!0),this._renderLine.isPickable=!1,this._renderFunction&&this._scene.registerBeforeRender(this._renderFunction)}q&&this._renderLine&&this._renderLine.color.copyFrom(q)},me.prototype.hide=function(){this._renderFunction&&this._scene&&(this._scene.unregisterBeforeRender(this._renderFunction),this._scene=null,this._renderFunction=null,this._renderLine&&(this._renderLine.dispose(),this._renderLine=null),this._renderPoints=[])},me.prototype._render=function(){var H=this.ray;if(!!H){var q=this._renderPoints[1],_e=Math.min(H.length,1e6);q.copyFrom(H.direction),q.scaleInPlace(_e),q.addInPlace(H.origin),this._renderPoints[0].copyFrom(H.origin),l.a.CreateLines("ray",this._renderPoints,this._scene,!0,this._renderLine)}},me.prototype.attachToMesh=function(H,q,_e,Ee){var Te=this;this._attachedToMesh=H;var se=this.ray;!se||(se.direction||(se.direction=S.e.Zero()),se.origin||(se.origin=S.e.Zero()),Ee&&(se.length=Ee),_e||(_e=S.e.Zero()),q||(q=new S.e(0,0,-1)),this._scene||(this._scene=H.getScene()),this._meshSpaceDirection?(this._meshSpaceDirection.copyFrom(q),this._meshSpaceOrigin.copyFrom(_e)):(this._meshSpaceDirection=q.clone(),this._meshSpaceOrigin=_e.clone()),this._onAfterRenderObserver||(this._onAfterRenderObserver=this._scene.onBeforeRenderObservable.add(function(){return Te._updateToMesh()}),this._onAfterStepObserver=this._scene.onAfterStepObservable.add(function(){return Te._updateToMesh()})),this._attachedToMesh.computeWorldMatrix(!0),this._updateToMesh())},me.prototype.detachFromMesh=function(){this._attachedToMesh&&this._scene&&(this._onAfterRenderObserver&&(this._scene.onBeforeRenderObservable.remove(this._onAfterRenderObserver),this._scene.onAfterStepObservable.remove(this._onAfterStepObserver)),this._attachedToMesh=null,this._onAfterRenderObserver=null,this._onAfterStepObserver=null,this._scene=null)},me.prototype._updateToMesh=function(){var H=this.ray;if(!(!this._attachedToMesh||!H)){if(this._attachedToMesh._isDisposed){this.detachFromMesh();return}this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,H.direction),S.e.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),H.origin)}},me.prototype.dispose=function(){this.hide(),this.detachFromMesh(),this.ray=null},me}(),j=u(459),w=u(509),Q=u(479),W=u(447),Y=u(435),he=u(617),le=function(){function me(H,q,_e,Ee,Te,se){Ee===void 0&&(Ee=!0),Te===void 0&&(Te=3),se===void 0&&(se={});var ve,ye,Le,be,ze,Ye,He,Ue,re,Z,fe,ue,Ge,xe;this.skeleton=H,this.mesh=q,this.autoUpdateBonesMatrices=Ee,this.renderingGroupId=Te,this.options=se,this.color=O.a.White(),this._debugLines=new Array,this._localAxes=null,this._isEnabled=!1,this._obs=null,this._scene=_e,this._ready=!1,se.pauseAnimations=(ve=se.pauseAnimations)!==null&&ve!==void 0?ve:!0,se.returnToRest=(ye=se.returnToRest)!==null&&ye!==void 0?ye:!1,se.displayMode=(Le=se.displayMode)!==null&&Le!==void 0?Le:me.DISPLAY_LINES,se.displayOptions=(be=se.displayOptions)!==null&&be!==void 0?be:{},se.displayOptions.midStep=(ze=se.displayOptions.midStep)!==null&&ze!==void 0?ze:.235,se.displayOptions.midStepFactor=(Ye=se.displayOptions.midStepFactor)!==null&&Ye!==void 0?Ye:.155,se.displayOptions.sphereBaseSize=(He=se.displayOptions.sphereBaseSize)!==null&&He!==void 0?He:.15,se.displayOptions.sphereScaleUnit=(Ue=se.displayOptions.sphereScaleUnit)!==null&&Ue!==void 0?Ue:2,se.displayOptions.sphereFactor=(re=se.displayOptions.sphereFactor)!==null&&re!==void 0?re:.865,se.displayOptions.spurFollowsChild=(Z=se.displayOptions.spurFollowsChild)!==null&&Z!==void 0?Z:!1,se.displayOptions.showLocalAxes=(fe=se.displayOptions.showLocalAxes)!==null&&fe!==void 0?fe:!1,se.displayOptions.localAxesSize=(ue=se.displayOptions.localAxesSize)!==null&&ue!==void 0?ue:.075,se.computeBonesUsingShaders=(Ge=se.computeBonesUsingShaders)!==null&&Ge!==void 0?Ge:!0,se.useAllBones=(xe=se.useAllBones)!==null&&xe!==void 0?xe:!0;var ne=q.getVerticesData(W.b.MatricesIndicesKind),Ke=q.getVerticesData(W.b.MatricesWeightsKind);if(this._boneIndices=new Set,!se.useAllBones&&ne&&Ke)for(var nt=0;nt<ne.length;++nt){var ut=ne[nt],pt=Ke[nt];pt!==0&&this._boneIndices.add(ut)}this._utilityLayer=new B.a(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;var Tt=this.options.displayMode||0;Tt>me.DISPLAY_SPHERE_AND_SPURS&&(Tt=me.DISPLAY_LINES),this.displayMode=Tt,this.update(),this._bindObs()}return me.CreateBoneWeightShader=function(H,q){var _e,Ee,Te,se,ve,ye,Le=H.skeleton,be=(_e=H.colorBase)!==null&&_e!==void 0?_e:O.a.Black(),ze=(Ee=H.colorZero)!==null&&Ee!==void 0?Ee:O.a.Blue(),Ye=(Te=H.colorQuarter)!==null&&Te!==void 0?Te:O.a.Green(),He=(se=H.colorHalf)!==null&&se!==void 0?se:O.a.Yellow(),Ue=(ve=H.colorFull)!==null&&ve!==void 0?ve:O.a.Red(),re=(ye=H.targetBoneIndex)!==null&&ye!==void 0?ye:0;Y.a.ShadersStore["boneWeights:"+Le.name+"VertexShader"]=`precision highp float;

        attribute vec3 position;
        attribute vec2 uv;

        uniform mat4 view;
        uniform mat4 projection;
        uniform mat4 worldViewProjection;

        #include<bonesDeclaration>
        #if NUM_BONE_INFLUENCERS == 0
            attribute vec4 matricesIndices;
            attribute vec4 matricesWeights;
        #endif

        #include<instancesDeclaration>

        varying vec3 vColor;

        uniform vec3 colorBase;
        uniform vec3 colorZero;
        uniform vec3 colorQuarter;
        uniform vec3 colorHalf;
        uniform vec3 colorFull;

        uniform float targetBoneIndex;

        void main() {
            vec3 positionUpdated = position;

            #include<instancesVertex>
            #include<bonesVertex>

            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);

            vec3 color = colorBase;
            float totalWeight = 0.;
            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){
                totalWeight += matricesWeights[0];
            }
            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){
                totalWeight += matricesWeights[1];
            }
            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){
                totalWeight += matricesWeights[2];
            }
            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){
                totalWeight += matricesWeights[3];
            }

            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));
            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));
            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));
            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));
            vColor = color;

        gl_Position = projection * view * worldPos;
        }`,Y.a.ShadersStore["boneWeights:"+Le.name+"FragmentShader"]=`
            precision highp float;
            varying vec3 vPosition;

            varying vec3 vColor;

            void main() {
                vec4 color = vec4(vColor, 1.0);
                gl_FragColor = color;
            }
        `;var Z=new w.a("boneWeight:"+Le.name,q,{vertex:"boneWeights:"+Le.name,fragment:"boneWeights:"+Le.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return Z.setColor3("colorBase",be),Z.setColor3("colorZero",ze),Z.setColor3("colorQuarter",Ye),Z.setColor3("colorHalf",He),Z.setColor3("colorFull",Ue),Z.setFloat("targetBoneIndex",re),Z.getClassName=function(){return"BoneWeightShader"},Z.transparencyMode=j.a.MATERIAL_OPAQUE,Z},me.CreateSkeletonMapShader=function(H,q){var _e,Ee=H.skeleton,Te=(_e=H.colorMap)!==null&&_e!==void 0?_e:[{color:new O.a(1,.38,.18),location:0},{color:new O.a(.59,.18,1),location:.2},{color:new O.a(.59,1,.18),location:.4},{color:new O.a(1,.87,.17),location:.6},{color:new O.a(1,.17,.42),location:.8},{color:new O.a(.17,.68,1),location:1}],se=Ee.bones.length+1,ve=me._CreateBoneMapColorBuffer(se,Te,q),ye=new w.a("boneWeights:"+Ee.name,q,{vertexSource:`precision highp float;

            attribute vec3 position;
            attribute vec2 uv;

            uniform mat4 view;
            uniform mat4 projection;
            uniform mat4 worldViewProjection;
            uniform float colorMap[`+Ee.bones.length*4+`];

            #include<bonesDeclaration>
            #if NUM_BONE_INFLUENCERS == 0
                attribute vec4 matricesIndices;
                attribute vec4 matricesWeights;
            #endif
            #include<instancesDeclaration>

            varying vec3 vColor;

            void main() {
                vec3 positionUpdated = position;

                #include<instancesVertex>
                #include<bonesVertex>

                vec3 color = vec3(0.);
                bool first = true;

                for (int i = 0; i < 4; i++) {
                    int boneIdx = int(matricesIndices[i]);
                    float boneWgt = matricesWeights[i];

                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);

                    if (boneWgt > 0.) {
                        if (first) {
                            first = false;
                            color = c;
                        } else {
                            color = mix(color, c, boneWgt);
                        }
                    }
                }

                vColor = color;

                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);

                gl_Position = projection * view * worldPos;
            }`,fragmentSource:`
            precision highp float;
            varying vec3 vColor;

            void main() {
                vec4 color = vec4( vColor, 1.0 );
                gl_FragColor = color;
            }
            `},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return ye.setFloats("colorMap",ve),ye.getClassName=function(){return"SkeletonMapShader"},ye.transparencyMode=j.a.MATERIAL_OPAQUE,ye},me._CreateBoneMapColorBuffer=function(H,q,_e){var Ee=new Q.a("temp",{width:H,height:1},_e,!1),Te=Ee.getContext(),se=Te.createLinearGradient(0,0,H,0);q.forEach(function(ze){se.addColorStop(ze.location,ze.color.toHexString())}),Te.fillStyle=se,Te.fillRect(0,0,H,1),Ee.update();for(var ve=[],ye=Te.getImageData(0,0,H,1).data,Le=1/255,be=0;be<ye.length;be++)ve.push(ye[be]*Le);return Ee.dispose(),ve},Object.defineProperty(me.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"utilityLayer",{get:function(){return this._utilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"isReady",{get:function(){return this._ready},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"ready",{set:function(H){this._ready=H},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"debugMesh",{get:function(){return this._debugMesh},set:function(H){this._debugMesh=H},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"displayMode",{get:function(){return this.options.displayMode||me.DISPLAY_LINES},set:function(H){H>me.DISPLAY_SPHERE_AND_SPURS&&(H=me.DISPLAY_LINES),this.options.displayMode=H},enumerable:!1,configurable:!0}),me.prototype._bindObs=function(){var H=this;switch(this.displayMode){case me.DISPLAY_LINES:{this._obs=this.scene.onBeforeRenderObservable.add(function(){H._displayLinesUpdate()});break}}},me.prototype.update=function(){switch(this.displayMode){case me.DISPLAY_LINES:{this._displayLinesUpdate();break}case me.DISPLAY_SPHERES:{this._buildSpheresAndSpurs(!0);break}case me.DISPLAY_SPHERE_AND_SPURS:{this._buildSpheresAndSpurs(!1);break}}this._buildLocalAxes()},Object.defineProperty(me.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(H){this.isEnabled!==H&&(this._isEnabled=H,this.debugMesh&&this.debugMesh.setEnabled(H),H&&!this._obs?this._bindObs():!H&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))},enumerable:!1,configurable:!0}),me.prototype._getBonePosition=function(H,q,_e,Ee,Te,se){Ee===void 0&&(Ee=0),Te===void 0&&(Te=0),se===void 0&&(se=0);var ve=S.c.Matrix[0],ye=q.getParent();if(ve.copyFrom(q.getLocalMatrix()),Ee!==0||Te!==0||se!==0){var Le=S.c.Matrix[1];S.a.IdentityToRef(Le),Le.setTranslationFromFloats(Ee,Te,se),Le.multiplyToRef(ve,ve)}ye&&ve.multiplyToRef(ye.getAbsoluteTransform(),ve),ve.multiplyToRef(_e,ve),H.x=ve.m[12],H.y=ve.m[13],H.z=ve.m[14]},me.prototype._getLinesForBonesWithLength=function(H,q){for(var _e=H.length,Ee=this.mesh._effectiveMesh,Te=Ee.position,se=0,ve=0;ve<_e;ve++){var ye=H[ve],Le=this._debugLines[se];ye._index===-1||!this._boneIndices.has(ye.getIndex())&&!this.options.useAllBones||(Le||(Le=[S.e.Zero(),S.e.Zero()],this._debugLines[se]=Le),this._getBonePosition(Le[0],ye,q),this._getBonePosition(Le[1],ye,q,0,ye.length,0),Le[0].subtractInPlace(Te),Le[1].subtractInPlace(Te),se++)}},me.prototype._getLinesForBonesNoLength=function(H){for(var q=H.length,_e=0,Ee=this.mesh._effectiveMesh,Te=Ee.position,se=q-1;se>=0;se--){var ve=H[se],ye=ve.getParent();if(!(!ye||!this._boneIndices.has(ve.getIndex())&&!this.options.useAllBones)){var Le=this._debugLines[_e];Le||(Le=[S.e.Zero(),S.e.Zero()],this._debugLines[_e]=Le),ve.getAbsolutePositionToRef(Ee,Le[0]),ye.getAbsolutePositionToRef(Ee,Le[1]),Le[0].subtractInPlace(Te),Le[1].subtractInPlace(Te),_e++}}},me.prototype._revert=function(H){this.options.pauseAnimations&&(this.scene.animationsEnabled=H,this.utilityLayer.utilityLayerScene.animationsEnabled=H)},me.prototype._getAbsoluteBindPoseToRef=function(H,q){if(H===null||H._index===-1){q.copyFrom(S.a.Identity());return}this._getAbsoluteBindPoseToRef(H.getParent(),q),H.getBindPose().multiplyToRef(q,q)},me.prototype._buildSpheresAndSpurs=function(H){var q,_e;H===void 0&&(H=!0),this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;var Ee=(q=this.utilityLayer)===null||q===void 0?void 0:q.utilityLayerScene,Te=this.skeleton.bones,se=[],ve=[],ye=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,Ee.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms();for(var Le=Number.NEGATIVE_INFINITY,be=this.options.displayOptions||{},ze=function(ut){var pt=Te[ut];if(pt._index===-1||!Ye._boneIndices.has(pt.getIndex())&&!Ye.options.useAllBones)return"continue";var Tt=new S.a;Ye._getAbsoluteBindPoseToRef(pt,Tt);var de=new S.e;Tt.decompose(void 0,void 0,de),pt.children.forEach(function(zi,li){var Di=new S.a;zi.getBindPose().multiplyToRef(Tt,Di);var Qt=new S.e;Di.decompose(void 0,void 0,Qt);var _i=S.e.Distance(de,Qt);if(_i>Le&&(Le=_i),!H){for(var ji=Qt.clone().subtract(de.clone()),yi=ji.length(),ai=ji.normalize().scale(yi),Ei=be.midStep||.165,Ut=be.midStepFactor||.215,wi=ai.scale(Ei),ui=he.a.ExtrudeShapeCustom("skeletonViewer",{shape:[new S.e(1,-1,0),new S.e(1,1,0),new S.e(-1,1,0),new S.e(-1,-1,0),new S.e(1,-1,0)],path:[S.e.Zero(),wi,ai],scaleFunction:function(Ji){switch(Ji){case 0:case 2:return 0;case 1:return yi*Ut}return 0},sideOrientation:l.a.DEFAULTSIDE,updatable:!1},Ee),Wi=ui.getTotalVertices(),Hi=[],Pi=[],xt=0;xt<Wi;xt++)Hi.push(1,0,0,0),be.spurFollowsChild&&xt>9?Pi.push(zi.getIndex(),0,0,0):Pi.push(pt.getIndex(),0,0,0);ui.position=de.clone(),ui.setVerticesData(W.b.MatricesWeightsKind,Hi,!1),ui.setVerticesData(W.b.MatricesIndicesKind,Pi,!1),ui.convertToFlatShadedMesh(),ve.push(ui)}});for(var Ft=be.sphereBaseSize||.2,Jt=E.a.CreateSphere("skeletonViewer",{segments:6,diameter:Ft,updatable:!0},Ee),Dt=Jt.getTotalVertices(),Xt=[],Kt=[],Zi=0;Zi<Dt;Zi++)Xt.push(1,0,0,0),Kt.push(pt.getIndex(),0,0,0);Jt.setVerticesData(W.b.MatricesWeightsKind,Xt,!1),Jt.setVerticesData(W.b.MatricesIndicesKind,Kt,!1),Jt.position=de.clone(),se.push([Jt,pt])},Ye=this,He=0;He<Te.length;He++)ze(He);for(var Ue=be.sphereScaleUnit||2,re=be.sphereFactor||.85,Z=[],He=0;He<se.length;He++){for(var fe=se[He],ue=fe[0],Ge=fe[1],xe=1/(Ue/Le),ne=0,Ke=Ge;Ke.getParent()&&Ke.getParent().getIndex()!==-1;)ne++,Ke=Ke.getParent();ue.scaling.scaleInPlace(xe*Math.pow(re,ne)),Z.push(ue)}this.debugMesh=l.a.MergeMeshes(Z.concat(ve),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=(_e=this.options.computeBonesUsingShaders)!==null&&_e!==void 0?_e:!0,this.debugMesh.alwaysSelectAsActiveMesh=!0);var nt=this.utilityLayer._getSharedGizmoLight();nt.intensity=.7,this._revert(ye),this.ready=!0}catch(ut){console.error(ut),this._revert(ye),this.dispose()}},me.prototype._buildLocalAxes=function(){var H;this._localAxes&&this._localAxes.dispose(),this._localAxes=null;var q=this.options.displayOptions||{};if(!!q.showLocalAxes){var _e=this._utilityLayer.utilityLayerScene,Ee=q.localAxesSize||.075,Te=[],se=[],ve=new O.b(1,0,0,1),ye=new O.b(0,1,0,1),Le=new O.b(0,0,1,1),be=[],ze=[],Ye=6;for(var He in this.skeleton.bones){var Ue=this.skeleton.bones[He];if(!(Ue._index===-1||!this._boneIndices.has(Ue.getIndex())&&!this.options.useAllBones)){var re=new S.a,Z=new S.e;this._getAbsoluteBindPoseToRef(Ue,re),re.decompose(void 0,void 0,Z);var fe=Ue.getBindPose().getRotationMatrix(),ue=S.e.TransformCoordinates(new S.e(0+Ee,0,0),fe),Ge=S.e.TransformCoordinates(new S.e(0,0+Ee,0),fe),xe=S.e.TransformCoordinates(new S.e(0,0,0+Ee),fe),ne=[Z,Z.add(ue)],Ke=[Z,Z.add(Ge)],nt=[Z,Z.add(xe)],ut=[ne,Ke,nt],pt=[[ve,ve],[ye,ye],[Le,Le]];Te.push.apply(Te,ut),se.push.apply(se,pt);for(var Tt=0;Tt<Ye;Tt++)be.push(1,0,0,0),ze.push(Ue.getIndex(),0,0,0)}}this._localAxes=z.a.CreateLineSystem("localAxes",{lines:Te,colors:se,updatable:!0},_e),this._localAxes.setVerticesData(W.b.MatricesWeightsKind,be,!1),this._localAxes.setVerticesData(W.b.MatricesIndicesKind,ze,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=(H=this.options.computeBonesUsingShaders)!==null&&H!==void 0?H:!0}},me.prototype._displayLinesUpdate=function(){if(!!this._utilityLayer){this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms();var H=this.mesh._effectiveMesh;this.skeleton.bones[0].length===void 0?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,H.getWorldMatrix());var q=this._utilityLayer.utilityLayerScene;q&&(this._debugMesh?z.a.CreateLineSystem("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},q):(this._debugMesh=z.a.CreateLineSystem("",{lines:this._debugLines,updatable:!0,instance:null},q),this._debugMesh.renderingGroupId=this.renderingGroupId),this._debugMesh.position.copyFrom(this.mesh.position),this._debugMesh.color=this.color)}},me.prototype.changeDisplayMode=function(H){var q=!!this.isEnabled;this.displayMode!==H&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=H,this.update(),this._bindObs(),this.isEnabled=q)},me.prototype.changeDisplayOptions=function(H,q){var _e=!!this.isEnabled;this.options.displayOptions[H]=q,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=_e},me.prototype.dispose=function(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1},me.DISPLAY_LINES=0,me.DISPLAY_SPHERES=1,me.DISPLAY_SPHERE_AND_SPURS=2,me}(),J=u(485),Re=u(499),Me=function(){function me(H,q){this._oldPosition=new S.e(Number.NaN,Number.NaN,Number.NaN),this._oldDirection=new S.e(Number.NaN,Number.NaN,Number.NaN),this._transparency=.3,this._showLines=!0,this._showPlanes=!0,this._scene=H.getScene(),this._light=H,this._camera=q,this._inverseViewMatrix=S.a.Identity(),this._lightHelperFrustumMeshes=[],this._createGeometry(),this.show(),this.update()}return Object.defineProperty(me.prototype,"transparency",{get:function(){return this._transparency},set:function(H){this._transparency=H;for(var q=6;q<12;++q)this._lightHelperFrustumMeshes[q].material.alpha=H},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"showLines",{get:function(){return this._showLines},set:function(H){if(this._showLines!==H){this._showLines=H;for(var q=0;q<6;++q)this._lightHelperFrustumMeshes[q].setEnabled(H)}},enumerable:!1,configurable:!0}),Object.defineProperty(me.prototype,"showPlanes",{get:function(){return this._showPlanes},set:function(H){if(this._showPlanes!==H){this._showPlanes=H;for(var q=6;q<12;++q)this._lightHelperFrustumMeshes[q].setEnabled(H)}},enumerable:!1,configurable:!0}),me.prototype.show=function(){var H=this;this._lightHelperFrustumMeshes.forEach(function(q,_e){q.setEnabled(_e<6&&H._showLines||_e>=6&&H._showPlanes)}),this._oldPosition.set(Number.NaN,Number.NaN,Number.NaN),this._visible=!0},me.prototype.hide=function(){this._lightHelperFrustumMeshes.forEach(function(H){H.setEnabled(!1)}),this._visible=!1},me.prototype.update=function(){var H,q,_e,Ee,Te,se;if(!!this._visible&&!(this._oldPosition.equals(this._light.position)&&this._oldDirection.equals(this._light.direction)&&this._oldAutoCalc===this._light.autoCalcShadowZBounds&&this._oldMinZ===this._light.shadowMinZ&&this._oldMaxZ===this._light.shadowMaxZ)){this._oldPosition.copyFrom(this._light.position),this._oldDirection.copyFrom(this._light.direction),this._oldAutoCalc=this._light.autoCalcShadowZBounds,this._oldMinZ=this._light.shadowMinZ,this._oldMaxZ=this._light.shadowMaxZ,S.c.Vector3[0].set(this._light.orthoLeft,this._light.orthoBottom,this._light.shadowMinZ!==void 0?this._light.shadowMinZ:this._camera.minZ),S.c.Vector3[1].set(this._light.orthoRight,this._light.orthoTop,this._light.shadowMaxZ!==void 0?this._light.shadowMaxZ:this._camera.maxZ);var ve=this._getInvertViewMatrix();S.c.Vector3[2].copyFromFloats(S.c.Vector3[1].x,S.c.Vector3[1].y,S.c.Vector3[0].z),S.c.Vector3[3].copyFromFloats(S.c.Vector3[1].x,S.c.Vector3[0].y,S.c.Vector3[0].z),S.c.Vector3[4].copyFromFloats(S.c.Vector3[0].x,S.c.Vector3[0].y,S.c.Vector3[0].z),S.c.Vector3[5].copyFromFloats(S.c.Vector3[0].x,S.c.Vector3[1].y,S.c.Vector3[0].z),S.e.TransformCoordinatesToRef(S.c.Vector3[2],ve,S.c.Vector3[2]),S.e.TransformCoordinatesToRef(S.c.Vector3[3],ve,S.c.Vector3[3]),S.e.TransformCoordinatesToRef(S.c.Vector3[4],ve,S.c.Vector3[4]),S.e.TransformCoordinatesToRef(S.c.Vector3[5],ve,S.c.Vector3[5]),S.c.Vector3[6].copyFromFloats(S.c.Vector3[1].x,S.c.Vector3[1].y,S.c.Vector3[1].z),S.c.Vector3[7].copyFromFloats(S.c.Vector3[1].x,S.c.Vector3[0].y,S.c.Vector3[1].z),S.c.Vector3[8].copyFromFloats(S.c.Vector3[0].x,S.c.Vector3[0].y,S.c.Vector3[1].z),S.c.Vector3[9].copyFromFloats(S.c.Vector3[0].x,S.c.Vector3[1].y,S.c.Vector3[1].z),S.e.TransformCoordinatesToRef(S.c.Vector3[6],ve,S.c.Vector3[6]),S.e.TransformCoordinatesToRef(S.c.Vector3[7],ve,S.c.Vector3[7]),S.e.TransformCoordinatesToRef(S.c.Vector3[8],ve,S.c.Vector3[8]),S.e.TransformCoordinatesToRef(S.c.Vector3[9],ve,S.c.Vector3[9]),z.a.CreateLines("nearlines",{updatable:!0,points:this._nearLinesPoints,instance:this._lightHelperFrustumMeshes[0]},this._scene),z.a.CreateLines("farlines",{updatable:!0,points:this._farLinesPoints,instance:this._lightHelperFrustumMeshes[1]},this._scene),z.a.CreateLines("trlines",{updatable:!0,points:this._trLinesPoints,instance:this._lightHelperFrustumMeshes[2]},this._scene),z.a.CreateLines("brlines",{updatable:!0,points:this._brLinesPoints,instance:this._lightHelperFrustumMeshes[3]},this._scene),z.a.CreateLines("tllines",{updatable:!0,points:this._tlLinesPoints,instance:this._lightHelperFrustumMeshes[4]},this._scene),z.a.CreateLines("bllines",{updatable:!0,points:this._blLinesPoints,instance:this._lightHelperFrustumMeshes[5]},this._scene),S.c.Vector3[2].toArray(this._nearPlaneVertices,0),S.c.Vector3[3].toArray(this._nearPlaneVertices,3),S.c.Vector3[4].toArray(this._nearPlaneVertices,6),S.c.Vector3[5].toArray(this._nearPlaneVertices,9),(H=this._lightHelperFrustumMeshes[6].geometry)===null||H===void 0||H.updateVerticesDataDirectly("position",this._nearPlaneVertices,0),S.c.Vector3[6].toArray(this._farPlaneVertices,0),S.c.Vector3[7].toArray(this._farPlaneVertices,3),S.c.Vector3[8].toArray(this._farPlaneVertices,6),S.c.Vector3[9].toArray(this._farPlaneVertices,9),(q=this._lightHelperFrustumMeshes[7].geometry)===null||q===void 0||q.updateVerticesDataDirectly("position",this._farPlaneVertices,0),S.c.Vector3[2].toArray(this._rightPlaneVertices,0),S.c.Vector3[6].toArray(this._rightPlaneVertices,3),S.c.Vector3[7].toArray(this._rightPlaneVertices,6),S.c.Vector3[3].toArray(this._rightPlaneVertices,9),(_e=this._lightHelperFrustumMeshes[8].geometry)===null||_e===void 0||_e.updateVerticesDataDirectly("position",this._rightPlaneVertices,0),S.c.Vector3[5].toArray(this._leftPlaneVertices,0),S.c.Vector3[9].toArray(this._leftPlaneVertices,3),S.c.Vector3[8].toArray(this._leftPlaneVertices,6),S.c.Vector3[4].toArray(this._leftPlaneVertices,9),(Ee=this._lightHelperFrustumMeshes[9].geometry)===null||Ee===void 0||Ee.updateVerticesDataDirectly("position",this._leftPlaneVertices,0),S.c.Vector3[2].toArray(this._topPlaneVertices,0),S.c.Vector3[6].toArray(this._topPlaneVertices,3),S.c.Vector3[9].toArray(this._topPlaneVertices,6),S.c.Vector3[5].toArray(this._topPlaneVertices,9),(Te=this._lightHelperFrustumMeshes[10].geometry)===null||Te===void 0||Te.updateVerticesDataDirectly("position",this._topPlaneVertices,0),S.c.Vector3[3].toArray(this._bottomPlaneVertices,0),S.c.Vector3[7].toArray(this._bottomPlaneVertices,3),S.c.Vector3[8].toArray(this._bottomPlaneVertices,6),S.c.Vector3[4].toArray(this._bottomPlaneVertices,9),(se=this._lightHelperFrustumMeshes[11].geometry)===null||se===void 0||se.updateVerticesDataDirectly("position",this._bottomPlaneVertices,0)}},me.prototype.dispose=function(){this._lightHelperFrustumMeshes.forEach(function(H){var q;(q=H.material)===null||q===void 0||q.dispose(),H.dispose()}),this._rootNode.dispose()},me.prototype._createGeometry=function(){var H=this;this._rootNode=new Re.a("directionalLightHelperRoot_"+this._light.name,this._scene),this._rootNode.parent=this._light.parent,this._nearLinesPoints=[S.e.ZeroReadOnly,S.e.ZeroReadOnly,S.e.ZeroReadOnly,S.e.ZeroReadOnly,S.e.ZeroReadOnly];var q=z.a.CreateLines("nearlines",{updatable:!0,points:this._nearLinesPoints},this._scene);q.parent=this._rootNode,q.alwaysSelectAsActiveMesh=!0,this._farLinesPoints=[S.e.ZeroReadOnly,S.e.ZeroReadOnly,S.e.ZeroReadOnly,S.e.ZeroReadOnly,S.e.ZeroReadOnly];var _e=z.a.CreateLines("farlines",{updatable:!0,points:this._farLinesPoints},this._scene);_e.parent=this._rootNode,_e.alwaysSelectAsActiveMesh=!0,this._trLinesPoints=[S.e.ZeroReadOnly,S.e.ZeroReadOnly];var Ee=z.a.CreateLines("trlines",{updatable:!0,points:this._trLinesPoints},this._scene);Ee.parent=this._rootNode,Ee.alwaysSelectAsActiveMesh=!0,this._brLinesPoints=[S.e.ZeroReadOnly,S.e.ZeroReadOnly];var Te=z.a.CreateLines("brlines",{updatable:!0,points:this._brLinesPoints},this._scene);Te.parent=this._rootNode,Te.alwaysSelectAsActiveMesh=!0,this._tlLinesPoints=[S.e.ZeroReadOnly,S.e.ZeroReadOnly];var se=z.a.CreateLines("tllines",{updatable:!0,points:this._tlLinesPoints},this._scene);se.parent=this._rootNode,se.alwaysSelectAsActiveMesh=!0,this._blLinesPoints=[S.e.ZeroReadOnly,S.e.ZeroReadOnly];var ve=z.a.CreateLines("bllines",{updatable:!0,points:this._blLinesPoints},this._scene);ve.parent=this._rootNode,ve.alwaysSelectAsActiveMesh=!0,this._lightHelperFrustumMeshes.push(q,_e,Ee,Te,se,ve);var ye=function(Le,be,ze){var Ye=new l.a(Le+"plane",H._scene),He=new R.a(Le+"PlaneMat",H._scene);Ye.material=He,Ye.parent=H._rootNode,Ye.alwaysSelectAsActiveMesh=!0,He.emissiveColor=be,He.alpha=H.transparency,He.backFaceCulling=!1,He.disableLighting=!0;var Ue=[0,1,2,0,2,3],re=new J.a;re.positions=ze,re.indices=Ue,re.applyToMesh(Ye,!0),H._lightHelperFrustumMeshes.push(Ye)};this._nearPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._farPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._rightPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._leftPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._topPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._bottomPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],ye("near",new O.a(1,0,0),this._nearPlaneVertices),ye("far",new O.a(.3,0,0),this._farPlaneVertices),ye("right",new O.a(0,1,0),this._rightPlaneVertices),ye("left",new O.a(0,.3,0),this._leftPlaneVertices),ye("top",new O.a(0,0,1),this._topPlaneVertices),ye("bottom",new O.a(0,0,.3),this._bottomPlaneVertices),this._nearLinesPoints[0]=S.c.Vector3[2],this._nearLinesPoints[1]=S.c.Vector3[3],this._nearLinesPoints[2]=S.c.Vector3[4],this._nearLinesPoints[3]=S.c.Vector3[5],this._nearLinesPoints[4]=S.c.Vector3[2],this._farLinesPoints[0]=S.c.Vector3[6],this._farLinesPoints[1]=S.c.Vector3[7],this._farLinesPoints[2]=S.c.Vector3[8],this._farLinesPoints[3]=S.c.Vector3[9],this._farLinesPoints[4]=S.c.Vector3[6],this._trLinesPoints[0]=S.c.Vector3[2],this._trLinesPoints[1]=S.c.Vector3[6],this._brLinesPoints[0]=S.c.Vector3[3],this._brLinesPoints[1]=S.c.Vector3[7],this._tlLinesPoints[0]=S.c.Vector3[4],this._tlLinesPoints[1]=S.c.Vector3[8],this._blLinesPoints[0]=S.c.Vector3[5],this._blLinesPoints[1]=S.c.Vector3[9]},me.prototype._getInvertViewMatrix=function(){return S.a.LookAtLHToRef(this._light.position,this._light.position.add(this._light.direction),S.e.UpReadOnly,this._inverseViewMatrix),this._inverseViewMatrix.invertToRef(this._inverseViewMatrix),this._inverseViewMatrix},me}()},679:function(we,P,u){"use strict";var S=u(435),R=u(535),U="bayerDitherFunctions",O=`




float bayerDither2(vec2 _P) {
return mod(2.0*_P.y+_P.x+1.0,4.0);
}


float bayerDither4(vec2 _P) {
vec2 P1=mod(_P,2.0);
vec2 P2=floor(0.5*mod(_P,4.0));
return 4.0*bayerDither2(P1)+bayerDither2(P2);
}

float bayerDither8(vec2 _P) {
vec2 P1=mod(_P,2.0);
vec2 P2=floor(0.5*mod(_P,4.0));
vec2 P4=floor(0.25*mod(_P,8.0));
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);
}
`;S.a.IncludesShadersStore[U]=O;var x={name:U,shader:O},G="shadowMapFragmentDeclaration",T=`#if SM_FLOAT == 0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW == 1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE == 1
uniform vec3 lightDataSM;
varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP == 1
varying float zSM;
#endif
`;S.a.IncludesShadersStore[G]=T;var h={name:G,shader:T},f=u(592),d=u(550),g="shadowMapFragment",p=` float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP == 1
#if SM_USEDISTANCE == 1
depthSM=clamp(((length(vPositionWSM-lightDataSM)+depthValuesSM.x)/(depthValuesSM.y))+biasAndScaleSM.x,0.0,1.0);
#else
depthSM=clamp(((zSM+depthValuesSM.x)/(depthValuesSM.y))+biasAndScaleSM.x,0.0,1.0);
#endif
gl_FragDepth=depthSM;
#elif SM_USEDISTANCE == 1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/(depthValuesSM.y)+biasAndScaleSM.x;
#endif
#if SM_ESM == 1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT == 1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;S.a.IncludesShadersStore[g]=p;var _={name:g,shader:p},m="shadowMapPixelShader",l=`#include<shadowMapFragmentDeclaration>
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
if (alphaFromAlphaTexture<0.4)
discard;
#endif
#if SM_SOFTTRANSPARENTSHADOW == 1
#ifdef ALPHATEST
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;S.a.ShadersStore[m]=l;var y={name:m,shader:l}},680:function(we,P,u){"use strict";var S=u(435),R=u(487),U=u(496),O=u(497),x=u(501),G=u(457),T="shadowMapVertexDeclaration",h=`#if SM_NORMALBIAS == 1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
varying float vDepthMetricSM;
#if SM_USEDISTANCE == 1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP == 1
varying float zSM;
#endif
`;S.a.IncludesShadersStore[T]=h;var f={name:T,shader:h},d=u(593),g=u(507),p=u(508),_=u(488),m=u(489),l="shadowMapVertexNormalBias",y=`
#if SM_NORMALBIAS == 1
#if SM_DIRECTIONINLIGHTDATA == 1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;
vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);
float sinNLSM=sqrt(1.0-ndlSM*ndlSM);
float normalBiasSM=biasAndScaleSM.y*sinNLSM;
worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;S.a.IncludesShadersStore[l]=y;var E={name:l,shader:y},A="shadowMapVertexMetric",F=`#if SM_USEDISTANCE == 1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE == 1

gl_Position.z+=biasAndScaleSM.x*gl_Position.w;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP == 1
zSM=gl_Position.z;
gl_Position.z=0.0;
#elif SM_USEDISTANCE == 0

vDepthMetricSM=((gl_Position.z+depthValuesSM.x)/(depthValuesSM.y))+biasAndScaleSM.x;
#endif
`;S.a.IncludesShadersStore[A]=F;var B={name:A,shader:F},L=u(551),I="shadowMapVertexShader",z=`
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

#include<instancesDeclaration>
#include<helperFunctions>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexDeclaration>
#include<clipPlaneVertexDeclaration>
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));
vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>

gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;S.a.ShadersStore[I]=z;var k={name:I,shader:z}},694:function(we,P,u){"use strict";u.d(P,"a",function(){return x});var S=u(541),R=u(628),U=u(452),O=u(468);O.a.AddParser(U.a.NAME_SHADOWGENERATOR,function(G,T){if(G.shadowGenerators!==void 0&&G.shadowGenerators!==null)for(var h=0,f=G.shadowGenerators.length;h<f;h++){var d=G.shadowGenerators[h];d.className===R.a.CLASSNAME?R.a.Parse(d,T):S.a.Parse(d,T)}});var x=function(){function G(T){this.name=U.a.NAME_SHADOWGENERATOR,this.scene=T}return G.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(U.a.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)},G.prototype.rebuild=function(){},G.prototype.serialize=function(T){T.shadowGenerators=[];for(var h=this.scene.lights,f=0,d=h;f<d.length;f++){var g=d[f],p=g.getShadowGenerator();p&&T.shadowGenerators.push(p.serialize())}},G.prototype.addFromContainer=function(T){},G.prototype.removeFromContainer=function(T,h){},G.prototype.dispose=function(){},G.prototype._gatherRenderTargets=function(T){var h=this.scene;if(this.scene.shadowsEnabled)for(var f=0;f<h.lights.length;f++){var d=h.lights[f],g=d.getShadowGenerator();if(d.isEnabled()&&d.shadowEnabled&&g){var p=g.getShadowMap();h.textures.indexOf(p)!==-1&&T.push(p)}}},G}();S.a._SceneComponentInitialization=function(G){var T=G._getComponent(U.a.NAME_SHADOWGENERATOR);T||(T=new x(G),G._addComponent(T))}},695:function(we,P,u){"use strict";u.d(P,"a",function(){return R});var S=u(445),R=function(){function U(O,x,G){var T=this;x===void 0&&(x=""),G===void 0&&(G="black"),this._renderingCanvas=O,this._loadingText=x,this._loadingDivBackgroundColor=G,this._resizeLoadingUI=function(){var h=T._renderingCanvas.getBoundingClientRect(),f=window.getComputedStyle(T._renderingCanvas).position;!T._loadingDiv||(T._loadingDiv.style.position=f==="fixed"?"fixed":"absolute",T._loadingDiv.style.left=h.left+"px",T._loadingDiv.style.top=h.top+"px",T._loadingDiv.style.width=h.width+"px",T._loadingDiv.style.height=h.height+"px")}}return U.prototype.displayLoadingUI=function(){if(!this._loadingDiv){this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText;var O=document.createElement("style");O.type="text/css";var x=`@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}
                    100% { -webkit-transform: rotate(360deg);}
                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}
                    100% { transform: rotate(360deg);}
                }`;O.innerHTML=x,document.getElementsByTagName("head")[0].appendChild(O);var G=!!window.SVGSVGElement,T=new Image;U.DefaultLogoUrl?T.src=U.DefaultLogoUrl:T.src=G?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",T.style.width="150px",T.style.gridColumn="1",T.style.gridRow="1",T.style.top="50%",T.style.left="50%",T.style.transform="translate(-50%, -50%)",T.style.position="absolute";var h=document.createElement("div");h.style.width="300px",h.style.gridColumn="1",h.style.gridRow="1",h.style.top="50%",h.style.left="50%",h.style.transform="translate(-50%, -50%)",h.style.position="absolute";var f=new Image;if(U.DefaultSpinnerUrl?f.src=U.DefaultSpinnerUrl:f.src=G?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",f.style.animation="spin1 0.75s infinite linear",f.style.webkitAnimation="spin1 0.75s infinite linear",f.style.transformOrigin="50% 50%",f.style.webkitTransformOrigin="50% 50%",!G){var d={w:16,h:18.5},g={w:30,h:30};T.style.width=d.w+"vh",T.style.height=d.h+"vh",T.style.left="calc(50% - "+d.w/2+"vh)",T.style.top="calc(50% - "+d.h/2+"vh)",f.style.width=g.w+"vh",f.style.height=g.h+"vh",f.style.left="calc(50% - "+g.w/2+"vh)",f.style.top="calc(50% - "+g.h/2+"vh)"}h.appendChild(f),this._loadingDiv.appendChild(T),this._loadingDiv.appendChild(h),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}},U.prototype.hideLoadingUI=function(){var O=this;if(!!this._loadingDiv){var x=function(){!O._loadingDiv||(O._loadingDiv.parentElement&&O._loadingDiv.parentElement.removeChild(O._loadingDiv),window.removeEventListener("resize",O._resizeLoadingUI),O._loadingDiv=null)};this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",x)}},Object.defineProperty(U.prototype,"loadingUIText",{get:function(){return this._loadingText},set:function(O){this._loadingText=O,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)},enumerable:!1,configurable:!0}),Object.defineProperty(U.prototype,"loadingUIBackgroundColor",{get:function(){return this._loadingDivBackgroundColor},set:function(O){this._loadingDivBackgroundColor=O,!!this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)},enumerable:!1,configurable:!0}),U.DefaultLogoUrl="",U.DefaultSpinnerUrl="",U}();S.a.DefaultLoadingScreenFactory=function(U){return new R(U)}},696:function(we,P,u){"use strict";u.d(P,"a",function(){return T});var S=u(443),R=u(575),U=u(485);function O(h){return new Promise(function(f){DracoDecoderModule({wasmBinary:h}).then(function(d){f({module:d})})})}function x(h,f,d,g,p){var _=new h.DecoderBuffer;_.Init(f,f.byteLength);var m=new h.Decoder,l,y;try{var E=m.GetEncodedGeometryType(_);switch(E){case h.TRIANGULAR_MESH:l=new h.Mesh,y=m.DecodeBufferToMesh(_,l);break;case h.POINT_CLOUD:l=new h.PointCloud,y=m.DecodeBufferToPointCloud(_,l);break;default:throw new Error("Invalid geometry type "+E)}if(!y.ok()||!l.ptr)throw new Error(y.error_msg());if(E===h.TRIANGULAR_MESH){var A=l.num_faces(),F=A*3,B=F*4,L=h._malloc(B);try{m.GetTrianglesUInt32Array(l,B,L);var I=new Uint32Array(F);I.set(new Uint32Array(h.HEAPF32.buffer,L,F)),g(I)}finally{h._free(L)}}var z=function(W,Y){var he=Y.num_components(),le=l.num_points(),J=le*he,Re=J*Float32Array.BYTES_PER_ELEMENT,Me=h._malloc(Re);try{m.GetAttributeDataArrayForAllPoints(l,Y,h.DT_FLOAT32,Re,Me);var me=new Float32Array(h.HEAPF32.buffer,Me,J);if(W==="color"&&he===3){for(var H=new Float32Array(le*4),q=0,_e=0;q<H.length;q+=4,_e+=he)H[q+0]=me[_e+0],H[q+1]=me[_e+1],H[q+2]=me[_e+2],H[q+3]=1;p(W,H)}else{var H=new Float32Array(J);H.set(new Float32Array(h.HEAPF32.buffer,Me,J)),p(W,H)}}finally{h._free(Me)}};if(d)for(var k in d){var j=d[k],w=m.GetAttributeByUniqueId(l,j);z(k,w)}else{var Q={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(var k in Q){var j=m.GetAttributeId(l,h[Q[k]]);if(j!==-1){var w=m.GetAttribute(l,j);z(k,w)}}}}finally{l&&h.destroy(l),h.destroy(m),h.destroy(_)}}function G(){var h;onmessage=function(f){var d=f.data;switch(d.id){case"init":{var g=d.decoder;g.url&&(importScripts(g.url),h=DracoDecoderModule({wasmBinary:g.wasmBinary})),postMessage("done");break}case"decodeMesh":{if(!h)throw new Error("Draco decoder module is not available");h.then(function(p){x(p,d.dataView,d.attributes,function(_){postMessage({id:"indices",value:_},[_.buffer])},function(_,m){postMessage({id:_,value:m},[m.buffer])}),postMessage("done")});break}}}}var T=function(){function h(f){f===void 0&&(f=h.DefaultNumWorkers);var d=h.Configuration.decoder,g=d.wasmUrl&&d.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:d.wasmUrl,wasmBinaryPromise:S.b.LoadFileAsync(d.wasmBinaryUrl)}:{url:d.fallbackUrl,wasmBinaryPromise:Promise.resolve(void 0)};f&&typeof Worker=="function"?this._workerPoolPromise=g.wasmBinaryPromise.then(function(p){for(var _=x+"("+G+")()",m=URL.createObjectURL(new Blob([_],{type:"application/javascript"})),l=new Array(f),y=0;y<l.length;y++)l[y]=new Promise(function(E,A){var F=new Worker(m),B=function(I){F.removeEventListener("error",B),F.removeEventListener("message",L),A(I)},L=function(I){I.data==="done"&&(F.removeEventListener("error",B),F.removeEventListener("message",L),E(F))};F.addEventListener("error",B),F.addEventListener("message",L),F.postMessage({id:"init",decoder:{url:g.url,wasmBinary:p}})});return Promise.all(l).then(function(E){return new R.a(E)})}):this._decoderModulePromise=g.wasmBinaryPromise.then(function(p){if(!g.url)throw new Error("Draco decoder module is not available");return S.b.LoadScriptAsync(g.url).then(function(){return O(p)})})}return Object.defineProperty(h,"DecoderAvailable",{get:function(){var f=h.Configuration.decoder;return!!(f.wasmUrl&&f.wasmBinaryUrl&&typeof WebAssembly=="object"||f.fallbackUrl)},enumerable:!1,configurable:!0}),h.GetDefaultNumWorkers=function(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)},Object.defineProperty(h,"Default",{get:function(){return h._Default||(h._Default=new h),h._Default},enumerable:!1,configurable:!0}),h.prototype.dispose=function(){this._workerPoolPromise&&this._workerPoolPromise.then(function(f){f.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise},h.prototype.whenReadyAsync=function(){return this._workerPoolPromise?this._workerPoolPromise.then(function(){}):this._decoderModulePromise?this._decoderModulePromise.then(function(){}):Promise.resolve()},h.prototype.decodeMeshAsync=function(f,d){var g=f instanceof ArrayBuffer?new Uint8Array(f):f;if(this._workerPoolPromise)return this._workerPoolPromise.then(function(p){return new Promise(function(_,m){p.push(function(l,y){var E=new U.a,A=function(L){l.removeEventListener("error",A),l.removeEventListener("message",F),m(L),y()},F=function(L){L.data==="done"?(l.removeEventListener("error",A),l.removeEventListener("message",F),_(E),y()):L.data.id==="indices"?E.indices=L.data.value:E.set(L.data.value,L.data.id)};l.addEventListener("error",A),l.addEventListener("message",F);var B=new Uint8Array(g.byteLength);B.set(new Uint8Array(g.buffer,g.byteOffset,g.byteLength)),l.postMessage({id:"decodeMesh",dataView:B,attributes:d},[B.buffer])})})});if(this._decoderModulePromise)return this._decoderModulePromise.then(function(p){var _=new U.a;return x(p.module,g,d,function(m){_.indices=m},function(m,l){_.set(l,m)}),_});throw new Error("Draco decoder module is not available")},h.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},h.DefaultNumWorkers=h.GetDefaultNumWorkers(),h._Default=null,h}()},698:function(we,P,u){"use strict";u.d(P,"a",function(){return S});var S=function(){function R(){var U=this;this.promise=new Promise(function(O,x){U._resolve=O,U._reject=x})}return Object.defineProperty(R.prototype,"resolve",{get:function(){return this._resolve},enumerable:!1,configurable:!0}),Object.defineProperty(R.prototype,"reject",{get:function(){return this._reject},enumerable:!1,configurable:!0}),R}()},699:function(we,P,u){"use strict";u.d(P,"a",function(){return R});var S=u(473),R=function(){function U(O){this.byteOffset=0,this.buffer=O}return U.prototype.loadAsync=function(O){var x=this;return this.buffer.readAsync(this.byteOffset,O).then(function(G){x._dataView=new DataView(G.buffer,G.byteOffset,G.byteLength),x._dataByteOffset=0})},U.prototype.readUint32=function(){var O=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,O},U.prototype.readUint8Array=function(O){var x=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,O);return this._dataByteOffset+=O,this.byteOffset+=O,x},U.prototype.readString=function(O){return S.a.Decode(this.readUint8Array(O))},U.prototype.skipBytes=function(O){this._dataByteOffset+=O,this.byteOffset+=O},U}()},704:function(we,P,u){"use strict";u.r(P),u.d(P,"AbstractScene",function(){return S.a}),u.d(P,"AbstractActionManager",function(){return R.a}),u.d(P,"Action",function(){return U.a}),u.d(P,"ActionEvent",function(){return O.a}),u.d(P,"ActionManager",function(){return x.a}),u.d(P,"Condition",function(){return G.a}),u.d(P,"ValueCondition",function(){return G.d}),u.d(P,"PredicateCondition",function(){return G.b}),u.d(P,"StateCondition",function(){return G.c}),u.d(P,"SwitchBooleanAction",function(){return T.j}),u.d(P,"SetStateAction",function(){return T.g}),u.d(P,"SetValueAction",function(){return T.h}),u.d(P,"IncrementValueAction",function(){return T.d}),u.d(P,"PlayAnimationAction",function(){return T.e}),u.d(P,"StopAnimationAction",function(){return T.i}),u.d(P,"DoNothingAction",function(){return T.b}),u.d(P,"CombineAction",function(){return T.a}),u.d(P,"ExecuteCodeAction",function(){return T.c}),u.d(P,"SetParentAction",function(){return T.f}),u.d(P,"PlaySoundAction",function(){return d}),u.d(P,"StopSoundAction",function(){return g}),u.d(P,"InterpolateValueAction",function(){return E}),u.d(P,"Animatable",function(){return A.a}),u.d(P,"_IAnimationState",function(){return y.b}),u.d(P,"Animation",function(){return y.a}),u.d(P,"TargetedAnimation",function(){return F.b}),u.d(P,"AnimationGroup",function(){return F.a}),u.d(P,"AnimationPropertiesOverride",function(){return B}),u.d(P,"EasingFunction",function(){return L.f}),u.d(P,"CircleEase",function(){return L.d}),u.d(P,"BackEase",function(){return L.a}),u.d(P,"BounceEase",function(){return L.c}),u.d(P,"CubicEase",function(){return L.e}),u.d(P,"ElasticEase",function(){return L.g}),u.d(P,"ExponentialEase",function(){return L.h}),u.d(P,"PowerEase",function(){return L.i}),u.d(P,"QuadraticEase",function(){return L.j}),u.d(P,"QuarticEase",function(){return L.k}),u.d(P,"QuinticEase",function(){return L.l}),u.d(P,"SineEase",function(){return L.m}),u.d(P,"BezierCurveEase",function(){return L.b}),u.d(P,"RuntimeAnimation",function(){return I.a}),u.d(P,"AnimationEvent",function(){return z}),u.d(P,"AnimationKeyInterpolation",function(){return k.a}),u.d(P,"AnimationRange",function(){return j.a}),u.d(P,"PathCursor",function(){return w}),u.d(P,"KeepAssets",function(){return Q.c}),u.d(P,"InstantiatedEntries",function(){return Q.b}),u.d(P,"AssetContainer",function(){return Q.a}),u.d(P,"Analyser",function(){return Y}),u.d(P,"AudioEngine",function(){return le}),u.d(P,"AudioSceneComponent",function(){return Ee}),u.d(P,"Sound",function(){return Me}),u.d(P,"SoundTrack",function(){return me}),u.d(P,"WeightedSound",function(){return Te}),u.d(P,"AutoRotationBehavior",function(){return se.a}),u.d(P,"BouncingBehavior",function(){return ve.a}),u.d(P,"FramingBehavior",function(){return ye.a}),u.d(P,"AttachToBoxBehavior",function(){return be}),u.d(P,"FadeInOutBehavior",function(){return ze}),u.d(P,"MultiPointerScaleBehavior",function(){return He}),u.d(P,"PointerDragBehavior",function(){return Ye.a}),u.d(P,"SixDofDragBehavior",function(){return ue}),u.d(P,"Bone",function(){return Ge.a}),u.d(P,"BoneIKController",function(){return ne}),u.d(P,"BoneLookController",function(){return nt}),u.d(P,"Skeleton",function(){return ut.a}),u.d(P,"BaseCameraMouseWheelInput",function(){return pt.a}),u.d(P,"BaseCameraPointersInput",function(){return Tt.a}),u.d(P,"ArcRotateCameraGamepadInput",function(){return Kt}),u.d(P,"ArcRotateCameraKeyboardMoveInput",function(){return Zi.a}),u.d(P,"ArcRotateCameraMouseWheelInput",function(){return zi.a}),u.d(P,"ArcRotateCameraPointersInput",function(){return li.a}),u.d(P,"ArcRotateCameraVRDeviceOrientationInput",function(){return Qt}),u.d(P,"FlyCameraKeyboardInput",function(){return ji}),u.d(P,"FlyCameraMouseInput",function(){return yi}),u.d(P,"FollowCameraKeyboardMoveInput",function(){return ai}),u.d(P,"FollowCameraMouseWheelInput",function(){return Ei}),u.d(P,"FollowCameraPointersInput",function(){return Ut}),u.d(P,"FreeCameraDeviceOrientationInput",function(){return ui}),u.d(P,"FreeCameraGamepadInput",function(){return Wi}),u.d(P,"FreeCameraKeyboardMoveInput",function(){return Hi.a}),u.d(P,"FreeCameraMouseInput",function(){return Pi.a}),u.d(P,"FreeCameraMouseWheelInput",function(){return xt.a}),u.d(P,"FreeCameraTouchInput",function(){return Ji.a}),u.d(P,"FreeCameraVirtualJoystickInput",function(){return dr}),u.d(P,"CameraInputTypes",function(){return Ft.a}),u.d(P,"CameraInputsManager",function(){return Ft.b}),u.d(P,"Camera",function(){return Z.a}),u.d(P,"TargetCamera",function(){return Ii.a}),u.d(P,"FreeCamera",function(){return Wt.a}),u.d(P,"FreeCameraInputsManager",function(){return wi.a}),u.d(P,"TouchCamera",function(){return sr}),u.d(P,"ArcRotateCamera",function(){return Ri.a}),u.d(P,"ArcRotateCameraInputsManager",function(){return Di.a}),u.d(P,"DeviceOrientationCamera",function(){return pr}),u.d(P,"FlyCamera",function(){return Vi}),u.d(P,"FlyCameraInputsManager",function(){return Er}),u.d(P,"FollowCamera",function(){return Pr}),u.d(P,"ArcFollowCamera",function(){return gr}),u.d(P,"FollowCameraInputsManager",function(){return $i}),u.d(P,"GamepadCamera",function(){return ln}),u.d(P,"AnaglyphArcRotateCamera",function(){return jn}),u.d(P,"AnaglyphFreeCamera",function(){return Wn}),u.d(P,"AnaglyphGamepadCamera",function(){return Fa}),u.d(P,"AnaglyphUniversalCamera",function(){return Ba}),u.d(P,"StereoscopicArcRotateCamera",function(){return Xn}),u.d(P,"StereoscopicFreeCamera",function(){return Yn}),u.d(P,"StereoscopicGamepadCamera",function(){return Va}),u.d(P,"StereoscopicUniversalCamera",function(){return Ua}),u.d(P,"UniversalCamera",function(){return Ir}),u.d(P,"VirtualJoysticksCamera",function(){return Ga}),u.d(P,"VRCameraMetrics",function(){return Lr}),u.d(P,"VRDeviceOrientationArcRotateCamera",function(){return Ha}),u.d(P,"VRDeviceOrientationFreeCamera",function(){return Jn}),u.d(P,"VRDeviceOrientationGamepadCamera",function(){return ka}),u.d(P,"OnAfterEnteringVRObservableEvent",function(){return Ka}),u.d(P,"VRExperienceHelper",function(){return Ve}),u.d(P,"WebVRFreeCamera",function(){return qn}),u.d(P,"Collider",function(){return Ie}),u.d(P,"DefaultCollisionCoordinator",function(){return ft}),u.d(P,"PickingInfo",function(){return mt.a}),u.d(P,"IntersectionInfo",function(){return st.a}),u.d(P,"_MeshCollisionData",function(){return kt.a}),u.d(P,"BoundingBox",function(){return ht.a}),u.d(P,"BoundingInfo",function(){return ke.a}),u.d(P,"BoundingSphere",function(){return Et.a}),u.d(P,"Octree",function(){return vt}),u.d(P,"OctreeBlock",function(){return ri}),u.d(P,"OctreeSceneComponent",function(){return qt}),u.d(P,"Ray",function(){return Zt.a}),u.d(P,"AxesViewer",function(){return gi.AxesViewer}),u.d(P,"BoneAxesViewer",function(){return gi.BoneAxesViewer}),u.d(P,"DebugLayerTab",function(){return gi.DebugLayerTab}),u.d(P,"DebugLayer",function(){return gi.DebugLayer}),u.d(P,"PhysicsViewer",function(){return gi.PhysicsViewer}),u.d(P,"RayHelper",function(){return gi.RayHelper}),u.d(P,"SkeletonViewer",function(){return gi.SkeletonViewer}),u.d(P,"DirectionalLightFrustumViewer",function(){return gi.DirectionalLightFrustumViewer}),u.d(P,"DeviceInputSystem",function(){return wr.a}),u.d(P,"DeviceType",function(){return Ai.a}),u.d(P,"PointerInput",function(){return Ai.c}),u.d(P,"DualShockInput",function(){return Ai.b}),u.d(P,"XboxInput",function(){return Ai.e}),u.d(P,"SwitchInput",function(){return Ai.d}),u.d(P,"DeviceSource",function(){return Pn}),u.d(P,"DeviceSourceManager",function(){return gp}),u.d(P,"Constants",function(){return mp}),u.d(P,"ThinEngine",function(){return fn.a}),u.d(P,"Engine",function(){return W.a}),u.d(P,"EngineStore",function(){return Yt.a}),u.d(P,"NullEngineOptions",function(){return Qa.b}),u.d(P,"NullEngine",function(){return Qa.a}),u.d(P,"_OcclusionDataStorage",function(){return Bl}),u.d(P,"_forceTransformFeedbackToBundle",function(){return vp}),u.d(P,"EngineView",function(){return _p}),u.d(P,"WebGLPipelineContext",function(){return bp.a}),u.d(P,"PowerPreference",function(){return Za}),u.d(P,"FeatureName",function(){return io}),u.d(P,"BufferUsage",function(){return Fi}),u.d(P,"MapMode",function(){return Vo}),u.d(P,"TextureDimension",function(){return Vr}),u.d(P,"TextureUsage",function(){return ei}),u.d(P,"TextureViewDimension",function(){return Oi}),u.d(P,"TextureAspect",function(){return qr}),u.d(P,"TextureFormat",function(){return Se}),u.d(P,"AddressMode",function(){return hn}),u.d(P,"FilterMode",function(){return _t}),u.d(P,"CompareFunction",function(){return ti}),u.d(P,"ShaderStage",function(){return ro}),u.d(P,"BufferBindingType",function(){return Uo}),u.d(P,"SamplerBindingType",function(){return no}),u.d(P,"TextureSampleType",function(){return dn}),u.d(P,"StorageTextureAccess",function(){return Ja}),u.d(P,"CompilationMessageType",function(){return $a}),u.d(P,"PrimitiveTopology",function(){return ki}),u.d(P,"FrontFace",function(){return oo}),u.d(P,"CullMode",function(){return Cn}),u.d(P,"ColorWrite",function(){return Go}),u.d(P,"BlendFactor",function(){return Si}),u.d(P,"BlendOperation",function(){return Ur}),u.d(P,"StencilOperation",function(){return ir}),u.d(P,"IndexFormat",function(){return Gr}),u.d(P,"VertexFormat",function(){return zt}),u.d(P,"InputStepMode",function(){return ao}),u.d(P,"LoadOp",function(){return Gi}),u.d(P,"StoreOp",function(){return Sr}),u.d(P,"QueryType",function(){return qa}),u.d(P,"PipelineStatisticName",function(){return es}),u.d(P,"DeviceLostReason",function(){return ts}),u.d(P,"ErrorFilter",function(){return is}),u.d(P,"WebGPUEngine",function(){return as}),u.d(P,"WebGPUCacheRenderPipeline",function(){return Wl}),u.d(P,"WebGPUCacheRenderPipelineTree",function(){return kl}),u.d(P,"WebGL2ShaderProcessor",function(){return $l.a}),u.d(P,"NativeEngine",function(){return $p}),u.d(P,"ShaderCodeInliner",function(){return zo.a}),u.d(P,"PerformanceConfigurator",function(){return qp.a}),u.d(P,"EngineFactory",function(){return eg}),u.d(P,"KeyboardEventTypes",function(){return _i.a}),u.d(P,"KeyboardInfo",function(){return _i.b}),u.d(P,"KeyboardInfoPre",function(){return _i.c}),u.d(P,"PointerEventTypes",function(){return re.a}),u.d(P,"PointerInfoBase",function(){return re.c}),u.d(P,"PointerInfoPre",function(){return re.d}),u.d(P,"PointerInfo",function(){return re.b}),u.d(P,"ClipboardEventTypes",function(){return Wo}),u.d(P,"ClipboardInfo",function(){return tg}),u.d(P,"DeviceInputEventType",function(){return nu.a}),u.d(P,"EventConstants",function(){return nu.b}),u.d(P,"DaydreamController",function(){return ss}),u.d(P,"GearVRController",function(){return ls}),u.d(P,"GenericController",function(){return Ho}),u.d(P,"OculusTouchController",function(){return us}),u.d(P,"PoseEnabledControllerType",function(){return Li}),u.d(P,"PoseEnabledControllerHelper",function(){return Ui}),u.d(P,"PoseEnabledController",function(){return qi}),u.d(P,"ViveController",function(){return ou}),u.d(P,"WebVRController",function(){return Br}),u.d(P,"WindowsMotionController",function(){return ko}),u.d(P,"XRWindowsMotionController",function(){return rg}),u.d(P,"StickValues",function(){return Jt}),u.d(P,"Gamepad",function(){return Dt}),u.d(P,"GenericPad",function(){return Xt}),u.d(P,"GamepadManager",function(){return Gn}),u.d(P,"GamepadSystemSceneComponent",function(){return Da}),u.d(P,"Xbox360Button",function(){return Ht}),u.d(P,"Xbox360Dpad",function(){return er}),u.d(P,"Xbox360Pad",function(){return Vn}),u.d(P,"DualShockButton",function(){return tr}),u.d(P,"DualShockDpad",function(){return Jr}),u.d(P,"DualShockPad",function(){return Un}),u.d(P,"AxisDragGizmo",function(){return Xo.a}),u.d(P,"AxisScaleGizmo",function(){return fo}),u.d(P,"BoundingBoxGizmo",function(){return au}),u.d(P,"Gizmo",function(){return rr.a}),u.d(P,"GizmoManager",function(){return ng}),u.d(P,"PlaneRotationGizmo",function(){return Yo}),u.d(P,"PositionGizmo",function(){return uu}),u.d(P,"RotationGizmo",function(){return su}),u.d(P,"ScaleGizmo",function(){return cu}),u.d(P,"LightGizmo",function(){return og}),u.d(P,"CameraGizmo",function(){return ag}),u.d(P,"PlaneDragGizmo",function(){return Ko}),u.d(P,"EnvironmentHelper",function(){return vs}),u.d(P,"PhotoDome",function(){return lg}),u.d(P,"_forceSceneHelpersToBundle",function(){return Og}),u.d(P,"VideoDome",function(){return Mg}),u.d(P,"EngineInstrumentation",function(){return xg}),u.d(P,"SceneInstrumentation",function(){return Dg}),u.d(P,"_TimeToken",function(){return Fl}),u.d(P,"EffectLayer",function(){return qu.a}),u.d(P,"EffectLayerSceneComponent",function(){return Ig.a}),u.d(P,"GlowLayer",function(){return Lg.a}),u.d(P,"HighlightLayer",function(){return Ts}),u.d(P,"Layer",function(){return Fg}),u.d(P,"LayerSceneComponent",function(){return rc}),u.d(P,"LensFlare",function(){return lc}),u.d(P,"LensFlareSystem",function(){return Rs}),u.d(P,"LensFlareSystemSceneComponent",function(){return dc}),u.d(P,"Light",function(){return Zo.a}),u.d(P,"ShadowLight",function(){return fs.a}),u.d(P,"ShadowGenerator",function(){return pc.a}),u.d(P,"CascadedShadowGenerator",function(){return Bg.a}),u.d(P,"ShadowGeneratorSceneComponent",function(){return Ng.a}),u.d(P,"DirectionalLight",function(){return fu.a}),u.d(P,"HemisphericLight",function(){return $n.a}),u.d(P,"PointLight",function(){return As}),u.d(P,"SpotLight",function(){return hs}),u.d(P,"DefaultLoadingScreen",function(){return wg.a}),u.d(P,"_BabylonLoaderRegistered",function(){return gc.b}),u.d(P,"BabylonFileLoaderConfiguration",function(){return gc.a}),u.d(P,"SceneLoaderAnimationGroupLoadingMode",function(){return Mi.b}),u.d(P,"SceneLoader",function(){return Mi.a}),u.d(P,"SceneLoaderFlags",function(){return Vg.a}),u.d(P,"BackgroundMaterial",function(){return mo}),u.d(P,"ColorCurves",function(){return Ug.a}),u.d(P,"EffectFallbacks",function(){return ms.a}),u.d(P,"Effect",function(){return qe.a}),u.d(P,"FresnelParameters",function(){return mc}),u.d(P,"ImageProcessingConfigurationDefines",function(){return mr.b}),u.d(P,"ImageProcessingConfiguration",function(){return mr.a}),u.d(P,"Material",function(){return Yi.a}),u.d(P,"MaterialDefines",function(){return ps.a}),u.d(P,"ThinMaterialHelper",function(){return vc.a}),u.d(P,"MaterialHelper",function(){return Ot.a}),u.d(P,"MultiMaterial",function(){return yo.a}),u.d(P,"OcclusionMaterial",function(){return Gg}),u.d(P,"PBRMaterialDefines",function(){return Hr.b}),u.d(P,"PBRBaseMaterial",function(){return Hr.a}),u.d(P,"PBRBaseSimpleMaterial",function(){return Os}),u.d(P,"PBRMaterial",function(){return Pu.a}),u.d(P,"PBRMetallicRoughnessMaterial",function(){return _c}),u.d(P,"PBRSpecularGlossinessMaterial",function(){return yc}),u.d(P,"PushMaterial",function(){return gs.a}),u.d(P,"ShaderMaterial",function(){return Tn.a}),u.d(P,"StandardMaterialDefines",function(){return Gt.b}),u.d(P,"StandardMaterial",function(){return Gt.a}),u.d(P,"BaseTexture",function(){return jr.a}),u.d(P,"ColorGradingTexture",function(){return bc}),u.d(P,"CubeTexture",function(){return pn.a}),u.d(P,"DynamicTexture",function(){return un.a}),u.d(P,"EquiRectangularCubeTexture",function(){return Pc}),u.d(P,"HDRFiltering",function(){return zg.a}),u.d(P,"HDRCubeTexture",function(){return Cc.a}),u.d(P,"HtmlElementTexture",function(){return jg}),u.d(P,"InternalTextureSource",function(){return gt.b}),u.d(P,"InternalTexture",function(){return gt.a}),u.d(P,"_DDSTextureLoader",function(){return Gu}),u.d(P,"_ENVTextureLoader",function(){return zu}),u.d(P,"_KTXTextureLoader",function(){return Wu}),u.d(P,"_TGATextureLoader",function(){return Sc}),u.d(P,"_HDRTextureLoader",function(){return Tc}),u.d(P,"_BasisTextureLoader",function(){return Rc}),u.d(P,"MirrorTexture",function(){return ds}),u.d(P,"MultiRenderTarget",function(){return kg.a}),u.d(P,"TexturePacker",function(){return Xg}),u.d(P,"TexturePackerFrame",function(){return xs}),u.d(P,"CustomProceduralTexture",function(){return Yg}),u.d(P,"NoiseProceduralTexture",function(){return Ic}),u.d(P,"ProceduralTexture",function(){return Po}),u.d(P,"ProceduralTextureSceneComponent",function(){return Ac}),u.d(P,"RawCubeTexture",function(){return Kg}),u.d(P,"RawTexture",function(){return kr.a}),u.d(P,"RawTexture2DArray",function(){return Qg.a}),u.d(P,"RawTexture3D",function(){return Zg}),u.d(P,"RefractionTexture",function(){return Jg}),u.d(P,"RenderTargetTexture",function(){return Cr.a}),u.d(P,"Texture",function(){return Ze.a}),u.d(P,"VideoTexture",function(){return $u}),u.d(P,"UniformBuffer",function(){return Fr.a}),u.d(P,"MaterialFlags",function(){return en.a}),u.d(P,"NodeMaterialBlockTargets",function(){return oe}),u.d(P,"NodeMaterialBlockConnectionPointTypes",function(){return K}),u.d(P,"NodeMaterialBlockConnectionPointMode",function(){return Ti}),u.d(P,"NodeMaterialSystemValues",function(){return dt}),u.d(P,"NodeMaterialModes",function(){return Ki}),u.d(P,"NodeMaterialConnectionPointCompatibilityStates",function(){return _r}),u.d(P,"NodeMaterialConnectionPointDirection",function(){return Ni}),u.d(P,"NodeMaterialConnectionPoint",function(){return ea}),u.d(P,"NodeMaterialBlock",function(){return it}),u.d(P,"NodeMaterialDefines",function(){return Ro}),u.d(P,"NodeMaterial",function(){return oa}),u.d(P,"VertexOutputBlock",function(){return Co}),u.d(P,"BonesBlock",function(){return wc}),u.d(P,"InstancesBlock",function(){return Vc}),u.d(P,"MorphTargetsBlock",function(){return Uc}),u.d(P,"LightInformationBlock",function(){return Gc}),u.d(P,"FragmentOutputBlock",function(){return On}),u.d(P,"ImageProcessingBlock",function(){return zc}),u.d(P,"PerturbNormalBlock",function(){return jc}),u.d(P,"DiscardBlock",function(){return Wc}),u.d(P,"FrontFacingBlock",function(){return Hc}),u.d(P,"DerivativeBlock",function(){return kc}),u.d(P,"FragCoordBlock",function(){return Xc}),u.d(P,"ScreenSizeBlock",function(){return Yc}),u.d(P,"FogBlock",function(){return Kc}),u.d(P,"LightBlock",function(){return Qc}),u.d(P,"TextureBlock",function(){return Zc}),u.d(P,"ReflectionTextureBlock",function(){return Jc}),u.d(P,"CurrentScreenBlock",function(){return Is}),u.d(P,"InputBlock",function(){return yt}),u.d(P,"AnimatedInputBlockTypes",function(){return on}),u.d(P,"MultiplyBlock",function(){return ia}),u.d(P,"AddBlock",function(){return $c}),u.d(P,"ScaleBlock",function(){return qc}),u.d(P,"ClampBlock",function(){return ef}),u.d(P,"CrossBlock",function(){return tf}),u.d(P,"DotBlock",function(){return rf}),u.d(P,"TransformBlock",function(){return ta}),u.d(P,"RemapBlock",function(){return Ns}),u.d(P,"NormalizeBlock",function(){return nf}),u.d(P,"TrigonometryBlockOperations",function(){return ni}),u.d(P,"TrigonometryBlock",function(){return Ws}),u.d(P,"ColorMergerBlock",function(){return of}),u.d(P,"VectorMergerBlock",function(){return So}),u.d(P,"ColorSplitterBlock",function(){return js}),u.d(P,"VectorSplitterBlock",function(){return af}),u.d(P,"LerpBlock",function(){return sf}),u.d(P,"DivideBlock",function(){return lf}),u.d(P,"SubtractBlock",function(){return uf}),u.d(P,"StepBlock",function(){return cf}),u.d(P,"OneMinusBlock",function(){return Xs}),u.d(P,"ViewDirectionBlock",function(){return Ys}),u.d(P,"FresnelBlock",function(){return ff}),u.d(P,"MaxBlock",function(){return hf}),u.d(P,"MinBlock",function(){return df}),u.d(P,"DistanceBlock",function(){return pf}),u.d(P,"LengthBlock",function(){return gf}),u.d(P,"NegateBlock",function(){return mf}),u.d(P,"PowBlock",function(){return vf}),u.d(P,"RandomNumberBlock",function(){return _f}),u.d(P,"ArcTan2Block",function(){return yf}),u.d(P,"SmoothStepBlock",function(){return bf}),u.d(P,"ReciprocalBlock",function(){return Ef}),u.d(P,"ReplaceColorBlock",function(){return Pf}),u.d(P,"PosterizeBlock",function(){return Cf}),u.d(P,"WaveBlockKind",function(){return gn}),u.d(P,"WaveBlock",function(){return Sf}),u.d(P,"GradientBlockColorStep",function(){return aa}),u.d(P,"GradientBlock",function(){return Tf}),u.d(P,"NLerpBlock",function(){return Rf}),u.d(P,"WorleyNoise3DBlock",function(){return Af}),u.d(P,"SimplexPerlin3DBlock",function(){return Of}),u.d(P,"NormalBlendBlock",function(){return Mf}),u.d(P,"Rotate2dBlock",function(){return xf}),u.d(P,"ReflectBlock",function(){return Df}),u.d(P,"RefractBlock",function(){return If}),u.d(P,"DesaturateBlock",function(){return Lf}),u.d(P,"PBRMetallicRoughnessBlock",function(){return Nf}),u.d(P,"SheenBlock",function(){return Ks}),u.d(P,"AnisotropyBlock",function(){return Qs}),u.d(P,"ReflectionBlock",function(){return Zs}),u.d(P,"ClearCoatBlock",function(){return sa}),u.d(P,"RefractionBlock",function(){return Js}),u.d(P,"SubSurfaceBlock",function(){return la}),u.d(P,"ParticleTextureBlock",function(){return Ls}),u.d(P,"ParticleRampGradientBlock",function(){return Fs}),u.d(P,"ParticleBlendMultiplyBlock",function(){return Bs}),u.d(P,"ModBlock",function(){return wf}),u.d(P,"MatrixBuilderBlock",function(){return Vf}),u.d(P,"NodeMaterialOptimizer",function(){return im}),u.d(P,"PropertyTypeForEdition",function(){return Mt}),u.d(P,"editableInPropertyPage",function(){return It}),u.d(P,"EffectRenderer",function(){return Uf.a}),u.d(P,"EffectWrapper",function(){return Uf.b}),u.d(P,"ShadowDepthWrapper",function(){return om}),u.d(P,"Scalar",function(){return $e.a}),u.d(P,"extractMinAndMaxIndexed",function(){return Gf.b}),u.d(P,"extractMinAndMax",function(){return Gf.a}),u.d(P,"Space",function(){return et.t}),u.d(P,"Axis",function(){return et.c}),u.d(P,"Coordinate",function(){return et.g}),u.d(P,"Color3",function(){return et.e}),u.d(P,"Color4",function(){return et.f}),u.d(P,"TmpColors",function(){return et.u}),u.d(P,"ToGammaSpace",function(){return et.w}),u.d(P,"ToLinearSpace",function(){return et.x}),u.d(P,"Epsilon",function(){return et.i}),u.d(P,"Frustum",function(){return et.j}),u.d(P,"Orientation",function(){return et.l}),u.d(P,"BezierCurve",function(){return et.d}),u.d(P,"Angle",function(){return et.a}),u.d(P,"Arc2",function(){return et.b}),u.d(P,"Path2",function(){return et.m}),u.d(P,"Path3D",function(){return et.n}),u.d(P,"Curve3",function(){return et.h}),u.d(P,"Plane",function(){return et.o}),u.d(P,"Size",function(){return et.s}),u.d(P,"Vector2",function(){return et.y}),u.d(P,"Vector3",function(){return et.z}),u.d(P,"Vector4",function(){return et.A}),u.d(P,"Quaternion",function(){return et.r}),u.d(P,"Matrix",function(){return et.k}),u.d(P,"TmpVectors",function(){return et.v}),u.d(P,"PositionNormalVertex",function(){return et.q}),u.d(P,"PositionNormalTextureVertex",function(){return et.p}),u.d(P,"Viewport",function(){return et.B}),u.d(P,"SphericalHarmonics",function(){return uo.a}),u.d(P,"SphericalPolynomial",function(){return uo.b}),u.d(P,"AbstractMesh",function(){return Ue.a}),u.d(P,"Buffer",function(){return Oe.a}),u.d(P,"VertexBuffer",function(){return Oe.b}),u.d(P,"DracoCompression",function(){return am.a}),u.d(P,"CSG",function(){return um}),u.d(P,"Geometry",function(){return cm.a}),u.d(P,"GroundMesh",function(){return fm.a}),u.d(P,"TrailMesh",function(){return hm}),u.d(P,"InstancedMesh",function(){return dm.a}),u.d(P,"LinesMesh",function(){return Oo.b}),u.d(P,"InstancedLinesMesh",function(){return Oo.a}),u.d(P,"_CreationDataStorage",function(){return ot.b}),u.d(P,"_InstancesBatch",function(){return ot.c}),u.d(P,"Mesh",function(){return ot.a}),u.d(P,"VertexData",function(){return an.a}),u.d(P,"MeshBuilder",function(){return pm.a}),u.d(P,"SimplificationSettings",function(){return gm}),u.d(P,"SimplificationQueue",function(){return jf}),u.d(P,"SimplificationType",function(){return Mo}),u.d(P,"QuadraticErrorSimplification",function(){return Hf}),u.d(P,"SimplicationQueueSceneComponent",function(){return kf}),u.d(P,"Polygon",function(){return Xf.a}),u.d(P,"PolygonMeshBuilder",function(){return Xf.b}),u.d(P,"SubMesh",function(){return Ao.a}),u.d(P,"MeshLODLevel",function(){return ym.a}),u.d(P,"TransformNode",function(){return po.a}),u.d(P,"BoxBuilder",function(){return co.a}),u.d(P,"TiledBoxBuilder",function(){return bm.a}),u.d(P,"DiscBuilder",function(){return Yf.a}),u.d(P,"RibbonBuilder",function(){return Em.a}),u.d(P,"SphereBuilder",function(){return nr.a}),u.d(P,"HemisphereBuilder",function(){return Qo}),u.d(P,"CylinderBuilder",function(){return Tr.a}),u.d(P,"TorusBuilder",function(){return eo.a}),u.d(P,"TorusKnotBuilder",function(){return Pm.a}),u.d(P,"LinesBuilder",function(){return Bi.a}),u.d(P,"PolygonBuilder",function(){return Cm.a}),u.d(P,"ShapeBuilder",function(){return Sm.a}),u.d(P,"LatheBuilder",function(){return Tm.a}),u.d(P,"PlaneBuilder",function(){return lu.a}),u.d(P,"TiledPlaneBuilder",function(){return Rm.a}),u.d(P,"GroundBuilder",function(){return Ya.a}),u.d(P,"TubeBuilder",function(){return Am.a}),u.d(P,"PolyhedronBuilder",function(){return cs.a}),u.d(P,"IcoSphereBuilder",function(){return Om.a}),u.d(P,"DecalBuilder",function(){return Mm.a}),u.d(P,"CapsuleBuilder",function(){return xm.a}),u.d(P,"DataBuffer",function(){return ns.a}),u.d(P,"WebGLDataBuffer",function(){return Dm.a}),u.d(P,"WebGPUDataBuffer",function(){return zl}),u.d(P,"MorphTarget",function(){return Im.a}),u.d(P,"MorphTargetManager",function(){return Kf.a}),u.d(P,"RecastJSPlugin",function(){return Lm}),u.d(P,"RecastJSCrowd",function(){return Qf}),u.d(P,"Node",function(){return Nt.a}),u.d(P,"Database",function(){return Zf}),u.d(P,"BaseParticleSystem",function(){return To}),u.d(P,"BoxParticleEmitter",function(){return Mn}),u.d(P,"ConeParticleEmitter",function(){return ws}),u.d(P,"CylinderParticleEmitter",function(){return ra}),u.d(P,"CylinderDirectedParticleEmitter",function(){return Vs}),u.d(P,"HemisphericParticleEmitter",function(){return Us}),u.d(P,"PointParticleEmitter",function(){return Gs}),u.d(P,"SphereParticleEmitter",function(){return na}),u.d(P,"SphereDirectedParticleEmitter",function(){return zs}),u.d(P,"CustomParticleEmitter",function(){return xn}),u.d(P,"MeshParticleEmitter",function(){return Bc}),u.d(P,"GPUParticleSystem",function(){return mn}),u.d(P,"Particle",function(){return $f}),u.d(P,"ParticleHelper",function(){return Fm}),u.d(P,"ParticleSystem",function(){return mi}),u.d(P,"ParticleSystemSet",function(){return ua}),u.d(P,"SolidParticle",function(){return tl}),u.d(P,"ModelShape",function(){return il}),u.d(P,"DepthSortedParticle",function(){return gh}),u.d(P,"SolidParticleVertex",function(){return mh}),u.d(P,"SolidParticleSystem",function(){return Bm}),u.d(P,"CloudPoint",function(){return vh.a}),u.d(P,"PointsGroup",function(){return vh.b}),u.d(P,"PointColor",function(){return _h.a}),u.d(P,"PointsCloudSystem",function(){return _h.b}),u.d(P,"SubEmitterType",function(){return Dn}),u.d(P,"SubEmitter",function(){return xo}),u.d(P,"PhysicsEngine",function(){return yh.a}),u.d(P,"PhysicsEngineSceneComponent",function(){return bh}),u.d(P,"PhysicsHelper",function(){return Nm}),u.d(P,"PhysicsRadialExplosionEventOptions",function(){return Ln}),u.d(P,"PhysicsUpdraftEventOptions",function(){return rl}),u.d(P,"PhysicsVortexEventOptions",function(){return nl}),u.d(P,"PhysicsRadialImpulseFalloff",function(){return Do}),u.d(P,"PhysicsUpdraftMode",function(){return Fn}),u.d(P,"PhysicsImpostor",function(){return Xr.a}),u.d(P,"PhysicsJoint",function(){return In.e}),u.d(P,"DistanceJoint",function(){return In.a}),u.d(P,"MotorEnabledJoint",function(){return In.d}),u.d(P,"HingeJoint",function(){return In.c}),u.d(P,"Hinge2Joint",function(){return In.b}),u.d(P,"CannonJSPlugin",function(){return Gm.a}),u.d(P,"AmmoJSPlugin",function(){return zm.a}),u.d(P,"OimoJSPlugin",function(){return jm.a}),u.d(P,"AnaglyphPostProcess",function(){return Fo}),u.d(P,"BlackAndWhitePostProcess",function(){return Sh}),u.d(P,"BloomEffect",function(){return Wm.a}),u.d(P,"BloomMergePostProcess",function(){return Hm.a}),u.d(P,"BlurPostProcess",function(){return go.a}),u.d(P,"ChromaticAberrationPostProcess",function(){return km.a}),u.d(P,"CircleOfConfusionPostProcess",function(){return Xm.a}),u.d(P,"ColorCorrectionPostProcess",function(){return Ah}),u.d(P,"ConvolutionPostProcess",function(){return xh}),u.d(P,"DepthOfFieldBlurPostProcess",function(){return Ym.a}),u.d(P,"DepthOfFieldEffectBlurLevel",function(){return Dh.b}),u.d(P,"DepthOfFieldEffect",function(){return Dh.a}),u.d(P,"DepthOfFieldMergePostProcessOptions",function(){return Ih.b}),u.d(P,"DepthOfFieldMergePostProcess",function(){return Ih.a}),u.d(P,"DisplayPassPostProcess",function(){return Bh}),u.d(P,"ExtractHighlightsPostProcess",function(){return Km.a}),u.d(P,"FilterPostProcess",function(){return Vh}),u.d(P,"FxaaPostProcess",function(){return Uh.a}),u.d(P,"GrainPostProcess",function(){return Qm.a}),u.d(P,"HighlightsPostProcess",function(){return Zm}),u.d(P,"ImageProcessingPostProcess",function(){return Xa.a}),u.d(P,"MotionBlurPostProcess",function(){return Jm.a}),u.d(P,"PassPostProcess",function(){return yn.b}),u.d(P,"PassCubePostProcess",function(){return yn.a}),u.d(P,"PostProcess",function(){return ii.a}),u.d(P,"PostProcessManager",function(){return $m.a}),u.d(P,"RefractionPostProcess",function(){return Hh}),u.d(P,"DefaultRenderingPipeline",function(){return Yr.a}),u.d(P,"LensRenderingPipeline",function(){return Yr.b}),u.d(P,"SSAO2RenderingPipeline",function(){return Yr.g}),u.d(P,"SSAORenderingPipeline",function(){return Yr.h}),u.d(P,"StandardRenderingPipeline",function(){return Yr.i}),u.d(P,"PostProcessRenderEffect",function(){return Yr.c}),u.d(P,"PostProcessRenderPipeline",function(){return Yr.d}),u.d(P,"PostProcessRenderPipelineManager",function(){return Yr.e}),u.d(P,"PostProcessRenderPipelineManagerSceneComponent",function(){return Yr.f}),u.d(P,"SharpenPostProcess",function(){return qm.a}),u.d(P,"StereoscopicInterlacePostProcessI",function(){return kn}),u.d(P,"StereoscopicInterlacePostProcess",function(){return Dl}),u.d(P,"TonemappingOperator",function(){return vn}),u.d(P,"TonemapPostProcess",function(){return ev}),u.d(P,"VolumetricLightScatteringPostProcess",function(){return qh}),u.d(P,"VRDistortionCorrectionPostProcess",function(){return Bo}),u.d(P,"VRMultiviewToSingleviewPostProcess",function(){return No}),u.d(P,"ScreenSpaceReflectionPostProcess",function(){return tv.a}),u.d(P,"ScreenSpaceCurvaturePostProcess",function(){return id}),u.d(P,"ReflectionProbe",function(){return rv.a}),u.d(P,"BoundingBoxRenderer",function(){return rd}),u.d(P,"DepthRenderer",function(){return nv.a}),u.d(P,"DepthRendererSceneComponent",function(){return ov.a}),u.d(P,"EdgesRenderer",function(){return ol}),u.d(P,"LineEdgesRenderer",function(){return ld}),u.d(P,"GeometryBufferRenderer",function(){return sv.a}),u.d(P,"GeometryBufferRendererSceneComponent",function(){return iv.a}),u.d(P,"PrePassRenderer",function(){return lv.a}),u.d(P,"PrePassRendererSceneComponent",function(){return uv.a}),u.d(P,"SubSurfaceSceneComponent",function(){return md}),u.d(P,"OutlineRenderer",function(){return Ed}),u.d(P,"RenderingGroup",function(){return fv.a}),u.d(P,"RenderingGroupInfo",function(){return Pd.a}),u.d(P,"RenderingManager",function(){return Pd.b}),u.d(P,"UtilityLayerRenderer",function(){return Xi.a}),u.d(P,"Scene",function(){return q.a}),u.d(P,"SceneComponentConstants",function(){return H.a}),u.d(P,"Stage",function(){return H.b}),u.d(P,"Sprite",function(){return Cd}),u.d(P,"SpriteManager",function(){return Dd}),u.d(P,"SpriteMap",function(){return pv}),u.d(P,"SpritePackedManager",function(){return gv}),u.d(P,"SpriteSceneComponent",function(){return Sd}),u.d(P,"AlphaState",function(){return mv.a}),u.d(P,"DepthCullingState",function(){return Yl.a}),u.d(P,"StencilState",function(){return Xl.a}),u.d(P,"AndOrNotEvaluator",function(){return vv.a}),u.d(P,"AssetTaskState",function(){return Or}),u.d(P,"AbstractAssetTask",function(){return Mr}),u.d(P,"AssetsProgressEvent",function(){return Nd}),u.d(P,"ContainerAssetTask",function(){return wd}),u.d(P,"MeshAssetTask",function(){return Vd}),u.d(P,"TextFileAssetTask",function(){return Ud}),u.d(P,"BinaryFileAssetTask",function(){return Gd}),u.d(P,"ImageAssetTask",function(){return zd}),u.d(P,"TextureAssetTask",function(){return jd}),u.d(P,"CubeTextureAssetTask",function(){return Wd}),u.d(P,"HDRCubeTextureAssetTask",function(){return Hd}),u.d(P,"EquiRectangularCubeTextureAssetTask",function(){return kd}),u.d(P,"AssetsManager",function(){return _v}),u.d(P,"BasisTranscodeConfiguration",function(){return Wg}),u.d(P,"BasisTools",function(){return Eo}),u.d(P,"DDSTools",function(){return rn}),u.d(P,"expandToProperty",function(){return de.b}),u.d(P,"serialize",function(){return de.c}),u.d(P,"serializeAsTexture",function(){return de.m}),u.d(P,"serializeAsColor3",function(){return de.e}),u.d(P,"serializeAsFresnelParameters",function(){return de.h}),u.d(P,"serializeAsVector2",function(){return de.n}),u.d(P,"serializeAsVector3",function(){return de.o}),u.d(P,"serializeAsMeshReference",function(){return de.k}),u.d(P,"serializeAsColorCurves",function(){return de.g}),u.d(P,"serializeAsColor4",function(){return de.f}),u.d(P,"serializeAsImageProcessingConfiguration",function(){return de.i}),u.d(P,"serializeAsQuaternion",function(){return de.l}),u.d(P,"serializeAsMatrix",function(){return de.j}),u.d(P,"serializeAsCameraReference",function(){return de.d}),u.d(P,"SerializationHelper",function(){return de.a}),u.d(P,"Deferred",function(){return yv.a}),u.d(P,"EnvironmentTextureTools",function(){return Wr}),u.d(P,"MeshExploder",function(){return bv}),u.d(P,"FilesInput",function(){return Ev}),u.d(P,"CubeMapToSphericalPolynomialTools",function(){return Cu.a}),u.d(P,"HDRTools",function(){return Ms.a}),u.d(P,"PanoramaToCubeMapTools",function(){return Ec.a}),u.d(P,"KhronosTextureContainer",function(){return $o}),u.d(P,"EventState",function(){return _.a}),u.d(P,"Observer",function(){return _.d}),u.d(P,"MultiObserver",function(){return _.b}),u.d(P,"Observable",function(){return _.c}),u.d(P,"PerformanceMonitor",function(){return Yd.a}),u.d(P,"RollingAverage",function(){return Yd.b}),u.d(P,"PromisePolyfill",function(){return Pv.a}),u.d(P,"SceneOptimization",function(){return xr}),u.d(P,"TextureOptimization",function(){return ca}),u.d(P,"HardwareScalingOptimization",function(){return al}),u.d(P,"ShadowsOptimization",function(){return fa}),u.d(P,"PostProcessesOptimization",function(){return ha}),u.d(P,"LensFlaresOptimization",function(){return da}),u.d(P,"CustomOptimization",function(){return Kd}),u.d(P,"ParticlesOptimization",function(){return pa}),u.d(P,"RenderTargetsOptimization",function(){return sl}),u.d(P,"MergeMeshesOptimization",function(){return ga}),u.d(P,"SceneOptimizerOptions",function(){return ll}),u.d(P,"SceneOptimizer",function(){return Cv}),u.d(P,"SceneSerializer",function(){return cl}),u.d(P,"SmartArray",function(){return Pt.a}),u.d(P,"SmartArrayNoDuplicate",function(){return Pt.b}),u.d(P,"StringDictionary",function(){return Dr.a}),u.d(P,"Tags",function(){return Zd.a}),u.d(P,"TextureTools",function(){return Tv.a}),u.d(P,"TGATools",function(){return qo}),u.d(P,"Tools",function(){return J.b}),u.d(P,"className",function(){return J.c}),u.d(P,"AsyncLoop",function(){return J.a}),u.d(P,"VideoRecorder",function(){return Rv}),u.d(P,"JoystickAxis",function(){return Vt}),u.d(P,"VirtualJoystick",function(){return Ci}),u.d(P,"WorkerPool",function(){return ju.a}),u.d(P,"Logger",function(){return p.a}),u.d(P,"_TypeStore",function(){return f.a}),u.d(P,"FilesInputStore",function(){return Xd.a}),u.d(P,"DeepCopier",function(){return vr.a}),u.d(P,"PivotTools",function(){return fe.a}),u.d(P,"PrecisionDate",function(){return _e.a}),u.d(P,"ScreenshotTools",function(){return Io}),u.d(P,"WebRequest",function(){return Ar.a}),u.d(P,"InspectableType",function(){return fl}),u.d(P,"BRDFTextureTools",function(){return Ff.a}),u.d(P,"RGBDTextureTools",function(){return tu.a}),u.d(P,"ColorGradient",function(){return qs}),u.d(P,"Color3Gradient",function(){return Jf}),u.d(P,"FactorGradient",function(){return el}),u.d(P,"GradientHelper",function(){return Qi}),u.d(P,"PerfCounter",function(){return fr.a}),u.d(P,"RetryStrategy",function(){return Av.a}),u.d(P,"CanvasGenerator",function(){return Nl.a}),u.d(P,"LoadFileError",function(){return va.b}),u.d(P,"RequestFileError",function(){return va.d}),u.d(P,"ReadFileError",function(){return va.c}),u.d(P,"FileTools",function(){return va.a}),u.d(P,"StringTools",function(){return Rr.a}),u.d(P,"DataReader",function(){return Ov.a}),u.d(P,"MinMaxReducer",function(){return Mv.a}),u.d(P,"DepthReducer",function(){return xv.a}),u.d(P,"DataStorage",function(){return Dv}),u.d(P,"SceneRecorder",function(){return Iv}),u.d(P,"KhronosTextureContainer2",function(){return Ps}),u.d(P,"Trajectory",function(){return Lv}),u.d(P,"TrajectoryClassifier",function(){return Fv}),u.d(P,"TimerState",function(){return nn}),u.d(P,"setAndStartTimer",function(){return Ss}),u.d(P,"AdvancedTimer",function(){return Rg}),u.d(P,"CopyTools",function(){return Bv.a}),u.d(P,"WebXRCamera",function(){return Hu}),u.d(P,"WebXREnterExitUIButton",function(){return Qu}),u.d(P,"WebXREnterExitUIOptions",function(){return Sg}),u.d(P,"WebXREnterExitUI",function(){return Zu}),u.d(P,"WebXRExperienceHelper",function(){return ku}),u.d(P,"WebXRInput",function(){return Ku}),u.d(P,"WebXRInputSource",function(){return Yu}),u.d(P,"WebXRManagedOutputCanvasOptions",function(){return wo}),u.d(P,"WebXRManagedOutputCanvas",function(){return to}),u.d(P,"WebXRState",function(){return pi}),u.d(P,"WebXRTrackingState",function(){return Nr}),u.d(P,"WebXRSessionManager",function(){return bn}),u.d(P,"WebXRDefaultExperienceOptions",function(){return Ag}),u.d(P,"WebXRDefaultExperience",function(){return Ju}),u.d(P,"WebXRFeatureName",function(){return ur}),u.d(P,"WebXRFeaturesManager",function(){return or}),u.d(P,"WebXRAbstractFeature",function(){return cr}),u.d(P,"WebXRHitTestLegacy",function(){return _a}),u.d(P,"WebXRAnchorSystem",function(){return ya}),u.d(P,"WebXRPlaneDetector",function(){return ba}),u.d(P,"WebXRBackgroundRemover",function(){return Ea}),u.d(P,"WebXRMotionControllerTeleportation",function(){return _o}),u.d(P,"WebXRControllerPointerSelection",function(){return vo}),u.d(P,"IWebXRControllerPhysicsOptions",function(){return Vv}),u.d(P,"WebXRControllerPhysics",function(){return Pa}),u.d(P,"WebXRHitTest",function(){return Ca}),u.d(P,"WebXRFeaturePointSystem",function(){return Sa}),u.d(P,"WebXRHand",function(){return ep}),u.d(P,"WebXRHandTracking",function(){return Ta}),u.d(P,"WebXRMeshDetector",function(){return Ra}),u.d(P,"WebXRImageTracking",function(){return Aa}),u.d(P,"WebXRAbstractMotionController",function(){return An}),u.d(P,"WebXRControllerComponent",function(){return Rn}),u.d(P,"WebXRGenericTriggerMotionController",function(){return Cs}),u.d(P,"WebXRMicrosoftMixedRealityController",function(){return tp}),u.d(P,"WebXRMotionControllerManager",function(){return ar}),u.d(P,"WebXROculusTouchMotionController",function(){return dl}),u.d(P,"WebXRHTCViveMotionController",function(){return ip}),u.d(P,"WebXRProfiledMotionController",function(){return Xu});var S=u(468),R=u(669),U=u(511),O=u(671),x=u(618),G=u(619),T=u(620),h=u(434),f=u(437),d=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,r)||this;return o._sound=i,o}return t.prototype._prepare=function(){},t.prototype.execute=function(){this._sound!==void 0&&this._sound.play()},t.prototype.serialize=function(e){return n.prototype._serialize.call(this,{name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)},t}(U.a),g=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,r)||this;return o._sound=i,o}return t.prototype._prepare=function(){},t.prototype.execute=function(){this._sound!==void 0&&this._sound.stop()},t.prototype.serialize=function(e){return n.prototype._serialize.call(this,{name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)},t}(U.a);f.a.RegisteredTypes["BABYLON.PlaySoundAction"]=g,f.a.RegisteredTypes["BABYLON.StopSoundAction"]=g;var p=u(440),_=u(438),m=u(441),l=u(436),y=u(483),E=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v){a===void 0&&(a=1e3);var b=n.call(this,e,s)||this;return b.duration=1e3,b.onInterpolationDoneObservable=new _.c,b.propertyPath=r,b.value=o,b.duration=a,b.stopOtherAnimations=c,b.onInterpolationDone=v,b._target=b._effectiveTarget=i,b}return t.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},t.prototype.execute=function(){var e=this,i=this._actionManager.getScene(),r=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}],o;if(typeof this.value=="number")o=y.a.ANIMATIONTYPE_FLOAT;else if(this.value instanceof m.a)o=y.a.ANIMATIONTYPE_COLOR3;else if(this.value instanceof l.e)o=y.a.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof l.a)o=y.a.ANIMATIONTYPE_MATRIX;else if(this.value instanceof l.b)o=y.a.ANIMATIONTYPE_QUATERNION;else{p.a.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}var a=new y.a("InterpolateValueAction",this._property,100*(1e3/this.duration),o,y.a.ANIMATIONLOOPMODE_CONSTANT);a.setKeys(r),this.stopOtherAnimations&&i.stopAnimation(this._effectiveTarget);var s=function(){e.onInterpolationDoneObservable.notifyObservers(e),e.onInterpolationDone&&e.onInterpolationDone()};i.beginDirectAnimation(this._effectiveTarget,[a],0,100,!1,1,s)},t.prototype.serialize=function(e){return n.prototype._serialize.call(this,{name:"InterpolateValueAction",properties:[U.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:U.a._SerializeValueAsString(this.value)},{name:"duration",value:U.a._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:U.a._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)},t}(U.a);f.a.RegisteredTypes["BABYLON.InterpolateValueAction"]=E;var A=u(530),F=u(540),B=function(){function n(){this.enableBlending=!1,this.blendingSpeed=.01,this.loopMode=y.a.ANIMATIONLOOPMODE_CYCLE}return n}(),L=u(613),I=u(572),z=function(){function n(t,e,i){this.frame=t,this.action=e,this.onlyOnce=i,this.isDone=!1}return n.prototype._clone=function(){return new n(this.frame,this.action,this.onlyOnce)},n}(),k=u(707),j=u(672),w=function(){function n(t){this.path=t,this._onchange=new Array,this.value=0,this.animations=new Array}return n.prototype.getPoint=function(){var t=this.path.getPointAtLengthPosition(this.value);return new l.e(t.x,0,t.y)},n.prototype.moveAhead=function(t){return t===void 0&&(t=.002),this.move(t),this},n.prototype.moveBack=function(t){return t===void 0&&(t=.002),this.move(-t),this},n.prototype.move=function(t){if(Math.abs(t)>1)throw"step size should be less than 1.";return this.value+=t,this.ensureLimits(),this.raiseOnChange(),this},n.prototype.ensureLimits=function(){for(;this.value>1;)this.value-=1;for(;this.value<0;)this.value+=1;return this},n.prototype.raiseOnChange=function(){var t=this;return this._onchange.forEach(function(e){return e(t)}),this},n.prototype.onchange=function(t){return this._onchange.push(t),this},n}(),Q=u(604),W=u(445),Y=function(){function n(t){this.SMOOTHING=.75,this.FFT_SIZE=512,this.BARGRAPHAMPLITUDE=256,this.DEBUGCANVASPOS={x:20,y:20},this.DEBUGCANVASSIZE={width:320,height:200},this._scene=t,this._audioEngine=W.a.audioEngine,this._audioEngine.canUseWebAudio&&this._audioEngine.audioContext&&(this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser(),this._webAudioAnalyser.minDecibels=-140,this._webAudioAnalyser.maxDecibels=0,this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount))}return n.prototype.getFrequencyBinCount=function(){return this._audioEngine.canUseWebAudio?this._webAudioAnalyser.frequencyBinCount:0},n.prototype.getByteFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)),this._byteFreqs},n.prototype.getByteTimeDomainData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)),this._byteTime},n.prototype.getFloatFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)),this._floatFreqs},n.prototype.drawDebugCanvas=function(){var t=this;if(this._audioEngine.canUseWebAudio&&(this._debugCanvas||(this._debugCanvas=document.createElement("canvas"),this._debugCanvas.width=this.DEBUGCANVASSIZE.width,this._debugCanvas.height=this.DEBUGCANVASSIZE.height,this._debugCanvas.style.position="absolute",this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px",this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px",this._debugCanvasContext=this._debugCanvas.getContext("2d"),document.body.appendChild(this._debugCanvas),this._registerFunc=function(){t.drawDebugCanvas()},this._scene.registerBeforeRender(this._registerFunc)),this._registerFunc&&this._debugCanvasContext)){var e=this.getByteFrequencyData();this._debugCanvasContext.fillStyle="rgb(0, 0, 0)",this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(var i=0;i<this.getFrequencyBinCount();i++){var r=e[i],o=r/this.BARGRAPHAMPLITUDE,a=this.DEBUGCANVASSIZE.height*o,s=this.DEBUGCANVASSIZE.height-a-1,c=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount(),v=i/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+v+", 100%, 50%)",this._debugCanvasContext.fillRect(i*c,s,c,a)}}},n.prototype.stopDebugCanvas=function(){this._debugCanvas&&(this._registerFunc&&(this._scene.unregisterBeforeRender(this._registerFunc),this._registerFunc=null),document.body.removeChild(this._debugCanvas),this._debugCanvas=null,this._debugCanvasContext=null)},n.prototype.connectAudioNodes=function(t,e){this._audioEngine.canUseWebAudio&&(t.connect(this._webAudioAnalyser),this._webAudioAnalyser.connect(e))},n.prototype.dispose=function(){this._audioEngine.canUseWebAudio&&this._webAudioAnalyser.disconnect()},n}(),he=u(660);W.a.AudioEngineFactory=function(n){return new le(n)};var le=function(){function n(t){var e=this;if(t===void 0&&(t=null),this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!0,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new _.c,this.onAudioLockedObservable=new _.c,this._tryToRun=!1,this._onResize=function(){e._moveButtonToTopLeft()},!!he.a.IsWindowObjectExist()){(typeof window.AudioContext!="undefined"||typeof window.webkitAudioContext!="undefined")&&(window.AudioContext=window.AudioContext||window.webkitAudioContext,this.canUseWebAudio=!0);var i=document.createElement("audio");this._hostElement=t;try{i&&!!i.canPlayType&&(i.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||i.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch(r){}try{i&&!!i.canPlayType&&i.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch(r){}}}return Object.defineProperty(n.prototype,"audioContext",{get:function(){return this._audioContextInitialized?!this.unlocked&&!this._muteButton&&this._displayMuteButton():this._initializeAudioContext(),this._audioContext},enumerable:!1,configurable:!0}),n.prototype.lock=function(){this._triggerSuspendedState()},n.prototype.unlock=function(){this._triggerRunningState()},n.prototype._resumeAudioContext=function(){var t;return this._audioContext.resume!==void 0&&(t=this._audioContext.resume()),t||Promise.resolve()},n.prototype._initializeAudioContext=function(){try{this.canUseWebAudio&&(this._audioContext=new AudioContext,this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(this._audioContext.destination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(t){this.canUseWebAudio=!1,p.a.Error("Web Audio: "+t.message)}},n.prototype._triggerRunningState=function(){var t=this;this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(function(){t._tryToRun=!1,t._muteButton&&t._hideMuteButton(),t.unlocked=!0,t.onAudioUnlockedObservable.notifyObservers(t)}).catch(function(){t._tryToRun=!1,t.unlocked=!1}))},n.prototype._triggerSuspendedState=function(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()},n.prototype._displayMuteButton=function(){var t=this;if(!(this.useCustomUnlockedButton||this._muteButton)){this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";var e=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png",i=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+e+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",r=document.createElement("style");r.appendChild(document.createTextNode(i)),document.getElementsByTagName("head")[0].appendChild(r),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",function(){t._triggerRunningState()},!0),this._muteButton.addEventListener("click",function(){t._triggerRunningState()},!0),window.addEventListener("resize",this._onResize)}},n.prototype._moveButtonToTopLeft=function(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")},n.prototype._hideMuteButton=function(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)},n.prototype.dispose=function(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()},n.prototype.getGlobalVolume=function(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1},n.prototype.setGlobalVolume=function(t){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=t)},n.prototype.connectToAnalyser=function(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=t,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))},n}(),J=u(443),Re=u(476),Me=function(){function n(t,e,i,r,o){var a=this;r===void 0&&(r=null);var s,c,v,b;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.spatialSound=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new _.c,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=l.e.Zero(),this._localDirection=new l.e(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=t,this._scene=i,n._SceneComponentInitialization(i),this._readyToPlayCallback=r,this._customAttenuationFunction=function(X,ee,ie,ge,pe){return ee<ie?X*(1-ee/ie):0},o&&(this.autoplay=o.autoplay||!1,this._loop=o.loop||!1,o.volume!==void 0&&(this._volume=o.volume),this.spatialSound=(s=o.spatialSound)!==null&&s!==void 0?s:!1,this.maxDistance=(c=o.maxDistance)!==null&&c!==void 0?c:100,this.useCustomAttenuation=(v=o.useCustomAttenuation)!==null&&v!==void 0?v:!1,this.rolloffFactor=o.rolloffFactor||1,this.refDistance=o.refDistance||1,this.distanceModel=o.distanceModel||"linear",this._playbackRate=o.playbackRate||1,this._streaming=(b=o.streaming)!==null&&b!==void 0?b:!1,this._length=o.length,this._offset=o.offset),W.a.audioEngine.canUseWebAudio&&W.a.audioEngine.audioContext){this._soundGain=W.a.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this.spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);var C=!0;if(e)try{typeof e=="string"?this._urlType="String":e instanceof ArrayBuffer?this._urlType="ArrayBuffer":e instanceof MediaStream?this._urlType="MediaStream":Array.isArray(e)&&(this._urlType="Array");var M=[],N=!1;switch(this._urlType){case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=W.a.audioEngine.audioContext.createMediaStreamSource(e),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":e.byteLength>0&&(N=!0,this._soundLoaded(e));break;case"String":M.push(e);case"Array":M.length===0&&(M=e);for(var D=0;D<M.length;D++){var V=M[D];if(N=o&&o.skipCodecCheck||V.indexOf(".mp3",V.length-4)!==-1&&W.a.audioEngine.isMP3supported||V.indexOf(".ogg",V.length-4)!==-1&&W.a.audioEngine.isOGGsupported||V.indexOf(".wav",V.length-4)!==-1||V.indexOf(".m4a",V.length-4)!==-1||V.indexOf("blob:")!==-1,N){this._streaming?(this._htmlAudioElement=new Audio(V),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,J.b.SetCorsBehavior(V,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",function(){a._isReadyToPlay=!0,a.autoplay&&a.play(0,a._offset,a._length),a._readyToPlayCallback&&a._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(V,function(X){a._soundLoaded(X)},void 0,!0,!0,function(X){X&&p.a.Error("XHR "+X.status+" error on: "+V+"."),p.a.Error("Sound creation aborted."),a._scene.mainSoundTrack.removeSound(a)});break}}break;default:C=!1;break}C?N||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout(function(){a._readyToPlayCallback&&a._readyToPlayCallback()},1e3)):p.a.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(X){p.a.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),W.a.audioEngine.WarnedWebAudioUnsupported||(p.a.Error("Web Audio is not supported by your browser."),W.a.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout(function(){a._readyToPlayCallback&&a._readyToPlayCallback()},1e3)}return Object.defineProperty(n.prototype,"loop",{get:function(){return this._loop},set:function(t){t!==this._loop&&(this._loop=t,this.updateOptions({loop:t}))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentTime",{get:function(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;var t=this._startOffset;return this.isPlaying&&W.a.audioEngine.audioContext&&(t+=W.a.audioEngine.audioContext.currentTime-this._startTime),t},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){W.a.audioEngine.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))},n.prototype.isReady=function(){return this._isReadyToPlay},n.prototype.getClassName=function(){return"Sound"},n.prototype._soundLoaded=function(t){var e=this;!W.a.audioEngine.audioContext||W.a.audioEngine.audioContext.decodeAudioData(t,function(i){e._audioBuffer=i,e._isReadyToPlay=!0,e.autoplay&&e.play(0,e._offset,e._length),e._readyToPlayCallback&&e._readyToPlayCallback()},function(i){p.a.Error("Error while decoding audio data for: "+e.name+" / Error: "+i)})},n.prototype.setAudioBuffer=function(t){W.a.audioEngine.canUseWebAudio&&(this._audioBuffer=t,this._isReadyToPlay=!0)},n.prototype.updateOptions=function(t){var e,i,r,o,a,s,c,v,b;t&&(this.loop=(e=t.loop)!==null&&e!==void 0?e:this.loop,this.maxDistance=(i=t.maxDistance)!==null&&i!==void 0?i:this.maxDistance,this.useCustomAttenuation=(r=t.useCustomAttenuation)!==null&&r!==void 0?r:this.useCustomAttenuation,this.rolloffFactor=(o=t.rolloffFactor)!==null&&o!==void 0?o:this.rolloffFactor,this.refDistance=(a=t.refDistance)!==null&&a!==void 0?a:this.refDistance,this.distanceModel=(s=t.distanceModel)!==null&&s!==void 0?s:this.distanceModel,this._playbackRate=(c=t.playbackRate)!==null&&c!==void 0?c:this._playbackRate,this._length=(v=t.length)!==null&&v!==void 0?v:void 0,this._offset=(b=t.offset)!==null&&b!==void 0?b:void 0,this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))},n.prototype._createSpatialParameters=function(){W.a.audioEngine.canUseWebAudio&&W.a.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=W.a.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))},n.prototype._updateSpatialParameters=function(){this.spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))},n.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF",this._switchPanningModel()},n.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower",this._switchPanningModel()},n.prototype._switchPanningModel=function(){W.a.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)},n.prototype.connectToSoundTrackAudioNode=function(t){W.a.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(t),this._isOutputConnected=!0)},n.prototype.setDirectionalCone=function(t,e,i){if(e<t){p.a.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,this._coneOuterAngle=e,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))},Object.defineProperty(n.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(t){if(t!=this._coneInnerAngle){if(this._coneOuterAngle<t){p.a.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,W.a.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(t){if(t!=this._coneOuterAngle){if(t<this._coneInnerAngle){p.a.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=t,W.a.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}},enumerable:!1,configurable:!0}),n.prototype.setPosition=function(t){this._position=t,W.a.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z)},n.prototype.setLocalDirectionToMesh=function(t){this._localDirection=t,W.a.audioEngine.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()},n.prototype._updateDirection=function(){if(!(!this._connectedTransformNode||!this._soundPanner)){var t=this._connectedTransformNode.getWorldMatrix(),e=l.e.TransformNormal(this._localDirection,t);e.normalize(),this._soundPanner.setOrientation(e.x,e.y,e.z)}},n.prototype.updateDistanceFromListener=function(){if(W.a.audioEngine.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){var t=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}},n.prototype.setAttenuationFunction=function(t){this._customAttenuationFunction=t},n.prototype.play=function(t,e,i){var r=this;if(this._isReadyToPlay&&this._scene.audioEnabled&&W.a.audioEngine.audioContext)try{this._startOffset<0&&(t=-this._startOffset,this._startOffset=0);var o=t?W.a.audioEngine.audioContext.currentTime+t:W.a.audioEngine.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this.spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=W.a.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=function(){r._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){var a=function(){if(W.a.audioEngine.unlocked){var s=r._htmlAudioElement.play();s!==void 0&&s.catch(function(c){W.a.audioEngine.lock(),(r.loop||r.autoplay)&&W.a.audioEngine.onAudioUnlockedObservable.addOnce(function(){a()})})}else(r.loop||r.autoplay)&&W.a.audioEngine.onAudioUnlockedObservable.addOnce(function(){a()})};a()}}else{var a=function(){if(W.a.audioEngine.audioContext){if(i=i||r._length,e=e||r._offset,r._soundSource){var c=r._soundSource;c.onended=function(){c.disconnect()}}if(r._soundSource=W.a.audioEngine.audioContext.createBufferSource(),r._soundSource&&r._inputAudioNode){r._soundSource.buffer=r._audioBuffer,r._soundSource.connect(r._inputAudioNode),r._soundSource.loop=r.loop,e!==void 0&&(r._soundSource.loopStart=e),i!==void 0&&(r._soundSource.loopEnd=(e|0)+i),r._soundSource.playbackRate.value=r._playbackRate,r._soundSource.onended=function(){r._onended()},o=t?W.a.audioEngine.audioContext.currentTime+t:W.a.audioEngine.audioContext.currentTime;var v=r.isPaused?r._startOffset%r._soundSource.buffer.duration:e||0;r._soundSource.start(o,v,r.loop?void 0:i)}}};W.a.audioEngine.audioContext.state==="suspended"?setTimeout(function(){W.a.audioEngine.audioContext.state==="suspended"?(W.a.audioEngine.lock(),(r.loop||r.autoplay)&&W.a.audioEngine.onAudioUnlockedObservable.addOnce(function(){a()})):a()},500):a()}this._startTime=o,this.isPlaying=!0,this.isPaused=!1}catch(s){p.a.Error("Error while trying to play audio: "+this.name+", "+s.message)}},n.prototype._onended=function(){this.isPlaying=!1,this._startOffset=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)},n.prototype.stop=function(t){var e=this;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(W.a.audioEngine.audioContext&&this._soundSource){var i=t?W.a.audioEngine.audioContext.currentTime+t:void 0;this._soundSource.stop(i),i===void 0?this.isPlaying=!1:this._soundSource.onended=function(){e.isPlaying=!1},this.isPaused||(this._startOffset=0)}}},n.prototype.pause=function(){this.isPlaying&&(this.isPaused=!0,this._streaming?this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect():W.a.audioEngine.audioContext&&(this.stop(0),this._startOffset+=W.a.audioEngine.audioContext.currentTime-this._startTime))},n.prototype.setVolume=function(t,e){W.a.audioEngine.canUseWebAudio&&this._soundGain&&(e&&W.a.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(W.a.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,W.a.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(t,W.a.audioEngine.audioContext.currentTime+e)):this._soundGain.gain.value=t),this._volume=t},n.prototype.setPlaybackRate=function(t){this._playbackRate=t,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))},n.prototype.getVolume=function(){return this._volume},n.prototype.attachToMesh=function(t){var e=this;this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=t,this.spatialSound||(this.spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=function(i){return e._onRegisterAfterWorldMatrixUpdate(i)},this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)},n.prototype.detachFromMesh=function(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)},n.prototype._onRegisterAfterWorldMatrixUpdate=function(t){if(!t.getBoundingInfo)this.setPosition(t.absolutePosition);else{var e=t,i=e.getBoundingInfo();this.setPosition(i.boundingSphere.centerWorld)}W.a.audioEngine.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()},n.prototype.clone=function(){var t=this;if(this._streaming)return null;var e=function(){t._isReadyToPlay?(r._audioBuffer=t.getAudioBuffer(),r._isReadyToPlay=!0,r.autoplay&&r.play(0,t._offset,t._length)):window.setTimeout(e,300)},i={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},r=new n(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,i);return this.useCustomAttenuation&&r.setAttenuationFunction(this._customAttenuationFunction),r.setPosition(this._position),r.setPlaybackRate(this._playbackRate),e(),r},n.prototype.getAudioBuffer=function(){return this._audioBuffer},n.prototype.getSoundSource=function(){return this._soundSource},n.prototype.getSoundGain=function(){return this._soundGain},n.prototype.serialize=function(){var t={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this.spatialSound&&(this._connectedTransformNode&&(t.connectedMeshId=this._connectedTransformNode.id),t.position=this._position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this._coneInnerAngle,t.coneOuterAngle=this._coneOuterAngle,t.coneOuterGain=this._coneOuterGain),t},n.Parse=function(t,e,i,r){var o=t.name,a;t.url?a=i+t.url:a=i+o;var s={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate},c;if(!r)c=new n(o,a,e,function(){e._removePendingData(c)},s),e._addPendingData(c);else{var v=function(){r._isReadyToPlay?(c._audioBuffer=r.getAudioBuffer(),c._isReadyToPlay=!0,c.autoplay&&c.play(0,c._offset,c._length)):window.setTimeout(v,300)};c=new n(o,new ArrayBuffer(0),e,null,s),v()}if(t.position){var b=l.e.FromArray(t.position);c.setPosition(b)}if(t.isDirectional&&(c.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){var C=l.e.FromArray(t.localDirectionToMesh);c.setLocalDirectionToMesh(C)}if(t.connectedMeshId){var M=e.getMeshByID(t.connectedMeshId);M&&c.attachToMesh(M)}return t.metadata&&(c.metadata=t.metadata),c},n._SceneComponentInitialization=function(t){throw Re.a.WarnImport("AudioSceneComponent")},n}(),me=function(){function n(t,e){e===void 0&&(e={}),this.id=-1,this._isInitialized=!1,this._scene=t,this.soundCollection=new Array,this._options=e,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1)}return n.prototype._initializeSoundTrackAudioGraph=function(){W.a.audioEngine.canUseWebAudio&&W.a.audioEngine.audioContext&&(this._outputAudioNode=W.a.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(W.a.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)},n.prototype.dispose=function(){if(W.a.audioEngine&&W.a.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}},n.prototype.addSound=function(t){this._isInitialized||this._initializeSoundTrackAudioGraph(),W.a.audioEngine.canUseWebAudio&&this._outputAudioNode&&t.connectToSoundTrackAudioNode(this._outputAudioNode),t.soundTrackId&&(t.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(t):this._scene.soundTracks&&this._scene.soundTracks[t.soundTrackId].removeSound(t)),this.soundCollection.push(t),t.soundTrackId=this.id},n.prototype.removeSound=function(t){var e=this.soundCollection.indexOf(t);e!==-1&&this.soundCollection.splice(e,1)},n.prototype.setVolume=function(t){W.a.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=t)},n.prototype.switchPanningModelToHRTF=function(){if(W.a.audioEngine.canUseWebAudio)for(var t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()},n.prototype.switchPanningModelToEqualPower=function(){if(W.a.audioEngine.canUseWebAudio)for(var t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()},n.prototype.connectToAnalyser=function(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=t,W.a.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,W.a.audioEngine.masterGain))},n}(),H=u(452),q=u(449),_e=u(589);S.a.AddParser(H.a.NAME_AUDIO,function(n,t,e,i){var r=[],o;if(e.sounds=e.sounds||[],n.sounds!==void 0&&n.sounds!==null)for(var a=0,s=n.sounds.length;a<s;a++){var c=n.sounds[a];W.a.audioEngine.canUseWebAudio?(c.url||(c.url=c.name),r[c.url]?e.sounds.push(Me.Parse(c,t,i,r[c.url])):(o=Me.Parse(c,t,i),r[c.url]=o,e.sounds.push(o))):e.sounds.push(new Me(c.name,null,t))}r=[]}),Object.defineProperty(q.a.prototype,"mainSoundTrack",{get:function(){var n=this._getComponent(H.a.NAME_AUDIO);return n||(n=new Ee(this),this._addComponent(n)),this._mainSoundTrack||(this._mainSoundTrack=new me(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),q.a.prototype.getSoundByName=function(n){var t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===n)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks){for(var e=0;e<this.soundTracks.length;e++)for(t=0;t<this.soundTracks[e].soundCollection.length;t++)if(this.soundTracks[e].soundCollection[t].name===n)return this.soundTracks[e].soundCollection[t]}return null},Object.defineProperty(q.a.prototype,"audioEnabled",{get:function(){var n=this._getComponent(H.a.NAME_AUDIO);return n||(n=new Ee(this),this._addComponent(n)),n.audioEnabled},set:function(n){var t=this._getComponent(H.a.NAME_AUDIO);t||(t=new Ee(this),this._addComponent(t)),n?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(q.a.prototype,"headphone",{get:function(){var n=this._getComponent(H.a.NAME_AUDIO);return n||(n=new Ee(this),this._addComponent(n)),n.headphone},set:function(n){var t=this._getComponent(H.a.NAME_AUDIO);t||(t=new Ee(this),this._addComponent(t)),n?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(q.a.prototype,"audioListenerPositionProvider",{get:function(){var n=this._getComponent(H.a.NAME_AUDIO);return n||(n=new Ee(this),this._addComponent(n)),n.audioListenerPositionProvider},set:function(n){var t=this._getComponent(H.a.NAME_AUDIO);if(t||(t=new Ee(this),this._addComponent(t)),typeof n!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=n},enumerable:!0,configurable:!0}),Object.defineProperty(q.a.prototype,"audioPositioningRefreshRate",{get:function(){var n=this._getComponent(H.a.NAME_AUDIO);return n||(n=new Ee(this),this._addComponent(n)),n.audioPositioningRefreshRate},set:function(n){var t=this._getComponent(H.a.NAME_AUDIO);t||(t=new Ee(this),this._addComponent(t)),t.audioPositioningRefreshRate=n},enumerable:!0,configurable:!0});var Ee=function(){function n(t){this.name=H.a.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this._audioListenerPositionProvider=null,this._cachedCameraDirection=new l.e,this._cachedCameraPosition=new l.e,this._lastCheck=0,this.scene=t,t.soundTracks=new Array,t.sounds=new Array}return Object.defineProperty(n.prototype,"audioEnabled",{get:function(){return this._audioEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"headphone",{get:function(){return this._headphone},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"audioListenerPositionProvider",{get:function(){return this._audioListenerPositionProvider},set:function(t){this._audioListenerPositionProvider=t},enumerable:!1,configurable:!0}),n.prototype.register=function(){this.scene._afterRenderStage.registerStep(H.a.STEP_AFTERRENDER_AUDIO,this,this._afterRender)},n.prototype.rebuild=function(){},n.prototype.serialize=function(t){if(t.sounds=[],this.scene.soundTracks)for(var e=0;e<this.scene.soundTracks.length;e++)for(var i=this.scene.soundTracks[e],r=0;r<i.soundCollection.length;r++)t.sounds.push(i.soundCollection[r].serialize())},n.prototype.addFromContainer=function(t){var e=this;!t.sounds||t.sounds.forEach(function(i){i.play(),i.autoplay=!0,e.scene.mainSoundTrack.addSound(i)})},n.prototype.removeFromContainer=function(t,e){var i=this;e===void 0&&(e=!1),!!t.sounds&&t.sounds.forEach(function(r){r.stop(),r.autoplay=!1,i.scene.mainSoundTrack.removeSound(r),e&&r.dispose()})},n.prototype.dispose=function(){var t=this.scene;if(t._mainSoundTrack&&t.mainSoundTrack.dispose(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].dispose()},n.prototype.disableAudio=function(){var t=this.scene;this._audioEnabled=!1,W.a.audioEngine&&W.a.audioEngine.audioContext&&W.a.audioEngine.audioContext.suspend();var e;for(e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].pause();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(var i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].pause()},n.prototype.enableAudio=function(){var t=this.scene;this._audioEnabled=!0,W.a.audioEngine&&W.a.audioEngine.audioContext&&W.a.audioEngine.audioContext.resume();var e;for(e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].isPaused&&t.mainSoundTrack.soundCollection[e].play();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(var i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].isPaused&&t.soundTracks[e].soundCollection[i].play()},n.prototype.switchAudioModeForHeadphones=function(){var t=this.scene;if(this._headphone=!0,t.mainSoundTrack.switchPanningModelToHRTF(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToHRTF()},n.prototype.switchAudioModeForNormalSpeakers=function(){var t=this.scene;if(this._headphone=!1,t.mainSoundTrack.switchPanningModelToEqualPower(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToEqualPower()},n.prototype._afterRender=function(){var t=_e.a.Now;if(!(this._lastCheck&&t-this._lastCheck<this.audioPositioningRefreshRate)){this._lastCheck=t;var e=this.scene;if(!(!this._audioEnabled||!e._mainSoundTrack||!e.soundTracks||e._mainSoundTrack.soundCollection.length===0&&e.soundTracks.length===1)){var i=W.a.audioEngine;if(!!i&&i.audioContext){if(this._audioListenerPositionProvider){var r=this._audioListenerPositionProvider();r.x=r.x||0,r.y=r.y||0,r.z=r.z||0,i.audioContext.listener.setPosition(r.x,r.y,r.z)}else{var o;if(e.activeCameras&&e.activeCameras.length>0?o=e.activeCameras[0]:o=e.activeCamera,o){this._cachedCameraPosition.equals(o.globalPosition)||(this._cachedCameraPosition.copyFrom(o.globalPosition),i.audioContext.listener.setPosition(o.globalPosition.x,o.globalPosition.y,o.globalPosition.z)),o.rigCameras&&o.rigCameras.length>0&&(o=o.rigCameras[0]);var a=l.a.Invert(o.getViewMatrix()),s=l.e.TransformNormal(n._CameraDirection,a);s.normalize(),!isNaN(s.x)&&!isNaN(s.y)&&!isNaN(s.z)&&(this._cachedCameraDirection.equals(s)||(this._cachedCameraDirection.copyFrom(s),i.audioContext.listener.setOrientation(s.x,s.y,s.z,0,1,0)))}else i.audioContext.listener.setPosition(0,0,0)}var c;for(c=0;c<e.mainSoundTrack.soundCollection.length;c++){var v=e.mainSoundTrack.soundCollection[c];v.useCustomAttenuation&&v.updateDistanceFromListener()}if(e.soundTracks)for(c=0;c<e.soundTracks.length;c++)for(var b=0;b<e.soundTracks[c].soundCollection.length;b++)v=e.soundTracks[c].soundCollection[b],v.useCustomAttenuation&&v.updateDistanceFromListener()}}}},n._CameraDirection=new l.e(0,0,-1),n}();Me._SceneComponentInitialization=function(n){var t=n._getComponent(H.a.NAME_AUDIO);t||(t=new Ee(n),n._addComponent(t))};var Te=function(){function n(t,e,i){var r=this;if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],e.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=t,this._weights=i;for(var o=0,a=0,s=i;a<s.length;a++){var c=s[a];o+=c}for(var v=o>0?1/o:0,b=0;b<this._weights.length;b++)this._weights[b]*=v;this._sounds=e;for(var C=0,M=this._sounds;C<M.length;C++){var N=M[C];N.onEndedObservable.add(function(){r._onended()})}}return Object.defineProperty(n.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(t){if(t!==this._coneInnerAngle){if(this._coneOuterAngle<t){p.a.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t;for(var e=0,i=this._sounds;e<i.length;e++){var r=i[e];r.directionalConeInnerAngle=t}}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(t){if(t!==this._coneOuterAngle){if(t<this._coneInnerAngle){p.a.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=t;for(var e=0,i=this._sounds;e<i.length;e++){var r=i[e];r.directionalConeOuterAngle=t}}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"volume",{get:function(){return this._volume},set:function(t){if(t!==this._volume)for(var e=0,i=this._sounds;e<i.length;e++){var r=i[e];r.setVolume(t)}},enumerable:!1,configurable:!0}),n.prototype._onended=function(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1},n.prototype.pause=function(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()},n.prototype.stop=function(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()},n.prototype.play=function(t){if(!this.isPaused){this.stop();for(var e=Math.random(),i=0,r=0;r<this._weights.length;r++)if(i+=this._weights[r],e<=i){this._currentIndex=r;break}}var o=this._sounds[this._currentIndex];o.isReady()?o.play(0,this.isPaused?void 0:t):o.autoplay=!0,this.isPlaying=!0,this.isPaused=!1},n}(),se=u(722),ve=u(723),ye=u(724),Le=function(){function n(t,e,i,r){e===void 0&&(e=new l.e),i===void 0&&(i=0),r===void 0&&(r=!1),this.direction=t,this.rotatedDirection=e,this.diff=i,this.ignore=r}return n}(),be=function(){function n(t){this.ui=t,this.name="AttachToBoxBehavior",this.distanceAwayFromFace=.15,this.distanceAwayFromBottomOfFace=.15,this._faceVectors=[new Le(l.e.Up()),new Le(l.e.Down()),new Le(l.e.Left()),new Le(l.e.Right()),new Le(l.e.Forward()),new Le(l.e.Forward().scaleInPlace(-1))],this._tmpMatrix=new l.a,this._tmpVector=new l.e,this._zeroVector=l.e.Zero(),this._lookAtTmpMatrix=new l.a}return n.prototype.init=function(){},n.prototype._closestFace=function(t){var e=this;return this._faceVectors.forEach(function(i){e._target.rotationQuaternion||(e._target.rotationQuaternion=l.b.RotationYawPitchRoll(e._target.rotation.y,e._target.rotation.x,e._target.rotation.z)),e._target.rotationQuaternion.toRotationMatrix(e._tmpMatrix),l.e.TransformCoordinatesToRef(i.direction,e._tmpMatrix,i.rotatedDirection),i.diff=l.e.GetAngleBetweenVectors(i.rotatedDirection,t,l.e.Cross(i.rotatedDirection,t))}),this._faceVectors.reduce(function(i,r){return i.ignore?r:r.ignore||i.diff<r.diff?i:r},this._faceVectors[0])},n.prototype._lookAtToRef=function(t,e,i){e===void 0&&(e=new l.e(0,1,0)),l.a.LookAtLHToRef(this._zeroVector,t,e,this._lookAtTmpMatrix),this._lookAtTmpMatrix.invert(),l.b.FromRotationMatrixToRef(this._lookAtTmpMatrix,i)},n.prototype.attach=function(t){var e=this;this._target=t,this._scene=this._target.getScene(),this._onRenderObserver=this._scene.onBeforeRenderObservable.add(function(){if(!!e._scene.activeCamera){var i=e._scene.activeCamera.position;e._scene.activeCamera.devicePosition&&(i=e._scene.activeCamera.devicePosition);var r=e._closestFace(i.subtract(t.position));e._scene.activeCamera.leftCamera?e._scene.activeCamera.leftCamera.computeWorldMatrix().getRotationMatrixToRef(e._tmpMatrix):e._scene.activeCamera.computeWorldMatrix().getRotationMatrixToRef(e._tmpMatrix),l.e.TransformCoordinatesToRef(l.e.Up(),e._tmpMatrix,e._tmpVector),e._faceVectors.forEach(function(a){r.direction.x&&a.direction.x&&(a.ignore=!0),r.direction.y&&a.direction.y&&(a.ignore=!0),r.direction.z&&a.direction.z&&(a.ignore=!0)});var o=e._closestFace(e._tmpVector);e._faceVectors.forEach(function(a){a.ignore=!1}),e.ui.position.copyFrom(t.position),r.direction.x&&(r.rotatedDirection.scaleToRef(t.scaling.x/2+e.distanceAwayFromFace,e._tmpVector),e.ui.position.addInPlace(e._tmpVector)),r.direction.y&&(r.rotatedDirection.scaleToRef(t.scaling.y/2+e.distanceAwayFromFace,e._tmpVector),e.ui.position.addInPlace(e._tmpVector)),r.direction.z&&(r.rotatedDirection.scaleToRef(t.scaling.z/2+e.distanceAwayFromFace,e._tmpVector),e.ui.position.addInPlace(e._tmpVector)),e.ui.rotationQuaternion||(e.ui.rotationQuaternion=l.b.RotationYawPitchRoll(e.ui.rotation.y,e.ui.rotation.x,e.ui.rotation.z)),r.rotatedDirection.scaleToRef(-1,e._tmpVector),e._lookAtToRef(e._tmpVector,o.rotatedDirection,e.ui.rotationQuaternion),o.direction.x&&e.ui.up.scaleToRef(e.distanceAwayFromBottomOfFace-t.scaling.x/2,e._tmpVector),o.direction.y&&e.ui.up.scaleToRef(e.distanceAwayFromBottomOfFace-t.scaling.y/2,e._tmpVector),o.direction.z&&e.ui.up.scaleToRef(e.distanceAwayFromBottomOfFace-t.scaling.z/2,e._tmpVector),e.ui.position.addInPlace(e._tmpVector)}})},n.prototype.detach=function(){this._scene.onBeforeRenderObservable.remove(this._onRenderObserver)},n}(),ze=function(){function n(){var t=this;this.delay=0,this.fadeInTime=300,this._millisecondsPerFrame=1e3/60,this._hovered=!1,this._hoverValue=0,this._ownerNode=null,this._update=function(){if(t._ownerNode){if(t._hoverValue+=t._hovered?t._millisecondsPerFrame:-t._millisecondsPerFrame,t._setAllVisibility(t._ownerNode,(t._hoverValue-t.delay)/t.fadeInTime),t._ownerNode.visibility>1){t._setAllVisibility(t._ownerNode,1),t._hoverValue=t.fadeInTime+t.delay;return}else if(t._ownerNode.visibility<0&&(t._setAllVisibility(t._ownerNode,0),t._hoverValue<0)){t._hoverValue=0;return}setTimeout(t._update,t._millisecondsPerFrame)}}}return Object.defineProperty(n.prototype,"name",{get:function(){return"FadeInOut"},enumerable:!1,configurable:!0}),n.prototype.init=function(){},n.prototype.attach=function(t){this._ownerNode=t,this._setAllVisibility(this._ownerNode,0)},n.prototype.detach=function(){this._ownerNode=null},n.prototype.fadeIn=function(t){this._hovered=t,this._update()},n.prototype._setAllVisibility=function(t,e){var i=this;t.visibility=e,t.getChildMeshes().forEach(function(r){i._setAllVisibility(r,e)})},n}(),Ye=u(505),He=function(){function n(){this._startDistance=0,this._initialScale=new l.e(0,0,0),this._targetScale=new l.e(0,0,0),this._sceneRenderObserver=null,this._dragBehaviorA=new Ye.a({}),this._dragBehaviorA.moveAttached=!1,this._dragBehaviorB=new Ye.a({}),this._dragBehaviorB.moveAttached=!1}return Object.defineProperty(n.prototype,"name",{get:function(){return"MultiPointerScale"},enumerable:!1,configurable:!0}),n.prototype.init=function(){},n.prototype._getCurrentDistance=function(){return this._dragBehaviorA.lastDragPosition.subtract(this._dragBehaviorB.lastDragPosition).length()},n.prototype.attach=function(t){var e=this;this._ownerNode=t,this._dragBehaviorA.onDragStartObservable.add(function(i){e._dragBehaviorA.dragging&&e._dragBehaviorB.dragging&&(e._dragBehaviorA.currentDraggingPointerID==e._dragBehaviorB.currentDraggingPointerID?e._dragBehaviorA.releaseDrag():(e._initialScale.copyFrom(t.scaling),e._startDistance=e._getCurrentDistance()))}),this._dragBehaviorB.onDragStartObservable.add(function(i){e._dragBehaviorA.dragging&&e._dragBehaviorB.dragging&&(e._dragBehaviorA.currentDraggingPointerID==e._dragBehaviorB.currentDraggingPointerID?e._dragBehaviorB.releaseDrag():(e._initialScale.copyFrom(t.scaling),e._startDistance=e._getCurrentDistance()))}),[this._dragBehaviorA,this._dragBehaviorB].forEach(function(i){i.onDragObservable.add(function(){if(e._dragBehaviorA.dragging&&e._dragBehaviorB.dragging){var r=e._getCurrentDistance()/e._startDistance;e._initialScale.scaleToRef(r,e._targetScale)}})}),t.addBehavior(this._dragBehaviorA),t.addBehavior(this._dragBehaviorB),this._sceneRenderObserver=t.getScene().onBeforeRenderObservable.add(function(){if(e._dragBehaviorA.dragging&&e._dragBehaviorB.dragging){var i=e._targetScale.subtract(t.scaling).scaleInPlace(.1);i.length()>.01&&t.scaling.addInPlace(i)}})},n.prototype.detach=function(){var t=this;this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),[this._dragBehaviorA,this._dragBehaviorB].forEach(function(e){e.onDragStartObservable.clear(),e.onDragObservable.clear(),t._ownerNode.removeBehavior(e)})},n}(),Ue=u(462),re=u(464),Z=u(451),fe=u(546),ue=function(){function n(){this._sceneRenderObserver=null,this._targetPosition=new l.e(0,0,0),this._moving=!1,this._startingOrientation=new l.b,this._attachedToElement=!1,this.zDragFactor=3,this.rotateDraggedObject=!0,this.dragging=!1,this.dragDeltaRatio=.2,this.currentDraggingPointerID=-1,this.detachCameraControls=!0,this.onDragStartObservable=new _.c,this.onDragObservable=new _.c,this.onDragEndObservable=new _.c}return Object.defineProperty(n.prototype,"name",{get:function(){return"SixDofDrag"},enumerable:!1,configurable:!0}),n.prototype.init=function(){},Object.defineProperty(n.prototype,"_pointerCamera",{get:function(){return this._scene.cameraToUseForPointers?this._scene.cameraToUseForPointers:this._scene.activeCamera},enumerable:!1,configurable:!0}),n.prototype.attach=function(t){var e=this;this._ownerNode=t,this._scene=this._ownerNode.getScene(),n._virtualScene||(n._virtualScene=new q.a(this._scene.getEngine(),{virtual:!0}),n._virtualScene.detachControl(),this._scene.getEngine().scenes.pop());var i=null,r=new l.e(0,0,0);this._virtualOriginMesh=new Ue.a("",n._virtualScene),this._virtualOriginMesh.rotationQuaternion=new l.b,this._virtualDragMesh=new Ue.a("",n._virtualScene),this._virtualDragMesh.rotationQuaternion=new l.b;var o=function(s){return e._ownerNode==s||s.isDescendantOf(e._ownerNode)};this._pointerObserver=this._scene.onPointerObservable.add(function(s,c){if(s.type==re.a.POINTERDOWN){if(!e.dragging&&s.pickInfo&&s.pickInfo.hit&&s.pickInfo.pickedMesh&&s.pickInfo.ray&&o(s.pickInfo.pickedMesh)){e._pointerCamera&&e._pointerCamera.cameraRigMode==Z.a.RIG_MODE_NONE&&s.pickInfo.ray.origin.copyFrom(e._pointerCamera.globalPosition),i=e._ownerNode,fe.a._RemoveAndStorePivotPoint(i),r.copyFrom(s.pickInfo.ray.origin),e._virtualOriginMesh.position.copyFrom(s.pickInfo.ray.origin),e._virtualOriginMesh.lookAt(s.pickInfo.ray.origin.add(s.pickInfo.ray.direction)),e._virtualOriginMesh.removeChild(e._virtualDragMesh),i.computeWorldMatrix(),e._virtualDragMesh.position.copyFrom(i.absolutePosition),i.rotationQuaternion||(i.rotationQuaternion=l.b.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z));var v=i.parent;i.setParent(null),e._virtualDragMesh.rotationQuaternion.copyFrom(i.rotationQuaternion),i.setParent(v),e._virtualOriginMesh.addChild(e._virtualDragMesh),e._targetPosition.copyFrom(e._virtualDragMesh.absolutePosition),e.dragging=!0,e.currentDraggingPointerID=s.event.pointerId,e.detachCameraControls&&e._pointerCamera&&!e._pointerCamera.leftCamera&&(e._pointerCamera.inputs.attachedToElement?(e._pointerCamera.detachControl(),e._attachedToElement=!0):e._attachedToElement=!1),fe.a._RestorePivotPoint(i),e.onDragStartObservable.notifyObservers({})}}else if(s.type==re.a.POINTERUP||s.type==re.a.POINTERDOUBLETAP)e.currentDraggingPointerID==s.event.pointerId&&(e.dragging=!1,e._moving=!1,e.currentDraggingPointerID=-1,i=null,e._virtualOriginMesh.removeChild(e._virtualDragMesh),e.detachCameraControls&&e._attachedToElement&&e._pointerCamera&&!e._pointerCamera.leftCamera&&(e._pointerCamera.attachControl(!0),e._attachedToElement=!1),e.onDragEndObservable.notifyObservers({}));else if(s.type==re.a.POINTERMOVE&&e.currentDraggingPointerID==s.event.pointerId&&e.dragging&&s.pickInfo&&s.pickInfo.ray&&i){var b=e.zDragFactor;e._pointerCamera&&e._pointerCamera.cameraRigMode==Z.a.RIG_MODE_NONE&&(s.pickInfo.ray.origin.copyFrom(e._pointerCamera.globalPosition),b=0);var C=s.pickInfo.ray.origin.subtract(r);r.copyFrom(s.pickInfo.ray.origin);var M=-l.e.Dot(C,s.pickInfo.ray.direction);e._virtualOriginMesh.addChild(e._virtualDragMesh),e._virtualDragMesh.position.z-=e._virtualDragMesh.position.z<1?M*e.zDragFactor:M*b*e._virtualDragMesh.position.z,e._virtualDragMesh.position.z<0&&(e._virtualDragMesh.position.z=0),e._virtualOriginMesh.position.copyFrom(s.pickInfo.ray.origin),e._virtualOriginMesh.lookAt(s.pickInfo.ray.origin.add(s.pickInfo.ray.direction)),e._virtualOriginMesh.removeChild(e._virtualDragMesh),e._targetPosition.copyFrom(e._virtualDragMesh.absolutePosition),i.parent&&l.e.TransformCoordinatesToRef(e._targetPosition,l.a.Invert(i.parent.getWorldMatrix()),e._targetPosition),e._moving||e._startingOrientation.copyFrom(e._virtualDragMesh.rotationQuaternion),e._moving=!0}});var a=new l.b;this._sceneRenderObserver=t.getScene().onBeforeRenderObservable.add(function(){if(e.dragging&&e._moving&&i){if(fe.a._RemoveAndStorePivotPoint(i),i.position.addInPlace(e._targetPosition.subtract(i.position).scale(e.dragDeltaRatio)),e.rotateDraggedObject){a.copyFrom(e._startingOrientation),a.x=-a.x,a.y=-a.y,a.z=-a.z,e._virtualDragMesh.rotationQuaternion.multiplyToRef(a,a),l.b.RotationYawPitchRollToRef(a.toEulerAngles("xyz").y,0,0,a),a.multiplyToRef(e._startingOrientation,a);var s=i.parent;(!s||s.scaling&&!s.scaling.isNonUniformWithinEpsilon(.001))&&(i.setParent(null),l.b.SlerpToRef(i.rotationQuaternion,a,e.dragDeltaRatio,i.rotationQuaternion),i.setParent(s))}fe.a._RestorePivotPoint(i),e.onDragObservable.notifyObservers()}})},n.prototype.detach=function(){this._scene&&(this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._pointerCamera.attachControl(!0),this._attachedToElement=!1),this._scene.onPointerObservable.remove(this._pointerObserver)),this._ownerNode&&this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),this._virtualOriginMesh&&this._virtualOriginMesh.dispose(),this._virtualDragMesh&&this._virtualDragMesh.dispose(),this.onDragEndObservable.clear(),this.onDragObservable.clear(),this.onDragStartObservable.clear()},n}(),Ge=u(542),xe=u(465),ne=function(){function n(t,e,i){if(this.targetPosition=l.e.Zero(),this.poleTargetPosition=l.e.Zero(),this.poleTargetLocalOffset=l.e.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=l.b.Identity(),this._bone1Mat=l.a.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=l.e.Right(),this._slerping=!1,this._adjustRoll=0,this._bone2=e,this._bone1=e.getParent(),!!this._bone1){this.mesh=t;var r=e.getPosition();if(e.getAbsoluteTransform().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,r.x>r.y&&r.x>r.z&&(this._adjustRoll=Math.PI*.5,this._bendAxis.z=1)),this._bone1.length){var o=this._bone1.getScale(),a=this._bone2.getScale();this._bone1Length=this._bone1.length*o.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*a.y*this.mesh.scaling.y}else if(this._bone1.children[0]){t.computeWorldMatrix(!0);var s=this._bone2.children[0].getAbsolutePosition(t),c=this._bone2.getAbsolutePosition(t),v=this._bone1.getAbsolutePosition(t);this._bone1Length=l.e.Distance(s,c),this._bone2Length=l.e.Distance(c,v)}this._bone1.getRotationMatrixToRef(xe.c.WORLD,t,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}}return Object.defineProperty(n.prototype,"maxAngle",{get:function(){return this._maxAngle},set:function(t){this._setMaxAngle(t)},enumerable:!1,configurable:!0}),n.prototype._setMaxAngle=function(t){t<0&&(t=0),(t>Math.PI||t==null)&&(t=Math.PI),this._maxAngle=t;var e=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(e*e+i*i-2*e*i*Math.cos(t))},n.prototype.update=function(){var t=this._bone1;if(!!t){var e=this.targetPosition,i=this.poleTargetPosition,r=n._tmpMats[0],o=n._tmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,i):this.poleTargetMesh&&l.e.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),i);var a=n._tmpVecs[0],s=n._tmpVecs[1],c=n._tmpVecs[2],v=n._tmpVecs[3],b=n._tmpVecs[4],C=n._tmpQuat;t.getAbsolutePositionToRef(this.mesh,a),i.subtractToRef(a,b),b.x==0&&b.y==0&&b.z==0?b.y=1:b.normalize(),e.subtractToRef(a,v),v.normalize(),l.e.CrossToRef(v,b,s),s.normalize(),l.e.CrossToRef(v,s,c),c.normalize(),l.a.FromXYZAxesToRef(c,v,s,r);var M=this._bone1Length,N=this._bone2Length,D=l.e.Distance(a,e);this._maxReach>0&&(D=Math.min(this._maxReach,D));var V=(N*N+D*D-M*M)/(2*N*D),X=(D*D+M*M-N*N)/(2*D*M);V>1&&(V=1),X>1&&(X=1),V<-1&&(V=-1),X<-1&&(X=-1);var ee=Math.acos(V),ie=Math.acos(X),ge=-ee-ie;if(this._rightHandedSystem)l.a.RotationYawPitchRollToRef(0,0,this._adjustRoll,o),o.multiplyToRef(r,r),l.a.RotationAxisToRef(this._bendAxis,ie,o),o.multiplyToRef(r,r);else{var pe=n._tmpVecs[5];pe.copyFrom(this._bendAxis),pe.x*=-1,l.a.RotationAxisToRef(pe,-ie,o),o.multiplyToRef(r,r)}this.poleAngle&&(l.a.RotationAxisToRef(v,this.poleAngle,o),r.multiplyToRef(o,r)),this._bone1&&(this.slerpAmount<1?(this._slerping||l.b.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),l.b.FromRotationMatrixToRef(r,C),l.b.SlerpToRef(this._bone1Quat,C,this.slerpAmount,this._bone1Quat),ge=this._bone2Ang*(1-this.slerpAmount)+ge*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,xe.c.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(r,xe.c.WORLD,this.mesh),this._bone1Mat.copyFrom(r),this._slerping=!1)),this._bone2.setAxisAngle(this._bendAxis,ge,xe.c.LOCAL),this._bone2Ang=ge}},n._tmpVecs=[l.e.Zero(),l.e.Zero(),l.e.Zero(),l.e.Zero(),l.e.Zero(),l.e.Zero()],n._tmpQuat=l.b.Identity(),n._tmpMats=[l.a.Identity(),l.a.Identity()],n}(),Ke=u(588),nt=function(){function n(t,e,i,r){if(this.upAxis=l.e.Up(),this.upAxisSpace=xe.c.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=l.b.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=l.e.Forward(),this.mesh=t,this.bone=e,this.target=i,r&&(r.adjustYaw&&(this.adjustYaw=r.adjustYaw),r.adjustPitch&&(this.adjustPitch=r.adjustPitch),r.adjustRoll&&(this.adjustRoll=r.adjustRoll),r.maxYaw!=null?this.maxYaw=r.maxYaw:this.maxYaw=Math.PI,r.minYaw!=null?this.minYaw=r.minYaw:this.minYaw=-Math.PI,r.maxPitch!=null?this.maxPitch=r.maxPitch:this.maxPitch=Math.PI,r.minPitch!=null?this.minPitch=r.minPitch:this.minPitch=-Math.PI,r.slerpAmount!=null&&(this.slerpAmount=r.slerpAmount),r.upAxis!=null&&(this.upAxis=r.upAxis),r.upAxisSpace!=null&&(this.upAxisSpace=r.upAxisSpace),r.yawAxis!=null||r.pitchAxis!=null)){var o=xe.a.Y,a=xe.a.X;r.yawAxis!=null&&(o=r.yawAxis.clone(),o.normalize()),r.pitchAxis!=null&&(a=r.pitchAxis.clone(),a.normalize());var s=l.e.Cross(a,o);this._transformYawPitch=l.a.Identity(),l.a.FromXYZAxesToRef(a,o,s,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}!e.getParent()&&this.upAxisSpace==xe.c.BONE&&(this.upAxisSpace=xe.c.LOCAL)}return Object.defineProperty(n.prototype,"minYaw",{get:function(){return this._minYaw},set:function(t){this._minYaw=t,this._minYawSin=Math.sin(t),this._minYawCos=Math.cos(t),this._maxYaw!=null&&(this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"maxYaw",{get:function(){return this._maxYaw},set:function(t){this._maxYaw=t,this._maxYawSin=Math.sin(t),this._maxYawCos=Math.cos(t),this._minYaw!=null&&(this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"minPitch",{get:function(){return this._minPitch},set:function(t){this._minPitch=t,this._minPitchTan=Math.tan(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"maxPitch",{get:function(){return this._maxPitch},set:function(t){this._maxPitch=t,this._maxPitchTan=Math.tan(t)},enumerable:!1,configurable:!0}),n.prototype.update=function(){if(this.slerpAmount<1&&!this._firstFrameSkipped){this._firstFrameSkipped=!0;return}var t=this.bone,e=n._tmpVecs[0];t.getAbsolutePositionToRef(this.mesh,e);var i=this.target,r=n._tmpMats[0],o=n._tmpMats[1],a=this.mesh,s=t.getParent(),c=n._tmpVecs[1];c.copyFrom(this.upAxis),this.upAxisSpace==xe.c.BONE&&s?(this._transformYawPitch&&l.e.TransformCoordinatesToRef(c,this._transformYawPitchInv,c),s.getDirectionToRef(c,this.mesh,c)):this.upAxisSpace==xe.c.LOCAL&&(a.getDirectionToRef(c,c),(a.scaling.x!=1||a.scaling.y!=1||a.scaling.z!=1)&&c.normalize());var v=!1,b=!1;if((this._maxYaw!=Math.PI||this._minYaw!=-Math.PI)&&(v=!0),(this._maxPitch!=Math.PI||this._minPitch!=-Math.PI)&&(b=!0),v||b){var C=n._tmpMats[2],M=n._tmpMats[3];if(this.upAxisSpace==xe.c.BONE&&c.y==1&&s)s.getRotationMatrixToRef(xe.c.WORLD,this.mesh,C);else if(this.upAxisSpace==xe.c.LOCAL&&c.y==1&&!s)C.copyFrom(a.getWorldMatrix());else{var N=n._tmpVecs[2];N.copyFrom(this._fowardAxis),this._transformYawPitch&&l.e.TransformCoordinatesToRef(N,this._transformYawPitchInv,N),s?s.getDirectionToRef(N,this.mesh,N):a.getDirectionToRef(N,N);var D=l.e.Cross(c,N);D.normalize();var N=l.e.Cross(D,c);l.a.FromXYZAxesToRef(D,c,N,C)}C.invertToRef(M);var V=null;if(b){var X=n._tmpVecs[3];i.subtractToRef(e,X),l.e.TransformCoordinatesToRef(X,M,X),V=Math.sqrt(X.x*X.x+X.z*X.z);var ee=Math.atan2(X.y,V),ie=ee;ee>this._maxPitch?(X.y=this._maxPitchTan*V,ie=this._maxPitch):ee<this._minPitch&&(X.y=this._minPitchTan*V,ie=this._minPitch),ee!=ie&&(l.e.TransformCoordinatesToRef(X,C,X),X.addInPlace(e),i=X)}if(v){var X=n._tmpVecs[4];i.subtractToRef(e,X),l.e.TransformCoordinatesToRef(X,M,X);var ge=Math.atan2(X.x,X.z),pe=ge;if((ge>this._maxYaw||ge<this._minYaw)&&(V==null&&(V=Math.sqrt(X.x*X.x+X.z*X.z)),this._yawRange>Math.PI?this._isAngleBetween(ge,this._maxYaw,this._midYawConstraint)?(X.z=this._maxYawCos*V,X.x=this._maxYawSin*V,pe=this._maxYaw):this._isAngleBetween(ge,this._midYawConstraint,this._minYaw)&&(X.z=this._minYawCos*V,X.x=this._minYawSin*V,pe=this._minYaw):ge>this._maxYaw?(X.z=this._maxYawCos*V,X.x=this._maxYawSin*V,pe=this._maxYaw):ge<this._minYaw&&(X.z=this._minYawCos*V,X.x=this._minYawSin*V,pe=this._minYaw)),this._slerping&&this._yawRange>Math.PI){var te=n._tmpVecs[8];te.copyFrom(xe.a.Z),this._transformYawPitch&&l.e.TransformCoordinatesToRef(te,this._transformYawPitchInv,te);var Ce=n._tmpMats[4];this._boneQuat.toRotationMatrix(Ce),this.mesh.getWorldMatrix().multiplyToRef(Ce,Ce),l.e.TransformCoordinatesToRef(te,Ce,te),l.e.TransformCoordinatesToRef(te,M,te);var Ae=Math.atan2(te.x,te.z),De=this._getAngleBetween(Ae,ge),Fe=this._getAngleBetween(Ae,this._midYawConstraint);if(De>Fe){V==null&&(V=Math.sqrt(X.x*X.x+X.z*X.z));var We=this._getAngleBetween(Ae,this._maxYaw),Pe=this._getAngleBetween(Ae,this._minYaw);Pe<We?(pe=Ae+Math.PI*.75,X.z=Math.cos(pe)*V,X.x=Math.sin(pe)*V):(pe=Ae-Math.PI*.75,X.z=Math.cos(pe)*V,X.x=Math.sin(pe)*V)}}ge!=pe&&(l.e.TransformCoordinatesToRef(X,C,X),X.addInPlace(e),i=X)}}var Ne=n._tmpVecs[5],je=n._tmpVecs[6],Be=n._tmpVecs[7],Je=n._tmpQuat;i.subtractToRef(e,Ne),Ne.normalize(),l.e.CrossToRef(c,Ne,je),je.normalize(),l.e.CrossToRef(Ne,je,Be),Be.normalize(),l.a.FromXYZAxesToRef(je,Be,Ne,r),!(je.x===0&&je.y===0&&je.z===0)&&(Be.x===0&&Be.y===0&&Be.z===0||Ne.x===0&&Ne.y===0&&Ne.z===0||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(l.a.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,o),o.multiplyToRef(r,r)),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(xe.c.WORLD,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),l.b.FromRotationMatrixToRef(r,Je),l.b.SlerpToRef(this._boneQuat,Je,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,xe.c.WORLD,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),this.bone.setRotationMatrix(r,xe.c.WORLD,this.mesh),this._slerping=!1)))},n.prototype._getAngleDiff=function(t,e){var i=e-t;return i%=Math.PI*2,i>Math.PI?i-=Math.PI*2:i<-Math.PI&&(i+=Math.PI*2),i},n.prototype._getAngleBetween=function(t,e){t%=2*Math.PI,t=t<0?t+2*Math.PI:t,e%=2*Math.PI,e=e<0?e+2*Math.PI:e;var i=0;return t<e?i=e-t:i=t-e,i>Math.PI&&(i=Math.PI*2-i),i},n.prototype._isAngleBetween=function(t,e,i){if(t%=2*Math.PI,t=t<0?t+2*Math.PI:t,e%=2*Math.PI,e=e<0?e+2*Math.PI:e,i%=2*Math.PI,i=i<0?i+2*Math.PI:i,e<i){if(t>e&&t<i)return!0}else if(t>i&&t<e)return!0;return!1},n._tmpVecs=Ke.a.BuildArray(10,l.e.Zero),n._tmpQuat=l.b.Identity(),n._tmpMats=Ke.a.BuildArray(5,l.a.Identity),n}(),ut=u(560),pt=u(639),Tt=u(691),de=u(439),Ft=u(460),Jt=function(){function n(t,e){this.x=t,this.y=e}return n}(),Dt=function(){function n(t,e,i,r,o,a,s){r===void 0&&(r=0),o===void 0&&(o=1),a===void 0&&(a=2),s===void 0&&(s=3),this.id=t,this.index=e,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=n.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=o,this._rightStickAxisX=a,this._rightStickAxisY=s,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}return Object.defineProperty(n.prototype,"isConnected",{get:function(){return this._isConnected},enumerable:!1,configurable:!0}),n.prototype.onleftstickchanged=function(t){this._onleftstickchanged=t},n.prototype.onrightstickchanged=function(t){this._onrightstickchanged=t},Object.defineProperty(n.prototype,"leftStick",{get:function(){return this._leftStick},set:function(t){this._onleftstickchanged&&(this._leftStick.x!==t.x||this._leftStick.y!==t.y)&&this._onleftstickchanged(t),this._leftStick=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightStick",{get:function(){return this._rightStick},set:function(t){this._onrightstickchanged&&(this._rightStick.x!==t.x||this._rightStick.y!==t.y)&&this._onrightstickchanged(t),this._rightStick=t},enumerable:!1,configurable:!0}),n.prototype.update=function(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})},n.prototype.dispose=function(){},n.GAMEPAD=0,n.GENERIC=1,n.XBOX=2,n.POSE_ENABLED=3,n.DUALSHOCK=4,n}(),Xt=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o.onButtonDownObservable=new _.c,o.onButtonUpObservable=new _.c,o.type=Dt.GENERIC,o._buttons=new Array(r.buttons.length),o}return t.prototype.onbuttondown=function(e){this._onbuttondown=e},t.prototype.onbuttonup=function(e){this._onbuttonup=e},t.prototype._setButtonValue=function(e,i,r){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(r),this.onButtonDownObservable.notifyObservers(r)),e===0&&(this._onbuttonup&&this._onbuttonup(r),this.onButtonUpObservable.notifyObservers(r))),e},t.prototype.update=function(){n.prototype.update.call(this);for(var e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()},t}(Dt),Kt=function(){function n(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}return Object.defineProperty(n.prototype,"invertYAxis",{get:function(){return this._yAxisScale!==1},set:function(t){this._yAxisScale=t?-1:1},enumerable:!1,configurable:!0}),n.prototype.attachControl=function(){var t=this,e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(function(i){i.type!==Dt.POSE_ENABLED&&(!t.gamepad||i.type===Dt.XBOX)&&(t.gamepad=i)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(function(i){t.gamepad===i&&(t.gamepad=null)}),this.gamepad=e.getGamepadByType(Dt.XBOX)},n.prototype.detachControl=function(t){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null},n.prototype.checkInputs=function(){if(this.gamepad){var t=this.camera,e=this.gamepad.rightStick;if(e){if(e.x!=0){var i=e.x/this.gamepadRotationSensibility;i!=0&&Math.abs(i)>.005&&(t.inertialAlphaOffset+=i)}if(e.y!=0){var r=e.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(t.inertialBetaOffset+=r)}}var o=this.gamepad.leftStick;if(o&&o.y!=0){var a=o.y/this.gamepadMoveSensibility;a!=0&&Math.abs(a)>.005&&(this.camera.inertialRadiusOffset-=a)}}},n.prototype.getClassName=function(){return"ArcRotateCameraGamepadInput"},n.prototype.getSimpleName=function(){return"gamepad"},Object(h.c)([Object(de.c)()],n.prototype,"gamepadRotationSensibility",void 0),Object(h.c)([Object(de.c)()],n.prototype,"gamepadMoveSensibility",void 0),n}();Ft.a.ArcRotateCameraGamepadInput=Kt;var Zi=u(726),zi=u(727),li=u(728),Di=u(623);Di.a.prototype.addVRDeviceOrientation=function(){return this.add(new Qt),this};var Qt=function(){function n(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}return n.prototype.attachControl=function(t){var e=this;t=J.b.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(t);var i=this.camera.getScene().getEngine().getHostWindow();i&&(typeof DeviceOrientationEvent!="undefined"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(function(r){r==="granted"?i.addEventListener("deviceorientation",e._deviceOrientationHandler):J.b.Warn("Permission not granted.")}).catch(function(r){J.b.Error(r)}):i.addEventListener("deviceorientation",this._deviceOrientationHandler))},n.prototype._onOrientationEvent=function(t){t.alpha!==null&&(this._alpha=(+t.alpha|0)*this.alphaCorrection),t.gamma!==null&&(this._gamma=(+t.gamma|0)*this.gammaCorrection),this._dirty=!0},n.prototype.checkInputs=function(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)},n.prototype.detachControl=function(t){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)},n.prototype.getClassName=function(){return"ArcRotateCameraVRDeviceOrientationInput"},n.prototype.getSimpleName=function(){return"VRDeviceOrientation"},n}();Ft.a.ArcRotateCameraVRDeviceOrientationInput=Qt;var _i=u(562),ji=function(){function n(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}return n.prototype.attachControl=function(t){var e=this;t=J.b.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){e._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(i){var r=i.event;if(i.type===_i.a.KEYDOWN){if(e.keysForward.indexOf(r.keyCode)!==-1||e.keysBackward.indexOf(r.keyCode)!==-1||e.keysUp.indexOf(r.keyCode)!==-1||e.keysDown.indexOf(r.keyCode)!==-1||e.keysLeft.indexOf(r.keyCode)!==-1||e.keysRight.indexOf(r.keyCode)!==-1){var o=e._keys.indexOf(r.keyCode);o===-1&&e._keys.push(r.keyCode),t||r.preventDefault()}}else if(e.keysForward.indexOf(r.keyCode)!==-1||e.keysBackward.indexOf(r.keyCode)!==-1||e.keysUp.indexOf(r.keyCode)!==-1||e.keysDown.indexOf(r.keyCode)!==-1||e.keysLeft.indexOf(r.keyCode)!==-1||e.keysRight.indexOf(r.keyCode)!==-1){var o=e._keys.indexOf(r.keyCode);o>=0&&e._keys.splice(o,1),t||r.preventDefault()}}))},n.prototype.detachControl=function(t){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},n.prototype.getClassName=function(){return"FlyCameraKeyboardInput"},n.prototype._onLostFocus=function(t){this._keys=[]},n.prototype.getSimpleName=function(){return"keyboard"},n.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var t=this.camera,e=0;e<this._keys.length;e++){var i=this._keys[e],r=t._computeLocalCameraSpeed();this.keysForward.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,0,r):this.keysBackward.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,0,-r):this.keysUp.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,r,0):this.keysDown.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,-r,0):this.keysRight.indexOf(i)!==-1?t._localDirection.copyFromFloats(r,0,0):this.keysLeft.indexOf(i)!==-1&&t._localDirection.copyFromFloats(-r,0,0),t.getScene().useRightHandedSystem&&(t._localDirection.z*=-1),t.getViewMatrix().invertToRef(t._cameraTransformMatrix),l.e.TransformNormalToRef(t._localDirection,t._cameraTransformMatrix,t._transformedDirection),t.cameraDirection.addInPlace(t._transformedDirection)}},Object(h.c)([Object(de.c)()],n.prototype,"keysForward",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysBackward",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysUp",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysDown",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRight",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysLeft",void 0),n}();Ft.a.FlyCameraKeyboardInput=ji;var yi=function(){function n(t){t===void 0&&(t=!0),this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this.previousPosition=null}return n.prototype.attachControl=function(t){var e=this;t=J.b.BackCompatCameraNoPreventDefault(arguments),this.noPreventDefault=t,this._observer=this.camera.getScene().onPointerObservable.add(function(i,r){e._pointerInput(i,r)},re.a.POINTERDOWN|re.a.POINTERUP|re.a.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(function(){e.camera.rollCorrect&&e.camera.restoreRoll(e.camera.rollCorrect)})},n.prototype.detachControl=function(t){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this.previousPosition=null,this.noPreventDefault=void 0)},n.prototype.getClassName=function(){return"FlyCameraMouseInput"},n.prototype.getSimpleName=function(){return"mouse"},n.prototype._pointerInput=function(t,e){var i=t.event,r=this.camera,o=r.getEngine();if(!o.isInVRExclusivePointerMode&&!(!this.touchEnabled&&i.pointerType==="touch")&&!(t.type!==re.a.POINTERMOVE&&this.buttons.indexOf(i.button)===-1)){var a=i.srcElement||i.target;if(t.type===re.a.POINTERDOWN&&a){try{a.setPointerCapture(i.pointerId)}catch(v){}this.previousPosition={x:i.clientX,y:i.clientY},this.activeButton=i.button,this.noPreventDefault||(i.preventDefault(),this.element.focus()),o.isPointerLock&&this._onMouseMove(t.event)}else if(t.type===re.a.POINTERUP&&a){try{a.releasePointerCapture(i.pointerId)}catch(v){}this.activeButton=-1,this.previousPosition=null,this.noPreventDefault||i.preventDefault()}else if(t.type===re.a.POINTERMOVE){if(!this.previousPosition){o.isPointerLock&&this._onMouseMove(t.event);return}var s=i.clientX-this.previousPosition.x,c=i.clientY-this.previousPosition.y;this.rotateCamera(s,c),this.previousPosition={x:i.clientX,y:i.clientY},this.noPreventDefault||i.preventDefault()}}},n.prototype._onMouseMove=function(t){var e=this.camera,i=e.getEngine();if(!(!i.isPointerLock||i.isInVRExclusivePointerMode)){var r=t.movementX||t.mozMovementX||t.webkitMovementX||t.msMovementX||0,o=t.movementY||t.mozMovementY||t.webkitMovementY||t.msMovementY||0;this.rotateCamera(r,o),this.previousPosition=null,this.noPreventDefault||t.preventDefault()}},n.prototype.rotateCamera=function(t,e){var i=this,r=this.camera,o=this.camera.getScene();o.useRightHandedSystem&&(t*=-1),r.parent&&r.parent._getWorldMatrixDeterminant()<0&&(t*=-1);var a=t/this.angularSensibility,s=e/this.angularSensibility,c=l.b.RotationYawPitchRoll(r.rotation.y,r.rotation.x,r.rotation.z),v;if(this.buttonsPitch.some(function(M){return M===i.activeButton})&&(v=l.b.RotationAxis(xe.a.X,s),c.multiplyInPlace(v)),this.buttonsYaw.some(function(M){return M===i.activeButton})){v=l.b.RotationAxis(xe.a.Y,a),c.multiplyInPlace(v);var b=r.bankedTurnLimit+r._trackRoll;if(r.bankedTurn&&-b<r.rotation.z&&r.rotation.z<b){var C=r.bankedTurnMultiplier*-a;v=l.b.RotationAxis(xe.a.Z,C),c.multiplyInPlace(v)}}this.buttonsRoll.some(function(M){return M===i.activeButton})&&(v=l.b.RotationAxis(xe.a.Z,-a),r._trackRoll-=a,c.multiplyInPlace(v)),c.toEulerAnglesToRef(r.rotation)},Object(h.c)([Object(de.c)()],n.prototype,"buttons",void 0),Object(h.c)([Object(de.c)()],n.prototype,"angularSensibility",void 0),n}();Ft.a.FlyCameraMouseInput=yi;var ai=function(){function n(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}return n.prototype.attachControl=function(t){var e=this;t=J.b.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){e._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(i){var r=i.event;if(!r.metaKey){if(i.type===_i.a.KEYDOWN){if(e._ctrlPressed=r.ctrlKey,e._altPressed=r.altKey,e._shiftPressed=r.shiftKey,e.keysHeightOffsetIncr.indexOf(r.keyCode)!==-1||e.keysHeightOffsetDecr.indexOf(r.keyCode)!==-1||e.keysRotationOffsetIncr.indexOf(r.keyCode)!==-1||e.keysRotationOffsetDecr.indexOf(r.keyCode)!==-1||e.keysRadiusIncr.indexOf(r.keyCode)!==-1||e.keysRadiusDecr.indexOf(r.keyCode)!==-1){var o=e._keys.indexOf(r.keyCode);o===-1&&e._keys.push(r.keyCode),r.preventDefault&&(t||r.preventDefault())}}else if(e.keysHeightOffsetIncr.indexOf(r.keyCode)!==-1||e.keysHeightOffsetDecr.indexOf(r.keyCode)!==-1||e.keysRotationOffsetIncr.indexOf(r.keyCode)!==-1||e.keysRotationOffsetDecr.indexOf(r.keyCode)!==-1||e.keysRadiusIncr.indexOf(r.keyCode)!==-1||e.keysRadiusDecr.indexOf(r.keyCode)!==-1){var o=e._keys.indexOf(r.keyCode);o>=0&&e._keys.splice(o,1),r.preventDefault&&(t||r.preventDefault())}}}))},n.prototype.detachControl=function(t){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},n.prototype.checkInputs=function(){var t=this;this._onKeyboardObserver&&this._keys.forEach(function(e){t.keysHeightOffsetIncr.indexOf(e)!==-1&&t._modifierHeightOffset()?t.camera.heightOffset+=t.heightSensibility:t.keysHeightOffsetDecr.indexOf(e)!==-1&&t._modifierHeightOffset()?t.camera.heightOffset-=t.heightSensibility:t.keysRotationOffsetIncr.indexOf(e)!==-1&&t._modifierRotationOffset()?(t.camera.rotationOffset+=t.rotationSensibility,t.camera.rotationOffset%=360):t.keysRotationOffsetDecr.indexOf(e)!==-1&&t._modifierRotationOffset()?(t.camera.rotationOffset-=t.rotationSensibility,t.camera.rotationOffset%=360):t.keysRadiusIncr.indexOf(e)!==-1&&t._modifierRadius()?t.camera.radius+=t.radiusSensibility:t.keysRadiusDecr.indexOf(e)!==-1&&t._modifierRadius()&&(t.camera.radius-=t.radiusSensibility)})},n.prototype.getClassName=function(){return"FollowCameraKeyboardMoveInput"},n.prototype.getSimpleName=function(){return"keyboard"},n.prototype._modifierHeightOffset=function(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed},n.prototype._modifierRotationOffset=function(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed},n.prototype._modifierRadius=function(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed},Object(h.c)([Object(de.c)()],n.prototype,"keysHeightOffsetIncr",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysHeightOffsetDecr",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysHeightOffsetModifierAlt",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysHeightOffsetModifierCtrl",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysHeightOffsetModifierShift",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRotationOffsetIncr",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRotationOffsetDecr",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRotationOffsetModifierAlt",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRotationOffsetModifierCtrl",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRotationOffsetModifierShift",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRadiusIncr",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRadiusDecr",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRadiusModifierAlt",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRadiusModifierCtrl",void 0),Object(h.c)([Object(de.c)()],n.prototype,"keysRadiusModifierShift",void 0),Object(h.c)([Object(de.c)()],n.prototype,"heightSensibility",void 0),Object(h.c)([Object(de.c)()],n.prototype,"rotationSensibility",void 0),Object(h.c)([Object(de.c)()],n.prototype,"radiusSensibility",void 0),n}();Ft.a.FollowCameraKeyboardMoveInput=ai;var Ei=function(){function n(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}return n.prototype.attachControl=function(t){var e=this;t=J.b.BackCompatCameraNoPreventDefault(arguments),this._wheel=function(i,r){if(i.type===re.a.POINTERWHEEL){var o=i.event,a=0,s=Math.max(-1,Math.min(1,o.deltaY||o.wheelDelta||-o.detail));e.wheelDeltaPercentage?(console.assert(e.axisControlRadius+e.axisControlHeight+e.axisControlRotation<=1,"wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+e.axisControlRadius+", axisControlHeightOffset: "+e.axisControlHeight+", axisControlRotationOffset: "+e.axisControlRotation),e.axisControlRadius?a=s*.01*e.wheelDeltaPercentage*e.camera.radius:e.axisControlHeight?a=s*.01*e.wheelDeltaPercentage*e.camera.heightOffset:e.axisControlRotation&&(a=s*.01*e.wheelDeltaPercentage*e.camera.rotationOffset)):a=s*e.wheelPrecision,a&&(e.axisControlRadius?e.camera.radius+=a:e.axisControlHeight?e.camera.heightOffset-=a:e.axisControlRotation&&(e.camera.rotationOffset-=a)),o.preventDefault&&(t||o.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,re.a.POINTERWHEEL)},n.prototype.detachControl=function(t){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)},n.prototype.getClassName=function(){return"ArcRotateCameraMouseWheelInput"},n.prototype.getSimpleName=function(){return"mousewheel"},Object(h.c)([Object(de.c)()],n.prototype,"axisControlRadius",void 0),Object(h.c)([Object(de.c)()],n.prototype,"axisControlHeight",void 0),Object(h.c)([Object(de.c)()],n.prototype,"axisControlRotation",void 0),Object(h.c)([Object(de.c)()],n.prototype,"wheelPrecision",void 0),Object(h.c)([Object(de.c)()],n.prototype,"wheelDeltaPercentage",void 0),n}();Ft.a.FollowCameraMouseWheelInput=Ei;var Ut=function(n){Object(h.d)(t,n);function t(){var e=n!==null&&n.apply(this,arguments)||this;return e.angularSensibilityX=1,e.angularSensibilityY=1,e.pinchPrecision=1e4,e.pinchDeltaPercentage=0,e.axisXControlRadius=!1,e.axisXControlHeight=!1,e.axisXControlRotation=!0,e.axisYControlRadius=!1,e.axisYControlHeight=!0,e.axisYControlRotation=!1,e.axisPinchControlRadius=!0,e.axisPinchControlHeight=!1,e.axisPinchControlRotation=!1,e.warningEnable=!0,e._warningCounter=0,e}return t.prototype.getClassName=function(){return"FollowCameraPointersInput"},t.prototype.onTouch=function(e,i,r){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=i/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=r/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=i/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=r/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=i/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=r/this.angularSensibilityY)},t.prototype.onMultiTouch=function(e,i,r,o,a,s){if(!(r===0&&a===null)&&!(o===0&&s===null)){var c=(o-r)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(c*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=c*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=c*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=c*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=c),this.axisPinchControlHeight&&(this.camera.heightOffset+=c),this.axisPinchControlRadius&&(this.camera.radius-=c))}},t.prototype._warning=function(){if(!(!this.warningEnable||this._warningCounter++%100!=0)){var e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";console.assert(this.axisXControlRotation+this.axisXControlHeight+this.axisXControlRadius<=1,e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),console.assert(this.axisYControlRotation+this.axisYControlHeight+this.axisYControlRadius<=1,e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),console.assert(this.axisPinchControlRotation+this.axisPinchControlHeight+this.axisPinchControlRadius<=1,e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}},Object(h.c)([Object(de.c)()],t.prototype,"angularSensibilityX",void 0),Object(h.c)([Object(de.c)()],t.prototype,"angularSensibilityY",void 0),Object(h.c)([Object(de.c)()],t.prototype,"pinchPrecision",void 0),Object(h.c)([Object(de.c)()],t.prototype,"pinchDeltaPercentage",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisXControlRadius",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisXControlHeight",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisXControlRotation",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisYControlRadius",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisYControlHeight",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisYControlRotation",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisPinchControlRadius",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisPinchControlHeight",void 0),Object(h.c)([Object(de.c)()],t.prototype,"axisPinchControlRotation",void 0),t}(Tt.a);Ft.a.FollowCameraPointersInput=Ut;var wi=u(531);wi.a.prototype.addDeviceOrientation=function(){return this._deviceOrientationInput||(this._deviceOrientationInput=new ui,this.add(this._deviceOrientationInput)),this};var ui=function(){function n(){var t=this;this._screenOrientationAngle=0,this._screenQuaternion=new l.b,this._alpha=0,this._beta=0,this._gamma=0,this._onDeviceOrientationChangedObservable=new _.c,this._orientationChanged=function(){t._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,t._screenOrientationAngle=-J.b.ToRadians(t._screenOrientationAngle/2),t._screenQuaternion.copyFromFloats(0,Math.sin(t._screenOrientationAngle),0,Math.cos(t._screenOrientationAngle))},this._deviceOrientation=function(e){t._alpha=e.alpha!==null?e.alpha:0,t._beta=e.beta!==null?e.beta:0,t._gamma=e.gamma!==null?e.gamma:0,e.alpha!==null&&t._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new l.b(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}return n.WaitForOrientationChangeAsync=function(t){return new Promise(function(e,i){var r=!1,o=function(){window.removeEventListener("deviceorientation",o),r=!0,e()};t&&setTimeout(function(){r||(window.removeEventListener("deviceorientation",o),i("WaitForOrientationChangeAsync timed out"))},t),typeof DeviceOrientationEvent!="undefined"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(function(a){a=="granted"?window.addEventListener("deviceorientation",o):J.b.Warn("Permission not granted.")}).catch(function(a){J.b.Error(a)}):window.addEventListener("deviceorientation",o)})},Object.defineProperty(n.prototype,"camera",{get:function(){return this._camera},set:function(t){var e=this;this._camera=t,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new l.b),this._camera&&this._camera.onDisposeObservable.add(function(){e._onDeviceOrientationChangedObservable.clear()})},enumerable:!1,configurable:!0}),n.prototype.attachControl=function(){var t=this,e=this.camera.getScene().getEngine().getHostWindow();if(e){var i=function(){e.addEventListener("orientationchange",t._orientationChanged),e.addEventListener("deviceorientation",t._deviceOrientation),t._orientationChanged()};typeof DeviceOrientationEvent!="undefined"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(function(r){r==="granted"?i():J.b.Warn("Permission not granted.")}).catch(function(r){J.b.Error(r)}):i()}},n.prototype.detachControl=function(t){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0},n.prototype.checkInputs=function(){!this._alpha||(l.b.RotationYawPitchRollToRef(J.b.ToRadians(this._alpha),J.b.ToRadians(this._beta),-J.b.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)},n.prototype.getClassName=function(){return"FreeCameraDeviceOrientationInput"},n.prototype.getSimpleName=function(){return"deviceOrientation"},n}();Ft.a.FreeCameraDeviceOrientationInput=ui;var Wi=function(){function n(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this._yAxisScale=1,this._cameraTransform=l.a.Identity(),this._deltaTransform=l.e.Zero(),this._vector3=l.e.Zero(),this._vector2=l.d.Zero()}return Object.defineProperty(n.prototype,"invertYAxis",{get:function(){return this._yAxisScale!==1},set:function(t){this._yAxisScale=t?-1:1},enumerable:!1,configurable:!0}),n.prototype.attachControl=function(){var t=this,e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(function(i){i.type!==Dt.POSE_ENABLED&&(!t.gamepad||i.type===Dt.XBOX)&&(t.gamepad=i)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(function(i){t.gamepad===i&&(t.gamepad=null)}),this.gamepad=e.getGamepadByType(Dt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])},n.prototype.detachControl=function(t){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null},n.prototype.checkInputs=function(){if(this.gamepad&&this.gamepad.leftStick){var t=this.camera,e=this.gamepad.leftStick,i=e.x/this.gamepadMoveSensibility,r=e.y/this.gamepadMoveSensibility;e.x=Math.abs(i)>.005?0+i:0,e.y=Math.abs(r)>.005?0+r:0;var o=this.gamepad.rightStick;if(o){var a=o.x/this.gamepadAngularSensibility,s=o.y/this.gamepadAngularSensibility*this._yAxisScale;o.x=Math.abs(a)>.001?0+a:0,o.y=Math.abs(s)>.001?0+s:0}else o={x:0,y:0};t.rotationQuaternion?t.rotationQuaternion.toRotationMatrix(this._cameraTransform):l.a.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,0,this._cameraTransform);var c=t._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(e.x*c,0,-e.y*c),l.e.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),t.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(o.y,o.x),t.cameraRotation.addInPlace(this._vector2)}},n.prototype.getClassName=function(){return"FreeCameraGamepadInput"},n.prototype.getSimpleName=function(){return"gamepad"},Object(h.c)([Object(de.c)()],n.prototype,"gamepadAngularSensibility",void 0),Object(h.c)([Object(de.c)()],n.prototype,"gamepadMoveSensibility",void 0),n}();Ft.a.FreeCameraGamepadInput=Wi;var Hi=u(640),Pi=u(641),xt=u(642),Ji=u(643),Dr=u(684),Vt;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(Vt||(Vt={}));var Ci=function(){function n(t,e){var i=this,r=Object(h.a)(Object(h.a)({},n._GetDefaultOptions()),e);if(t?this._leftJoystick=!0:this._leftJoystick=!1,n._globalJoystickIndex++,this._axisTargetedByLeftAndRight=Vt.X,this._axisTargetedByUpAndDown=Vt.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new Dr.a,this.deltaPosition=l.e.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=function(a){n.vjCanvasWidth=window.innerWidth,n.vjCanvasHeight=window.innerHeight,n.Canvas&&(n.Canvas.width=n.vjCanvasWidth,n.Canvas.height=n.vjCanvasHeight),n.halfWidth=n.vjCanvasWidth/2},!n.Canvas){window.addEventListener("resize",this._onResize,!1),n.Canvas=document.createElement("canvas"),n.vjCanvasWidth=window.innerWidth,n.vjCanvasHeight=window.innerHeight,n.Canvas.width=window.innerWidth,n.Canvas.height=window.innerHeight,n.Canvas.style.width="100%",n.Canvas.style.height="100%",n.Canvas.style.position="absolute",n.Canvas.style.backgroundColor="transparent",n.Canvas.style.top="0px",n.Canvas.style.left="0px",n.Canvas.style.zIndex="5",n.Canvas.style.msTouchAction="none",n.Canvas.style.touchAction="none",n.Canvas.setAttribute("touch-action","none");var o=n.Canvas.getContext("2d");if(!o)throw new Error("Unable to create canvas for virtual joystick");n.vjCanvasContext=o,n.vjCanvasContext.strokeStyle="#ffffff",n.vjCanvasContext.lineWidth=2,document.body.appendChild(n.Canvas)}n.halfWidth=n.Canvas.width/2,this.pressed=!1,this.limitToContainer=r.limitToContainer,this._joystickColor=r.color,this.containerSize=r.containerSize,this.puckSize=r.puckSize,r.position&&this.setPosition(r.position.x,r.position.y),r.puckImage&&this.setPuckImage(r.puckImage),r.containerImage&&this.setContainerImage(r.containerImage),r.alwaysVisible&&n._alwaysVisibleSticks++,this.alwaysVisible=r.alwaysVisible,this._joystickPointerID=-1,this._joystickPointerPos=new l.d(0,0),this._joystickPreviousPointerPos=new l.d(0,0),this._joystickPointerStartPos=new l.d(0,0),this._deltaJoystickVector=new l.d(0,0),this._onPointerDownHandlerRef=function(a){i._onPointerDown(a)},this._onPointerMoveHandlerRef=function(a){i._onPointerMove(a)},this._onPointerUpHandlerRef=function(a){i._onPointerUp(a)},n.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),n.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),n.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),n.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),n.Canvas.addEventListener("contextmenu",function(a){a.preventDefault()},!1),requestAnimationFrame(function(){i._drawVirtualJoystick()})}return n._GetDefaultOptions=function(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}},n.prototype.setJoystickSensibility=function(t){this._joystickSensibility=t,this._inversedSensibility=1/(this._joystickSensibility/1e3)},n.prototype._onPointerDown=function(t){var e;t.preventDefault(),this._leftJoystick===!0?e=t.clientX<n.halfWidth:e=t.clientX>n.halfWidth,e&&this._joystickPointerID<0?(this._joystickPointerID=t.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(t)):(this._joystickPointerStartPos.x=t.clientX,this._joystickPointerStartPos.y=t.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(t.pointerId.toString(),t)):n._globalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(t.pointerId.toString(),{x:t.clientX,y:t.clientY,prevX:t.clientX,prevY:t.clientY}))},n.prototype._onPointerMove=function(t){if(this._joystickPointerID==t.pointerId){if(this.limitToContainer){var e=new l.d(t.clientX-this._joystickPointerStartPos.x,t.clientY-this._joystickPointerStartPos.y),i=e.length();i>this.containerSize&&e.scaleInPlace(this.containerSize/i),this._joystickPointerPos.x=this._joystickPointerStartPos.x+e.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+e.y}else this._joystickPointerPos.x=t.clientX,this._joystickPointerPos.y=t.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<n._alwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(n.halfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(n.halfWidth,this._joystickPointerPos.x));var r=this.reverseLeftRight?-1:1,o=r*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case Vt.X:this.deltaPosition.x=Math.min(1,Math.max(-1,o));break;case Vt.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,o));break;case Vt.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,o));break}var a=this.reverseUpDown?1:-1,s=a*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case Vt.X:this.deltaPosition.x=Math.min(1,Math.max(-1,s));break;case Vt.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,s));break;case Vt.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,s));break}}else{var c=this._touches.get(t.pointerId.toString());c&&(c.x=t.clientX,c.y=t.clientY)}},n.prototype._onPointerUp=function(t){if(this._joystickPointerID==t.pointerId)this._clearPreviousDraw(),this._joystickPointerID=-1,this.pressed=!1;else{var e=this._touches.get(t.pointerId.toString());e&&n.vjCanvasContext.clearRect(e.prevX-44,e.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(t.pointerId.toString())},n.prototype.setJoystickColor=function(t){this._joystickColor=t},Object.defineProperty(n.prototype,"containerSize",{get:function(){return this._joystickContainerSize},set:function(t){this._joystickContainerSize=t,this._clearContainerSize=~~(this._joystickContainerSize*2.1),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"puckSize",{get:function(){return this._joystickPuckSize},set:function(t){this._joystickPuckSize=t,this._clearPuckSize=~~(this._joystickPuckSize*2.1),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)},enumerable:!1,configurable:!0}),n.prototype.clearPosition=function(){this.alwaysVisible=!1,this._joystickPosition=null},Object.defineProperty(n.prototype,"alwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible!==t&&(t&&this._joystickPosition?(n._alwaysVisibleSticks++,this._alwaysVisible=!0):(n._alwaysVisibleSticks--,this._alwaysVisible=!1))},enumerable:!1,configurable:!0}),n.prototype.setPosition=function(t,e){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new l.d(t,e)},n.prototype.setActionOnTouch=function(t){this._action=t},n.prototype.setAxisForLeftRight=function(t){switch(t){case Vt.X:case Vt.Y:case Vt.Z:this._axisTargetedByLeftAndRight=t;break;default:this._axisTargetedByLeftAndRight=Vt.X;break}},n.prototype.setAxisForUpDown=function(t){switch(t){case Vt.X:case Vt.Y:case Vt.Z:this._axisTargetedByUpAndDown=t;break;default:this._axisTargetedByUpAndDown=Vt.Y;break}},n.prototype._clearPreviousDraw=function(){var t=this._joystickPosition||this._joystickPointerStartPos;n.vjCanvasContext.clearRect(t.x-this._clearContainerSizeOffset,t.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),n.vjCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset,this._clearPuckSize,this._clearPuckSize)},n.prototype.setContainerImage=function(t){var e=this,i=new Image;i.src=t,i.onload=function(){return e._containerImage=i}},n.prototype.setPuckImage=function(t){var e=this,i=new Image;i.src=t,i.onload=function(){return e._puckImage=i}},n.prototype._drawContainer=function(){var t=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?n.vjCanvasContext.drawImage(this._containerImage,t.x-this.containerSize,t.y-this.containerSize,this.containerSize*2,this.containerSize*2):(n.vjCanvasContext.beginPath(),n.vjCanvasContext.strokeStyle=this._joystickColor,n.vjCanvasContext.lineWidth=2,n.vjCanvasContext.arc(t.x,t.y,this.containerSize,0,Math.PI*2,!0),n.vjCanvasContext.stroke(),n.vjCanvasContext.closePath(),n.vjCanvasContext.beginPath(),n.vjCanvasContext.lineWidth=6,n.vjCanvasContext.strokeStyle=this._joystickColor,n.vjCanvasContext.arc(t.x,t.y,this.puckSize,0,Math.PI*2,!0),n.vjCanvasContext.stroke(),n.vjCanvasContext.closePath())},n.prototype._drawPuck=function(){this._puckImage?n.vjCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,this.puckSize*2,this.puckSize*2):(n.vjCanvasContext.beginPath(),n.vjCanvasContext.strokeStyle=this._joystickColor,n.vjCanvasContext.lineWidth=2,n.vjCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,Math.PI*2,!0),n.vjCanvasContext.stroke(),n.vjCanvasContext.closePath())},n.prototype._drawVirtualJoystick=function(){var t=this;this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach(function(e,i){i.pointerId===t._joystickPointerID?(t.alwaysVisible||t._drawContainer(),t._drawPuck(),t._joystickPreviousPointerPos=t._joystickPointerPos.clone()):(n.vjCanvasContext.clearRect(i.prevX-44,i.prevY-44,88,88),n.vjCanvasContext.beginPath(),n.vjCanvasContext.fillStyle="white",n.vjCanvasContext.beginPath(),n.vjCanvasContext.strokeStyle="red",n.vjCanvasContext.lineWidth=6,n.vjCanvasContext.arc(i.x,i.y,40,0,Math.PI*2,!0),n.vjCanvasContext.stroke(),n.vjCanvasContext.closePath(),i.prevX=i.x,i.prevY=i.y)}),requestAnimationFrame(function(){t._drawVirtualJoystick()})},n.prototype.releaseCanvas=function(){n.Canvas&&(n.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),n.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),n.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),n.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(n.Canvas),n.Canvas=null)},n._globalJoystickIndex=0,n._alwaysVisibleSticks=0,n}();wi.a.prototype.addVirtualJoystick=function(){return this.add(new dr),this};var dr=function(){function n(){}return n.prototype.getLeftJoystick=function(){return this._leftjoystick},n.prototype.getRightJoystick=function(){return this._rightjoystick},n.prototype.checkInputs=function(){if(this._leftjoystick){var t=this.camera,e=t._computeLocalCameraSpeed()*50,i=l.a.RotationYawPitchRoll(t.rotation.y,t.rotation.x,0),r=l.e.TransformCoordinates(new l.e(this._leftjoystick.deltaPosition.x*e,this._leftjoystick.deltaPosition.y*e,this._leftjoystick.deltaPosition.z*e),i);t.cameraDirection=t.cameraDirection.add(r),t.cameraRotation=t.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}},n.prototype.attachControl=function(){this._leftjoystick=new Ci(!0),this._leftjoystick.setAxisForUpDown(Vt.Z),this._leftjoystick.setAxisForLeftRight(Vt.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new Ci(!1),this._rightjoystick.setAxisForUpDown(Vt.X),this._rightjoystick.setAxisForLeftRight(Vt.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")},n.prototype.detachControl=function(t){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()},n.prototype.getClassName=function(){return"FreeCameraVirtualJoystickInput"},n.prototype.getSimpleName=function(){return"virtualJoystick"},n}();Ft.a.FreeCameraVirtualJoystickInput=dr;var Ii=u(528),Wt=u(478),Nt=u(453);Nt.a.AddNodeConstructor("TouchCamera",function(n,t){return function(){return new sr(n,l.e.Zero(),t)}});var sr=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o.inputs.addTouch(),o._setupInputs(),o}return Object.defineProperty(t.prototype,"touchAngularSensibility",{get:function(){var e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0},set:function(e){var i=this.inputs.attached.touch;i&&(i.touchAngularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"touchMoveSensibility",{get:function(){var e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0},set:function(e){var i=this.inputs.attached.touch;i&&(i.touchMoveSensibility=e)},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"TouchCamera"},t.prototype._setupInputs=function(){var e=this.inputs.attached.touch,i=this.inputs.attached.mouse;i?i.touchEnabled=!1:e.allowMouse=!0},t}(Wt.a),Ri=u(506);Nt.a.AddNodeConstructor("DeviceOrientationCamera",function(n,t){return function(){return new pr(n,l.e.Zero(),t)}});var pr=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o._tmpDragQuaternion=new l.b,o._disablePointerInputWhenUsingDeviceOrientation=!0,o._dragFactor=0,o._quaternionCache=new l.b,o.inputs.addDeviceOrientation(),o.inputs._deviceOrientationInput&&o.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(function(){o._disablePointerInputWhenUsingDeviceOrientation&&o.inputs._mouseInput&&(o.inputs._mouseInput._allowCameraRotation=!1,o.inputs._mouseInput.onPointerMovedObservable.add(function(a){o._dragFactor!=0&&(o._initialQuaternion||(o._initialQuaternion=new l.b),l.b.FromEulerAnglesToRef(0,a.offsetX*o._dragFactor,0,o._tmpDragQuaternion),o._initialQuaternion.multiplyToRef(o._tmpDragQuaternion,o._initialQuaternion))}))}),o}return Object.defineProperty(t.prototype,"disablePointerInputWhenUsingDeviceOrientation",{get:function(){return this._disablePointerInputWhenUsingDeviceOrientation},set:function(e){this._disablePointerInputWhenUsingDeviceOrientation=e},enumerable:!1,configurable:!0}),t.prototype.enableHorizontalDragging=function(e){e===void 0&&(e=1/300),this._dragFactor=e},t.prototype.getClassName=function(){return"DeviceOrientationCamera"},t.prototype._checkInputs=function(){n.prototype._checkInputs.call(this),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)},t.prototype.resetToCurrentRotation=function(e){var i=this;e===void 0&&(e=xe.a.Y),!!this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new l.b),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(function(r){e[r]?i._initialQuaternion[r]*=-1:i._initialQuaternion[r]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))},t}(Wt.a),Er=function(n){Object(h.d)(t,n);function t(e){return n.call(this,e)||this}return t.prototype.addKeyboard=function(){return this.add(new ji),this},t.prototype.addMouse=function(e){return e===void 0&&(e=!0),this.add(new yi(e)),this},t}(Ft.b),Vi=function(n){Object(h.d)(t,n);function t(e,i,r,o){o===void 0&&(o=!0);var a=n.call(this,e,i,r,o)||this;return a.ellipsoid=new l.e(1,1,1),a.ellipsoidOffset=new l.e(0,0,0),a.checkCollisions=!1,a.applyGravity=!1,a.cameraDirection=l.e.Zero(),a._trackRoll=0,a.rollCorrect=100,a.bankedTurn=!1,a.bankedTurnLimit=Math.PI/2,a.bankedTurnMultiplier=1,a._needMoveForGravity=!1,a._oldPosition=l.e.Zero(),a._diffPosition=l.e.Zero(),a._newPosition=l.e.Zero(),a._collisionMask=-1,a._onCollisionPositionChange=function(s,c,v){v===void 0&&(v=null);var b=function(C){a._newPosition.copyFrom(C),a._newPosition.subtractToRef(a._oldPosition,a._diffPosition),a._diffPosition.length()>W.a.CollisionsEpsilon&&(a.position.addInPlace(a._diffPosition),a.onCollide&&v&&a.onCollide(v))};b(c)},a.inputs=new Er(a),a.inputs.addKeyboard().addMouse(),a}return Object.defineProperty(t.prototype,"angularSensibility",{get:function(){var e=this.inputs.attached.mouse;return e?e.angularSensibility:0},set:function(e){var i=this.inputs.attached.mouse;i&&(i.angularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysForward",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysForward:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysForward=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysBackward",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysBackward:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysBackward=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysUp",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysUp:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysUp=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysDown",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysDown:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysDown=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysLeft",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysLeft:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysLeft=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysRight",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysRight:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysRight=e)},enumerable:!1,configurable:!0}),t.prototype.attachControl=function(e,i){i=J.b.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i)},t.prototype.detachControl=function(){this.inputs.detachElement(),this.cameraDirection=new l.e(0,0,0)},Object.defineProperty(t.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=isNaN(e)?-1:e},enumerable:!1,configurable:!0}),t.prototype._collideWithWorld=function(e){var i;this.parent?i=l.e.TransformCoordinates(this.position,this.parent.getWorldMatrix()):i=this.position,i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);var r=this.getScene().collisionCoordinator;this._collider||(this._collider=r.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var o=e;this.applyGravity&&(o=e.add(this.getScene().gravity)),r.getNewPosition(this._oldPosition,o,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},t.prototype._checkInputs=function(){this._localDirection||(this._localDirection=l.e.Zero(),this._transformedDirection=l.e.Zero()),this.inputs.checkInputs(),n.prototype._checkInputs.call(this)},t.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},t.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):n.prototype._updatePosition.call(this)},t.prototype.restoreRoll=function(e){var i=this._trackRoll,r=this.rotation.z,o=i-r,a=.001;Math.abs(o)>=a&&(this.rotation.z+=o/e,Math.abs(i-this.rotation.z)<=a&&(this.rotation.z=i))},t.prototype.dispose=function(){this.inputs.clear(),n.prototype.dispose.call(this)},t.prototype.getClassName=function(){return"FlyCamera"},Object(h.c)([Object(de.o)()],t.prototype,"ellipsoid",void 0),Object(h.c)([Object(de.o)()],t.prototype,"ellipsoidOffset",void 0),Object(h.c)([Object(de.c)()],t.prototype,"checkCollisions",void 0),Object(h.c)([Object(de.c)()],t.prototype,"applyGravity",void 0),t}(Ii.a),$i=function(n){Object(h.d)(t,n);function t(e){return n.call(this,e)||this}return t.prototype.addKeyboard=function(){return this.add(new ai),this},t.prototype.addMouseWheel=function(){return this.add(new Ei),this},t.prototype.addPointers=function(){return this.add(new Ut),this},t.prototype.addVRDeviceOrientation=function(){return console.warn("DeviceOrientation support not yet implemented for FollowCamera."),this},t}(Ft.b);Nt.a.AddNodeConstructor("FollowCamera",function(n,t){return function(){return new Pr(n,l.e.Zero(),t)}}),Nt.a.AddNodeConstructor("ArcFollowCamera",function(n,t){return function(){return new gr(n,0,0,1,null,t)}});var Pr=function(n){Object(h.d)(t,n);function t(e,i,r,o){o===void 0&&(o=null);var a=n.call(this,e,i,r)||this;return a.radius=12,a.lowerRadiusLimit=null,a.upperRadiusLimit=null,a.rotationOffset=0,a.lowerRotationOffsetLimit=null,a.upperRotationOffsetLimit=null,a.heightOffset=4,a.lowerHeightOffsetLimit=null,a.upperHeightOffsetLimit=null,a.cameraAcceleration=.05,a.maxCameraSpeed=20,a.lockedTarget=o,a.inputs=new $i(a),a.inputs.addKeyboard().addMouseWheel().addPointers(),a}return t.prototype._follow=function(e){if(!!e){var i=l.c.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(i);var r=Math.atan2(i.m[8],i.m[10]),o=J.b.ToRadians(this.rotationOffset)+r,a=e.getAbsolutePosition(),s=a.x+Math.sin(o)*this.radius,c=a.z+Math.cos(o)*this.radius,v=s-this.position.x,b=a.y+this.heightOffset-this.position.y,C=c-this.position.z,M=v*this.cameraAcceleration*2,N=b*this.cameraAcceleration,D=C*this.cameraAcceleration*2;(M>this.maxCameraSpeed||M<-this.maxCameraSpeed)&&(M=M<1?-this.maxCameraSpeed:this.maxCameraSpeed),(N>this.maxCameraSpeed||N<-this.maxCameraSpeed)&&(N=N<1?-this.maxCameraSpeed:this.maxCameraSpeed),(D>this.maxCameraSpeed||D<-this.maxCameraSpeed)&&(D=D<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new l.e(this.position.x+M,this.position.y+N,this.position.z+D),this.setTarget(a)}},t.prototype.attachControl=function(e,i){i=J.b.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i),this._reset=function(){}},t.prototype.detachControl=function(e){this.inputs.detachElement(),this._reset&&this._reset()},t.prototype._checkInputs=function(){this.inputs.checkInputs(),this._checkLimits(),n.prototype._checkInputs.call(this),this.lockedTarget&&this._follow(this.lockedTarget)},t.prototype._checkLimits=function(){this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),this.lowerHeightOffsetLimit!==null&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),this.upperHeightOffsetLimit!==null&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),this.lowerRotationOffsetLimit!==null&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),this.upperRotationOffsetLimit!==null&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)},t.prototype.getClassName=function(){return"FollowCamera"},Object(h.c)([Object(de.c)()],t.prototype,"radius",void 0),Object(h.c)([Object(de.c)()],t.prototype,"lowerRadiusLimit",void 0),Object(h.c)([Object(de.c)()],t.prototype,"upperRadiusLimit",void 0),Object(h.c)([Object(de.c)()],t.prototype,"rotationOffset",void 0),Object(h.c)([Object(de.c)()],t.prototype,"lowerRotationOffsetLimit",void 0),Object(h.c)([Object(de.c)()],t.prototype,"upperRotationOffsetLimit",void 0),Object(h.c)([Object(de.c)()],t.prototype,"heightOffset",void 0),Object(h.c)([Object(de.c)()],t.prototype,"lowerHeightOffsetLimit",void 0),Object(h.c)([Object(de.c)()],t.prototype,"upperHeightOffsetLimit",void 0),Object(h.c)([Object(de.c)()],t.prototype,"cameraAcceleration",void 0),Object(h.c)([Object(de.c)()],t.prototype,"maxCameraSpeed",void 0),Object(h.c)([Object(de.k)("lockedTargetId")],t.prototype,"lockedTarget",void 0),t}(Ii.a),gr=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,l.e.Zero(),s)||this;return c.alpha=i,c.beta=r,c.radius=o,c._cartesianCoordinates=l.e.Zero(),c.setMeshTarget(a),c}return t.prototype.setMeshTarget=function(e){this._meshTarget=e,this._follow()},t.prototype._follow=function(){if(!!this._meshTarget){this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);var e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}},t.prototype._checkInputs=function(){n.prototype._checkInputs.call(this),this._follow()},t.prototype.getClassName=function(){return"ArcFollowCamera"},t}(Ii.a),Zt=u(469),Yt=u(448),Li;(function(n){n[n.VIVE=0]="VIVE",n[n.OCULUS=1]="OCULUS",n[n.WINDOWS=2]="WINDOWS",n[n.GEAR_VR=3]="GEAR_VR",n[n.DAYDREAM=4]="DAYDREAM",n[n.GENERIC=5]="GENERIC"})(Li||(Li={}));var Ui=function(){function n(){}return n.InitiateController=function(t){for(var e=0,i=this._ControllerFactories;e<i.length;e++){var r=i[e];if(r.canCreate(t))return r.create(t)}if(this._DefaultControllerFactory)return this._DefaultControllerFactory(t);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."},n._ControllerFactories=[],n._DefaultControllerFactory=null,n}(),qi=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e.id,e.index,e)||this;return i.isXR=!1,i._deviceRoomPosition=l.e.Zero(),i._deviceRoomRotationQuaternion=new l.b,i.devicePosition=l.e.Zero(),i.deviceRotationQuaternion=new l.b,i.deviceScaleFactor=1,i._trackPosition=!0,i._maxRotationDistFromHeadset=Math.PI/5,i._draggedRoomRotation=0,i._leftHandSystemQuaternion=new l.b,i._deviceToWorld=l.a.Identity(),i._pointingPoseNode=null,i._workingMatrix=l.a.Identity(),i._meshAttachedObservable=new _.c,i.type=Dt.POSE_ENABLED,i.controllerType=Li.GENERIC,i.position=l.e.Zero(),i.rotationQuaternion=new l.b,i._calculatedPosition=l.e.Zero(),i._calculatedRotation=new l.b,l.b.RotationYawPitchRollToRef(Math.PI,0,0,i._leftHandSystemQuaternion),i}return t.prototype._disableTrackPosition=function(e){this._trackPosition&&(this._calculatedPosition.copyFrom(e),this._trackPosition=!1)},t.prototype.update=function(){n.prototype.update.call(this),this._updatePoseAndMesh()},t.prototype._updatePoseAndMesh=function(){if(!this.isXR){var e=this.browserGamepad.pose;if(this.updateFromDevice(e),!this._trackPosition&&Yt.a.LastCreatedScene&&Yt.a.LastCreatedScene.activeCamera&&Yt.a.LastCreatedScene.activeCamera.devicePosition){var i=Yt.a.LastCreatedScene.activeCamera;if(i._computeDevicePosition(),this._deviceToWorld.setTranslation(i.devicePosition),i.deviceRotationQuaternion){var i=i;i._deviceRoomRotationQuaternion.toEulerAnglesToRef(l.c.Vector3[0]);var r=Math.atan2(Math.sin(l.c.Vector3[0].y-this._draggedRoomRotation),Math.cos(l.c.Vector3[0].y-this._draggedRoomRotation));if(Math.abs(r)>this._maxRotationDistFromHeadset){var o=r-(r<0?-this._maxRotationDistFromHeadset:this._maxRotationDistFromHeadset);this._draggedRoomRotation+=o;var a=Math.sin(-o),s=Math.cos(-o);this._calculatedPosition.x=this._calculatedPosition.x*s-this._calculatedPosition.z*a,this._calculatedPosition.z=this._calculatedPosition.x*a+this._calculatedPosition.z*s}}}l.e.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition),this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix),l.b.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation),this._mesh&&(this._mesh.position.copyFrom(this.devicePosition),this._mesh.rotationQuaternion&&this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))}},t.prototype.updateFromDevice=function(e){if(!this.isXR&&e){this.rawPose=e,e.position&&(this._deviceRoomPosition.copyFromFloats(e.position[0],e.position[1],-e.position[2]),this._mesh&&this._mesh.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1),this._trackPosition&&this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition),this._calculatedPosition.addInPlace(this.position));var i=this.rawPose;e.orientation&&i.orientation&&i.orientation.length===4&&(this._deviceRoomRotationQuaternion.copyFromFloats(i.orientation[0],i.orientation[1],-i.orientation[2],-i.orientation[3]),this._mesh&&(this._mesh.getScene().useRightHandedSystem?(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1):this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)),this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation))}},t.prototype.attachToMesh=function(e){if(this._mesh&&(this._mesh.parent=null),this._mesh=e,this._poseControlledCamera&&(this._mesh.parent=this._poseControlledCamera),this._mesh.rotationQuaternion||(this._mesh.rotationQuaternion=new l.b),!this.isXR&&(this._updatePoseAndMesh(),this._pointingPoseNode)){for(var i=[],r=this._pointingPoseNode;r.parent;)i.push(r.parent),r=r.parent;i.reverse().forEach(function(o){o.computeWorldMatrix(!0)})}this._meshAttachedObservable.notifyObservers(e)},t.prototype.attachToPoseControlledCamera=function(e){this._poseControlledCamera=e,this._mesh&&(this._mesh.parent=this._poseControlledCamera)},t.prototype.dispose=function(){this._mesh&&this._mesh.dispose(),this._mesh=null,n.prototype.dispose.call(this)},Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),t.prototype.getForwardRay=function(e){if(e===void 0&&(e=100),!this.mesh)return new Zt.a(l.e.Zero(),new l.e(0,0,1),e);var i=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix(),r=i.getTranslation(),o=new l.e(0,0,-1),a=l.e.TransformNormal(o,i),s=l.e.Normalize(a);return new Zt.a(r,s,e)},t.POINTING_POSE="POINTING_POSE",t}(Dt),Ht;(function(n){n[n.A=0]="A",n[n.B=1]="B",n[n.X=2]="X",n[n.Y=3]="Y",n[n.LB=4]="LB",n[n.RB=5]="RB",n[n.Back=8]="Back",n[n.Start=9]="Start",n[n.LeftStick=10]="LeftStick",n[n.RightStick=11]="RightStick"})(Ht||(Ht={}));var er;(function(n){n[n.Up=12]="Up",n[n.Down=13]="Down",n[n.Left=14]="Left",n[n.Right=15]="Right"})(er||(er={}));var Vn=function(n){Object(h.d)(t,n);function t(e,i,r,o){o===void 0&&(o=!1);var a=n.call(this,e,i,r,0,1,2,3)||this;return a._leftTrigger=0,a._rightTrigger=0,a.onButtonDownObservable=new _.c,a.onButtonUpObservable=new _.c,a.onPadDownObservable=new _.c,a.onPadUpObservable=new _.c,a._buttonA=0,a._buttonB=0,a._buttonX=0,a._buttonY=0,a._buttonBack=0,a._buttonStart=0,a._buttonLB=0,a._buttonRB=0,a._buttonLeftStick=0,a._buttonRightStick=0,a._dPadUp=0,a._dPadDown=0,a._dPadLeft=0,a._dPadRight=0,a._isXboxOnePad=!1,a.type=Dt.XBOX,a._isXboxOnePad=o,a}return t.prototype.onlefttriggerchanged=function(e){this._onlefttriggerchanged=e},t.prototype.onrighttriggerchanged=function(e){this._onrighttriggerchanged=e},Object.defineProperty(t.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e},enumerable:!1,configurable:!0}),t.prototype.onbuttondown=function(e){this._onbuttondown=e},t.prototype.onbuttonup=function(e){this._onbuttonup=e},t.prototype.ondpaddown=function(e){this._ondpaddown=e},t.prototype.ondpadup=function(e){this._ondpadup=e},t.prototype._setButtonValue=function(e,i,r){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(r),this.onButtonDownObservable.notifyObservers(r)),e===0&&(this._onbuttonup&&this._onbuttonup(r),this.onButtonUpObservable.notifyObservers(r))),e},t.prototype._setDPadValue=function(e,i,r){return e!==i&&(e===1&&(this._ondpaddown&&this._ondpaddown(r),this.onPadDownObservable.notifyObservers(r)),e===0&&(this._ondpadup&&this._ondpadup(r),this.onPadUpObservable.notifyObservers(r))),e},Object.defineProperty(t.prototype,"buttonA",{get:function(){return this._buttonA},set:function(e){this._buttonA=this._setButtonValue(e,this._buttonA,Ht.A)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonB",{get:function(){return this._buttonB},set:function(e){this._buttonB=this._setButtonValue(e,this._buttonB,Ht.B)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonX",{get:function(){return this._buttonX},set:function(e){this._buttonX=this._setButtonValue(e,this._buttonX,Ht.X)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonY",{get:function(){return this._buttonY},set:function(e){this._buttonY=this._setButtonValue(e,this._buttonY,Ht.Y)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,Ht.Start)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,Ht.Back)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,Ht.LB)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,Ht.RB)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Ht.LeftStick)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Ht.RightStick)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,er.Up)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,er.Down)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,er.Left)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,er.Right)},enumerable:!1,configurable:!0}),t.prototype.update=function(){n.prototype.update.call(this),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()},t}(Dt),tr;(function(n){n[n.Cross=0]="Cross",n[n.Circle=1]="Circle",n[n.Square=2]="Square",n[n.Triangle=3]="Triangle",n[n.L1=4]="L1",n[n.R1=5]="R1",n[n.Share=8]="Share",n[n.Options=9]="Options",n[n.LeftStick=10]="LeftStick",n[n.RightStick=11]="RightStick"})(tr||(tr={}));var Jr;(function(n){n[n.Up=12]="Up",n[n.Down=13]="Down",n[n.Left=14]="Left",n[n.Right=15]="Right"})(Jr||(Jr={}));var Un=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),i,r,0,1,2,3)||this;return o._leftTrigger=0,o._rightTrigger=0,o.onButtonDownObservable=new _.c,o.onButtonUpObservable=new _.c,o.onPadDownObservable=new _.c,o.onPadUpObservable=new _.c,o._buttonCross=0,o._buttonCircle=0,o._buttonSquare=0,o._buttonTriangle=0,o._buttonShare=0,o._buttonOptions=0,o._buttonL1=0,o._buttonR1=0,o._buttonLeftStick=0,o._buttonRightStick=0,o._dPadUp=0,o._dPadDown=0,o._dPadLeft=0,o._dPadRight=0,o.type=Dt.DUALSHOCK,o}return t.prototype.onlefttriggerchanged=function(e){this._onlefttriggerchanged=e},t.prototype.onrighttriggerchanged=function(e){this._onrighttriggerchanged=e},Object.defineProperty(t.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e},enumerable:!1,configurable:!0}),t.prototype.onbuttondown=function(e){this._onbuttondown=e},t.prototype.onbuttonup=function(e){this._onbuttonup=e},t.prototype.ondpaddown=function(e){this._ondpaddown=e},t.prototype.ondpadup=function(e){this._ondpadup=e},t.prototype._setButtonValue=function(e,i,r){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(r),this.onButtonDownObservable.notifyObservers(r)),e===0&&(this._onbuttonup&&this._onbuttonup(r),this.onButtonUpObservable.notifyObservers(r))),e},t.prototype._setDPadValue=function(e,i,r){return e!==i&&(e===1&&(this._ondpaddown&&this._ondpaddown(r),this.onPadDownObservable.notifyObservers(r)),e===0&&(this._ondpadup&&this._ondpadup(r),this.onPadUpObservable.notifyObservers(r))),e},Object.defineProperty(t.prototype,"buttonCross",{get:function(){return this._buttonCross},set:function(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,tr.Cross)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonCircle",{get:function(){return this._buttonCircle},set:function(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,tr.Circle)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonSquare",{get:function(){return this._buttonSquare},set:function(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,tr.Square)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonTriangle",{get:function(){return this._buttonTriangle},set:function(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,tr.Triangle)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonOptions",{get:function(){return this._buttonOptions},set:function(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,tr.Options)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonShare",{get:function(){return this._buttonShare},set:function(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,tr.Share)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonL1",{get:function(){return this._buttonL1},set:function(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,tr.L1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonR1",{get:function(){return this._buttonR1},set:function(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,tr.R1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,tr.LeftStick)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,tr.RightStick)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Jr.Up)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Jr.Down)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Jr.Left)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Jr.Right)},enumerable:!1,configurable:!0}),t.prototype.update=function(){n.prototype.update.call(this),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()},t}(Dt),Gn=function(){function n(t){var e=this;if(this._scene=t,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new _.c,he.a.IsWindowObjectExist()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&(navigator.getGamepads||navigator.webkitGetGamepads||navigator.msGetGamepads||navigator.webkitGamepads)):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new _.c(function(r){for(var o in e._babylonGamepads){var a=e._babylonGamepads[o];a&&a._isConnected&&e.onGamepadConnectedObservable.notifyObserver(r,a)}}),this._onGamepadConnectedEvent=function(r){var o=r.gamepad;if(!(o.index in e._babylonGamepads&&e._babylonGamepads[o.index].isConnected)){var a;e._babylonGamepads[o.index]?(a=e._babylonGamepads[o.index],a.browserGamepad=o,a._isConnected=!0):a=e._addNewGamepad(o),e.onGamepadConnectedObservable.notifyObservers(a),e._startMonitoringGamepads()}},this._onGamepadDisconnectedEvent=function(r){var o=r.gamepad;for(var a in e._babylonGamepads)if(e._babylonGamepads[a].index===o.index){var s=e._babylonGamepads[a];s._isConnected=!1,e.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){var i=this._scene?this._scene.getEngine().getHostWindow():window;i&&(i.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),i.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}return Object.defineProperty(n.prototype,"gamepads",{get:function(){return this._babylonGamepads},enumerable:!1,configurable:!0}),n.prototype.getGamepadByType=function(t){t===void 0&&(t=Dt.XBOX);for(var e=0,i=this._babylonGamepads;e<i.length;e++){var r=i[e];if(r&&r.type===t)return r}return null},n.prototype.dispose=function(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(function(t){t.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]},n.prototype._addNewGamepad=function(t){this._oneGamepadConnected||(this._oneGamepadConnected=!0);var e,i=t.id.search("054c")!==-1&&t.id.search("0ce6")===-1,r=t.id.search("Xbox One")!==-1;return r||t.id.search("Xbox 360")!==-1||t.id.search("xinput")!==-1||t.id.search("045e")!==-1?e=new Vn(t.id,t.index,t,r):i?e=new Un(t.id,t.index,t):t.pose?e=Ui.InitiateController(t):e=new Xt(t.id,t.index,t),this._babylonGamepads[e.index]=e,e},n.prototype._startMonitoringGamepads=function(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())},n.prototype._stopMonitoringGamepads=function(){this._isMonitoring=!1},n.prototype._checkGamepadsStatus=function(){var t=this;this._updateGamepadObjects();for(var e in this._babylonGamepads){var i=this._babylonGamepads[e];!i||!i.isConnected||i.update()}this._isMonitoring&&!this._scene&&W.a.QueueNewFrame(function(){t._checkGamepadsStatus()})},n.prototype._updateGamepadObjects=function(){for(var t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e=0;e<t.length;e++){var i=t[e];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[e].browserGamepad=i,this._babylonGamepads[e].isConnected||(this._babylonGamepads[e]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[e]));else{var r=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(r)}}},n}();Object.defineProperty(q.a.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Gn(this);var n=this._getComponent(H.a.NAME_GAMEPAD);n||(n=new Da(this),this._addComponent(n))}return this._gamepadManager},enumerable:!0,configurable:!0}),wi.a.prototype.addGamepad=function(){return this.add(new Wi),this},Di.a.prototype.addGamepad=function(){return this.add(new Kt),this};var Da=function(){function n(t){this.name=H.a.NAME_GAMEPAD,this.scene=t}return n.prototype.register=function(){this.scene._beforeCameraUpdateStage.registerStep(H.a.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){var t=this.scene._gamepadManager;t&&(t.dispose(),this.scene._gamepadManager=null)},n.prototype._beforeCameraUpdate=function(){var t=this.scene._gamepadManager;t&&t._isMonitoring&&t._checkGamepadsStatus()},n}();Nt.a.AddNodeConstructor("FreeCamera",function(n,t){return function(){return new Ir(n,l.e.Zero(),t)}});var Ir=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o.inputs.addGamepad(),o}return Object.defineProperty(t.prototype,"gamepadAngularSensibility",{get:function(){var e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0},set:function(e){var i=this.inputs.attached.gamepad;i&&(i.gamepadAngularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gamepadMoveSensibility",{get:function(){var e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0},set:function(e){var i=this.inputs.attached.gamepad;i&&(i.gamepadMoveSensibility=e)},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"UniversalCamera"},t}(sr);Z.a._createDefaultParsedCamera=function(n,t){return new Ir(n,l.e.Zero(),t)},Nt.a.AddNodeConstructor("GamepadCamera",function(n,t){return function(){return new ln(n,l.e.Zero(),t)}});var ln=function(n){Object(h.d)(t,n);function t(e,i,r){return n.call(this,e,i,r)||this}return t.prototype.getClassName=function(){return"GamepadCamera"},t}(Ir),yn=u(486),ii=u(444),qe=u(435),Ia="anaglyphPixelShader",zn=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D leftSampler;
void main(void)
{
vec4 leftFrag=texture2D(leftSampler,vUV);
leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);
vec4 rightFrag=texture2D(textureSampler,vUV);
rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);
gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);
}`;qe.a.ShadersStore[Ia]=zn;var La={name:Ia,shader:zn},Fo=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,"anaglyph",null,["leftSampler"],i,r[1],o,a,s)||this;return c._passedProcess=r[0]._rigPostProcess,c.onApplyObservable.add(function(v){v.setTextureFromPostProcess("leftSampler",c._passedProcess)}),c}return t.prototype.getClassName=function(){return"AnaglyphPostProcess"},t}(ii.a);f.a.RegisteredTypes["BABYLON.AnaglyphPostProcess"]=Fo,Z.a._setStereoscopicAnaglyphRigMode=function(n){n._rigCameras[0]._rigPostProcess=new yn.b(n.name+"_passthru",1,n._rigCameras[0]),n._rigCameras[1]._rigPostProcess=new Fo(n.name+"_anaglyph",1,n._rigCameras)},Nt.a.AddNodeConstructor("AnaglyphArcRotateCamera",function(n,t,e){return function(){return new jn(n,0,0,1,l.e.Zero(),e.interaxial_distance,t)}});var jn=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){var v=n.call(this,e,i,r,o,a,c)||this;return v.interaxialDistance=s,v.setCameraRigMode(Z.a.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:s}),v}return t.prototype.getClassName=function(){return"AnaglyphArcRotateCamera"},t}(Ri.a);Nt.a.AddNodeConstructor("AnaglyphFreeCamera",function(n,t,e){return function(){return new Wn(n,l.e.Zero(),e.interaxial_distance,t)}});var Wn=function(n){Object(h.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,i,o)||this;return a.interaxialDistance=r,a.setCameraRigMode(Z.a.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),a}return t.prototype.getClassName=function(){return"AnaglyphFreeCamera"},t}(Wt.a);Nt.a.AddNodeConstructor("AnaglyphGamepadCamera",function(n,t,e){return function(){return new Fa(n,l.e.Zero(),e.interaxial_distance,t)}});var Fa=function(n){Object(h.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,i,o)||this;return a.interaxialDistance=r,a.setCameraRigMode(Z.a.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),a}return t.prototype.getClassName=function(){return"AnaglyphGamepadCamera"},t}(ln);Nt.a.AddNodeConstructor("AnaglyphUniversalCamera",function(n,t,e){return function(){return new Ba(n,l.e.Zero(),e.interaxial_distance,t)}});var Ba=function(n){Object(h.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,i,o)||this;return a.interaxialDistance=r,a.setCameraRigMode(Z.a.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),a}return t.prototype.getClassName=function(){return"AnaglyphUniversalCamera"},t}(Ir),lr=u(520),Hn="stereoscopicInterlacePixelShader",Na=`const vec3 TWO=vec3(2.0,2.0,2.0);
varying vec2 vUV;
uniform sampler2D camASampler;
uniform sampler2D textureSampler;
uniform vec2 stepSize;
void main(void)
{
bool useCamA;
bool useCamB;
vec2 texCoord1;
vec2 texCoord2;
vec3 frag1;
vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;
useCamA=!useCamB;
texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);
texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);
useCamA=mod(rowNum,2.0) == 1.0;
useCamB=mod(rowNum,2.0) == 0.0;
texCoord1=vec2(vUV.x,vUV.y);
texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;
useCamA=!useCamB;
texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);
texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif

if (useCamB){
frag1=texture2D(textureSampler,texCoord1).rgb;
frag2=texture2D(textureSampler,texCoord2).rgb;
}else if (useCamA){
frag1=texture2D(camASampler ,texCoord1).rgb;
frag2=texture2D(camASampler ,texCoord2).rgb;
}else {
discard;
}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);
}
`;qe.a.ShadersStore[Hn]=Na;var wa={name:Hn,shader:Na},kn=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){var v=n.call(this,e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,i[1],a,s,c,o?"#define IS_STEREOSCOPIC_INTERLACED 1":r?"#define IS_STEREOSCOPIC_HORIZ 1":void 0)||this;return v._passedProcess=i[0]._rigPostProcess,v._stepSize=new l.d(1/v.width,1/v.height),v.onSizeChangedObservable.add(function(){v._stepSize=new l.d(1/v.width,1/v.height)}),v.onApplyObservable.add(function(b){b.setTextureFromPostProcess("camASampler",v._passedProcess),b.setFloat2("stepSize",v._stepSize.x,v._stepSize.y)}),v}return t.prototype.getClassName=function(){return"StereoscopicInterlacePostProcessI"},t}(ii.a),Dl=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,i[1],o,a,s,r?"#define IS_STEREOSCOPIC_HORIZ 1":void 0)||this;return c._passedProcess=i[0]._rigPostProcess,c._stepSize=new l.d(1/c.width,1/c.height),c.onSizeChangedObservable.add(function(){c._stepSize=new l.d(1/c.width,1/c.height)}),c.onApplyObservable.add(function(v){v.setTextureFromPostProcess("camASampler",c._passedProcess),v.setFloat2("stepSize",c._stepSize.x,c._stepSize.y)}),c}return t.prototype.getClassName=function(){return"StereoscopicInterlacePostProcess"},t}(ii.a);Z.a._setStereoscopicRigMode=function(n){var t=n.cameraRigMode===Z.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||n.cameraRigMode===Z.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,e=n.cameraRigMode===Z.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,i=n.cameraRigMode===Z.a.RIG_MODE_STEREOSCOPIC_INTERLACED;i?(n._rigCameras[0]._rigPostProcess=new yn.b(n.name+"_passthru",1,n._rigCameras[0]),n._rigCameras[1]._rigPostProcess=new kn(n.name+"_stereoInterlace",n._rigCameras,!1,!0)):(n._rigCameras[e?1:0].viewport=new lr.a(0,0,t?.5:1,t?1:.5),n._rigCameras[e?0:1].viewport=new lr.a(t?.5:0,t?0:.5,t?.5:1,t?1:.5))},Nt.a.AddNodeConstructor("StereoscopicArcRotateCamera",function(n,t,e){return function(){return new Xn(n,0,0,1,l.e.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,t)}});var Xn=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v){var b=n.call(this,e,i,r,o,a,v)||this;return b.interaxialDistance=s,b.isStereoscopicSideBySide=c,b.setCameraRigMode(c?Z.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Z.a.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:s}),b}return t.prototype.getClassName=function(){return"StereoscopicArcRotateCamera"},t}(Ri.a);Nt.a.AddNodeConstructor("StereoscopicFreeCamera",function(n,t,e){return function(){return new Yn(n,l.e.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,t)}});var Yn=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){var s=n.call(this,e,i,a)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=o,s.setCameraRigMode(o?Z.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Z.a.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return t.prototype.getClassName=function(){return"StereoscopicFreeCamera"},t}(Wt.a);Nt.a.AddNodeConstructor("StereoscopicGamepadCamera",function(n,t,e){return function(){return new Va(n,l.e.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,t)}});var Va=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){var s=n.call(this,e,i,a)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=o,s.setCameraRigMode(o?Z.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Z.a.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return t.prototype.getClassName=function(){return"StereoscopicGamepadCamera"},t}(ln);Nt.a.AddNodeConstructor("StereoscopicFreeCamera",function(n,t,e){return function(){return new Ua(n,l.e.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,t)}});var Ua=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){var s=n.call(this,e,i,a)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=o,s.setCameraRigMode(o?Z.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Z.a.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return t.prototype.getClassName=function(){return"StereoscopicUniversalCamera"},t}(Ir);Nt.a.AddNodeConstructor("VirtualJoysticksCamera",function(n,t){return function(){return new Ga(n,l.e.Zero(),t)}});var Ga=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o.inputs.addVirtualJoystick(),o}return t.prototype.getClassName=function(){return"VirtualJoysticksCamera"},t}(Wt.a),Lr=function(){function n(){this.compensateDistortion=!0,this.multiviewEnabled=!1}return Object.defineProperty(n.prototype,"aspectRatio",{get:function(){return this.hResolution/(2*this.vResolution)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"aspectRatioFov",{get:function(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"leftHMatrix",{get:function(){var t=this.hScreenSize/4-this.lensSeparationDistance/2,e=4*t/this.hScreenSize;return l.a.Translation(e,0,0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightHMatrix",{get:function(){var t=this.hScreenSize/4-this.lensSeparationDistance/2,e=4*t/this.hScreenSize;return l.a.Translation(-e,0,0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"leftPreViewMatrix",{get:function(){return l.a.Translation(.5*this.interpupillaryDistance,0,0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightPreViewMatrix",{get:function(){return l.a.Translation(-.5*this.interpupillaryDistance,0,0)},enumerable:!1,configurable:!0}),n.GetDefault=function(){var t=new n;return t.hResolution=1280,t.vResolution=800,t.hScreenSize=.149759993,t.vScreenSize=.0935999975,t.vScreenCenter=.0467999987,t.eyeToScreenDistance=.0410000011,t.lensSeparationDistance=.063500002,t.interpupillaryDistance=.064000003,t.distortionK=[1,.219999999,.239999995,0],t.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],t.postProcessScaleFactor=1.714605507808412,t.lensCenterOffset=.151976421,t},n}(),Ze=u(442),za="vrDistortionCorrectionPixelShader",Kn=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 LensCenter;
uniform vec2 Scale;
uniform vec2 ScaleIn;
uniform vec4 HmdWarpParam;
vec2 HmdWarp(vec2 in01) {
vec2 theta=(in01-LensCenter)*ScaleIn;
float rSq=theta.x*theta.x+theta.y*theta.y;
vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);
return LensCenter+Scale*rvector;
}
void main(void)
{
vec2 tc=HmdWarp(vUV);
if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);
else{
gl_FragColor=texture2D(textureSampler,tc);
}
}`;qe.a.ShadersStore[za]=Kn;var ja={name:za,shader:Kn},Bo=function(n){Object(h.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,o.postProcessScaleFactor,i,Ze.a.BILINEAR_SAMPLINGMODE)||this;return a._isRightEye=r,a._distortionFactors=o.distortionK,a._postProcessScaleFactor=o.postProcessScaleFactor,a._lensCenterOffset=o.lensCenterOffset,a.adaptScaleToCurrentViewport=!0,a.onSizeChangedObservable.add(function(){a._scaleIn=new l.d(2,2/a.aspectRatio),a._scaleFactor=new l.d(.5*(1/a._postProcessScaleFactor),.5*(1/a._postProcessScaleFactor)*a.aspectRatio),a._lensCenter=new l.d(a._isRightEye?.5-a._lensCenterOffset*.5:.5+a._lensCenterOffset*.5,.5)}),a.onApplyObservable.add(function(s){s.setFloat2("LensCenter",a._lensCenter.x,a._lensCenter.y),s.setFloat2("Scale",a._scaleFactor.x,a._scaleFactor.y),s.setFloat2("ScaleIn",a._scaleIn.x,a._scaleIn.y),s.setFloat4("HmdWarpParam",a._distortionFactors[0],a._distortionFactors[1],a._distortionFactors[2],a._distortionFactors[3])}),a}return t.prototype.getClassName=function(){return"VRDistortionCorrectionPostProcess"},t}(ii.a),Qn="vrMultiviewToSingleviewPixelShader",Zn=`precision mediump sampler2DArray;
varying vec2 vUV;
uniform sampler2DArray multiviewSampler;
uniform int imageIndex;
void main(void)
{
gl_FragColor=texture(multiviewSampler,vec3(vUV,imageIndex));
}`;qe.a.ShadersStore[Qn]=Zn;var pp={name:Qn,shader:Zn},gt=u(456),Fr=u(557),Cr=u(458),Wa=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i=512);var r=n.call(this,"multiview rtt",i,e,!1,!0,gt.b.Unknown,!1,void 0,!1,!1,!0,void 0,!0)||this,o=e.getEngine().createMultiviewRenderTargetTexture(r.getRenderWidth(),r.getRenderHeight());return o.isMultiview=!0,o.format=5,r._texture=o,r.samples=r._getEngine().getCaps().maxSamples||r.samples,r}return t.prototype._bindFrameBuffer=function(e){e===void 0&&(e=0),!!this._texture&&this.getScene().getEngine().bindMultiviewFramebuffer(this._texture)},t.prototype.getViewCount=function(){return 2},t}(Cr.a),Il=u(757);W.a.prototype.createMultiviewRenderTargetTexture=function(n,t){var e=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";var i=new gt.a(this,gt.b.Unknown,!0);return i.width=n,i.height=t,i._framebuffer=e.createFramebuffer(),i._colorTextureArray=e.createTexture(),e.bindTexture(e.TEXTURE_2D_ARRAY,i._colorTextureArray),e.texStorage3D(e.TEXTURE_2D_ARRAY,1,e.RGBA8,n,t,2),i._depthStencilTextureArray=e.createTexture(),e.bindTexture(e.TEXTURE_2D_ARRAY,i._depthStencilTextureArray),e.texStorage3D(e.TEXTURE_2D_ARRAY,1,e.DEPTH32F_STENCIL8,n,t,2),i.isReady=!0,i},W.a.prototype.bindMultiviewFramebuffer=function(n){var t=this._gl,e=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(n,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,n._framebuffer),n._colorTextureArray&&n._depthStencilTextureArray)this.getCaps().oculusMultiview?(e.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,n._colorTextureArray,0,n.samples,0,2),e.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,n._depthStencilTextureArray,0,n.samples,0,2)):(e.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,n._colorTextureArray,0,0,2),e.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,n._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"},Z.a.prototype._useMultiviewToSingleView=!1,Z.a.prototype._multiviewTexture=null,Z.a.prototype._resizeOrCreateMultiviewTexture=function(n,t){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=n||this._multiviewTexture.getRenderHeight()!=t)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new Wa(this.getScene(),{width:n,height:t})):this._multiviewTexture=new Wa(this.getScene(),{width:n,height:t})},q.a.prototype._transformMatrixR=l.a.Zero(),q.a.prototype._multiviewSceneUbo=null,q.a.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=new Fr.a(this.getEngine(),void 0,!0,"scene_multiview"),this._multiviewSceneUbo.addUniform("viewProjection",16),this._multiviewSceneUbo.addUniform("viewProjectionR",16),this._multiviewSceneUbo.addUniform("view",16),this._multiviewSceneUbo.addUniform("projection",16),this._multiviewSceneUbo.addUniform("viewPosition",4)},q.a.prototype._updateMultiviewUbo=function(n,t){n&&t&&n.multiplyToRef(t,this._transformMatrixR),n&&t&&(n.multiplyToRef(t,l.c.Matrix[0]),Il.a.GetRightPlaneToRef(l.c.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},q.a.prototype._renderMultiviewToSingleView=function(n){n._resizeOrCreateMultiviewTexture(n._rigPostProcess&&n._rigPostProcess&&n._rigPostProcess.width>0?n._rigPostProcess.width:this.getEngine().getRenderWidth(!0),n._rigPostProcess&&n._rigPostProcess&&n._rigPostProcess.height>0?n._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),n.outputRenderTarget=n._multiviewTexture,this._renderForCamera(n),n.outputRenderTarget=null;for(var t=0;t<n._rigCameras.length;t++){var e=this.getEngine();this._activeCamera=n._rigCameras[t],e.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};var No=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],r,i,Ze.a.BILINEAR_SAMPLINGMODE)||this;return o.onSizeChangedObservable.add(function(){}),o.onApplyObservable.add(function(a){i._scene.activeCamera&&i._scene.activeCamera.isLeftCamera?a.setInt("imageIndex",0):a.setInt("imageIndex",1),a.setTexture("multiviewSampler",i._multiviewTexture)}),o}return t.prototype.getClassName=function(){return"VRMultiviewToSingleviewPostProcess"},t}(ii.a);Z.a._setVRRigMode=function(n,t){var e=t.vrCameraMetrics||Lr.GetDefault();n._rigCameras[0]._cameraRigParams.vrMetrics=e,n._rigCameras[0].viewport=new lr.a(0,0,.5,1),n._rigCameras[0]._cameraRigParams.vrWorkMatrix=new l.a,n._rigCameras[0]._cameraRigParams.vrHMatrix=e.leftHMatrix,n._rigCameras[0]._cameraRigParams.vrPreViewMatrix=e.leftPreViewMatrix,n._rigCameras[0].getProjectionMatrix=n._rigCameras[0]._getVRProjectionMatrix,n._rigCameras[1]._cameraRigParams.vrMetrics=e,n._rigCameras[1].viewport=new lr.a(.5,0,.5,1),n._rigCameras[1]._cameraRigParams.vrWorkMatrix=new l.a,n._rigCameras[1]._cameraRigParams.vrHMatrix=e.rightHMatrix,n._rigCameras[1]._cameraRigParams.vrPreViewMatrix=e.rightPreViewMatrix,n._rigCameras[1].getProjectionMatrix=n._rigCameras[1]._getVRProjectionMatrix,e.multiviewEnabled&&(n.getScene().getEngine().getCaps().multiview?(n._useMultiviewToSingleView=!0,n._rigPostProcess=new No("VRMultiviewToSingleview",n,e.postProcessScaleFactor)):(p.a.Warn("Multiview is not supported, falling back to standard rendering"),e.multiviewEnabled=!1)),e.compensateDistortion&&(n._rigCameras[0]._rigPostProcess=new Bo("VR_Distort_Compensation_Left",n._rigCameras[0],!1,e),n._rigCameras[1]._rigPostProcess=new Bo("VR_Distort_Compensation_Right",n._rigCameras[1],!0,e))},Nt.a.AddNodeConstructor("VRDeviceOrientationFreeCamera",function(n,t){return function(){return new Ha(n,0,0,1,l.e.Zero(),t)}});var Ha=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v){c===void 0&&(c=!0),v===void 0&&(v=Lr.GetDefault());var b=n.call(this,e,i,r,o,a,s)||this;return v.compensateDistortion=c,b.setCameraRigMode(Z.a.RIG_MODE_VR,{vrCameraMetrics:v}),b.inputs.addVRDeviceOrientation(),b}return t.prototype.getClassName=function(){return"VRDeviceOrientationArcRotateCamera"},t}(Ri.a);Nt.a.AddNodeConstructor("VRDeviceOrientationFreeCamera",function(n,t){return function(){return new Jn(n,l.e.Zero(),t)}});var Jn=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!0),a===void 0&&(a=Lr.GetDefault());var s=n.call(this,e,i,r)||this;return a.compensateDistortion=o,s.setCameraRigMode(Z.a.RIG_MODE_VR,{vrCameraMetrics:a}),s}return t.prototype.getClassName=function(){return"VRDeviceOrientationFreeCamera"},t}(pr);Nt.a.AddNodeConstructor("VRDeviceOrientationGamepadCamera",function(n,t){return function(){return new ka(n,l.e.Zero(),t)}});var ka=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!0),a===void 0&&(a=Lr.GetDefault());var s=n.call(this,e,i,r,o,a)||this;return s.inputs.addGamepad(),s}return t.prototype.getClassName=function(){return"VRDeviceOrientationGamepadCamera"},t}(Jn),$n=u(498);Z.a._setWebVRRigMode=function(n,t){if(t.vrDisplay){var e=t.vrDisplay.getEyeParameters("left"),i=t.vrDisplay.getEyeParameters("right");n._rigCameras[0].viewport=new lr.a(0,0,.5,1),n._rigCameras[0].setCameraRigParameter("left",!0),n._rigCameras[0].setCameraRigParameter("specs",t.specs),n._rigCameras[0].setCameraRigParameter("eyeParameters",e),n._rigCameras[0].setCameraRigParameter("frameData",t.frameData),n._rigCameras[0].setCameraRigParameter("parentCamera",t.parentCamera),n._rigCameras[0]._cameraRigParams.vrWorkMatrix=new l.a,n._rigCameras[0].getProjectionMatrix=n._getWebVRProjectionMatrix,n._rigCameras[0].parent=n,n._rigCameras[0]._getViewMatrix=n._getWebVRViewMatrix,n._rigCameras[1].viewport=new lr.a(.5,0,.5,1),n._rigCameras[1].setCameraRigParameter("eyeParameters",i),n._rigCameras[1].setCameraRigParameter("specs",t.specs),n._rigCameras[1].setCameraRigParameter("frameData",t.frameData),n._rigCameras[1].setCameraRigParameter("parentCamera",t.parentCamera),n._rigCameras[1]._cameraRigParams.vrWorkMatrix=new l.a,n._rigCameras[1].getProjectionMatrix=n._getWebVRProjectionMatrix,n._rigCameras[1].parent=n,n._rigCameras[1]._getViewMatrix=n._getWebVRViewMatrix}};var Ll=u(700);Object.defineProperty(W.a.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0}),W.a.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new _.c,this.onVRRequestPresentComplete=new _.c,this.onVRRequestPresentStart=new _.c},W.a.prototype.isVRDevicePresent=function(){return!!this._vrDisplay},W.a.prototype.getVRDevice=function(){return this._vrDisplay},W.a.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},W.a.prototype.initWebVRAsync=function(){var n=this,t=function(){var i={vrDisplay:n._vrDisplay,vrSupported:n._vrSupported};n.onVRDisplayChangedObservable.notifyObservers(i),n._webVRInitPromise=new Promise(function(r){r(i)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=function(i){n._vrDisplay=i.display,t()},this._onVrDisplayDisconnect=function(){n._vrDisplay.cancelAnimationFrame(n._frameHandler),n._vrDisplay=void 0,n._frameHandler=W.a.QueueNewFrame(n._boundRenderFunction),t()},this._onVrDisplayPresentChange=function(){n._vrExclusivePointerMode=n._vrDisplay&&n._vrDisplay.isPresenting};var e=this.getHostWindow();e&&(e.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),e.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),e.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(t),this._webVRInitPromise},W.a.prototype._getVRDisplaysAsync=function(){var n=this;return new Promise(function(t){navigator.getVRDisplays?navigator.getVRDisplays().then(function(e){n._vrSupported=!0,n._vrDisplay=e[0],t({vrDisplay:n._vrDisplay,vrSupported:n._vrSupported})}):(n._vrDisplay=void 0,n._vrSupported=!1,t({vrDisplay:n._vrDisplay,vrSupported:n._vrSupported}))})},W.a.prototype.enableVR=function(n){var t=this;if(this._vrDisplay&&!this._vrDisplay.isPresenting){var e=function(){t.onVRRequestPresentComplete.notifyObservers(!0),t._onVRFullScreenTriggered()},i=function(){t.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);var r={highRefreshRate:this.vrPresentationAttributes?this.vrPresentationAttributes.highRefreshRate:!1,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&n.useMultiview};this._vrDisplay.requestPresent([Object(h.a)({source:this.getRenderingCanvas(),attributes:r},r)]).then(e).catch(i)}},W.a.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new Ll.a(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();var n=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(n.renderWidth*2,n.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)},W.a.prototype.disableVR=function(){var n=this;this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(function(){return n._onVRFullScreenTriggered()}).catch(function(){return n._onVRFullScreenTriggered()}),he.a.IsWindowObjectExist()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))},W.a.prototype._connectVREvents=function(n,t){var e=this;if(this._onVRDisplayPointerRestricted=function(){n&&n.requestPointerLock()},this._onVRDisplayPointerUnrestricted=function(){if(!t){var r=e.getHostWindow();r.document&&r.document.exitPointerLock&&r.document.exitPointerLock();return}!t.exitPointerLock||t.exitPointerLock()},he.a.IsWindowObjectExist()){var i=this.getHostWindow();i.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),i.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}},W.a.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(n){J.b.Warn("webVR submitFrame has had an unexpected failure: "+n)}},W.a.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting},W.a.prototype._requestVRFrame=function(){this._frameHandler=W.a.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)},Nt.a.AddNodeConstructor("WebVRFreeCamera",function(n,t){return function(){return new qn(n,l.e.Zero(),t)}}),Nt.a.AddNodeConstructor("WebVRGamepadCamera",function(n,t){return function(){return new qn(n,l.e.Zero(),t)}});var qn=function(n){Object(h.d)(t,n);function t(e,i,r,o){o===void 0&&(o={});var a=n.call(this,e,i,r)||this;a.webVROptions=o,a._vrDevice=null,a.rawPose=null,a._specsVersion="1.1",a._attached=!1,a._descendants=[],a._deviceRoomPosition=l.e.Zero(),a._deviceRoomRotationQuaternion=l.b.Identity(),a._standingMatrix=null,a.devicePosition=l.e.Zero(),a.deviceRotationQuaternion=l.b.Identity(),a.deviceScaleFactor=1,a._deviceToWorld=l.a.Identity(),a._worldToDevice=l.a.Identity(),a.controllers=[],a.onControllersAttachedObservable=new _.c,a.onControllerMeshLoadedObservable=new _.c,a.onPoseUpdatedFromDeviceObservable=new _.c,a._poseSet=!1,a.rigParenting=!0,a._defaultHeight=void 0,a._detachIfAttached=function(){var c=a.getEngine().getVRDevice();c&&!c.isPresenting&&a.detachControl()},a._workingVector=l.e.Zero(),a._oneVector=l.e.One(),a._workingMatrix=l.a.Identity(),a._tmpMatrix=new l.a,a._cache.position=l.e.Zero(),o.defaultHeight&&(a._defaultHeight=o.defaultHeight,a.position.y=a._defaultHeight),a.minZ=.1,arguments.length===5&&(a.webVROptions=arguments[4]),a.webVROptions.trackPosition==null&&(a.webVROptions.trackPosition=!0),a.webVROptions.controllerMeshes==null&&(a.webVROptions.controllerMeshes=!0),a.webVROptions.defaultLightingOnControllers==null&&(a.webVROptions.defaultLightingOnControllers=!0),a.rotationQuaternion=new l.b,a.webVROptions&&a.webVROptions.positionScale&&(a.deviceScaleFactor=a.webVROptions.positionScale);var s=a.getEngine();return a._onVREnabled=function(c){c&&a.initControllers()},s.onVRRequestPresentComplete.add(a._onVREnabled),s.initWebVR().add(function(c){!c.vrDisplay||a._vrDevice===c.vrDisplay||(a._vrDevice=c.vrDisplay,a.setCameraRigMode(Z.a.RIG_MODE_WEBVR,{parentCamera:a,vrDisplay:a._vrDevice,frameData:a._frameData,specs:a._specsVersion}),a._attached&&a.getEngine().enableVR(a.webVROptions))}),typeof VRFrameData!="undefined"&&(a._frameData=new VRFrameData),o.useMultiview&&(a.getScene().getEngine().getCaps().multiview?(a._useMultiviewToSingleView=!0,a._rigPostProcess=new No("VRMultiviewToSingleview",a,1)):(p.a.Warn("Multiview is not supported, falling back to standard rendering"),a._useMultiviewToSingleView=!1)),r.onBeforeCameraRenderObservable.add(function(c){c.parent===a&&a.rigParenting&&(a._descendants=a.getDescendants(!0,function(v){var b=a.controllers.some(function(M){return M._mesh===v}),C=a._rigCameras.indexOf(v)!==-1;return!b&&!C}),a._descendants.forEach(function(v){v.parent=c}))}),r.onAfterCameraRenderObservable.add(function(c){c.parent===a&&a.rigParenting&&a._descendants.forEach(function(v){v.parent=a})}),a}return t.prototype.deviceDistanceToRoomGround=function(){return this._standingMatrix?(this._standingMatrix.getTranslationToRef(this._workingVector),this._deviceRoomPosition.y+this._workingVector.y):this._defaultHeight||0},t.prototype.useStandingMatrix=function(e){var i=this;e===void 0&&(e=function(r){}),this.getEngine().initWebVRAsync().then(function(r){!r.vrDisplay||!r.vrDisplay.stageParameters||!r.vrDisplay.stageParameters.sittingToStandingTransform||!i.webVROptions.trackPosition?e(!1):(i._standingMatrix=new l.a,l.a.FromFloat32ArrayToRefScaled(r.vrDisplay.stageParameters.sittingToStandingTransform,0,1,i._standingMatrix),i.getScene().useRightHandedSystem||i._standingMatrix&&i._standingMatrix.toggleModelMatrixHandInPlace(),e(!0))})},t.prototype.useStandingMatrixAsync=function(){var e=this;return new Promise(function(i){e.useStandingMatrix(function(r){i(r)})})},t.prototype.dispose=function(){this._detachIfAttached(),this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled),this._updateCacheWhenTrackingDisabledObserver&&this._scene.onBeforeRenderObservable.remove(this._updateCacheWhenTrackingDisabledObserver),n.prototype.dispose.call(this)},t.prototype.getControllerByName=function(e){for(var i=0,r=this.controllers;i<r.length;i++){var o=r[i];if(o.hand===e)return o}return null},Object.defineProperty(t.prototype,"leftController",{get:function(){return this._leftController||(this._leftController=this.getControllerByName("left")),this._leftController},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rightController",{get:function(){return this._rightController||(this._rightController=this.getControllerByName("right")),this._rightController},enumerable:!1,configurable:!0}),t.prototype.getForwardRay=function(e){return e===void 0&&(e=100),this.leftCamera?n.prototype.getForwardRay.call(this,e,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition):n.prototype.getForwardRay.call(this,e)},t.prototype._checkInputs=function(){this._vrDevice&&this._vrDevice.isPresenting&&(this._vrDevice.getFrameData(this._frameData),this.updateFromDevice(this._frameData.pose)),n.prototype._checkInputs.call(this)},t.prototype.updateFromDevice=function(e){e&&e.orientation&&e.orientation.length===4&&(this.rawPose=e,this._deviceRoomRotationQuaternion.copyFromFloats(e.orientation[0],e.orientation[1],-e.orientation[2],-e.orientation[3]),this.getScene().useRightHandedSystem&&(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1),this.webVROptions.trackPosition&&this.rawPose.position&&(this._deviceRoomPosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]),this.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1)),this._poseSet=!0)},t.prototype.attachControl=function(e){e=J.b.BackCompatCameraNoPreventDefault(arguments),n.prototype.attachControl.call(this,e),this._attached=!0,e=Z.a.ForceAttachControlToAlwaysPreventDefault?!1:e,this._vrDevice&&this.getEngine().enableVR(this.webVROptions);var i=this._scene.getEngine().getHostWindow();i&&i.addEventListener("vrdisplaypresentchange",this._detachIfAttached)},t.prototype.detachControl=function(e){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),n.prototype.detachControl.call(this),this._attached=!1,this.getEngine().disableVR(),window.removeEventListener("vrdisplaypresentchange",this._detachIfAttached)},t.prototype.getClassName=function(){return"WebVRFreeCamera"},t.prototype.resetToCurrentRotation=function(){this._vrDevice.resetPose()},t.prototype._updateRigCameras=function(){var e=this._rigCameras[0],i=this._rigCameras[1];e.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),i.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),e.position.copyFrom(this._deviceRoomPosition),i.position.copyFrom(this._deviceRoomPosition)},t.prototype._correctPositionIfNotTrackPosition=function(e,i){i===void 0&&(i=!1),this.rawPose&&this.rawPose.position&&!this.webVROptions.trackPosition&&(l.a.TranslationToRef(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2],this._tmpMatrix),i||this._tmpMatrix.invert(),this._tmpMatrix.multiplyToRef(e,e))},t.prototype._updateCache=function(e){var i=this;(!this.rotationQuaternion.equals(this._cache.rotationQuaternion)||!this.position.equals(this._cache.position))&&(this.updateCacheCalled||(this.updateCacheCalled=!0,this.update()),this.rotationQuaternion.toRotationMatrix(this._workingMatrix),l.e.TransformCoordinatesToRef(this._deviceRoomPosition,this._workingMatrix,this._workingVector),this.devicePosition.subtractToRef(this._workingVector,this._workingVector),l.a.ComposeToRef(this._oneVector,this.rotationQuaternion,this._workingVector,this._deviceToWorld),this._deviceToWorld.getTranslationToRef(this._workingVector),this._workingVector.addInPlace(this.position),this._workingVector.subtractInPlace(this._cache.position),this._deviceToWorld.setTranslation(this._workingVector),this._deviceToWorld.invertToRef(this._worldToDevice),this.controllers.forEach(function(r){r._deviceToWorld.copyFrom(i._deviceToWorld),i._correctPositionIfNotTrackPosition(r._deviceToWorld),r.update()})),e||n.prototype._updateCache.call(this),this.updateCacheCalled=!1},t.prototype._computeDevicePosition=function(){l.e.TransformCoordinatesToRef(this._deviceRoomPosition,this._deviceToWorld,this.devicePosition)},t.prototype.update=function(){this._computeDevicePosition(),l.a.FromQuaternionToRef(this._deviceRoomRotationQuaternion,this._workingMatrix),this._workingMatrix.multiplyToRef(this._deviceToWorld,this._workingMatrix),l.b.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this._poseSet&&this.onPoseUpdatedFromDeviceObservable.notifyObservers(null),n.prototype.update.call(this)},t.prototype._getViewMatrix=function(){return l.a.Identity()},t.prototype._getWebVRViewMatrix=function(){var e=this._cameraRigParams.parentCamera;e._updateCache();var i=this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix;return l.a.FromArrayToRef(i,0,this._webvrViewMatrix),this.getScene().useRightHandedSystem||this._webvrViewMatrix.toggleModelMatrixHandInPlace(),this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix),l.e.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),e.deviceScaleFactor!==1&&(this._webvrViewMatrix.invert(),e.deviceScaleFactor&&(this._webvrViewMatrix.multiplyAtIndex(12,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(13,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(14,e.deviceScaleFactor)),this._webvrViewMatrix.invert()),e._correctPositionIfNotTrackPosition(this._webvrViewMatrix,!0),e._worldToDevice.multiplyToRef(this._webvrViewMatrix,this._webvrViewMatrix),this._workingMatrix=this._workingMatrix||l.a.Identity(),this._webvrViewMatrix.invertToRef(this._workingMatrix),this._workingMatrix.multiplyToRef(e.getWorldMatrix(),this._workingMatrix),this._workingMatrix.getTranslationToRef(this._globalPosition),this._markSyncedWithParent(),this._webvrViewMatrix},t.prototype._getWebVRProjectionMatrix=function(){var e=this.parent;e._vrDevice.depthNear=e.minZ,e._vrDevice.depthFar=e.maxZ;var i=this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix;return l.a.FromArrayToRef(i,0,this._projectionMatrix),this.getScene().useRightHandedSystem||this._projectionMatrix.toggleProjectionMatrixHandInPlace(),this._projectionMatrix},t.prototype.initControllers=function(){var e=this;this.controllers=[];var i=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=i.onGamepadDisconnectedObservable.add(function(r){if(r.type===Dt.POSE_ENABLED){var o=r;o.defaultModel&&o.defaultModel.setEnabled(!1),o.hand==="right"&&(e._rightController=null),o.hand==="left"&&(e._leftController=null);var a=e.controllers.indexOf(o);a!==-1&&e.controllers.splice(a,1)}}),this._onGamepadConnectedObserver=i.onGamepadConnectedObservable.add(function(r){if(r.type===Dt.POSE_ENABLED){var o=r;if(e.webVROptions.trackPosition||(o._disableTrackPosition(new l.e(o.hand=="left"?-.15:.15,-.5,.25)),e._updateCacheWhenTrackingDisabledObserver||(e._updateCacheWhenTrackingDisabledObserver=e._scene.onBeforeRenderObservable.add(function(){e._updateCache()}))),o.deviceScaleFactor=e.deviceScaleFactor,o._deviceToWorld.copyFrom(e._deviceToWorld),e._correctPositionIfNotTrackPosition(o._deviceToWorld),e.webVROptions.controllerMeshes&&(o.defaultModel?o.defaultModel.setEnabled(!0):o.initControllerMesh(e.getScene(),function(c){if(c.scaling.scaleInPlace(e.deviceScaleFactor),e.onControllerMeshLoadedObservable.notifyObservers(o),e.webVROptions.defaultLightingOnControllers){e._lightOnControllers||(e._lightOnControllers=new $n.a("vrControllersLight",new l.e(0,1,0),e.getScene()));var v=function(b,C){var M=b.getChildren();M&&M.length!==0&&M.forEach(function(N){C.includedOnlyMeshes.push(N),v(N,C)})};e._lightOnControllers.includedOnlyMeshes.push(c),v(c,e._lightOnControllers)}})),o.attachToPoseControlledCamera(e),e.controllers.indexOf(o)===-1){e.controllers.push(o);for(var a=!1,s=0;s<e.controllers.length;s++)e.controllers[s].controllerType===Li.VIVE&&(a?e.controllers[s].hand="right":(a=!0,e.controllers[s].hand="left"));e.controllers.length>=2&&e.onControllersAttachedObservable.notifyObservers(e.controllers)}}})},t}(Wt.a),Br=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.onTriggerStateChangedObservable=new _.c,i.onMainButtonStateChangedObservable=new _.c,i.onSecondaryButtonStateChangedObservable=new _.c,i.onPadStateChangedObservable=new _.c,i.onPadValuesChangedObservable=new _.c,i.pad={x:0,y:0},i._changes={pressChanged:!1,touchChanged:!1,valueChanged:!1,changed:!1},i._buttons=new Array(e.buttons.length),i.hand=e.hand,i}return t.prototype.onButtonStateChange=function(e){this._onButtonStateChange=e},Object.defineProperty(t.prototype,"defaultModel",{get:function(){return this._defaultModel},enumerable:!1,configurable:!0}),t.prototype.update=function(){n.prototype.update.call(this);for(var e=0;e<this._buttons.length;e++)this._setButtonValue(this.browserGamepad.buttons[e],this._buttons[e],e);(this.leftStick.x!==this.pad.x||this.leftStick.y!==this.pad.y)&&(this.pad.x=this.leftStick.x,this.pad.y=this.leftStick.y,this.onPadValuesChangedObservable.notifyObservers(this.pad))},t.prototype._setButtonValue=function(e,i,r){if(e||(e={pressed:!1,touched:!1,value:0}),!i){this._buttons[r]={pressed:e.pressed,touched:e.touched,value:e.value};return}this._checkChanges(e,i),this._changes.changed&&(this._onButtonStateChange&&this._onButtonStateChange(this.index,r,e),this._handleButtonChange(r,e,this._changes)),this._buttons[r].pressed=e.pressed,this._buttons[r].touched=e.touched,this._buttons[r].value=e.value<1e-8?0:e.value},t.prototype._checkChanges=function(e,i){return this._changes.pressChanged=e.pressed!==i.pressed,this._changes.touchChanged=e.touched!==i.touched,this._changes.valueChanged=e.value!==i.value,this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged,this._changes},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._defaultModel=null,this.onTriggerStateChangedObservable.clear(),this.onMainButtonStateChangedObservable.clear(),this.onSecondaryButtonStateChangedObservable.clear(),this.onPadStateChangedObservable.clear(),this.onPadValuesChangedObservable.clear()},t}(qi),ot=u(446),mr=u(491),Gt=u(455),un=u(479),Xa=u(518),Ya=u(624),eo=u(564),Tr=u(494),wo=function(){function n(){}return n.GetDefaults=function(t){var e=new n;return e.canvasOptions={antialias:!0,depth:!0,stencil:t?t.isStencilEnable:!0,alpha:!0,multiview:!1,framebufferScaleFactor:1},e.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",e},n}(),to=function(){function n(t,e){var i=this;if(e===void 0&&(e=wo.GetDefaults()),this._options=e,this._canvas=null,this._engine=null,this.xrLayer=null,this.onXRLayerInitObservable=new _.c,this._engine=t.scene.getEngine(),this._engine.onDisposeObservable.addOnce(function(){i._engine=null}),e.canvasElement)this._setManagedOutputCanvas(e.canvasElement);else{var r=document.createElement("canvas");r.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(r)}t.onXRSessionInit.add(function(){i._addCanvas()}),t.onXRSessionEnded.add(function(){i._removeCanvas()})}return n.prototype.dispose=function(){this._removeCanvas(),this._setManagedOutputCanvas(null)},n.prototype.initializeXRLayerAsync=function(t){var e=this,i=function(){var r=new XRWebGLLayer(t,e.canvasContext,e._options.canvasOptions);return e.onXRLayerInitObservable.notifyObservers(r),r};return this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(function(){},function(){J.b.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")}).then(function(){return e.xrLayer=i(),e.xrLayer}):(this.xrLayer=i(),Promise.resolve(this.xrLayer))},n.prototype._addCanvas=function(){var t=this;this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(function(e){t._setCanvasSize(!0,e)})},n.prototype._removeCanvas=function(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)},n.prototype._setCanvasSize=function(t,e){t===void 0&&(t=!0),e===void 0&&(e=this.xrLayer),!(!this._canvas||!this._engine)&&(t?e&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=e.framebufferWidth+"px",this._canvas.style.height=e.framebufferHeight+"px"):this._engine.setSize(e.framebufferWidth,e.framebufferHeight)):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))},n.prototype._setManagedOutputCanvas=function(t){this._removeCanvas(),t?(this._originalCanvasSize={width:t.offsetWidth,height:t.offsetHeight},this._canvas=t,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)},n}(),bn=function(){function n(t){var e=this;this.scene=t,this._sessionEnded=!1,this.baseLayer=null,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new _.c,this.onXRReferenceSpaceChanged=new _.c,this.onXRSessionEnded=new _.c,this.onXRSessionInit=new _.c,this._engine=t.getEngine(),this._engine.onDisposeObservable.addOnce(function(){e._engine=null})}return Object.defineProperty(n.prototype,"referenceSpace",{get:function(){return this._referenceSpace},set:function(t){this._referenceSpace=t,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this._sessionEnded||this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear()},n.prototype.exitXRAsync=function(){return this.session&&!this._sessionEnded?(this._sessionEnded=!0,this.session.end().catch(function(t){p.a.Warn("Could not end XR session.")})):Promise.resolve()},n.prototype.getRenderTargetTextureForEye=function(t){return this._rttProvider.getRenderTargetForEye(t)},n.prototype.getWebXRRenderTarget=function(t){var e=this.scene.getEngine();return this._xrNavigator.xr.native?this._xrNavigator.xr.getWebXRRenderTarget(e):(t=t||wo.GetDefaults(e),t.canvasElement=e.getRenderingCanvas()||void 0,new to(this,t))},n.prototype.initializeAsync=function(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")},n.prototype.initializeSessionAsync=function(t,e){var i=this;return t===void 0&&(t="immersive-vr"),e===void 0&&(e={}),this._xrNavigator.xr.requestSession(t,e).then(function(r){return i.session=r,i.onXRSessionInit.notifyObservers(r),i._sessionEnded=!1,i.session.addEventListener("end",function(){i._sessionEnded=!0,i._rttProvider=null,i._engine&&(i._engine.framebufferDimensionsObject=null,i._engine.restoreDefaultFramebuffer(),i._engine.customAnimationFrameRequester=null,i._engine._renderLoop()),i.onXRSessionEnded.notifyObservers(null)},{once:!0}),i.session})},n.prototype.isSessionSupportedAsync=function(t){return n.IsSessionSupportedAsync(t)},n.prototype.resetReferenceSpace=function(){this.referenceSpace=this.baseReferenceSpace},n.prototype.runXRRenderLoop=function(){var t=this;if(!(this._sessionEnded||!this._engine)){if(this._engine.customAnimationFrameRequester={requestAnimationFrame:this.session.requestAnimationFrame.bind(this.session),renderFunction:function(a,s){t._sessionEnded||!t._engine||(t.currentFrame=s,t.currentTimestamp=a,s&&(t._engine.framebufferDimensionsObject=t.baseLayer,t.onXRFrameObservable.notifyObservers(s),t._engine._renderLoop(),t._engine.framebufferDimensionsObject=null))}},this._xrNavigator.xr.native)this._rttProvider=this._xrNavigator.xr.getNativeRenderTargetProvider(this.session,this._createRenderTargetTexture.bind(this));else{var e,i,r,o;this._rttProvider={getRenderTargetForEye:function(){var a=t.baseLayer;return(a.framebufferWidth!==i||a.framebufferHeight!==r||a.framebuffer!==o)&&(e=t._createRenderTargetTexture(a.framebufferWidth,a.framebufferHeight,a.framebuffer),i=a.framebufferWidth,r=a.framebufferHeight,o=a.framebuffer),e}},this._engine.framebufferDimensionsObject=this.baseLayer}typeof window!="undefined"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop()}},n.prototype.setReferenceSpaceTypeAsync=function(t){var e=this;return t===void 0&&(t="local-floor"),this.session.requestReferenceSpace(t).then(function(i){return i},function(i){return p.a.Error("XR.requestReferenceSpace failed for the following reason: "),p.a.Error(i),p.a.Log('Defaulting to universally-supported "viewer" reference space type.'),e.session.requestReferenceSpace("viewer").then(function(r){var o=new XRRigidTransform({x:0,y:-e.defaultHeightCompensation,z:0});return r.getOffsetReferenceSpace(o)},function(r){throw p.a.Error(r),'XR initialization failed: required "viewer" reference space type not supported.'})}).then(function(i){return e.session.requestReferenceSpace("viewer").then(function(r){return e.viewerReferenceSpace=r,i})}).then(function(i){return e.referenceSpace=e.baseReferenceSpace=i,e.referenceSpace})},n.prototype.updateRenderStateAsync=function(t){return t.baseLayer&&(this.baseLayer=t.baseLayer),this.session.updateRenderState(t)},n.IsSessionSupportedAsync=function(t){if(!navigator.xr)return Promise.resolve(!1);var e=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return e?e.call(navigator.xr,t).then(function(i){var r=typeof i=="undefined"?!0:i;return Promise.resolve(r)}).catch(function(i){return p.a.Warn(i),Promise.resolve(!1)}):Promise.resolve(!1)},Object.defineProperty(n.prototype,"isNative",{get:function(){var t;return(t=this._xrNavigator.xr.native)!==null&&t!==void 0?t:!1},enumerable:!1,configurable:!0}),n.prototype._createRenderTargetTexture=function(t,e,i){if(!this._engine)throw new Error("Engine is disposed");var r=new gt.a(this._engine,gt.b.Unknown,!0);r.width=t,r.height=e,r._framebuffer=i;var o=new Cr.a("XR renderTargetTexture",{width:t,height:e},this.scene,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0);return o._texture=r,o},n}(),pi;(function(n){n[n.ENTERING_XR=0]="ENTERING_XR",n[n.EXITING_XR=1]="EXITING_XR",n[n.IN_XR=2]="IN_XR",n[n.NOT_IN_XR=3]="NOT_IN_XR"})(pi||(pi={}));var Nr;(function(n){n[n.NOT_TRACKING=0]="NOT_TRACKING",n[n.TRACKING_LOST=1]="TRACKING_LOST",n[n.TRACKING=2]="TRACKING"})(Nr||(Nr={}));var cn=function(){function n(t,e){if(e===void 0&&(e=null),this.scene=t,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=n._idCounter++,e)this._gazeTracker=e.clone("gazeTracker");else{this._gazeTracker=ot.a.CreateTorus("gazeTracker",.0035,.0025,20,t,!1),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;var i=new Gt.a("targetMat",t);i.specularColor=m.a.Black(),i.emissiveColor=new m.a(.7,.7,.7),i.backFaceCulling=!1,this._gazeTracker.material=i}}return n.prototype._getForwardRay=function(t){return new Zt.a(l.e.Zero(),new l.e(0,0,t))},n.prototype._selectionPointerDown=function(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})},n.prototype._selectionPointerUp=function(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1},n.prototype._activatePointer=function(){this._activePointer=!0},n.prototype._deactivatePointer=function(){this._activePointer=!1},n.prototype._updatePointerDistance=function(t){t===void 0&&(t=100)},n.prototype.dispose=function(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()},n._idCounter=0,n}(),$r=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,i,r)||this;o.webVRController=e,o._laserPointer=ot.a.CreateCylinder("laserPointer",1,.004,2e-4,20,1,i,!1);var a=new Gt.a("laserPointerMat",i);if(a.emissiveColor=new m.a(.7,.7,.7),a.alpha=.6,o._laserPointer.material=a,o._laserPointer.rotation.x=Math.PI/2,o._laserPointer.position.z=-.5,o._laserPointer.isVisible=!1,o._laserPointer.isPickable=!1,!e.mesh){var s=new ot.a("preloadControllerMesh",i),c=new ot.a(qi.POINTING_POSE,i);c.rotation.x=-.7,s.addChild(c),e.attachToMesh(s)}return o._setLaserPointerParent(e.mesh),o._meshAttachedObserver=e._meshAttachedObservable.add(function(v){o._setLaserPointerParent(v)}),o}return t.prototype._getForwardRay=function(e){return this.webVRController.getForwardRay(e)},t.prototype._activatePointer=function(){n.prototype._activatePointer.call(this),this._laserPointer.isVisible=!0},t.prototype._deactivatePointer=function(){n.prototype._deactivatePointer.call(this),this._laserPointer.isVisible=!1},t.prototype._setLaserPointerColor=function(e){this._laserPointer.material.emissiveColor=e},t.prototype._setLaserPointerLightingDisabled=function(e){this._laserPointer.material.disableLighting=e},t.prototype._setLaserPointerParent=function(e){var i=function(s){s.isPickable=!1,s.getChildMeshes().forEach(function(c){i(c)})};i(e);var r=e.getChildren(void 0,!1),o=e;this.webVRController._pointingPoseNode=null;for(var a=0;a<r.length;a++)if(r[a].name&&r[a].name.indexOf(qi.POINTING_POSE)>=0){o=r[a],this.webVRController._pointingPoseNode=o;break}this._laserPointer.parent=o},t.prototype._updatePointerDistance=function(e){e===void 0&&(e=100),this._laserPointer.scaling.y=e,this._laserPointer.position.z=-e/2},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._laserPointer.dispose(),this._meshAttachedObserver&&this.webVRController._meshAttachedObservable.remove(this._meshAttachedObserver)},t}(cn),En=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,i)||this;return r.getCamera=e,r}return t.prototype._getForwardRay=function(e){var i=this.getCamera();return i?i.getForwardRay(e):new Zt.a(l.e.Zero(),l.e.Forward())},t}(cn),Ka=function(){function n(){}return n}(),Ve=function(){function n(t,e){var i=this;e===void 0&&(e={}),this.webVROptions=e,this._webVRsupported=!1,this._webVRready=!1,this._webVRrequesting=!1,this._webVRpresenting=!1,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new _.c,this.onAfterEnteringVRObservable=new _.c,this.onExitingVRObservable=new _.c,this.onControllerMeshLoadedObservable=new _.c,this._useCustomVRButton=!1,this._teleportationRequested=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=n.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new l.e(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new l.e(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._leftController=null,this._rightController=null,this._gazeColor=new m.a(.7,.7,.7),this._laserColor=new m.a(.7,.7,.7),this._pickedLaserColor=new m.a(.2,.2,1),this._pickedGazeColor=new m.a(0,0,1),this.onNewMeshSelected=new _.c,this.onMeshSelectedWithController=new _.c,this.onNewMeshPicked=new _.c,this.onBeforeCameraTeleport=new _.c,this.onAfterCameraTeleport=new _.c,this.onSelectedMeshUnselected=new _.c,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._interactionsRequested=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=function(){i.moveButtonToBottomRight(),i._fullscreenVRpresenting&&i._webVRready&&i.exitVR()},this._onFullscreenChange=function(){var a=document;a.fullscreen!==void 0?i._fullscreenVRpresenting=document.fullscreen:a.mozFullScreen!==void 0?i._fullscreenVRpresenting=a.mozFullScreen:a.webkitIsFullScreen!==void 0?i._fullscreenVRpresenting=a.webkitIsFullScreen:a.msIsFullScreen!==void 0?i._fullscreenVRpresenting=a.msIsFullScreen:document.msFullscreenElement!==void 0&&(i._fullscreenVRpresenting=document.msFullscreenElement),!i._fullscreenVRpresenting&&i._inputElement&&(i.exitVR(),!i._useCustomVRButton&&i._btnVR&&(i._btnVR.style.top=i._inputElement.offsetTop+i._inputElement.offsetHeight-70+"px",i._btnVR.style.left=i._inputElement.offsetLeft+i._inputElement.offsetWidth-100+"px",i.updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this.beforeRender=function(){i._leftController&&i._leftController._activePointer&&i._castRayAndSelectObject(i._leftController),i._rightController&&i._rightController._activePointer&&i._castRayAndSelectObject(i._rightController),i._noControllerIsActive&&(i._scene.getEngine().isPointerLock||i.enableGazeEvenWhenNoPointerLock)?i._castRayAndSelectObject(i._cameraGazer):i._cameraGazer._gazeTracker.isVisible=!1},this._onNewGamepadConnected=function(a){if(a.type!==Dt.POSE_ENABLED)a.leftStick&&a.onleftstickchanged(function(v){i._teleportationInitialized&&i.teleportationEnabled&&(!i._leftController&&!i._rightController||i._leftController&&!i._leftController._activePointer&&i._rightController&&!i._rightController._activePointer)&&(i._checkTeleportWithRay(v,i._cameraGazer),i._checkTeleportBackwards(v,i._cameraGazer))}),a.rightStick&&a.onrightstickchanged(function(v){i._teleportationInitialized&&i._checkRotate(v,i._cameraGazer)}),a.type===Dt.XBOX&&(a.onbuttondown(function(v){i._interactionsEnabled&&v===Ht.A&&i._cameraGazer._selectionPointerDown()}),a.onbuttonup(function(v){i._interactionsEnabled&&v===Ht.A&&i._cameraGazer._selectionPointerUp()}));else{var s=a,c=new $r(s,i._scene,i._cameraGazer._gazeTracker);s.hand==="right"||i._leftController&&i._leftController.webVRController!=s?i._rightController=c:i._leftController=c,i._tryEnableInteractionOnController(c)}},this._tryEnableInteractionOnController=function(a){i._interactionsRequested&&!a._interactionsEnabled&&i._enableInteractionOnController(a),i._teleportationRequested&&!a._teleportationEnabled&&i._enableTeleportationOnController(a)},this._onNewGamepadDisconnected=function(a){a instanceof Br&&(a.hand==="left"&&i._leftController!=null&&(i._leftController.dispose(),i._leftController=null),a.hand==="right"&&i._rightController!=null&&(i._rightController.dispose(),i._rightController=null))},this._workingVector=l.e.Zero(),this._workingQuaternion=l.b.Identity(),this._workingMatrix=l.a.Identity(),this._scene=t,this._inputElement=t.getEngine().getInputElement();var r="getVRDisplays"in navigator;if(r||(e.useXR=!0),e.createFallbackVRDeviceOrientationFreeCamera===void 0&&(e.createFallbackVRDeviceOrientationFreeCamera=!0),e.createDeviceOrientationCamera===void 0&&(e.createDeviceOrientationCamera=!0),e.laserToggle===void 0&&(e.laserToggle=!0),e.defaultHeight===void 0&&(e.defaultHeight=1.7),e.useCustomVRButton&&(this._useCustomVRButton=!0,e.customVRButton&&(this._btnVR=e.customVRButton)),e.rayLength&&(this._rayLength=e.rayLength),this._defaultHeight=e.defaultHeight,e.positionScale&&(this._rayLength*=e.positionScale,this._defaultHeight*=e.positionScale),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new l.e(0,this._defaultHeight,0),e.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new pr("deviceOrientationVRHelper",this._position.clone(),t),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof Ii.a&&this._scene.activeCamera.rotation)){var o=this._scene.activeCamera;o.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(o.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(l.b.RotationYawPitchRoll(o.rotation.y,o.rotation.x,o.rotation.z)),this._deviceOrientationCamera.rotation=o.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?bn.IsSessionSupportedAsync("immersive-vr").then(function(a){a?(p.a.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),t.createDefaultXRExperienceAsync({floorMeshes:e.floorMeshes||[]}).then(function(s){i.xr=s,i.xrTestDone=!0,i._cameraGazer=new En(function(){return i.xr.baseExperience.camera},t),i.xr.baseExperience.onStateChangedObservable.add(function(c){switch(c){case pi.ENTERING_XR:i.onEnteringVRObservable.notifyObservers(i),i._interactionsEnabled||i.xr.pointerSelection.detach(),i.xr.pointerSelection.displayLaserPointer=i._displayLaserPointer;break;case pi.EXITING_XR:i.onExitingVRObservable.notifyObservers(i),i._scene.getEngine().resize();break;case pi.IN_XR:i._hasEnteredVR=!0;break;case pi.NOT_IN_XR:i._hasEnteredVR=!1;break}})})):i.completeVRInit(t,e)}):this.completeVRInit(t,e)}return Object.defineProperty(n.prototype,"onEnteringVR",{get:function(){return this.onEnteringVRObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onExitingVR",{get:function(){return this.onExitingVRObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onControllerMeshLoaded",{get:function(){return this.onControllerMeshLoadedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"teleportationTarget",{get:function(){return this._teleportationTarget},set:function(t){t&&(t.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"gazeTrackerMesh",{get:function(){return this._cameraGazer._gazeTracker},set:function(t){t&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._leftController&&this._leftController._gazeTracker&&this._leftController._gazeTracker.dispose(),this._rightController&&this._rightController._gazeTracker&&this._rightController._gazeTracker.dispose(),this._cameraGazer._gazeTracker=t,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker",this._leftController&&(this._leftController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")),this._rightController&&(this._rightController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"leftControllerGazeTrackerMesh",{get:function(){return this._leftController?this._leftController._gazeTracker:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightControllerGazeTrackerMesh",{get:function(){return this._rightController?this._rightController._gazeTracker:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"displayGaze",{get:function(){return this._displayGaze},set:function(t){this._displayGaze=t,t||(this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"displayLaserPointer",{get:function(){return this._displayLaserPointer},set:function(t){this._displayLaserPointer=t,t?(this._rightController&&this._rightController._activatePointer(),this._leftController&&this._leftController._activatePointer()):(this._rightController&&(this._rightController._deactivatePointer(),this._rightController._gazeTracker.isVisible=!1),this._leftController&&(this._leftController._deactivatePointer(),this._leftController._gazeTracker.isVisible=!1))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"deviceOrientationCamera",{get:function(){return this._deviceOrientationCamera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentVRCamera",{get:function(){return this._webVRready?this._webVRCamera:this._scene.activeCamera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"webVRCamera",{get:function(){return this._webVRCamera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"vrDeviceOrientationCamera",{get:function(){return this._vrDeviceOrientationCamera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"vrButton",{get:function(){return this._btnVR},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_teleportationRequestInitiated",{get:function(){var t=this._cameraGazer._teleportationRequestInitiated||this._leftController!==null&&this._leftController._teleportationRequestInitiated||this._rightController!==null&&this._rightController._teleportationRequestInitiated;return t},enumerable:!1,configurable:!0}),n.prototype.completeVRInit=function(t,e){var i=this;if(this.xrTestDone=!0,e.createFallbackVRDeviceOrientationFreeCamera&&(e.useMultiview&&(e.vrDeviceOrientationCameraMetrics||(e.vrDeviceOrientationCameraMetrics=Lr.GetDefault()),e.vrDeviceOrientationCameraMetrics.multiviewEnabled=!0),this._vrDeviceOrientationCamera=new Jn("VRDeviceOrientationVRHelper",this._position,this._scene,!0,e.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._webVRCamera=new qn("WebVRHelper",this._position,this._scene,e),this._webVRCamera.useStandingMatrix(),this._cameraGazer=new En(function(){return i.currentVRCamera},t),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";var r=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png",o=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+r+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+=".babylonVRicon.vrdisplaypresenting { display: none; }";var a=document.createElement("style");a.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(a),this.moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",function(){i.isInVRMode?i._scene.getEngine().disableVR():i.enterVR()});var s=this._scene.getEngine().getHostWindow();!s||(s.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",this._onFullscreenChange,!1),document.onmsfullscreenchange=this._onFullscreenChange,e.createFallbackVRDeviceOrientationFreeCamera?this.displayVRButton():this._scene.getEngine().onVRDisplayChangedObservable.add(function(c){c.vrDisplay&&i.displayVRButton()}),this._onKeyDown=function(c){c.keyCode===27&&i.isInVRMode&&i.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(function(){i._hasEnteredVR&&i.exitVROnDoubleTap&&(i.exitVR(),i._fullscreenVRpresenting&&i._scene.getEngine().exitFullscreen())},re.a.POINTERDOUBLETAP,!1),this._onVRDisplayChanged=function(c){return i.onVRDisplayChanged(c)},this._onVrDisplayPresentChange=function(){return i.onVrDisplayPresentChange()},this._onVRRequestPresentStart=function(){i._webVRrequesting=!0,i.updateButtonVisibility()},this._onVRRequestPresentComplete=function(){i._webVRrequesting=!1,i.updateButtonVisibility()},t.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChanged),t.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart),t.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete),s.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),t.onDisposeObservable.add(function(){i.dispose()}),this._webVRCamera.onControllerMeshLoadedObservable.add(function(c){return i._onDefaultMeshLoaded(c)}),this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected),this.updateButtonVisibility(),this._circleEase=new L.d,this._circleEase.setEasingMode(L.f.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,t.onPointerObservable.add(function(c){i._interactionsEnabled&&t.activeCamera===i.vrDeviceOrientationCamera&&c.event.pointerType==="mouse"&&(c.type===re.a.POINTERDOWN?i._cameraGazer._selectionPointerDown():c.type===re.a.POINTERUP&&i._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))},n.prototype._onDefaultMeshLoaded=function(t){this._leftController&&this._leftController.webVRController==t&&t.mesh&&this._leftController._setLaserPointerParent(t.mesh),this._rightController&&this._rightController.webVRController==t&&t.mesh&&this._rightController._setLaserPointerParent(t.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(t)}catch(e){p.a.Warn("Error in your custom logic onControllerMeshLoaded: "+e)}},Object.defineProperty(n.prototype,"isInVRMode",{get:function(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===pi.IN_XR||this._webVRpresenting||this._fullscreenVRpresenting},enumerable:!1,configurable:!0}),n.prototype.onVrDisplayPresentChange=function(){var t=this._scene.getEngine().getVRDevice();if(t){var e=this._webVRpresenting;this._webVRpresenting=t.isPresenting,e&&!this._webVRpresenting&&this.exitVR()}else p.a.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?");this.updateButtonVisibility()},n.prototype.onVRDisplayChanged=function(t){this._webVRsupported=t.vrSupported,this._webVRready=!!t.vrDisplay,this._webVRpresenting=t.vrDisplay&&t.vrDisplay.isPresenting,this.updateButtonVisibility()},n.prototype.moveButtonToBottomRight=function(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){var t=this._inputElement.getBoundingClientRect();this._btnVR.style.top=t.top+t.height-70+"px",this._btnVR.style.left=t.left+t.width-100+"px"}},n.prototype.displayVRButton=function(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)},n.prototype.updateButtonVisibility=function(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode?this._btnVR.className+=" vrdisplaypresenting":(this._webVRready&&(this._btnVR.className+=" vrdisplayready"),this._webVRsupported&&(this._btnVR.className+=" vrdisplaysupported"),this._webVRrequesting&&(this._btnVR.className+=" vrdisplayrequesting")))},n.prototype.enterVR=function(){var t=this;if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(a){p.a.Warn("Error in your custom logic onEnteringVR: "+a)}if(this._scene.activeCamera){if(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=l.b.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this.webVRCamera){var e=this.webVRCamera.deviceRotationQuaternion.toEulerAngles().y,i=l.b.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles().y,r=i-e,o=this.webVRCamera.rotationQuaternion.toEulerAngles().y;this.webVRCamera.rotationQuaternion=l.b.FromEulerAngles(0,o+r,0)}this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)}this._webVRrequesting||(this._webVRready?this._webVRpresenting||(this._scene.getEngine().onVRRequestPresentComplete.addOnce(function(a){t.onAfterEnteringVRObservable.notifyObservers({success:a})}),this._webVRCamera.position=this._position,this._scene.activeCamera=this._webVRCamera):this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this.updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(function(){t.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this.beforeRender),this._displayLaserPointer&&[this._leftController,this._rightController].forEach(function(a){a&&a._activatePointer()}),this._hasEnteredVR=!0)},n.prototype.exitVR=function(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){p.a.Warn("Error in your custom logic onExitingVR: "+e)}this._webVRpresenting&&this._scene.getEngine().disableVR(),this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this.updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this.beforeRender),this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1)),this._scene.getEngine().resize(),[this._leftController,this._rightController].forEach(function(e){e&&e._deactivatePointer()}),this._hasEnteredVR=!1;var t=this._scene.getEngine();t._onVrDisplayPresentChange&&t._onVrDisplayPresentChange()}},Object.defineProperty(n.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this._scene.activeCamera&&(this._scene.activeCamera.position=t)},enumerable:!1,configurable:!0}),n.prototype.enableInteractions=function(){var t=this;if(!this._interactionsEnabled){if(this._interactionsRequested=!0,this.xr){this.xr.baseExperience.state===pi.IN_XR&&this.xr.pointerSelection.attach();return}this._leftController&&this._enableInteractionOnController(this._leftController),this._rightController&&this._enableInteractionOnController(this._rightController),this.raySelectionPredicate=function(e){return e.isVisible&&(e.isPickable||e.name===t._floorMeshName)},this.meshSelectionPredicate=function(){return!0},this._raySelectionPredicate=function(e){return t._isTeleportationFloor(e)||e.name.indexOf("gazeTracker")===-1&&e.name.indexOf("teleportationTarget")===-1&&e.name.indexOf("torusTeleportation")===-1?t.raySelectionPredicate(e):!1},this._interactionsEnabled=!0}},Object.defineProperty(n.prototype,"_noControllerIsActive",{get:function(){return!(this._leftController&&this._leftController._activePointer)&&!(this._rightController&&this._rightController._activePointer)},enumerable:!1,configurable:!0}),n.prototype._isTeleportationFloor=function(t){for(var e=0;e<this._floorMeshesCollection.length;e++)if(this._floorMeshesCollection[e].id===t.id)return!0;return!!(this._floorMeshName&&t.name===this._floorMeshName)},n.prototype.addFloorMesh=function(t){!this._floorMeshesCollection||this._floorMeshesCollection.indexOf(t)>-1||this._floorMeshesCollection.push(t)},n.prototype.removeFloorMesh=function(t){if(!!this._floorMeshesCollection){var e=this._floorMeshesCollection.indexOf(t);e!==-1&&this._floorMeshesCollection.splice(e,1)}},n.prototype.enableTeleportation=function(t){var e=this;if(t===void 0&&(t={}),!this._teleportationInitialized){if(this._teleportationRequested=!0,this.enableInteractions(),this.webVROptions.useXR&&(t.floorMeshes||t.floorMeshName)){var i=t.floorMeshes||[];if(!i.length){var r=this._scene.getMeshByName(t.floorMeshName);r&&i.push(r)}if(this.xr){i.forEach(function(s){e.xr.teleportation.addFloorMesh(s)}),this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){var o=function(){e.xrTestDone&&(e._scene.unregisterBeforeRender(o),e.xr?e.xr.teleportation.attached||e.xr.teleportation.attach():e.enableTeleportation(t))};this._scene.registerBeforeRender(o);return}}t.floorMeshName&&(this._floorMeshName=t.floorMeshName),t.floorMeshes&&(this._floorMeshesCollection=t.floorMeshes),t.teleportationMode&&(this._teleportationMode=t.teleportationMode),t.teleportationTime&&t.teleportationTime>0&&(this._teleportationTime=t.teleportationTime),t.teleportationSpeed&&t.teleportationSpeed>0&&(this._teleportationSpeed=t.teleportationSpeed),t.easingFunction!==void 0&&(this._teleportationEasing=t.easingFunction),this._leftController!=null&&this._enableTeleportationOnController(this._leftController),this._rightController!=null&&this._enableTeleportationOnController(this._rightController);var a=new mr.a;a.vignetteColor=new m.b(0,0,0,0),a.vignetteEnabled=!0,this._postProcessMove=new Xa.a("postProcessMove",1,this._webVRCamera,void 0,void 0,void 0,void 0,a),this._webVRCamera.detachPostProcess(this._postProcessMove),this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&(this._createTeleportationCircles(),this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor))}},n.prototype._enableInteractionOnController=function(t){var e=this,i=t.webVRController.mesh;i&&(t._interactionsEnabled=!0,this.isInVRMode&&this._displayLaserPointer&&t._activatePointer(),this.webVROptions.laserToggle&&t.webVRController.onMainButtonStateChangedObservable.add(function(r){e._displayLaserPointer&&r.value===1&&(t._activePointer?t._deactivatePointer():t._activatePointer(),e.displayGaze&&(t._gazeTracker.isVisible=t._activePointer))}),t.webVRController.onTriggerStateChangedObservable.add(function(r){var o=t;e._noControllerIsActive&&(o=e._cameraGazer),o._pointerDownOnMeshAsked?r.value<e._padSensibilityDown&&o._selectionPointerUp():r.value>e._padSensibilityUp&&o._selectionPointerDown()}))},n.prototype._checkTeleportWithRay=function(t,e){this._teleportationRequestInitiated&&!e._teleportationRequestInitiated||(e._teleportationRequestInitiated?Math.sqrt(t.y*t.y+t.x*t.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),e._teleportationRequestInitiated=!1):t.y<-this._padSensibilityUp&&e._dpadPressed&&(e._activatePointer(),e._teleportationRequestInitiated=!0))},n.prototype._checkRotate=function(t,e){e._teleportationRequestInitiated||(e._rotationLeftAsked?t.x>-this._padSensibilityDown&&(e._rotationLeftAsked=!1):t.x<-this._padSensibilityUp&&e._dpadPressed&&(e._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),e._rotationRightAsked?t.x<this._padSensibilityDown&&(e._rotationRightAsked=!1):t.x>this._padSensibilityUp&&e._dpadPressed&&(e._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))},n.prototype._checkTeleportBackwards=function(t,e){if(!e._teleportationRequestInitiated)if(t.y>this._padSensibilityUp&&e._dpadPressed){if(!e._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;var i=l.b.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),r=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(i=this.currentVRCamera.deviceRotationQuaternion,r=this.currentVRCamera.devicePosition),i.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,l.b.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),l.e.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);var o=new Zt.a(r,this._workingVector),a=this._scene.pickWithRay(o,this._raySelectionPredicate);a&&a.pickedPoint&&a.pickedMesh&&this._isTeleportationFloor(a.pickedMesh)&&a.distance<5&&this.teleportCamera(a.pickedPoint),e._teleportationBackRequestInitiated=!0}}else e._teleportationBackRequestInitiated=!1},n.prototype._enableTeleportationOnController=function(t){var e=this,i=t.webVRController.mesh;i&&(t._interactionsEnabled||this._enableInteractionOnController(t),t._interactionsEnabled=!0,t._teleportationEnabled=!0,t.webVRController.controllerType===Li.VIVE&&(t._dpadPressed=!1,t.webVRController.onPadStateChangedObservable.add(function(r){t._dpadPressed=r.pressed,t._dpadPressed||(t._rotationLeftAsked=!1,t._rotationRightAsked=!1,t._teleportationBackRequestInitiated=!1)})),t.webVRController.onPadValuesChangedObservable.add(function(r){e.teleportationEnabled&&(e._checkTeleportBackwards(r,t),e._checkTeleportWithRay(r,t)),e._checkRotate(r,t)}))},n.prototype._createTeleportationCircles=function(){this._teleportationTarget=ot.a.CreateGround("teleportationTarget",2,2,2,this._scene),this._teleportationTarget.isPickable=!1;var t=512,e=new un.a("DynamicTexture",t,this._scene,!0);e.hasAlpha=!0;var i=e.getContext(),r=t/2,o=t/2,a=200;i.beginPath(),i.arc(r,o,a,0,2*Math.PI,!1),i.fillStyle=this._teleportationFillColor,i.fill(),i.lineWidth=10,i.strokeStyle=this._teleportationBorderColor,i.stroke(),i.closePath(),e.update();var s=new Gt.a("TextPlaneMaterial",this._scene);s.diffuseTexture=e,this._teleportationTarget.material=s;var c=ot.a.CreateTorus("torusTeleportation",.75,.1,25,this._scene,!1);c.isPickable=!1,c.parent=this._teleportationTarget;var v=new y.a("animationInnerCircle","position.y",30,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CYCLE),b=[];b.push({frame:0,value:0}),b.push({frame:30,value:.4}),b.push({frame:60,value:0}),v.setKeys(b);var C=new L.m;C.setEasingMode(L.f.EASINGMODE_EASEINOUT),v.setEasingFunction(C),c.animations=[],c.animations.push(v),this._scene.beginAnimation(c,0,60,!0),this._hideTeleportationTarget()},n.prototype._displayTeleportationTarget=function(){this._teleportActive=!0,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!0,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!0))},n.prototype._hideTeleportationTarget=function(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))},n.prototype._rotateCamera=function(t){var e=this;if(this.currentVRCamera instanceof Wt.a){t?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];var i=l.b.FromRotationMatrix(l.a.RotationY(Math.PI/4*this._rotationAngle)),r=new y.a("animationRotation","rotationQuaternion",90,y.a.ANIMATIONTYPE_QUATERNION,y.a.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),o.push({frame:6,value:i}),r.setKeys(o),r.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];var a=new y.a("animationPP","vignetteWeight",90,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:0}),s.push({frame:3,value:4}),s.push({frame:6,value:0}),a.setKeys(s),a.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(a);var c=new y.a("animationPP2","vignetteStretch",90,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CONSTANT),v=[];v.push({frame:0,value:0}),v.push({frame:3,value:10}),v.push({frame:6,value:0}),c.setKeys(v),c.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(c),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,6,!1,1,function(){e._webVRCamera.detachPostProcess(e._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}},n.prototype._moveTeleportationSelectorTo=function(t,e,i){if(t.pickedPoint){e._teleportationRequestInitiated&&(this._displayTeleportationTarget(),this._haloCenter.copyFrom(t.pickedPoint),this._teleportationTarget.position.copyFrom(t.pickedPoint));var r=this._convertNormalToDirectionOfRay(t.getNormal(!0,!1),i);if(r){var o=l.e.Cross(xe.a.Y,r),a=l.e.Cross(r,o);l.e.RotationFromAxisToRef(a,r,o,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}},n.prototype.teleportCamera=function(t){var e=this;if(this.currentVRCamera instanceof Wt.a){this.webVRCamera.leftCamera?(this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition),this._workingVector.subtractInPlace(this.webVRCamera.position),t.subtractToRef(this._workingVector,this._workingVector)):this._workingVector.copyFrom(t),this.isInVRMode?this._workingVector.y+=this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor:this._workingVector.y+=this._defaultHeight,this.onBeforeCameraTeleport.notifyObservers(this._workingVector);var i=90,r,o;if(this._teleportationMode==n.TELEPORTATIONMODE_CONSTANTSPEED){o=i;var a=l.e.Distance(this.currentVRCamera.position,this._workingVector);r=this._teleportationSpeed/a}else o=Math.round(this._teleportationTime*i/1e3),r=1;this.currentVRCamera.animations=[];var s=new y.a("animationCameraTeleportation","position",i,y.a.ANIMATIONTYPE_VECTOR3,y.a.ANIMATIONLOOPMODE_CONSTANT),c=[{frame:0,value:this.currentVRCamera.position},{frame:o,value:this._workingVector}];s.setKeys(c),s.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];var v=Math.round(o/2),b=new y.a("animationPP","vignetteWeight",i,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CONSTANT),C=[];C.push({frame:0,value:0}),C.push({frame:v,value:8}),C.push({frame:o,value:0}),b.setKeys(C),this._postProcessMove.animations.push(b);var M=new y.a("animationPP2","vignetteStretch",i,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CONSTANT),N=[];N.push({frame:0,value:0}),N.push({frame:v,value:10}),N.push({frame:o,value:0}),M.setKeys(N),this._postProcessMove.animations.push(M),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,o,!1,r,function(){e._webVRCamera.detachPostProcess(e._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,o,!1,r,function(){e.onAfterCameraTeleport.notifyObservers(e._workingVector)}),this._hideTeleportationTarget()}},n.prototype._convertNormalToDirectionOfRay=function(t,e){if(t){var i=Math.acos(l.e.Dot(t,e.direction));i<Math.PI/2&&t.scaleInPlace(-1)}return t},n.prototype._castRayAndSelectObject=function(t){if(this.currentVRCamera instanceof Wt.a){var e=t._getForwardRay(this._rayLength),i=this._scene.pickWithRay(e,this._raySelectionPredicate);if(i&&(t._laserPointer&&(i.originMesh=t._laserPointer.parent),this._scene.simulatePointerMove(i,{pointerId:t._id})),t._currentHit=i,i&&i.pickedPoint){if(this._displayGaze){var r=1;t._gazeTracker.isVisible=!0,t._isActionableMesh&&(r=3),this.updateGazeTrackerScale&&(t._gazeTracker.scaling.x=i.distance*r,t._gazeTracker.scaling.y=i.distance*r,t._gazeTracker.scaling.z=i.distance*r);var o=this._convertNormalToDirectionOfRay(i.getNormal(),e),a=.002;if(o){var s=l.e.Cross(xe.a.Y,o),c=l.e.Cross(o,s);l.e.RotationFromAxisToRef(c,o,s,t._gazeTracker.rotation)}t._gazeTracker.position.copyFrom(i.pickedPoint),t._gazeTracker.position.x<0?t._gazeTracker.position.x+=a:t._gazeTracker.position.x-=a,t._gazeTracker.position.y<0?t._gazeTracker.position.y+=a:t._gazeTracker.position.y-=a,t._gazeTracker.position.z<0?t._gazeTracker.position.z+=a:t._gazeTracker.position.z-=a}t._updatePointerDistance(i.distance)}else t._updatePointerDistance(),t._gazeTracker.isVisible=!1;if(i&&i.pickedMesh){if(this._teleportationInitialized&&this._isTeleportationFloor(i.pickedMesh)&&i.pickedPoint){t._currentMeshSelected&&!this._isTeleportationFloor(t._currentMeshSelected)&&this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,t._teleportationRequestInitiated&&this._moveTeleportationSelectorTo(i,t,e);return}if(i.pickedMesh!==t._currentMeshSelected)if(this.meshSelectionPredicate(i.pickedMesh)){this.onNewMeshPicked.notifyObservers(i),t._currentMeshSelected=i.pickedMesh,i.pickedMesh.isPickable&&i.pickedMesh.actionManager?(this.changeGazeColor(this._pickedGazeColor),this.changeLaserColor(this._pickedLaserColor),t._isActionableMesh=!0):(this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor),t._isActionableMesh=!1);try{this.onNewMeshSelected.notifyObservers(i.pickedMesh);var v=t;v.webVRController&&this.onMeshSelectedWithController.notifyObservers({mesh:i.pickedMesh,controller:v.webVRController})}catch(b){p.a.Warn("Error while raising onNewMeshSelected or onMeshSelectedWithController: "+b)}}else this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}else this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}},n.prototype._notifySelectedMeshUnselected=function(t){t&&this.onSelectedMeshUnselected.notifyObservers(t)},n.prototype.setLaserColor=function(t,e){e===void 0&&(e=this._pickedLaserColor),this._laserColor=t,this._pickedLaserColor=e},n.prototype.setLaserLightingState=function(t){t===void 0&&(t=!0),this._leftController&&this._leftController._setLaserPointerLightingDisabled(!t),this._rightController&&this._rightController._setLaserPointerLightingDisabled(!t)},n.prototype.setGazeColor=function(t,e){e===void 0&&(e=this._pickedGazeColor),this._gazeColor=t,this._pickedGazeColor=e},n.prototype.changeLaserColor=function(t){!this.updateControllerLaserColor||(this._leftController&&this._leftController._setLaserPointerColor(t),this._rightController&&this._rightController._setLaserPointerColor(t))},n.prototype.changeGazeColor=function(t){!this.updateGazeTrackerColor||!this._cameraGazer._gazeTracker.material||(this._cameraGazer._gazeTracker.material.emissiveColor=t,this._leftController&&(this._leftController._gazeTracker.material.emissiveColor=t),this._rightController&&(this._rightController._gazeTracker.material.emissiveColor=t))},n.prototype.dispose=function(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._webVRCamera&&this._webVRCamera.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._leftController&&this._leftController.dispose(),this._rightController&&this._rightController.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection=[],document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.onmsfullscreenchange=null,this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChanged),this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart),this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected),this._scene.unregisterBeforeRender(this.beforeRender)},n.prototype.getClassName=function(){return"VRExperienceHelper"},n.TELEPORTATIONMODE_CONSTANTTIME=0,n.TELEPORTATIONMODE_CONSTANTSPEED=1,n}(),ce=u(603),$=function(n,t,e,i){return!(n.x>e.x+i||e.x-i>t.x||n.y>e.y+i||e.y-i>t.y||n.z>e.z+i||e.z-i>t.z)},ae=function(){var n={root:0,found:!1};return function(t,e,i,r){n.root=0,n.found=!1;var o=e*e-4*t*i;if(o<0)return n;var a=Math.sqrt(o),s=(-e-a)/(2*t),c=(-e+a)/(2*t);if(s>c){var v=c;c=s,s=v}return s>0&&s<r?(n.root=s,n.found=!0,n):(c>0&&c<r&&(n.root=c,n.found=!0),n)}}(),Ie=function(){function n(){this._collisionPoint=l.e.Zero(),this._planeIntersectionPoint=l.e.Zero(),this._tempVector=l.e.Zero(),this._tempVector2=l.e.Zero(),this._tempVector3=l.e.Zero(),this._tempVector4=l.e.Zero(),this._edge=l.e.Zero(),this._baseToVertex=l.e.Zero(),this._destinationPoint=l.e.Zero(),this._slidePlaneNormal=l.e.Zero(),this._displacementVector=l.e.Zero(),this._radius=l.e.One(),this._retry=0,this._basePointWorld=l.e.Zero(),this._velocityWorld=l.e.Zero(),this._normalizedVelocity=l.e.Zero(),this._collisionMask=-1}return Object.defineProperty(n.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(t){this._collisionMask=isNaN(t)?-1:t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"slidePlaneNormal",{get:function(){return this._slidePlaneNormal},enumerable:!1,configurable:!0}),n.prototype._initialize=function(t,e,i){this._velocity=e,this._velocitySquaredLength=this._velocity.lengthSquared();var r=Math.sqrt(this._velocitySquaredLength);r===0||r===1?this._normalizedVelocity.copyFromFloats(e._x,e._y,e._z):e.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=t,t.multiplyToRef(this._radius,this._basePointWorld),e.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1},n.prototype._checkPointInTriangle=function(t,e,i,r,o){e.subtractToRef(t,this._tempVector),i.subtractToRef(t,this._tempVector2),l.e.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var a=l.e.Dot(this._tempVector4,o);return a<0||(r.subtractToRef(t,this._tempVector3),l.e.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),a=l.e.Dot(this._tempVector4,o),a<0)?!1:(l.e.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),a=l.e.Dot(this._tempVector4,o),a>=0)},n.prototype._canDoCollision=function(t,e,i,r){var o=l.e.Distance(this._basePointWorld,t),a=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(o>this._velocityWorldLength+a+e||!$(i,r,this._basePointWorld,this._velocityWorldLength+a))},n.prototype._testTriangle=function(t,e,i,r,o,a,s){var c,v=!1;e||(e=[]),e[t]||(e[t]=new ce.a(0,0,0,0),e[t].copyFromPoints(i,r,o));var b=e[t];if(!(!a&&!b.isFrontFacingTo(this._normalizedVelocity,0))){var C=b.signedDistanceTo(this._basePoint),M=l.e.Dot(b.normal,this._velocity);if(M==0){if(Math.abs(C)>=1)return;v=!0,c=0}else{c=(-1-C)/M;var N=(1-C)/M;if(c>N){var D=N;N=c,c=D}if(c>1||N<0)return;c<0&&(c=0),c>1&&(c=1)}this._collisionPoint.copyFromFloats(0,0,0);var V=!1,X=1;if(v||(this._basePoint.subtractToRef(b.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(c,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,o,b.normal)&&(V=!0,X=c,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!V){var ee=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);var ie=2*l.e.Dot(this._velocity,this._tempVector),ge=this._tempVector.lengthSquared()-1,pe=ae(ee,ie,ge,X);pe.found&&(X=pe.root,V=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),ie=2*l.e.Dot(this._velocity,this._tempVector),ge=this._tempVector.lengthSquared()-1,pe=ae(ee,ie,ge,X),pe.found&&(X=pe.root,V=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(o,this._tempVector),ie=2*l.e.Dot(this._velocity,this._tempVector),ge=this._tempVector.lengthSquared()-1,pe=ae(ee,ie,ge,X),pe.found&&(X=pe.root,V=!0,this._collisionPoint.copyFrom(o)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);var te=this._edge.lengthSquared(),Ce=l.e.Dot(this._edge,this._velocity),Ae=l.e.Dot(this._edge,this._baseToVertex);if(ee=te*-this._velocitySquaredLength+Ce*Ce,ie=2*(te*l.e.Dot(this._velocity,this._baseToVertex)-Ce*Ae),ge=te*(1-this._baseToVertex.lengthSquared())+Ae*Ae,pe=ae(ee,ie,ge,X),pe.found){var De=(Ce*pe.root-Ae)/te;De>=0&&De<=1&&(X=pe.root,V=!0,this._edge.scaleInPlace(De),i.addToRef(this._edge,this._collisionPoint))}o.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),te=this._edge.lengthSquared(),Ce=l.e.Dot(this._edge,this._velocity),Ae=l.e.Dot(this._edge,this._baseToVertex),ee=te*-this._velocitySquaredLength+Ce*Ce,ie=2*(te*l.e.Dot(this._velocity,this._baseToVertex)-Ce*Ae),ge=te*(1-this._baseToVertex.lengthSquared())+Ae*Ae,pe=ae(ee,ie,ge,X),pe.found&&(De=(Ce*pe.root-Ae)/te,De>=0&&De<=1&&(X=pe.root,V=!0,this._edge.scaleInPlace(De),r.addToRef(this._edge,this._collisionPoint))),i.subtractToRef(o,this._edge),o.subtractToRef(this._basePoint,this._baseToVertex),te=this._edge.lengthSquared(),Ce=l.e.Dot(this._edge,this._velocity),Ae=l.e.Dot(this._edge,this._baseToVertex),ee=te*-this._velocitySquaredLength+Ce*Ce,ie=2*(te*l.e.Dot(this._velocity,this._baseToVertex)-Ce*Ae),ge=te*(1-this._baseToVertex.lengthSquared())+Ae*Ae,pe=ae(ee,ie,ge,X),pe.found&&(De=(Ce*pe.root-Ae)/te,De>=0&&De<=1&&(X=pe.root,V=!0,this._edge.scaleInPlace(De),o.addToRef(this._edge,this._collisionPoint)))}if(V){var Fe=X*X*this._velocitySquaredLength;(!this.collisionFound||Fe<this._nearestDistanceSquared)&&(s.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=Fe,this._nearestDistance=Math.sqrt(Fe),this.collisionFound=!0),this.collidedMesh=s)}}},n.prototype._collide=function(t,e,i,r,o,a,s,c){if(!i||i.length===0)for(var v=0;v<e.length;v+=3){var b=e[v],C=e[v+1],M=e[v+2];this._testTriangle(v,t,M,C,b,s,c)}else for(var v=r;v<o;v+=3){var b=e[i[v]-a],C=e[i[v+1]-a],M=e[i[v+2]-a];this._testTriangle(v,t,M,C,b,s,c)}},n.prototype._getResponse=function(t,e){t.addToRef(e,this._destinationPoint),e.scaleInPlace(this._nearestDistance/e.length()),this._basePoint.addToRef(e,t),t.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),t.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(ce.a.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,e)},n}(),ft=function(){function n(){this._scaledPosition=l.e.Zero(),this._scaledVelocity=l.e.Zero(),this._finalPosition=l.e.Zero()}return n.prototype.getNewPosition=function(t,e,i,r,o,a,s){t.divideToRef(i._radius,this._scaledPosition),e.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,o),this._finalPosition.multiplyInPlace(i._radius),a(s,this._finalPosition,i.collidedMesh)},n.prototype.createCollider=function(){return new Ie},n.prototype.init=function(t){this._scene=t},n.prototype._collideWithWorld=function(t,e,i,r,o,a){a===void 0&&(a=null);var s=W.a.CollisionsEpsilon*10;if(i._retry>=r){o.copyFrom(t);return}var c=a?a.collisionMask:i.collisionMask;i._initialize(t,e,s);for(var v=a&&a.surroundingMeshes||this._scene.meshes,b=0;b<v.length;b++){var C=v[b];C.isEnabled()&&C.checkCollisions&&C.subMeshes&&C!==a&&(c&C.collisionGroup)!=0&&C._checkCollision(i)}if(!i.collisionFound){t.addToRef(e,o);return}if((e.x!==0||e.y!==0||e.z!==0)&&i._getResponse(t,e),e.length()<=s){o.copyFrom(t);return}i._retry++,this._collideWithWorld(t,e,i,r,o,a)},n}();q.a.CollisionCoordinatorFactory=function(){return new ft};var mt=u(539),st=u(667),kt=u(718),ht=u(686),ke=u(536),Et=u(687),Pt=u(490),ri=function(){function n(t,e,i,r,o,a){this.entries=new Array,this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=o,this._creationFunc=a,this._minPoint=t,this._maxPoint=e,this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors[2].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[3].y=e.y,this._boundingVectors.push(t.clone()),this._boundingVectors[4].z=e.z,this._boundingVectors.push(e.clone()),this._boundingVectors[5].z=t.z,this._boundingVectors.push(e.clone()),this._boundingVectors[6].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[7].y=t.y}return Object.defineProperty(n.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:!1,configurable:!0}),n.prototype.addEntry=function(t){if(this.blocks){for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.addEntry(t)}return}this._creationFunc(t,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},n.prototype.removeEntry=function(t){if(this.blocks){for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.removeEntry(t)}return}var r=this.entries.indexOf(t);r>-1&&this.entries.splice(r,1)},n.prototype.addEntries=function(t){for(var e=0;e<t.length;e++){var i=t[e];this.addEntry(i)}},n.prototype.select=function(t,e,i){if(ht.a.IsInFrustum(this._boundingVectors,t)){if(this.blocks){for(var r=0;r<this.blocks.length;r++){var o=this.blocks[r];o.select(t,e,i)}return}i?e.concat(this.entries):e.concatWithNoDuplicate(this.entries)}},n.prototype.intersects=function(t,e,i,r){if(ht.a.IntersectsSphere(this._minPoint,this._maxPoint,t,e)){if(this.blocks){for(var o=0;o<this.blocks.length;o++){var a=this.blocks[o];a.intersects(t,e,i,r)}return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}},n.prototype.intersectsRay=function(t,e){if(t.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.intersectsRay(t,e)}return}e.concatWithNoDuplicate(this.entries)}},n.prototype.createInnerBlocks=function(){n._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},n._CreateBlocks=function(t,e,i,r,o,a,s,c){s.blocks=new Array;for(var v=new l.e((e.x-t.x)/2,(e.y-t.y)/2,(e.z-t.z)/2),b=0;b<2;b++)for(var C=0;C<2;C++)for(var M=0;M<2;M++){var N=t.add(v.multiplyByFloats(b,C,M)),D=t.add(v.multiplyByFloats(b+1,C+1,M+1)),V=new n(N,D,r,o+1,a,c);V.addEntries(i),s.blocks.push(V)}},n}(),vt=function(){function n(t,e,i){i===void 0&&(i=2),this.maxDepth=i,this.dynamicContent=new Array,this._maxBlockCapacity=e||64,this._selectionContent=new Pt.b(1024),this._creationFunc=t}return n.prototype.update=function(t,e,i){ri._CreateBlocks(t,e,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},n.prototype.addMesh=function(t){for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.addEntry(t)}},n.prototype.removeMesh=function(t){for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.removeEntry(t)}},n.prototype.select=function(t,e){this._selectionContent.reset();for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.select(t,this._selectionContent,e)}return e?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},n.prototype.intersects=function(t,e,i){this._selectionContent.reset();for(var r=0;r<this.blocks.length;r++){var o=this.blocks[r];o.intersects(t,e,this._selectionContent,i)}return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},n.prototype.intersectsRay=function(t){this._selectionContent.reset();for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.intersectsRay(t,this._selectionContent)}return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},n.CreationFuncForMeshes=function(t,e){var i=t.getBoundingInfo();!t.isBlocked&&i.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(t)},n.CreationFuncForSubMeshes=function(t,e){var i=t.getBoundingInfo();i.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(t)},n}();q.a.prototype.createOrUpdateSelectionOctree=function(n,t){n===void 0&&(n=64),t===void 0&&(t=2);var e=this._getComponent(H.a.NAME_OCTREE);e||(e=new qt(this),this._addComponent(e)),this._selectionOctree||(this._selectionOctree=new vt(vt.CreationFuncForMeshes,n,t));var i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree},Object.defineProperty(q.a.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Ue.a.prototype.createOrUpdateSubmeshesOctree=function(n,t){n===void 0&&(n=64),t===void 0&&(t=2);var e=this.getScene(),i=e._getComponent(H.a.NAME_OCTREE);i||(i=new qt(e),e._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new vt(vt.CreationFuncForSubMeshes,n,t)),this.computeWorldMatrix(!0);var r=this.getBoundingInfo(),o=r.boundingBox;return this._submeshesOctree.update(o.minimumWorld,o.maximumWorld,this.subMeshes),this._submeshesOctree};var qt=function(){function n(t){this.name=H.a.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new Zt.a(l.e.Zero(),new l.e(1,1,1)),this.scene=t,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this)}return n.prototype.register=function(){var t=this;this.scene.onMeshRemovedObservable.add(function(e){var i=t.scene.selectionOctree;if(i!=null){var r=i.dynamicContent.indexOf(e);r!==-1&&i.dynamicContent.splice(r,1)}}),this.scene.onMeshImportedObservable.add(function(e){var i=t.scene.selectionOctree;i!=null&&i.addMesh(e)})},n.prototype.getActiveMeshCandidates=function(){if(this.scene._selectionOctree){var t=this.scene._selectionOctree.select(this.scene.frustumPlanes);return t}return this.scene._getDefaultMeshCandidates()},n.prototype.getActiveSubMeshCandidates=function(t){if(t._submeshesOctree&&t.useOctreeForRenderingSelection){var e=t._submeshesOctree.select(this.scene.frustumPlanes);return e}return this.scene._getDefaultSubMeshCandidates(t)},n.prototype.getIntersectingSubMeshCandidates=function(t,e){if(t._submeshesOctree&&t.useOctreeForPicking){Zt.a.TransformToRef(e,t.getWorldMatrix(),this._tempRay);var i=t._submeshesOctree.intersectsRay(this._tempRay);return i}return this.scene._getDefaultSubMeshCandidates(t)},n.prototype.getCollidingSubMeshCandidates=function(t,e){if(t._submeshesOctree&&t.useOctreeForCollisions){var i=e._velocityWorldLength+Math.max(e._radius.x,e._radius.y,e._radius.z),r=t._submeshesOctree.intersects(e._basePointWorld,i);return r}return this.scene._getDefaultSubMeshCandidates(t)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n}(),gi=u(678),wr=u(689),Ai=u(673),Pn=function(){function n(t,e,i){i===void 0&&(i=0),this.deviceType=e,this.deviceSlot=i,this.onInputChangedObservable=new _.c,this._deviceInputSystem=t}return n.prototype.getInput=function(t){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,t)},n}(),gp=function(){function n(t){var e=this;this.onDeviceConnectedObservable=new _.c(function(r){e.getDevices().forEach(function(o){e.onDeviceConnectedObservable.notifyObserver(r,o)})}),this.onDeviceDisconnectedObservable=new _.c;var i=Object.keys(Ai.a).length/2;this._devices=new Array(i),this._firstDevice=new Array(i),this._deviceInputSystem=wr.a.Create(t),this._deviceInputSystem.onDeviceConnected=function(r,o){e._addDevice(r,o),e.onDeviceConnectedObservable.notifyObservers(e.getDeviceSource(r,o))},this._deviceInputSystem.onDeviceDisconnected=function(r,o){var a=e.getDeviceSource(r,o);e._removeDevice(r,o),e.onDeviceDisconnectedObservable.notifyObservers(a)},this._deviceInputSystem.onInputChanged||(this._deviceInputSystem.onInputChanged=function(r,o,a,s,c){var v;(v=e.getDeviceSource(r,o))===null||v===void 0||v.onInputChangedObservable.notifyObservers({inputIndex:a,previousState:s,currentState:c})})}return n.prototype.getDeviceSource=function(t,e){if(e===void 0){if(this._firstDevice[t]===void 0)return null;e=this._firstDevice[t]}return!this._devices[t]||this._devices[t][e]===void 0?null:this._devices[t][e]},n.prototype.getDeviceSources=function(t){return this._devices[t].filter(function(e){return!!e})},n.prototype.getDevices=function(){var t=new Array;return this._devices.forEach(function(e){t.push.apply(t,e)}),t},n.prototype.dispose=function(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._deviceInputSystem.dispose()},n.prototype._addDevice=function(t,e){this._devices[t]||(this._devices[t]=new Array),this._devices[t][e]||(this._devices[t][e]=new Pn(this._deviceInputSystem,t,e),this._updateFirstDevices(t))},n.prototype._removeDevice=function(t,e){delete this._devices[t][e],this._updateFirstDevices(t)},n.prototype._updateFirstDevices=function(t){switch(t){case Ai.a.Keyboard:case Ai.a.Mouse:this._firstDevice[t]=0;break;case Ai.a.Touch:case Ai.a.DualShock:case Ai.a.Xbox:case Ai.a.Switch:case Ai.a.Generic:var e=this._devices[t];delete this._firstDevice[t];for(var i=0;i<e.length;i++)if(e[i]){this._firstDevice[t]=i;break}break}},n}(),mp=function(){function n(){}return n.ALPHA_DISABLE=0,n.ALPHA_ADD=1,n.ALPHA_COMBINE=2,n.ALPHA_SUBTRACT=3,n.ALPHA_MULTIPLY=4,n.ALPHA_MAXIMIZED=5,n.ALPHA_ONEONE=6,n.ALPHA_PREMULTIPLIED=7,n.ALPHA_PREMULTIPLIED_PORTERDUFF=8,n.ALPHA_INTERPOLATE=9,n.ALPHA_SCREENMODE=10,n.ALPHA_ONEONE_ONEONE=11,n.ALPHA_ALPHATOCOLOR=12,n.ALPHA_REVERSEONEMINUS=13,n.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,n.ALPHA_ONEONE_ONEZERO=15,n.ALPHA_EXCLUSION=16,n.ALPHA_EQUATION_ADD=0,n.ALPHA_EQUATION_SUBSTRACT=1,n.ALPHA_EQUATION_REVERSE_SUBTRACT=2,n.ALPHA_EQUATION_MAX=3,n.ALPHA_EQUATION_MIN=4,n.ALPHA_EQUATION_DARKEN=5,n.DELAYLOADSTATE_NONE=0,n.DELAYLOADSTATE_LOADED=1,n.DELAYLOADSTATE_LOADING=2,n.DELAYLOADSTATE_NOTLOADED=4,n.NEVER=512,n.ALWAYS=519,n.LESS=513,n.EQUAL=514,n.LEQUAL=515,n.GREATER=516,n.GEQUAL=518,n.NOTEQUAL=517,n.KEEP=7680,n.ZERO=0,n.REPLACE=7681,n.INCR=7682,n.DECR=7683,n.INVERT=5386,n.INCR_WRAP=34055,n.DECR_WRAP=34056,n.TEXTURE_CLAMP_ADDRESSMODE=0,n.TEXTURE_WRAP_ADDRESSMODE=1,n.TEXTURE_MIRROR_ADDRESSMODE=2,n.TEXTUREFORMAT_ALPHA=0,n.TEXTUREFORMAT_LUMINANCE=1,n.TEXTUREFORMAT_LUMINANCE_ALPHA=2,n.TEXTUREFORMAT_RGB=4,n.TEXTUREFORMAT_RGBA=5,n.TEXTUREFORMAT_RED=6,n.TEXTUREFORMAT_R=6,n.TEXTUREFORMAT_RG=7,n.TEXTUREFORMAT_RED_INTEGER=8,n.TEXTUREFORMAT_R_INTEGER=8,n.TEXTUREFORMAT_RG_INTEGER=9,n.TEXTUREFORMAT_RGB_INTEGER=10,n.TEXTUREFORMAT_RGBA_INTEGER=11,n.TEXTUREFORMAT_BGRA=12,n.TEXTUREFORMAT_DEPTH24_STENCIL8=13,n.TEXTUREFORMAT_DEPTH32_FLOAT=14,n.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,n.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,n.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,n.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,n.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,n.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,n.TEXTURETYPE_UNSIGNED_BYTE=0,n.TEXTURETYPE_UNSIGNED_INT=0,n.TEXTURETYPE_FLOAT=1,n.TEXTURETYPE_HALF_FLOAT=2,n.TEXTURETYPE_BYTE=3,n.TEXTURETYPE_SHORT=4,n.TEXTURETYPE_UNSIGNED_SHORT=5,n.TEXTURETYPE_INT=6,n.TEXTURETYPE_UNSIGNED_INTEGER=7,n.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,n.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,n.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,n.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,n.TEXTURETYPE_UNSIGNED_INT_24_8=12,n.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,n.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,n.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,n.TEXTURE_NEAREST_SAMPLINGMODE=1,n.TEXTURE_NEAREST_NEAREST=1,n.TEXTURE_BILINEAR_SAMPLINGMODE=2,n.TEXTURE_LINEAR_LINEAR=2,n.TEXTURE_TRILINEAR_SAMPLINGMODE=3,n.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,n.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,n.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,n.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,n.TEXTURE_NEAREST_LINEAR=7,n.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,n.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,n.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,n.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,n.TEXTURE_LINEAR_NEAREST=12,n.TEXTURE_EXPLICIT_MODE=0,n.TEXTURE_SPHERICAL_MODE=1,n.TEXTURE_PLANAR_MODE=2,n.TEXTURE_CUBIC_MODE=3,n.TEXTURE_PROJECTION_MODE=4,n.TEXTURE_SKYBOX_MODE=5,n.TEXTURE_INVCUBIC_MODE=6,n.TEXTURE_EQUIRECTANGULAR_MODE=7,n.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,n.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,n.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,n.TEXTURE_FILTERING_QUALITY_HIGH=64,n.TEXTURE_FILTERING_QUALITY_MEDIUM=16,n.TEXTURE_FILTERING_QUALITY_LOW=8,n.SCALEMODE_FLOOR=1,n.SCALEMODE_NEAREST=2,n.SCALEMODE_CEILING=3,n.MATERIAL_TextureDirtyFlag=1,n.MATERIAL_LightDirtyFlag=2,n.MATERIAL_FresnelDirtyFlag=4,n.MATERIAL_AttributesDirtyFlag=8,n.MATERIAL_MiscDirtyFlag=16,n.MATERIAL_PrePassDirtyFlag=32,n.MATERIAL_AllDirtyFlag=63,n.MATERIAL_TriangleFillMode=0,n.MATERIAL_WireFrameFillMode=1,n.MATERIAL_PointFillMode=2,n.MATERIAL_PointListDrawMode=3,n.MATERIAL_LineListDrawMode=4,n.MATERIAL_LineLoopDrawMode=5,n.MATERIAL_LineStripDrawMode=6,n.MATERIAL_TriangleStripDrawMode=7,n.MATERIAL_TriangleFanDrawMode=8,n.MATERIAL_ClockWiseSideOrientation=0,n.MATERIAL_CounterClockWiseSideOrientation=1,n.ACTION_NothingTrigger=0,n.ACTION_OnPickTrigger=1,n.ACTION_OnLeftPickTrigger=2,n.ACTION_OnRightPickTrigger=3,n.ACTION_OnCenterPickTrigger=4,n.ACTION_OnPickDownTrigger=5,n.ACTION_OnDoublePickTrigger=6,n.ACTION_OnPickUpTrigger=7,n.ACTION_OnPickOutTrigger=16,n.ACTION_OnLongPressTrigger=8,n.ACTION_OnPointerOverTrigger=9,n.ACTION_OnPointerOutTrigger=10,n.ACTION_OnEveryFrameTrigger=11,n.ACTION_OnIntersectionEnterTrigger=12,n.ACTION_OnIntersectionExitTrigger=13,n.ACTION_OnKeyDownTrigger=14,n.ACTION_OnKeyUpTrigger=15,n.PARTICLES_BILLBOARDMODE_Y=2,n.PARTICLES_BILLBOARDMODE_ALL=7,n.PARTICLES_BILLBOARDMODE_STRETCHED=8,n.MESHES_CULLINGSTRATEGY_STANDARD=0,n.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,n.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,n.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,n.SCENELOADER_NO_LOGGING=0,n.SCENELOADER_MINIMAL_LOGGING=1,n.SCENELOADER_SUMMARY_LOGGING=2,n.SCENELOADER_DETAILED_LOGGING=3,n.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,n.PREPASS_POSITION_TEXTURE_TYPE=1,n.PREPASS_VELOCITY_TEXTURE_TYPE=2,n.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,n.PREPASS_COLOR_TEXTURE_TYPE=4,n.PREPASS_DEPTH_TEXTURE_TYPE=5,n.PREPASS_NORMAL_TEXTURE_TYPE=6,n.PREPASS_ALBEDO_TEXTURE_TYPE=7,n.CUSTOMEFFECT_PREFIX_SHADOWGENERATOR="bjs_shadowgenerator_",n.INPUT_ALT_KEY=18,n.INPUT_CTRL_KEY=17,n.INPUT_META_KEY1=91,n.INPUT_META_KEY2=92,n.INPUT_META_KEY3=93,n.INPUT_SHIFT_KEY=16,n}(),fn=u(467),Qa=u(645),$v=u(621),Fl=function(){function n(){this._timeElapsedQueryEnded=!1}return n}(),Bl=function(){function n(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=Ue.a.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=Ue.a.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE}return n}();W.a.prototype.createQuery=function(){return this._gl.createQuery()},W.a.prototype.deleteQuery=function(n){return this._gl.deleteQuery(n),this},W.a.prototype.isQueryResultAvailable=function(n){return this._gl.getQueryParameter(n,this._gl.QUERY_RESULT_AVAILABLE)},W.a.prototype.getQueryResult=function(n){return this._gl.getQueryParameter(n,this._gl.QUERY_RESULT)},W.a.prototype.beginOcclusionQuery=function(n,t){var e=this._getGlAlgorithmType(n);return this._gl.beginQuery(e,t),this},W.a.prototype.endOcclusionQuery=function(n){var t=this._getGlAlgorithmType(n);return this._gl.endQuery(t),this},W.a.prototype._createTimeQuery=function(){var n=this.getCaps().timerQuery;return n.createQueryEXT?n.createQueryEXT():this.createQuery()},W.a.prototype._deleteTimeQuery=function(n){var t=this.getCaps().timerQuery;if(t.deleteQueryEXT){t.deleteQueryEXT(n);return}this.deleteQuery(n)},W.a.prototype._getTimeQueryResult=function(n){var t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(n,t.QUERY_RESULT_EXT):this.getQueryResult(n)},W.a.prototype._getTimeQueryAvailability=function(n){var t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(n,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(n)},W.a.prototype.startTimeQuery=function(){var n=this.getCaps(),t=n.timerQuery;if(!t)return null;var e=new Fl;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),n.canUseTimestampForTimerQuery)e._startTimeQuery=this._createTimeQuery(),t.queryCounterEXT(e._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;e._timeElapsedQuery=this._createTimeQuery(),t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,e._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,e._timeElapsedQuery),this._currentNonTimestampToken=e}return e},W.a.prototype.endTimeQuery=function(n){var t=this.getCaps(),e=t.timerQuery;if(!e||!n)return-1;if(t.canUseTimestampForTimerQuery){if(!n._startTimeQuery)return-1;n._endTimeQuery||(n._endTimeQuery=this._createTimeQuery(),e.queryCounterEXT(n._endTimeQuery,e.TIMESTAMP_EXT))}else if(!n._timeElapsedQueryEnded){if(!n._timeElapsedQuery)return-1;e.endQueryEXT?e.endQueryEXT(e.TIME_ELAPSED_EXT):this._gl.endQuery(e.TIME_ELAPSED_EXT),n._timeElapsedQueryEnded=!0}var i=this._gl.getParameter(e.GPU_DISJOINT_EXT),r=!1;if(n._endTimeQuery?r=this._getTimeQueryAvailability(n._endTimeQuery):n._timeElapsedQuery&&(r=this._getTimeQueryAvailability(n._timeElapsedQuery)),r&&!i){var o=0;if(t.canUseTimestampForTimerQuery){if(!n._startTimeQuery||!n._endTimeQuery)return-1;var a=this._getTimeQueryResult(n._startTimeQuery),s=this._getTimeQueryResult(n._endTimeQuery);o=s-a,this._deleteTimeQuery(n._startTimeQuery),this._deleteTimeQuery(n._endTimeQuery),n._startTimeQuery=null,n._endTimeQuery=null}else{if(!n._timeElapsedQuery)return-1;o=this._getTimeQueryResult(n._timeElapsedQuery),this._deleteTimeQuery(n._timeElapsedQuery),n._timeElapsedQuery=null,n._timeElapsedQueryEnded=!1,this._currentNonTimestampToken=null}return o}return-1},W.a.prototype._getGlAlgorithmType=function(n){return n===Ue.a.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},Object.defineProperty(Ue.a.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(n){this._occlusionDataStorage.isOcclusionQueryInProgress=n},enumerable:!1,configurable:!0}),Object.defineProperty(Ue.a.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new Bl),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(Ue.a.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(n){this._occlusionDataStorage.isOccluded=n},enumerable:!0,configurable:!0}),Object.defineProperty(Ue.a.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(n){this._occlusionDataStorage.occlusionQueryAlgorithmType=n},enumerable:!0,configurable:!0}),Object.defineProperty(Ue.a.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(n){this._occlusionDataStorage.occlusionType=n},enumerable:!0,configurable:!0}),Object.defineProperty(Ue.a.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(n){this._occlusionDataStorage.occlusionRetryCount=n},enumerable:!0,configurable:!0}),Ue.a.prototype._checkOcclusionQuery=function(){var n=this._occlusionDataStorage;if(n.occlusionType===Ue.a.OCCLUSION_TYPE_NONE)return n.isOccluded=!1,!1;var t=this.getEngine();if(t.webGLVersion<2||!t.isQueryResultAvailable)return n.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery){var e=t.isQueryResultAvailable(this._occlusionQuery);if(e){var i=t.getQueryResult(this._occlusionQuery);n.isOcclusionQueryInProgress=!1,n.occlusionInternalRetryCounter=0,n.isOccluded=i!==1}else if(n.occlusionInternalRetryCounter++,n.occlusionRetryCount!==-1&&n.occlusionInternalRetryCounter>n.occlusionRetryCount)n.isOcclusionQueryInProgress=!1,n.occlusionInternalRetryCounter=0,n.isOccluded=n.occlusionType===Ue.a.OCCLUSION_TYPE_OPTIMISTIC?!1:n.isOccluded;else return!1}var r=this.getScene();if(r.getBoundingBoxRenderer){var o=r.getBoundingBoxRenderer();this._occlusionQuery||(this._occlusionQuery=t.createQuery()),t.beginOcclusionQuery(n.occlusionQueryAlgorithmType,this._occlusionQuery),o.renderOcclusionBoundingBox(this),t.endOcclusionQuery(n.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0}return n.isOccluded};var vp=!0;W.a.prototype.createTransformFeedback=function(){return this._gl.createTransformFeedback()},W.a.prototype.deleteTransformFeedback=function(n){this._gl.deleteTransformFeedback(n)},W.a.prototype.bindTransformFeedback=function(n){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,n)},W.a.prototype.beginTransformFeedback=function(n){n===void 0&&(n=!0),this._gl.beginTransformFeedback(n?this._gl.POINTS:this._gl.TRIANGLES)},W.a.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},W.a.prototype.setTranformFeedbackVaryings=function(n,t){this._gl.transformFeedbackVaryings(n,t,this._gl.INTERLEAVED_ATTRIBS)},W.a.prototype.bindTransformFeedbackBuffer=function(n){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,n?n.underlyingResource:null)};var qv=u(492),e_=u(532),Nl=u(596);fn.a.prototype.updateVideoTexture=function(n,t,e){if(!(!n||n._isDisabled)){var i=this._bindTextureDirectly(this._gl.TEXTURE_2D,n,!0);this._unpackFlipY(!e);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t);else{if(!n._workingCanvas){n._workingCanvas=Nl.a.CreateCanvas(n.width,n.height);var r=n._workingCanvas.getContext("2d");if(!r)throw new Error("Unable to get 2d context");n._workingContext=r,n._workingCanvas.width=n.width,n._workingCanvas.height=n.height}n._workingContext.clearRect(0,0,n.width,n.height),n._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,n.width,n.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n._workingCanvas)}n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),i||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),n.isReady=!0}catch(o){n._isDisabled=!0}}};var t_=u(574),i_=u(565),r_=u(500),n_=u(522),o_=u(717),a_=u(622),_p=function(){function n(){}return n}();W.a.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},W.a.prototype.registerView=function(n,t){var e=this;this.views||(this.views=[]);for(var i=0,r=this.views;i<r.length;i++){var o=r[i];if(o.target===n)return o}var a=this.getRenderingCanvas();a&&(n.width=a.width,n.height=a.height);var s={target:n,camera:t};return this.views.push(s),t&&t.onDisposeObservable.add(function(){e.unRegisterView(n)}),s},W.a.prototype.unRegisterView=function(n){if(!this.views)return this;for(var t=0,e=this.views;t<e.length;t++){var i=e[t];if(i.target===n){var r=this.views.indexOf(i);r!==-1&&this.views.splice(r,1);break}}return this},W.a.prototype._renderViews=function(){if(!this.views)return!1;var n=this.getRenderingCanvas();if(!n)return!1;for(var t=0,e=this.views;t<e.length;t++){var i=e[t],r=i.target,o=r.getContext("2d");if(!!o){var a=i.camera,s=null,c=null;if(a){if(c=a.getScene(),c.activeCameras&&c.activeCameras.length)continue;this.activeView=i,s=c.activeCamera,c.activeCamera=a}var v=r.clientWidth!==r.width||n.width!==r.width||r.clientHeight!==r.height||n.height!==r.height;if(r.clientWidth&&r.clientHeight&&v&&(r.width=r.clientWidth,r.height=r.clientHeight,n.width=r.clientWidth,n.height=r.clientHeight,this.resize(!0)),!n.width||!n.height)return!1;this._renderFrame(),o.drawImage(n,0,0),s&&c&&(c.activeCamera=s)}}return this.activeView=null,!0};var s_=u(685);function yp(n){var t=function(o){var a="\\b"+o+"\\b";return n&&(n===o||n.match(new RegExp(a,"g")))};if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(t))return n;var e=n.lastIndexOf("."),i=n.lastIndexOf("?"),r=i>-1?n.substring(i,n.length):"";return(e>-1?n.substring(0,e):n)+this._textureFormatInUse+r}Object.defineProperty(W.a.prototype,"texturesSupported",{get:function(){var n=new Array;return this._caps.astc&&n.push("-astc.ktx"),this._caps.s3tc&&n.push("-dxt.ktx"),this._caps.pvrtc&&n.push("-pvrtc.ktx"),this._caps.etc2&&n.push("-etc2.ktx"),this._caps.etc1&&n.push("-etc1.ktx"),n},enumerable:!0,configurable:!0}),Object.defineProperty(W.a.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),W.a.prototype.setCompressedTextureExclusions=function(n){this._excludedCompressedTextures=n},W.a.prototype.setTextureFormatToUse=function(n){for(var t=this.texturesSupported,e=0,i=t.length;e<i;e++)for(var r=0,o=n.length;r<o;r++)if(t[e]===n[r].toLowerCase())return this._transformTextureUrl=yp.bind(this),this._textureFormatInUse=t[e];return this._textureFormatInUse="",this._transformTextureUrl=null,null};var bp=u(714),Za;(function(n){n.LowPower="low-power",n.HighPerformance="high-performance"})(Za||(Za={}));var io;(function(n){n.DepthClamping="depth-clamping",n.Depth24UnormStencil8="depth24unorm-stencil8",n.Depth32FloatStencil8="depth32float-stencil8",n.PipelineStatisticsQuery="pipeline-statistics-query",n.TextureCompressionBC="texture-compression-bc",n.TimestampQuery="timestamp-query"})(io||(io={}));var Fi;(function(n){n[n.MapRead=1]="MapRead",n[n.MapWrite=2]="MapWrite",n[n.CopySrc=4]="CopySrc",n[n.CopyDst=8]="CopyDst",n[n.Index=16]="Index",n[n.Vertex=32]="Vertex",n[n.Uniform=64]="Uniform",n[n.Storage=128]="Storage",n[n.Indirect=256]="Indirect",n[n.QueryResolve=512]="QueryResolve"})(Fi||(Fi={}));var Vo;(function(n){n[n.Read=1]="Read",n[n.Write=2]="Write"})(Vo||(Vo={}));var Vr;(function(n){n.E1d="1d",n.E2d="2d",n.E3d="3d"})(Vr||(Vr={}));var ei;(function(n){n[n.CopySrc=1]="CopySrc",n[n.CopyDst=2]="CopyDst",n[n.Sampled=4]="Sampled",n[n.Storage=8]="Storage",n[n.OutputAttachment=16]="OutputAttachment"})(ei||(ei={}));var Oi;(function(n){n.E1d="1d",n.E2d="2d",n.E2dArray="2d-array",n.Cube="cube",n.CubeArray="cube-array",n.E3d="3d"})(Oi||(Oi={}));var qr;(function(n){n.All="all",n.StencilOnly="stencil-only",n.DepthOnly="depth-only"})(qr||(qr={}));var Se;(function(n){n.R8Unorm="r8unorm",n.R8Snorm="r8snorm",n.R8Uint="r8uint",n.R8Sint="r8sint",n.R16Uint="r16uint",n.R16Sint="r16sint",n.R16Float="r16float",n.RG8Unorm="rg8unorm",n.RG8Snorm="rg8snorm",n.RG8Uint="rg8uint",n.RG8Sint="rg8sint",n.R32Uint="r32uint",n.R32Sint="r32sint",n.R32Float="r32float",n.RG16Uint="rg16uint",n.RG16Sint="rg16sint",n.RG16Float="rg16float",n.RGBA8Unorm="rgba8unorm",n.RGBA8UnormSRGB="rgba8unorm-srgb",n.RGBA8Snorm="rgba8snorm",n.RGBA8Uint="rgba8uint",n.RGBA8Sint="rgba8sint",n.BGRA8Unorm="bgra8unorm",n.BGRA8UnormSRGB="bgra8unorm-srgb",n.RGB9E5UFloat="rgb9e5ufloat",n.RGB10A2Unorm="rgb10a2unorm",n.RG11B10UFloat="rg11b10ufloat",n.RG32Uint="rg32uint",n.RG32Sint="rg32sint",n.RG32Float="rg32float",n.RGBA16Uint="rgba16uint",n.RGBA16Sint="rgba16sint",n.RGBA16Float="rgba16float",n.RGBA32Uint="rgba32uint",n.RGBA32Sint="rgba32sint",n.RGBA32Float="rgba32float",n.Stencil8="stencil8",n.Depth16Unorm="depth16unorm",n.Depth24Plus="depth24plus",n.Depth24PlusStencil8="depth24plus-stencil8",n.Depth32Float="depth32float",n.BC1RGBAUNorm="bc1-rgba-unorm",n.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",n.BC2RGBAUnorm="bc2-rgba-unorm",n.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",n.BC3RGBAUnorm="bc3-rgba-unorm",n.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",n.BC4RUnorm="bc4-r-unorm",n.BC4RSnorm="bc4-r-snorm",n.BC5RGUnorm="bc5-rg-unorm",n.BC5RGSnorm="bc5-rg-snorm",n.BC6HRGBUFloat="bc6h-rgb-ufloat",n.BC6HRGBFloat="bc6h-rgb-float",n.BC7RGBAUnorm="bc7-rgba-unorm",n.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",n.Depth24UnormStencil8="depth24unorm-stencil8",n.Depth32FloatStencil8="depth32float-stencil8"})(Se||(Se={}));var hn;(function(n){n.ClampToEdge="clamp-to-edge",n.Repeat="repeat",n.MirrorRepeat="mirror-repeat"})(hn||(hn={}));var _t;(function(n){n.Nearest="nearest",n.Linear="linear"})(_t||(_t={}));var ti;(function(n){n.Never="never",n.Less="less",n.Equal="equal",n.LessEqual="less-equal",n.Greater="greater",n.NotEqual="not-equal",n.GreaterEqual="greater-equal",n.Always="always"})(ti||(ti={}));var ro;(function(n){n[n.Vertex=1]="Vertex",n[n.Fragment=2]="Fragment",n[n.Compute=4]="Compute"})(ro||(ro={}));var Uo;(function(n){n.Uniform="uniform",n.Storage="storage",n.ReadOnlyStorage="read-only-storage"})(Uo||(Uo={}));var no;(function(n){n.Filtering="filtering",n.NonFiltering="non-filtering",n.Comparison="comparison"})(no||(no={}));var dn;(function(n){n.Float="float",n.UnfilterableFloat="unfilterable-float",n.Depth="depth",n.Sint="sint",n.Uint="uint"})(dn||(dn={}));var Ja;(function(n){n.ReadOnly="read-only",n.WriteOnly="write-only"})(Ja||(Ja={}));var $a;(function(n){n.Error="error",n.Warning="warning",n.Info="info"})($a||($a={}));var ki;(function(n){n.PointList="point-list",n.LineList="line-list",n.LineStrip="line-strip",n.TriangleList="triangle-list",n.TriangleStrip="triangle-strip"})(ki||(ki={}));var oo;(function(n){n.CCW="ccw",n.CW="cw"})(oo||(oo={}));var Cn;(function(n){n.None="none",n.Front="front",n.Back="back"})(Cn||(Cn={}));var Go;(function(n){n[n.Red=1]="Red",n[n.Green=2]="Green",n[n.Blue=4]="Blue",n[n.Alpha=8]="Alpha",n[n.All=15]="All"})(Go||(Go={}));var Si;(function(n){n.Zero="zero",n.One="one",n.SrcColor="src-color",n.OneMinusSrcColor="one-minus-src-color",n.SrcAlpha="src-alpha",n.OneMinusSrcAlpha="one-minus-src-alpha",n.DstColor="dst-color",n.OneMinusDstColor="one-minus-dst-color",n.DstAlpha="dst-alpha",n.OneMinusDstAlpha="one-minus-dst-alpha",n.SrcAlphaSaturated="src-alpha-saturated",n.BlendColor="blend-color",n.OneMinusBlendColor="one-minus-blend-color"})(Si||(Si={}));var Ur;(function(n){n.Add="add",n.Subtract="subtract",n.ReverseSubtract="reverse-subtract",n.Min="min",n.Max="max"})(Ur||(Ur={}));var ir;(function(n){n.Keep="keep",n.Zero="zero",n.Replace="replace",n.Invert="invert",n.IncrementClamp="increment-clamp",n.DecrementClamp="decrement-clamp",n.IncrementWrap="increment-wrap",n.DecrementWrap="decrement-wrap"})(ir||(ir={}));var Gr;(function(n){n.Uint16="uint16",n.Uint32="uint32"})(Gr||(Gr={}));var zt;(function(n){n.Uchar2="uchar2",n.Uchar4="uchar4",n.Char2="char2",n.Char4="char4",n.Uchar2Norm="uchar2norm",n.Uchar4Norm="uchar4norm",n.Char2Norm="char2norm",n.Char4Norm="char4norm",n.Ushort2="ushort2",n.Ushort4="ushort4",n.Short2="short2",n.Short4="short4",n.Ushort2Norm="ushort2norm",n.Ushort4Norm="ushort4norm",n.Short2Norm="short2norm",n.Short4Norm="short4norm",n.Half2="half2",n.Half4="half4",n.Float="float",n.Float2="float2",n.Float3="float3",n.Float4="float4",n.Uint="uint",n.Uint2="uint2",n.Uint3="uint3",n.Uint4="uint4",n.Int="int",n.Int2="int2",n.Int3="int3",n.Int4="int4"})(zt||(zt={}));var ao;(function(n){n.Vertex="vertex",n.Instance="instance"})(ao||(ao={}));var Gi;(function(n){n.Load="load"})(Gi||(Gi={}));var Sr;(function(n){n.Store="store",n.Clear="clear"})(Sr||(Sr={}));var qa;(function(n){n.Occlusion="occlusion",n.PipelineStatistics="pipeline-statistics",n.Timestamp="timestamp"})(qa||(qa={}));var es;(function(n){n.VertexShaderInvocations="vertex-shader-invocations",n.ClipperInvocations="clipper-invocations",n.ClipperPrimitivesOut="clipper-primitives-out",n.FragmentShaderInvocations="fragment-shader-invocations",n.ComputeShaderInvocations="compute-shader-invocations"})(es||(es={}));var ts;(function(n){n.Destroyed="destroyed"})(ts||(ts={}));var is;(function(n){n.OutOfMemory="out-of-memory",n.Validation="validation"})(is||(is={}));var et=u(475),wl=u(595),Oe=u(447),Ep={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16},Vl=function(){function n(){this.values={}}return n}(),Pp=function(){function n(t,e){this.samplers={},this.textures={},this._name="unnamed",this.shaderProcessingContext=t,this.leftOverUniformsByName={},this.engine=e,this.bindGroupsCache=new Vl}return Object.defineProperty(n.prototype,"isAsync",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isReady",{get:function(){return!!this.stages},enumerable:!1,configurable:!0}),n.prototype._handlesSpectorRebuildCallback=function(t){},n.prototype._fillEffectInformation=function(t,e,i,r,o,a,s,c){var v=this.engine,b=v.getUniforms(this,i);b.forEach(function(te,Ce){r[i[Ce]]=te}),t._fragmentSourceCode="",t._vertexSourceCode="";var C=this.shaderProcessingContext.availableSamplers,M;for(M=0;M<o.length;M++){var N=o[M],D=C[o[M]];D==null||D==null?(o.splice(M,1),M--):a[N]=M}for(var V=0,X=v.getAttributes(this,s);V<X.length;V++){var ee=X[V];c.push(ee)}this.buildUniformLayout();var ie=[],ge=[];for(M=0;M<s.length;M++){var pe=c[M];pe>=0&&(ie.push(s[M]),ge.push(pe))}this.shaderProcessingContext.attributeNamesFromEffect=ie,this.shaderProcessingContext.attributeLocationsFromEffect=ge},n.prototype.buildUniformLayout=function(){if(!!this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new Fr.a(this.engine,void 0,void 0,"leftOver-"+this._name);for(var t=0,e=this.shaderProcessingContext.leftOverUniforms;t<e.length;t++){var i=e[t],r=Ep[i.type];this.uniformBuffer.addUniform(i.name,r,i.length),this.leftOverUniformsByName[i.name]=i.type}this.uniformBuffer.create()}},n.prototype.dispose=function(){this.uniformBuffer&&this.uniformBuffer.dispose()},n.prototype.setInt=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateInt(t,e)},n.prototype.setInt2=function(t,e,i){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateInt2(t,e,i)},n.prototype.setInt3=function(t,e,i,r){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateInt3(t,e,i,r)},n.prototype.setInt4=function(t,e,i,r,o){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateInt4(t,e,i,r,o)},n.prototype.setIntArray=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateIntArray(t,e)},n.prototype.setIntArray2=function(t,e){this.setIntArray(t,e)},n.prototype.setIntArray3=function(t,e){this.setIntArray(t,e)},n.prototype.setIntArray4=function(t,e){this.setIntArray(t,e)},n.prototype.setArray=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateArray(t,e)},n.prototype.setArray2=function(t,e){this.setArray(t,e)},n.prototype.setArray3=function(t,e){this.setArray(t,e)},n.prototype.setArray4=function(t,e){this.setArray(t,e)},n.prototype.setMatrices=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateMatrices(t,e)},n.prototype.setMatrix=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateMatrix(t,e)},n.prototype.setMatrix3x3=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateMatrix3x3(t,e)},n.prototype.setMatrix2x2=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateMatrix2x2(t,e)},n.prototype.setFloat=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateFloat(t,e)},n.prototype.setVector2=function(t,e){this.setFloat2(t,e.x,e.y)},n.prototype.setFloat2=function(t,e,i){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateFloat2(t,e,i)},n.prototype.setVector3=function(t,e){this.setFloat3(t,e.x,e.y,e.z)},n.prototype.setFloat3=function(t,e,i,r){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateFloat3(t,e,i,r)},n.prototype.setVector4=function(t,e){this.setFloat4(t,e.x,e.y,e.z,e.w)},n.prototype.setFloat4=function(t,e,i,r,o){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateFloat4(t,e,i,r,o)},n.prototype.setColor3=function(t,e){this.setFloat3(t,e.r,e.g,e.b)},n.prototype.setColor4=function(t,e,i){this.setFloat4(t,e.r,e.g,e.b,i)},n.prototype.setDirectColor4=function(t,e){this.setFloat4(t,e.r,e.g,e.b,e.a)},n.prototype._getVertexShaderCode=function(){var t;return(t=this.sources)===null||t===void 0?void 0:t.vertex},n.prototype._getFragmentShaderCode=function(){var t;return(t=this.sources)===null||t===void 0?void 0:t.fragment},n}(),zo=u(554),Cp=!1,Sp={Scene:{setIndex:0,bindingIndex:0},Light0:{setIndex:0,bindingIndex:5},Light1:{setIndex:0,bindingIndex:6},Light2:{setIndex:0,bindingIndex:7},Light3:{setIndex:0,bindingIndex:8},Light4:{setIndex:0,bindingIndex:9},Light5:{setIndex:0,bindingIndex:10},Light6:{setIndex:0,bindingIndex:11},Light7:{setIndex:0,bindingIndex:12},Light8:{setIndex:0,bindingIndex:13},Material:{setIndex:1,bindingIndex:0},Mesh:{setIndex:1,bindingIndex:1}},Tp={environmentBrdfSampler:{sampler:{setIndex:0,bindingIndex:1},isTextureArray:!1,textures:[{setIndex:0,bindingIndex:2}]}},Rp={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube"},Ap={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray"},Op={textureCube:Oi.Cube,textureCubeArray:Oi.CubeArray,texture2D:Oi.E2d,texture2DArray:Oi.E2dArray},Mp={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},xp={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1},Dp=function(){function n(){this._missingVaryings=[],this._textureArrayProcessing=[]}return n.prototype._getArraySize=function(t,e){var i=0,r=t.indexOf("["),o=t.indexOf("]");if(r>0&&o>0){var a=t.substring(r+1,o);i=+a,isNaN(i)&&(i=+e[a.trim()]),t=t.substr(0,r)}return[t,i]},n.prototype.initializeShaders=function(t){this._missingVaryings.length=0,this._textureArrayProcessing.length=0},n.prototype.varyingProcessor=function(t,e,i,r){this._preProcessors=i;var o=r,a=new RegExp(/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm),s=a.exec(t);if(s!=null){var c=s[1],v=s[2],b;e?(b=o.availableVaryings[v],this._missingVaryings[b]="",b===void 0&&p.a.Warn('Invalid fragment shader: The varying named "'+v+'" is not declared in the vertex shader! This declaration will be ignored.')):(b=o.getVaryingNextLocation(c,this._getArraySize(v,i)[1]),o.availableVaryings[v]=b,this._missingVaryings[b]="layout(location = "+b+") in "+c+" "+v+";"),t=t.replace(s[0],b===void 0?"":"layout(location = "+b+") "+(e?"in":"out")+" "+c+" "+v+";")}return t},n.prototype.attributeProcessor=function(t,e,i){this._preProcessors=e;var r=i,o=new RegExp(/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm),a=o.exec(t);if(a!=null){var s=a[1],c=a[2],v=r.getAttributeNextLocation(s,this._getArraySize(c,e)[1]);r.availableAttributes[c]=v,r.orderedAttributes[v]=c,t=t.replace(a[0],"layout(location = "+v+") in "+s+" "+c+";")}return t},n.prototype.uniformProcessor=function(t,e,i,r){var o,a,s;this._preProcessors=i;var c=r,v=new RegExp(/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm),b=v.exec(t);if(b!=null){var C=b[1],M=b[2];if(C.indexOf("sampler")===0||C.indexOf("sampler")===1){var N=Tp[M],D=0;if(!N)if(o=this._getArraySize(M,i),M=o[0],D=o[1],N=c.availableSamplers[M],N)D=N.isTextureArray?N.textures.length:0;else{N={sampler:c.getNextFreeUBOBinding(),isTextureArray:D>0,textures:[]};for(var V=0;V<(D||1);++V)N.textures.push(c.getNextFreeUBOBinding())}var X=C.charAt(0)==="u"?"u":C.charAt(0)==="i"?"i":"";X&&(C=C.substr(1));var ee=D>0,ie=N.sampler.setIndex,ge=N.sampler.bindingIndex,pe=Rp[C],te=(s=Mp[C])!==null&&s!==void 0?s:"sampler",Ce=Ap[C],Ae=Op[Ce],De=!!xp[te];if(!ee)D=1,t="layout(set = "+ie+", binding = "+ge+") uniform "+X+te+" "+M+`Sampler;
                        layout(set = `+N.textures[0].setIndex+", binding = "+N.textures[0].bindingIndex+") uniform "+Ce+" "+M+`Texture;
                        #define `+M+" "+X+pe+"("+M+"Texture, "+M+"Sampler)";else{var Fe=[];Fe.push("layout(set = "+ie+", binding = "+ge+") uniform "+X+te+" "+M+"Sampler;"),t=`\r
`;for(var V=0;V<D;++V){var We=N.textures[V].setIndex,Pe=N.textures[V].bindingIndex;Fe.push("layout(set = "+We+", binding = "+Pe+") uniform "+Ce+" "+M+"Texture"+V+";"),t+=(V>0?`\r
`:"")+"#define "+M+V+" "+X+pe+"("+M+"Texture"+V+", "+M+"Sampler)"}t=Fe.join(`\r
`)+t,this._textureArrayProcessing.push(M)}c.availableSamplers[M]=N,c.orderedUBOsAndSamplers[ie]||(c.orderedUBOsAndSamplers[ie]=[]),c.orderedUBOsAndSamplers[ie][ge]||(c.orderedUBOsAndSamplers[ie][ge]={isSampler:!0,isTexture:!1,isComparisonSampler:De,usedInVertex:!1,usedInFragment:!1,name:M}),e?c.orderedUBOsAndSamplers[ie][ge].usedInFragment=!0:c.orderedUBOsAndSamplers[ie][ge].usedInVertex=!0;for(var V=0;V<D;++V){var We=N.textures[V].setIndex,Pe=N.textures[V].bindingIndex;c.orderedUBOsAndSamplers[We]||(c.orderedUBOsAndSamplers[We]=[]),c.orderedUBOsAndSamplers[We][Pe]||(c.orderedUBOsAndSamplers[We][Pe]={isSampler:!1,isTexture:!0,sampleType:De?dn.Depth:X==="u"?dn.Uint:X==="i"?dn.Sint:dn.Float,textureDimension:Ae,usedInVertex:!1,usedInFragment:!1,name:ee?M+V.toString():M}),e?c.orderedUBOsAndSamplers[We][Pe].usedInFragment=!0:c.orderedUBOsAndSamplers[We][Pe].usedInVertex=!0}}else{var Ne=0;a=this._getArraySize(M,i),M=a[0],Ne=a[1];for(var V=0;V<c.leftOverUniforms.length;V++)if(c.leftOverUniforms[V].name===M)return"";c.leftOverUniforms.push({name:M,type:C,length:Ne}),t=""}}return t},n.prototype.uniformBufferProcessor=function(t,e,i){var r=i,o=new RegExp(/uniform\s+(\w+)/gm),a=o.exec(t);if(a!=null){var s=a[1],c=void 0,v=void 0,b=Sp[s];if(b)c=b.setIndex,v=b.bindingIndex;else if(e){var C=r.availableUBOs[s];if(C)c=C.setIndex,v=C.bindingIndex;else{var M=r.getNextFreeUBOBinding();c=M.setIndex,v=M.bindingIndex}}else{var M=r.getNextFreeUBOBinding();c=M.setIndex,v=M.bindingIndex}r.availableUBOs[s]={setIndex:c,bindingIndex:v},r.orderedUBOsAndSamplers[c]||(r.orderedUBOsAndSamplers[c]=[]),r.orderedUBOsAndSamplers[c][v]||(r.orderedUBOsAndSamplers[c][v]={isSampler:!1,isTexture:!1,name:s,usedInVertex:!1,usedInFragment:!1}),e?r.orderedUBOsAndSamplers[c][v].usedInFragment=!0:r.orderedUBOsAndSamplers[c][v].usedInVertex=!0,t=t.replace("uniform","layout(set = "+c+", binding = "+v+") uniform")}return t},n.prototype.postProcessor=function(t,e,i,r){var o=t.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,a=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(t=t.replace(a,""),t=t.replace(/texture2D\s*\(/g,"texture("),i)t=t.replace(/texture2DLodEXT\s*\(/g,"textureLod("),t=t.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),t=t.replace(/textureCube\s*\(/g,"texture("),t=t.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),t=t.replace(/gl_FragColor/g,"glFragColor"),t=t.replace(/gl_FragData/g,"glFragData"),t=t.replace(/void\s+?main\s*\(/g,(o?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else{t=t.replace(/gl_InstanceID/g,"gl_InstanceIndex"),t=t.replace(/gl_VertexID/g,"gl_VertexIndex");var s=e.indexOf("#define MULTIVIEW")!==-1;if(s)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+t}if(!i){var c=t.lastIndexOf("}");t=t.substring(0,c),t+=`gl_Position.y *= -1.;
gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0; }`}var v=new zo.a(t);return v.debug=Cp,v.processCode(),v.code},n.prototype._applyTextureArrayProcessing=function(t,e){for(var i=new RegExp(e+"\\s*\\[(.+)?\\]","gm"),r=i.exec(t);r!=null;){var o=r[1],a=+o;this._preProcessors&&isNaN(a)&&(a=+this._preProcessors[o.trim()]),t=t.replace(r[0],e+a),r=i.exec(t)}return t},n.prototype.finalizeShaders=function(t,e,i){for(var r=i,o=0;o<this._textureArrayProcessing.length;++o){var a=this._textureArrayProcessing[o];t=this._applyTextureArrayProcessing(t,a),e=this._applyTextureArrayProcessing(e,a)}for(var o=0;o<this._missingVaryings.length;++o){var s=this._missingVaryings[o];s&&s.length>0&&(e=s+`
`+e)}if(r.leftOverUniforms.length){var c="LeftOver",v=r.availableUBOs[c];v||(v=r.getNextFreeUBOBinding(),r.availableUBOs[c]=v,r.orderedUBOsAndSamplers[v.setIndex]||(r.orderedUBOsAndSamplers[v.setIndex]=[]),r.orderedUBOsAndSamplers[v.setIndex][v.bindingIndex]={isSampler:!1,isTexture:!1,usedInVertex:!0,usedInFragment:!0,name:c});for(var b="layout(set = "+v.setIndex+", binding = "+v.bindingIndex+") uniform "+c+` {
    `,C=0,M=r.leftOverUniforms;C<M.length;C++){var N=M[C];N.length>0?b+="    "+N.type+" "+N.name+"["+N.length+`];
`:b+="    "+N.type+" "+N.name+`;
`}b+=`};

`,t=b+t,e=b+e}for(var o=0;o<r.orderedUBOsAndSamplers.length;o++){var D=r.orderedUBOsAndSamplers[o];if(D!==void 0)for(var V=0;V<D.length;V++){var X=r.orderedUBOsAndSamplers[o][V];X&&!X.isSampler&&!X.isTexture&&r.uniformBufferNames.push(X.name)}}return this._preProcessors=null,{vertexCode:t,fragmentCode:e}},n}(),Ip=4,Lp=16,Ul={mat2:2,mat3:3,mat4:4},Fp=function(){function n(){this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeSetIndex=2,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableUBOs={},this.availableSamplers={},this.orderedAttributes=[],this.orderedUBOsAndSamplers=[],this.uniformBufferNames=[],this.leftOverUniforms=[]}return n.prototype.getAttributeNextLocation=function(t,e){var i;e===void 0&&(e=0);var r=this._attributeNextLocation;return this._attributeNextLocation+=((i=Ul[t])!==null&&i!==void 0?i:1)*(e||1),r},n.prototype.getVaryingNextLocation=function(t,e){var i;e===void 0&&(e=0);var r=this._varyingNextLocation;return this._varyingNextLocation+=((i=Ul[t])!==null&&i!==void 0?i:1)*(e||1),r},n.prototype.getNextFreeUBOBinding=function(){return this._getNextFreeBinding(1)},n.prototype._getNextFreeBinding=function(t){if(this.freeBindingIndex>Lp-t&&(this.freeSetIndex++,this.freeBindingIndex=0),this.freeSetIndex===Ip)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";var e={setIndex:this.freeSetIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=t,e},n}(),$e=u(450),rs=function(){function n(t){t===void 0&&(t=null),this.format=Se.RGBA8Unorm,this.textureUsages=0,this._webgpuTexture=t,this._webgpuMSAATexture=null,this.view=null}return Object.defineProperty(n.prototype,"underlyingResource",{get:function(){return this._webgpuTexture},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"msaaTexture",{get:function(){return this._webgpuMSAATexture},set:function(t){this._webgpuMSAATexture=t},enumerable:!1,configurable:!0}),n.prototype.set=function(t){this._webgpuTexture=t},n.prototype.setMSAATexture=function(t){this._webgpuMSAATexture=t},n.prototype.setUsage=function(t,e,i,r,o){e=t===gt.b.RenderTarget?!1:e,this.createView({dimension:i?Oi.Cube:Oi.E2d,mipLevelCount:e?$e.a.ILog2(Math.max(r,o))+1:1,baseArrayLayer:0,baseMipLevel:0,aspect:qr.All})},n.prototype.createView=function(t){this.view=this._webgpuTexture.createView(t)},n.prototype.reset=function(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null},n.prototype.release=function(){var t,e;(t=this._webgpuTexture)===null||t===void 0||t.destroy(),(e=this._webgpuMSAATexture)===null||e===void 0||e.destroy(),this.reset()},n}(),Bp=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(location = 0) out vec2 vTex;

    void main() {
        vTex = tex[gl_VertexIndex];
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,Np=`
    layout(set = 0, binding = 0) uniform sampler imgSampler;
    layout(set = 0, binding = 1) uniform texture2D img;

    layout(location = 0) in vec2 vTex;
    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = texture(sampler2D(img, imgSampler), vTex);
    }
    `,wp=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(location = 0) out vec2 vTex;

    void main() {
        vTex = tex[gl_VertexIndex];
    #ifdef INVERTY
        vTex.y = 1.0 - vTex.y;
    #endif
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,Vp=`
    layout(set = 0, binding = 0) uniform sampler imgSampler;
    layout(set = 0, binding = 1) uniform texture2D img;

    layout(location = 0) in vec2 vTex;
    layout(location = 0) out vec4 outColor;

    void main() {
        vec4 color = texture(sampler2D(img, imgSampler), vTex);
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,Up=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));

    void main() {
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,Gp=`
    layout(set = 0, binding = 0) uniform Uniforms {
        uniform vec4 color;
    };

    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = color;
    }
    `,zr;(function(n){n[n.MipMap=0]="MipMap",n[n.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",n[n.Clear=2]="Clear"})(zr||(zr={}));var Gl=[{vertex:Bp,fragment:Np},{vertex:wp,fragment:Vp},{vertex:Up,fragment:Gp}],so=function(){function n(t,e,i){this._pipelines={},this._compiledShaders=[],this._deferredReleaseTextures=[],this._device=t,this._glslang=e,this._bufferManager=i,this._mipmapSampler=t.createSampler({minFilter:_t.Linear}),this._invertYPreMultiplyAlphaSampler=t.createSampler({minFilter:_t.Nearest,magFilter:_t.Nearest}),this._getPipeline(Se.RGBA8Unorm)}return n.ComputeNumMipmapLevels=function(t,e){return $e.a.ILog2(Math.max(t,e))+1},n.prototype._getPipeline=function(t,e,i){e===void 0&&(e=zr.MipMap);var r=e===zr.MipMap?1<<0:e===zr.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):e===zr.Clear?1<<3:0;this._pipelines[t]||(this._pipelines[t]=[]);var o=this._pipelines[t][r];if(!o){var a=`#version 450\r
`;e===zr.InvertYPremultiplyAlpha&&(i.invertY&&(a+=`#define INVERTY\r
`),i.premultiplyAlpha&&(a+=`define PREMULTIPLYALPHA\r
`));var s=this._compiledShaders[r];if(!s){var c=this._device.createShaderModule({code:this._glslang.compileGLSL(a+Gl[e].vertex,"vertex")}),v=this._device.createShaderModule({code:this._glslang.compileGLSL(a+Gl[e].fragment,"fragment")});s=this._compiledShaders[r]=[c,v]}o=this._pipelines[t][r]=this._device.createRenderPipeline({vertexStage:{module:s[0],entryPoint:"main"},fragmentStage:{module:s[1],entryPoint:"main"},primitiveTopology:ki.TriangleStrip,vertexState:{indexFormat:Gr.Uint16},colorStates:[{format:t}]})}return o},n._GetTextureTypeFromFormat=function(t){switch(t){case Se.R8Unorm:case Se.R8Snorm:case Se.R8Uint:case Se.R8Sint:case Se.RG8Unorm:case Se.RG8Snorm:case Se.RG8Uint:case Se.RG8Sint:case Se.RGBA8Unorm:case Se.RGBA8UnormSRGB:case Se.RGBA8Snorm:case Se.RGBA8Uint:case Se.RGBA8Sint:case Se.BGRA8Unorm:case Se.BGRA8UnormSRGB:case Se.RGB10A2Unorm:case Se.RGB9E5UFloat:case Se.RG11B10UFloat:case Se.Depth24UnormStencil8:case Se.Depth32FloatStencil8:case Se.BC7RGBAUnorm:case Se.BC7RGBAUnormSRGB:case Se.BC6HRGBUFloat:case Se.BC6HRGBFloat:case Se.BC5RGUnorm:case Se.BC5RGSnorm:case Se.BC3RGBAUnorm:case Se.BC3RGBAUnormSRGB:case Se.BC2RGBAUnorm:case Se.BC2RGBAUnormSRGB:case Se.BC4RUnorm:case Se.BC4RSnorm:case Se.BC1RGBAUNorm:case Se.BC1RGBAUnormSRGB:return 0;case Se.R16Uint:case Se.R16Sint:case Se.RG16Uint:case Se.RG16Sint:case Se.RGBA16Uint:case Se.RGBA16Sint:case Se.Depth16Unorm:return 5;case Se.R16Float:case Se.RG16Float:case Se.RGBA16Float:return 2;case Se.R32Uint:case Se.R32Sint:case Se.RG32Uint:case Se.RG32Sint:case Se.RGBA32Uint:case Se.RGBA32Sint:return 7;case Se.R32Float:case Se.RG32Float:case Se.RGBA32Float:case Se.Depth32Float:return 1;case Se.Stencil8:throw"No fixed size for Stencil8 format!";case Se.Depth24Plus:throw"No fixed size for Depth24Plus format!";case Se.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0},n._GetBlockInformationFromFormat=function(t){switch(t){case Se.R8Unorm:case Se.R8Snorm:case Se.R8Uint:case Se.R8Sint:return{width:1,height:1,length:1};case Se.R16Uint:case Se.R16Sint:case Se.R16Float:case Se.RG8Unorm:case Se.RG8Snorm:case Se.RG8Uint:case Se.RG8Sint:return{width:1,height:1,length:2};case Se.R32Uint:case Se.R32Sint:case Se.R32Float:case Se.RG16Uint:case Se.RG16Sint:case Se.RG16Float:case Se.RGBA8Unorm:case Se.RGBA8UnormSRGB:case Se.RGBA8Snorm:case Se.RGBA8Uint:case Se.RGBA8Sint:case Se.BGRA8Unorm:case Se.BGRA8UnormSRGB:case Se.RGB9E5UFloat:case Se.RGB10A2Unorm:case Se.RG11B10UFloat:return{width:1,height:1,length:4};case Se.RG32Uint:case Se.RG32Sint:case Se.RG32Float:case Se.RGBA16Uint:case Se.RGBA16Sint:case Se.RGBA16Float:return{width:1,height:1,length:8};case Se.RGBA32Uint:case Se.RGBA32Sint:case Se.RGBA32Float:return{width:1,height:1,length:16};case Se.Stencil8:throw"No fixed size for Stencil8 format!";case Se.Depth16Unorm:return{width:1,height:1,length:2};case Se.Depth24Plus:throw"No fixed size for Depth24Plus format!";case Se.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case Se.Depth32Float:return{width:1,height:1,length:4};case Se.Depth24UnormStencil8:return{width:1,height:1,length:4};case Se.Depth32FloatStencil8:return{width:1,height:1,length:5};case Se.BC7RGBAUnorm:case Se.BC7RGBAUnormSRGB:case Se.BC6HRGBUFloat:case Se.BC6HRGBFloat:case Se.BC5RGUnorm:case Se.BC5RGSnorm:case Se.BC3RGBAUnorm:case Se.BC3RGBAUnormSRGB:case Se.BC2RGBAUnorm:case Se.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case Se.BC4RUnorm:case Se.BC4RSnorm:case Se.BC1RGBAUNorm:case Se.BC1RGBAUnormSRGB:return{width:4,height:4,length:8}}return{width:1,height:1,length:4}},n._IsHardwareTexture=function(t){return!!t.release},n._IsInternalTexture=function(t){return!!t.dispose},n.GetCompareFunction=function(t){switch(t){case 519:return ti.Always;case 514:return ti.Equal;case 516:return ti.Greater;case 518:return ti.GreaterEqual;case 513:return ti.Less;case 515:return ti.LessEqual;case 512:return ti.Never;case 517:return ti.NotEqual;default:return ti.Less}},n.IsImageBitmap=function(t){return t.close!==void 0},n.IsImageBitmapArray=function(t){return Array.isArray(t)&&t[0].close!==void 0},n.prototype.setCommandEncoder=function(t){this._commandEncoderForCreation=t},n.IsCompressedFormat=function(t){switch(t){case Se.BC7RGBAUnormSRGB:case Se.BC7RGBAUnorm:case Se.BC6HRGBFloat:case Se.BC6HRGBUFloat:case Se.BC5RGSnorm:case Se.BC5RGUnorm:case Se.BC4RSnorm:case Se.BC4RUnorm:case Se.BC3RGBAUnormSRGB:case Se.BC3RGBAUnorm:case Se.BC2RGBAUnormSRGB:case Se.BC2RGBAUnorm:case Se.BC1RGBAUnormSRGB:case Se.BC1RGBAUNorm:return!0}return!1},n.GetWebGPUTextureFormat=function(t,e){switch(e){case 13:return Se.Depth24PlusStencil8;case 14:return Se.Depth32Float;case 36492:return Se.BC7RGBAUnorm;case 36495:return Se.BC6HRGBUFloat;case 36494:return Se.BC6HRGBFloat;case 33779:return Se.BC3RGBAUnorm;case 33778:return Se.BC2RGBAUnorm;case 33777:return Se.BC1RGBAUNorm}switch(t){case 3:switch(e){case 6:return Se.R8Snorm;case 7:return Se.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return Se.R8Sint;case 9:return Se.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return Se.RGBA8Sint;default:return Se.RGBA8Snorm}case 0:switch(e){case 6:return Se.R8Unorm;case 7:return Se.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return Se.RGBA8Unorm;case 12:return Se.BGRA8Unorm;case 8:return Se.R8Uint;case 9:return Se.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return Se.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return Se.RGBA8Unorm}case 4:switch(e){case 8:return Se.R16Sint;case 9:return Se.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return Se.RGBA16Sint;default:return Se.RGBA16Sint}case 5:switch(e){case 8:return Se.R16Uint;case 9:return Se.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return Se.RGBA16Uint;default:return Se.RGBA16Uint}case 6:switch(e){case 8:return Se.R32Sint;case 9:return Se.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return Se.RGBA32Sint;default:return Se.RGBA32Sint}case 7:switch(e){case 8:return Se.R32Uint;case 9:return Se.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return Se.RGBA32Uint;default:return Se.RGBA32Uint}case 1:switch(e){case 6:return Se.R32Float;case 7:return Se.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return Se.RGBA32Float;default:return Se.RGBA32Float}case 2:switch(e){case 6:return Se.R16Float;case 7:return Se.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return Se.RGBA16Float;default:return Se.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(e){case 5:return Se.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV";default:return Se.RGB10A2Unorm}}return Se.RGBA8Unorm},n.prototype.invertYPreMultiplyAlpha=function(t,e,i,r,o,a,s,c){o===void 0&&(o=!1),a===void 0&&(a=!1),s===void 0&&(s=0);var v=c===void 0,b=this._getPipeline(r,zr.InvertYPremultiplyAlpha,{invertY:o,premultiplyAlpha:a}),C=b.getBindGroupLayout(0);v&&(c=this._device.createCommandEncoder({})),c.pushDebugGroup("internal process texture - invertY="+o+" premultiplyAlpha="+a);var M=this.createTexture({width:e,height:i,layers:1},!1,!1,!1,!1,!1,r,1,c,ei.CopySrc|ei.OutputAttachment|ei.Sampled),N=c.beginRenderPass({colorAttachments:[{attachment:M.createView({dimension:Oi.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadValue:Gi.Load}]}),D=this._device.createBindGroup({layout:C,entries:[{binding:0,resource:this._invertYPreMultiplyAlphaSampler},{binding:1,resource:t.createView({dimension:Oi.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s})}]});N.setPipeline(b),N.setBindGroup(0,D),N.draw(4,1,0,0),N.endPass(),c.copyTextureToTexture({texture:M},{texture:t,origin:{x:0,y:0,z:Math.max(s,0)}},{width:e,height:i,depth:1}),this._deferredReleaseTextures.push([M,null,null]),c.popDebugGroup(),v&&(this._device.defaultQueue.submit([c.finish()]),c=null)},n.prototype.clear=function(t,e,i){var r=this._getPipeline(t,zr.Clear),o=r.getBindGroupLayout(0),a=this._bufferManager.createRawBuffer(4*4,Fi.CopySrc|Fi.Uniform,!0),s=this._device.createBindGroup({layout:o,entries:[{binding:0,resource:{buffer:a}}]});i.setPipeline(r),i.setBindGroup(0,s),i.draw(4,1,0,0),this._bufferManager.releaseBuffer(a)},n.prototype.createTexture=function(t,e,i,r,o,a,s,c,v,b){e===void 0&&(e=!1),i===void 0&&(i=!1),r===void 0&&(r=!1),o===void 0&&(o=!1),a===void 0&&(a=!1),s===void 0&&(s=Se.RGBA8Unorm),c===void 0&&(c=1),b===void 0&&(b=-1),c>1&&(c=4);var C=t.layers||1,M={width:t.width,height:t.height,depth:C},N=e?n.ComputeNumMipmapLevels(t.width,t.height):1,D=b>=0?b:ei.CopySrc|ei.CopyDst|ei.Sampled,V=e&&!n.IsCompressedFormat(s)?ei.CopySrc|ei.OutputAttachment:0,X=this._device.createTexture({size:M,dimension:a?Vr.E3d:Vr.E2d,format:s,usage:D|V,sampleCount:c,mipLevelCount:N});return n.IsImageBitmap(t)&&(this.updateTexture(t,X,t.width,t.height,C,s,0,0,r,o,0,0,v),e&&i&&this.generateMipmaps(X,s,N,0,v)),X},n.prototype.createCubeTexture=function(t,e,i,r,o,a,s,c,v){e===void 0&&(e=!1),i===void 0&&(i=!1),r===void 0&&(r=!1),o===void 0&&(o=!1),a===void 0&&(a=Se.RGBA8Unorm),s===void 0&&(s=1),v===void 0&&(v=-1),s>1&&(s=4);var b=n.IsImageBitmapArray(t)?t[0].width:t.width,C=n.IsImageBitmapArray(t)?t[0].height:t.height,M=e?n.ComputeNumMipmapLevels(b,C):1,N=v>=0?v:ei.CopySrc|ei.CopyDst|ei.Sampled,D=e&&!n.IsCompressedFormat(a)?ei.CopySrc|ei.OutputAttachment:0,V=this._device.createTexture({size:{width:b,height:C,depth:6},dimension:Vr.E2d,format:a,usage:N|D,sampleCount:s,mipLevelCount:M});return n.IsImageBitmapArray(t)&&(this.updateCubeTextures(t,V,b,C,a,r,o,0,0,c),e&&i&&this.generateCubeMipmaps(V,a,M,c)),V},n.prototype.generateCubeMipmaps=function(t,e,i,r){var o=r===void 0;o&&(r=this._device.createCommandEncoder({})),r.pushDebugGroup("create cube mipmaps - "+i+" levels");for(var a=0;a<6;++a)this.generateMipmaps(t,e,i,a,r);r.popDebugGroup(),o&&(this._device.defaultQueue.submit([r.finish()]),r=null)},n.prototype.generateMipmaps=function(t,e,i,r,o){r===void 0&&(r=0);var a=o===void 0,s=this._getPipeline(e),c=s.getBindGroupLayout(0);a&&(o=this._device.createCommandEncoder({})),o.pushDebugGroup("create mipmaps for face #"+r+" - "+i+" levels");for(var v=1;v<i;++v){var b=o.beginRenderPass({colorAttachments:[{attachment:t.createView({dimension:Oi.E2d,baseMipLevel:v,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadValue:Gi.Load}]}),C=this._device.createBindGroup({layout:c,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:t.createView({dimension:Oi.E2d,baseMipLevel:v-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})}]});b.setPipeline(s),b.setBindGroup(0,C),b.draw(4,1,0,0),b.endPass()}o.popDebugGroup(),a&&(this._device.defaultQueue.submit([o.finish()]),o=null)},n.prototype.createGPUTextureForInternalTexture=function(t,e,i,r){t._hardwareTexture||(t._hardwareTexture=new rs),e===void 0&&(e=t.width),i===void 0&&(i=t.height),r===void 0&&(r=t.depth);var o=t._hardwareTexture;o.format=n.GetWebGPUTextureFormat(t.type,t.format),o.textureUsages=t._source===gt.b.RenderTarget||t.source===gt.b.MultiRenderTarget?ei.Sampled|ei.CopySrc|ei.OutputAttachment:t._source===gt.b.Depth?ei.Sampled|ei.OutputAttachment:-1;var a=t.generateMipMaps,s=r||1;if(t.isCube){var c=this.createCubeTexture({width:e,height:i},t.generateMipMaps,t.generateMipMaps,t.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages);o.set(c),o.createView({dimension:Oi.Cube,mipLevelCount:a?n.ComputeNumMipmapLevels(e,i):1,baseArrayLayer:0,baseMipLevel:0,aspect:qr.All})}else{var c=this.createTexture({width:e,height:i,layers:s},t.generateMipMaps,t.generateMipMaps,t.invertY,!1,t.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages);o.set(c),o.createView({dimension:t.is2DArray?Oi.E2dArray:t.is3D?Vr.E3d:Oi.E2d,mipLevelCount:a?n.ComputeNumMipmapLevels(e,i):1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:s,aspect:qr.All})}return t.width=t.baseWidth=e,t.height=t.baseHeight=i,t.depth=t.baseDepth=r,this.createMSAATexture(t,t.samples),o},n.prototype.createMSAATexture=function(t,e){var i=t._hardwareTexture;if((i==null?void 0:i.msaaTexture)&&(this.releaseTexture(i.msaaTexture),i.msaaTexture=null),!(!i||(e!=null?e:1)<=1)){var r=t.width,o=t.height,a=t.depth||1;if(t.isCube){var s=this.createCubeTexture({width:r,height:o},!1,!1,t.invertY,!1,i.format,e,this._commandEncoderForCreation,i.textureUsages);i.setMSAATexture(s)}else{var s=this.createTexture({width:r,height:o,layers:a},!1,!1,t.invertY,!1,t.is3D,i.format,e,this._commandEncoderForCreation,i.textureUsages);i.setMSAATexture(s)}}},n.prototype.updateCubeTextures=function(t,e,i,r,o,a,s,c,v,b){a===void 0&&(a=!1),s===void 0&&(s=!1),c===void 0&&(c=0),v===void 0&&(v=0);for(var C=[0,3,1,4,2,5],M=0;M<C.length;++M){var N=t[C[M]];this.updateTexture(N,e,i,r,1,o,M,0,a,s,c,v,b)}},n.prototype.updateTexture=function(t,e,i,r,o,a,s,c,v,b,C,M,N){var D=this;s===void 0&&(s=0),c===void 0&&(c=0),v===void 0&&(v=!1),b===void 0&&(b=!1),C===void 0&&(C=0),M===void 0&&(M=0);var V=n._GetBlockInformationFromFormat(a),X={texture:e,origin:{x:C,y:M,z:Math.max(s,0)},mipLevel:c},ee={width:Math.ceil(i/V.width)*V.width,height:Math.ceil(r/V.height)*V.height,depth:o||1};if(t.byteLength!==void 0){t=t;var ie=Math.ceil(i/V.width)*V.length,ge=Math.ceil(ie/256)*256===ie;if(ge){var pe=N===void 0;pe&&(N=this._device.createCommandEncoder({}));var te=this._bufferManager.createRawBuffer(t.byteLength,Fi.MapWrite|Fi.CopySrc,!0),Ce=te.getMappedRange();new Uint8Array(Ce).set(t),te.unmap(),N.copyBufferToTexture({buffer:te,offset:0,bytesPerRow:ie,rowsPerImage:r},X,ee),pe&&(this._device.defaultQueue.submit([N.finish()]),N=null),this._bufferManager.releaseBuffer(te)}else this._device.defaultQueue.writeTexture(X,t,{offset:0,bytesPerRow:ie,rowsPerImage:r},ee);(v||b)&&this.invertYPreMultiplyAlpha(e,i,r,a,v,b,s,N)}else t=t,v||b?createImageBitmap(t,{imageOrientation:v?"flipY":"none",premultiplyAlpha:b?"premultiply":"none"}).then(function(Ae){D._device.defaultQueue.copyImageBitmapToTexture({imageBitmap:Ae},X,ee)}):this._device.defaultQueue.copyImageBitmapToTexture({imageBitmap:t},X,ee)},n.prototype.readPixels=function(t,e,i,r,o,a,s,c,v){s===void 0&&(s=0),c===void 0&&(c=0),v===void 0&&(v=null);var b=n._GetBlockInformationFromFormat(a),C=Math.ceil(r/b.width)*b.length,M=Math.ceil(C/256)*256,N=M*o,D=this._bufferManager.createRawBuffer(N,Fi.MapRead|Fi.CopyDst),V=this._device.createCommandEncoder({});V.copyTextureToBuffer({texture:t,mipLevel:c,origin:{x:e,y:i,z:Math.max(s,0)}},{buffer:D,offset:0,bytesPerRow:M},{width:r,height:o,depth:1}),this._device.defaultQueue.submit([V.finish()]);var X=n._GetTextureTypeFromFormat(a),ee=X===1?2:X===2?1:0;return this._bufferManager.readDataFromBuffer(D,N,r,o,C,M,ee,0,v)},n.prototype.releaseTexture=function(t){if(n._IsInternalTexture(t)){var e=t._hardwareTexture,i=t._irradianceTexture,r=t._depthStencilTexture;this._deferredReleaseTextures.push([e,i,r])}else this._deferredReleaseTextures.push([t,null,null])},n.prototype.destroyDeferredTextures=function(){for(var t=0;t<this._deferredReleaseTextures.length;++t){var e=this._deferredReleaseTextures[t],i=e[0],r=e[1],o=e[2];i&&(n._IsHardwareTexture(i)?i.release():i.destroy()),r==null||r.dispose(),o==null||o.dispose()}this._deferredReleaseTextures.length=0},n}(),ns=u(563),zl=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this)||this;return i._buffer=e,i}return Object.defineProperty(t.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),t}(ns.a),zp=function(){function n(t){this._deferredReleaseBuffers=[],this._device=t}return n._IsGPUBuffer=function(t){return t.underlyingResource===void 0},n.prototype.createRawBuffer=function(t,e,i){i===void 0&&(i=!1);var r=t.byteLength!==void 0?t.byteLength+3&~3:t+3&~3,o={mappedAtCreation:i,size:r,usage:e};return this._device.createBuffer(o)},n.prototype.createBuffer=function(t,e){var i=t.byteLength!==void 0,r=this.createRawBuffer(t,e),o=new zl(r);return o.references=1,o.capacity=i?t.byteLength:t,i&&this.setSubData(o,0,t),o},n.prototype.setSubData=function(t,e,i,r,o){r===void 0&&(r=0),o===void 0&&(o=0);var a=t.underlyingResource;o=o||i.byteLength,o=Math.min(o,t.capacity-e);var s=i.byteOffset+r,c=s+o,v=o+3&~3;if(v!==o){var b=new Uint8Array(i.buffer.slice(s,c));i=new Uint8Array(v),i.set(b),r=0,s=0,c=v,o=v}for(var C=1024*1024*15,M=0;c-(s+M)>C;)this._device.defaultQueue.writeBuffer(a,e+M,i.buffer,s+M,C),M+=C;this._device.defaultQueue.writeBuffer(a,e+M,i.buffer,s+M,o-M)},n.prototype._FromHalfFloat=function(t){var e=(t&32768)>>15,i=(t&31744)>>10,r=t&1023;return i===0?(e?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):i==31?r?NaN:(e?-1:1)*Infinity:(e?-1:1)*Math.pow(2,i-15)*(1+r/Math.pow(2,10))},n.prototype._GetHalfFloatAsFloatRGBAArrayBuffer=function(t,e,i){i||(i=new Float32Array(t));for(var r=new Uint16Array(e);t--;)i[t]=this._FromHalfFloat(r[t]);return i},n.prototype.readDataFromBuffer=function(t,e,i,r,o,a,s,c,v,b){var C=this;return s===void 0&&(s=0),c===void 0&&(c=0),v===void 0&&(v=null),b===void 0&&(b=!0),new Promise(function(M,N){t.mapAsync(Vo.Read,c,e).then(function(){var D=t.getMappedRange(c,e),V=v;if(V===null)switch(s){case 0:V=new Uint8Array(e),V.set(new Uint8Array(D));break;case 1:V=C._GetHalfFloatAsFloatRGBAArrayBuffer(e/2,D);break;case 2:V=new Float32Array(e/4),V.set(new Float32Array(D));break}else switch(s){case 0:V=new Uint8Array(V.buffer),V.set(new Uint8Array(D));break;case 1:V=C._GetHalfFloatAsFloatRGBAArrayBuffer(e/2,D,v);break;case 2:V=new Float32Array(V.buffer),V.set(new Float32Array(D));break}if(o!==a){s===1&&(o*=2,a*=2);for(var X=new Uint8Array(V.buffer),ee=o,ie=0,ge=1;ge<r;++ge){ie=ge*a;for(var pe=0;pe<o;++pe)X[ee++]=X[ie++]}s!==0?V=new Float32Array(X.buffer,0,ee/4):V=new Uint8Array(X.buffer,0,ee)}t.unmap(),b&&C.releaseBuffer(t),M(V)},function(D){return N(D)})})},n.prototype.releaseBuffer=function(t){return n._IsGPUBuffer(t)?(this._deferredReleaseBuffers.push(t),!0):(t.references--,t.references===0?(this._deferredReleaseBuffers.push(t.underlyingResource),!0):!1)},n.prototype.destroyDeferredBuffers=function(){for(var t=0;t<this._deferredReleaseBuffers.length;++t)this._deferredReleaseBuffers[t].destroy();this._deferredReleaseBuffers.length=0},n}(),jl=function(){function n(){this.colorAttachmentGPUTextures=[],this.reset()}return n.prototype.reset=function(t){t===void 0&&(t=!1),this.renderPass=null,t&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)},n}(),jp=[0|0<<1|0<<2,0|0<<1|0<<2,1|1<<1|0<<2,1|1<<1|1<<2,0|0<<1|0<<2,0|1<<1|0<<2,0|1<<1|1<<2,0|1<<1|0<<2,0|0<<1|1<<2,1|0<<1|0<<2,1|0<<1|1<<2,1|1<<1|0<<2,1|0<<1|0<<2],Wp=[0<<3|0<<4|0<<5|0<<6,0<<3|0<<4|0<<5|1<<6,0<<3|0<<4|1<<5|0<<6,0<<3|0<<4|1<<5|1<<6,0<<3|1<<4|0<<5|0<<6,0<<3|1<<4|0<<5|1<<6,0<<3|1<<4|1<<5|0<<6,0<<3|1<<4|1<<5|1<<6,1<<3|0<<4|0<<5|0<<6],Hp=[0<<7,1<<7,1<<7,0<<7,0<<7,0<<7,0<<7,1<<7,0<<7,0<<7,0<<7,0<<7,1<<7],kp=function(){function n(t){this._samplers={},this._device=t,this.disabled=!1}return n._GetSamplerHashCode=function(t){var e,i,r,o,a=jp[t.samplingMode]+Wp[(t._comparisonFunction||514)-512+1]+Hp[t.samplingMode]+(((e=t._cachedWrapU)!==null&&e!==void 0?e:1)<<8)+(((i=t._cachedWrapV)!==null&&i!==void 0?i:1)<<10)+(((r=t._cachedWrapR)!==null&&r!==void 0?r:1)<<12)+((t.generateMipMaps?1:0)<<14)+(((o=t._cachedAnisotropicFilteringLevel)!==null&&o!==void 0?o:1)<<15);return a},n._GetSamplerFilterDescriptor=function(t,e){var i,r,o,a,s,c=t.generateMipMaps;switch(t.samplingMode){case 11:i=_t.Linear,r=_t.Linear,o=_t.Nearest,c||(a=s=0);break;case 3:case 3:i=_t.Linear,r=_t.Linear,c?o=_t.Linear:(o=_t.Nearest,a=s=0);break;case 8:i=_t.Nearest,r=_t.Nearest,c?o=_t.Linear:(o=_t.Nearest,a=s=0);break;case 4:i=_t.Nearest,r=_t.Nearest,o=_t.Nearest,c||(a=s=0);break;case 5:i=_t.Nearest,r=_t.Linear,o=_t.Nearest,c||(a=s=0);break;case 6:i=_t.Nearest,r=_t.Linear,c?o=_t.Linear:(o=_t.Nearest,a=s=0);break;case 7:i=_t.Nearest,r=_t.Linear,o=_t.Nearest,a=s=0;break;case 1:case 1:i=_t.Nearest,r=_t.Nearest,o=_t.Nearest,a=s=0;break;case 9:i=_t.Linear,r=_t.Nearest,o=_t.Nearest,c||(a=s=0);break;case 10:i=_t.Linear,r=_t.Nearest,c?o=_t.Linear:(o=_t.Nearest,a=s=0);break;case 2:case 2:i=_t.Linear,r=_t.Linear,o=_t.Nearest,a=s=0;break;case 12:i=_t.Linear,r=_t.Nearest,o=_t.Nearest,a=s=0;break;default:i=_t.Nearest,r=_t.Nearest,o=_t.Nearest,a=s=0;break}return e>1&&(a!==0||s!==0)?{magFilter:_t.Linear,minFilter:_t.Linear,mipmapFilter:_t.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:o,lodMinClamp:a,lodMaxClamp:s}},n._GetWrappingMode=function(t){switch(t){case 1:return hn.Repeat;case 0:return hn.ClampToEdge;case 2:return hn.MirrorRepeat}return hn.Repeat},n._GetSamplerWrappingDescriptor=function(t){return{addressModeU:this._GetWrappingMode(t._cachedWrapU),addressModeV:this._GetWrappingMode(t._cachedWrapV),addressModeW:this._GetWrappingMode(t._cachedWrapR)}},n._GetSamplerDescriptor=function(t){var e,i=t.generateMipMaps&&(e=t._cachedAnisotropicFilteringLevel)!==null&&e!==void 0?e:1,r=this._GetSamplerFilterDescriptor(t,i);return Object(h.a)(Object(h.a)(Object(h.a)({},r),this._GetSamplerWrappingDescriptor(t)),{compare:t._comparisonFunction?so.GetCompareFunction(t._comparisonFunction):void 0,maxAnisotropy:r.anisotropyEnabled?i:1})},n.prototype.getSampler=function(t,e){if(e===void 0&&(e=!1),this.disabled)return this._device.createSampler(n._GetSamplerDescriptor(t));var i=e?0:n._GetSamplerHashCode(t),r=e?void 0:this._samplers[i];return r||(r=this._device.createSampler(n._GetSamplerDescriptor(t)),e||(this._samplers[i]=r)),r},n}(),Xp=function(){function n(t){this._shaders={},this._device=t}return n.prototype.getCompiledShaders=function(t){var e=this._shaders[t];return e||(e=this._shaders[t]={vertexStage:{module:this._device.createShaderModule({code:qe.a.ShadersStore[t+"VertexShader"]}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:qe.a.ShadersStore[t+"PixelShader"]}),entryPoint:"main"}}),e},n}(),ci;(function(n){n[n.StencilReadMask=0]="StencilReadMask",n[n.StencilWriteMask=1]="StencilWriteMask",n[n.DepthBiasSlopeScale=2]="DepthBiasSlopeScale",n[n.MRTAttachments1=3]="MRTAttachments1",n[n.MRTAttachments2=4]="MRTAttachments2",n[n.DepthStencilState=5]="DepthStencilState",n[n.RasterizationState=6]="RasterizationState",n[n.ColorStates=7]="ColorStates",n[n.ShaderStage=8]="ShaderStage",n[n.VertexState=9]="VertexState",n[n.NumStates=10]="NumStates"})(ci||(ci={}));var os={"":0,r8unorm:1,r8snorm:2,r8uint:3,r8sint:4,r16uint:5,r16sint:6,r16float:7,rg8unorm:8,rg8snorm:9,rg8uint:10,rg8sint:11,r32uint:12,r32sint:13,r32float:14,rg16uint:15,rg16sint:16,rg16float:17,rgba8unorm:18,"rgba8unorm-srgb":19,rgba8snorm:20,rgba8uint:21,rgba8sint:22,bgra8unorm:23,"bgra8unorm-srgb":24,rgb9e5ufloat:25,rgb10a2unorm:26,rg11b10ufloat:27,rg32uint:28,rg32sint:29,rg32float:30,rgba16uint:31,rgba16sint:32,rgba16float:33,rgba32uint:34,rgba32sint:35,rgba32float:36,stencil8:37,depth16unorm:38,depth24plus:39,"depth24plus-stencil8":40,depth32float:41,"bc1-rgba-unorm":42,"bc1-rgba-unorm-srgb":43,"bc2-rgba-unorm":44,"bc2-rgba-unorm-srgb":45,"bc3-rgba-unorm":46,"bc3-rgba-unorm-srgb":47,"bc4-r-unorm":48,"bc4-r-snorm":49,"bc5-rg-unorm":50,"bc5-rg-snorm":51,"bc6h-rgb-ufloat":52,"bc6h-rgb-float":53,"bc7-rgba-unorm":54,"bc7-rgba-unorm-srgb":55,"depth24unorm-stencil8":56,"depth32float-stencil8":57},jo={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},Sn={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},Wl=function(){function n(t,e){this._device=t,this._states=[],this._states.length=ci.NumStates,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=e,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.reset()}return n.prototype.reset=function(){this._isDirty=!0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setColorFormat(Se.BGRA8Unorm),this.setMRTAttachments([],[]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(Se.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null)},n.prototype.getRenderPipeline=function(t,e,i){if(this.disabled){var r=n._GetTopology(t);return this._parameter.pipeline=this._createRenderPipeline(e,r,i),n.NumCacheMiss++,n._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(e.uniqueId),this._setRasterizationState(t,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(e),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._states.length,n.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._states.length,this._parameter.pipeline)return n.NumCacheHitWithHash++,this._parameter.pipeline;var o=n._GetTopology(t);return this._parameter.pipeline=this._createRenderPipeline(e,o,i),this._setRenderPipeline(this._parameter),n.NumCacheMiss++,n._NumPipelineCreationCurrentFrame++,this._parameter.pipeline},n.prototype.endFrame=function(){n.NumPipelineCreationLastFrame=n._NumPipelineCreationCurrentFrame,n._NumPipelineCreationCurrentFrame=0},n.prototype.setAlphaToCoverage=function(t){this._alphaToCoverageEnabled=t},n.prototype.setFrontFace=function(t){this._frontFace=t},n.prototype.setCullEnabled=function(t){this._cullEnabled=t},n.prototype.setCullFace=function(t){this._cullFace=t},n.prototype.setClampDepth=function(t){this._clampDepth=t},n.prototype.resetDepthCullingState=function(){this.setDepthCullingState(!1,2,1,0,!0,!0,519)},n.prototype.setDepthCullingState=function(t,e,i,r,o,a,s){this._depthWriteEnabled=a,this._depthTestEnabled=o,this._depthCompare=(s!=null?s:519)-512,this._cullFace=i,this._cullEnabled=t,this._frontFace=e,this.setDepthBiasSlopeScale(r)},n.prototype.setDepthBiasSlopeScale=function(t){this._depthBiasSlopeScale!==t&&(this._depthBiasSlopeScale=t,this._states[ci.DepthBiasSlopeScale]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.DepthBiasSlopeScale))},n.prototype.setColorFormat=function(t){this._webgpuColorFormat=t,this._colorFormat=os[t]},n.prototype.setMRTAttachments=function(t,e){var i;if(t.length>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";var r=[0,0],o=0,a=0;this._mrtFormats.length=t.length;for(var s=0;s<t.length;++s){var c=t[s],v=e[c-1],b=v==null?void 0:v._hardwareTexture;this._mrtFormats[s]=(i=b==null?void 0:b.format)!==null&&i!==void 0?i:this._webgpuColorFormat,r[o]+=os[this._mrtFormats[s]]<<a,a+=6,a>=32&&(a=0,o++)}(this._mrtAttachments1!==r[0]||this._mrtAttachments2!==r[1])&&(this._mrtAttachments1=r[0],this._mrtAttachments2=r[1],this._states[ci.MRTAttachments1]=r[0],this._states[ci.MRTAttachments2]=r[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.MRTAttachments1))},n.prototype.setAlphaBlendEnabled=function(t){this._alphaBlendEnabled=t},n.prototype.setAlphaBlendFactors=function(t,e){this._alphaBlendFuncParams=t,this._alphaBlendEqParams=e},n.prototype.setWriteMask=function(t){this._writeMask=t},n.prototype.setDepthStencilFormat=function(t){this._webgpuDepthStencilFormat=t,this._depthStencilFormat=t===void 0?0:os[t]},n.prototype.setDepthTestEnabled=function(t){this._depthTestEnabled=t},n.prototype.setDepthWriteEnabled=function(t){this._depthWriteEnabled=t},n.prototype.setDepthCompare=function(t){this._depthCompare=(t!=null?t:519)-512},n.prototype.setStencilEnabled=function(t){this._stencilEnabled=t},n.prototype.setStencilCompare=function(t){this._stencilFrontCompare=(t!=null?t:519)-512},n.prototype.setStencilDepthFailOp=function(t){this._stencilFrontDepthFailOp=t===null?1:Sn[t]},n.prototype.setStencilPassOp=function(t){this._stencilFrontPassOp=t===null?2:Sn[t]},n.prototype.setStencilFailOp=function(t){this._stencilFrontFailOp=t===null?1:Sn[t]},n.prototype.setStencilReadMask=function(t){this._stencilReadMask!==t&&(this._stencilReadMask=t,this._states[ci.StencilReadMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.StencilReadMask))},n.prototype.setStencilWriteMask=function(t){this._stencilWriteMask!==t&&(this._stencilWriteMask=t,this._states[ci.StencilWriteMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.StencilWriteMask))},n.prototype.resetStencilState=function(){this.setStencilState(!1,519,7680,7681,7680,255,255)},n.prototype.setStencilState=function(t,e,i,r,o,a,s){this._stencilEnabled=t,this._stencilFrontCompare=(e!=null?e:519)-512,this._stencilFrontDepthFailOp=i===null?1:Sn[i],this._stencilFrontPassOp=r===null?2:Sn[r],this._stencilFrontFailOp=o===null?1:Sn[o],this.setStencilReadMask(a),this.setStencilWriteMask(s)},n.prototype.setBuffers=function(t,e,i){this._vertexBuffers=t,this._overrideVertexBuffers=i,this._indexBuffer=e},n._GetTopology=function(t){switch(t){case 0:return ki.TriangleList;case 2:return ki.PointList;case 1:return ki.LineList;case 3:return ki.PointList;case 4:return ki.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return ki.LineStrip;case 7:return ki.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return ki.TriangleList}},n._GetAphaBlendOperation=function(t){switch(t){case 32774:return Ur.Add;case 32778:return Ur.Subtract;case 32779:return Ur.ReverseSubtract;case 32775:return Ur.Min;case 32776:return Ur.Max;default:return Ur.Add}},n._GetAphaBlendFactor=function(t){switch(t){case 0:return Si.Zero;case 1:return Si.One;case 768:return Si.SrcColor;case 769:return Si.OneMinusSrcColor;case 770:return Si.SrcAlpha;case 771:return Si.OneMinusSrcAlpha;case 772:return Si.DstAlpha;case 773:return Si.OneMinusDstAlpha;case 774:return Si.DstColor;case 775:return Si.OneMinusDstColor;case 776:return Si.SrcAlphaSaturated;case 32769:return Si.BlendColor;case 32770:return Si.OneMinusBlendColor;case 32771:return Si.BlendColor;case 32772:return Si.OneMinusBlendColor;default:return Si.One}},n._GetCompareFunction=function(t){switch(t){case 0:return ti.Never;case 1:return ti.Less;case 2:return ti.Equal;case 3:return ti.LessEqual;case 4:return ti.Greater;case 5:return ti.NotEqual;case 6:return ti.GreaterEqual;case 7:return ti.Always}return ti.Never},n._GetStencilOpFunction=function(t){switch(t){case 0:return ir.Zero;case 1:return ir.Keep;case 2:return ir.Replace;case 3:return ir.IncrementClamp;case 4:return ir.DecrementClamp;case 5:return ir.Invert;case 6:return ir.IncrementWrap;case 7:return ir.DecrementWrap}return ir.Keep},n._GetVertexInputDescriptorFormat=function(t){var e=t.type,i=t.normalized,r=t.getSize();switch(e){case Oe.b.BYTE:switch(r){case 1:case 2:return i?zt.Char2Norm:zt.Char2;case 3:case 4:return i?zt.Char4Norm:zt.Char4}break;case Oe.b.UNSIGNED_BYTE:switch(r){case 1:case 2:return i?zt.Uchar2Norm:zt.Uchar2;case 3:case 4:return i?zt.Uchar4Norm:zt.Uchar4}break;case Oe.b.SHORT:switch(r){case 1:case 2:return i?zt.Short2Norm:zt.Short2;case 3:case 4:return i?zt.Short4Norm:zt.Short4}break;case Oe.b.UNSIGNED_SHORT:switch(r){case 1:case 2:return i?zt.Ushort2Norm:zt.Ushort2;case 3:case 4:return i?zt.Ushort4Norm:zt.Ushort4}break;case Oe.b.INT:switch(r){case 1:return zt.Int;case 2:return zt.Int2;case 3:return zt.Int3;case 4:return zt.Int4}break;case Oe.b.UNSIGNED_INT:switch(r){case 1:return zt.Uint;case 2:return zt.Uint2;case 3:return zt.Uint3;case 4:return zt.Uint4}break;case Oe.b.FLOAT:switch(r){case 1:return zt.Float;case 2:return zt.Float2;case 3:return zt.Float3;case 4:return zt.Float4}break}throw new Error("Invalid Format '"+t.getKind()+"' - type="+e+", normalized="+i+", size="+r)},n.prototype._getAphaBlendState=function(){return this._alphaBlendEnabled?{srcFactor:n._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:n._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:n._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:{}},n.prototype._getColorBlendState=function(){return this._alphaBlendEnabled?{srcFactor:n._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:n._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:n._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:{}},n.prototype._setShaderStage=function(t){this._shaderId!==t&&(this._shaderId=t,this._states[ci.ShaderStage]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.ShaderStage))},n.prototype._setRasterizationState=function(t,e){var i=this._frontFace,r=this._cullEnabled?this._cullFace:0,o=this._clampDepth?1:0,a=this._alphaToCoverageEnabled?1:0,s=i-1+(r<<1)+(o<<3)+(a<<4)+(t<<5)+(e<<8);this._rasterizationState!==s&&(this._rasterizationState=s,this._states[ci.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.RasterizationState))},n.prototype._setColorStates=function(){var t=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(t+=((this._alphaBlendFuncParams[0]===null?2:jo[this._alphaBlendFuncParams[0]])<<0)+((this._alphaBlendFuncParams[1]===null?2:jo[this._alphaBlendFuncParams[1]])<<4)+((this._alphaBlendFuncParams[2]===null?2:jo[this._alphaBlendFuncParams[2]])<<8)+((this._alphaBlendFuncParams[3]===null?2:jo[this._alphaBlendFuncParams[3]])<<12)+((this._alphaBlendEqParams[0]===null?1:this._alphaBlendEqParams[0]-32773)<<16)+((this._alphaBlendEqParams[1]===null?1:this._alphaBlendEqParams[1]-32773)<<19)),t!==this._colorStates&&(this._colorStates=t,this._states[ci.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.ColorStates))},n.prototype._setDepthStencilState=function(){var t=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):7+(1<<3)+(1<<6)+(1<<9),e=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(t<<10);this._depthStencilState!==e&&(this._depthStencilState=e,this._states[ci.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.DepthStencilState))},n.prototype._setVertexState=function(t){for(var e,i=this._states.length,r=ci.VertexState,o=t._pipelineContext,a=o.shaderProcessingContext.attributeNamesFromEffect,s=o.shaderProcessingContext.attributeLocationsFromEffect,c=0;c<a.length;c++){var v=s[c],b=(e=this._overrideVertexBuffers&&this._overrideVertexBuffers[a[c]])!==null&&e!==void 0?e:this._vertexBuffers[a[c]];b||(b=this._emptyVertexBuffer);var C=b.hashCode+(v<<7);this._isDirty=this._isDirty||this._states[r]!==C,this._states[r++]=C}this._states.length=r,this._isDirty=this._isDirty||r!==i,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.VertexState))},n.prototype._createPipelineLayout=function(t){for(var e=[],i=0;i<t.shaderProcessingContext.orderedUBOsAndSamplers.length;i++){var r=t.shaderProcessingContext.orderedUBOsAndSamplers[i];if(r===void 0){var o=[],a=this._device.createBindGroupLayout({entries:o});e[i]=a;continue}for(var s=[],c=0;c<r.length;c++){var v=t.shaderProcessingContext.orderedUBOsAndSamplers[i][c];if(v!==void 0){var b=0;v.usedInVertex&&(b=b|ro.Vertex),v.usedInFragment&&(b=b|ro.Fragment);var C={binding:c,visibility:b};s.push(C),v.isSampler?C.sampler={type:v.isComparisonSampler?no.Comparison:no.Filtering}:v.isTexture?C.texture={sampleType:v.sampleType,viewDimension:v.textureDimension,multisampled:!1}:C.buffer={type:Uo.Uniform}}}if(s.length>0){var a=this._device.createBindGroupLayout({entries:s});e[i]=a}}return t.bindGroupLayouts=e,this._device.createPipelineLayout({bindGroupLayouts:e})},n.prototype._getVertexInputDescriptor=function(t,e){for(var i,r=[],o=t._pipelineContext,a=o.shaderProcessingContext.attributeNamesFromEffect,s=o.shaderProcessingContext.attributeLocationsFromEffect,c=0;c<a.length;c++){var v=s[c],b=(i=this._overrideVertexBuffers&&this._overrideVertexBuffers[a[c]])!==null&&i!==void 0?i:this._vertexBuffers[a[c]];b||(b=this._emptyVertexBuffer);var C={shaderLocation:v,offset:0,format:n._GetVertexInputDescriptorFormat(b)},M={arrayStride:b.byteStride,stepMode:b.getIsInstanced()?ao.Instance:ao.Vertex,attributes:[C]};r.push(M)}var N={vertexBuffers:r};return(e===ki.LineStrip||e===ki.TriangleStrip)&&(N.indexFormat=!this._indexBuffer||this._indexBuffer.is32Bits?Gr.Uint32:Gr.Uint16),N},n.prototype._createRenderPipeline=function(t,e,i,r){r===void 0&&(r=!0);var o=t._pipelineContext,a=this._getVertexInputDescriptor(t,e),s=r?this._createPipelineLayout(o):void 0,c=[],v=this._getAphaBlendState(),b=this._getColorBlendState();if(this._mrtAttachments1>0)for(var C=0;C<this._mrtFormats.length;++C)c.push({format:this._mrtFormats[C],alphaBlend:v,colorBlend:b,writeMask:this._writeMask});else c.push({format:this._webgpuColorFormat,alphaBlend:v,colorBlend:b,writeMask:this._writeMask});var M={compare:n._GetCompareFunction(this._stencilFrontCompare),depthFailOp:n._GetStencilOpFunction(this._stencilFrontDepthFailOp),failOp:n._GetStencilOpFunction(this._stencilFrontFailOp),passOp:n._GetStencilOpFunction(this._stencilFrontPassOp)};return this._device.createRenderPipeline(Object(h.a)(Object(h.a)({layout:s},o.stages),{primitiveTopology:e,rasterizationState:{frontFace:this._frontFace===1?oo.CCW:oo.CW,cullMode:this._cullEnabled?this._cullFace===2?Cn.Front:Cn.Back:Cn.None,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale},colorStates:c,sampleCount:i,depthStencilState:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?n._GetCompareFunction(this._depthCompare):ti.Always,format:this._webgpuDepthStencilFormat,stencilFront:M,stencilBack:M,stencilReadMask:this._stencilReadMask,stencilWriteMask:this._stencilWriteMask},vertexState:a}))},n.NumCacheHitWithoutHash=0,n.NumCacheHitWithHash=0,n.NumCacheMiss=0,n.NumPipelineCreationLastFrame=0,n._NumPipelineCreationCurrentFrame=0,n}(),Hl=function(){function n(){this.values={}}return n.prototype.count=function(){var t=0,e=this.pipeline?1:0;for(var i in this.values){var r=this.values[i],o=r.count(),a=o[0],s=o[1];t+=a,e+=s,t++}return[t,e]},n}(),kl=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r._nodeStack=[],r._nodeStack[0]=t._Cache,r}return t.GetNodeCounts=function(){var e=t._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}},t.prototype._getRenderPipeline=function(e){for(var i=this._nodeStack[this._stateDirtyLowestIndex],r=this._stateDirtyLowestIndex;r<this._states.length;++r){var o=i.values[this._states[r]];o||(o=new Hl,i.values[this._states[r]]=o),i=o,this._nodeStack[r+1]=i}e.token=i,e.pipeline=i.pipeline},t.prototype._setRenderPipeline=function(e){e.token.pipeline=e.pipeline},t._Cache=new Hl,t}(Wl),Xl=u(682),Yp=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,!1)||this;return i._cache=e,i.reset(),i}return Object.defineProperty(t.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(e){this._stencilFunc!==e&&(this._stencilFunc=e,this._isStencilFuncDirty=!0,this._cache.setStencilCompare(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(e){this._stencilFuncRef!==e&&(this._stencilFuncRef=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(e){this._stencilFuncMask!==e&&(this._stencilFuncMask=e,this._isStencilFuncDirty=!0,this._cache.setStencilReadMask(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(e){this._stencilOpStencilFail!==e&&(this._stencilOpStencilFail=e,this._isStencilOpDirty=!0,this._cache.setStencilFailOp(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(e){this._stencilOpDepthFail!==e&&(this._stencilOpDepthFail=e,this._isStencilOpDirty=!0,this._cache.setStencilDepthFailOp(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(e){this._stencilOpStencilDepthPass!==e&&(this._stencilOpStencilDepthPass=e,this._isStencilOpDirty=!0,this._cache.setStencilPassOp(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(e){this._stencilMask!==e&&(this._stencilMask=e,this._isStencilMaskDirty=!0,this._cache.setStencilWriteMask(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(e){this._stencilTest!==e&&(this._stencilTest=e,this._isStencilTestDirty=!0,this._cache.setStencilEnabled(e))},enumerable:!1,configurable:!0}),t.prototype.reset=function(){n.prototype.reset.call(this),this._cache.resetStencilState()},t.prototype.apply=function(e){},t}(Xl.a),Yl=u(681),Kp=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,!1)||this;return i._cache=e,i.reset(),i}return Object.defineProperty(t.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e!=null?e:1))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cull",{get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e!=null?e:2))},enumerable:!1,configurable:!0}),t.prototype.reset=function(){n.prototype.reset.call(this),this._cache.resetDepthCullingState()},t.prototype.apply=function(e){},t}(Yl.a),Kl="clearQuadVertexShader",Ql=`
const pos : array<vec2<f32>,4>
= array<vec2<f32>,4>(
vec2<f32>(-1.0,1.0),
vec2<f32>(1.0,1.0),
vec2<f32>(-1.0,-1.0),
vec2<f32>(1.0,-1.0)
);
[[builtin(position)]] var<out> position : vec4<f32>;
[[builtin(vertex_idx)]] var<in> vertexIndex : i32;
[[stage(vertex)]]
fn main() -> void {
position=vec4<f32>(pos[vertexIndex],0.0,1.0);
return;
}
`;qe.a.ShadersStore[Kl]=Ql;var l_={name:Kl,shader:Ql},Zl="clearQuadPixelShader",Jl=`[[block]] struct Uniforms {
[[offset(0)]] color : vec4<f32>;
};
[[binding(0),set(0)]] var<uniform> uniforms : Uniforms;
[[location(0)]] var<out> outColor : vec4<f32>;
[[stage(fragment)]]
fn main() -> void {
outColor=uniforms.color;
return;
}
`;qe.a.ShadersStore[Zl]=Jl;var u_={name:Zl,shader:Jl};function Qp(n,t){if(!n)throw new Error(t)}var as=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i={});var r,o,a=n.call(this,null)||this;return a._uploadEncoderDescriptor={label:"upload"},a._renderEncoderDescriptor={label:"render"},a._renderTargetEncoderDescriptor={label:"renderTarget"},a._clearDepthValue=1,a._clearReverseDepthValue=0,a._clearStencilValue=0,a._defaultSampleCount=4,a._glslang=null,a._counters={numBindGroupsCreation:0},a._commandBuffers=[null,null,null],a._currentRenderPass=null,a._mainRenderPassWrapper=new jl,a._rttRenderPassWrapper=new jl,a._pendingDebugCommands=[],a._currentVertexBuffers=null,a._currentOverrideVertexBuffers=null,a._currentIndexBuffer=null,a.__colorWrite=!0,a._uniformsBuffers={},a._forceEnableEffect=!1,a.dbgShowShaderCode=!1,a.dbgSanityChecks=!1,a.dbgGenerateLogs=!1,a.dbgVerboseLogsForFirstFrames=!1,a.dbgVerboseLogsNumFrames=10,a._viewportsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],a._scissorsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],a._scissorCached={x:0,y:0,z:0,w:0},i.deviceDescriptor=i.deviceDescriptor||{},i.swapChainFormat=i.swapChainFormat||Se.BGRA8Unorm,i.antialiasing=i.antialiasing===void 0?!0:i.antialiasing,i.stencil=(r=i.stencil)!==null&&r!==void 0?r:!0,i.enableGPUDebugMarkers=(o=i.enableGPUDebugMarkers)!==null&&o!==void 0?o:!1,p.a.Log("Babylon.js v"+W.a.Version+" - "+a.description+" engine"),navigator.gpu?(a._isWebGPU=!0,a._shaderPlatformName="WEBGPU",i.deterministicLockstep===void 0&&(i.deterministicLockstep=!1),i.lockstepMaxSteps===void 0&&(i.lockstepMaxSteps=4),i.audioEngine===void 0&&(i.audioEngine=!0),a._deterministicLockstep=i.deterministicLockstep,a._lockstepMaxSteps=i.lockstepMaxSteps,a._timeStep=i.timeStep||1/60,a._doNotHandleContextLost=!1,a._canvas=e,a._options=i,a.premultipliedAlpha=!1,a._hardwareScalingLevel=1,a._mainPassSampleCount=i.antialiasing?a._defaultSampleCount:1,a._isStencilEnable=i.stencil,a._sharedInit(e,!!i.doNotHandleTouchAction,i.audioEngine),a._shaderProcessor=a._getShaderProcessor(),a._canvas.style.transform="scaleY(-1)",a):(p.a.Error("WebGPU is not supported by your browser."),a)}return Object.defineProperty(t.prototype,"disableCacheSamplers",{get:function(){return this._cacheSampler?this._cacheSampler.disabled:!1},set:function(e){this._cacheSampler&&(this._cacheSampler.disabled=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"disableCacheRenderPipelines",{get:function(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1},set:function(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t,"IsSupported",{get:function(){return!!navigator.gpu},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"supportsUniformBuffers",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"supportedExtensions",{get:function(){return this._adapterSupportedExtensions},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"enabledExtensions",{get:function(){return this._deviceEnabledExtensions},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return"WebGPU"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"description",{get:function(){var e=this.name+this.version;return e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return 1},enumerable:!1,configurable:!0}),t.CreateAsync=function(e,i){i===void 0&&(i={});var r=new t(e,i);return new Promise(function(o){r.initAsync(i.glslangOptions).then(function(){return o(r)})})},t.prototype.initAsync=function(e){var i=this,r;return this._initGlslang(e!=null?e:(r=this._options)===null||r===void 0?void 0:r.glslangOptions).then(function(o){return i._glslang=o,navigator.gpu.requestAdapter(i._options)}).then(function(o){i._adapter=o,i._adapterSupportedExtensions=i._adapter.extensions.slice(0);var a=i._options.deviceDescriptor;if(a==null?void 0:a.extensions){for(var s=a.extensions,c=[],v=s[Symbol.iterator]();;){var b=v.next(),C=b.done,M=b.value;if(C)break;i._adapterSupportedExtensions.indexOf(M)>=0&&c.push(M)}a.extensions=c}return i._adapter.requestDevice(i._options.deviceDescriptor)}).then(function(o){i._device=o,i._deviceEnabledExtensions=i._device.extensions.slice(0)}).then(function(){i._bufferManager=new zp(i._device),i._textureHelper=new so(i._device,i._glslang,i._bufferManager),i._shaderManager=new Xp(i._device),i._cacheSampler=new kp(i._device),i.dbgVerboseLogsForFirstFrames&&i._count===void 0&&(i._count=0,console.log("%c frame #"+i._count+" - begin","background: #ffff00")),i._uploadEncoder=i._device.createCommandEncoder(i._uploadEncoderDescriptor),i._renderEncoder=i._device.createCommandEncoder(i._renderEncoderDescriptor),i._renderTargetEncoder=i._device.createCommandEncoder(i._renderTargetEncoderDescriptor),i._emptyVertexBuffer=new Oe.b(i,[0],"",!1,!1,1,!1,0,1),i._cacheRenderPipeline=new kl(i._device,i._emptyVertexBuffer),i._depthCullingState=new Kp(i._cacheRenderPipeline),i._stencilState=new Yp(i._cacheRenderPipeline),i._depthCullingState.depthTest=!0,i._depthCullingState.depthFunc=515,i._depthCullingState.depthMask=!0,i._textureHelper.setCommandEncoder(i._uploadEncoder),i._initializeLimits(),i._initializeContextAndSwapChain(),i._initializeMainAttachments(),i.resize()}).catch(function(o){p.a.Error("Can not create WebGPU Device and/or context."),p.a.Error(o),console.trace&&console.trace()})},t.prototype._initGlslang=function(e){return e=e||{},e=Object(h.a)(Object(h.a)({},t._glslangDefaultOptions),e),e.glslang?Promise.resolve(e.glslang):window.glslang?window.glslang(e.wasmPath):e.jsPath&&e.wasmPath?J.b.LoadScriptAsync(e.jsPath).then(function(){return window.glslang(e.wasmPath)}):Promise.reject("gslang is not available.")},t.prototype._initializeLimits=function(){this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:2048,maxCubemapTextureSize:2048,maxRenderTextureSize:2048,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:1024,maxVertexUniformVectors:1024,standardDerivatives:!0,astc:null,s3tc:this._deviceEnabledExtensions.indexOf(io.TextureCompressionBC)>=0?!0:void 0,pvrtc:null,etc1:null,etc2:null,bptc:this._deviceEnabledExtensions.indexOf(io.TextureCompressionBC)>=0?!0:void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,textureFloat:!0,textureFloatLinearFiltering:!0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:void 0,canUseTimestampForTimerQuery:!1,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0},this._caps.parallelShaderCompile=null,this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!0,allowTexturePrefiltering:!0,trackUbosInFrame:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,_collectUbosUpdatedInFrame:!0}},t.prototype._initializeContextAndSwapChain=function(){this._context=this._canvas.getContext("gpupresent"),this._swapChain=this._context.configureSwapChain({device:this._device,format:this._options.swapChainFormat,usage:ei.OutputAttachment|ei.CopySrc}),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new rs],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this.dbgGenerateLogs&&console.log("Swap chain preferred format:",this._context.getSwapChainPreferredFormat(this._adapter))},t.prototype._initializeMainAttachments=function(){this._mainTextureExtends={width:this.getRenderWidth(),height:this.getRenderHeight(),depth:1};var e;if(this._options.antialiasing){var i={size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Vr.E2d,format:this._options.swapChainFormat,usage:ei.OutputAttachment};this._mainTexture&&this._mainTexture.destroy(),this._mainTexture=this._device.createTexture(i),e=[{attachment:this._mainTexture.createView(),loadValue:new et.f(0,0,0,1),storeOp:Sr.Store}]}else e=[{attachment:void 0,loadValue:new et.f(0,0,0,1),storeOp:Sr.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?Se.Depth24PlusStencil8:Se.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper);var r={size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Vr.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:ei.OutputAttachment};this._depthTexture&&this._depthTexture.destroy(),this._depthTexture=this._device.createTexture(r);var o={attachment:this._depthTexture.createView(),depthLoadValue:this._clearDepthValue,depthStoreOp:Sr.Store,stencilLoadValue:this._clearStencilValue,stencilStoreOp:Sr.Store};this._mainRenderPassWrapper.renderPassDescriptor={colorAttachments:e,depthStencilAttachment:o},this._mainRenderPassWrapper.renderPass!==null&&this._endMainRenderPass()},t.prototype.setSize=function(e,i,r){return r===void 0&&(r=!1),n.prototype.setSize.call(this,e,i,r)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - setSize called -",e,i)),this._initializeMainAttachments(),!0):!1},t.prototype._getShaderProcessor=function(){return new Dp},t.prototype._getShaderProcessingContext=function(){return new Fp},t.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentVertexBuffers=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._currentProgram=null,this._stencilState.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},t.prototype.setColorWrite=function(e){this.__colorWrite=e,this._cacheRenderPipeline.setWriteMask(e?15:0)},t.prototype.getColorWrite=function(){return this.__colorWrite},t.prototype._resetCurrentViewport=function(e){this._viewportsCurrent[e].x=0,this._viewportsCurrent[e].y=0,this._viewportsCurrent[e].w=0,this._viewportsCurrent[e].h=0},t.prototype._applyViewport=function(e){var i=e===this._mainRenderPassWrapper.renderPass?0:1,r=this._viewportCached.x,o=this._viewportCached.y,a=this._viewportCached.z,s=this._viewportCached.w;(this._viewportsCurrent[i].x!==r||this._viewportsCurrent[i].y!==o||this._viewportsCurrent[i].w!==a||this._viewportsCurrent[i].h!==s)&&(this._viewportsCurrent[i].x=r,this._viewportsCurrent[i].y=o,this._viewportsCurrent[i].w=a,this._viewportsCurrent[i].h=s,e.setViewport(r,o,a,s,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - viewport applied - (",r,o,a,s,") current pass is main pass="+(e===this._mainRenderPassWrapper.renderPass))))},t.prototype._viewport=function(e,i,r,o){this._viewportCached.x=e,this._viewportCached.y=i,this._viewportCached.z=r,this._viewportCached.w=o},t.prototype._resetCurrentScissor=function(e){this._scissorsCurrent[e].x=0,this._scissorsCurrent[e].y=0,this._scissorsCurrent[e].w=0,this._scissorsCurrent[e].h=0},t.prototype._applyScissor=function(e){var i=e===this._mainRenderPassWrapper.renderPass?0:1,r=this._scissorCached.x,o=this._scissorCached.y,a=this._scissorCached.z,s=this._scissorCached.w;(this._scissorsCurrent[i].x!==r||this._scissorsCurrent[i].y!==o||this._scissorsCurrent[i].w!==a||this._scissorsCurrent[i].h!==s)&&(this._scissorsCurrent[i].x=r,this._scissorsCurrent[i].y=o,this._scissorsCurrent[i].w=a,this._scissorsCurrent[i].h=s,e.setScissorRect(r,o,a,s),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - scissor applied - (",r,o,a,s,") current pass is main pass="+(e===this._mainRenderPassWrapper.renderPass))))},t.prototype._scissorIsActive=function(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==this.getRenderWidth()&&this._scissorCached.z!==0||this._scissorCached.w!==this.getRenderHeight()&&this._scissorCached.w!==0},t.prototype.enableScissor=function(e,i,r,o){this._scissorCached.x=e,this._scissorCached.y=i,this._scissorCached.z=r,this._scissorCached.w=o},t.prototype.disableScissor=function(){this._scissorCached.x=0,this._scissorCached.y=0,this._scissorCached.z=this.getRenderWidth(),this._scissorCached.w=this.getRenderHeight()},t.prototype.clear=function(e,i,r,o){o===void 0&&(o=!1),e&&e.a===void 0&&(e.a=1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - clear called - backBuffer=",i," depth=",r," stencil=",o)),this._currentRenderTarget?(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,i?e:null,i?e:null,r,o)):this._startMainRenderPass(!0,i?e:null,r,o)},t.prototype.clearAttachments=function(e,i,r,o,a){e.length===0||!this._currentRenderTarget||(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,i,r,o,a))},t.prototype.createVertexBuffer=function(e){var i;e instanceof Array?i=new Float32Array(e):e instanceof ArrayBuffer?i=new Uint8Array(e):i=e;var r=this._bufferManager.createBuffer(i,Fi.Vertex|Fi.CopyDst);return r},t.prototype.createDynamicVertexBuffer=function(e){return this.createVertexBuffer(e)},t.prototype.updateDynamicVertexBuffer=function(e,i,r,o){var a=e;r===void 0&&(r=0);var s;o===void 0?(i instanceof Array?s=new Float32Array(i):i instanceof ArrayBuffer?s=new Uint8Array(i):s=i,o=s.byteLength):i instanceof Array?s=new Float32Array(i):i instanceof ArrayBuffer?s=new Uint8Array(i):s=i,this._bufferManager.setSubData(a,r,s,0,o)},t.prototype.createIndexBuffer=function(e,i){var r=!0,o;e instanceof Uint32Array||e instanceof Int32Array?o=e:e instanceof Uint16Array?(o=e,r=!1):e.length>65535?o=new Uint32Array(e):(o=new Uint16Array(e),r=!1);var a=this._bufferManager.createBuffer(o,Fi.Index|Fi.CopyDst);return a.is32Bits=r,a},t.prototype.updateDynamicIndexBuffer=function(e,i,r){r===void 0&&(r=0);var o=e,a;i instanceof Uint16Array?e.is32Bits?a=Uint32Array.from(i):a=i:i instanceof Uint32Array?e.is32Bits?a=i:a=Uint16Array.from(i):e.is32Bits?a=new Uint32Array(i):a=new Uint16Array(i),this._bufferManager.setSubData(o,r,a)},t.prototype.bindBuffersDirectly=function(e,i,r,o,a){throw"Not implemented on WebGPU so far."},t.prototype.updateAndBindInstancesBuffer=function(e,i,r){throw"Not implemented on WebGPU so far."},t.prototype.bindBuffers=function(e,i,r,o){this._currentIndexBuffer=i,this._currentVertexBuffers=e,this._currentOverrideVertexBuffers=o!=null?o:null,this._cacheRenderPipeline.setBuffers(e,i,this._currentOverrideVertexBuffers)},t.prototype._releaseBuffer=function(e){return this._bufferManager.releaseBuffer(e)},t.prototype.createUniformBuffer=function(e){var i;e instanceof Array?i=new Float32Array(e):i=e;var r=this._bufferManager.createBuffer(i,Fi.Uniform|Fi.CopyDst);return r},t.prototype.createDynamicUniformBuffer=function(e){return this.createUniformBuffer(e)},t.prototype.updateUniformBuffer=function(e,i,r,o){r===void 0&&(r=0);var a=e,s;o===void 0?(i instanceof Float32Array?s=i:s=new Float32Array(i),o=s.byteLength):i instanceof Float32Array?s=i:s=new Float32Array(i),this._bufferManager.setSubData(a,r,s,0,o)},t.prototype.bindUniformBufferBase=function(e,i,r){this._uniformsBuffers[r]=e},t.prototype.createEffect=function(e,i,r,o,a,s,c,v,b){var C=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,M=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,N=C+"+"+M+"@"+(a||i.defines);if(this._compiledEffects[N]){var D=this._compiledEffects[N];return c&&D.isReady()&&c(D),D}var V=new qe.a(e,i,r,o,this,a,s,c,v,b,N);return this._compiledEffects[N]=V,V},t.prototype._compileRawShaderToSpirV=function(e,i){return this._glslang.compileGLSL(e,i)},t.prototype._compileShaderToSpirV=function(e,i,r,o){return this._compileRawShaderToSpirV(o+(r?r+`
`:"")+e,i)},t.prototype._createPipelineStageDescriptor=function(e,i){return{vertexStage:{module:this._device.createShaderModule({code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:i}),entryPoint:"main"}}},t.prototype._compileRawPipelineStageDescriptor=function(e,i){var r=this._compileRawShaderToSpirV(e,"vertex"),o=this._compileRawShaderToSpirV(i,"fragment");return this._createPipelineStageDescriptor(r,o)},t.prototype._compilePipelineStageDescriptor=function(e,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);var o=`#version 450
`,a=this._compileShaderToSpirV(e,"vertex",r,o),s=this._compileShaderToSpirV(i,"fragment",r,o),c=this._createPipelineStageDescriptor(a,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),c},t.prototype.createRawShaderProgram=function(e,i,r,o,a){throw a===void 0&&(a=null),"Not available on WebGPU"},t.prototype.createShaderProgram=function(e,i,r,o,a,s){throw s===void 0&&(s=null),"Not available on WebGPU"},t.prototype.createPipelineContext=function(e){return new Pp(e,this)},t.prototype._preparePipelineContext=function(e,i,r,o,a,s,c,v,b,C){var M=e;this.dbgShowShaderCode&&(console.log(v),console.log(i),console.log(r)),M.sources={fragment:r,vertex:i,rawVertex:a,rawFragment:s},o?M.stages=this._compileRawPipelineStageDescriptor(i,r):M.stages=this._compilePipelineStageDescriptor(i,r,v)},t.prototype.getAttributes=function(e,i){for(var r=new Array(i.length),o=e,a=0;a<i.length;a++){var s=i[a],c=o.shaderProcessingContext.availableAttributes[s];c!==void 0&&(r[a]=c)}return r},t.prototype.enableEffect=function(e){!e||e===this._currentEffect&&!this._forceEnableEffect||(this._currentEffect=e,this._forceEnableEffect=!1,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))},t.prototype._releaseEffect=function(e){},t.prototype.releaseEffects=function(){},t.prototype._deletePipelineContext=function(e){var i=e;i&&e.dispose()},Object.defineProperty(t.prototype,"needPOTTextures",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype._createHardwareTexture=function(){return new rs},t.prototype._releaseTexture=function(e){var i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),this._textureHelper.releaseTexture(e)},t.prototype._getRGBABufferInternalSizedFormat=function(e,i){return 5},t.prototype.updateTextureComparisonFunction=function(e,i){e._comparisonFunction=i},t.prototype.createTexture=function(e,i,r,o,a,s,c,v,b,C,M,N,D){var V=this;return a===void 0&&(a=3),s===void 0&&(s=null),c===void 0&&(c=null),v===void 0&&(v=null),b===void 0&&(b=null),C===void 0&&(C=null),M===void 0&&(M=null),this._createTextureBase(e,i,r,o,a,s,c,function(X,ee,ie,ge,pe,te,Ce,Ae,De){var Fe,We=ge;if(X.baseWidth=We.width,X.baseHeight=We.height,X.width=We.width,X.height=We.height,X.format=C!=null?C:-1,Ae(X.width,X.height,We,ee,X,function(){}),(Fe=X._hardwareTexture)===null||Fe===void 0?void 0:Fe.underlyingResource)!te&&!Ce&&V._generateMipmaps(X,V._uploadEncoder);else{var Pe=V._textureHelper.createGPUTextureForInternalTexture(X,We.width,We.height);so.IsImageBitmap(We)&&(V._textureHelper.updateTexture(We,Pe.underlyingResource,We.width,We.height,X.depth,Pe.format,0,0,pe,!1,0,0,V._uploadEncoder),!te&&!Ce&&V._generateMipmaps(X,V._uploadEncoder))}ie&&ie._removePendingData(X),X.isReady=!0,X.onLoadedObservable.notifyObservers(X),X.onLoadedObservable.clear()},function(){return!1},v,b,C,M,N,D)},t.prototype._setCubeMapTextureParams=function(e,i){e.samplingMode=i?W.a.TEXTURE_TRILINEAR_SAMPLINGMODE:W.a.TEXTURE_BILINEAR_SAMPLINGMODE,e._cachedWrapU=0,e._cachedWrapV=0},t.prototype.createCubeTexture=function(e,i,r,o,a,s,c,v,b,C,M,N){var D=this;return a===void 0&&(a=null),s===void 0&&(s=null),v===void 0&&(v=null),b===void 0&&(b=!1),C===void 0&&(C=0),M===void 0&&(M=0),N===void 0&&(N=null),this.createCubeTextureBase(e,i,r,!!o,a,s,c,v,b,C,M,N,null,function(V,X){var ee=X,ie=ee[0].width,ge=ie;D._setCubeMapTextureParams(V,!o),V.format=c!=null?c:-1;var pe=D._textureHelper.createGPUTextureForInternalTexture(V,ie,ge);D._textureHelper.updateCubeTextures(ee,pe.underlyingResource,ie,ge,pe.format,!1,!1,0,0,D._uploadEncoder),o||D._generateMipmaps(V,D._uploadEncoder),V.isReady=!0,V.onLoadedObservable.notifyObservers(V),V.onLoadedObservable.clear(),a&&a()})},t.prototype.createRawTexture=function(e,i,r,o,a,s,c,v,b){v===void 0&&(v=null),b===void 0&&(b=0);var C=new gt.a(this,gt.b.Raw);return C.baseWidth=i,C.baseHeight=r,C.width=i,C.height=r,C.format=o,C.generateMipMaps=a,C.samplingMode=c,C.invertY=s,C._compression=v,C.type=b,this._doNotHandleContextLost||(C._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(C,i,r),this.updateRawTexture(C,e,o,s,v,b),this._internalTexturesCache.push(C),C},t.prototype.createRawCubeTexture=function(e,i,r,o,a,s,c,v){v===void 0&&(v=null);var b=new gt.a(this,gt.b.CubeRaw);return b.isCube=!0,b.format=r===4?5:r,b.type=o,b.generateMipMaps=a,b.width=i,b.height=i,b.samplingMode=c,this._doNotHandleContextLost||(b._bufferViewArray=e),this._textureHelper.createGPUTextureForInternalTexture(b),e&&this.updateRawCubeTexture(b,e,r,o,s,v),b},t.prototype.createRawCubeTextureFromUrl=function(e,i,r,o,a,s,c,v,b,C,M,N){var D=this;b===void 0&&(b=null),C===void 0&&(C=null),M===void 0&&(M=3),N===void 0&&(N=!1);var V=this.createRawCubeTexture(null,r,o,a,!s,N,M,null);i==null||i._addPendingData(V),V.url=e,this._internalTexturesCache.push(V);var X=function(ie,ge){i==null||i._removePendingData(V),C&&ie&&C(ie.status+" "+ie.statusText,ge)},ee=function(ie){var ge=V.width,pe=c(ie);if(!!pe){var te=[0,2,4,1,3,5];if(v)for(var Ce=o===4,Ae=v(pe),De=V._hardwareTexture,Fe=[0,1,2,3,4,5],We=0;We<Ae.length;We++){for(var Pe=ge>>We,Ne=[],je=0;je<6;je++){var Be=Ae[We][Fe[je]];Ce&&(Be=lo(Be,Pe,Pe,a)),Ne.push(new Uint8Array(Be.buffer,Be.byteOffset,Be.byteLength))}D._textureHelper.updateCubeTextures(Ne,De.underlyingResource,Pe,Pe,De.format,N,!1,0,0,D._uploadEncoder)}else{for(var Ne=[],je=0;je<6;je++)Ne.push(pe[te[je]]);D.updateRawCubeTexture(V,Ne,o,a,N)}V.isReady=!0,i==null||i._removePendingData(V),b&&b()}};return this._loadFile(e,function(ie){ee(ie)},void 0,i==null?void 0:i.offlineProvider,!0,X),V},t.prototype.createRawTexture2DArray=function(e,i,r,o,a,s,c,v,b,C){b===void 0&&(b=null),C===void 0&&(C=0);var M=gt.b.Raw2DArray,N=new gt.a(this,M);return N.baseWidth=i,N.baseHeight=r,N.baseDepth=o,N.width=i,N.height=r,N.depth=o,N.format=a,N.type=C,N.generateMipMaps=s,N.samplingMode=v,N.is2DArray=!0,this._doNotHandleContextLost||(N._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(N,i,r,o),this.updateRawTexture2DArray(N,e,a,c,b,C),this._internalTexturesCache.push(N),N},t.prototype.createRawTexture3D=function(e,i,r,o,a,s,c,v,b,C){b===void 0&&(b=null),C===void 0&&(C=0);var M=gt.b.Raw3D,N=new gt.a(this,M);return N.baseWidth=i,N.baseHeight=r,N.baseDepth=o,N.width=i,N.height=r,N.depth=o,N.format=a,N.type=C,N.generateMipMaps=s,N.samplingMode=v,N.is3D=!0,this._doNotHandleContextLost||(N._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(N,i,r),this.updateRawTexture3D(N,e,a,c,b,C),this._internalTexturesCache.push(N),N},t.prototype.generateMipMapsForCubemap=function(e,i){var r;if(i===void 0&&(i=!0),e.generateMipMaps){var o=(r=e._hardwareTexture)===null||r===void 0?void 0:r.underlyingResource;o||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e,e.source===gt.b.RenderTarget||e.source===gt.b.MultiRenderTarget?this._renderTargetEncoder:void 0)}},t.prototype.updateTextureSamplingMode=function(e,i,r){r===void 0&&(r=!1),r&&(i.generateMipMaps=!0,this._generateMipmaps(i)),i.samplingMode=e},t.prototype.updateTextureWrappingMode=function(e,i,r,o){r===void 0&&(r=null),o===void 0&&(o=null),i!==null&&(e._cachedWrapU=i,this._lastCachedWrapU=i),r!==null&&(e._cachedWrapV=r,this._lastCachedWrapV=r),(e.is2DArray||e.is3D)&&o!==null&&(e._cachedWrapR=o,this._lastCachedWrapR=o)},t.prototype.updateTextureDimensions=function(e,i,r,o){o===void 0&&(o=1),!!e._hardwareTexture&&(e.width===i&&e.height===r&&e.depth===o||(e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,i,r,o)))},t.prototype._setInternalTexture=function(e,i,r,o){if(o===void 0&&(o=0),r=r!=null?r:e,this._currentEffect){var a=this._currentEffect._pipelineContext;if(a.textures[e])a.textures[e].texture!==i&&(a.bindGroupsCache.values={}),a.textures[e].texture=i;else{var s=a.shaderProcessingContext.availableSamplers[r];s&&(a.samplers[r]={samplerBinding:s.sampler.bindingIndex,firstTextureName:e},a.textures[e]={textureBinding:s.textures[o].bindingIndex,texture:i})}}},t.prototype.setTexture=function(e,i,r,o){this._setTexture(e,r,!1,!1,o,o)},t.prototype.setTextureArray=function(e,i,r,o){for(var a=0;a<r.length;a++)this._setTexture(-1,r[a],!0,!1,o+a.toString(),o,a)},t.prototype._setTexture=function(e,i,r,o,a,s,c){if(r===void 0&&(r=!1),o===void 0&&(o=!1),a===void 0&&(a=""),c===void 0&&(c=0),s=s!=null?s:a,this._currentEffect){var v=this._currentEffect._pipelineContext;if(!i)return v.textures[a]&&v.textures[a].texture&&(v.bindGroupsCache.values={}),v.textures[a]=null,!1;if(i.video)i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;var b=null;if(o?b=i.depthStencilTexture:i.isReady()?b=i.getInternalTexture():i.isCube?b=this.emptyCubeTexture:i.is3D?b=this.emptyTexture3D:i.is2DArray?b=this.emptyTexture2DArray:b=this.emptyTexture,b&&!b.isMultiview){if(b.isCube&&b._cachedCoordinatesMode!==i.coordinatesMode){b._cachedCoordinatesMode=i.coordinatesMode;var C=i.coordinatesMode!==3&&i.coordinatesMode!==5?1:0;i.wrapU=C,i.wrapV=C}b._cachedWrapU=i.wrapU,this._lastCachedWrapU!==i.wrapU&&(this._lastCachedWrapU=i.wrapU),b._cachedWrapV=i.wrapV,this._lastCachedWrapV!==i.wrapV&&(this._lastCachedWrapV=i.wrapV),b._cachedWrapR=i.wrapR,b.is3D&&this._lastCachedWrapR!==i.wrapR&&(this._lastCachedWrapR=i.wrapR),this._setAnisotropicLevel(0,b,i.anisotropicFilteringLevel)}this._setInternalTexture(a,b,s,c)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",i));return!0},t.prototype._setAnisotropicLevel=function(e,i,r){i._cachedAnisotropicFilteringLevel!==r&&(i._cachedAnisotropicFilteringLevel=Math.min(r,this._caps.maxAnisotropy))},t.prototype._bindTexture=function(e,i,r){e!==void 0&&(i&&(this._lastCachedWrapU!==null&&(i._cachedWrapU=this._lastCachedWrapU),this._lastCachedWrapV!==null&&(i._cachedWrapV=this._lastCachedWrapV),this._lastCachedWrapR!==null&&(i._cachedWrapR=this._lastCachedWrapR)),this._setInternalTexture(r,i))},t.prototype._generateMipmaps=function(e,i){var r,o=(r=e._hardwareTexture)===null||r===void 0?void 0:r.underlyingResource;if(!!o){i=i!=null?i:this._currentRenderTarget&&!this._currentRenderPass?this._renderTargetEncoder:this._currentRenderPass?this._uploadEncoder:this._renderEncoder;var a=e._hardwareTexture.format,s=so.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - generate mipmaps called - width=",e.width,"height=",e.height,"isCube=",e.isCube)),e.isCube?this._textureHelper.generateCubeMipmaps(o,a,s,i):this._textureHelper.generateMipmaps(o,a,s,0,i)}},t.prototype.updateDynamicTexture=function(e,i,r,o,a,s){var c=this,v;if(o===void 0&&(o=!1),!!e){var b=i.width,C=i.height,M=e._hardwareTexture;((v=e._hardwareTexture)===null||v===void 0?void 0:v.underlyingResource)||(M=this._textureHelper.createGPUTextureForInternalTexture(e,b,C)),createImageBitmap(i).then(function(N){c._textureHelper.updateTexture(N,M.underlyingResource,b,C,e.depth,M.format,0,0,r,o,0,0,c._uploadEncoder),e.generateMipMaps&&c._generateMipmaps(e,c._uploadEncoder),e.isReady=!0})}},t.prototype.updateTextureData=function(e,i,r,o,a,s,c,v){var b;c===void 0&&(c=0),v===void 0&&(v=0);var C=e._hardwareTexture;((b=e._hardwareTexture)===null||b===void 0?void 0:b.underlyingResource)||(C=this._textureHelper.createGPUTextureForInternalTexture(e));var M=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(M,C.underlyingResource,a,s,e.depth,C.format,c,v,e.invertY,!1,r,o,this._uploadEncoder)},t.prototype.updateVideoTexture=function(e,i,r){var o=this,a;if(!(!e||e._isDisabled)){this._videoTextureSupported===void 0&&(this._videoTextureSupported=!0);var s=e._hardwareTexture;((a=e._hardwareTexture)===null||a===void 0?void 0:a.underlyingResource)||(s=this._textureHelper.createGPUTextureForInternalTexture(e)),createImageBitmap(i).then(function(c){o._textureHelper.updateTexture(c,s.underlyingResource,e.width,e.height,e.depth,s.format,0,0,!r,!1,0,0,o._uploadEncoder),e.generateMipMaps&&o._generateMipmaps(e,o._uploadEncoder),e.isReady=!0}).catch(function(c){e.isReady=!0})}},t.prototype._uploadCompressedDataToTextureDirectly=function(e,i,r,o,a,s,c){var v;s===void 0&&(s=0),c===void 0&&(c=0);var b=e._hardwareTexture;((v=e._hardwareTexture)===null||v===void 0?void 0:v.underlyingResource)||(e.format=i,b=this._textureHelper.createGPUTextureForInternalTexture(e,r,o));var C=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);this._textureHelper.updateTexture(C,b.underlyingResource,r,o,e.depth,b.format,s,c,!1,!1,0,0,this._uploadEncoder)},t.prototype._uploadDataToTextureDirectly=function(e,i,r,o,a,s){var c;r===void 0&&(r=0),o===void 0&&(o=0),s===void 0&&(s=!1);var v=Math.round(Math.log(e.width)*Math.LOG2E),b=Math.round(Math.log(e.height)*Math.LOG2E),C=s?e.width:Math.pow(2,Math.max(v-o,0)),M=s?e.height:Math.pow(2,Math.max(b-o,0)),N=e._hardwareTexture;((c=e._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource)||(N=this._textureHelper.createGPUTextureForInternalTexture(e,C,M));var D=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(D,N.underlyingResource,C,M,e.depth,N.format,r,o,e.invertY,!1,0,0,this._uploadEncoder)},t.prototype._uploadArrayBufferViewToTexture=function(e,i,r,o){r===void 0&&(r=0),o===void 0&&(o=0),this._uploadDataToTextureDirectly(e,i,r,o)},t.prototype._uploadImageToTexture=function(e,i,r,o){var a;r===void 0&&(r=0),o===void 0&&(o=0);var s=e._hardwareTexture;((a=e._hardwareTexture)===null||a===void 0?void 0:a.underlyingResource)||(s=this._textureHelper.createGPUTextureForInternalTexture(e));var c=i,v=Math.ceil(e.width/(1<<o)),b=Math.ceil(e.height/(1<<o));this._textureHelper.updateTexture(c,s.underlyingResource,v,b,e.depth,s.format,r,o,e.invertY,!1,0,0,this._uploadEncoder)},t.prototype.updateRawTexture=function(e,i,r,o,a,s){if(a===void 0&&(a=null),s===void 0&&(s=0),!!e){if(this._doNotHandleContextLost||(e._bufferView=i,e.invertY=o,e._compression=a),i){var c=e._hardwareTexture,v=r===4;v&&(i=lo(i,e.width,e.height,s));var b=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(b,c.underlyingResource,e.width,e.height,e.depth,c.format,0,0,o,!1,0,0,this._uploadEncoder),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},t.prototype.updateRawCubeTexture=function(e,i,r,o,a,s,c){s===void 0&&(s=null),c===void 0&&(c=0),e._bufferViewArray=i,e.invertY=a,e._compression=s;for(var v=e._hardwareTexture,b=r===4,C=[],M=0;M<i.length;++M){var N=i[M];b&&(N=lo(i[M],e.width,e.height,o)),C.push(new Uint8Array(N.buffer,N.byteOffset,N.byteLength))}this._textureHelper.updateCubeTextures(C,v.underlyingResource,e.width,e.height,v.format,a,!1,0,0,this._uploadEncoder),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0},t.prototype.updateRawTexture2DArray=function(e,i,r,o,a,s){if(a===void 0&&(a=null),s===void 0&&(s=0),this._doNotHandleContextLost||(e._bufferView=i,e.format=r,e.invertY=o,e._compression=a),i){var c=e._hardwareTexture,v=r===4;v&&(i=lo(i,e.width,e.height,s));var b=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(b,c.underlyingResource,e.width,e.height,e.depth,c.format,0,0,o,!1,0,0,this._uploadEncoder),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},t.prototype.updateRawTexture3D=function(e,i,r,o,a,s){if(a===void 0&&(a=null),s===void 0&&(s=0),this._doNotHandleContextLost||(e._bufferView=i,e.format=r,e.invertY=o,e._compression=a),i){var c=e._hardwareTexture,v=r===4;v&&(i=lo(i,e.width,e.height,s));var b=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(b,c.underlyingResource,e.width,e.height,e.depth,c.format,0,0,o,!1,0,0,this._uploadEncoder),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},t.prototype.readPixels=function(e,i,r,o,a,s){a===void 0&&(a=!0),s===void 0&&(s=!0);var c=this._rttRenderPassWrapper.renderPass?this._rttRenderPassWrapper:this._mainRenderPassWrapper,v=c.colorAttachmentGPUTextures[0].underlyingResource,b=c.colorAttachmentGPUTextures[0].format;return v?(s&&this.flushFramebuffer(),this._textureHelper.readPixels(v,e,i,r,o,b)):Promise.resolve(new Uint8Array(0))},t.prototype._readTexturePixels=function(e,i,r,o,a,s,c){o===void 0&&(o=-1),a===void 0&&(a=0),s===void 0&&(s=null),c===void 0&&(c=!0);var v=e._hardwareTexture;return c&&this.flushFramebuffer(),this._textureHelper.readPixels(v.underlyingResource,0,0,i,r,v.format,o,a,s)},t.prototype._readTexturePixelsSync=function(e,i,r,o,a,s,c){throw o===void 0&&(o=-1),a===void 0&&(a=0),s===void 0&&(s=null),c===void 0&&(c=!0),"_readTexturePixelsSync is unsupported in WebGPU!"},t.prototype.createRenderTargetTexture=function(e,i){var r,o=new wl.a;i!==void 0&&typeof i=="object"?(o.generateMipMaps=i.generateMipMaps,o.generateDepthBuffer=i.generateDepthBuffer===void 0?!0:i.generateDepthBuffer,o.generateStencilBuffer=o.generateDepthBuffer&&i.generateStencilBuffer,o.type=i.type===void 0?0:i.type,o.samplingMode=i.samplingMode===void 0?3:i.samplingMode,o.format=i.format===void 0?5:i.format,o.samples=(r=i.samples)!==null&&r!==void 0?r:1):(o.generateMipMaps=i,o.generateDepthBuffer=!0,o.generateStencilBuffer=!1,o.type=0,o.samplingMode=3,o.format=5,o.samples=1);var a=new gt.a(this,gt.b.RenderTarget),s=e.width||e,c=e.height||e,v=e.layers||0;return a._depthStencilBuffer={},a._framebuffer={},a.baseWidth=s,a.baseHeight=c,a.width=s,a.height=c,a.depth=v,a.isReady=!0,a.samples=o.samples,a.generateMipMaps=!!o.generateMipMaps,a.samplingMode=o.samplingMode,a.type=o.type,a.format=o.format,a._generateDepthBuffer=o.generateDepthBuffer,a._generateStencilBuffer=!!o.generateStencilBuffer,a.is2DArray=v>0,this._internalTexturesCache.push(a),(a._generateDepthBuffer||a._generateStencilBuffer)&&(a._depthStencilTexture=this.createDepthStencilTexture({width:s,height:c,layers:v},{bilinearFiltering:o.samplingMode===void 0||o.samplingMode===2||o.samplingMode===2||o.samplingMode===3||o.samplingMode===3||o.samplingMode===5||o.samplingMode===6||o.samplingMode===7||o.samplingMode===11,comparisonFunction:0,generateStencil:a._generateStencilBuffer,isCube:a.isCube,samples:a.samples})),i!==void 0&&typeof i=="object"&&i.createMipMaps&&!o.generateMipMaps&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a),i!==void 0&&typeof i=="object"&&i.createMipMaps&&!o.generateMipMaps&&(a.generateMipMaps=!1),a},t.prototype.createMultipleRenderTarget=function(e,i){var r=!1,o=!0,a=!1,s=!1,c=1,v=0,b=3,C=new Array,M=new Array;i!==void 0&&(r=i.generateMipMaps===void 0?!1:i.generateMipMaps,o=i.generateDepthBuffer===void 0?!0:i.generateDepthBuffer,a=i.generateStencilBuffer===void 0?!1:i.generateStencilBuffer,s=i.generateDepthTexture===void 0?!1:i.generateDepthTexture,c=i.textureCount||1,i.types&&(C=i.types),i.samplingModes&&(M=i.samplingModes));var N=e.width||e,D=e.height||e,V=null;(o||a||s)&&(V=this.createDepthStencilTexture({width:N,height:D},{bilinearFiltering:!1,comparisonFunction:0,generateStencil:a,isCube:!1,samples:1}));for(var X=[],ee=[],ie=0;ie<c;ie++){var ge=M[ie]||b,pe=C[ie]||v;(pe===1&&!this._caps.textureFloatLinearFiltering||pe===2&&!this._caps.textureHalfFloatLinearFiltering)&&(ge=1),pe===1&&!this._caps.textureFloat&&(pe=0,p.a.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var te=new gt.a(this,gt.b.MultiRenderTarget);X.push(te),ee.push(ie+1),te._depthStencilTexture=ie===0?V:null,te._framebuffer={},te._depthStencilBuffer={},te.baseWidth=N,te.baseHeight=D,te.width=N,te.height=D,te.isReady=!0,te.samples=1,te.generateMipMaps=r,te.samplingMode=ge,te.type=pe,te._generateDepthBuffer=o,te._generateStencilBuffer=!!a,te._attachments=ee,te._textureArray=X,this._internalTexturesCache.push(te),this._textureHelper.createGPUTextureForInternalTexture(te)}return V&&(X.push(V),this._internalTexturesCache.push(V)),X},t.prototype.createRenderTargetCubeTexture=function(e,i){var r=Object(h.a)({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1},i);r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer;var o=new gt.a(this,gt.b.RenderTarget);return o.width=e,o.height=e,o.depth=0,o.isReady=!0,o.isCube=!0,o.samples=r.samples,o.generateMipMaps=r.generateMipMaps,o.samplingMode=r.samplingMode,o.type=r.type,o.format=r.format,o._generateDepthBuffer=r.generateDepthBuffer,o._generateStencilBuffer=r.generateStencilBuffer,this._internalTexturesCache.push(o),(o._generateDepthBuffer||o._generateStencilBuffer)&&(o._depthStencilTexture=this.createDepthStencilTexture({width:o.width,height:o.height,layers:o.depth},{bilinearFiltering:r.samplingMode===void 0||r.samplingMode===2||r.samplingMode===2||r.samplingMode===3||r.samplingMode===3||r.samplingMode===5||r.samplingMode===6||r.samplingMode===7||r.samplingMode===11,comparisonFunction:0,generateStencil:o._generateStencilBuffer,isCube:o.isCube,samples:o.samples})),i&&i.createMipMaps&&!r.generateMipMaps&&(o.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(o),i&&i.createMipMaps&&!r.generateMipMaps&&(o.generateMipMaps=!1),o},t.prototype._setupDepthStencilTexture=function(e,i,r,o,a,s){s===void 0&&(s=1);var c=i.width||i,v=i.height||i,b=i.layers||0;e.baseWidth=c,e.baseHeight=v,e.width=c,e.height=v,e.is2DArray=b>0,e.depth=b,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e._generateDepthBuffer=!0,e._generateStencilBuffer=r,e.samplingMode=o?2:1,e.type=0,e._comparisonFunction=a},t.prototype._createDepthStencilTexture=function(e,i){var r=new gt.a(this,gt.b.Depth),o=Object(h.a)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1},i);return r.format=o.generateStencil?13:14,this._setupDepthStencilTexture(r,e,o.generateStencil,o.bilinearFiltering,o.comparisonFunction,o.samples),this._textureHelper.createGPUTextureForInternalTexture(r),r},t.prototype._createDepthStencilCubeTexture=function(e,i){var r=new gt.a(this,gt.b.Depth);r.isCube=!0;var o=Object(h.a)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1},i);return r.format=o.generateStencil?13:14,this._setupDepthStencilTexture(r,e,o.generateStencil,o.bilinearFiltering,o.comparisonFunction,o.samples),this._textureHelper.createGPUTextureForInternalTexture(r),r},t.prototype.updateRenderTargetTextureSampleCount=function(e,i){return!e||e.samples===i||(i=Math.min(i,this.getCaps().maxMSAASamples),i>1&&(i=4),this._textureHelper.createMSAATexture(e,i),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,i),e._depthStencilTexture.samples=i),e.samples=i),i},t.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,i){if(!e||e[0].samples===i)return i;i=Math.min(i,this.getCaps().maxMSAASamples),i>1&&(i=4);for(var r=0;r<e.length;++r){var o=e[r];this._textureHelper.createMSAATexture(o,i),o.samples=i}return i},t.prototype.beginFrame=function(){n.prototype.beginFrame.call(this)},t.prototype.endFrame=function(){if(this._endMainRenderPass(),this.flushFramebuffer(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - counters - numBindGroupsCreation=",this._counters.numBindGroupsCreation)),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){var e=[];for(var i in Fr.a._updatedUbosInFrame)e.push(i+":"+Fr.a._updatedUbosInFrame[i]);console.log("frame #"+this._count+" - updated ubos -",e.join(", "))}Fr.a._updatedUbosInFrame={}}this._counters.numBindGroupsCreation=0,this._cacheRenderPipeline.endFrame(),this._pendingDebugCommands.length=0,n.prototype.endFrame.call(this),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - end","background: #ffff00"),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - begin","background: #ffff00")))},t.prototype.flushFramebuffer=function(){var e=0;this._currentRenderPass&&(this._currentRenderTarget?this._currentRenderPass&&(e=1,this._endRenderTargetRenderPass()):(e=2,this._endMainRenderPass())),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderTargetEncoder.finish(),this._commandBuffers[2]=this._renderEncoder.finish(),this._device.defaultQueue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._textureHelper.setCommandEncoder(this._uploadEncoder),e===1?this._startRenderTargetRenderPass(this._currentRenderTarget,null,null,!1,!1):e===2&&this._startMainRenderPass(!1)},t.prototype._startRenderTargetRenderPass=function(e,i,r,o,a){var s=e._hardwareTexture,c=s.underlyingResource,v=e._depthStencilTexture,b=v==null?void 0:v._hardwareTexture,C=b==null?void 0:b.underlyingResource,M=b==null?void 0:b.msaaTexture,N=C==null?void 0:C.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),D=M==null?void 0:M.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),V=[];if(e._attachments&&e._textureArray){for(var X=0;X<e._attachments.length;++X){var ee=e._attachments[X],ie=e._textureArray[ee-1],ge=ie==null?void 0:ie._hardwareTexture,pe=ge==null?void 0:ge.underlyingResource;if(ge&&pe){var te=Object(h.a)(Object(h.a)({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{format:ge.format}),Ce=ge.msaaTexture,Ae=pe.createView(te),De=Ce==null?void 0:Ce.createView(te),Fe=X===0?i||Gi.Load:r||Gi.Load;V.push({attachment:De||Ae,resolveTarget:Ce?Ae:void 0,loadValue:Fe,storeOp:Sr.Store})}}this._mrtAttachments=e._attachments,this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments,e._textureArray)}else{var Ce=s.msaaTexture,Ae=c.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),De=Ce==null?void 0:Ce.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor);V.push({attachment:De||Ae,resolveTarget:Ce?Ae:void 0,loadValue:i!==null?i:Gi.Load,storeOp:Sr.Store})}this._debugPushGroup("render target pass",1),this._rttRenderPassWrapper.renderPassDescriptor={colorAttachments:V,depthStencilAttachment:v&&C?{attachment:D||N,depthLoadValue:o&&v._generateDepthBuffer?this._clearDepthValue:Gi.Load,depthStoreOp:Sr.Store,stencilLoadValue:a&&v._generateStencilBuffer?this._clearStencilValue:Gi.Load,stencilStoreOp:Sr.Store}:void 0},this._rttRenderPassWrapper.renderPass=this._renderTargetEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target begin pass - internalTexture.uniqueId=",e.uniqueId,this._rttRenderPassWrapper.renderPassDescriptor)),this._currentRenderPass=this._rttRenderPassWrapper.renderPass,this._debugFlushPendingCommands(),this._resetCurrentViewport(1),this._resetCurrentScissor(1)},t.prototype._endRenderTargetRenderPass=function(){var e;this._currentRenderPass&&(this._currentRenderPass.endPass(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target end pass - internalTexture.uniqueId=",(e=this._currentRenderTarget)===null||e===void 0?void 0:e.uniqueId)),this._debugPopGroup(1),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._currentRenderPass=null,this._rttRenderPassWrapper.reset())},t.prototype._getCurrentRenderPass=function(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,null,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass},t.prototype._startMainRenderPass=function(e,i,r,o){this._mainRenderPassWrapper.renderPass&&this._endMainRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreater();var a=this._scissorIsActive();if(e){var s=a?Gi.Load:i||Gi.Load,c=a?Gi.Load:r?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:Gi.Load,v=a?Gi.Load:o?this._clearStencilValue:Gi.Load;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadValue=s,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadValue=c,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadValue=v}if(this._swapChainTexture=this._swapChain.getCurrentTexture(),this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(this._swapChainTexture),this._options.antialiasing?this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=this._swapChainTexture.createView():this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].attachment=this._swapChainTexture.createView(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height,this._mainRenderPassWrapper.renderPassDescriptor)),this._debugPushGroup("main pass",0),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._mainRenderPassWrapper.renderPass=this._currentRenderPass,this._debugFlushPendingCommands(),this._resetCurrentViewport(0),this._resetCurrentScissor(0),e&&a){this._applyScissor(this._currentRenderPass);var b=this._device.createRenderPipeline(Object(h.a)({sampleCount:this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount,primitiveTopology:ki.TriangleStrip,vertexState:{indexFormat:Gr.Uint16},depthStencilState:this._depthTextureFormat===void 0?void 0:{depthWriteEnabled:r,depthCompare:ti.Always,format:this._depthTextureFormat,stencilFront:{compare:o?ti.Always:ti.Never,passOp:o?ir.Replace:ir.Keep},stencilReadMask:255,stencilWriteMask:o?255:0},colorStates:[{format:this._colorFormat,writeMask:i?Go.All:0}]},this._shaderManager.getCompiledShaders("clearQuad"))),C=b.getBindGroupLayout(0),M=this._bufferManager.createBuffer(4*4,Fi.CopyDst|Fi.Uniform);if(i){var N=new Float32Array([i.r,i.g,i.b,i.a]);this._bufferManager.setSubData(M,0,N)}var D=this._device.createBindGroup({layout:C,entries:[{binding:0,resource:{buffer:M.underlyingResource}}]});this._currentRenderPass.setStencilReference(this._clearStencilValue),this._currentRenderPass.setPipeline(b),this._currentRenderPass.setBindGroup(0,D),this._currentRenderPass.draw(4,1,0,0),this._stencilState.stencilTest&&this._getCurrentRenderPass().setStencilReference(this._stencilState.stencilFuncRef),this._bufferManager.releaseBuffer(M)}},t.prototype._endMainRenderPass=function(){this._mainRenderPassWrapper.renderPass!==null&&(this._mainRenderPassWrapper.renderPass.endPass(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main end pass")),this._debugPopGroup(0),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._mainRenderPassWrapper.renderPass===this._currentRenderPass&&(this._currentRenderPass=null),this._mainRenderPassWrapper.reset(!1))},t.prototype.restoreSingleAttachment=function(){},t.prototype.buildTextureLayout=function(e){for(var i=[],r=0;r<e.length;r++)e[r]?i.push(r+1):i.push(0);return i},t.prototype.bindAttachments=function(e){},t.prototype.bindFramebuffer=function(e,i,r,o,a,s,c){i===void 0&&(i=0),s===void 0&&(s=0),c===void 0&&(c=0);var v=e._hardwareTexture,b=v==null?void 0:v.underlyingResource;if(!v||!b){this.dbgSanityChecks&&console.error("bindFramebuffer: Trying to bind a texture that does not have a hardware texture or that has a webgpu texture empty!",e,v,b);return}this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=v,this._rttRenderPassWrapper.depthTextureFormat=this._currentRenderTarget._depthStencilTexture?so.GetWebGPUTextureFormat(-1,this._currentRenderTarget._depthStencilTexture.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:Oi.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?c*6+i:c,baseMipLevel:s,arrayLayerCount:1,aspect:qr.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:Oi.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?c*6+i:c,baseMipLevel:0,arrayLayerCount:1,aspect:qr.All},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - bindFramebuffer called - face=",i,"lodLevel=",s,"layer=",c,this._rttRenderPassWrapper.colorAttachmentViewDescriptor,this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),this._currentRenderPass=null,this._cachedViewport&&!a?this.setViewport(this._cachedViewport,r,o):(r||(r=e.width,s&&(r=r/Math.pow(2,s))),o||(o=e.height,s&&(o=o/Math.pow(2,s))),this._viewport(0,0,r,o)),this.wipeCaches()},t.prototype.unBindFramebuffer=function(e,i,r){i===void 0&&(i=!1),Qp(this._currentRenderTarget===null||this._currentRenderTarget!==null&&e===this._currentRenderTarget,"unBindFramebuffer - the texture we want to unbind is not the same than the currentRenderTarget! texture="+e+", this._currentRenderTarget="+this._currentRenderTarget);var o=this._currentRenderTarget;this._currentRenderTarget=null,r&&r(),this._currentRenderTarget=o,this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass(),e.generateMipMaps&&!i&&!e.isCube&&this._generateMipmaps(e),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments,[]),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)},t.prototype.unBindMultiColorAttachmentFramebuffer=function(e,i,r){i===void 0&&(i=!1),r&&r();var o=e[0]._attachments,a=o.length;this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass();for(var s=0;s<a;s++){var c=e[s];c.generateMipMaps&&!i&&!c.isCube&&this._generateMipmaps(c)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments,[]),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)},t.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):(this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)),this._currentRenderPass&&this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},t.prototype._setColorFormat=function(e){var i=e.colorAttachmentGPUTextures[0].format;this._cacheRenderPipeline.setColorFormat(i),this._colorFormat!==i&&(this._colorFormat=i)},t.prototype._setDepthTextureFormat=function(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)},t.prototype.setDitheringState=function(e){},t.prototype.setRasterizerState=function(e){},t.prototype.setState=function(e,i,r,o){i===void 0&&(i=0),o===void 0&&(o=!1),(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e);var a=this.cullBackFaces?1:2;(this._depthCullingState.cullFace!==a||r)&&(this._depthCullingState.cullFace=a),this.setZOffset(i);var s=o?1:2;(this._depthCullingState.frontFace!==s||r)&&(this._depthCullingState.frontFace=s)},t.prototype.setAlphaMode=function(e,i){if(i===void 0&&(i=!1),this._alphaMode!==e){switch(e){case W.a.ALPHA_DISABLE:this._alphaState.alphaBlend=!1;break;case W.a.ALPHA_PREMULTIPLIED:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_PREMULTIPLIED_PORTERDUFF:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_COMBINE:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_ONEONE:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_ADD:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_SUBTRACT:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_MULTIPLY:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_MAXIMIZED:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_INTERPOLATE:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case W.a.ALPHA_SCREENMODE:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break}i||(this.setDepthWrite(e===W.a.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(e===W.a.ALPHA_DISABLE)),this._alphaMode=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}},t.prototype.setAlphaEquation=function(e){n.prototype.setAlphaEquation.call(this,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)},t.prototype._getBindGroupsToRender=function(){var e,i=this._currentEffect._pipelineContext;i.uniformBuffer&&(this.bindUniformBufferBase(i.uniformBuffer.getBuffer(),0,"LeftOver"),i.uniformBuffer.update());for(var r=i.bindGroupsCache,o=0;o<i.shaderProcessingContext.uniformBufferNames.length;++o){var a=i.shaderProcessingContext.uniformBufferNames[o],s=this._uniformsBuffers[a].uniqueId,c=r.values[s];c||(c=new Vl,r.values[s]=c),r=c}var v=r.bindGroups;if(v)return v;v=[],r.bindGroups=v,this._counters.numBindGroupsCreation++;for(var b=i.bindGroupLayouts,o=0;o<i.shaderProcessingContext.orderedUBOsAndSamplers.length;o++){var C=i.shaderProcessingContext.orderedUBOsAndSamplers[o];if(C===void 0){var M=b[o];v[o]=this._device.createBindGroup({layout:M,entries:[]});continue}for(var N=[],D=0;D<C.length;D++){var V=i.shaderProcessingContext.orderedUBOsAndSamplers[o][D];if(V!==void 0)if(V.isSampler){var X=i.samplers[V.name];if(X){var ee=(e=i.textures[X.firstTextureName])===null||e===void 0?void 0:e.texture;if(!ee){p.a.Error('Could not create the gpu sampler "'+V.name+'" because no texture can be looked up for the name "'+X.firstTextureName+'". bindingInfo='+JSON.stringify(X)+", webgpuPipelineContext.textures="+i.textures,50);continue}N.push({binding:X.samplerBinding,resource:this._cacheSampler.getSampler(ee)})}else p.a.Error('Sampler "'+V.name+'" could not be bound. bindingDefinition='+JSON.stringify(V)+", webgpuPipelineContext.samplers="+JSON.stringify(i.samplers),50)}else if(V.isTexture){var X=i.textures[V.name];if(X){if(this.dbgSanityChecks&&X.texture===null){p.a.Error("Trying to bind a null texture! bindingDefinition="+JSON.stringify(V)+", bindingInfo="+JSON.stringify(X,function(Ae,De){return Ae==="texture"?"<no dump>":De}),50);continue}var ie=X.texture._hardwareTexture;if(this.dbgSanityChecks&&!ie.view){p.a.Error("Trying to bind a null gpu texture! bindingDefinition="+JSON.stringify(V)+", bindingInfo="+JSON.stringify(X,function(Ae,De){return Ae==="texture"?"<no dump>":De})+", isReady="+X.texture.isReady,50);continue}N.push({binding:X.textureBinding,resource:ie.view})}else p.a.Error('Texture "'+V.name+'" could not be bound. bindingDefinition='+JSON.stringify(V)+", webgpuPipelineContext.textures="+JSON.stringify(i.textures,function(Ae,De){return Ae==="texture"?"<no dump>":De}),50)}else{var ge=this._uniformsBuffers[V.name];if(ge){var pe=ge.underlyingResource;N.push({binding:D,resource:{buffer:pe,offset:0,size:ge.capacity}})}else p.a.Error('UBO "'+V.name+". bindingDefinition="+JSON.stringify(V)+", _uniformsBuffers="+JSON.stringify(this._uniformsBuffers),50)}}if(N.length>0){var M=b[o];v[o]=this._device.createBindGroup({layout:M,entries:N})}}return v},t.prototype._bindVertexInputs=function(){var e,i=this._bundleEncoder||this._getCurrentRenderPass();this._currentIndexBuffer&&i.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?Gr.Uint32:Gr.Uint16,0);for(var r=this._currentEffect._pipelineContext,o=r.shaderProcessingContext.attributeNamesFromEffect,a=0;a<o.length;a++){var s=(e=this._currentOverrideVertexBuffers&&this._currentOverrideVertexBuffers[o[a]])!==null&&e!==void 0?e:this._currentVertexBuffers[o[a]];s||(s=this._emptyVertexBuffer);var c=s.getBuffer();c&&i.setVertexBuffer(a,c.underlyingResource,s.byteOffset)}},t.prototype._setRenderBindGroups=function(e){for(var i=this._bundleEncoder||this._getCurrentRenderPass(),r=0;r<e.length;r++)i.setBindGroup(r,e[r])},t.prototype._setRenderPipeline=function(e){var i=this._bundleEncoder||this._getCurrentRenderPass(),r=this._cacheRenderPipeline.getRenderPipeline(e,this._currentEffect,this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount);i.setPipeline(r),this._bindVertexInputs();var o=this._getBindGroupsToRender();this._setRenderBindGroups(o),this._stencilState.stencilTest&&i!==this._bundleEncoder&&this._getCurrentRenderPass().setStencilReference(this._stencilState.stencilFuncRef),this._alphaState.alphaBlend&&i!==this._bundleEncoder&&this._getCurrentRenderPass().setBlendColor(this._alphaState._blendConstants),i!==this._bundleEncoder&&(this._applyViewport(i),this._applyScissor(i))},t.prototype.drawElementsType=function(e,i,r,o){o===void 0&&(o=1);var a=this._bundleEncoder||this._getCurrentRenderPass();this._setRenderPipeline(e),a.drawIndexed(r,o||1,i,0,0),this._reportDrawCall()},t.prototype.drawArraysType=function(e,i,r,o){o===void 0&&(o=1);var a=this._bundleEncoder||this._getCurrentRenderPass();this._currentIndexBuffer=null,this._setRenderPipeline(e),a.draw(r,o||1,i,0),this._reportDrawCall()},t.prototype.startRecordBundle=function(){this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:[Se.BGRA8Unorm],depthStencilFormat:Se.Depth24PlusStencil8,sampleCount:this._mainPassSampleCount})},t.prototype.stopRecordBundle=function(){var e=this._bundleEncoder.finish();return this._bundleEncoder=null,e},t.prototype.executeBundles=function(e){var i=this._getCurrentRenderPass();i.executeBundles(e)},t.prototype.dispose=function(){this._mainTexture&&this._mainTexture.destroy(),this._depthTexture&&this._depthTexture.destroy(),n.prototype.dispose.call(this)},t.prototype.getRenderWidth=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._canvas.width},t.prototype.getRenderHeight=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._canvas.height},t.prototype.getRenderingCanvas=function(){return this._canvas},t.prototype._debugPushGroup=function(e,i){if(!!this._options.enableGPUDebugMarkers)if(i===0||i===1){var r=i===0?this._renderEncoder:this._renderTargetEncoder;r.pushDebugGroup(e)}else this._currentRenderPass?this._currentRenderPass.pushDebugGroup(e):this._pendingDebugCommands.push(["push",e])},t.prototype._debugPopGroup=function(e){if(!!this._options.enableGPUDebugMarkers)if(e===0||e===1){var i=e===0?this._renderEncoder:this._renderTargetEncoder;i.popDebugGroup()}else this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null])},t.prototype._debugInsertMarker=function(e,i){if(!!this._options.enableGPUDebugMarkers)if(i===0||i===1){var r=i===0?this._renderEncoder:this._renderTargetEncoder;r.insertDebugMarker(e)}else this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e])},t.prototype._debugFlushPendingCommands=function(){for(var e=0;e<this._pendingDebugCommands.length;++e){var i=this._pendingDebugCommands[e],r=i[0],o=i[1];switch(r){case"push":this._debugPushGroup(o);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(o);break}}this._pendingDebugCommands.length=0},t.prototype.getError=function(){return 0},t.prototype.bindSamplers=function(e){},t.prototype._bindTextureDirectly=function(e,i,r,o){return r===void 0&&(r=!1),o===void 0&&(o=!1),!1},t.prototype._releaseFramebufferObjects=function(e){},t.prototype.applyStates=function(){},t.prototype.areAllEffectsReady=function(){return!0},t.prototype._executeWhenRenderingStateIsCompiled=function(e,i){i()},t.prototype._isRenderingStateCompiled=function(e){return!0},t.prototype._getUnpackAlignement=function(){return 1},t.prototype._unpackFlipY=function(e){},t.prototype._getSamplingParameters=function(e,i){throw"_getSamplingParameters is not available in WebGPU"},t.prototype.bindUniformBlock=function(e,i,r){},t.prototype.getUniforms=function(e,i){return[]},t.prototype.setIntArray=function(e,i){return!1},t.prototype.setIntArray2=function(e,i){return!1},t.prototype.setIntArray3=function(e,i){return!1},t.prototype.setIntArray4=function(e,i){return!1},t.prototype.setArray=function(e,i){return!1},t.prototype.setArray2=function(e,i){return!1},t.prototype.setArray3=function(e,i){return!1},t.prototype.setArray4=function(e,i){return!1},t.prototype.setMatrices=function(e,i){return!1},t.prototype.setMatrix3x3=function(e,i){return!1},t.prototype.setMatrix2x2=function(e,i){return!1},t.prototype.setFloat=function(e,i){return!1},t.prototype.setFloat2=function(e,i,r){return!1},t.prototype.setFloat3=function(e,i,r,o){return!1},t.prototype.setFloat4=function(e,i,r,o,a){return!1},t._glslangDefaultOptions={jsPath:"https://preview.babylonjs.com/glslang/glslang.js",wasmPath:"https://preview.babylonjs.com/glslang/glslang.wasm"},t}(W.a);function lo(n,t,e,i){var r;i===1?r=new Float32Array(t*e*4):r=new Uint32Array(t*e*4);for(var o=0;o<t;o++)for(var a=0;a<e;a++){var s=(a*t+o)*3,c=(a*t+o)*4;r[c+0]=n[s+0],r[c+1]=n[s+1],r[c+2]=n[s+2],r[c+3]=1}return r}var $l=u(683),uo=u(513),jr=u(477),c_=u(523),f_=u(457),ql="rgbdEncodePixelShader",eu=`
varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
void main(void)
{
gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);
}`;qe.a.ShadersStore[ql]=eu;var h_={name:ql,shader:eu},d_=u(625),tu=u(545),Wr=function(){function n(){}return n.GetEnvInfo=function(t){for(var e=new DataView(t.buffer,t.byteOffset,t.byteLength),i=0,r=0;r<n._MagicBytes.length;r++)if(e.getUint8(i++)!==n._MagicBytes[r])return p.a.Error("Not a babylon environment map"),null;for(var o="",a=0;a=e.getUint8(i++);)o+=String.fromCharCode(a);var s=JSON.parse(o);return s.specular&&(s.specular.specularDataPosition=i,s.specular.lodGenerationScale=s.specular.lodGenerationScale||.8),s},n.CreateEnvTextureAsync=function(t){return Object(h.b)(this,void 0,void 0,function(){var e,i,r,o,a,s,c,v,b,C,M,N,D,V,X,ee,ie,ge,v,C,pe,te,Ce,Ae,v,De,Fe,We,Pe,Ne,je,v,v,C,Be;return Object(h.e)(this,function(Je){switch(Je.label){case 0:if(e=t.getInternalTexture(),!e)return[2,Promise.reject("The cube texture is invalid.")];if(i=e.getEngine(),t.textureType!==2&&t.textureType!==1&&t.textureType!==0&&t.textureType!==0&&t.textureType!==7&&t.textureType!==-1)return[2,Promise.reject("The cube texture should allow HDR (Full Float or Half Float).")];if(r=1,!i.getCaps().textureFloatRender&&(r=2,!i.getCaps().textureHalfFloatRender))return[2,Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.")];o=e.width,a=new q.a(i),s={},i.flushFramebuffer(),c=$e.a.ILog2(e.width),v=0,Je.label=1;case 1:if(!(v<=c))return[3,9];b=Math.pow(2,c-v),C=0,Je.label=2;case 2:return C<6?[4,t.readPixels(C,v,void 0,!1)]:[3,8];case 3:if(M=Je.sent(),M&&M.byteLength===M.length){for(N=new Float32Array(M.byteLength*4),D=0;D<M.byteLength;D++)N[D]=M[D]/255,N[D]=Math.pow(N[D],2.2);M=N}return V=i.createRawTexture(M,b,b,5,!1,!0,1,null,r),[4,tu.a.EncodeTextureToRGBD(V,a,r)];case 4:return Je.sent(),[4,i._readTexturePixels(V,b,b)];case 5:return X=Je.sent(),[4,J.b.DumpDataAsync(b,b,X,"image/png",void 0,!1,!0)];case 6:ee=Je.sent(),s[v*6+C]=ee,V.dispose(),Je.label=7;case 7:return C++,[3,2];case 8:return v++,[3,1];case 9:for(a.dispose(),ie={version:1,width:o,irradiance:this._CreateEnvTextureIrradiance(t),specular:{mipmaps:[],lodGenerationScale:t.lodGenerationScale}},ge=0,v=0;v<=c;v++)for(C=0;C<6;C++)pe=s[v*6+C].byteLength,ie.specular.mipmaps.push({length:pe,position:ge}),ge+=pe;for(te=JSON.stringify(ie),Ce=new ArrayBuffer(te.length+1),Ae=new Uint8Array(Ce),v=0,De=te.length;v<De;v++)Ae[v]=te.charCodeAt(v);for(Ae[te.length]=0,Fe=n._MagicBytes.length+ge+Ce.byteLength,We=new ArrayBuffer(Fe),Pe=new Uint8Array(We),Ne=new DataView(We),je=0,v=0;v<n._MagicBytes.length;v++)Ne.setUint8(je++,n._MagicBytes[v]);for(Pe.set(new Uint8Array(Ce),je),je+=Ce.byteLength,v=0;v<=c;v++)for(C=0;C<6;C++)Be=s[v*6+C],Pe.set(new Uint8Array(Be),je),je+=Be.byteLength;return[2,We]}})})},n._CreateEnvTextureIrradiance=function(t){var e=t.sphericalPolynomial;return e==null?null:{x:[e.x.x,e.x.y,e.x.z],y:[e.y.x,e.y.y,e.y.z],z:[e.z.x,e.z.y,e.z.z],xx:[e.xx.x,e.xx.y,e.xx.z],yy:[e.yy.x,e.yy.y,e.yy.z],zz:[e.zz.x,e.zz.y,e.zz.z],yz:[e.yz.x,e.yz.y,e.yz.z],zx:[e.zx.x,e.zx.y,e.zx.z],xy:[e.xy.x,e.xy.y,e.xy.z]}},n.CreateImageDataArrayBufferViews=function(t,e){if(e.version!==1)throw new Error('Unsupported babylon environment map version "'+e.version+'"');var i=e.specular,r=$e.a.Log2(e.width);if(r=Math.round(r)+1,i.mipmaps.length!==6*r)throw new Error('Unsupported specular mipmaps number "'+i.mipmaps.length+'"');for(var o=new Array(r),a=0;a<r;a++){o[a]=new Array(6);for(var s=0;s<6;s++){var c=i.mipmaps[a*6+s];o[a][s]=new Uint8Array(t.buffer,t.byteOffset+i.specularDataPosition+c.position,c.length)}}return o},n.UploadEnvLevelsAsync=function(t,e,i){if(i.version!==1)throw new Error('Unsupported babylon environment map version "'+i.version+'"');var r=i.specular;if(!r)return Promise.resolve();t._lodGenerationScale=r.lodGenerationScale;var o=n.CreateImageDataArrayBufferViews(e,i);return n.UploadLevelsAsync(t,o)},n._OnImageReadyAsync=function(t,e,i,r,o,a,s,c,v,b,C){return new Promise(function(M,N){if(i){var D=e.createTexture(null,!0,!0,null,1,null,function(X){N(X)},t);r.getEffect().executeWhenCompiled(function(){r.onApply=function(X){X._bindTexture("textureSampler",D),X.setFloat2("scale",1,e._features.needsInvertingBitmap&&t instanceof ImageBitmap?-1:1)},!!e.scenes.length&&(e.scenes[0].postProcessManager.directRender([r],b,!0,a,s),e.restoreDefaultFramebuffer(),D.dispose(),URL.revokeObjectURL(o),M())})}else{if(e._uploadImageToTexture(C,t,a,s),c){var V=v[s];V&&e._uploadImageToTexture(V._texture,t,a,0)}M()}})},n.UploadLevelsAsync=function(t,e){var i=this;if(!J.b.IsExponentOfTwo(t.width))throw new Error("Texture size must be a power of two");var r=$e.a.ILog2(t.width)+1,o=t.getEngine(),a=!1,s=!1,c=null,v=null,b=null,C=o.getCaps();if(t.format=5,t.type=0,t.generateMipMaps=!0,t._cachedAnisotropicFilteringLevel=null,o.updateTextureSamplingMode(3,t),C.textureLOD?o._features.supportRenderAndCopyToLodForFloatTextures?C.textureHalfFloatRender&&C.textureHalfFloatLinearFiltering?(a=!0,t.type=2):C.textureFloatRender&&C.textureFloatLinearFiltering&&(a=!0,t.type=1):a=!1:(a=!1,s=!0,b={}),a)c=new ii.a("rgbdDecode","rgbdDecode",null,null,1,null,3,o,!1,void 0,t.type,void 0,null,!1),t._isRGBD=!1,t.invertY=!1,v=o.createRenderTargetCubeTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:t.type,format:5});else if(t._isRGBD=!0,t.invertY=!0,s)for(var M=3,N=t._lodGenerationScale,D=t._lodGenerationOffset,V=0;V<M;V++){var X=V/(M-1),ee=1-X,ie=D,ge=(r-1)*N+D,pe=ie+(ge-ie)*ee,te=Math.round(Math.min(Math.max(pe,0),ge)),Ce=new gt.a(o,gt.b.Temp);Ce.isCube=!0,Ce.invertY=!0,Ce.generateMipMaps=!1,o.updateTextureSamplingMode(2,Ce);var Ae=new jr.a(null);switch(Ae.isCube=!0,Ae._texture=Ce,b[te]=Ae,V){case 0:t._lodTextureLow=Ae;break;case 1:t._lodTextureMid=Ae;break;case 2:t._lodTextureHigh=Ae;break}}for(var De=[],Fe=function(Be){for(var Je=function(Xe){var Ct=e[Be][Xe],At=new Blob([Ct],{type:"image/png"}),Rt=URL.createObjectURL(At),rt=void 0;if(typeof Image=="undefined"||o._features.forceBitmapOverHTMLImageElement)rt=createImageBitmap(At,{premultiplyAlpha:"none"}).then(function(jt){return i._OnImageReadyAsync(jt,o,a,c,Rt,Xe,Be,s,b,v,t)});else{var Bt=new Image;Bt.src=Rt,rt=new Promise(function(jt,at){Bt.onload=function(){i._OnImageReadyAsync(Bt,o,a,c,Rt,Xe,Be,s,b,v,t).then(function(){return jt()}).catch(function(Lt){at(Lt)})},Bt.onerror=function(Lt){at(Lt)}})}De.push(rt)},tt=0;tt<6;tt++)Je(tt)},V=0;V<e.length;V++)Fe(V);if(e.length<r){var We=void 0,Pe=Math.pow(2,r-1-e.length),Ne=Pe*Pe*4;switch(t.type){case 0:{We=new Uint8Array(Ne);break}case 2:{We=new Uint16Array(Ne);break}case 1:{We=new Float32Array(Ne);break}}for(var V=e.length;V<r;V++)for(var je=0;je<6;je++)o._uploadArrayBufferViewToTexture(t,We,je,V)}return Promise.all(De).then(function(){v&&(o._releaseFramebufferObjects(v),o._releaseTexture(t),v._swapAndDie(t)),c&&c.dispose(),s&&(t._lodTextureHigh&&t._lodTextureHigh._texture&&(t._lodTextureHigh._texture.isReady=!0),t._lodTextureMid&&t._lodTextureMid._texture&&(t._lodTextureMid._texture.isReady=!0),t._lodTextureLow&&t._lodTextureLow._texture&&(t._lodTextureLow._texture.isReady=!0))})},n.UploadEnvSpherical=function(t,e){e.version!==1&&p.a.Warn('Unsupported babylon environment map version "'+e.version+'"');var i=e.irradiance;if(!!i){var r=new uo.b;l.e.FromArrayToRef(i.x,0,r.x),l.e.FromArrayToRef(i.y,0,r.y),l.e.FromArrayToRef(i.z,0,r.z),l.e.FromArrayToRef(i.xx,0,r.xx),l.e.FromArrayToRef(i.yy,0,r.yy),l.e.FromArrayToRef(i.zz,0,r.zz),l.e.FromArrayToRef(i.yz,0,r.yz),l.e.FromArrayToRef(i.zx,0,r.zx),l.e.FromArrayToRef(i.xy,0,r.xy),t._sphericalPolynomial=r}},n._UpdateRGBDAsync=function(t,e,i,r,o){return t._source=gt.b.CubeRawRGBD,t._bufferViewArrayArray=e,t._lodGenerationScale=r,t._lodGenerationOffset=o,t._sphericalPolynomial=i,n.UploadLevelsAsync(t,e).then(function(){t.isReady=!0})},n._MagicBytes=[134,22,135,150,246,214,150,54],n}();gt.a._UpdateRGBDAsync=Wr._UpdateRGBDAsync;var Zp=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.postProcessor=function(e,i,r,o,a){if(e=n.prototype.postProcessor.call(this,e,i,r,o,a),!r&&!a.homogeneousDepth){var s=e.lastIndexOf("}");e=e.substring(0,s),e+="gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0; }"}return e},t}($l.a),Jp=function(){function n(t){this.isAsync=!1,this.isReady=!1,this._valueCache={},this.engine=t}return n.prototype._getVertexShaderCode=function(){return null},n.prototype._getFragmentShaderCode=function(){return null},n.prototype._handlesSpectorRebuildCallback=function(t){throw new Error("Not implemented")},n.prototype._fillEffectInformation=function(t,e,i,r,o,a,s,c){var v=this.engine;if(v.supportsUniformBuffers)for(var b in e)t.bindUniformBlock(b,e[b]);var C=this.engine.getUniforms(this,i);C.forEach(function(D,V){r[i[V]]=D}),this._uniforms=r;var M;for(M=0;M<o.length;M++){var N=t.getUniform(o[M]);N==null&&(o.splice(M,1),M--)}o.forEach(function(D,V){a[D]=V}),c.push.apply(c,v.getAttributes(this,s))},n.prototype.dispose=function(){this._uniforms={}},n.prototype._cacheMatrix=function(t,e){var i=this._valueCache[t],r=e.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[t]=r,!0)},n.prototype._cacheFloat2=function(t,e,i){var r=this._valueCache[t];if(!r)return r=[e,i],this._valueCache[t]=r,!0;var o=!1;return r[0]!==e&&(r[0]=e,o=!0),r[1]!==i&&(r[1]=i,o=!0),o},n.prototype._cacheFloat3=function(t,e,i,r){var o=this._valueCache[t];if(!o)return o=[e,i,r],this._valueCache[t]=o,!0;var a=!1;return o[0]!==e&&(o[0]=e,a=!0),o[1]!==i&&(o[1]=i,a=!0),o[2]!==r&&(o[2]=r,a=!0),a},n.prototype._cacheFloat4=function(t,e,i,r,o){var a=this._valueCache[t];if(!a)return a=[e,i,r,o],this._valueCache[t]=a,!0;var s=!1;return a[0]!==e&&(a[0]=e,s=!0),a[1]!==i&&(a[1]=i,s=!0),a[2]!==r&&(a[2]=r,s=!0),a[3]!==o&&(a[3]=o,s=!0),s},n.prototype.setInt=function(t,e){var i=this._valueCache[t];i!==void 0&&i===e||this.engine.setInt(this._uniforms[t],e)&&(this._valueCache[t]=e)},n.prototype.setInt2=function(t,e,i){this._cacheFloat2(t,e,i)&&(this.engine.setInt2(this._uniforms[t],e,i)||(this._valueCache[t]=null))},n.prototype.setInt3=function(t,e,i,r){this._cacheFloat3(t,e,i,r)&&(this.engine.setInt3(this._uniforms[t],e,i,r)||(this._valueCache[t]=null))},n.prototype.setInt4=function(t,e,i,r,o){this._cacheFloat4(t,e,i,r,o)&&(this.engine.setInt4(this._uniforms[t],e,i,r,o)||(this._valueCache[t]=null))},n.prototype.setIntArray=function(t,e){this._valueCache[t]=null,this.engine.setIntArray(this._uniforms[t],e)},n.prototype.setIntArray2=function(t,e){this._valueCache[t]=null,this.engine.setIntArray2(this._uniforms[t],e)},n.prototype.setIntArray3=function(t,e){this._valueCache[t]=null,this.engine.setIntArray3(this._uniforms[t],e)},n.prototype.setIntArray4=function(t,e){this._valueCache[t]=null,this.engine.setIntArray4(this._uniforms[t],e)},n.prototype.setFloatArray=function(t,e){this._valueCache[t]=null,this.engine.setFloatArray(this._uniforms[t],e)},n.prototype.setFloatArray2=function(t,e){this._valueCache[t]=null,this.engine.setFloatArray2(this._uniforms[t],e)},n.prototype.setFloatArray3=function(t,e){this._valueCache[t]=null,this.engine.setFloatArray3(this._uniforms[t],e)},n.prototype.setFloatArray4=function(t,e){this._valueCache[t]=null,this.engine.setFloatArray4(this._uniforms[t],e)},n.prototype.setArray=function(t,e){this._valueCache[t]=null,this.engine.setArray(this._uniforms[t],e)},n.prototype.setArray2=function(t,e){this._valueCache[t]=null,this.engine.setArray2(this._uniforms[t],e)},n.prototype.setArray3=function(t,e){this._valueCache[t]=null,this.engine.setArray3(this._uniforms[t],e)},n.prototype.setArray4=function(t,e){this._valueCache[t]=null,this.engine.setArray4(this._uniforms[t],e)},n.prototype.setMatrices=function(t,e){!e||(this._valueCache[t]=null,this.engine.setMatrices(this._uniforms[t],e))},n.prototype.setMatrix=function(t,e){this._cacheMatrix(t,e)&&(this.engine.setMatrices(this._uniforms[t],e.toArray())||(this._valueCache[t]=null))},n.prototype.setMatrix3x3=function(t,e){this._valueCache[t]=null,this.engine.setMatrix3x3(this._uniforms[t],e)},n.prototype.setMatrix2x2=function(t,e){this._valueCache[t]=null,this.engine.setMatrix2x2(this._uniforms[t],e)},n.prototype.setFloat=function(t,e){var i=this._valueCache[t];i!==void 0&&i===e||this.engine.setFloat(this._uniforms[t],e)&&(this._valueCache[t]=e)},n.prototype.setBool=function(t,e){var i=this._valueCache[t];i!==void 0&&i===e||this.engine.setInt(this._uniforms[t],e?1:0)&&(this._valueCache[t]=e?1:0)},n.prototype.setVector2=function(t,e){this._cacheFloat2(t,e.x,e.y)&&(this.engine.setFloat2(this._uniforms[t],e.x,e.y)||(this._valueCache[t]=null))},n.prototype.setFloat2=function(t,e,i){this._cacheFloat2(t,e,i)&&(this.engine.setFloat2(this._uniforms[t],e,i)||(this._valueCache[t]=null))},n.prototype.setVector3=function(t,e){this._cacheFloat3(t,e.x,e.y,e.z)&&(this.engine.setFloat3(this._uniforms[t],e.x,e.y,e.z)||(this._valueCache[t]=null))},n.prototype.setFloat3=function(t,e,i,r){this._cacheFloat3(t,e,i,r)&&(this.engine.setFloat3(this._uniforms[t],e,i,r)||(this._valueCache[t]=null))},n.prototype.setVector4=function(t,e){this._cacheFloat4(t,e.x,e.y,e.z,e.w)&&(this.engine.setFloat4(this._uniforms[t],e.x,e.y,e.z,e.w)||(this._valueCache[t]=null))},n.prototype.setFloat4=function(t,e,i,r,o){this._cacheFloat4(t,e,i,r,o)&&(this.engine.setFloat4(this._uniforms[t],e,i,r,o)||(this._valueCache[t]=null))},n.prototype.setColor3=function(t,e){this._cacheFloat3(t,e.r,e.g,e.b)&&(this.engine.setFloat3(this._uniforms[t],e.r,e.g,e.b)||(this._valueCache[t]=null))},n.prototype.setColor4=function(t,e,i){this._cacheFloat4(t,e.r,e.g,e.b,i)&&(this.engine.setFloat4(this._uniforms[t],e.r,e.g,e.b,i)||(this._valueCache[t]=null))},n.prototype.setDirectColor4=function(t,e){this._cacheFloat4(t,e.r,e.g,e.b,e.a)&&(this.engine.setFloat4(this._uniforms[t],e.r,e.g,e.b,e.a)||(this._valueCache[t]=null))},n}(),iu=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t}(ns.a),ru=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getInternalTexture=function(){return this},t.prototype.getViewCount=function(){return 1},t}(gt.a),$p=function(n){Object(h.d)(t,n);function t(){var e=n.call(this,null)||this;return e._native=new _native.Engine,e.INVALID_HANDLE=65535,e._boundBuffersVertexArray=null,e._currentDepthTest=e._native.DEPTH_TEST_LEQUAL,e.homogeneousDepth=e._native.homogeneousDepth,e._webGLVersion=2,e.disableUniformBuffers=!0,e._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:512,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!0,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:1,canUseGLInstanceID:!0,canUseGLVertexID:!0},e._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,_collectUbosUpdatedInFrame:!1},J.b.Log("Babylon Native (v"+W.a.Version+") launched"),J.b.LoadScript=function(i,r,o,a){J.b.LoadFile(i,function(s){Function(s).apply(null),r&&r()},void 0,void 0,!1,function(s,c){o&&o("LoadScript Error",c)})},typeof URL=="undefined"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob=="undefined"&&(window.Blob=function(){}),e._shaderProcessor=new Zp,e}return t.prototype.getHardwareScalingLevel=function(){return this._native.getHardwareScalingLevel()},t.prototype.setHardwareScalingLevel=function(e){this._native.setHardwareScalingLevel(e)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._boundBuffersVertexArray&&this._native.deleteVertexArray(this._boundBuffersVertexArray),this._native.dispose()},t.prototype._queueNewFrame=function(e,i){return i.requestAnimationFrame&&i!==window?i.requestAnimationFrame(e):this._native.requestAnimationFrame(e),0},t.prototype._bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&this._native.unbindFramebuffer(this._currentFramebuffer),e&&this._native.bindFramebuffer(e),this._currentFramebuffer=e)},t.prototype.getHostDocument=function(){return null},t.prototype.clear=function(e,i,r,o){if(o===void 0&&(o=!1),this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._native.clear(i?e:null,r?1:void 0,o?0:void 0)},t.prototype.createIndexBuffer=function(e,i){var r=this._normalizeIndexData(e),o=new iu;if(o.references=1,o.is32Bits=r.BYTES_PER_ELEMENT===4,r.length){if(o.nativeIndexBuffer=this._native.createIndexBuffer(r,i!=null?i:!1),o.nativeVertexBuffer===this.INVALID_HANDLE)throw new Error("Could not create a native index buffer.")}else o.nativeVertexBuffer=this.INVALID_HANDLE;return o},t.prototype.createVertexBuffer=function(e,i){var r=new iu;if(r.references=1,r.nativeVertexBuffer=this._native.createVertexBuffer(ArrayBuffer.isView(e)?e:new Float32Array(e),i!=null?i:!1),r.nativeVertexBuffer===this.INVALID_HANDLE)throw new Error("Could not create a native vertex buffer.");return r},t.prototype._recordVertexArrayObject=function(e,i,r,o){r&&this._native.recordIndexBuffer(e,r.nativeIndexBuffer);for(var a=o.getAttributesNames(),s=0;s<a.length;s++){var c=o.getAttributeLocation(s);if(c>=0){var v=a[s],b=i[v];if(b){var C=b.getBuffer();C&&this._native.recordVertexBuffer(e,C.nativeVertexBuffer,c,b.byteOffset,b.byteStride,b.getSize(),this._getNativeAttribType(b.type),b.normalized)}}}},t.prototype.bindBuffers=function(e,i,r){this._boundBuffersVertexArray&&this._native.deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._native.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,i,r),this._native.bindVertexArray(this._boundBuffersVertexArray)},t.prototype.recordVertexArrayObject=function(e,i,r){var o=this._native.createVertexArray();return this._recordVertexArrayObject(o,e,i,r),o},t.prototype.bindVertexArrayObject=function(e){this._native.bindVertexArray(e)},t.prototype.releaseVertexArrayObject=function(e){this._native.deleteVertexArray(e)},t.prototype.getAttributes=function(e,i){var r=e;return this._native.getAttributes(r.nativeProgram,i)},t.prototype.drawElementsType=function(e,i,r,o){this._drawCalls.addCount(1,!1),this._native.drawIndexed(e,i,r)},t.prototype.drawArraysType=function(e,i,r,o){this._drawCalls.addCount(1,!1),this._native.draw(e,i,r)},t.prototype.createPipelineContext=function(){return new Jp(this)},t.prototype._preparePipelineContext=function(e,i,r,o,a,s,c,v,b){var C=e;o?C.nativeProgram=this.createRawShaderProgram(e,i,r,void 0,b):C.nativeProgram=this.createShaderProgram(e,i,r,v,void 0,b)},t.prototype._isRenderingStateCompiled=function(e){return!0},t.prototype._executeWhenRenderingStateIsCompiled=function(e,i){i()},t.prototype.createRawShaderProgram=function(e,i,r,o,a){throw a===void 0&&(a=null),new Error("Not Supported")},t.prototype.createShaderProgram=function(e,i,r,o,a,s){s===void 0&&(s=null),this.onBeforeShaderCompilationObservable.notifyObservers(this);var c=new zo.a(i);c.processCode(),i=c.code;var v=new zo.a(r);v.processCode(),r=v.code,i=fn.a._ConcatenateShader(i,o),r=fn.a._ConcatenateShader(r,o);var b=this._native.createProgram(i,r);return this.onAfterShaderCompilationObservable.notifyObservers(this),b},t.prototype._setProgram=function(e){this._currentProgram!==e&&(this._native.setProgram(e),this._currentProgram=e)},t.prototype._releaseEffect=function(e){},t.prototype._deletePipelineContext=function(e){},t.prototype.getUniforms=function(e,i){var r=e;return this._native.getUniforms(r.nativeProgram,i)},t.prototype.bindUniformBlock=function(e,i,r){throw new Error("Not Implemented")},t.prototype.bindSamplers=function(e){var i=e.getPipelineContext();this._setProgram(i.nativeProgram);for(var r=e.getSamplers(),o=0;o<r.length;o++){var a=e.getUniform(r[o]);a&&(this._boundUniforms[o]=a)}this._currentEffect=null},t.prototype.setMatrix=function(e,i){!e||this._native.setMatrix(e,i.toArray())},t.prototype.getRenderWidth=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._native.getRenderWidth()},t.prototype.getRenderHeight=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._native.getRenderHeight()},t.prototype.setViewport=function(e,i,r){this._cachedViewport=e,this._native.setViewPort(e.x,e.y,e.width,e.height)},t.prototype.setState=function(e,i,r,o){i===void 0&&(i=0),o===void 0&&(o=!1),this._native.setState(e,i,this.cullBackFaces,o)},t.prototype.getInputElementClientRect=function(){var e={bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth()};return e},t.prototype.setZOffset=function(e){this._native.setZOffset(e)},t.prototype.getZOffset=function(){return this._native.getZOffset()},t.prototype.setDepthBuffer=function(e){this._native.setDepthTest(e?this._currentDepthTest:this._native.DEPTH_TEST_ALWAYS)},t.prototype.getDepthWrite=function(){return this._native.getDepthWrite()},t.prototype.setDepthFunctionToGreater=function(){this._currentDepthTest=this._native.DEPTH_TEST_GREATER,this._native.setDepthTest(this._currentDepthTest)},t.prototype.setDepthFunctionToGreaterOrEqual=function(){this._currentDepthTest=this._native.DEPTH_TEST_GEQUAL,this._native.setDepthTest(this._currentDepthTest)},t.prototype.setDepthFunctionToLess=function(){this._currentDepthTest=this._native.DEPTH_TEST_LESS,this._native.setDepthTest(this._currentDepthTest)},t.prototype.setDepthFunctionToLessOrEqual=function(){this._currentDepthTest=this._native.DEPTH_TEST_LEQUAL,this._native.setDepthTest(this._currentDepthTest)},t.prototype.setDepthWrite=function(e){this._native.setDepthWrite(e)},t.prototype.setColorWrite=function(e){this._native.setColorWrite(e),this._colorWrite=e},t.prototype.getColorWrite=function(){return this._colorWrite},t.prototype.setAlphaConstants=function(e,i,r,o){throw new Error("Setting alpha blend constant color not yet implemented.")},t.prototype.setAlphaMode=function(e,i){i===void 0&&(i=!1),this._alphaMode!==e&&(e=this._getNativeAlphaMode(e),this._native.setBlendMode(e),i||this.setDepthWrite(e===0),this._alphaMode=e)},t.prototype.getAlphaMode=function(){return this._alphaMode},t.prototype.setInt=function(e,i){return e?(this._native.setInt(e,i),!0):!1},t.prototype.setIntArray=function(e,i){return e?(this._native.setIntArray(e,i),!0):!1},t.prototype.setIntArray2=function(e,i){return e?(this._native.setIntArray2(e,i),!0):!1},t.prototype.setIntArray3=function(e,i){return e?(this._native.setIntArray3(e,i),!0):!1},t.prototype.setIntArray4=function(e,i){return e?(this._native.setIntArray4(e,i),!0):!1},t.prototype.setFloatArray=function(e,i){return e?(this._native.setFloatArray(e,i),!0):!1},t.prototype.setFloatArray2=function(e,i){return e?(this._native.setFloatArray2(e,i),!0):!1},t.prototype.setFloatArray3=function(e,i){return e?(this._native.setFloatArray3(e,i),!0):!1},t.prototype.setFloatArray4=function(e,i){return e?(this._native.setFloatArray4(e,i),!0):!1},t.prototype.setArray=function(e,i){return e?(this._native.setFloatArray(e,i),!0):!1},t.prototype.setArray2=function(e,i){return e?(this._native.setFloatArray2(e,i),!0):!1},t.prototype.setArray3=function(e,i){return e?(this._native.setFloatArray3(e,i),!0):!1},t.prototype.setArray4=function(e,i){return e?(this._native.setFloatArray4(e,i),!0):!1},t.prototype.setMatrices=function(e,i){return e?(this._native.setMatrices(e,i),!0):!1},t.prototype.setMatrix3x3=function(e,i){return e?(this._native.setMatrix3x3(e,i),!0):!1},t.prototype.setMatrix2x2=function(e,i){return e?(this._native.setMatrix2x2(e,i),!0):!1},t.prototype.setFloat=function(e,i){return e?(this._native.setFloat(e,i),!0):!1},t.prototype.setFloat2=function(e,i,r){return e?(this._native.setFloat2(e,i,r),!0):!1},t.prototype.setFloat3=function(e,i,r,o){return e?(this._native.setFloat3(e,i,r,o),!0):!1},t.prototype.setFloat4=function(e,i,r,o,a){return e?(this._native.setFloat4(e,i,r,o,a),!0):!1},t.prototype.setColor3=function(e,i){return e?(this._native.setFloat3(e,i.r,i.g,i.b),!0):!1},t.prototype.setColor4=function(e,i,r){return e?(this._native.setFloat4(e,i.r,i.g,i.b,r),!0):!1},t.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilState.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},t.prototype._createTexture=function(){return this._native.createTexture()},t.prototype._deleteTexture=function(e){e&&this._native.deleteTexture(e)},t.prototype.updateDynamicTexture=function(e,i,r,o,a){o===void 0&&(o=!1);var s="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYSURBVChTY/z//z8DPsAEpXGC4aCAgQEAGGMDDWwwgqsAAAAASUVORK5CYII=";this.createTexture("data:my_image_name",!0,r,null,Ze.a.BILINEAR_SAMPLINGMODE,void 0,void 0,s,e,t.TEXTUREFORMAT_RGBA,null,void 0)},t.prototype.createRawTexture=function(e,i,r,o,a,s,c,v,b){v===void 0&&(v=null),b===void 0&&(b=0);var C=new gt.a(this,gt.b.Raw);if(C.generateMipMaps=a,C.samplingMode=c,C.invertY=s,C.baseWidth=i,C.baseHeight=r,C.width=C.baseWidth,C.height=C.baseHeight,C._compression=v,C.type=b,this.updateRawTexture(C,e,o,s,v,b),C._hardwareTexture){var M=C._hardwareTexture.underlyingResource,N=this._getNativeSamplingMode(c);this._native.setTextureSampling(M,N)}return this._internalTexturesCache.push(C),C},t.prototype.updateRawTexture=function(e,i,r,o,a,s){if(a===void 0&&(a=null),s===void 0&&(s=0),!!e){if(i&&e._hardwareTexture){var c=e._hardwareTexture.underlyingResource;this._native.loadRawTexture(c,i,e.width,e.height,this._getNativeTextureFormat(r,s),e.generateMipMaps,e.invertY)}e.isReady=!0}},t.prototype.createTexture=function(e,i,r,o,a,s,c,v,b,C,M,N,D){var V=this;a===void 0&&(a=3),s===void 0&&(s=null),c===void 0&&(c=null),v===void 0&&(v=null),b===void 0&&(b=null),C===void 0&&(C=null),M===void 0&&(M=null),e=e||"";var X=e.substr(0,5)==="data:",ee=X&&e.indexOf(";base64,")!==-1,ie=b||new gt.a(this,gt.b.Url),ge=e;this._transformTextureUrl&&!ee&&!b&&!v&&(e=this._transformTextureUrl(e));for(var pe=e.lastIndexOf("."),te=M||(pe>-1?e.substring(pe).toLowerCase():""),Ce=null,Ae=0,De=W.a._TextureLoaders;Ae<De.length;Ae++){var Fe=De[Ae];if(Fe.canLoad(te)){Ce=Fe;break}}o&&o._addPendingData(ie),ie.url=e,ie.generateMipMaps=!i,ie.samplingMode=a,ie.invertY=r,this.doNotHandleContextLost||(ie._buffer=v);var We=null;s&&!b&&(We=ie.onLoadedObservable.add(s)),b||this._internalTexturesCache.push(ie);var Pe=function(je,Be){o&&o._removePendingData(ie),e===ge?(We&&ie.onLoadedObservable.remove(We),Yt.a.UseFallbackTexture&&V.createTexture(Yt.a.FallbackTexture,i,ie.invertY,o,a,null,c,v,ie),c&&c((je||"Unknown error")+(Yt.a.UseFallbackTexture?" - Fallback texture was used":""),Be)):(p.a.Warn("Failed to load "+e+", falling back to "+ge),V.createTexture(ge,i,ie.invertY,o,a,s,c,v,ie,C,M,N,D))};if(Ce)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");var Ne=function(je){if(!ie._hardwareTexture){o&&o._removePendingData(ie);return}var Be=ie._hardwareTexture.underlyingResource;V._native.loadTexture(Be,je,!i,r,function(){ie.baseWidth=V._native.getTextureWidth(Be),ie.baseHeight=V._native.getTextureHeight(Be),ie.width=ie.baseWidth,ie.height=ie.baseHeight,ie.isReady=!0;var Je=V._getNativeSamplingMode(a);V._native.setTextureSampling(Be,Je),o&&o._removePendingData(ie),ie.onLoadedObservable.notifyObservers(ie),ie.onLoadedObservable.clear()},function(){throw new Error("Could not load a native texture.")})};if(X&&v)if(v instanceof ArrayBuffer)Ne(new Uint8Array(v));else if(ArrayBuffer.isView(v))Ne(v);else if(typeof v=="string")Ne(new Uint8Array(J.b.DecodeBase64(v)));else throw new Error("Unsupported buffer type");else ee?Ne(new Uint8Array(J.b.DecodeBase64(e))):this._loadFile(e,function(je){return Ne(new Uint8Array(je))},void 0,void 0,!0,function(je,Be){Pe("Unable to load "+(je&&je.responseURL,Be))});return ie},t.prototype._createDepthStencilTexture=function(e,i){var r=new ru(this,gt.b.Depth),o=e.width||e,a=e.height||e,s=this._native.createFramebuffer(r._hardwareTexture.underlyingResource,o,a,this._native.TEXTURE_FORMAT_RGBA8,this._native.TEXTURE_LINEAR_LINEAR,!1,!0,!1);return r._framebuffer=s,r},t.prototype._releaseFramebufferObjects=function(e){e._framebuffer&&(this._native.deleteFramebuffer(e._framebuffer),e._framebuffer=null)},t.prototype.createCubeTexture=function(e,i,r,o,a,s,c,v,b,C,M,N){var D=this;a===void 0&&(a=null),s===void 0&&(s=null),v===void 0&&(v=null),b===void 0&&(b=!1),C===void 0&&(C=0),M===void 0&&(M=0),N===void 0&&(N=null);var V=N||new gt.a(this,gt.b.Cube);V.isCube=!0,V.url=e,V.generateMipMaps=!o,V._lodGenerationScale=C,V._lodGenerationOffset=M,this._doNotHandleContextLost||(V._extension=v,V._files=r);var X=e.lastIndexOf("."),ee=v||(X>-1?e.substring(X).toLowerCase():"");if(ee===".env"){var ie=function(te){var Ce=Wr.GetEnvInfo(te);if(V.width=Ce.width,V.height=Ce.width,Wr.UploadEnvSpherical(V,Ce),Ce.version!==1)throw new Error('Unsupported babylon environment map version "'+Ce.version+'"');var Ae=Ce.specular;if(!Ae)throw new Error("Nothing else parsed so far");V._lodGenerationScale=Ae.lodGenerationScale;var De=Wr.CreateImageDataArrayBufferViews(te,Ce);V.format=5,V.type=0,V.generateMipMaps=!0,V.getEngine().updateTextureSamplingMode(Ze.a.TRILINEAR_SAMPLINGMODE,V),V._isRGBD=!0,V.invertY=!0,D._native.loadCubeTextureWithMips(V._hardwareTexture.underlyingResource,De,function(){V.isReady=!0,a&&a()},function(){throw new Error("Could not load a native cube texture.")})};if(r&&r.length===6)throw new Error("Multi-file loading not allowed on env files.");var ge=function(te,Ce){s&&te&&s(te.status+" "+te.statusText,Ce)};this._loadFile(e,function(te){return ie(new Uint8Array(te))},void 0,void 0,!0,ge)}else{if(!r||r.length!==6)throw new Error("Cannot load cubemap because 6 files were not defined");var pe=[r[0],r[3],r[1],r[4],r[2],r[5]];Promise.all(pe.map(function(te){return J.b.LoadFileAsync(te).then(function(Ce){return new Uint8Array(Ce)})})).then(function(te){return new Promise(function(Ce,Ae){D._native.loadCubeTexture(V._hardwareTexture.underlyingResource,te,!o,Ce,Ae)})}).then(function(){V.isReady=!0,a&&a()},function(te){s&&s("Failed to load cubemap: "+te.message,te)})}return this._internalTexturesCache.push(V),V},t.prototype.createRenderTargetTexture=function(e,i){var r=new wl.a;i!==void 0&&typeof i=="object"?(r.generateMipMaps=i.generateMipMaps,r.generateDepthBuffer=i.generateDepthBuffer===void 0?!0:i.generateDepthBuffer,r.generateStencilBuffer=r.generateDepthBuffer&&i.generateStencilBuffer,r.type=i.type===void 0?0:i.type,r.samplingMode=i.samplingMode===void 0?3:i.samplingMode,r.format=i.format===void 0?5:i.format):(r.generateMipMaps=i,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.type=0,r.samplingMode=3,r.format=5),(r.type===1&&!this._caps.textureFloatLinearFiltering||r.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(r.samplingMode=1);var o=new ru(this,gt.b.RenderTarget),a=e.width||e,s=e.height||e;r.type===1&&!this._caps.textureFloat&&(r.type=0,p.a.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var c=this._native.createFramebuffer(o._hardwareTexture.underlyingResource,a,s,this._getNativeTextureFormat(r.format,r.type),r.samplingMode,!!r.generateStencilBuffer,r.generateDepthBuffer,!!r.generateMipMaps);return o._framebuffer=c,o.baseWidth=a,o.baseHeight=s,o.width=a,o.height=s,o.isReady=!0,o.samples=1,o.generateMipMaps=!!r.generateMipMaps,o.samplingMode=r.samplingMode,o.type=r.type,o.format=r.format,o._generateDepthBuffer=r.generateDepthBuffer,o._generateStencilBuffer=!!r.generateStencilBuffer,this._internalTexturesCache.push(o),o},t.prototype.updateTextureSamplingMode=function(e,i){if(i._hardwareTexture){var r=this._getNativeSamplingMode(e);this._native.setTextureSampling(i._hardwareTexture.underlyingResource,r)}i.samplingMode=e},t.prototype.bindFramebuffer=function(e,i,r,o,a){if(i)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(r||o)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");e._depthStencilTexture?this._bindUnboundFramebuffer(e._depthStencilTexture._framebuffer):this._bindUnboundFramebuffer(e._framebuffer)},t.prototype.unBindFramebuffer=function(e,i,r){i===void 0&&(i=!1),i&&p.a.Warn("Disabling mipmap generation not yet supported in NativeEngine. Ignoring."),r&&r(),this._bindUnboundFramebuffer(null)},t.prototype.createDynamicVertexBuffer=function(e){return this.createVertexBuffer(e,!0)},t.prototype.updateDynamicIndexBuffer=function(e,i,r){r===void 0&&(r=0);var o=e,a=this._normalizeIndexData(i);o.is32Bits=a.BYTES_PER_ELEMENT===4,this._native.updateDynamicIndexBuffer(o.nativeIndexBuffer,a,r)},t.prototype.updateDynamicVertexBuffer=function(e,i,r,o){var a=e,s=ArrayBuffer.isView(i)?i:new Float32Array(i);this._native.updateDynamicVertexBuffer(a.nativeVertexBuffer,s,r!=null?r:0,o!=null?o:s.byteLength)},t.prototype._setTexture=function(e,i,r,o){r===void 0&&(r=!1),o===void 0&&(o=!1);var a=this._boundUniforms[e];if(!a)return!1;if(!i)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._native.setTexture(a,null)),!1;if(i.video)this._activeChannel=e,i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;var s;return o?s=i.depthStencilTexture:i.isReady()?s=i.getInternalTexture():i.isCube?s=this.emptyCubeTexture:i.is3D?s=this.emptyTexture3D:i.is2DArray?s=this.emptyTexture2DArray:s=this.emptyTexture,this._activeChannel=e,!s||!s._hardwareTexture?!1:(this._native.setTextureWrapMode(s._hardwareTexture.underlyingResource,this._getAddressMode(i.wrapU),this._getAddressMode(i.wrapV),this._getAddressMode(i.wrapR)),this._updateAnisotropicLevel(i),this._native.setTexture(a,s._hardwareTexture.underlyingResource),!0)},t.prototype._updateAnisotropicLevel=function(e){var i=e.getInternalTexture(),r=e.anisotropicFilteringLevel;!i||!i._hardwareTexture||i._cachedAnisotropicFilteringLevel!==r&&(this._native.setTextureAnisotropicLevel(i._hardwareTexture.underlyingResource,r),i._cachedAnisotropicFilteringLevel=r)},t.prototype._getAddressMode=function(e){switch(e){case 1:return this._native.ADDRESS_MODE_WRAP;case 0:return this._native.ADDRESS_MODE_CLAMP;case 2:return this._native.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+e+".")}},t.prototype._bindTexture=function(e,i){var r=this._boundUniforms[e];if(!!r&&i&&i._hardwareTexture){var o=i._hardwareTexture.underlyingResource;this._native.setTexture(r,o)}},t.prototype._deleteBuffer=function(e){e.nativeIndexBuffer&&(this._native.deleteIndexBuffer(e.nativeIndexBuffer),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._native.deleteVertexBuffer(e.nativeVertexBuffer),delete e.nativeVertexBuffer)},t.prototype.releaseEffects=function(){},t.prototype._uploadCompressedDataToTextureDirectly=function(e,i,r,o,a,s,c){throw s===void 0&&(s=0),c===void 0&&(c=0),new Error("_uploadCompressedDataToTextureDirectly not implemented.")},t.prototype._uploadDataToTextureDirectly=function(e,i,r,o){throw r===void 0&&(r=0),o===void 0&&(o=0),new Error("_uploadDataToTextureDirectly not implemented.")},t.prototype._uploadArrayBufferViewToTexture=function(e,i,r,o){throw r===void 0&&(r=0),o===void 0&&(o=0),new Error("_uploadArrayBufferViewToTexture not implemented.")},t.prototype._uploadImageToTexture=function(e,i,r,o){throw r===void 0&&(r=0),o===void 0&&(o=0),new Error("_uploadArrayBufferViewToTexture not implemented.")},t.prototype._getNativeSamplingMode=function(e){switch(e){case 1:return this._native.TEXTURE_NEAREST_NEAREST;case 2:return this._native.TEXTURE_LINEAR_LINEAR;case 3:return this._native.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return this._native.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return this._native.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return this._native.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return this._native.TEXTURE_NEAREST_LINEAR;case 8:return this._native.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return this._native.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return this._native.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return this._native.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return this._native.TEXTURE_LINEAR_NEAREST;default:throw new Error("Unsupported sampling mode: "+e+".")}},t.prototype._getNativeTextureFormat=function(e,i){if(e==4&&i==0)return this._native.TEXTURE_FORMAT_RGB8;if(e==5&&i==0)return this._native.TEXTURE_FORMAT_RGBA8;if(e==5&&i==1)return this._native.TEXTURE_FORMAT_RGBA32F;throw new Error("Unsupported texture format or type: format "+e+", type "+i+".")},t.prototype._getNativeAlphaMode=function(e){switch(e){case 0:return this._native.ALPHA_DISABLE;case 1:return this._native.ALPHA_ADD;case 2:return this._native.ALPHA_COMBINE;case 3:return this._native.ALPHA_SUBTRACT;case 4:return this._native.ALPHA_MULTIPLY;case 5:return this._native.ALPHA_MAXIMIZED;case 6:return this._native.ALPHA_ONEONE;case 7:return this._native.ALPHA_PREMULTIPLIED;case 8:return this._native.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return this._native.ALPHA_INTERPOLATE;case 10:return this._native.ALPHA_SCREENMODE;default:throw new Error("Unsupported alpha mode: "+e+".")}},t.prototype._getNativeAttribType=function(e){switch(e){case Oe.b.UNSIGNED_BYTE:return this._native.ATTRIB_TYPE_UINT8;case Oe.b.SHORT:return this._native.ATTRIB_TYPE_INT16;case Oe.b.FLOAT:return this._native.ATTRIB_TYPE_FLOAT;default:throw new Error("Unsupported attribute type: "+e+".")}},t}(W.a),qp=u(670),eg=function(){function n(){}return n.CreateAsync=function(t,e){return as.IsSupported?as.CreateAsync(t,e):W.a.IsSupported?new Promise(function(i){i(new W.a(t,void 0,e))}):new Promise(function(i){i(new Qa.a(e))})},n}(),Wo=function(){function n(){}return n.COPY=1,n.CUT=2,n.PASTE=3,n}(),tg=function(){function n(t,e){this.type=t,this.event=e}return n.GetTypeFromCharacter=function(t){var e=t;switch(e){case 67:return Wo.COPY;case 86:return Wo.PASTE;case 88:return Wo.CUT;default:return-1}},n}(),nu=u(688),Mi=u(463),ss=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.controllerType=Li.DAYDREAM,i}return t.prototype.initControllerMesh=function(e,i){var r=this;Mi.a.ImportMesh("",t.MODEL_BASE_URL,t.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},t.prototype._handleButtonChange=function(e,i,r){if(e===0){var o=this.onTriggerStateChangedObservable;o&&o.notifyObservers(i)}else p.a.Warn("Unrecognized Daydream button index: "+e)},t.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",t.MODEL_FILENAME="generic.babylon",t.GAMEPAD_ID_PREFIX="Daydream",t}(Br);Ui._ControllerFactories.push({canCreate:function(n){return n.id.indexOf(ss.GAMEPAD_ID_PREFIX)===0},create:function(n){return new ss(n)}});var ls=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i._buttonIndexToObservableNameMap=["onPadStateChangedObservable","onTriggerStateChangedObservable"],i.controllerType=Li.GEAR_VR,i._calculatedPosition=new l.e(i.hand=="left"?-.15:.15,-.5,.25),i._disableTrackPosition(i._calculatedPosition),i}return t.prototype.initControllerMesh=function(e,i){var r=this;Mi.a.ImportMesh("",t.MODEL_BASE_URL,t.MODEL_FILENAME,e,function(o){var a=new ot.a("",e);o[1].parent=a,o[1].position.z=-.15,r._defaultModel=a,r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},t.prototype._handleButtonChange=function(e,i,r){if(e<this._buttonIndexToObservableNameMap.length){var o=this._buttonIndexToObservableNameMap[e],a=this[o];a&&a.notifyObservers(i)}},t.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",t.MODEL_FILENAME="generic.babylon",t.GAMEPAD_ID_PREFIX="Gear VR",t}(Br);Ui._ControllerFactories.push({canCreate:function(n){return n.id.indexOf(ls.GAMEPAD_ID_PREFIX)===0||n.id.indexOf("Oculus Go")!==-1||n.id.indexOf("Vive Focus")!==-1},create:function(n){return new ls(n)}});var Ho=function(n){Object(h.d)(t,n);function t(e){return n.call(this,e)||this}return t.prototype.initControllerMesh=function(e,i){var r=this;Mi.a.ImportMesh("",t.MODEL_BASE_URL,t.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},t.prototype._handleButtonChange=function(e,i,r){console.log("Button id: "+e+"state: "),console.dir(i)},t.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",t.MODEL_FILENAME="generic.babylon",t}(Br);Ui._DefaultControllerFactory=function(n){return new Ho(n)};var us=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.onSecondaryTriggerStateChangedObservable=new _.c,i.onThumbRestChangedObservable=new _.c,i.controllerType=Li.OCULUS,i}return t.prototype.initControllerMesh=function(e,i){var r=this,o;this.hand==="left"?o=t.MODEL_LEFT_FILENAME:o=t.MODEL_RIGHT_FILENAME,Mi.a.ImportMesh("",t._IsQuest?t.QUEST_MODEL_BASE_URL:t.MODEL_BASE_URL,o,e,function(a){r._defaultModel=t._IsQuest?a[0]:a[1],r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},Object.defineProperty(t.prototype,"onAButtonStateChangedObservable",{get:function(){if(this.hand==="right")return this.onMainButtonStateChangedObservable;throw new Error("No A button on left hand")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBButtonStateChangedObservable",{get:function(){if(this.hand==="right")return this.onSecondaryButtonStateChangedObservable;throw new Error("No B button on left hand")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onXButtonStateChangedObservable",{get:function(){if(this.hand==="left")return this.onMainButtonStateChangedObservable;throw new Error("No X button on right hand")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onYButtonStateChangedObservable",{get:function(){if(this.hand==="left")return this.onSecondaryButtonStateChangedObservable;throw new Error("No Y button on right hand")},enumerable:!1,configurable:!0}),t.prototype._handleButtonChange=function(e,i,r){var o=i,a=this.hand==="right"?-1:1;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(o);return;case 1:!t._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[3].rotation.x=-o.value*.2,this._defaultModel.getChildren()[3].position.y=-o.value*.005,this._defaultModel.getChildren()[3].position.z=-o.value*.005),this.onTriggerStateChangedObservable.notifyObservers(o);return;case 2:!t._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[4].position.x=a*o.value*.0035),this.onSecondaryTriggerStateChangedObservable.notifyObservers(o);return;case 3:!t._IsQuest&&this._defaultModel&&(o.pressed?this._defaultModel.getChildren()[1].position.y=-.001:this._defaultModel.getChildren()[1].position.y=0),this.onMainButtonStateChangedObservable.notifyObservers(o);return;case 4:!t._IsQuest&&this._defaultModel&&(o.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),this.onSecondaryButtonStateChangedObservable.notifyObservers(o);return;case 5:this.onThumbRestChangedObservable.notifyObservers(o);return}},t.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",t.MODEL_LEFT_FILENAME="left.babylon",t.MODEL_RIGHT_FILENAME="right.babylon",t.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",t._IsQuest=!1,t}(Br);Ui._ControllerFactories.push({canCreate:function(n){return W.a.LastCreatedEngine&&W.a.LastCreatedEngine._vrDisplay&&W.a.LastCreatedEngine._vrDisplay.displayName==="Oculus Quest"&&(us._IsQuest=!0),n.id.indexOf("Oculus Touch")!==-1},create:function(n){return new us(n)}});var ou=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.controllerType=Li.VIVE,i._invertLeftStickY=!0,i}return t.prototype.initControllerMesh=function(e,i){var r=this;Mi.a.ImportMesh("",t.MODEL_BASE_URL,t.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},Object.defineProperty(t.prototype,"onLeftButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRightButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMenuButtonStateChangedObservable",{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:!1,configurable:!0}),t.prototype._handleButtonChange=function(e,i,r){var o=i;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(o);return;case 1:this._defaultModel&&(this._defaultModel.getChildren()[6].rotation.x=-o.value*.15),this.onTriggerStateChangedObservable.notifyObservers(o);return;case 2:this.onMainButtonStateChangedObservable.notifyObservers(o);return;case 3:this._defaultModel&&(o.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),this.onSecondaryButtonStateChangedObservable.notifyObservers(o);return}},t.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",t.MODEL_FILENAME="wand.babylon",t}(Br);Ui._ControllerFactories.push({canCreate:function(n){return n.id.toLowerCase().indexOf("openvr")!==-1},create:function(n){return new ou(n)}});var ig=function(){function n(){this.buttonMeshes={},this.axisMeshes={}}return n}(),ko=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i._mapping={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:qi.POINTING_POSE},i.onTrackpadChangedObservable=new _.c,i.onTrackpadValuesChangedObservable=new _.c,i.trackpad={x:0,y:0},i.controllerType=Li.WINDOWS,i._loadedMeshInfo=null,i}return Object.defineProperty(t.prototype,"onTriggerButtonStateChangedObservable",{get:function(){return this.onTriggerStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMenuButtonStateChangedObservable",{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onGripButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onThumbstickButtonStateChangedObservable",{get:function(){return this.onPadStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTouchpadButtonStateChangedObservable",{get:function(){return this.onTrackpadChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTouchpadValuesChangedObservable",{get:function(){return this.onTrackpadValuesChangedObservable},enumerable:!1,configurable:!0}),t.prototype._updateTrackpad=function(){this.browserGamepad.axes&&(this.browserGamepad.axes[2]!=this.trackpad.x||this.browserGamepad.axes[3]!=this.trackpad.y)&&(this.trackpad.x=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_X")],this.trackpad.y=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_Y")],this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad))},t.prototype.update=function(){if(n.prototype.update.call(this),this.browserGamepad.axes&&(this._updateTrackpad(),this._loadedMeshInfo))for(var e=0;e<this._mapping.axisMeshNames.length;e++)this._lerpAxisTransform(e,this.browserGamepad.axes[e])},t.prototype._handleButtonChange=function(e,i,r){var o=this._mapping.buttons[e];if(!!o){this._updateTrackpad();var a=this[this._mapping.buttonObservableNames[o]];a&&a.notifyObservers(i),this._lerpButtonTransform(o,i.value)}},t.prototype._lerpButtonTransform=function(e,i){if(!!this._loadedMeshInfo){var r=this._loadedMeshInfo.buttonMeshes[e];!r||!r.unpressed.rotationQuaternion||!r.pressed.rotationQuaternion||!r.value.rotationQuaternion||(l.b.SlerpToRef(r.unpressed.rotationQuaternion,r.pressed.rotationQuaternion,i,r.value.rotationQuaternion),l.e.LerpToRef(r.unpressed.position,r.pressed.position,i,r.value.position))}},t.prototype._lerpAxisTransform=function(e,i){if(!!this._loadedMeshInfo){var r=this._loadedMeshInfo.axisMeshes[e];if(!!r&&!(!r.min.rotationQuaternion||!r.max.rotationQuaternion||!r.value.rotationQuaternion)){var o=i*.5+.5;l.b.SlerpToRef(r.min.rotationQuaternion,r.max.rotationQuaternion,o,r.value.rotationQuaternion),l.e.LerpToRef(r.min.position,r.max.position,o,r.value.position)}}},t.prototype.initControllerMesh=function(e,i,r){var o=this;r===void 0&&(r=!1);var a,s;if(Mi.a.IsPluginForExtensionAvailable(".glb")){var c="default";if(this.id&&!r){var v=this.id.match(t.GAMEPAD_ID_PATTERN);c=v&&v[0]||c}this.hand==="left"?s=t.MODEL_LEFT_FILENAME:s=t.MODEL_RIGHT_FILENAME,a=t.MODEL_BASE_URL+c+"/"}else p.a.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models"),a=Ho.MODEL_BASE_URL,s=Ho.MODEL_FILENAME;Mi.a.ImportMesh("",a,s,e,function(b){o._loadedMeshInfo=o.processModel(e,b),!!o._loadedMeshInfo&&(o._defaultModel=o._loadedMeshInfo.rootNode,o.attachToMesh(o._defaultModel),i&&i(o._defaultModel))},null,function(b,C){p.a.Log(C),p.a.Warn("Failed to retrieve controller model from the remote server: "+a+s),r||o.initControllerMesh(b,i,!0)})},t.prototype.processModel=function(e,i){for(var r=null,o=new ot.a(this.id+" "+this.hand,e),a=null,s=0;s<i.length;s++){var c=i[s];if(!c.parent){c.isPickable=!1,a=c;break}}return a?(a.setParent(o),r=this.createMeshInfo(o)):p.a.Warn("Could not find root node in model file."),r},t.prototype.createMeshInfo=function(e){var i=new ig,r;for(i.rootNode=e,i.buttonMeshes={},i.axisMeshes={},r=0;r<this._mapping.buttons.length;r++){var o=this._mapping.buttonMeshNames[this._mapping.buttons[r]];if(!o){p.a.Log("Skipping unknown button at index: "+r+" with mapped name: "+this._mapping.buttons[r]);continue}var a=C(e,o);if(!a){p.a.Warn("Missing button mesh with name: "+o);continue}var s={index:r,value:M(a,"VALUE"),pressed:M(a,"PRESSED"),unpressed:M(a,"UNPRESSED")};s.value&&s.pressed&&s.unpressed?i.buttonMeshes[this._mapping.buttons[r]]=s:p.a.Warn("Missing button submesh under mesh with name: "+o+"(VALUE: "+!!s.value+", PRESSED: "+!!s.pressed+", UNPRESSED:"+!!s.unpressed+")")}for(r=0;r<this._mapping.axisMeshNames.length;r++){var c=this._mapping.axisMeshNames[r];if(!c){p.a.Log("Skipping unknown axis at index: "+r);continue}var v=C(e,c);if(!v){p.a.Warn("Missing axis mesh with name: "+c);continue}var b={index:r,value:M(v,"VALUE"),min:M(v,"MIN"),max:M(v,"MAX")};b.value&&b.min&&b.max?i.axisMeshes[r]=b:p.a.Warn("Missing axis submesh under mesh with name: "+c+"(VALUE: "+!!b.value+", MIN: "+!!b.min+", MAX:"+!!b.max+")")}return i.pointingPoseNode=C(e,this._mapping.pointingPoseMeshName),i.pointingPoseNode?this._pointingPoseNode=i.pointingPoseNode:p.a.Warn("Missing pointing pose mesh with name: "+this._mapping.pointingPoseMeshName),i;function C(N,D){return N.getChildren(function(V){return V.name===D},!1)[0]}function M(N,D){return N.getChildren(function(V){return V.name==D},!0)[0]}},t.prototype.getForwardRay=function(e){if(e===void 0&&(e=100),!(this._loadedMeshInfo&&this._loadedMeshInfo.pointingPoseNode))return n.prototype.getForwardRay.call(this,e);var i=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix(),r=i.getTranslation(),o=new l.e(0,0,-1),a=l.e.TransformNormal(o,i),s=l.e.Normalize(a);return new Zt.a(r,s,e)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onTrackpadChangedObservable.clear(),this.onTrackpadValuesChangedObservable.clear()},t.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",t.MODEL_LEFT_FILENAME="left.glb",t.MODEL_RIGHT_FILENAME="right.glb",t.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ",t.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/,t}(Br),rg=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i._mapping={buttons:["trigger","grip","trackpad","thumbstick","menu"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onThumbstickStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y","THUMBSTICK_X","THUMBSTICK_Y"],pointingPoseMeshName:qi.POINTING_POSE},i.thumbstickValues={x:0,y:0},i.onThumbstickStateChangedObservable=new _.c,i.onThumbstickValuesChangedObservable=new _.c,i.onTrackpadChangedObservable=i.onPadStateChangedObservable,i.onTrackpadValuesChangedObservable=i.onPadValuesChangedObservable,i}return Object.defineProperty(t.prototype,"onThumbstickButtonStateChangedObservable",{get:function(){return this.onThumbstickStateChangedObservable},enumerable:!1,configurable:!0}),t.prototype._updateTrackpad=function(){this.browserGamepad.axes&&(this.browserGamepad.axes[2]!=this.thumbstickValues.x||this.browserGamepad.axes[3]!=this.thumbstickValues.y)&&(this.trackpad.x=this.browserGamepad.axes[2],this.trackpad.y=this.browserGamepad.axes[3],this.onThumbstickValuesChangedObservable.notifyObservers(this.trackpad))},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onThumbstickStateChangedObservable.clear(),this.onThumbstickValuesChangedObservable.clear()},t}(ko);Ui._ControllerFactories.push({canCreate:function(n){return n.id.indexOf(ko.GAMEPAD_ID_PREFIX)===0},create:function(n){return new ko(n)}});var Xo=u(573),co=u(495),rr=u(471),Xi=u(461),fo=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){i===void 0&&(i=m.a.Gray()),r===void 0&&(r=Xi.a.DefaultUtilityLayer),o===void 0&&(o=null),a===void 0&&(a=1);var s,c,v,b,C,M,N,D=n.call(this,r)||this;D._pointerObserver=null,D.snapDistance=0,D.onSnapObservable=new _.c,D.uniformScaling=!1,D.sensitivity=1,D._isEnabled=!0,D._parent=null,D._dragging=!1,D._tmpVector=new l.e,D._tmpMatrix=new l.a,D._tmpMatrix2=new l.a,D._parent=o,D._coloredMaterial=new Gt.a("",r.utilityLayerScene),D._coloredMaterial.diffuseColor=i,D._coloredMaterial.specularColor=i.subtract(new m.a(.1,.1,.1)),D._hoverMaterial=new Gt.a("",r.utilityLayerScene),D._hoverMaterial.diffuseColor=m.a.Yellow(),D._disableMaterial=new Gt.a("",r.utilityLayerScene),D._disableMaterial.diffuseColor=m.a.Gray(),D._disableMaterial.alpha=.4,D._gizmoMesh=new ot.a("axis",r.utilityLayerScene);var V=D._createGizmoMesh(D._gizmoMesh,a),X=V.arrowMesh,ee=V.arrowTail,ie=D._createGizmoMesh(D._gizmoMesh,a+4,!0);D._gizmoMesh.lookAt(D._rootMesh.position.add(e)),D._rootMesh.addChild(D._gizmoMesh),D._gizmoMesh.scaling.scaleInPlace(1/3);var ge=X.position.clone(),pe=ee.position.clone(),te=ee.scaling.clone(),Ce=function(je){var Be=je*(3/D._rootMesh.scaling.length())*6;X.position.z+=Be/3.5,ee.scaling.y+=Be,ee.position.z=X.position.z/2},Ae=function(){X.position.set(ge.x,ge.y,ge.z),ee.position.set(pe.x,pe.y,pe.z),ee.scaling.set(te.x,te.y,te.z),D._dragging=!1};D.dragBehavior=new Ye.a({dragAxis:e}),D.dragBehavior.moveAttached=!1,D._rootMesh.addBehavior(D.dragBehavior);var De=0,Fe=new l.e,We={snapDistance:0};D.dragBehavior.onDragObservable.add(function(je){if(D.attachedNode){var Be=D.sensitivity*je.dragDistance*(D.scaleRatio*3/D._rootMesh.scaling.length()),Je=!1,tt=0;D.uniformScaling?(D.attachedNode.getWorldMatrix().decompose(Fe),Fe.normalize(),Fe.y<0&&Fe.scaleInPlace(-1)):Fe.copyFrom(e),D.snapDistance==0?Fe.scaleToRef(Be,Fe):(De+=Be,Math.abs(De)>D.snapDistance?(tt=Math.floor(Math.abs(De)/D.snapDistance),De<0&&(tt*=-1),De=De%D.snapDistance,Fe.scaleToRef(D.snapDistance*tt,Fe),Je=!0):Fe.scaleInPlace(0)),l.a.ScalingToRef(1+Fe.x,1+Fe.y,1+Fe.z,D._tmpMatrix2),D._tmpMatrix2.multiplyToRef(D.attachedNode.getWorldMatrix(),D._tmpMatrix),D._tmpMatrix.decompose(D._tmpVector);var Xe=1e5;Math.abs(D._tmpVector.x)<Xe&&Math.abs(D._tmpVector.y)<Xe&&Math.abs(D._tmpVector.z)<Xe&&D.attachedNode.getWorldMatrix().copyFrom(D._tmpMatrix),Je&&(We.snapDistance=D.snapDistance*tt,D.onSnapObservable.notifyObservers(We)),D._matrixChanged()}}),D.dragBehavior.onDragStartObservable.add(function(){D._dragging=!0}),D.dragBehavior.onDragObservable.add(function(je){return Ce(je.dragDistance)}),D.dragBehavior.onDragEndObservable.add(Ae),(v=(c=(s=o==null?void 0:o.uniformScaleGizmo)===null||s===void 0?void 0:s.dragBehavior)===null||c===void 0?void 0:c.onDragObservable)===null||v===void 0||v.add(function(je){return Ce(je.delta.y)}),(M=(C=(b=o==null?void 0:o.uniformScaleGizmo)===null||b===void 0?void 0:b.dragBehavior)===null||C===void 0?void 0:C.onDragEndObservable)===null||M===void 0||M.add(Ae);var Pe={gizmoMeshes:[X,ee],colliderMeshes:[ie.arrowMesh,ie.arrowTail],material:D._coloredMaterial,hoverMaterial:D._hoverMaterial,disableMaterial:D._disableMaterial,active:!1};(N=D._parent)===null||N===void 0||N.addToAxisCache(D._gizmoMesh,Pe),D._pointerObserver=r.utilityLayerScene.onPointerObservable.add(function(je){var Be;if(!D._customMeshSet&&(D._isHovered=Pe.colliderMeshes.indexOf((Be=je==null?void 0:je.pickInfo)===null||Be===void 0?void 0:Be.pickedMesh)!=-1,!D._parent)){var Je=D._isHovered||D._dragging?D._hoverMaterial:D._coloredMaterial;Pe.gizmoMeshes.forEach(function(tt){tt.material=Je,tt.color&&(tt.color=Je.diffuseColor)})}});var Ne=r._getSharedGizmoLight();return Ne.includedOnlyMeshes=Ne.includedOnlyMeshes.concat(D._rootMesh.getChildMeshes()),D}return t.prototype._createGizmoMesh=function(e,i,r){r===void 0&&(r=!1);var o=co.a.CreateBox("yPosMesh",{size:.4*(1+(i-1)/4)},this.gizmoLayer.utilityLayerScene),a=Tr.a.CreateCylinder("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},this.gizmoLayer.utilityLayerScene);return o.scaling.scaleInPlace(.1),o.material=this._coloredMaterial,o.rotation.x=Math.PI/2,o.position.z+=.3,a.material=this._coloredMaterial,a.position.z+=.275/2,a.rotation.x=Math.PI/2,r&&(o.visibility=0,a.visibility=0),e.addChild(o),e.addChild(a),{arrowMesh:o,arrowTail:a}},t.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()}),n.prototype.dispose.call(this)},t.prototype.setCustomMesh=function(e,i){var r=this;i===void 0&&(i=!1),n.prototype.setCustomMesh.call(this,e),i&&(this._rootMesh.getChildMeshes().forEach(function(o){o.material=r._coloredMaterial,o.color&&(o.color=r._coloredMaterial.diffuseColor)}),this._customMeshSet=!1)},t}(rr.a),nr=u(470),Bi=u(493),ho=u(515),au=function(n){Object(h.d)(t,n);function t(e,i){e===void 0&&(e=m.a.Gray()),i===void 0&&(i=Xi.a.DefaultKeepDepthUtilityLayer);var r=n.call(this,i)||this;r._boundingDimensions=new l.e(1,1,1),r._renderObserver=null,r._pointerObserver=null,r._scaleDragSpeed=.2,r._tmpQuaternion=new l.b,r._tmpVector=new l.e(0,0,0),r._tmpRotationMatrix=new l.a,r.ignoreChildren=!1,r.includeChildPredicate=null,r.rotationSphereSize=.1,r.scaleBoxSize=.1,r.fixedDragMeshScreenSize=!1,r.fixedDragMeshBoundsSize=!1,r.fixedDragMeshScreenSizeDistanceFactor=10,r.onDragStartObservable=new _.c,r.onScaleBoxDragObservable=new _.c,r.onScaleBoxDragEndObservable=new _.c,r.onRotationSphereDragObservable=new _.c,r.onRotationSphereDragEndObservable=new _.c,r.scalePivot=null,r._axisFactor=new l.e(1,1,1),r._existingMeshScale=new l.e,r._dragMesh=null,r.pointerDragBehavior=new Ye.a,r.updateScale=!1,r._anchorMesh=new Ue.a("anchor",i.utilityLayerScene),r.coloredMaterial=new Gt.a("",i.utilityLayerScene),r.coloredMaterial.disableLighting=!0,r.hoverColoredMaterial=new Gt.a("",i.utilityLayerScene),r.hoverColoredMaterial.disableLighting=!0,r._lineBoundingBox=new Ue.a("",i.utilityLayerScene),r._lineBoundingBox.rotationQuaternion=new l.b;var o=[];o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,0),new l.e(r._boundingDimensions.x,0,0)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,0),new l.e(0,r._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,0),new l.e(0,0,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,0,0),new l.e(r._boundingDimensions.x,r._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,0,0),new l.e(r._boundingDimensions.x,0,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,r._boundingDimensions.y,0),new l.e(r._boundingDimensions.x,r._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,r._boundingDimensions.y,0),new l.e(0,r._boundingDimensions.y,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,r._boundingDimensions.z),new l.e(r._boundingDimensions.x,0,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,r._boundingDimensions.z),new l.e(0,r._boundingDimensions.y,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,r._boundingDimensions.y,r._boundingDimensions.z),new l.e(0,r._boundingDimensions.y,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,r._boundingDimensions.y,r._boundingDimensions.z),new l.e(r._boundingDimensions.x,0,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,r._boundingDimensions.y,r._boundingDimensions.z),new l.e(r._boundingDimensions.x,r._boundingDimensions.y,0)]},i.utilityLayerScene)),o.forEach(function(X){X.color=e,X.position.addInPlace(new l.e(-r._boundingDimensions.x/2,-r._boundingDimensions.y/2,-r._boundingDimensions.z/2)),X.isPickable=!1,r._lineBoundingBox.addChild(X)}),r._rootMesh.addChild(r._lineBoundingBox),r.setColor(e),r._rotateSpheresParent=new Ue.a("",i.utilityLayerScene),r._rotateSpheresParent.rotationQuaternion=new l.b;for(var a=function(X){var ee=nr.a.CreateSphere("",{diameter:1},i.utilityLayerScene);ee.rotationQuaternion=new l.b,ee.material=s.coloredMaterial,c=new Ye.a({}),c.moveAttached=!1,c.updateDragPlane=!1,ee.addBehavior(c);var ie=new l.e(1,0,0),ge=0;c.onDragStartObservable.add(function(){ie.copyFrom(ee.forward),ge=0}),c.onDragObservable.add(function(pe){if(r.onRotationSphereDragObservable.notifyObservers({}),r.attachedMesh){var te=r.attachedMesh.parent;if(te&&te.scaling&&te.scaling.isNonUniformWithinEpsilon(.001)){p.a.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");return}fe.a._RemoveAndStorePivotPoint(r.attachedMesh);var Ce=ie,Ae=pe.dragPlaneNormal.scale(l.e.Dot(pe.dragPlaneNormal,Ce)),De=Ce.subtract(Ae).normalizeToNew(),Fe=l.e.Dot(De,pe.delta)<0?Math.abs(pe.delta.length()):-Math.abs(pe.delta.length());Fe=Fe/r._boundingDimensions.length()*r._anchorMesh.scaling.length(),r.attachedMesh.rotationQuaternion||(r.attachedMesh.rotationQuaternion=l.b.RotationYawPitchRoll(r.attachedMesh.rotation.y,r.attachedMesh.rotation.x,r.attachedMesh.rotation.z)),r._anchorMesh.rotationQuaternion||(r._anchorMesh.rotationQuaternion=l.b.RotationYawPitchRoll(r._anchorMesh.rotation.y,r._anchorMesh.rotation.x,r._anchorMesh.rotation.z)),ge+=Fe,Math.abs(ge)<=2*Math.PI&&(X>=8?l.b.RotationYawPitchRollToRef(0,0,Fe,r._tmpQuaternion):X>=4?l.b.RotationYawPitchRollToRef(Fe,0,0,r._tmpQuaternion):l.b.RotationYawPitchRollToRef(0,Fe,0,r._tmpQuaternion),r._anchorMesh.addChild(r.attachedMesh),r._anchorMesh.rotationQuaternion.multiplyToRef(r._tmpQuaternion,r._anchorMesh.rotationQuaternion),r._anchorMesh.removeChild(r.attachedMesh),r.attachedMesh.setParent(te)),r.updateBoundingBox(),fe.a._RestorePivotPoint(r.attachedMesh)}r._updateDummy()}),c.onDragStartObservable.add(function(){r.onDragStartObservable.notifyObservers({}),r._selectNode(ee)}),c.onDragEndObservable.add(function(){r.onRotationSphereDragEndObservable.notifyObservers({}),r._selectNode(null),r._updateDummy()}),s._rotateSpheresParent.addChild(ee)},s=this,c,v=0;v<12;v++)a(v);r._rootMesh.addChild(r._rotateSpheresParent),r._scaleBoxesParent=new Ue.a("",i.utilityLayerScene),r._scaleBoxesParent.rotationQuaternion=new l.b;for(var b=0;b<3;b++)for(var C=0;C<3;C++)for(var M=function(){var ee=(b===1?1:0)+(C===1?1:0)+(D===1?1:0);if(ee===1||ee===3)return"continue";var ie=co.a.CreateBox("",{size:1},i.utilityLayerScene);ie.material=N.coloredMaterial,ie.metadata=ee===2;var ge=new l.e(b-1,C-1,D-1).normalize();c=new Ye.a({dragAxis:ge}),c.updateDragPlane=!1,c.moveAttached=!1,ie.addBehavior(c),c.onDragObservable.add(function(pe){if(r.onScaleBoxDragObservable.notifyObservers({}),r.attachedMesh){var te=r.attachedMesh.parent;if(te&&te.scaling&&te.scaling.isNonUniformWithinEpsilon(.001)){p.a.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");return}fe.a._RemoveAndStorePivotPoint(r.attachedMesh);var Ce=pe.dragDistance/r._boundingDimensions.length()*r._anchorMesh.scaling.length(),Ae=new l.e(Ce,Ce,Ce);ee===2&&(Ae.x*=Math.abs(ge.x),Ae.y*=Math.abs(ge.y),Ae.z*=Math.abs(ge.z)),Ae.scaleInPlace(r._scaleDragSpeed),Ae.multiplyInPlace(r._axisFactor),r.updateBoundingBox(),r.scalePivot?(r.attachedMesh.getWorldMatrix().getRotationMatrixToRef(r._tmpRotationMatrix),r._boundingDimensions.scaleToRef(.5,r._tmpVector),l.e.TransformCoordinatesToRef(r._tmpVector,r._tmpRotationMatrix,r._tmpVector),r._anchorMesh.position.subtractInPlace(r._tmpVector),r._boundingDimensions.multiplyToRef(r.scalePivot,r._tmpVector),l.e.TransformCoordinatesToRef(r._tmpVector,r._tmpRotationMatrix,r._tmpVector),r._anchorMesh.position.addInPlace(r._tmpVector)):(ie.absolutePosition.subtractToRef(r._anchorMesh.position,r._tmpVector),r._anchorMesh.position.subtractInPlace(r._tmpVector)),r._anchorMesh.addChild(r.attachedMesh),r._anchorMesh.scaling.addInPlace(Ae),(r._anchorMesh.scaling.x<0||r._anchorMesh.scaling.y<0||r._anchorMesh.scaling.z<0)&&r._anchorMesh.scaling.subtractInPlace(Ae),r._anchorMesh.removeChild(r.attachedMesh),r.attachedMesh.setParent(te),fe.a._RestorePivotPoint(r.attachedMesh)}r._updateDummy()}),c.onDragStartObservable.add(function(){r.onDragStartObservable.notifyObservers({}),r._selectNode(ie)}),c.onDragEndObservable.add(function(){r.onScaleBoxDragEndObservable.notifyObservers({}),r._selectNode(null),r._updateDummy()}),N._scaleBoxesParent.addChild(ie)},N=this,c,D=0;D<3;D++)M();r._rootMesh.addChild(r._scaleBoxesParent);var V=new Array;return r._pointerObserver=i.utilityLayerScene.onPointerObservable.add(function(X){V[X.event.pointerId]?X.pickInfo&&X.pickInfo.pickedMesh!=V[X.event.pointerId]&&(V[X.event.pointerId].material=r.coloredMaterial,delete V[X.event.pointerId]):r._rotateSpheresParent.getChildMeshes().concat(r._scaleBoxesParent.getChildMeshes()).forEach(function(ee){X.pickInfo&&X.pickInfo.pickedMesh==ee&&(V[X.event.pointerId]=ee,ee.material=r.hoverColoredMaterial)})}),r._renderObserver=r.gizmoLayer.originalScene.onBeforeRenderObservable.add(function(){r.attachedMesh&&!r._existingMeshScale.equals(r.attachedMesh.scaling)?r.updateBoundingBox():(r.fixedDragMeshScreenSize||r.fixedDragMeshBoundsSize)&&(r._updateRotationSpheres(),r._updateScaleBoxes()),r._dragMesh&&r.attachedMesh&&r.pointerDragBehavior.dragging&&(r._lineBoundingBox.position.rotateByQuaternionToRef(r._rootMesh.rotationQuaternion,r._tmpVector),r.attachedMesh.setAbsolutePosition(r._dragMesh.position.add(r._tmpVector.scale(-1))))}),r.updateBoundingBox(),r}return Object.defineProperty(t.prototype,"axisFactor",{get:function(){return this._axisFactor},set:function(e){this._axisFactor=e;for(var i=this._scaleBoxesParent.getChildMeshes(),r=0,o=0;o<3;o++)for(var a=0;a<3;a++)for(var s=0;s<3;s++){var c=(o===1?1:0)+(a===1?1:0)+(s===1?1:0);if(!(c===1||c===3)){if(i[r]){var v=new l.e(o-1,a-1,s-1);v.multiplyInPlace(this._axisFactor),i[r].setEnabled(v.lengthSquared()>ho.a)}r++}}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaleDragSpeed",{get:function(){return this._scaleDragSpeed},set:function(e){this._scaleDragSpeed=e},enumerable:!1,configurable:!0}),t.prototype.setColor=function(e){this.coloredMaterial.emissiveColor=e,this.hoverColoredMaterial.emissiveColor=e.clone().add(new m.a(.3,.3,.3)),this._lineBoundingBox.getChildren().forEach(function(i){i.color&&(i.color=e)})},t.prototype._attachedNodeChanged=function(e){var i=this;if(e){this._anchorMesh.scaling.setAll(1),fe.a._RemoveAndStorePivotPoint(e);var r=e.parent;this._anchorMesh.addChild(e),this._anchorMesh.removeChild(e),e.setParent(r),fe.a._RestorePivotPoint(e),this.updateBoundingBox(),e.getChildMeshes(!1).forEach(function(o){o.markAsDirty("scaling")}),this.gizmoLayer.utilityLayerScene.onAfterRenderObservable.addOnce(function(){i._updateDummy()})}},t.prototype._selectNode=function(e){this._rotateSpheresParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach(function(i){i.isVisible=!e||i==e})},t.prototype.updateBoundingBox=function(){if(this.attachedMesh){fe.a._RemoveAndStorePivotPoint(this.attachedMesh);var e=this.attachedMesh.parent;this.attachedMesh.setParent(null);var i=null;this.attachedMesh.skeleton&&(i=this.attachedMesh.skeleton.overrideMesh,this.attachedMesh.skeleton.overrideMesh=null),this._update(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=l.b.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=l.b.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),this._anchorMesh.rotationQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpVector.copyFrom(this.attachedMesh.position),this.attachedMesh.rotationQuaternion.set(0,0,0,1),this.attachedMesh.position.set(0,0,0);var r=this.attachedMesh.getHierarchyBoundingVectors(!this.ignoreChildren,this.includeChildPredicate);r.max.subtractToRef(r.min,this._boundingDimensions),this._lineBoundingBox.scaling.copyFrom(this._boundingDimensions),this._lineBoundingBox.position.set((r.max.x+r.min.x)/2,(r.max.y+r.min.y)/2,(r.max.z+r.min.z)/2),this._rotateSpheresParent.position.copyFrom(this._lineBoundingBox.position),this._scaleBoxesParent.position.copyFrom(this._lineBoundingBox.position),this._lineBoundingBox.computeWorldMatrix(),this._anchorMesh.position.copyFrom(this._lineBoundingBox.absolutePosition),this.attachedMesh.rotationQuaternion.copyFrom(this._tmpQuaternion),this.attachedMesh.position.copyFrom(this._tmpVector),this.attachedMesh.setParent(e),this.attachedMesh.skeleton&&(this.attachedMesh.skeleton.overrideMesh=i)}this._updateRotationSpheres(),this._updateScaleBoxes(),this.attachedMesh&&(this._existingMeshScale.copyFrom(this.attachedMesh.scaling),fe.a._RestorePivotPoint(this.attachedMesh))},t.prototype._updateRotationSpheres=function(){for(var e=this._rotateSpheresParent.getChildMeshes(),i=0;i<3;i++)for(var r=0;r<2;r++)for(var o=0;o<2;o++){var a=i*4+r*2+o;if(i==0&&(e[a].position.set(this._boundingDimensions.x/2,this._boundingDimensions.y*r,this._boundingDimensions.z*o),e[a].position.addInPlace(new l.e(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[a].lookAt(l.e.Cross(e[a].position.normalizeToNew(),l.e.Right()).normalizeToNew().add(e[a].position))),i==1&&(e[a].position.set(this._boundingDimensions.x*r,this._boundingDimensions.y/2,this._boundingDimensions.z*o),e[a].position.addInPlace(new l.e(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[a].lookAt(l.e.Cross(e[a].position.normalizeToNew(),l.e.Up()).normalizeToNew().add(e[a].position))),i==2&&(e[a].position.set(this._boundingDimensions.x*r,this._boundingDimensions.y*o,this._boundingDimensions.z/2),e[a].position.addInPlace(new l.e(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[a].lookAt(l.e.Cross(e[a].position.normalizeToNew(),l.e.Forward()).normalizeToNew().add(e[a].position))),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[a].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);var s=this.rotationSphereSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[a].scaling.set(s,s,s)}else this.fixedDragMeshBoundsSize?e[a].scaling.set(this.rotationSphereSize*this._boundingDimensions.x,this.rotationSphereSize*this._boundingDimensions.y,this.rotationSphereSize*this._boundingDimensions.z):e[a].scaling.set(this.rotationSphereSize,this.rotationSphereSize,this.rotationSphereSize)}},t.prototype._updateScaleBoxes=function(){for(var e=this._scaleBoxesParent.getChildMeshes(),i=0,r=0;r<3;r++)for(var o=0;o<3;o++)for(var a=0;a<3;a++){var s=(r===1?1:0)+(o===1?1:0)+(a===1?1:0);if(!(s===1||s===3)){if(e[i])if(e[i].position.set(this._boundingDimensions.x*(r/2),this._boundingDimensions.y*(o/2),this._boundingDimensions.z*(a/2)),e[i].position.addInPlace(new l.e(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[i].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);var c=this.scaleBoxSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[i].scaling.set(c,c,c)}else this.fixedDragMeshBoundsSize?e[i].scaling.set(this.scaleBoxSize*this._boundingDimensions.x,this.scaleBoxSize*this._boundingDimensions.y,this.scaleBoxSize*this._boundingDimensions.z):e[i].scaling.set(this.scaleBoxSize,this.scaleBoxSize,this.scaleBoxSize);i++}}},t.prototype.setEnabledRotationAxis=function(e){this._rotateSpheresParent.getChildMeshes().forEach(function(i,r){r<4?i.setEnabled(e.indexOf("x")!=-1):r<8?i.setEnabled(e.indexOf("y")!=-1):i.setEnabled(e.indexOf("z")!=-1)})},t.prototype.setEnabledScaling=function(e,i){i===void 0&&(i=!1),this._scaleBoxesParent.getChildMeshes().forEach(function(r,o){var a=e;i&&r.metadata===!0&&(a=!1),r.setEnabled(a)})},t.prototype._updateDummy=function(){this._dragMesh&&(this._dragMesh.position.copyFrom(this._lineBoundingBox.getAbsolutePosition()),this._dragMesh.scaling.copyFrom(this._lineBoundingBox.scaling),this._dragMesh.rotationQuaternion.copyFrom(this._rootMesh.rotationQuaternion))},t.prototype.enableDragBehavior=function(){this._dragMesh=ot.a.CreateBox("dummy",1,this.gizmoLayer.utilityLayerScene),this._dragMesh.visibility=0,this._dragMesh.rotationQuaternion=new l.b,this.pointerDragBehavior.useObjectOrientationForDragging=!1,this._dragMesh.addBehavior(this.pointerDragBehavior)},t.prototype.dispose=function(){this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.gizmoLayer.originalScene.onBeforeRenderObservable.remove(this._renderObserver),this._lineBoundingBox.dispose(),this._rotateSpheresParent.dispose(),this._scaleBoxesParent.dispose(),this._dragMesh&&this._dragMesh.dispose(),n.prototype.dispose.call(this)},t.MakeNotPickableAndWrapInBoundingBox=function(e){var i=function(c){c.isPickable=!1,c.getChildMeshes().forEach(function(v){i(v)})};i(e),e.rotationQuaternion||(e.rotationQuaternion=l.b.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z));var r=e.position.clone(),o=e.rotationQuaternion.clone();e.rotationQuaternion.set(0,0,0,1),e.position.set(0,0,0);var a=co.a.CreateBox("box",{size:1},e.getScene()),s=e.getHierarchyBoundingVectors();return s.max.subtractToRef(s.min,a.scaling),a.scaling.y===0&&(a.scaling.y=ho.a),a.scaling.x===0&&(a.scaling.x=ho.a),a.scaling.z===0&&(a.scaling.z=ho.a),a.position.set((s.max.x+s.min.x)/2,(s.max.y+s.min.y)/2,(s.max.z+s.min.z)/2),e.addChild(a),e.rotationQuaternion.copyFrom(o),e.position.copyFrom(r),e.removeChild(a),a.addChild(e),a.visibility=0,a},t.prototype.setCustomMesh=function(e){p.a.Error("Custom meshes are not supported on this gizmo")},t}(rr.a),Tn=u(509),Yo=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){i===void 0&&(i=m.a.Gray()),r===void 0&&(r=Xi.a.DefaultUtilityLayer),o===void 0&&(o=32),a===void 0&&(a=null),s===void 0&&(s=!1),c===void 0&&(c=1);var v,b=n.call(this,r)||this;b._pointerObserver=null,b.snapDistance=0,b.onSnapObservable=new _.c,b._isEnabled=!0,b._parent=null,b._dragging=!1,b._angles=new l.e,b._parent=a,b._coloredMaterial=new Gt.a("",r.utilityLayerScene),b._coloredMaterial.diffuseColor=i,b._coloredMaterial.specularColor=i.subtract(new m.a(.1,.1,.1)),b._hoverMaterial=new Gt.a("",r.utilityLayerScene),b._hoverMaterial.diffuseColor=m.a.Yellow(),b._disableMaterial=new Gt.a("",r.utilityLayerScene),b._disableMaterial.diffuseColor=m.a.Gray(),b._disableMaterial.alpha=.4,b._gizmoMesh=new ot.a("",r.utilityLayerScene);var C=b._createGizmoMesh(b._gizmoMesh,c,o),M=C.rotationMesh,N=C.collider;b._rotationDisplayPlane=ot.a.CreatePlane("rotationDisplay",.6,b.gizmoLayer.utilityLayerScene,!1),b._rotationDisplayPlane.rotation.z=Math.PI*.5,b._rotationDisplayPlane.parent=b._gizmoMesh,b._rotationDisplayPlane.setEnabled(!1),qe.a.ShadersStore.rotationGizmoVertexShader=t._rotationGizmoVertexShader,qe.a.ShadersStore.rotationGizmoFragmentShader=t._rotationGizmoFragmentShader,b._rotationShaderMaterial=new Tn.a("shader",b.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles"]}),b._rotationShaderMaterial.backFaceCulling=!1,b._rotationDisplayPlane.material=b._rotationShaderMaterial,b._rotationDisplayPlane.visibility=.999,b._gizmoMesh.lookAt(b._rootMesh.position.add(e)),b._rootMesh.addChild(b._gizmoMesh),b._gizmoMesh.scaling.scaleInPlace(1/3),b.dragBehavior=new Ye.a({dragPlaneNormal:e}),b.dragBehavior.moveAttached=!1,b.dragBehavior.maxDragAngle=Math.PI*9/20,b.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,b._rootMesh.addBehavior(b.dragBehavior);var D=new l.e,V=new l.a,X=new l.e,ee=new l.e;b.dragBehavior.onDragStartObservable.add(function(De){b.attachedNode&&(D.copyFrom(De.dragPlanePoint),b._rotationDisplayPlane.setEnabled(!0),b._rotationDisplayPlane.getWorldMatrix().invertToRef(V),l.e.TransformCoordinatesToRef(De.dragPlanePoint,V,D),b._angles.x=Math.atan2(D.y,D.x)+Math.PI,b._angles.y=0,b._angles.z=b.updateGizmoRotationToMatchAttachedMesh?1:0,b._dragging=!0,D.copyFrom(De.dragPlanePoint),b._rotationShaderMaterial.setVector3("angles",b._angles))}),b.dragBehavior.onDragEndObservable.add(function(){b._dragging=!1,b._rotationDisplayPlane.setEnabled(!1)});var ie={snapDistance:0},ge=0,pe=new l.a,te=new l.b;b.dragBehavior.onDragObservable.add(function(De){if(b.attachedNode){var Fe=new l.e(1,1,1),We=new l.b(0,0,0,1),Pe=new l.e(0,0,0);b.attachedNode.getWorldMatrix().decompose(Fe,We,Pe);var Ne=De.dragPlanePoint.subtract(Pe).normalize(),je=D.subtract(Pe).normalize(),Be=l.e.Cross(Ne,je),Je=l.e.Dot(Ne,je),tt=Math.atan2(Be.length(),Je);if(X.copyFrom(e),ee.copyFrom(e),b.updateGizmoRotationToMatchAttachedMesh&&(We.toRotationMatrix(V),ee=l.e.TransformCoordinates(X,V)),r.utilityLayerScene.activeCamera){var Xe=r.utilityLayerScene.activeCamera.position.subtract(Pe).normalize();l.e.Dot(Xe,ee)>0&&(X.scaleInPlace(-1),ee.scaleInPlace(-1))}var Ct=l.e.Dot(ee,Be)>0;Ct&&(tt=-tt);var At=!1;if(b.snapDistance!=0)if(ge+=tt,Math.abs(ge)>b.snapDistance){var Rt=Math.floor(Math.abs(ge)/b.snapDistance);ge<0&&(Rt*=-1),ge=ge%b.snapDistance,tt=b.snapDistance*Rt,At=!0}else tt=0;var rt=Math.sin(tt/2);if(te.set(X.x*rt,X.y*rt,X.z*rt,Math.cos(tt/2)),pe.determinant()>0){var Bt=new l.e;te.toEulerAnglesToRef(Bt),l.b.RotationYawPitchRollToRef(Bt.y,-Bt.x,-Bt.z,te)}b.updateGizmoRotationToMatchAttachedMesh?We.multiplyToRef(te,We):te.multiplyToRef(We,We),b.attachedNode.getWorldMatrix().copyFrom(l.a.Compose(Fe,We,Pe)),D.copyFrom(De.dragPlanePoint),At&&(ie.snapDistance=tt,b.onSnapObservable.notifyObservers(ie)),b._angles.y+=tt,b._rotationShaderMaterial.setVector3("angles",b._angles),b._matrixChanged()}});var Ce=r._getSharedGizmoLight();Ce.includedOnlyMeshes=Ce.includedOnlyMeshes.concat(b._rootMesh.getChildMeshes(!1));var Ae={colliderMeshes:[N],gizmoMeshes:[M],material:b._coloredMaterial,hoverMaterial:b._hoverMaterial,disableMaterial:b._disableMaterial,active:!1};return(v=b._parent)===null||v===void 0||v.addToAxisCache(b._gizmoMesh,Ae),b._pointerObserver=r.utilityLayerScene.onPointerObservable.add(function(De){var Fe;if(!b._customMeshSet&&(b._isHovered=Ae.colliderMeshes.indexOf((Fe=De==null?void 0:De.pickInfo)===null||Fe===void 0?void 0:Fe.pickedMesh)!=-1,!b._parent)){var We=b._isHovered||b._dragging?b._hoverMaterial:b._coloredMaterial;Ae.gizmoMeshes.forEach(function(Pe){Pe.material=We,Pe.color&&(Pe.color=We.diffuseColor)})}}),b}return t.prototype._createGizmoMesh=function(e,i,r){var o=ot.a.CreateTorus("ignore",.6,.03*i,r,this.gizmoLayer.utilityLayerScene);o.visibility=0;var a=ot.a.CreateTorus("",.6,.005*i,r,this.gizmoLayer.utilityLayerScene);return a.material=this._coloredMaterial,a.rotation.x=Math.PI/2,o.rotation.x=Math.PI/2,e.addChild(a),e.addChild(o),{rotationMesh:a,collider:o}},t.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()}),n.prototype.dispose.call(this)},t._rotationGizmoVertexShader=`
        precision highp float;
        attribute vec3 position;
        attribute vec2 uv;
        uniform mat4 worldViewProjection;
        varying vec3 vPosition;
        varying vec2 vUV;
        void main(void) {
            gl_Position = worldViewProjection * vec4(position, 1.0);
            vUV = uv;
        }`,t._rotationGizmoFragmentShader=`
        precision highp float;
        varying vec2 vUV;
        varying vec3 vPosition;
        uniform vec3 angles;
        #define twopi 6.283185307
        void main(void) {
            vec2 uv = vUV - vec2(0.5);
            float angle = atan(uv.y, uv.x) + 3.141592;
            float delta = gl_FrontFacing ? angles.y : -angles.y;
            float begin = angles.x - delta * angles.z;
            float start = (begin < (begin + delta)) ? begin : (begin + delta);
            float end = (begin > (begin + delta)) ? begin : (begin + delta);
            float len = sqrt(dot(uv,uv));
            float opacity = 1. - step(0.5, len);

            float base = abs(floor(start / twopi)) * twopi;
            start += base;
            end += base;

            float intensity = 0.;
            for (int i = 0; i < 5; i++)
            {
                intensity += max(step(start, angle) - step(end, angle), 0.);
                angle += twopi;
            }
            gl_FragColor = vec4(1.,1.,0., min(intensity * 0.25, 0.8)) * opacity;
        }`,t}(rr.a),su=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){e===void 0&&(e=Xi.a.DefaultUtilityLayer),i===void 0&&(i=32),r===void 0&&(r=!1),o===void 0&&(o=1);var s=n.call(this,e)||this;return s.onDragStartObservable=new _.c,s.onDragEndObservable=new _.c,s._observables=[],s._gizmoAxisCache=new Map,s.xGizmo=new Yo(new l.e(1,0,0),m.a.Red().scale(.5),e,i,s,r,o),s.yGizmo=new Yo(new l.e(0,1,0),m.a.Green().scale(.5),e,i,s,r,o),s.zGizmo=new Yo(new l.e(0,0,1),m.a.Blue().scale(.5),e,i,s,r,o),[s.xGizmo,s.yGizmo,s.zGizmo].forEach(function(c){c.dragBehavior.onDragStartObservable.add(function(){s.onDragStartObservable.notifyObservers({})}),c.dragBehavior.onDragEndObservable.add(function(){s.onDragEndObservable.notifyObservers({})})}),s.attachedMesh=null,s.attachedNode=null,a?a.addToAxisCache(s._gizmoAxisCache):rr.a.GizmoAxisPointerObserver(e,s._gizmoAxisCache),s}return Object.defineProperty(t.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),t.prototype._checkBillboardTransform=function(){this._nodeAttached&&this._nodeAttached.billboardMode&&console.log("Rotation Gizmo will not work with transforms in billboard mode.")},Object.defineProperty(t.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh},set:function(e){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"snapDistance",{get:function(){return this.xGizmo.snapDistance},set:function(e){this.xGizmo&&(this.xGizmo.snapDistance=e,this.yGizmo.snapDistance=e,this.zGizmo.snapDistance=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaleRatio",{get:function(){return this.xGizmo.scaleRatio},set:function(e){this.xGizmo&&(this.xGizmo.scaleRatio=e,this.yGizmo.scaleRatio=e,this.zGizmo.scaleRatio=e)},enumerable:!1,configurable:!0}),t.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},t.prototype.dispose=function(){var e=this;this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)})},t.prototype.setCustomMesh=function(e){p.a.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")},t}(rr.a),po=u(499),lu=u(526),Ko=function(n){Object(h.d)(t,n);function t(e,i,r,o){i===void 0&&(i=m.a.Gray()),r===void 0&&(r=Xi.a.DefaultUtilityLayer),o===void 0&&(o=null);var a,s=n.call(this,r)||this;s._pointerObserver=null,s.snapDistance=0,s.onSnapObservable=new _.c,s._isEnabled=!1,s._parent=null,s._dragging=!1,s._parent=o,s._coloredMaterial=new Gt.a("",r.utilityLayerScene),s._coloredMaterial.diffuseColor=i,s._coloredMaterial.specularColor=i.subtract(new m.a(.1,.1,.1)),s._hoverMaterial=new Gt.a("",r.utilityLayerScene),s._hoverMaterial.diffuseColor=m.a.Yellow(),s._disableMaterial=new Gt.a("",r.utilityLayerScene),s._disableMaterial.diffuseColor=m.a.Gray(),s._disableMaterial.alpha=.4,s._gizmoMesh=t._CreatePlane(r.utilityLayerScene,s._coloredMaterial),s._gizmoMesh.lookAt(s._rootMesh.position.add(e)),s._gizmoMesh.scaling.scaleInPlace(1/3),s._gizmoMesh.parent=s._rootMesh;var c=0,v=new l.e,b={snapDistance:0};s.dragBehavior=new Ye.a({dragPlaneNormal:e}),s.dragBehavior.moveAttached=!1,s._rootMesh.addBehavior(s.dragBehavior),s.dragBehavior.onDragObservable.add(function(N){if(s.attachedNode){if(s.snapDistance==0)s.attachedNode.getWorldMatrix().addTranslationFromFloats(N.delta.x,N.delta.y,N.delta.z);else if(c+=N.dragDistance,Math.abs(c)>s.snapDistance){var D=Math.floor(Math.abs(c)/s.snapDistance);c=c%s.snapDistance,N.delta.normalizeToRef(v),v.scaleInPlace(s.snapDistance*D),s.attachedNode.getWorldMatrix().addTranslationFromFloats(v.x,v.y,v.z),b.snapDistance=s.snapDistance*D,s.onSnapObservable.notifyObservers(b)}s._matrixChanged()}}),s.dragBehavior.onDragStartObservable.add(function(){s._dragging=!0}),s.dragBehavior.onDragEndObservable.add(function(){s._dragging=!1});var C=r._getSharedGizmoLight();C.includedOnlyMeshes=C.includedOnlyMeshes.concat(s._rootMesh.getChildMeshes(!1));var M={gizmoMeshes:s._gizmoMesh.getChildMeshes(),colliderMeshes:s._gizmoMesh.getChildMeshes(),material:s._coloredMaterial,hoverMaterial:s._hoverMaterial,disableMaterial:s._disableMaterial,active:!1};return(a=s._parent)===null||a===void 0||a.addToAxisCache(s._gizmoMesh,M),s._pointerObserver=r.utilityLayerScene.onPointerObservable.add(function(N){var D;if(!s._customMeshSet&&(s._isHovered=M.colliderMeshes.indexOf((D=N==null?void 0:N.pickInfo)===null||D===void 0?void 0:D.pickedMesh)!=-1,!s._parent)){var V=s._isHovered||s._dragging?s._hoverMaterial:s._coloredMaterial;M.gizmoMeshes.forEach(function(X){X.material=V})}}),s}return t._CreatePlane=function(e,i){var r=new po.a("plane",e),o=lu.a.CreatePlane("dragPlane",{width:.1375,height:.1375,sideOrientation:2},e);return o.material=i,o.parent=r,r},t.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),n.prototype.dispose.call(this),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()})},t}(rr.a),uu=function(n){Object(h.d)(t,n);function t(e,i,r){e===void 0&&(e=Xi.a.DefaultUtilityLayer),i===void 0&&(i=1);var o=n.call(this,e)||this;return o._meshAttached=null,o._nodeAttached=null,o._observables=[],o._gizmoAxisCache=new Map,o.onDragStartObservable=new _.c,o.onDragEndObservable=new _.c,o._planarGizmoEnabled=!1,o.xGizmo=new Xo.a(new l.e(1,0,0),m.a.Red().scale(.5),e,o,i),o.yGizmo=new Xo.a(new l.e(0,1,0),m.a.Green().scale(.5),e,o,i),o.zGizmo=new Xo.a(new l.e(0,0,1),m.a.Blue().scale(.5),e,o,i),o.xPlaneGizmo=new Ko(new l.e(1,0,0),m.a.Red().scale(.5),o.gizmoLayer,o),o.yPlaneGizmo=new Ko(new l.e(0,1,0),m.a.Green().scale(.5),o.gizmoLayer,o),o.zPlaneGizmo=new Ko(new l.e(0,0,1),m.a.Blue().scale(.5),o.gizmoLayer,o),[o.xGizmo,o.yGizmo,o.zGizmo,o.xPlaneGizmo,o.yPlaneGizmo,o.zPlaneGizmo].forEach(function(a){a.dragBehavior.onDragStartObservable.add(function(){o.onDragStartObservable.notifyObservers({})}),a.dragBehavior.onDragEndObservable.add(function(){o.onDragEndObservable.notifyObservers({})})}),o.attachedMesh=null,r?r.addToAxisCache(o._gizmoAxisCache):rr.a.GizmoAxisPointerObserver(e,o._gizmoAxisCache),o}return Object.defineProperty(t.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=null,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"planarGizmoEnabled",{get:function(){return this._planarGizmoEnabled},set:function(e){var i=this;this._planarGizmoEnabled=e,[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(r){r&&(r.isEnabled=e,e&&(r.attachedMesh?r.attachedMesh=i.attachedMesh:r.attachedNode=i.attachedNode))},this)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(e){this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.updateGizmoRotationToMatchAttachedMesh=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"snapDistance",{get:function(){return this._snapDistance},set:function(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.snapDistance=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.scaleRatio=e)})},enumerable:!1,configurable:!0}),t.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},t.prototype.dispose=function(){var e=this;[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&i.dispose()}),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)}),this.onDragStartObservable.clear(),this.onDragEndObservable.clear()},t.prototype.setCustomMesh=function(e){p.a.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")},t}(rr.a),cs=u(693),cu=function(n){Object(h.d)(t,n);function t(e,i,r){e===void 0&&(e=Xi.a.DefaultUtilityLayer),i===void 0&&(i=1);var o=n.call(this,e)||this;return o._meshAttached=null,o._nodeAttached=null,o._sensitivity=1,o._observables=[],o._gizmoAxisCache=new Map,o.onDragStartObservable=new _.c,o.onDragEndObservable=new _.c,o.uniformScaleGizmo=o._createUniformScaleMesh(),o.xGizmo=new fo(new l.e(1,0,0),m.a.Red().scale(.5),e,o,i),o.yGizmo=new fo(new l.e(0,1,0),m.a.Green().scale(.5),e,o,i),o.zGizmo=new fo(new l.e(0,0,1),m.a.Blue().scale(.5),e,o,i),[o.xGizmo,o.yGizmo,o.zGizmo,o.uniformScaleGizmo].forEach(function(a){a.dragBehavior.onDragStartObservable.add(function(){o.onDragStartObservable.notifyObservers({})}),a.dragBehavior.onDragEndObservable.add(function(){o.onDragEndObservable.notifyObservers({})})}),o.attachedMesh=null,o.attachedNode=null,r?r.addToAxisCache(o._gizmoAxisCache):rr.a.GizmoAxisPointerObserver(e,o._gizmoAxisCache),o}return Object.defineProperty(t.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),t.prototype._createUniformScaleMesh=function(){this._coloredMaterial=new Gt.a("",this.gizmoLayer.utilityLayerScene),this._coloredMaterial.diffuseColor=m.a.Gray(),this._hoverMaterial=new Gt.a("",this.gizmoLayer.utilityLayerScene),this._hoverMaterial.diffuseColor=m.a.Yellow(),this._disableMaterial=new Gt.a("",this.gizmoLayer.utilityLayerScene),this._disableMaterial.diffuseColor=m.a.Gray(),this._disableMaterial.alpha=.4;var e=new fo(new l.e(0,1,0),m.a.Gray().scale(.5),this.gizmoLayer,this);e.updateGizmoRotationToMatchAttachedMesh=!1,e.uniformScaling=!0,this._uniformScalingMesh=cs.a.CreatePolyhedron("uniform",{type:1},e.gizmoLayer.utilityLayerScene),this._uniformScalingMesh.scaling.scaleInPlace(.01),this._uniformScalingMesh.visibility=0,this._octahedron=cs.a.CreatePolyhedron("",{type:1},e.gizmoLayer.utilityLayerScene),this._octahedron.scaling.scaleInPlace(.007),this._uniformScalingMesh.addChild(this._octahedron),e.setCustomMesh(this._uniformScalingMesh,!0);var i=this.gizmoLayer._getSharedGizmoLight();i.includedOnlyMeshes=i.includedOnlyMeshes.concat(this._octahedron);var r={gizmoMeshes:[this._octahedron,this._uniformScalingMesh],colliderMeshes:[this._uniformScalingMesh],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1};return this.addToAxisCache(e._rootMesh,r),e},Object.defineProperty(t.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(e){e?(this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.updateGizmoRotationToMatchAttachedMesh=e)})):p.a.Warn("Setting updateGizmoRotationToMatchAttachedMesh = false on scaling gizmo is not supported.")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"snapDistance",{get:function(){return this._snapDistance},set:function(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.snapDistance=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.scaleRatio=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sensitivity",{get:function(){return this._sensitivity},set:function(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.sensitivity=e)})},enumerable:!1,configurable:!0}),t.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},t.prototype.dispose=function(){var e=this;[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&i.dispose()}),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)}),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),[this._uniformScalingMesh,this._octahedron].forEach(function(i){i&&i.dispose()}),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(i){i&&i.dispose()})},t}(rr.a),ng=function(){function n(t,e,i,r){e===void 0&&(e=1),i===void 0&&(i=Xi.a.DefaultUtilityLayer),r===void 0&&(r=Xi.a.DefaultKeepDepthUtilityLayer),this.scene=t,this.clearGizmoOnEmptyPointerEvent=!1,this.onAttachedToMeshObservable=new _.c,this.onAttachedToNodeObservable=new _.c,this._gizmosEnabled={positionGizmo:!1,rotationGizmo:!1,scaleGizmo:!1,boundingBoxGizmo:!1},this._pointerObservers=[],this._attachedMesh=null,this._attachedNode=null,this._boundingBoxColor=m.a.FromHexString("#0984e3"),this._thickness=1,this._gizmoAxisCache=new Map,this.boundingBoxDragBehavior=new ue,this.attachableMeshes=null,this.attachableNodes=null,this.usePointerToAttachGizmos=!0,this._defaultUtilityLayer=i,this._defaultKeepDepthUtilityLayer=r,this._defaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,this._thickness=e,this.gizmos={positionGizmo:null,rotationGizmo:null,scaleGizmo:null,boundingBoxGizmo:null};var o=this._attachToMeshPointerObserver(t),a=rr.a.GizmoAxisPointerObserver(this._defaultUtilityLayer,this._gizmoAxisCache);this._pointerObservers=[o,a]}return Object.defineProperty(n.prototype,"keepDepthUtilityLayer",{get:function(){return this._defaultKeepDepthUtilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"utilityLayer",{get:function(){return this._defaultUtilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isHovered",{get:function(){var t=!1;for(var e in this.gizmos){var i=this.gizmos[e];if(i&&i.isHovered){t=!0;break}}return t},enumerable:!1,configurable:!0}),n.prototype._attachToMeshPointerObserver=function(t){var e=this,i=t.onPointerObservable.add(function(r){if(!!e.usePointerToAttachGizmos&&r.type==re.a.POINTERDOWN)if(r.pickInfo&&r.pickInfo.pickedMesh){var o=r.pickInfo.pickedMesh;if(e.attachableMeshes==null)for(;o&&o.parent!=null;)o=o.parent;else{var a=!1;e.attachableMeshes.forEach(function(s){o&&(o==s||o.isDescendantOf(s))&&(o=s,a=!0)}),a||(o=null)}o instanceof Ue.a?e._attachedMesh!=o&&e.attachToMesh(o):e.clearGizmoOnEmptyPointerEvent&&e.attachToMesh(null)}else e.clearGizmoOnEmptyPointerEvent&&e.attachToMesh(null)});return i},n.prototype.attachToMesh=function(t){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=t,this._attachedNode=null;for(var e in this.gizmos){var i=this.gizmos[e];i&&this._gizmosEnabled[e]&&(i.attachedMesh=t)}this.boundingBoxGizmoEnabled&&this._attachedMesh&&this._attachedMesh.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToMeshObservable.notifyObservers(t)},n.prototype.attachToNode=function(t){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=null,this._attachedNode=t;for(var e in this.gizmos){var i=this.gizmos[e];i&&this._gizmosEnabled[e]&&(i.attachedNode=t)}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(t)},Object.defineProperty(n.prototype,"positionGizmoEnabled",{get:function(){return this._gizmosEnabled.positionGizmo},set:function(t){t?(this.gizmos.positionGizmo||(this.gizmos.positionGizmo=new uu(this._defaultUtilityLayer,this._thickness,this)),this._attachedNode?this.gizmos.positionGizmo.attachedNode=this._attachedNode:this.gizmos.positionGizmo.attachedMesh=this._attachedMesh):this.gizmos.positionGizmo&&(this.gizmos.positionGizmo.attachedNode=null),this._gizmosEnabled.positionGizmo=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rotationGizmoEnabled",{get:function(){return this._gizmosEnabled.rotationGizmo},set:function(t){t?(this.gizmos.rotationGizmo||(this.gizmos.rotationGizmo=new su(this._defaultUtilityLayer,32,!1,this._thickness,this)),this._attachedNode?this.gizmos.rotationGizmo.attachedNode=this._attachedNode:this.gizmos.rotationGizmo.attachedMesh=this._attachedMesh):this.gizmos.rotationGizmo&&(this.gizmos.rotationGizmo.attachedNode=null),this._gizmosEnabled.rotationGizmo=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"scaleGizmoEnabled",{get:function(){return this._gizmosEnabled.scaleGizmo},set:function(t){t?(this.gizmos.scaleGizmo=this.gizmos.scaleGizmo||new cu(this._defaultUtilityLayer,this._thickness,this),this._attachedNode?this.gizmos.scaleGizmo.attachedNode=this._attachedNode:this.gizmos.scaleGizmo.attachedMesh=this._attachedMesh):this.gizmos.scaleGizmo&&(this.gizmos.scaleGizmo.attachedNode=null),this._gizmosEnabled.scaleGizmo=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"boundingBoxGizmoEnabled",{get:function(){return this._gizmosEnabled.boundingBoxGizmo},set:function(t){t?(this.gizmos.boundingBoxGizmo=this.gizmos.boundingBoxGizmo||new au(this._boundingBoxColor,this._defaultKeepDepthUtilityLayer),this._attachedMesh?this.gizmos.boundingBoxGizmo.attachedMesh=this._attachedMesh:this.gizmos.boundingBoxGizmo.attachedNode=this._attachedNode,this._attachedMesh?(this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh.addBehavior(this.boundingBoxDragBehavior)):this._attachedNode&&(this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode.addBehavior(this.boundingBoxDragBehavior))):this.gizmos.boundingBoxGizmo&&(this._attachedMesh?this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior):this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this.gizmos.boundingBoxGizmo.attachedNode=null),this._gizmosEnabled.boundingBoxGizmo=t},enumerable:!1,configurable:!0}),n.prototype.addToAxisCache=function(t){var e=this;t.size>0&&t.forEach(function(i,r){e._gizmoAxisCache.set(r,i)})},n.prototype.dispose=function(){var t=this;this._pointerObservers.forEach(function(r){t.scene.onPointerObservable.remove(r)});for(var e in this.gizmos){var i=this.gizmos[e];i&&i.dispose()}this._defaultKeepDepthUtilityLayer.dispose(),this._defaultUtilityLayer.dispose(),this.boundingBoxDragBehavior.detach(),this.onAttachedToMeshObservable.clear()},n}(),fu=u(599);ot.a.CreateHemisphere=function(n,t,e,i){var r={segments:t,diameter:e};return Qo.CreateHemisphere(n,r,i)};var Qo=function(){function n(){}return n.CreateHemisphere=function(t,e,i){e.diameter||(e.diameter=1),e.segments||(e.segments=16);var r=nr.a.CreateSphere("",{slice:.5,diameter:e.diameter,segments:e.segments},i),o=ot.a.CreateDisc("",e.diameter/2,e.segments*3+(4-e.segments),i);o.rotation.x=-Math.PI/2,o.parent=r;var a=ot.a.MergeMeshes([o,r],!0);return a.name=t,a},n}(),Zo=u(484),fs=u(537);Nt.a.AddNodeConstructor("Light_Type_2",function(n,t){return function(){return new hs(n,l.e.Zero(),l.e.Zero(),0,0,t)}});var hs=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,s)||this;return c._innerAngle=0,c._projectionTextureMatrix=l.a.Zero(),c._projectionTextureLightNear=1e-6,c._projectionTextureLightFar=1e3,c._projectionTextureUpDirection=l.e.Up(),c._projectionTextureViewLightDirty=!0,c._projectionTextureProjectionLightDirty=!0,c._projectionTextureDirty=!0,c._projectionTextureViewTargetVector=l.e.Zero(),c._projectionTextureViewLightMatrix=l.a.Zero(),c._projectionTextureProjectionLightMatrix=l.a.Zero(),c._projectionTextureScalingMatrix=l.a.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),c.position=i,c.direction=r,c.angle=o,c.exponent=a,c}return Object.defineProperty(t.prototype,"angle",{get:function(){return this._angle},set:function(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"innerAngle",{get:function(){return this._innerAngle},set:function(e){this._innerAngle=e,this._computeAngleValues()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowAngleScale",{get:function(){return this._shadowAngleScale},set:function(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureMatrix",{get:function(){return this._projectionTextureMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureLightNear",{get:function(){return this._projectionTextureLightNear},set:function(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureLightFar",{get:function(){return this._projectionTextureLightFar},set:function(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureUpDirection",{get:function(){return this._projectionTextureUpDirection},set:function(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTexture",{get:function(){return this._projectionTexture},set:function(e){var i=this;this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(t._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(function(){i._markMeshesAsLightDirty()}):t._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(function(){i._markMeshesAsLightDirty()})))},enumerable:!1,configurable:!0}),t._IsProceduralTexture=function(e){return e.onGeneratedObservable!==void 0},t._IsTexture=function(e){return e.onLoadObservable!==void 0},t.prototype.getClassName=function(){return"SpotLight"},t.prototype.getTypeID=function(){return Zo.a.LIGHTTYPEID_SPOTLIGHT},t.prototype._setDirection=function(e){n.prototype._setDirection.call(this,e),this._projectionTextureViewLightDirty=!0},t.prototype._setPosition=function(e){n.prototype._setPosition.call(this,e),this._projectionTextureViewLightDirty=!0},t.prototype._setDefaultShadowProjectionMatrix=function(e,i,r){var o=this.getScene().activeCamera;if(!!o){this._shadowAngleScale=this._shadowAngleScale||1;var a=this._shadowAngleScale*this._angle;l.a.PerspectiveFovLHToRef(a,1,this.getDepthMinZ(o),this.getDepthMaxZ(o),e)}},t.prototype._computeProjectionTextureViewLightMatrix=function(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),l.a.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)},t.prototype._computeProjectionTextureProjectionLightMatrix=function(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;var e=this.projectionTextureLightFar,i=this.projectionTextureLightNear,r=e/(e-i),o=-r*i,a=1/Math.tan(this._angle/2),s=1;l.a.FromValuesToRef(a/s,0,0,0,0,a,0,0,0,0,r,1,0,0,o,0,this._projectionTextureProjectionLightMatrix)},t.prototype._computeProjectionTextureMatrix=function(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Ze.a){var e=this._projectionTexture.uScale/2,i=this._projectionTexture.vScale/2;l.a.FromValuesToRef(e,0,0,0,0,i,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)},t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype._computeAngleValues=function(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale},t.prototype.transferTexturesToEffect=function(e,i){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+i,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+i,this.projectionTexture)),this},t.prototype.transferToEffect=function(e,i){var r;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,i),r=l.e.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,i),r=l.e.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",r.x,r.y,r.z,this._cosHalfAngle,i),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,i),this},t.prototype.transferToNodeMaterialEffect=function(e,i){var r;return this.computeTransformedInformation()?r=l.e.Normalize(this.transformedDirection):r=l.e.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(i,-r.x,-r.y,-r.z):e.setFloat3(i,r.x,r.y,r.z),this},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._projectionTexture&&this._projectionTexture.dispose()},t.prototype.prepareLightSpecificDefines=function(e,i){e["SPOTLIGHT"+i]=!0,e["PROJECTEDLIGHTTEXTURE"+i]=!!(this.projectionTexture&&this.projectionTexture.isReady())},Object(h.c)([Object(de.c)()],t.prototype,"angle",null),Object(h.c)([Object(de.c)()],t.prototype,"innerAngle",null),Object(h.c)([Object(de.c)()],t.prototype,"shadowAngleScale",null),Object(h.c)([Object(de.c)()],t.prototype,"exponent",void 0),Object(h.c)([Object(de.c)()],t.prototype,"projectionTextureLightNear",null),Object(h.c)([Object(de.c)()],t.prototype,"projectionTextureLightFar",null),Object(h.c)([Object(de.c)()],t.prototype,"projectionTextureUpDirection",null),Object(h.c)([Object(de.m)("projectedLightTexture")],t.prototype,"_projectionTexture",void 0),t}(fs.a),og=function(n){Object(h.d)(t,n);function t(e){e===void 0&&(e=Xi.a.DefaultUtilityLayer);var i=n.call(this,e)||this;return i._cachedPosition=new l.e,i._cachedForward=new l.e(0,0,1),i._pointerObserver=null,i.onClickedObservable=new _.c,i._light=null,i.attachedMesh=new Ue.a("",i.gizmoLayer.utilityLayerScene),i._attachedMeshParent=new po.a("parent",i.gizmoLayer.utilityLayerScene),i.attachedMesh.parent=i._attachedMeshParent,i._material=new Gt.a("light",i.gizmoLayer.utilityLayerScene),i._material.diffuseColor=new m.a(.5,.5,.5),i._material.specularColor=new m.a(.1,.1,.1),i._pointerObserver=e.utilityLayerScene.onPointerObservable.add(function(r){!i._light||(i._isHovered=!!(r.pickInfo&&i._rootMesh.getChildMeshes().indexOf(r.pickInfo.pickedMesh)!=-1),i._isHovered&&r.event.button===0&&i.onClickedObservable.notifyObservers(i._light))},re.a.POINTERDOWN),i}return Object.defineProperty(t.prototype,"light",{get:function(){return this._light},set:function(e){var i=this;if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),e instanceof $n.a?this._lightMesh=t._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof fu.a?this._lightMesh=t._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof hs?this._lightMesh=t._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):this._lightMesh=t._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach(function(o){o.material=i._material}),this._lightMesh.parent=this._rootMesh;var r=this.gizmoLayer._getSharedGizmoLight();r.includedOnlyMeshes=r.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new l.b,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction&&(this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(this.attachedMesh.forward)),this._update()}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),t.prototype._update=function(){n.prototype._update.call(this),!!this._light&&(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position&&(this.attachedMesh.position.equals(this._cachedPosition)?(this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)):(this._light.position.copyFrom(this.attachedMesh.position),this._cachedPosition.copyFrom(this.attachedMesh.position))),this._light.direction&&(l.e.DistanceSquared(this.attachedMesh.forward,this._cachedForward)>1e-4?(this._light.direction.copyFrom(this.attachedMesh.forward),this._cachedForward.copyFrom(this.attachedMesh.forward)):l.e.DistanceSquared(this.attachedMesh.forward,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(this.attachedMesh.forward))))},t.prototype.dispose=function(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),n.prototype.dispose.call(this),this._attachedMeshParent.dispose()},t._CreateHemisphericLightMesh=function(e){var i=new ot.a("hemisphereLight",e),r=Qo.CreateHemisphere(i.name,{segments:10,diameter:1},e);r.position.z=-.15,r.rotation.x=Math.PI/2,r.parent=i;var o=this._CreateLightLines(3,e);return o.parent=i,i.scaling.scaleInPlace(t._Scale),i.rotation.x=Math.PI/2,i},t._CreatePointLightMesh=function(e){var i=new ot.a("pointLight",e),r=nr.a.CreateSphere(i.name,{segments:10,diameter:1},e);r.rotation.x=Math.PI/2,r.parent=i;var o=this._CreateLightLines(5,e);return o.parent=i,i.scaling.scaleInPlace(t._Scale),i.rotation.x=Math.PI/2,i},t._CreateSpotLightMesh=function(e){var i=new ot.a("spotLight",e),r=nr.a.CreateSphere(i.name,{segments:10,diameter:1},e);r.parent=i;var o=Qo.CreateHemisphere(i.name,{segments:10,diameter:2},e);o.parent=i,o.rotation.x=-Math.PI/2;var a=this._CreateLightLines(2,e);return a.parent=i,i.scaling.scaleInPlace(t._Scale),i.rotation.x=Math.PI/2,i},t._CreateDirectionalLightMesh=function(e){var i=new ot.a("directionalLight",e),r=new ot.a(i.name,e);r.parent=i;var o=nr.a.CreateSphere(i.name,{diameter:1.2,segments:10},e);o.parent=r;var a=ot.a.CreateCylinder(i.name,6,.3,.3,6,1,e);a.parent=r;var s=a.clone(i.name);s.scaling.y=.5,s.position.x+=1.25;var c=a.clone(i.name);c.scaling.y=.5,c.position.x+=-1.25;var v=ot.a.CreateCylinder(i.name,1,0,.6,6,1,e);v.position.y+=3,v.parent=r;var s=v.clone(i.name);s.position.y=1.5,s.position.x+=1.25;var c=v.clone(i.name);return c.position.y=1.5,c.position.x+=-1.25,r.scaling.scaleInPlace(t._Scale),r.rotation.z=Math.PI/2,r.rotation.y=Math.PI/2,i},t._Scale=.007,t._CreateLightLines=function(e,i){var r=1.2,o=new ot.a("root",i);o.rotation.x=Math.PI/2;var a=new ot.a("linePivot",i);a.parent=o;var s=ot.a.CreateCylinder("line",2,.2,.3,6,1,i);if(s.position.y=s.scaling.y/2+r,s.parent=a,e<2)return a;for(var c=0;c<4;c++){var v=a.clone("lineParentClone");v.rotation.z=Math.PI/4,v.rotation.y=Math.PI/2+Math.PI/2*c,v.getChildMeshes()[0].scaling.y=.5,v.getChildMeshes()[0].scaling.x=v.getChildMeshes()[0].scaling.z=.8,v.getChildMeshes()[0].position.y=v.getChildMeshes()[0].scaling.y/2+r}if(e<3)return o;for(var c=0;c<4;c++){var v=a.clone("linePivotClone");v.rotation.z=Math.PI/2,v.rotation.y=Math.PI/2*c}if(e<4)return o;for(var c=0;c<4;c++){var v=a.clone("linePivotClone");v.rotation.z=Math.PI+Math.PI/4,v.rotation.y=Math.PI/2+Math.PI/2*c,v.getChildMeshes()[0].scaling.y=.5,v.getChildMeshes()[0].scaling.x=v.getChildMeshes()[0].scaling.z=.8,v.getChildMeshes()[0].position.y=v.getChildMeshes()[0].scaling.y/2+r}if(e<5)return o;var v=a.clone("linePivotClone");return v.rotation.z=Math.PI,o},t}(rr.a),ag=function(n){Object(h.d)(t,n);function t(e){e===void 0&&(e=Xi.a.DefaultUtilityLayer);var i=n.call(this,e)||this;return i._pointerObserver=null,i.onClickedObservable=new _.c,i._camera=null,i._invProjection=new et.k,i._material=new Gt.a("cameraGizmoMaterial",i.gizmoLayer.utilityLayerScene),i._material.diffuseColor=new m.a(.5,.5,.5),i._material.specularColor=new m.a(.1,.1,.1),i._pointerObserver=e.utilityLayerScene.onPointerObservable.add(function(r){!i._camera||(i._isHovered=!!(r.pickInfo&&i._rootMesh.getChildMeshes().indexOf(r.pickInfo.pickedMesh)!=-1),i._isHovered&&r.event.button===0&&i.onClickedObservable.notifyObservers(i._camera))},re.a.POINTERDOWN),i}return Object.defineProperty(t.prototype,"displayFrustum",{get:function(){return this._cameraLinesMesh.isEnabled()},set:function(e){this._cameraLinesMesh.setEnabled(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"camera",{get:function(){return this._camera},set:function(e){var i=this;if(this._camera=e,this.attachedNode=e,e){this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._cameraMesh=t._CreateCameraMesh(this.gizmoLayer.utilityLayerScene),this._cameraLinesMesh=t._CreateCameraFrustum(this.gizmoLayer.utilityLayerScene),this._cameraMesh.getChildMeshes(!1).forEach(function(o){o.material=i._material}),this._cameraMesh.parent=this._rootMesh,this._cameraLinesMesh.parent=this._rootMesh,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<e.maxZ*1.5&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=e.maxZ*1.5),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;var r=this.gizmoLayer._getSharedGizmoLight();r.includedOnlyMeshes=r.includedOnlyMeshes.concat(this._cameraMesh.getChildMeshes(!1)),this._update()}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),t.prototype._update=function(){n.prototype._update.call(this),!!this._camera&&(this._camera.getProjectionMatrix().invertToRef(this._invProjection),this._cameraLinesMesh.setPivotMatrix(this._invProjection,!1),this._cameraLinesMesh.scaling.x=1/this._rootMesh.scaling.x,this._cameraLinesMesh.scaling.y=1/this._rootMesh.scaling.y,this._cameraLinesMesh.scaling.z=1/this._rootMesh.scaling.z,this._cameraMesh.parent=null,this._cameraMesh.rotation.y=Math.PI*.5*(this._camera.getScene().useRightHandedSystem?1:-1),this._cameraMesh.parent=this._rootMesh)},t.prototype.dispose=function(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._material.dispose(),n.prototype.dispose.call(this)},t._CreateCameraMesh=function(e){var i=new ot.a("rootCameraGizmo",e),r=new ot.a(i.name,e);r.parent=i;var o=co.a.CreateBox(i.name,{width:1,height:.8,depth:.5},e);o.parent=r;var a=Tr.a.CreateCylinder(i.name,{height:.5,diameterTop:.8,diameterBottom:.8},e);a.parent=r,a.position.y=.3,a.position.x=-.6,a.rotation.x=Math.PI*.5;var s=Tr.a.CreateCylinder(i.name,{height:.5,diameterTop:.6,diameterBottom:.6},e);s.parent=r,s.position.y=.5,s.position.x=.4,s.rotation.x=Math.PI*.5;var c=Tr.a.CreateCylinder(i.name,{height:.5,diameterTop:.5,diameterBottom:.5},e);return c.parent=r,c.position.y=0,c.position.x=.6,c.rotation.z=Math.PI*.5,i.scaling.scaleInPlace(t._Scale),r.position.x=-.9,i},t._CreateCameraFrustum=function(e){var i=new ot.a("rootCameraGizmo",e),r=new ot.a(i.name,e);r.parent=i;for(var o=0;o<4;o+=2)for(var a=0;a<4;a+=2){var s=Bi.a.CreateLines("lines",{points:[new l.e(-1+a,-1+o,-1),new l.e(-1+a,-1+o,1)]},e);s.parent=r,s.alwaysSelectAsActiveMesh=!0,s.isPickable=!1;var s=Bi.a.CreateLines("lines",{points:[new l.e(-1,-1+a,-1+o),new l.e(1,-1+a,-1+o)]},e);s.parent=r,s.alwaysSelectAsActiveMesh=!0,s.isPickable=!1;var s=Bi.a.CreateLines("lines",{points:[new l.e(-1+a,-1,-1+o),new l.e(-1+a,1,-1+o)]},e);s.parent=r,s.alwaysSelectAsActiveMesh=!0,s.isPickable=!1}return i},t._Scale=.05,t}(rr.a),go=u(472),ds=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){a===void 0&&(a=0),s===void 0&&(s=Ze.a.BILINEAR_SAMPLINGMODE),c===void 0&&(c=!0);var v=n.call(this,e,i,r,o,!0,a,!1,s,c)||this;v.scene=r,v.mirrorPlane=new ce.a(0,1,0,1),v._transformMatrix=l.a.Zero(),v._mirrorMatrix=l.a.Zero(),v._adaptiveBlurKernel=0,v._blurKernelX=0,v._blurKernelY=0,v._blurRatio=1,v.ignoreCameraViewport=!0,v._updateGammaSpace(),v._imageProcessingConfigChangeObserver=r.imageProcessingConfiguration.onUpdateParameters.add(function(){v._updateGammaSpace()});var b=v.getScene().getEngine();v.onBeforeBindObservable.add(function(){b._debugPushGroup("mirror generation for "+e,1)}),v.onAfterUnbindObservable.add(function(){b._debugPopGroup(1)});var C;return v.onBeforeRenderObservable.add(function(){l.a.ReflectionToRef(v.mirrorPlane,v._mirrorMatrix),v._mirrorMatrix.multiplyToRef(r.getViewMatrix(),v._transformMatrix),r.setTransformMatrix(v._transformMatrix,r.getProjectionMatrix()),C=r.clipPlane,r.clipPlane=v.mirrorPlane,r.getEngine().cullBackFaces=!1,r._mirroredCameraPosition=l.e.TransformCoordinates(r.activeCamera.globalPosition,v._mirrorMatrix)}),v.onAfterRenderObservable.add(function(){r.updateTransformMatrix(),r.getEngine().cullBackFaces=!0,r._mirroredCameraPosition=null,r.clipPlane=C}),v}return Object.defineProperty(t.prototype,"blurRatio",{get:function(){return this._blurRatio},set:function(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"adaptiveBlurKernel",{set:function(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurKernel",{set:function(e){this.blurKernelX=e,this.blurKernelY=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurKernelX",{get:function(){return this._blurKernelX},set:function(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurKernelY",{get:function(){return this._blurKernelY},set:function(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),t.prototype._autoComputeBlurKernel=function(){var e=this.getScene().getEngine(),i=this.getRenderWidth()/e.getRenderWidth(),r=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*i,this.blurKernelY=this._adaptiveBlurKernel*r},t.prototype._onRatioRescale=function(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()},t.prototype._updateGammaSpace=function(){this.gammaSpace=!this.scene.imageProcessingConfiguration.isEnabled||!this.scene.imageProcessingConfiguration.applyByPostProcess},t.prototype._preparePostProcesses=function(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){var e=this.getScene().getEngine(),i=e.getCaps().textureFloatRender?1:2;this._blurX=new go.a("horizontal blur",new l.d(1,0),this._blurKernelX,this._blurRatio,null,Ze.a.BILINEAR_SAMPLINGMODE,e,!1,i),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._texture:this._blurX.alwaysForcePOT=!0,this._blurY=new go.a("vertical blur",new l.d(0,1),this._blurKernelY,this._blurRatio,null,Ze.a.BILINEAR_SAMPLINGMODE,e,!1,i),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)},t.prototype.clone=function(){var e=this.getScene();if(!e)return this;var i=this.getSize(),r=new t(this.name,i.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return r.hasAlpha=this.hasAlpha,r.level=this.level,r.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(r.renderList=this.renderList.slice(0)),r},t.prototype.serialize=function(){if(!this.name)return null;var e=n.prototype.serialize.call(this);return e.mirrorPlane=this.mirrorPlane.asArray(),e},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver)},t}(Cr.a);Ze.a._CreateMirror=function(n,t,e,i){return new ds(n,t,e,i)};var pn=u(504),Ot=u(454),ps=u(552),gs=u(553),en=u(480),hu="backgroundFragmentDeclaration",du=` uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;
uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif`;qe.a.IncludesShadersStore[hu]=du;var p_={name:hu,shader:du},pu="backgroundUboDeclaration",gu=`layout(std140,column_major) uniform;
uniform Material
{
uniform vec4 vPrimaryColor;
uniform vec4 vPrimaryColorShadow;
uniform vec2 vDiffuseInfos;
uniform vec2 vReflectionInfos;
uniform mat4 diffuseMatrix;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
uniform float pointSize;
uniform float shadowLevel;
uniform float alpha;
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
};
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif
mat4 view;
vec4 viewPosition;
};`;qe.a.IncludesShadersStore[pu]=gu;var g_={name:pu,shader:gu},m_=u(653),v_=u(524),__=u(650),y_=u(651),b_=u(729),E_=u(652),P_=u(525),C_=u(592),S_=u(597),T_=u(550),R_=u(654),A_=u(655),mu="backgroundPixelShader",vu=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#define RECIPROCAL_PI2 0.15915494

uniform vec4 vEyePosition;

varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV == 1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV == 2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif

#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif

#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif

#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>

#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<helperFunctions>
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<clipPlaneFragmentDeclaration>

#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{

float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
void main(void) {
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);

#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif

float shadow=1.;
float globalShadow=0.;
float shadowLightCount=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY

vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif

#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT

reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);
if(lodReflectionNormalizedDoubled<1.0){
reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);
} else {
reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);
reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif

reflectionColor.rgb*=vReflectionInfos.x;
#endif

vec3 diffuseColor=vec3(1.,1.,1.);
float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif

diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif

#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);

#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif

#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;
vec3 reflectionReflectance0=vReflectionControl.yyy;
vec3 reflectionReflectance90=vReflectionControl.zzz;
float VdotN=dot(normalize(vEyePosition.xyz),normalW);
vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);
reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);
reflectionDistanceFalloff*=reflectionDistanceFalloff;
reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));

const float startAngle=0.1;
float fadeFactor=saturate(viewAngleToFloor/startAngle);
finalAlpha*=fadeFactor*fadeFactor;
#endif

#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif

vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS


color.rgb=clamp(color.rgb,0.,30.0);
#else

color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA

color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);
color=max(color,0.0);
#endif
gl_FragColor=color;
}
`;qe.a.ShadersStore[mu]=vu;var O_={name:mu,shader:vu},_u="backgroundVertexDeclaration",yu=`uniform mat4 view;
uniform mat4 viewProjection;
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif`;qe.a.IncludesShadersStore[_u]=yu;var M_={name:_u,shader:yu},x_=u(487),D_=u(501),I_=u(593),L_=u(656),F_=u(657),B_=u(658),N_=u(488),w_=u(489),V_=u(551),U_=u(702),G_=u(659),bu="backgroundVertexShader",Eu=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>

attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>

#include<instancesDeclaration>

varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
void main(void) {
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#ifdef MULTIVIEW
if (gl_ViewID_OVR == 0u) {
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
} else {
gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);
}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);
vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));
vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));
if (fFovMultiplier<=1.0) {
vDirectionW=normalize(segment);
} else {
vDirectionW=normalize(vDirectionW+(vDirectionW-segment));
}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0
if (vDiffuseInfos.x == 0.)
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));
}
else
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
}
#endif

#include<clipPlaneVertex>

#include<fogVertex>

#include<shadowsVertex>[0..maxSimultaneousLights]

#ifdef VERTEXCOLOR
vColor=color;
#endif

#ifdef POINTSIZE
gl_PointSize=pointSize;
#endif
}
`;qe.a.ShadersStore[bu]=Eu;var z_={name:bu,shader:Eu},ms=u(512),sg=function(n){Object(h.d)(t,n);function t(){var e=n.call(this)||this;return e.DIFFUSE=!1,e.DIFFUSEDIRECTUV=0,e.GAMMADIFFUSE=!1,e.DIFFUSEHASALPHA=!1,e.OPACITYFRESNEL=!1,e.REFLECTIONBLUR=!1,e.REFLECTIONFRESNEL=!1,e.REFLECTIONFALLOFF=!1,e.TEXTURELODSUPPORT=!1,e.PREMULTIPLYALPHA=!1,e.USERGBCOLOR=!1,e.USEHIGHLIGHTANDSHADOWCOLORS=!1,e.BACKMAT_SHADOWONLY=!1,e.NOISE=!1,e.REFLECTIONBGR=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.EXPOSURE=!1,e.MULTIVIEW=!1,e.REFLECTION=!1,e.REFLECTIONMAP_3D=!1,e.REFLECTIONMAP_SPHERICAL=!1,e.REFLECTIONMAP_PLANAR=!1,e.REFLECTIONMAP_CUBIC=!1,e.REFLECTIONMAP_PROJECTION=!1,e.REFLECTIONMAP_SKYBOX=!1,e.REFLECTIONMAP_EXPLICIT=!1,e.REFLECTIONMAP_EQUIRECTANGULAR=!1,e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.INVERTCUBICMAP=!1,e.REFLECTIONMAP_OPPOSITEZ=!1,e.LODINREFLECTIONALPHA=!1,e.GAMMAREFLECTION=!1,e.RGBDREFLECTION=!1,e.EQUIRECTANGULAR_RELFECTION_FOV=!1,e.MAINUV1=!1,e.MAINUV2=!1,e.UV1=!1,e.UV2=!1,e.CLIPPLANE=!1,e.CLIPPLANE2=!1,e.CLIPPLANE3=!1,e.CLIPPLANE4=!1,e.CLIPPLANE5=!1,e.CLIPPLANE6=!1,e.POINTSIZE=!1,e.FOG=!1,e.NORMAL=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.INSTANCES=!1,e.SHADOWFLOAT=!1,e.rebuild(),e}return t}(ps.a),mo=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r.primaryColor=m.a.White(),r._primaryColorShadowLevel=0,r._primaryColorHighlightLevel=0,r.reflectionTexture=null,r.reflectionBlur=0,r.diffuseTexture=null,r._shadowLights=null,r.shadowLights=null,r.shadowLevel=0,r.sceneCenter=l.e.Zero(),r.opacityFresnel=!0,r.reflectionFresnel=!1,r.reflectionFalloffDistance=0,r.reflectionAmount=1,r.reflectionReflectance0=.05,r.reflectionReflectance90=.5,r.useRGBColor=!0,r.enableNoise=!1,r._fovMultiplier=1,r.useEquirectangularFOV=!1,r._maxSimultaneousLights=4,r.maxSimultaneousLights=4,r._shadowOnly=!1,r.shadowOnly=!1,r._imageProcessingObserver=null,r.switchToBGR=!1,r._renderTargets=new Pt.a(16),r._reflectionControls=l.f.Zero(),r._white=m.a.White(),r._primaryShadowColor=m.a.Black(),r._primaryHighlightColor=m.a.Black(),r._attachImageProcessingConfiguration(null),r.getRenderTargetTextures=function(){return r._renderTargets.reset(),r._diffuseTexture&&r._diffuseTexture.isRenderTarget&&r._renderTargets.push(r._diffuseTexture),r._reflectionTexture&&r._reflectionTexture.isRenderTarget&&r._renderTargets.push(r._reflectionTexture),r._renderTargets},r}return Object.defineProperty(t.prototype,"_perceptualColor",{get:function(){return this.__perceptualColor},set:function(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"primaryColorShadowLevel",{get:function(){return this._primaryColorShadowLevel},set:function(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"primaryColorHighlightLevel",{get:function(){return this._primaryColorHighlightLevel},set:function(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflectionStandardFresnelWeight",{set:function(e){var i=e;i<.5?(i=i*2,this.reflectionReflectance0=t.StandardReflectance0*i,this.reflectionReflectance90=t.StandardReflectance90*i):(i=i*2-1,this.reflectionReflectance0=t.StandardReflectance0+(1-t.StandardReflectance0)*i,this.reflectionReflectance90=t.StandardReflectance90+(1-t.StandardReflectance90)*i)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fovMultiplier",{get:function(){return this._fovMultiplier},set:function(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))},enumerable:!1,configurable:!0}),t.prototype._attachImageProcessingConfiguration=function(e){var i=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){i._computePrimaryColorFromPerceptualColor(),i._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(t.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this.imageProcessingConfiguration.colorGradingTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraColorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(e){this.imageProcessingConfiguration.colorCurves=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasRenderTargetTextures",{get:function(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)},enumerable:!1,configurable:!0}),t.prototype.needAlphaTesting=function(){return!0},t.prototype.needAlphaBlending=function(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly},t.prototype.isReadyForSubMesh=function(e,i,r){var o=this;if(r===void 0&&(r=!1),i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady)return!0;i._materialDefines||(i._materialDefines=new sg);var a=this.getScene(),s=i._materialDefines;if(this._isReadyForSubMesh(i))return!0;var c=a.getEngine();if(Ot.a.PrepareDefinesForLights(a,e,s,!1,this._maxSimultaneousLights),s._needNormals=!0,Ot.a.PrepareDefinesForMultiview(a,s),s._areTexturesDirty){if(s._needUVs=!1,a.texturesEnabled){if(a.getEngine().getCaps().textureLOD&&(s.TEXTURELODSUPPORT=!0),this._diffuseTexture&&en.a.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;Ot.a.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE"),s.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,s.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,s.OPACITYFRESNEL=this._opacityFresnel}else s.DIFFUSE=!1,s.DIFFUSEHASALPHA=!1,s.GAMMADIFFUSE=!1,s.OPACITYFRESNEL=!1;var v=this._reflectionTexture;if(v&&en.a.ReflectionTextureEnabled){if(!v.isReadyOrNotBlocking())return!1;switch(s.REFLECTION=!0,s.GAMMAREFLECTION=v.gammaSpace,s.RGBDREFLECTION=v.isRGBD,s.REFLECTIONBLUR=this._reflectionBlur>0,s.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!v.invertZ:v.invertZ,s.LODINREFLECTIONALPHA=v.lodLevelInAlpha,s.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,s.REFLECTIONBGR=this.switchToBGR,v.coordinatesMode===Ze.a.INVCUBIC_MODE&&(s.INVERTCUBICMAP=!0),s.REFLECTIONMAP_3D=v.isCube,v.coordinatesMode){case Ze.a.EXPLICIT_MODE:s.REFLECTIONMAP_EXPLICIT=!0;break;case Ze.a.PLANAR_MODE:s.REFLECTIONMAP_PLANAR=!0;break;case Ze.a.PROJECTION_MODE:s.REFLECTIONMAP_PROJECTION=!0;break;case Ze.a.SKYBOX_MODE:s.REFLECTIONMAP_SKYBOX=!0;break;case Ze.a.SPHERICAL_MODE:s.REFLECTIONMAP_SPHERICAL=!0;break;case Ze.a.EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Ze.a.FIXED_EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Ze.a.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Ze.a.CUBIC_MODE:case Ze.a.INVCUBIC_MODE:default:s.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(s.REFLECTIONFRESNEL=!0,s.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1)}else s.REFLECTION=!1,s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1,s.REFLECTIONBLUR=!1,s.REFLECTIONMAP_3D=!1,s.REFLECTIONMAP_SPHERICAL=!1,s.REFLECTIONMAP_PLANAR=!1,s.REFLECTIONMAP_CUBIC=!1,s.REFLECTIONMAP_PROJECTION=!1,s.REFLECTIONMAP_SKYBOX=!1,s.REFLECTIONMAP_EXPLICIT=!1,s.REFLECTIONMAP_EQUIRECTANGULAR=!1,s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,s.INVERTCUBICMAP=!1,s.REFLECTIONMAP_OPPOSITEZ=!1,s.LODINREFLECTIONALPHA=!1,s.GAMMAREFLECTION=!1,s.RGBDREFLECTION=!1}s.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,s.USERGBCOLOR=this._useRGBColor,s.NOISE=this._enableNoise}if(s._areLightsDirty&&(s.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),s.BACKMAT_SHADOWONLY=this._shadowOnly),s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s)}if(Ot.a.PrepareDefinesForMisc(e,a,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),s),Ot.a.PrepareDefinesForFrameBoundValues(a,c,s,r,null,i.getRenderingMesh().hasThinInstances),Ot.a.PrepareDefinesForAttributes(e,s,!1,!0,!1)&&e&&!a.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(Oe.b.NormalKind)&&(e.createNormals(!0),p.a.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),s.isDirty){s.markAsProcessed(),a.resetCachedMaterial();var b=new ms.a;s.FOG&&b.addFallback(0,"FOG"),s.POINTSIZE&&b.addFallback(1,"POINTSIZE"),s.MULTIVIEW&&b.addFallback(0,"MULTIVIEW"),Ot.a.HandleFallbacksForShadows(s,b,this._maxSimultaneousLights);var C=[Oe.b.PositionKind];s.NORMAL&&C.push(Oe.b.NormalKind),s.UV1&&C.push(Oe.b.UVKind),s.UV2&&C.push(Oe.b.UV2Kind),Ot.a.PrepareAttributesForBones(C,e,s,b),Ot.a.PrepareAttributesForInstances(C,s);var M=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"],N=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],D=["Material","Scene"];mr.a&&(mr.a.PrepareUniforms(M,s),mr.a.PrepareSamplers(N,s)),Ot.a.PrepareUniformsAndSamplersList({uniformsNames:M,uniformBuffersNames:D,samplers:N,defines:s,maxSimultaneousLights:this._maxSimultaneousLights});var V=function(ee){o.onCompiled&&o.onCompiled(ee),Ot.a.BindSceneUniformBuffer(ee,a.getSceneUniformBuffer())},X=s.toString();i.setEffect(a.getEngine().createEffect("background",{attributes:C,uniformsNames:M,uniformBuffersNames:D,samplers:N,defines:X,fallbacks:b,onCompiled:V,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},c),s),this.buildUniformLayout()}return!i.effect||!i.effect.isReady()?!1:(s._renderId=a.getRenderId(),i.effect._wasPreviouslyReady=!0,!0)},t.prototype._computePrimaryColorFromPerceptualColor=function(){!this.__perceptualColor||(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())},t.prototype._computePrimaryColors=function(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))},t.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()},t.prototype.unbind=function(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),n.prototype.unbind.call(this)},t.prototype.bindOnlyWorldMatrix=function(e){this._activeEffect.setMatrix("world",e)},t.prototype.bindForSubMesh=function(e,i,r){var o=this.getScene(),a=r._materialDefines;if(!!a){var s=r.effect;if(!!s){this._activeEffect=s,this.bindOnlyWorldMatrix(e),Ot.a.BindBonesParameters(i,this._activeEffect);var c=this._mustRebind(o,s,i.visibility);if(c){this._uniformBuffer.bindToEffect(s,"Material"),this.bindViewProjection(s);var v=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(o.texturesEnabled&&(this._diffuseTexture&&en.a.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),Ot.a.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),v&&en.a.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",v.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",v.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",v.getSize().width,v.lodGenerationScale,v.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),a.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),o.texturesEnabled&&(this._diffuseTexture&&en.a.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),v&&en.a.ReflectionTextureEnabled&&(a.REFLECTIONBLUR&&a.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",v):a.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",v._lodTextureMid||v),this._uniformBuffer.setTexture("reflectionSamplerLow",v._lodTextureLow||v),this._uniformBuffer.setTexture("reflectionSamplerHigh",v._lodTextureHigh||v)):this._uniformBuffer.setTexture("reflectionSampler",v),a.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),Ot.a.BindClipPlane(this._activeEffect,o),Ot.a.BindEyePosition(s,o)}(c||!this.isFrozen)&&(o.lightsEnabled&&Ot.a.BindLights(o,i,this._activeEffect,a,this._maxSimultaneousLights,!1),this.bindView(s),Ot.a.BindFogParameters(o,i,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(i,this._activeEffect),this._uniformBuffer.update()}}},t.prototype.hasTexture=function(e){return!!(n.prototype.hasTexture.call(this,e)||this._reflectionTexture===e||this._diffuseTexture===e)},t.prototype.dispose=function(e,i){e===void 0&&(e=!1),i===void 0&&(i=!1),i&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),n.prototype.dispose.call(this,e)},t.prototype.clone=function(e){var i=this;return de.a.Clone(function(){return new t(e,i.getScene())},this)},t.prototype.serialize=function(){var e=de.a.Serialize(this);return e.customType="BABYLON.BackgroundMaterial",e},t.prototype.getClassName=function(){return"BackgroundMaterial"},t.Parse=function(e,i,r){return de.a.Parse(function(){return new t(e.name,i)},e,i,r)},t.StandardReflectance0=.05,t.StandardReflectance90=.5,Object(h.c)([Object(de.e)()],t.prototype,"_primaryColor",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"primaryColor",void 0),Object(h.c)([Object(de.e)()],t.prototype,"__perceptualColor",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_primaryColorShadowLevel",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_primaryColorHighlightLevel",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"primaryColorHighlightLevel",null),Object(h.c)([Object(de.m)()],t.prototype,"_reflectionTexture",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionTexture",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_reflectionBlur",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionBlur",void 0),Object(h.c)([Object(de.m)()],t.prototype,"_diffuseTexture",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"diffuseTexture",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"shadowLights",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_shadowLevel",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"shadowLevel",void 0),Object(h.c)([Object(de.o)()],t.prototype,"_sceneCenter",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"sceneCenter",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_opacityFresnel",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"opacityFresnel",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_reflectionFresnel",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionFresnel",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_reflectionFalloffDistance",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionFalloffDistance",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_reflectionAmount",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionAmount",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_reflectionReflectance0",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionReflectance0",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_reflectionReflectance90",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionReflectance90",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_useRGBColor",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"useRGBColor",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_enableNoise",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"enableNoise",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_maxSimultaneousLights",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"maxSimultaneousLights",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_shadowOnly",void 0),Object(h.c)([Object(de.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"shadowOnly",void 0),Object(h.c)([Object(de.i)()],t.prototype,"_imageProcessingConfiguration",void 0),t}(gs.a);f.a.RegisteredTypes["BABYLON.BackgroundMaterial"]=mo;var vs=function(){function n(t,e){var i=this;this._errorHandler=function(r,o){i.onErrorObservable.notifyObservers({message:r,exception:o})},this._options=Object(h.a)(Object(h.a)({},n._getDefaultOptions()),t),this._scene=e,this.onErrorObservable=new _.c,this._setupBackground(),this._setupImageProcessing()}return n._getDefaultOptions=function(){return{createGround:!0,groundSize:15,groundTexture:this._groundTextureCDNUrl,groundColor:new m.a(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._skyboxTextureCDNUrl,skyboxColor:new m.a(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:l.e.Zero(),setupImageProcessing:!0,environmentTexture:this._environmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}},Object.defineProperty(n.prototype,"rootMesh",{get:function(){return this._rootMesh},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"skybox",{get:function(){return this._skybox},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"skyboxTexture",{get:function(){return this._skyboxTexture},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"skyboxMaterial",{get:function(){return this._skyboxMaterial},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ground",{get:function(){return this._ground},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"groundTexture",{get:function(){return this._groundTexture},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"groundMirror",{get:function(){return this._groundMirror},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"groundMirrorRenderList",{get:function(){return this._groundMirror?this._groundMirror.renderList:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"groundMaterial",{get:function(){return this._groundMaterial},enumerable:!1,configurable:!0}),n.prototype.updateOptions=function(t){var e=Object(h.a)(Object(h.a)({},this._options),t);this._ground&&!e.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!e.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=e.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!e.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!e.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=e.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!e.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=e.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=e,this._setupBackground(),this._setupImageProcessing()},n.prototype.setMainColor=function(t){this.groundMaterial&&(this.groundMaterial.primaryColor=t),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=t),this.groundMirror&&(this.groundMirror.clearColor=new m.b(t.r,t.g,t.b,1))},n.prototype._setupImageProcessing=function(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())},n.prototype._setupEnvironmentTexture=function(){if(!this._scene.environmentTexture){if(this._options.environmentTexture instanceof jr.a){this._scene.environmentTexture=this._options.environmentTexture;return}var t=pn.a.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=t}},n.prototype._setupBackground=function(){this._rootMesh||(this._rootMesh=new ot.a("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;var t=this._getSceneSize();this._options.createGround&&(this._setupGround(t),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(t),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(t),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=t.rootPosition.x,this._rootMesh.position.z=t.rootPosition.z,this._rootMesh.position.y=t.rootPosition.y},n.prototype._getSceneSize=function(){var t=this,e=this._options.groundSize,i=this._options.skyboxSize,r=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:e,skyboxSize:i,rootPosition:r};var o=this._scene.getWorldExtends(function(c){return c!==t._ground&&c!==t._rootMesh&&c!==t._skybox}),a=o.max.subtract(o.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Ri.a&&this._scene.activeCamera.upperRadiusLimit&&(e=this._scene.activeCamera.upperRadiusLimit*2,i=e);var s=a.length();s>e&&(e=s*2,i=e),e*=1.1,i*=1.5,r=o.min.add(a.scale(.5)),r.y=o.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:i,rootPosition:r}},n.prototype._setupGround=function(t){var e=this;(!this._ground||this._ground.isDisposed())&&(this._ground=ot.a.CreatePlane("BackgroundPlane",t.groundSize,this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(function(){e._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow},n.prototype._setupGroundMaterial=function(){this._groundMaterial||(this._groundMaterial=new mo("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)},n.prototype._setupGroundDiffuseTexture=function(){if(!!this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof jr.a){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new Ze.a(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}},n.prototype._setupGroundMirrorTexture=function(t){var e=Ze.a.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new ds("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,Ze.a.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new ce.a(0,-1,0,t.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=e,this._groundMirror.wrapV=e,this._groundMirror.gammaSpace=!1,this._groundMirror.renderList))for(var i=0;i<this._scene.meshes.length;i++){var r=this._scene.meshes[i];r!==this._ground&&r!==this._skybox&&r!==this._rootMesh&&this._groundMirror.renderList.push(r)}this._groundMirror.clearColor=new m.b(this._options.groundColor.r,this._options.groundColor.g,this._options.groundColor.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel},n.prototype._setupMirrorInGroundMaterial=function(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)},n.prototype._setupSkybox=function(t){var e=this;(!this._skybox||this._skybox.isDisposed())&&(this._skybox=ot.a.CreateBox("BackgroundSkybox",t.skyboxSize,this._scene,void 0,ot.a.BACKSIDE),this._skybox.onDisposeObservable.add(function(){e._skybox=null})),this._skybox.parent=this._rootMesh},n.prototype._setupSkyboxMaterial=function(){!this._skybox||(this._skyboxMaterial||(this._skyboxMaterial=new mo("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)},n.prototype._setupSkyboxReflectionTexture=function(){if(!!this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof jr.a){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new pn.a(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=Ze.a.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}},n.prototype.dispose=function(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)},n._groundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",n._skyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",n._environmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env",n}(),tn=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){a===void 0&&(a=null);var s=n.call(this,e,o)||this;s.onError=a,s._halfDome=!1,s._crossEye=!1,s._useDirectMapping=!1,s._textureMode=t.MODE_MONOSCOPIC,s._onBeforeCameraRenderObserver=null,s.onLoadErrorObservable=new _.c,s.onLoadObservable=new _.c,o=s.getScene(),e=e||"textureDome",r.resolution=Math.abs(r.resolution)|0||32,r.clickToPlay=Boolean(r.clickToPlay),r.autoPlay=r.autoPlay===void 0?!0:Boolean(r.autoPlay),r.loop=r.loop===void 0?!0:Boolean(r.loop),r.size=Math.abs(r.size)||(o.activeCamera?o.activeCamera.maxZ*.48:1e3),r.useDirectMapping===void 0?s._useDirectMapping=!0:s._useDirectMapping=r.useDirectMapping,r.faceForward===void 0&&(r.faceForward=!0),s._setReady(!1),r.mesh?s._mesh=r.mesh:s._mesh=ot.a.CreateSphere(e+"_mesh",r.resolution,r.size,o,!1,ot.a.BACKSIDE);var c=s._material=new mo(e+"_material",o);c.useEquirectangularFOV=!0,c.fovMultiplier=1,c.opacityFresnel=!1;var v=s._initTexture(i,o,r);if(s.texture=v,s._mesh.material=c,s._mesh.parent=s,s._halfDomeMask=nr.a.CreateSphere("",{slice:.5,diameter:r.size*.98,segments:r.resolution*2,sideOrientation:ot.a.BACKSIDE},o),s._halfDomeMask.rotate(et.c.X,-Math.PI/2),s._halfDomeMask.parent=s._mesh,s._halfDome=!!r.halfDomeMode,s._halfDomeMask.setEnabled(s._halfDome),s._crossEye=!!r.crossEyeMode,s._texture.anisotropicFilteringLevel=1,s._texture.onLoadObservable.addOnce(function(){s._setReady(!0)}),r.faceForward&&o.activeCamera){var b=o.activeCamera,C=l.e.Forward(),M=l.e.TransformNormal(C,b.getViewMatrix());M.normalize(),s.rotation.y=Math.acos(l.e.Dot(C,M))}return s._changeTextureMode(s._textureMode),s}return Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=Ze.a.CLAMP_ADDRESSMODE,this._texture.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=Ze.a.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fovMultiplier",{get:function(){return this._material.fovMultiplier},set:function(e){this._material.fovMultiplier=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textureMode",{get:function(){return this._textureMode},set:function(e){this._textureMode!==e&&this._changeTextureMode(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"halfDome",{get:function(){return this._halfDome},set:function(e){this._halfDome=e,this._halfDomeMask.setEnabled(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"crossEye",{get:function(){return this._crossEye},set:function(e){this._crossEye=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),t.prototype._changeTextureMode=function(e){var i=this;switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case t.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case t.MODE_SIDEBYSIDE:this._texture.uScale=this._halfDome?.99999:.5;var r=this._halfDome?0:.5,o=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(function(a){var s=a.isRightCamera;i._crossEye&&(s=!s),s?i._texture.uOffset=r:i._texture.uOffset=o});break;case t.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(function(a){var s=a.isRightCamera;i._crossEye&&(s=!s),i._texture.vOffset=s?.5:0});break}},t.prototype.dispose=function(e,i){i===void 0&&(i=!1),this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),n.prototype.dispose.call(this,e,i)},t.MODE_MONOSCOPIC=0,t.MODE_TOPBOTTOM=1,t.MODE_SIDEBYSIDE=2,t}(po.a),lg=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return Object.defineProperty(t.prototype,"photoTexture",{get:function(){return this.texture},set:function(e){this.texture=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"imageMode",{get:function(){return this.textureMode},set:function(e){this.textureMode=e},enumerable:!1,configurable:!0}),t.prototype._initTexture=function(e,i,r){var o=this;return new Ze.a(e,i,!r.generateMipMaps,!this._useDirectMapping,void 0,function(){o.onLoadObservable.notifyObservers()},function(a,s){o.onLoadErrorObservable.notifyObservers(a||"Unknown error occured"),o.onError&&o.onError(a,s)})},t.MODE_MONOSCOPIC=tn.MODE_MONOSCOPIC,t.MODE_TOPBOTTOM=tn.MODE_TOPBOTTOM,t.MODE_SIDEBYSIDE=tn.MODE_SIDEBYSIDE,t}(tn),Pu=u(533),Cu=u(521),ug=542327876,Su=131072,Tu=512,Ru=4,Au=64,Ou=131072;function Jo(n){return n.charCodeAt(0)+(n.charCodeAt(1)<<8)+(n.charCodeAt(2)<<16)+(n.charCodeAt(3)<<24)}function cg(n){return String.fromCharCode(n&255,n>>8&255,n>>16&255,n>>24&255)}var Mu=Jo("DXT1"),xu=Jo("DXT3"),Du=Jo("DXT5"),_s=Jo("DX10"),Iu=113,Lu=116,Fu=2,Bu=10,fg=88,ys=31,hg=0,dg=1,Nu=2,wu=3,bs=4,Vu=7,Es=20,Uu=21,pg=22,gg=23,mg=24,vg=25,_g=26,yg=28,bg=32,rn=function(){function n(){}return n.GetDDSInfo=function(t){var e=new Int32Array(t.buffer,t.byteOffset,ys),i=new Int32Array(t.buffer,t.byteOffset,ys+4),r=1;e[Nu]&Su&&(r=Math.max(1,e[Vu]));var o=e[Uu],a=o===_s?i[bg]:0,s=0;switch(o){case Iu:s=2;break;case Lu:s=1;break;case _s:if(a===Bu){s=2;break}if(a===Fu){s=1;break}}return{width:e[bs],height:e[wu],mipmapCount:r,isFourCC:(e[Es]&Ru)===Ru,isRGB:(e[Es]&Au)===Au,isLuminance:(e[Es]&Ou)===Ou,isCube:(e[yg]&Tu)===Tu,isCompressed:o===Mu||o===xu||o===Du,dxgiFormat:a,textureType:s}},n._ToHalfFloat=function(t){n._FloatView||(n._FloatView=new Float32Array(1),n._Int32View=new Int32Array(n._FloatView.buffer)),n._FloatView[0]=t;var e=n._Int32View[0],i=e>>16&32768,r=e>>12&2047,o=e>>23&255;return o<103?i:o>142?(i|=31744,i|=(o==255?0:1)&&e&8388607,i):o<113?(r|=2048,i|=(r>>114-o)+(r>>113-o&1),i):(i|=o-112<<10|r>>1,i+=r&1,i)},n._FromHalfFloat=function(t){var e=(t&32768)>>15,i=(t&31744)>>10,r=t&1023;return i===0?(e?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):i==31?r?NaN:(e?-1:1)*Infinity:(e?-1:1)*Math.pow(2,i-15)*(1+r/Math.pow(2,10))},n._GetHalfFloatAsFloatRGBAArrayBuffer=function(t,e,i,r,o,a){for(var s=new Float32Array(r),c=new Uint16Array(o,i),v=0,b=0;b<e;b++)for(var C=0;C<t;C++){var M=(C+b*t)*4;s[v]=n._FromHalfFloat(c[M]),s[v+1]=n._FromHalfFloat(c[M+1]),s[v+2]=n._FromHalfFloat(c[M+2]),n.StoreLODInAlphaChannel?s[v+3]=a:s[v+3]=n._FromHalfFloat(c[M+3]),v+=4}return s},n._GetHalfFloatRGBAArrayBuffer=function(t,e,i,r,o,a){if(n.StoreLODInAlphaChannel){for(var s=new Uint16Array(r),c=new Uint16Array(o,i),v=0,b=0;b<e;b++)for(var C=0;C<t;C++){var M=(C+b*t)*4;s[v]=c[M],s[v+1]=c[M+1],s[v+2]=c[M+2],s[v+3]=n._ToHalfFloat(a),v+=4}return s}return new Uint16Array(o,i,r)},n._GetFloatRGBAArrayBuffer=function(t,e,i,r,o,a){if(n.StoreLODInAlphaChannel){for(var s=new Float32Array(r),c=new Float32Array(o,i),v=0,b=0;b<e;b++)for(var C=0;C<t;C++){var M=(C+b*t)*4;s[v]=c[M],s[v+1]=c[M+1],s[v+2]=c[M+2],s[v+3]=a,v+=4}return s}return new Float32Array(o,i,r)},n._GetFloatAsUIntRGBAArrayBuffer=function(t,e,i,r,o,a){for(var s=new Uint8Array(r),c=new Float32Array(o,i),v=0,b=0;b<e;b++)for(var C=0;C<t;C++){var M=(C+b*t)*4;s[v]=$e.a.Clamp(c[M])*255,s[v+1]=$e.a.Clamp(c[M+1])*255,s[v+2]=$e.a.Clamp(c[M+2])*255,n.StoreLODInAlphaChannel?s[v+3]=a:s[v+3]=$e.a.Clamp(c[M+3])*255,v+=4}return s},n._GetHalfFloatAsUIntRGBAArrayBuffer=function(t,e,i,r,o,a){for(var s=new Uint8Array(r),c=new Uint16Array(o,i),v=0,b=0;b<e;b++)for(var C=0;C<t;C++){var M=(C+b*t)*4;s[v]=$e.a.Clamp(n._FromHalfFloat(c[M]))*255,s[v+1]=$e.a.Clamp(n._FromHalfFloat(c[M+1]))*255,s[v+2]=$e.a.Clamp(n._FromHalfFloat(c[M+2]))*255,n.StoreLODInAlphaChannel?s[v+3]=a:s[v+3]=$e.a.Clamp(n._FromHalfFloat(c[M+3]))*255,v+=4}return s},n._GetRGBAArrayBuffer=function(t,e,i,r,o,a,s,c,v){for(var b=new Uint8Array(r),C=new Uint8Array(o,i),M=0,N=0;N<e;N++)for(var D=0;D<t;D++){var V=(D+N*t)*4;b[M]=C[V+a],b[M+1]=C[V+s],b[M+2]=C[V+c],b[M+3]=C[V+v],M+=4}return b},n._ExtractLongWordOrder=function(t){return t===0||t===255||t===-16777216?0:1+n._ExtractLongWordOrder(t>>8)},n._GetRGBArrayBuffer=function(t,e,i,r,o,a,s,c){for(var v=new Uint8Array(r),b=new Uint8Array(o,i),C=0,M=0;M<e;M++)for(var N=0;N<t;N++){var D=(N+M*t)*3;v[C]=b[D+a],v[C+1]=b[D+s],v[C+2]=b[D+c],C+=3}return v},n._GetLuminanceArrayBuffer=function(t,e,i,r,o){for(var a=new Uint8Array(r),s=new Uint8Array(o,i),c=0,v=0;v<e;v++)for(var b=0;b<t;b++){var C=b+v*t;a[c]=s[C],c++}return a},n.UploadDDSLevels=function(t,e,i,r,o,a,s,c){s===void 0&&(s=-1);var v=null;r.sphericalPolynomial&&(v=new Array);var b=!!t.getCaps().s3tc;e.generateMipMaps=o;var C=new Int32Array(i.buffer,i.byteOffset,ys),M,N,D,V=0,X,ee,ie,ge,pe=0,te=1;if(C[hg]!==ug){p.a.Error("Invalid magic number in DDS header");return}if(!r.isFourCC&&!r.isRGB&&!r.isLuminance){p.a.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(r.isCompressed&&!b){p.a.Error("Compressed textures are not supported on this platform.");return}var Ce=C[pg];X=C[dg]+4;var Ae=!1;if(r.isFourCC)switch(M=C[Uu],M){case Mu:te=8,pe=33777;break;case xu:te=16,pe=33778;break;case Du:te=16,pe=33779;break;case Iu:Ae=!0;break;case Lu:Ae=!0;break;case _s:X+=5*4;var De=!1;switch(r.dxgiFormat){case Bu:case Fu:Ae=!0,De=!0;break;case fg:r.isRGB=!0,r.isFourCC=!1,Ce=32,De=!0;break}if(De)break;default:console.error("Unsupported FourCC code:",cg(M));return}var Fe=n._ExtractLongWordOrder(C[gg]),We=n._ExtractLongWordOrder(C[mg]),Pe=n._ExtractLongWordOrder(C[vg]),Ne=n._ExtractLongWordOrder(C[_g]);Ae&&(pe=t._getRGBABufferInternalSizedFormat(r.textureType)),ie=1,C[Nu]&Su&&o!==!1&&(ie=Math.max(1,C[Vu]));for(var je=c||0,Be=je;Be<a;Be++){for(N=C[bs],D=C[wu],ge=0;ge<ie;++ge){if(s===-1||s===ge){var Je=s===-1?ge:0;if(!r.isCompressed&&r.isFourCC){e.format=5,V=N*D*4;var tt=null;t._badOS||t._badDesktopOS||!t.getCaps().textureHalfFloat&&!t.getCaps().textureFloat?(Ce===128?(tt=n._GetFloatAsUIntRGBAArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Je),v&&Je==0&&v.push(n._GetFloatRGBAArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Je))):Ce===64&&(tt=n._GetHalfFloatAsUIntRGBAArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Je),v&&Je==0&&v.push(n._GetHalfFloatAsFloatRGBAArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Je))),e.type=0):Ce===128?(e.type=1,tt=n._GetFloatRGBAArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Je),v&&Je==0&&v.push(tt)):Ce===64&&!t.getCaps().textureHalfFloat?(e.type=1,tt=n._GetHalfFloatAsFloatRGBAArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Je),v&&Je==0&&v.push(tt)):(e.type=2,tt=n._GetHalfFloatRGBAArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Je),v&&Je==0&&v.push(n._GetHalfFloatAsFloatRGBAArrayBuffer(N,D,X,V,i.buffer,Je))),tt&&t._uploadDataToTextureDirectly(e,tt,Be,Je)}else if(r.isRGB)e.type=0,Ce===24?(e.format=4,V=N*D*3,ee=n._GetRGBArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Fe,We,Pe),t._uploadDataToTextureDirectly(e,ee,Be,Je)):(e.format=5,V=N*D*4,ee=n._GetRGBAArrayBuffer(N,D,i.byteOffset+X,V,i.buffer,Fe,We,Pe,Ne),t._uploadDataToTextureDirectly(e,ee,Be,Je));else if(r.isLuminance){var Xe=t._getUnpackAlignement(),Ct=N,At=Math.floor((N+Xe-1)/Xe)*Xe;V=At*(D-1)+Ct,ee=n._GetLuminanceArrayBuffer(N,D,i.byteOffset+X,V,i.buffer),e.format=1,e.type=0,t._uploadDataToTextureDirectly(e,ee,Be,Je)}else V=Math.max(4,N)/4*Math.max(4,D)/4*te,ee=new Uint8Array(i.buffer,i.byteOffset+X,V),e.type=0,t._uploadCompressedDataToTextureDirectly(e,pe,N,D,ee,Be,Je)}X+=Ce?N*D*(Ce/8):V,N*=.5,D*=.5,N=Math.max(1,N),D=Math.max(1,D)}if(c!==void 0)break}v&&v.length>0?r.sphericalPolynomial=Cu.a.ConvertCubeMapToSphericalPolynomial({size:C[bs],right:v[0],left:v[1],up:v[2],down:v[3],front:v[4],back:v[5],format:5,type:1,gammaSpace:!1}):r.sphericalPolynomial=void 0},n.StoreLODInAlphaChannel=!1,n}();fn.a.prototype.createPrefilteredCubeTexture=function(n,t,e,i,r,o,a,s,c){var v=this;r===void 0&&(r=null),o===void 0&&(o=null),s===void 0&&(s=null),c===void 0&&(c=!0);var b=function(C){if(!C){r&&r(null);return}var M=C.texture;if(c?C.info.sphericalPolynomial&&(M._sphericalPolynomial=C.info.sphericalPolynomial):M._sphericalPolynomial=new uo.b,M._source=gt.b.CubePrefiltered,v.getCaps().textureLOD){r&&r(M);return}var N=3,D=v._gl,V=C.width;if(!!V){for(var X=[],ee=0;ee<N;ee++){var ie=ee/(N-1),ge=1-ie,pe=i,te=$e.a.Log2(V)*e+i,Ce=pe+(te-pe)*ge,Ae=Math.round(Math.min(Math.max(Ce,0),te)),De=new gt.a(v,gt.b.Temp);if(De.type=M.type,De.format=M.format,De.width=Math.pow(2,Math.max($e.a.Log2(V)-Ae,0)),De.height=De.width,De.isCube=!0,v._bindTextureDirectly(D.TEXTURE_CUBE_MAP,De,!0),De.samplingMode=2,D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MAG_FILTER,D.LINEAR),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MIN_FILTER,D.LINEAR),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),C.isDDS){var Fe=C.info,We=C.data;v._unpackFlipY(Fe.isCompressed),rn.UploadDDSLevels(v,De,We,Fe,!0,6,Ae)}else p.a.Warn("DDS is the only prefiltered cube map supported so far.");v._bindTextureDirectly(D.TEXTURE_CUBE_MAP,null);var Pe=new jr.a(t);Pe.isCube=!0,Pe._texture=De,De.isReady=!0,X.push(Pe)}M._lodTextureHigh=X[2],M._lodTextureMid=X[1],M._lodTextureLow=X[0],r&&r(M)}};return this.createCubeTexture(n,t,null,!1,b,o,a,s,c,e,i)};var Rr=u(473),Gu=function(){function n(){this.supportCascades=!0}return n.prototype.canLoad=function(t){return Rr.a.EndsWith(t,".dds")},n.prototype.loadCubeData=function(t,e,i,r,o){var a=e.getEngine(),s,c=!1;if(Array.isArray(t))for(var v=0;v<t.length;v++){var b=t[v];s=rn.GetDDSInfo(b),e.width=s.width,e.height=s.height,c=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&e.generateMipMaps,a._unpackFlipY(s.isCompressed),rn.UploadDDSLevels(a,e,b,s,c,6,-1,v),!s.isFourCC&&s.mipmapCount===1&&a.generateMipMapsForCubemap(e)}else{var C=t;s=rn.GetDDSInfo(C),e.width=s.width,e.height=s.height,i&&(s.sphericalPolynomial=new uo.b),c=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&e.generateMipMaps,a._unpackFlipY(s.isCompressed),rn.UploadDDSLevels(a,e,C,s,c,6),!s.isFourCC&&s.mipmapCount===1&&a.generateMipMapsForCubemap(e,!1)}a._setCubeMapTextureParams(e,c),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r({isDDS:!0,width:e.width,info:s,data:t,texture:e})},n.prototype.loadData=function(t,e,i){var r=rn.GetDDSInfo(t),o=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&e.generateMipMaps&&r.width>>r.mipmapCount-1==1;i(r.width,r.height,o,r.isFourCC,function(){rn.UploadDDSLevels(e.getEngine(),e,t,r,o,1)})},n}();W.a._TextureLoaders.push(new Gu);var zu=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t){return Rr.a.EndsWith(t,".env")},n.prototype.loadCubeData=function(t,e,i,r,o){if(!Array.isArray(t)){var a=Wr.GetEnvInfo(t);if(a){e.width=a.width,e.height=a.width;try{Wr.UploadEnvSpherical(e,a),Wr.UploadEnvLevelsAsync(e,t,a).then(function(){e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()},function(s){o==null||o("Can not upload environment levels",s)})}catch(s){o==null||o("Can not upload environment file",s)}}else o&&o("Can not parse the environment file",null)}},n.prototype.loadData=function(t,e,i){throw".env not supported in 2d."},n}();W.a._TextureLoaders.push(new zu);var $o=function(){function n(t,e,i,r){if(this.data=t,this.isInvalid=!1,!n.IsValid(t)){this.isInvalid=!0,p.a.Error("texture missing KTX identifier");return}var o=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(this.data.buffer,this.data.byteOffset+12,13*o),s=a.getUint32(0,!0),c=s===67305985;if(this.glType=a.getUint32(1*o,c),this.glTypeSize=a.getUint32(2*o,c),this.glFormat=a.getUint32(3*o,c),this.glInternalFormat=a.getUint32(4*o,c),this.glBaseInternalFormat=a.getUint32(5*o,c),this.pixelWidth=a.getUint32(6*o,c),this.pixelHeight=a.getUint32(7*o,c),this.pixelDepth=a.getUint32(8*o,c),this.numberOfArrayElements=a.getUint32(9*o,c),this.numberOfFaces=a.getUint32(10*o,c),this.numberOfMipmapLevels=a.getUint32(11*o,c),this.bytesOfKeyValueData=a.getUint32(12*o,c),this.glType!==0){p.a.Error("only compressed formats currently supported");return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){p.a.Error("only 2D textures currently supported");return}if(this.numberOfArrayElements!==0){p.a.Error("texture arrays not currently supported");return}if(this.numberOfFaces!==e){p.a.Error("number of faces expected"+e+", but found "+this.numberOfFaces);return}this.loadType=n.COMPRESSED_2D}return n.prototype.uploadLevels=function(t,e){switch(this.loadType){case n.COMPRESSED_2D:this._upload2DCompressedLevels(t,e);break;case n.TEX_2D:case n.COMPRESSED_3D:case n.TEX_3D:}},n.prototype._upload2DCompressedLevels=function(t,e){for(var i=n.HEADER_LEN+this.bytesOfKeyValueData,r=this.pixelWidth,o=this.pixelHeight,a=e?this.numberOfMipmapLevels:1,s=0;s<a;s++){var c=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(var v=0;v<this.numberOfFaces;v++){var b=new Uint8Array(this.data.buffer,this.data.byteOffset+i,c),C=t.getEngine();C._uploadCompressedDataToTextureDirectly(t,this.glInternalFormat,r,o,b,v,s),i+=c,i+=3-(c+3)%4}r=Math.max(1,r*.5),o=Math.max(1,o*.5)}},n.IsValid=function(t){if(t.byteLength>=12){var e=new Uint8Array(t.buffer,t.byteOffset,12);if(e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===49&&e[6]===49&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10)return!0}return!1},n.HEADER_LEN=12+13*4,n.COMPRESSED_2D=0,n.COMPRESSED_3D=1,n.TEX_2D=2,n.TEX_3D=3,n}(),ju=u(575),Ps=function(){function n(t,e){e===void 0&&(e=n.DefaultNumWorkers),this._engine=t,n._Initialized||n._CreateWorkerPool(e)}return n.GetDefaultNumWorkers=function(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)},n._CreateWorkerPool=function(t){this._Initialized=!0,t&&typeof Worker=="function"?n._WorkerPoolPromise=new Promise(function(e){for(var i="("+Eg+")()",r=URL.createObjectURL(new Blob([i],{type:"application/javascript"})),o=new Array(t),a=0;a<o.length;a++)o[a]=new Promise(function(s,c){var v=new Worker(r),b=function(M){v.removeEventListener("error",b),v.removeEventListener("message",C),c(M)},C=function(M){M.data.action==="init"&&(v.removeEventListener("error",b),v.removeEventListener("message",C),s(v))};v.addEventListener("error",b),v.addEventListener("message",C),v.postMessage({action:"init",urls:n.URLConfig})});Promise.all(o).then(function(s){e(new ju.a(s))})}):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0)},n.prototype.uploadAsync=function(t,e,i){var r=this,o=this._engine.getCaps(),a={astc:!!o.astc,bptc:!!o.bptc,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,etc1:!!o.etc1};return n._WorkerPoolPromise?n._WorkerPoolPromise.then(function(s){return new Promise(function(c,v){s.push(function(b,C){var M=function(D){b.removeEventListener("error",M),b.removeEventListener("message",N),v(D),C()},N=function(D){if(D.data.action==="decoded"){if(b.removeEventListener("error",M),b.removeEventListener("message",N),!D.data.success)v({message:D.data.msg});else try{r._createTexture(D.data.decodedData,e,i),c()}catch(V){v({message:V})}C()}};b.addEventListener("error",M),b.addEventListener("message",N),b.postMessage({action:"decode",data:t,caps:a,options:i})})})}):new Promise(function(s,c){n._Ktx2Decoder||(n._Ktx2Decoder=new KTX2DECODER.KTX2Decoder),n._Ktx2Decoder.decode(t,o).then(function(v){r._createTexture(v,e),s()}).catch(function(v){c({message:v})})})},n.prototype.dispose=function(){n._WorkerPoolPromise&&n._WorkerPoolPromise.then(function(t){t.dispose()}),delete n._WorkerPoolPromise},n.prototype._createTexture=function(t,e,i){var r=3553;if(this._engine._bindTextureDirectly(r,e),i&&(i.transcodedFormat=t.transcodedFormat,i.isInGammaSpace=t.isInGammaSpace,i.hasAlpha=t.hasAlpha,i.transcoderName=t.transcoderName),t.transcodedFormat===32856?(e.type=0,e.format=5):e.format=t.transcodedFormat,e._gammaSpace=t.isInGammaSpace,e.generateMipMaps=t.mipmaps.length>1,t.errors)throw new Error("KTX2 container - could not transcode the data. "+t.errors);for(var o=0;o<t.mipmaps.length;++o){var a=t.mipmaps[o];if(!a||!a.data)throw new Error("KTX2 container - could not transcode one of the image");t.transcodedFormat===32856?(e.width=a.width,e.height=a.height,this._engine._uploadDataToTextureDirectly(e,a.data,0,o,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(e,t.transcodedFormat,a.width,a.height,a.data,0,o)}e.width=t.mipmaps[0].width,e.height=t.mipmaps[0].height,e.isReady=!0,this._engine._bindTextureDirectly(r,null)},n.IsValid=function(t){if(t.byteLength>=12){var e=new Uint8Array(t.buffer,t.byteOffset,12);if(e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===50&&e[6]===48&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10)return!0}return!1},n.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},n.DefaultNumWorkers=n.GetDefaultNumWorkers(),n}();function Eg(){var n;onmessage=function(t){switch(t.data.action){case"init":var e=t.data.urls;importScripts(e.jsDecoderModule),e.wasmUASTCToASTC!==null&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7!==null&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.jsMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder!==null&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder),n=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break;case"decode":n.decode(t.data.data,t.data.caps,t.data.options).then(function(i){for(var r=[],o=0;o<i.mipmaps.length;++o){var a=i.mipmaps[o];a&&a.data&&r.push(a.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:i},r)}).catch(function(i){postMessage({action:"decoded",success:!1,msg:i})});break}}}var Wu=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t,e){return Rr.a.EndsWith(t,".ktx")||Rr.a.EndsWith(t,".ktx2")||e==="image/ktx"||e==="image/ktx2"},n.prototype.loadCubeData=function(t,e,i,r,o){if(!Array.isArray(t)){e._invertVScale=!e.invertY;var a=e.getEngine(),s=new $o(t,6),c=s.numberOfMipmapLevels>1&&e.generateMipMaps;a._unpackFlipY(!0),s.uploadLevels(e,e.generateMipMaps),e.width=s.pixelWidth,e.height=s.pixelHeight,a._setCubeMapTextureParams(e,c),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()}},n.prototype.loadData=function(t,e,i,r){if($o.IsValid(t)){e._invertVScale=!e.invertY;var o=new $o(t,1);i(o.pixelWidth,o.pixelHeight,e.generateMipMaps,!0,function(){o.uploadLevels(e,e.generateMipMaps)},o.isInvalid)}else if(Ps.IsValid(t)){var a=new Ps(e.getEngine());a.uploadAsync(t,e,r).then(function(){i(e.width,e.height,e.generateMipMaps,!0,function(){},!1)},function(s){p.a.Warn("Failed to load KTX2 texture data: "+s.message),i(0,0,!1,!1,function(){},!0)})}else p.a.Error("texture missing KTX identifier"),i(0,0,!1,!1,function(){},!0)},n}();W.a._TextureLoaders.unshift(new Wu);var Hu=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,l.e.Zero(),i)||this;return o._xrSessionManager=r,o._firstFrame=!1,o._referenceQuaternion=l.b.Identity(),o._referencedPosition=new l.e,o._xrInvPositionCache=new l.e,o._xrInvQuaternionCache=l.b.Identity(),o._trackingState=Nr.NOT_TRACKING,o.onBeforeCameraTeleport=new _.c,o.onAfterCameraTeleport=new _.c,o.onTrackingStateChanged=new _.c,o.compensateOnFirstFrame=!0,o._rotate180=new l.b(0,1,0,0),o.minZ=.1,o.rotationQuaternion=new l.b,o.cameraRigMode=Z.a.RIG_MODE_CUSTOM,o.updateUpVectorFromRotation=!0,o._updateNumberOfRigCameras(1),o.freezeProjectionMatrix(),o._xrSessionManager.onXRSessionInit.add(function(){o._referencedPosition.copyFromFloats(0,0,0),o._referenceQuaternion.copyFromFloats(0,0,0,1),o._firstFrame=o.compensateOnFirstFrame}),o._xrSessionManager.onXRFrameObservable.add(function(a){o._firstFrame&&o._updateFromXRSession(),o._updateReferenceSpace(),o._updateFromXRSession()},void 0,!0),o}return Object.defineProperty(t.prototype,"trackingState",{get:function(){return this._trackingState},enumerable:!1,configurable:!0}),t.prototype._setTrackingState=function(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))},Object.defineProperty(t.prototype,"realWorldHeight",{get:function(){var e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0},enumerable:!1,configurable:!0}),t.prototype._updateForDualEyeDebugging=function(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new lr.a(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new lr.a(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null},t.prototype.setTransformationFromNonVRCamera=function(e,i){if(e===void 0&&(e=this.getScene().activeCamera),i===void 0&&(i=!0),!(!e||e===this)){var r=e.computeWorldMatrix();r.decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,l.b.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,i&&this._xrSessionManager.resetReferenceSpace()}},t.prototype.getClassName=function(){return"WebXRCamera"},t.prototype._updateFromXRSession=function(){var e=this,i=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(!i){this._setTrackingState(Nr.NOT_TRACKING);return}var r=i.emulatedPosition?Nr.TRACKING_LOST:Nr.TRACKING;if(this._setTrackingState(r),i.transform){var o=i.transform.position;this._referencedPosition.set(o.x,o.y,o.z);var a=i.transform.orientation;this._referenceQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==i.views.length&&this._updateNumberOfRigCameras(i.views.length),i.views.forEach(function(s,c){var v=e.rigCameras[c];!v.isLeftCamera&&!v.isRightCamera&&(s.eye==="right"?v._isRightCamera=!0:s.eye==="left"&&(v._isLeftCamera=!0));var b=s.transform.position,C=s.transform.orientation;if(v.position.set(b.x,b.y,b.z),v.rotationQuaternion.set(C.x,C.y,C.z,C.w),e._scene.useRightHandedSystem?v.rotationQuaternion.multiplyInPlace(e._rotate180):(v.position.z*=-1,v.rotationQuaternion.z*=-1,v.rotationQuaternion.w*=-1),l.a.FromFloat32ArrayToRefScaled(s.projectionMatrix,0,1,v._projectionMatrix),e._scene.useRightHandedSystem||v._projectionMatrix.toggleProjectionMatrixHandInPlace(),c===0&&e._projectionMatrix.copyFrom(v._projectionMatrix),e._xrSessionManager.session.renderState.baseLayer){var M=e._xrSessionManager.session.renderState.baseLayer.getViewport(s),N=e._xrSessionManager.session.renderState.baseLayer.framebufferWidth,D=e._xrSessionManager.session.renderState.baseLayer.framebufferHeight;v.viewport.width=M.width/N,v.viewport.height=M.height/D,v.viewport.x=M.x/N,v.viewport.y=M.y/D}v.outputRenderTarget=e._xrSessionManager.getRenderTargetTextureForEye(s.eye)})},t.prototype._updateNumberOfRigCameras=function(e){for(e===void 0&&(e=1);this.rigCameras.length<e;){var i=new Ii.a("XR-RigCamera: "+this.rigCameras.length,l.e.Zero(),this.getScene());i.minZ=.1,i.rotationQuaternion=new l.b,i.updateUpVectorFromRotation=!0,i.isRigCamera=!0,i.rigParent=this,i.freezeProjectionMatrix(),this.rigCameras.push(i)}for(;this.rigCameras.length>e;){var r=this.rigCameras.pop();r&&r.dispose()}},t.prototype._updateReferenceSpace=function(){(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion))&&(this.position.subtractToRef(this._referencedPosition,this._referencedPosition),this._referenceQuaternion.conjugateInPlace(),this._referenceQuaternion.multiplyToRef(this.rotationQuaternion,this._referenceQuaternion),this._updateReferenceSpaceOffset(this._referencedPosition,this._referenceQuaternion.normalize()))},t.prototype._updateReferenceSpaceOffset=function(e,i,r){if(r===void 0&&(r=!1),!(!this._xrSessionManager.referenceSpace||!this._xrSessionManager.currentFrame)){this._xrInvPositionCache.copyFrom(e),i?this._xrInvQuaternionCache.copyFrom(i):this._xrInvQuaternionCache.copyFromFloats(0,0,0,1),this._scene.useRightHandedSystem||(this._xrInvPositionCache.z*=-1,this._xrInvQuaternionCache.z*=-1,this._xrInvQuaternionCache.w*=-1),this._xrInvPositionCache.negateInPlace(),this._xrInvQuaternionCache.conjugateInPlace(),this._xrInvPositionCache.rotateByQuaternionToRef(this._xrInvQuaternionCache,this._xrInvPositionCache),r&&(this._xrInvPositionCache.y=0);var o=new XRRigidTransform({x:this._xrInvPositionCache.x,y:this._xrInvPositionCache.y,z:this._xrInvPositionCache.z},{x:this._xrInvQuaternionCache.x,y:this._xrInvQuaternionCache.y,z:this._xrInvQuaternionCache.z,w:this._xrInvQuaternionCache.w}),a=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(o),s=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(a);if(s){var c=new l.e(s.transform.position.x,s.transform.position.y,s.transform.position.z);this._scene.useRightHandedSystem||(c.z*=-1),this.position.subtractToRef(c,c),this._scene.useRightHandedSystem||(c.z*=-1),c.negateInPlace();var v=new XRRigidTransform({x:c.x,y:c.y,z:c.z});this._xrSessionManager.referenceSpace=a.getOffsetReferenceSpace(v)}}},t}(Wt.a),ur=function(){function n(){}return n.ANCHOR_SYSTEM="xr-anchor-system",n.BACKGROUND_REMOVER="xr-background-remover",n.HIT_TEST="xr-hit-test",n.MESH_DETECTION="xr-mesh-detection",n.PHYSICS_CONTROLLERS="xr-physics-controller",n.PLANE_DETECTION="xr-plane-detection",n.POINTER_SELECTION="xr-controller-pointer-selection",n.TELEPORTATION="xr-controller-teleportation",n.FEATURE_POINTS="xr-feature-points",n.HAND_TRACKING="xr-hand-tracking",n.IMAGE_TRACKING="xr-image-tracking",n}(),or=function(){function n(t){var e=this;this._xrSessionManager=t,this._features={},this._xrSessionManager.onXRSessionInit.add(function(){e.getEnabledFeatures().forEach(function(i){var r=e._features[i];r.enabled&&!r.featureImplementation.attached&&!r.featureImplementation.disableAutoAttach&&e.attachFeature(i)})}),this._xrSessionManager.onXRSessionEnded.add(function(){e.getEnabledFeatures().forEach(function(i){var r=e._features[i];r.enabled&&r.featureImplementation.attached&&e.detachFeature(i)})})}return n.AddWebXRFeature=function(t,e,i,r){i===void 0&&(i=1),r===void 0&&(r=!1),this._AvailableFeatures[t]=this._AvailableFeatures[t]||{latest:i},i>this._AvailableFeatures[t].latest&&(this._AvailableFeatures[t].latest=i),r&&(this._AvailableFeatures[t].stable=i),this._AvailableFeatures[t][i]=e},n.ConstructFeature=function(t,e,i,r){e===void 0&&(e=1);var o=this._AvailableFeatures[t][e];if(!o)throw new Error("feature not found");return o(i,r)},n.GetAvailableFeatures=function(){return Object.keys(this._AvailableFeatures)},n.GetAvailableVersions=function(t){return Object.keys(this._AvailableFeatures[t])},n.GetLatestVersionOfFeature=function(t){return this._AvailableFeatures[t]&&this._AvailableFeatures[t].latest||-1},n.GetStableVersionOfFeature=function(t){return this._AvailableFeatures[t]&&this._AvailableFeatures[t].stable||-1},n.prototype.attachFeature=function(t){var e=this._features[t];e&&e.enabled&&!e.featureImplementation.attached&&e.featureImplementation.attach()},n.prototype.detachFeature=function(t){var e=this._features[t];e&&e.featureImplementation.attached&&e.featureImplementation.detach()},n.prototype.disableFeature=function(t){var e=typeof t=="string"?t:t.Name,i=this._features[e];return i&&i.enabled?(i.enabled=!1,this.detachFeature(e),i.featureImplementation.dispose(),!0):!1},n.prototype.dispose=function(){var t=this;this.getEnabledFeatures().forEach(function(e){t.disableFeature(e),t._features[e].featureImplementation.dispose()})},n.prototype.enableFeature=function(t,e,i,r,o){var a=this;e===void 0&&(e="latest"),i===void 0&&(i={}),r===void 0&&(r=!0),o===void 0&&(o=!0);var s=typeof t=="string"?t:t.Name,c=0;if(typeof e=="string"){if(!e)throw new Error("Error in provided version - "+s+" ("+e+")");if(e==="stable"?c=n.GetStableVersionOfFeature(s):e==="latest"?c=n.GetLatestVersionOfFeature(s):c=+e,c===-1||isNaN(c))throw new Error("feature not found - "+s+" ("+e+")")}else c=e;var v=this._features[s],b=n.ConstructFeature(s,c,this._xrSessionManager,i);if(!b)throw new Error("feature not found - "+s);v&&this.disableFeature(s);var C=b();if(C.dependsOn){var M=C.dependsOn.every(function(N){return!!a._features[N]});if(!M)throw new Error("Dependant features missing. Make sure the following features are enabled - "+C.dependsOn.join(", "))}if(C.isCompatible())return this._features[s]={featureImplementation:C,enabled:!0,version:c,required:o},r?this._xrSessionManager.session&&!this._features[s].featureImplementation.attached&&this.attachFeature(s):this._features[s].featureImplementation.disableAutoAttach=!0,this._features[s].featureImplementation;if(o)throw new Error("required feature not compatible");return J.b.Warn("Feature "+s+" not compatible with the current environment/browser and was not enabled."),C},n.prototype.getEnabledFeature=function(t){return this._features[t]&&this._features[t].featureImplementation},n.prototype.getEnabledFeatures=function(){return Object.keys(this._features)},n.prototype._extendXRSessionInitObject=function(t){return Object(h.b)(this,void 0,void 0,function(){var e,i,r,o,a,s,c;return Object(h.e)(this,function(v){switch(v.label){case 0:e=this.getEnabledFeatures(),i=0,r=e,v.label=1;case 1:return i<r.length?(o=r[i],a=this._features[o],s=a.featureImplementation.xrNativeFeatureName,s&&(a.required?(t.requiredFeatures=t.requiredFeatures||[],t.requiredFeatures.indexOf(s)===-1&&t.requiredFeatures.push(s)):(t.optionalFeatures=t.optionalFeatures||[],t.optionalFeatures.indexOf(s)===-1&&t.optionalFeatures.push(s))),a.featureImplementation.getXRSessionInitExtension?[4,a.featureImplementation.getXRSessionInitExtension()]:[3,3]):[3,4];case 2:c=v.sent(),t=Object(h.a)(Object(h.a)({},t),c),v.label=3;case 3:return i++,[3,1];case 4:return[2,t]}})})},n._AvailableFeatures={},n}(),ku=function(){function n(t){var e=this;this.scene=t,this._nonVRCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this.onInitialXRPoseSetObservable=new _.c,this.onStateChangedObservable=new _.c,this.state=pi.NOT_IN_XR,this.sessionManager=new bn(t),this.camera=new Hu("",t,this.sessionManager),this.featuresManager=new or(this.sessionManager),t.onDisposeObservable.add(function(){e.exitXRAsync()})}return n.CreateAsync=function(t){var e=new n(t);return e.sessionManager.initializeAsync().then(function(){return e._supported=!0,e}).catch(function(i){throw e._setState(pi.NOT_IN_XR),e.dispose(),i})},n.prototype.dispose=function(){this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._nonVRCamera&&(this.scene.activeCamera=this._nonVRCamera)},n.prototype.enterXRAsync=function(t,e,i,r){return i===void 0&&(i=this.sessionManager.getWebXRRenderTarget()),r===void 0&&(r={}),Object(h.b)(this,void 0,void 0,function(){var o,a=this;return Object(h.e)(this,function(s){switch(s.label){case 0:if(!this._supported)throw"WebXR not supported in this browser or environment";return this._setState(pi.ENTERING_XR),e!=="viewer"&&e!=="local"&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(e)),[4,this.featuresManager._extendXRSessionInitObject(r)];case 1:r=s.sent(),t==="immersive-ar"&&e!=="unbounded"&&p.a.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode"),s.label=2;case 2:return s.trys.push([2,7,,8]),[4,this.sessionManager.initializeSessionAsync(t,r)];case 3:return s.sent(),[4,this.sessionManager.setReferenceSpaceTypeAsync(e)];case 4:return s.sent(),[4,i.initializeXRLayerAsync(this.sessionManager.session)];case 5:return s.sent(),[4,this.sessionManager.updateRenderStateAsync({depthFar:this.camera.maxZ,depthNear:this.camera.minZ,baseLayer:i.xrLayer})];case 6:return s.sent(),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this.scene.autoClear,this._nonVRCamera=this.scene.activeCamera,this.scene.activeCamera=this.camera,t!=="immersive-ar"?this._nonXRToXRCamera():(this.scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1),this.sessionManager.onXRSessionEnded.addOnce(function(){a.camera.rigCameras.forEach(function(c){c.outputRenderTarget=null}),a.scene.autoClear=a._originalSceneAutoClear,a.scene.activeCamera=a._nonVRCamera,t!=="immersive-ar"&&a.camera.compensateOnFirstFrame&&(a._nonVRCamera.setPosition?a._nonVRCamera.setPosition(a.camera.position):a._nonVRCamera.position.copyFrom(a.camera.position)),a._setState(pi.NOT_IN_XR)}),this.sessionManager.onXRFrameObservable.addOnce(function(){a._setState(pi.IN_XR)}),[2,this.sessionManager];case 7:throw o=s.sent(),console.log(o),console.log(o.message),this._setState(pi.NOT_IN_XR),o;case 8:return[2]}})})},n.prototype.exitXRAsync=function(){return this.state!==pi.IN_XR?Promise.resolve():(this._setState(pi.EXITING_XR),this.sessionManager.exitXRAsync())},n.prototype._nonXRToXRCamera=function(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)},n.prototype._setState=function(t){this.state!==t&&(this.state=t,this.onStateChangedObservable.notifyObservers(this.state))},n}(),Rn=function(){function n(t,e,i,r){i===void 0&&(i=-1),r===void 0&&(r=[]),this.id=t,this.type=e,this._buttonIndex=i,this._axesIndices=r,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new _.c,this.onButtonStateChangedObservable=new _.c}return Object.defineProperty(n.prototype,"axes",{get:function(){return this._axes},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"changes",{get:function(){return this._changes},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasChanges",{get:function(){return this._hasChanges},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"pressed",{get:function(){return this._pressed},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"touched",{get:function(){return this._touched},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"value",{get:function(){return this._currentValue},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()},n.prototype.isAxes=function(){return this._axesIndices.length!==0},n.prototype.isButton=function(){return this._buttonIndex!==-1},n.prototype.update=function(t){var e=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){var r=t.buttons[this._buttonIndex];if(!r)return;this._currentValue!==r.value&&(this.changes.value={current:r.value,previous:this._currentValue},e=!0,this._currentValue=r.value),this._touched!==r.touched&&(this.changes.touched={current:r.touched,previous:this._touched},e=!0,this._touched=r.touched),this._pressed!==r.pressed&&(this.changes.pressed={current:r.pressed,previous:this._pressed},e=!0,this._pressed=r.pressed)}this.isAxes()&&(this._axes.x!==t.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:t.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=t.axes[this._axesIndices[0]],i=!0),this._axes.y!==t.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=t.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:t.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=t.axes[this._axesIndices[1]],i=!0)),e&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))},n.BUTTON_TYPE="button",n.SQUEEZE_TYPE="squeeze",n.THUMBSTICK_TYPE="thumbstick",n.TOUCHPAD_TYPE="touchpad",n.TRIGGER_TYPE="trigger",n}(),An=function(){function n(t,e,i,r,o){var a=this;o===void 0&&(o=!1),this.scene=t,this.layout=e,this.gamepadObject=i,this.handedness=r,this._initComponent=function(s){if(!!s){var c=a.layout.components[s],v=c.type,b=c.gamepadIndices.button,C=[];c.gamepadIndices.xAxis!==void 0&&c.gamepadIndices.yAxis!==void 0&&C.push(c.gamepadIndices.xAxis,c.gamepadIndices.yAxis),a.components[s]=new Rn(s,v,b,C)}},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new _.c,e.components&&Object.keys(e.components).forEach(this._initComponent)}return n.prototype.dispose=function(){var t=this;this.getComponentIds().forEach(function(e){return t.getComponent(e).dispose()}),this.rootMesh&&this.rootMesh.dispose()},n.prototype.getAllComponentsOfType=function(t){var e=this;return this.getComponentIds().map(function(i){return e.components[i]}).filter(function(i){return i.type===t})},n.prototype.getComponent=function(t){return this.components[t]},n.prototype.getComponentIds=function(){return Object.keys(this.components)},n.prototype.getComponentOfType=function(t){return this.getAllComponentsOfType(t)[0]||null},n.prototype.getMainComponent=function(){return this.getComponent(this.layout.selectComponentId)},n.prototype.loadModel=function(){return Object(h.b)(this,void 0,void 0,function(){var t,e,i=this;return Object(h.e)(this,function(r){return t=!this._getModelLoadingConstraints(),e=this._getGenericFilenameAndPath(),t?p.a.Warn("Falling back to generic models"):e=this._getFilenameAndPath(),[2,new Promise(function(o,a){Mi.a.ImportMesh("",e.path,e.filename,i.scene,function(s){t?i._getGenericParentMesh(s):i._setRootMesh(s),i._processLoadedModel(s),i._modelReady=!0,i.onModelLoadedObservable.notifyObservers(i),o(!0)},null,function(s,c){p.a.Log(c),p.a.Warn("Failed to retrieve controller model of type "+i.profileId+" from the remote server: "+e.path+e.filename),a(c)})})]})})},n.prototype.updateFromXRFrame=function(t){var e=this;this.getComponentIds().forEach(function(i){return e.getComponent(i).update(e.gamepadObject)}),this.updateModel(t)},Object.defineProperty(n.prototype,"handness",{get:function(){return this.handedness},enumerable:!1,configurable:!0}),n.prototype.pulse=function(t,e,i){return i===void 0&&(i=0),this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(t,e):Promise.resolve(!1)},n.prototype._getChildByName=function(t,e){return t.getChildren(function(i){return i.name===e},!1)[0]},n.prototype._getImmediateChildByName=function(t,e){return t.getChildren(function(i){return i.name==e},!0)[0]},n.prototype._lerpTransform=function(t,e,i){if(!(!t.minMesh||!t.maxMesh||!t.valueMesh)&&!(!t.minMesh.rotationQuaternion||!t.maxMesh.rotationQuaternion||!t.valueMesh.rotationQuaternion)){var r=i?e*.5+.5:e;l.b.SlerpToRef(t.minMesh.rotationQuaternion,t.maxMesh.rotationQuaternion,r,t.valueMesh.rotationQuaternion),l.e.LerpToRef(t.minMesh.position,t.maxMesh.position,r,t.valueMesh.position)}},n.prototype.updateModel=function(t){!this._modelReady||this._updateModel(t)},n.prototype._getGenericFilenameAndPath=function(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}},n.prototype._getGenericParentMesh=function(t){var e=this;this.rootMesh=new ot.a(this.profileId+" "+this.handedness,this.scene),t.forEach(function(i){i.parent||(i.isPickable=!1,i.setParent(e.rootMesh))}),this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0)},n}(),Cs=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,Pg[r],i,r)||this;return o.profileId=t.ProfileId,o}return t.prototype._getFilenameAndPath=function(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}},t.prototype._getModelLoadingConstraints=function(){return!0},t.prototype._processLoadedModel=function(e){},t.prototype._setRootMesh=function(e){var i=this;this.rootMesh=new ot.a(this.profileId+" "+this.handedness,this.scene),e.forEach(function(r){r.isPickable=!1,r.parent||r.setParent(i.rootMesh)}),this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0)},t.prototype._updateModel=function(){},t.ProfileId="generic-trigger",t}(An),Pg={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}},Xu=function(n){Object(h.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,r.layouts[i.handedness||"none"],i.gamepad,i.handedness)||this;return a._repositoryUrl=o,a._buttonMeshMapping={},a._touchDots={},a.profileId=r.profileId,a}return t.prototype.dispose=function(){var e=this;n.prototype.dispose.call(this),Object.keys(this._touchDots).forEach(function(i){e._touchDots[i].dispose()})},t.prototype._getFilenameAndPath=function(){return{filename:this.layout.assetPath,path:this._repositoryUrl+"/profiles/"+this.profileId+"/"}},t.prototype._getModelLoadingConstraints=function(){var e=Mi.a.IsPluginForExtensionAvailable(".glb");return e||p.a.Warn("glTF / glb loader was not registered, using generic controller instead"),e},t.prototype._processLoadedModel=function(e){var i=this;this.getComponentIds().forEach(function(r){var o=i.layout.components[r];i._buttonMeshMapping[r]={mainMesh:i._getChildByName(i.rootMesh,o.rootNodeName),states:{}},Object.keys(o.visualResponses).forEach(function(a){var s=o.visualResponses[a];if(s.valueNodeProperty==="transform")i._buttonMeshMapping[r].states[a]={valueMesh:i._getChildByName(i.rootMesh,s.valueNodeName),minMesh:i._getChildByName(i.rootMesh,s.minNodeName),maxMesh:i._getChildByName(i.rootMesh,s.maxNodeName)};else{var c=o.type===Rn.TOUCHPAD_TYPE&&o.touchPointNodeName?o.touchPointNodeName:s.valueNodeName;if(i._buttonMeshMapping[r].states[a]={valueMesh:i._getChildByName(i.rootMesh,c)},o.type===Rn.TOUCHPAD_TYPE&&!i._touchDots[a]){var v=nr.a.CreateSphere(a+"dot",{diameter:.0015,segments:8},i.scene);v.material=new Gt.a(a+"mat",i.scene),v.material.diffuseColor=m.a.Red(),v.parent=i._buttonMeshMapping[r].states[a].valueMesh||null,v.isVisible=!1,i._touchDots[a]=v}}})})},t.prototype._setRootMesh=function(e){this.rootMesh=new ot.a(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(var i,r=0;r<e.length;r++){var o=e[r];o.isPickable=!1,o.parent||(i=o)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(xe.a.Y,Math.PI,xe.c.WORLD)},t.prototype._updateModel=function(e){var i=this;this.disableAnimation||this.getComponentIds().forEach(function(r){var o=i.getComponent(r);if(!!o.hasChanges){var a=i._buttonMeshMapping[r],s=i.layout.components[r];Object.keys(s.visualResponses).forEach(function(c){var v=s.visualResponses[c],b=o.value;if(v.componentProperty==="xAxis"?b=o.axes.x:v.componentProperty==="yAxis"&&(b=o.axes.y),v.valueNodeProperty==="transform")i._lerpTransform(a.states[c],b,v.componentProperty!=="button");else{var C=a.states[c].valueMesh;C&&(C.isVisible=o.touched||o.pressed),i._touchDots[c]&&(i._touchDots[c].isVisible=o.touched||o.pressed)}})}})},t}(An),ar=function(){function n(){}return n.ClearProfilesCache=function(){this._ProfilesList=null,this._ProfileLoadingPromises={}},n.DefaultFallbacks=function(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"])},n.FindFallbackWithProfileId=function(t){var e=this._Fallbacks[t]||[];return e.unshift(t),e},n.GetMotionControllerWithXRInput=function(t,e,i){var r=this,o=[];if(i&&o.push(i),o.push.apply(o,t.profiles||[]),o.length&&!o[0]&&o.pop(),t.gamepad&&t.gamepad.id)switch(t.gamepad.id){case(t.gamepad.id.match(/oculus touch/gi)?t.gamepad.id:void 0):o.push("oculus-touch-v2");break}var a=o.indexOf("windows-mixed-reality");if(a!==-1&&o.splice(a,0,"microsoft-mixed-reality"),o.length||o.push("generic-trigger"),this.UseOnlineRepository){var s=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,c=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return s.call(this,o,t,e).catch(function(){return c.call(r,o,t,e)})}else return this._LoadProfilesFromAvailableControllers(o,t,e)},n.RegisterController=function(t,e){this._AvailableControllers[t]=e},n.RegisterFallbacksForProfileId=function(t,e){var i;this._Fallbacks[t]?(i=this._Fallbacks[t]).push.apply(i,e):this._Fallbacks[t]=e},n.UpdateProfilesList=function(){return this._ProfilesList=J.b.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(function(t){return JSON.parse(t.toString())}),this._ProfilesList},n._LoadProfileFromRepository=function(t,e,i){var r=this;return Promise.resolve().then(function(){return r._ProfilesList?r._ProfilesList:r.UpdateProfilesList()}).then(function(o){for(var a=0;a<t.length;++a)if(!!t[a]&&o[t[a]])return t[a];throw new Error("neither controller "+t[0]+" nor all fallbacks were found in the repository,")}).then(function(o){return r._ProfileLoadingPromises[o]||(r._ProfileLoadingPromises[o]=J.b.LoadFileAsync(r.BaseRepositoryUrl+"/profiles/"+o+"/profile.json",!1).then(function(a){return JSON.parse(a)})),r._ProfileLoadingPromises[o]}).then(function(o){return new Xu(i,e,o,r.BaseRepositoryUrl)})},n._LoadProfilesFromAvailableControllers=function(t,e,i){for(var r=0;r<t.length;++r)if(!!t[r])for(var o=this.FindFallbackWithProfileId(t[r]),a=0;a<o.length;++a){var s=this._AvailableControllers[o[a]];if(s)return Promise.resolve(s(e,i))}throw new Error("no controller requested was found in the available controllers list")},n._AvailableControllers={},n._Fallbacks={},n._ProfileLoadingPromises={},n.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",n.PrioritizeOnlineRepository=!0,n.UseOnlineRepository=!0,n}();ar.RegisterController(Cs.ProfileId,function(n,t){return new Cs(t,n.gamepad,n.handedness)}),ar.DefaultFallbacks();var Cg=0,Yu=function(){function n(t,e,i){var r=this;i===void 0&&(i={}),this._scene=t,this.inputSource=e,this._options=i,this._tmpVector=new l.e,this._disposed=!1,this.onDisposeObservable=new _.c,this.onMeshLoadedObservable=new _.c,this.onMotionControllerInitObservable=new _.c,this._uniqueId="controller-"+Cg+++"-"+e.targetRayMode+"-"+e.handedness,this.pointer=new Ue.a(this._uniqueId+"-pointer",t),this.pointer.rotationQuaternion=new l.b,this.inputSource.gripSpace&&(this.grip=new Ue.a(this._uniqueId+"-grip",this._scene),this.grip.rotationQuaternion=new l.b),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&ar.GetMotionControllerWithXRInput(e,t,this._options.forceControllerProfile).then(function(o){r.motionController=o,r.onMotionControllerInitObservable.notifyObservers(o),r._options.doNotLoadControllerMesh||r.motionController.loadModel().then(function(a){var s;a&&r.motionController&&r.motionController.rootMesh&&(r._options.renderingGroupId&&(r.motionController.rootMesh.renderingGroupId=r._options.renderingGroupId,r.motionController.rootMesh.getChildMeshes(!1).forEach(function(c){return c.renderingGroupId=r._options.renderingGroupId})),r.onMeshLoadedObservable.notifyObservers(r.motionController.rootMesh),r.motionController.rootMesh.parent=r.grip||r.pointer,r.motionController.disableAnimation=!!r._options.disableMotionControllerAnimation),r._disposed&&((s=r.motionController)===null||s===void 0||s.dispose())})},function(){J.b.Warn("Could not find a matching motion controller for the registered input source")})}return Object.defineProperty(n.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this.grip&&this.grip.dispose(),this.motionController&&this.motionController.dispose(),this.pointer.dispose(),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0},n.prototype.getWorldPointerRayToRef=function(t,e){e===void 0&&(e=!1);var i=e&&this.grip?this.grip:this.pointer;l.e.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),t.direction),t.direction.normalize(),t.origin.copyFrom(i.absolutePosition),t.length=1e3},n.prototype.updateFromXRFrame=function(t,e){var i=t.getPose(this.inputSource.targetRaySpace,e);if(i){var r=i.transform.position;this.pointer.position.set(r.x,r.y,r.z);var o=i.transform.orientation;this.pointer.rotationQuaternion.set(o.x,o.y,o.z,o.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1)}if(this.inputSource.gripSpace&&this.grip){var a=t.getPose(this.inputSource.gripSpace,e);if(a){var r=a.transform.position,s=a.transform.orientation;this.grip.position.set(r.x,r.y,r.z),this.grip.rotationQuaternion.set(s.x,s.y,s.z,s.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}}this.motionController&&this.motionController.updateFromXRFrame(t)},n}(),Ku=function(){function n(t,e,i){var r=this;if(i===void 0&&(i={}),this.xrSessionManager=t,this.xrCamera=e,this.options=i,this.controllers=[],this.onControllerAddedObservable=new _.c,this.onControllerRemovedObservable=new _.c,this._onInputSourcesChange=function(o){r._addAndRemoveControllers(o.added,o.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(function(){r._addAndRemoveControllers([],r.controllers.map(function(o){return o.inputSource}))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(function(o){o.addEventListener("inputsourceschange",r._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(function(o){r.controllers.forEach(function(a){a.updateFromXRFrame(o,r.xrSessionManager.referenceSpace)})}),this.options.customControllersRepositoryURL&&(ar.BaseRepositoryUrl=this.options.customControllersRepositoryURL),ar.UseOnlineRepository=!this.options.disableOnlineControllerRepository,ar.UseOnlineRepository)try{ar.UpdateProfilesList().catch(function(){ar.UseOnlineRepository=!1})}catch(o){ar.UseOnlineRepository=!1}}return n.prototype._addAndRemoveControllers=function(t,e){for(var i=this,r=this.controllers.map(function(C){return C.inputSource}),o=0,a=t;o<a.length;o++){var s=a[o];if(r.indexOf(s)===-1){var c=new Yu(this.xrSessionManager.scene,s,Object(h.a)(Object(h.a)({},this.options.controllerOptions||{}),{forceControllerProfile:this.options.forceInputProfile,doNotLoadControllerMesh:this.options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this.options.disableControllerAnimation}));this.controllers.push(c),this.onControllerAddedObservable.notifyObservers(c)}}var v=[],b=[];this.controllers.forEach(function(C){e.indexOf(C.inputSource)===-1?v.push(C):b.push(C)}),this.controllers=v,b.forEach(function(C){i.onControllerRemovedObservable.notifyObservers(C),C.dispose()})},n.prototype.dispose=function(){this.controllers.forEach(function(t){t.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear()},n}(),cr=function(){function n(t){this._xrSessionManager=t,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}return Object.defineProperty(n.prototype,"attached",{get:function(){return this._attached},enumerable:!1,configurable:!0}),n.prototype.attach=function(t){var e=this;if(this.isDisposed)return!1;if(t)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,function(i){return e._onXRFrame(i)}),!0},n.prototype.detach=function(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(function(t){t.observable.remove(t.observer)}),!0):(this.disableAutoAttach=!0,!1)},n.prototype.dispose=function(){this.detach(),this.isDisposed=!0},n.prototype.isCompatible=function(){return!0},n.prototype._addNewAttachObserver=function(t,e){this._removeOnDetach.push({observable:t,observer:t.add(e)})},n}(),vo=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r._options=i,r._attachController=function(o){if(!r._controllers[o.uniqueId]){var a=r._generateNewMeshPair(o.pointer),s=a.laserPointer,c=a.selectionMesh;switch(r._controllers[o.uniqueId]={xrController:o,laserPointer:s,selectionMesh:c,meshUnderPointer:null,pick:null,tmpRay:new Zt.a(new l.e,new l.e),id:t._idCounter++},r._attachedController?!r._options.enablePointerSelectionOnAllControllers&&r._options.preferredHandedness&&o.inputSource.handedness===r._options.preferredHandedness&&(r._attachedController=o.uniqueId):r._options.enablePointerSelectionOnAllControllers||(r._attachedController=o.uniqueId),o.inputSource.targetRayMode){case"tracked-pointer":return r._attachTrackedPointerRayMode(o);case"gaze":return r._attachGazeMode(o);case"screen":return r._attachScreenRayMode(o)}}},r._controllers={},r._tmpVectorForPickCompare=new l.e,r.disablePointerLighting=!0,r.disableSelectionMeshLighting=!0,r.displayLaserPointer=!0,r.displaySelectionMesh=!0,r.laserPointerPickedColor=new m.a(.9,.9,.9),r.laserPointerDefaultColor=new m.a(.7,.7,.7),r.selectionMeshDefaultColor=new m.a(.8,.8,.8),r.selectionMeshPickedColor=new m.a(.3,.3,1),r._identityMatrix=l.a.Identity(),r._screenCoordinatesRef=l.e.Zero(),r._viewportRef=new lr.a(0,0,0,0),r._scene=r._xrSessionManager.scene,r}return t.prototype.attach=function(){var e=this;if(!n.prototype.attach.call(this))return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(s){e._detachController(s.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){var i=this._options.gazeCamera,r=this._generateNewMeshPair(i),o=r.laserPointer,a=r.selectionMesh;this._controllers.camera={webXRCamera:i,laserPointer:o,selectionMesh:a,meshUnderPointer:null,pick:null,tmpRay:new Zt.a(new l.e,new l.e),id:t._idCounter++},this._attachGazeMode()}return!0},t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(i){e._detachController(i)}),!0):!1},t.prototype.getMeshUnderPointer=function(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null},t.prototype.getXRControllerByPointerId=function(e){for(var i=Object.keys(this._controllers),r=0;r<i.length;++r)if(this._controllers[i[r]].id===e)return this._controllers[i[r]].xrController||null;return null},t.prototype._onXRFrame=function(e){var i=this;Object.keys(this._controllers).forEach(function(r){var o=i._controllers[r];if(!i._options.enablePointerSelectionOnAllControllers&&r!==i._attachedController){o.selectionMesh.isVisible=!1,o.laserPointer.isVisible=!1,o.pick=null;return}o.laserPointer.isVisible=i.displayLaserPointer;var a;if(o.xrController)a=o.xrController.pointer.position,o.xrController.getWorldPointerRayToRef(o.tmpRay);else if(o.webXRCamera)a=o.webXRCamera.position,o.webXRCamera.getForwardRayToRef(o.tmpRay);else return;if(i._options.maxPointerDistance&&(o.tmpRay.length=i._options.maxPointerDistance),!i._options.disableScenePointerVectorUpdate&&a){var s=i._xrSessionManager.scene,c=i._options.xrInput.xrCamera;c&&(c.viewport.toGlobalToRef(s.getEngine().getRenderWidth(),s.getEngine().getRenderHeight(),i._viewportRef),l.e.ProjectToRef(a,i._identityMatrix,s.getTransformMatrix(),i._viewportRef,i._screenCoordinatesRef),s.pointerX=i._screenCoordinatesRef.x,s.pointerY=i._screenCoordinatesRef.y)}o.pick=i._scene.pickWithRay(o.tmpRay,i._scene.pointerMovePredicate||i.raySelectionPredicate);var v=o.pick;if(v&&v.pickedPoint&&v.hit){i._updatePointerDistance(o.laserPointer,v.distance),o.selectionMesh.position.copyFrom(v.pickedPoint),o.selectionMesh.scaling.x=Math.sqrt(v.distance),o.selectionMesh.scaling.y=Math.sqrt(v.distance),o.selectionMesh.scaling.z=Math.sqrt(v.distance);var b=i._convertNormalToDirectionOfRay(v.getNormal(!0),o.tmpRay),C=.001;if(o.selectionMesh.position.copyFrom(v.pickedPoint),b){var M=l.e.Cross(xe.a.Y,b),N=l.e.Cross(b,M);l.e.RotationFromAxisToRef(N,b,M,o.selectionMesh.rotation),o.selectionMesh.position.addInPlace(b.scale(C))}o.selectionMesh.isVisible=i.displaySelectionMesh,o.meshUnderPointer=v.pickedMesh}else o.selectionMesh.isVisible=!1,i._updatePointerDistance(o.laserPointer,1),o.meshUnderPointer=null})},t.prototype._attachGazeMode=function(e){var i=this,r=this._controllers[e&&e.uniqueId||"camera"],o=this._options.timeToSelect||3e3,a=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xi.a.DefaultUtilityLayer.utilityLayerScene:this._scene,s=new mt.a,c=eo.a.CreateTorus("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},a);c.isVisible=!1,c.isPickable=!1,c.parent=r.selectionMesh;var v=0,b=!1,C={pointerId:r.id,pointerType:"xr"};r.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){if(!!r.pick){if(r.laserPointer.material.alpha=0,c.isVisible=!1,r.pick.hit)if(i._pickingMoved(s,r.pick))b&&(i._options.disablePointerUpOnTouchOut||i._scene.simulatePointerUp(r.pick,C)),b=!1,v=0;else if(v>o/10&&(c.isVisible=!0),v+=i._scene.getEngine().getDeltaTime(),v>=o)i._scene.simulatePointerDown(r.pick,C),b=!0,i._options.disablePointerUpOnTouchOut&&i._scene.simulatePointerUp(r.pick,C),c.isVisible=!1;else{var M=1-v/o;c.scaling.set(M,M,M)}else b=!1,v=0;i._scene.simulatePointerMove(r.pick,C),s=r.pick}}),this._options.renderingGroupId!==void 0&&(c.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(function(){r.pick&&!i._options.disablePointerUpOnTouchOut&&b&&i._scene.simulatePointerUp(r.pick,C),c.dispose()})},t.prototype._attachScreenRayMode=function(e){var i=this,r=this._controllers[e.uniqueId],o=!1,a={pointerId:r.id,pointerType:"xr"};r.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){!r.pick||i._options.disablePointerUpOnTouchOut&&o||(o?i._scene.simulatePointerMove(r.pick,a):(i._scene.simulatePointerDown(r.pick,a),o=!0,i._options.disablePointerUpOnTouchOut&&i._scene.simulatePointerUp(r.pick,a)))}),e.onDisposeObservable.addOnce(function(){r.pick&&o&&!i._options.disablePointerUpOnTouchOut&&i._scene.simulatePointerUp(r.pick,a)})},t.prototype._attachTrackedPointerRayMode=function(e){var i=this,r=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);var o={pointerId:r.id,pointerType:"xr"};if(r.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){r.laserPointer.material.disableLighting=i.disablePointerLighting,r.selectionMesh.material.disableLighting=i.disableSelectionMeshLighting,r.pick&&i._scene.simulatePointerMove(r.pick,o)}),e.inputSource.gamepad){var a=function(v){i._options.overrideButtonId&&(r.selectionComponent=v.getComponent(i._options.overrideButtonId)),r.selectionComponent||(r.selectionComponent=v.getMainComponent()),r.onButtonChangedObserver=r.selectionComponent.onButtonStateChangedObservable.add(function(b){if(b.changes.pressed){var C=b.changes.pressed.current;r.pick?(i._options.enablePointerSelectionOnAllControllers||e.uniqueId===i._attachedController)&&(C?(i._scene.simulatePointerDown(r.pick,o),r.selectionMesh.material.emissiveColor=i.selectionMeshPickedColor,r.laserPointer.material.emissiveColor=i.laserPointerPickedColor):(i._scene.simulatePointerUp(r.pick,o),r.selectionMesh.material.emissiveColor=i.selectionMeshDefaultColor,r.laserPointer.material.emissiveColor=i.laserPointerDefaultColor)):C&&!i._options.enablePointerSelectionOnAllControllers&&!i._options.disableSwitchOnClick&&(i._attachedController=e.uniqueId)}})};e.motionController?a(e.motionController):e.onMotionControllerInitObservable.add(a)}else{var s=function(v){r.xrController&&v.inputSource===r.xrController.inputSource&&r.pick&&(i._scene.simulatePointerDown(r.pick,o),r.selectionMesh.material.emissiveColor=i.selectionMeshPickedColor,r.laserPointer.material.emissiveColor=i.laserPointerPickedColor)},c=function(v){r.xrController&&v.inputSource===r.xrController.inputSource&&r.pick&&(i._scene.simulatePointerUp(r.pick,o),r.selectionMesh.material.emissiveColor=i.selectionMeshDefaultColor,r.laserPointer.material.emissiveColor=i.laserPointerDefaultColor)};r.eventListeners={selectend:c,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",c)}},t.prototype._convertNormalToDirectionOfRay=function(e,i){if(e){var r=Math.acos(l.e.Dot(e,i.direction));r<Math.PI/2&&e.scaleInPlace(-1)}return e},t.prototype._detachController=function(e){var i=this,r=this._controllers[e];if(!!r&&(r.selectionComponent&&r.onButtonChangedObserver&&r.selectionComponent.onButtonStateChangedObservable.remove(r.onButtonChangedObserver),r.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(r.onFrameObserver),r.eventListeners&&Object.keys(r.eventListeners).forEach(function(a){var s=r.eventListeners&&r.eventListeners[a];s&&i._xrSessionManager.session.removeEventListener(a,s)}),r.selectionMesh.dispose(),r.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e)){var o=Object.keys(this._controllers);o.length?this._attachedController=o[0]:this._attachedController=""}},t.prototype._generateNewMeshPair=function(e){var i=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xi.a.DefaultUtilityLayer.utilityLayerScene:this._scene,r=Tr.a.CreateCylinder("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},i);r.parent=e;var o=new Gt.a("laserPointerMat",i);o.emissiveColor=this.laserPointerDefaultColor,o.alpha=.7,r.material=o,r.rotation.x=Math.PI/2,this._updatePointerDistance(r,1),r.isPickable=!1;var a=eo.a.CreateTorus("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},i);a.bakeCurrentTransformIntoVertices(),a.isPickable=!1,a.isVisible=!1;var s=new Gt.a("targetMat",i);return s.specularColor=m.a.Black(),s.emissiveColor=this.selectionMeshDefaultColor,s.backFaceCulling=!1,a.material=s,this._options.renderingGroupId!==void 0&&(r.renderingGroupId=this._options.renderingGroupId,a.renderingGroupId=this._options.renderingGroupId),{laserPointer:r,selectionMesh:a}},t.prototype._pickingMoved=function(e,i){var r;if(!e.hit||!i.hit||!e.pickedMesh||!e.pickedPoint||!i.pickedMesh||!i.pickedPoint||e.pickedMesh!==i.pickedMesh)return!0;(r=e.pickedPoint)===null||r===void 0||r.subtractToRef(i.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));var o=(this._options.gazeModePointerMovedFactor||1)*.01*i.distance,a=this._tmpVectorForPickCompare.length();return a>o},t.prototype._updatePointerDistance=function(e,i){i===void 0&&(i=100),e.scaling.y=i,this._scene.useRightHandedSystem&&(i*=-1),e.position.z=i/2+.05},Object.defineProperty(t.prototype,"lasterPointerDefaultColor",{get:function(){return this.laserPointerDefaultColor},enumerable:!1,configurable:!0}),t._idCounter=200,t.Name=ur.POINTER_SELECTION,t.Version=1,t}(cr);or.AddWebXRFeature(vo.Name,function(n,t){return function(){return new vo(n,t)}},vo.Version,!0);var Qu=function(){function n(t,e,i){this.element=t,this.sessionMode=e,this.referenceSpaceType=i}return n.prototype.update=function(t){},n}(),Sg=function(){function n(){}return n}(),Zu=function(){function n(t,e){var i=this;if(this.scene=t,this.options=e,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new _.c,this._onSessionGranted=function(C){i._helper&&i._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;",e.ignoreSessionGrantedEvent||navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window!="undefined"&&window.location&&window.location.protocol==="http:"){J.b.Warn("WebXR can only be served over HTTPS");return}if(e.customButtons)this._buttons=e.customButtons;else{var r=e.sessionMode||"immersive-vr",o=e.referenceSpaceType||"local-floor",a=typeof SVGSVGElement=="undefined"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A",s=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+a+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';var c=document.createElement("style");c.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(c);var v=document.createElement("button");v.className="babylonVRicon",v.title=r+" - "+o,this._buttons.push(new Qu(v,r,o)),this._buttons[this._buttons.length-1].update=function(C){this.element.style.display=C===null||C===this?"":"none",v.className="babylonVRicon"+(C===this?" vrdisplaypresenting":"")},this._updateButtons(null)}var b=t.getEngine().getInputElement();b&&b.parentNode&&(b.parentNode.appendChild(this.overlay),t.onDisposeObservable.addOnce(function(){i.dispose()}))}return n.prototype.setHelperAsync=function(t,e){return Object(h.b)(this,void 0,void 0,function(){var i,r,o=this;return Object(h.e)(this,function(a){switch(a.label){case 0:return this._helper=t,this._renderTarget=e,i=this._buttons.map(function(s){return t.sessionManager.isSessionSupportedAsync(s.sessionMode)}),t.onStateChangedObservable.add(function(s){s==pi.NOT_IN_XR&&o._updateButtons(null)}),[4,Promise.all(i)];case 1:return r=a.sent(),r.forEach(function(s,c){s?(o.overlay.appendChild(o._buttons[c].element),o._buttons[c].element.onclick=o._enterXRWithButtonIndex.bind(o,c)):J.b.Warn('Session mode "'+o._buttons[c].sessionMode+'" not supported in browser')}),[2]}})})},n.CreateAsync=function(t,e,i){return Object(h.b)(this,void 0,void 0,function(){var r;return Object(h.e)(this,function(o){switch(o.label){case 0:return r=new n(t,i),[4,r.setHelperAsync(e,i.renderTarget||void 0)];case 1:return o.sent(),[2,r]}})})},n.prototype._enterXRWithButtonIndex=function(t){return t===void 0&&(t=0),Object(h.b)(this,void 0,void 0,function(){var e,i,r;return Object(h.e)(this,function(o){switch(o.label){case 0:return this._helper.state!=pi.IN_XR?[3,2]:[4,this._helper.exitXRAsync()];case 1:return o.sent(),this._updateButtons(null),[3,6];case 2:if(this._helper.state!=pi.NOT_IN_XR)return[3,6];o.label=3;case 3:return o.trys.push([3,5,,6]),[4,this._helper.enterXRAsync(this._buttons[t].sessionMode,this._buttons[t].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures})];case 4:return o.sent(),this._updateButtons(this._buttons[t]),[3,6];case 5:return e=o.sent(),this._updateButtons(null),i=this._buttons[t].element,r=i.title,i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(e),[3,6];case 6:return[2]}})})},n.prototype.dispose=function(){var t=this.scene.getEngine().getInputElement();t&&t.parentNode&&t.parentNode.contains(this.overlay)&&t.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)},n.prototype._updateButtons=function(t){var e=this;this._activeButton=t,this._buttons.forEach(function(i){i.update(e._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)},n}(),Tg=u(756),nn;(function(n){n[n.INIT=0]="INIT",n[n.STARTED=1]="STARTED",n[n.ENDED=2]="ENDED"})(nn||(nn={}));function Ss(n){var t,e=0,i=Date.now();n.observableParameters=(t=n.observableParameters)!==null&&t!==void 0?t:{};var r=n.contextObservable.add(function(o){var a=Date.now();e=a-i;var s={startTime:i,currentTime:a,deltaTime:e,completeRate:e/n.timeout,payload:o};n.onTick&&n.onTick(s),n.breakCondition&&n.breakCondition()&&(n.contextObservable.remove(r),n.onAborted&&n.onAborted(s)),e>=n.timeout&&(n.contextObservable.remove(r),n.onEnded&&n.onEnded(s))},n.observableParameters.mask,n.observableParameters.insertFirst,n.observableParameters.scope);return r}var Rg=function(){function n(t){var e=this,i,r;this.onEachCountObservable=new _.c,this.onTimerAbortedObservable=new _.c,this.onTimerEndedObservable=new _.c,this.onStateChangedObservable=new _.c,this._observer=null,this._breakOnNextTick=!1,this._tick=function(o){var a=Date.now();e._timer=a-e._startTime;var s={startTime:e._startTime,currentTime:a,deltaTime:e._timer,completeRate:e._timer/e._timeToEnd,payload:o},c=e._breakOnNextTick||e._breakCondition(s);c||e._timer>=e._timeToEnd?e._stop(s,c):e.onEachCountObservable.notifyObservers(s)},this._setState(nn.INIT),this._contextObservable=t.contextObservable,this._observableParameters=(i=t.observableParameters)!==null&&i!==void 0?i:{},this._breakCondition=(r=t.breakCondition)!==null&&r!==void 0?r:function(){return!1},t.onEnded&&this.onTimerEndedObservable.add(t.onEnded),t.onTick&&this.onEachCountObservable.add(t.onTick),t.onAborted&&this.onTimerAbortedObservable.add(t.onAborted)}return Object.defineProperty(n.prototype,"breakCondition",{set:function(t){this._breakCondition=t},enumerable:!1,configurable:!0}),n.prototype.clearObservables=function(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()},n.prototype.start=function(t){if(t===void 0&&(t=this._timeToEnd),this._state===nn.STARTED)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=t,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(nn.STARTED)},n.prototype.stop=function(){this._state===nn.STARTED&&(this._breakOnNextTick=!0)},n.prototype.dispose=function(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()},n.prototype._setState=function(t){this._state=t,this.onStateChangedObservable.notifyObservers(this._state)},n.prototype._stop=function(t,e){e===void 0&&(e=!1),this._contextObservable.remove(this._observer),this._setState(nn.ENDED),e?this.onTimerAbortedObservable.notifyObservers(t):this.onTimerEndedObservable.notifyObservers(t)},n}(),_o=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r._options=i,r._controllers={},r._snappedToPoint=!1,r._tmpRay=new Zt.a(new l.e,new l.e),r._tmpVector=new l.e,r._tmpQuaternion=new l.b,r.backwardsMovementEnabled=!0,r.backwardsTeleportationDistance=.7,r.parabolicCheckRadius=5,r.parabolicRayEnabled=!0,r.straightRayEnabled=!0,r.rotationAngle=Math.PI/8,r._rotationEnabled=!0,r._attachController=function(o){if(!(r._controllers[o.uniqueId]||r._options.forceHandedness&&o.inputSource.handedness!==r._options.forceHandedness)){r._controllers[o.uniqueId]={xrController:o,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0}};var a=r._controllers[o.uniqueId];if(a.xrController.inputSource.targetRayMode==="tracked-pointer"&&a.xrController.inputSource.gamepad){var s=function(){if(o.motionController){var c=o.motionController.getComponentOfType(Rn.THUMBSTICK_TYPE)||o.motionController.getComponentOfType(Rn.TOUCHPAD_TYPE);if(!c||r._options.useMainComponentOnly){var v=o.motionController.getMainComponent();if(!v)return;a.teleportationComponent=v,a.onButtonChangedObserver=v.onButtonStateChangedObservable.add(function(){if(v.changes.pressed)if(v.changes.pressed.current){a.teleportationState.forward=!0,r._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=r._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,a.teleportationState.currentRotation=0;var b=r._options.timeToTeleport||3e3;Ss({timeout:b,contextObservable:r._xrSessionManager.onXRFrameObservable,breakCondition:function(){return!v.pressed},onEnded:function(){r._currentTeleportationControllerId===a.xrController.uniqueId&&a.teleportationState.forward&&r._teleportForward(o.uniqueId)}})}else a.teleportationState.forward=!1,r._currentTeleportationControllerId=""})}else a.teleportationComponent=c,a.onAxisChangedObserver=c.onAxisValueChangedObservable.add(function(b){if(b.y<=.7&&a.teleportationState.backwards&&(a.teleportationState.backwards=!1),b.y>.7&&!a.teleportationState.forward&&r.backwardsMovementEnabled&&!r.snapPointsOnly&&!a.teleportationState.backwards){a.teleportationState.backwards=!0,r._tmpQuaternion.copyFrom(r._options.xrInput.xrCamera.rotationQuaternion),r._tmpQuaternion.toEulerAnglesToRef(r._tmpVector),r._tmpVector.x=0,r._tmpVector.z=0,l.b.FromEulerVectorToRef(r._tmpVector,r._tmpQuaternion),r._tmpVector.set(0,0,r.backwardsTeleportationDistance*(r._xrSessionManager.scene.useRightHandedSystem?1:-1)),r._tmpVector.rotateByQuaternionToRef(r._tmpQuaternion,r._tmpVector),r._tmpVector.addInPlace(r._options.xrInput.xrCamera.position),r._tmpRay.origin.copyFrom(r._tmpVector),r._tmpRay.length=r._options.xrInput.xrCamera.realWorldHeight+.1,r._tmpRay.direction.set(0,-1,0);var C=r._xrSessionManager.scene.pickWithRay(r._tmpRay,function(N){return r._floorMeshes.indexOf(N)!==-1});C&&C.pickedPoint&&(r._options.xrInput.xrCamera.position.x=C.pickedPoint.x,r._options.xrInput.xrCamera.position.z=C.pickedPoint.z)}if(b.y<-.7&&!r._currentTeleportationControllerId&&!a.teleportationState.rotating&&(a.teleportationState.forward=!0,r._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=r._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),b.x){if(a.teleportationState.forward)r._currentTeleportationControllerId===a.xrController.uniqueId&&(r.rotationEnabled?setTimeout(function(){a.teleportationState.currentRotation=Math.atan2(b.x,b.y*(r._xrSessionManager.scene.useRightHandedSystem?1:-1))}):a.teleportationState.currentRotation=0);else if(!a.teleportationState.rotating&&Math.abs(b.x)>.7){a.teleportationState.rotating=!0;var M=r.rotationAngle*(b.x>0?1:-1)*(r._xrSessionManager.scene.useRightHandedSystem?-1:1);r._options.xrInput.xrCamera.rotationQuaternion.multiplyInPlace(l.b.FromEulerAngles(0,M,0))}}else a.teleportationState.rotating=!1;b.x===0&&b.y===0&&a.teleportationState.forward&&r._teleportForward(o.uniqueId)})}};o.motionController?s():o.onMotionControllerInitObservable.addOnce(function(){s()})}else r._xrSessionManager.scene.onPointerObservable.add(function(c){if(c.type===re.a.POINTERDOWN){a.teleportationState.forward=!0,r._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=r._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,a.teleportationState.currentRotation=0;var v=r._options.timeToTeleport||3e3;Ss({timeout:v,contextObservable:r._xrSessionManager.onXRFrameObservable,onEnded:function(){r._currentTeleportationControllerId===a.xrController.uniqueId&&a.teleportationState.forward&&r._teleportForward(o.uniqueId)}})}else c.type===re.a.POINTERUP&&(a.teleportationState.forward=!1,r._currentTeleportationControllerId="")})}},r._options.teleportationTargetMesh||r._createDefaultTargetMesh(),r._floorMeshes=r._options.floorMeshes||[],r._snapToPositions=r._options.snapPositions||[],r._setTargetMeshVisibility(!1),r}return Object.defineProperty(t.prototype,"rotationEnabled",{get:function(){return this._rotationEnabled},set:function(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){var i=this._options.teleportationTargetMesh.getChildMeshes(!1,function(r){return r.name==="rotationCone"});i[0]&&i[0].setEnabled(e)}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"teleportationTargetMesh",{get:function(){return this._options.teleportationTargetMesh||null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"snapPointsOnly",{get:function(){return!!this._options.snapPointsOnly},set:function(e){this._options.snapPointsOnly=e},enumerable:!1,configurable:!0}),t.prototype.addFloorMesh=function(e){this._floorMeshes.push(e)},t.prototype.addSnapPoint=function(e){this._snapToPositions.push(e)},t.prototype.attach=function(){var e=this;return n.prototype.attach.call(this)?(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(i){e._detachController(i.uniqueId)}),!0):!1},t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(i){e._detachController(i)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)},t.prototype.removeFloorMesh=function(e){var i=this._floorMeshes.indexOf(e);i!==-1&&this._floorMeshes.splice(i,1)},t.prototype.removeFloorMeshByName=function(e){var i=this._xrSessionManager.scene.getMeshByName(e);i&&this.removeFloorMesh(i)},t.prototype.removeSnapPoint=function(e){var i=this._snapToPositions.indexOf(e);if(i===-1){for(var r=0;r<this._snapToPositions.length;++r)if(this._snapToPositions[r].equals(e)){i=r;break}}return i!==-1?(this._snapToPositions.splice(i,1),!0):!1},t.prototype.setSelectionFeature=function(e){this._selectionFeature=e},t.prototype._onXRFrame=function(e){var i=this,r=this._xrSessionManager.currentFrame,o=this._xrSessionManager.scene;if(!(!this.attach||!r)){var a=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!a)return;a.rotationQuaternion=a.rotationQuaternion||new l.b;var s=this._controllers[this._currentTeleportationControllerId];if(s&&s.teleportationState.forward){l.b.RotationYawPitchRollToRef(s.teleportationState.currentRotation+s.teleportationState.baseRotation,0,0,a.rotationQuaternion);var c=!1;if(s.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){var v=o.pickWithRay(this._tmpRay,function(N){if(i._options.pickBlockerMeshes&&i._options.pickBlockerMeshes.indexOf(N)!==-1)return!0;var D=i._floorMeshes.indexOf(N);return D===-1?!1:i._floorMeshes[D].absolutePosition.y<i._options.xrInput.xrCamera.position.y});if(v&&v.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(v.pickedMesh)!==-1)return;v&&v.pickedPoint&&(c=!0,this._setTargetMeshPosition(v.pickedPoint),this._setTargetMeshVisibility(!0),this._showParabolicPath(v))}if(this.parabolicRayEnabled&&!c){var b=s.xrController.pointer.rotationQuaternion.toEulerAngles().x,C=1+(Math.PI/2-Math.abs(b)),M=this.parabolicCheckRadius*C;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(M*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(M)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();var v=o.pickWithRay(this._tmpRay,function(D){return i._options.pickBlockerMeshes&&i._options.pickBlockerMeshes.indexOf(D)!==-1?!0:i._floorMeshes.indexOf(D)!==-1});if(v&&v.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(v.pickedMesh)!==-1)return;v&&v.pickedPoint&&(c=!0,this._setTargetMeshPosition(v.pickedPoint),this._setTargetMeshVisibility(!0),this._showParabolicPath(v))}this._setTargetMeshVisibility(c)}else this._setTargetMeshVisibility(!1)}else this._setTargetMeshVisibility(!1)}},t.prototype._createDefaultTargetMesh=function(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};var e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xi.a.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=Ya.a.CreateGround("teleportationTarget",{width:2,height:2,subdivisions:2},e);i.isPickable=!1;var r=512,o=new un.a("teleportationPlaneDynamicTexture",r,e,!0);o.hasAlpha=!0;var a=o.getContext(),s=r/2,c=r/2,v=200;a.beginPath(),a.arc(s,c,v,0,2*Math.PI,!1),a.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",a.fill(),a.lineWidth=10,a.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",a.stroke(),a.closePath(),o.update();var b=new Gt.a("teleportationPlaneMaterial",e);b.diffuseTexture=o,i.material=b;var C=eo.a.CreateTorus("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(C.isPickable=!1,C.parent=i,!this._options.defaultTargetMeshOptions.disableAnimation){var M=new y.a("animationInnerCircle","position.y",30,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CYCLE),N=[];N.push({frame:0,value:0}),N.push({frame:30,value:.4}),N.push({frame:60,value:0}),M.setKeys(N);var D=new L.m;D.setEasingMode(L.f.EASINGMODE_EASEINOUT),M.setEasingFunction(D),C.animations=[],C.animations.push(M),e.beginAnimation(C,0,60,!0)}var V=Tr.a.CreateCylinder("rotationCone",{diameterTop:0,tessellation:4},e);if(V.isPickable=!1,V.scaling.set(.5,.12,.2),V.rotate(xe.a.X,Math.PI/2),V.position.z=.6,V.parent=C,this._options.defaultTargetMeshOptions.torusArrowMaterial)C.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,V.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{var X=new Gt.a("torusConsMat",e);X.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,X.disableLighting?X.emissiveColor=new m.a(.3,.3,1):X.diffuseColor=new m.a(.3,.3,1),X.alpha=.9,C.material=X,V.material=X,this._teleportationRingMaterial=X}this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,C.renderingGroupId=this._options.renderingGroupId,V.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=i},t.prototype._detachController=function(e){var i=this._controllers[e];!i||(i.teleportationComponent&&(i.onAxisChangedObserver&&i.teleportationComponent.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.teleportationComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver)),delete this._controllers[e])},t.prototype._findClosestSnapPointWithRadius=function(e,i){i===void 0&&(i=this._options.snapToPositionRadius||.8);var r=null,o=Number.MAX_VALUE;if(this._snapToPositions.length){var a=i*i;this._snapToPositions.forEach(function(s){var c=l.e.DistanceSquared(s,e);c<=a&&c<o&&(o=c,r=s)})}return r},t.prototype._setTargetMeshPosition=function(e){if(!!this._options.teleportationTargetMesh){var i=this._findClosestSnapPointWithRadius(e);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||e),this._options.teleportationTargetMesh.position.y+=.01}},t.prototype._setTargetMeshVisibility=function(e){!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible!==e&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(function(i){i.isVisible=e}),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))},t.prototype._showParabolicPath=function(e){if(!!e.pickedPoint){var i=this._controllers[this._currentTeleportationControllerId],r=Tg.d.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25);this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints()):this._quadraticBezierCurve=Bi.a.CreateLines("teleportation path line",{points:r.getPoints(),instance:this._quadraticBezierCurve,updatable:!0}),this._quadraticBezierCurve.isPickable=!1}},t.prototype._teleportForward=function(e){var i=this._controllers[e];if(!(!i||!i.teleportationState.forward)&&(i.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint)&&this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible)){var r=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=r,this._options.xrInput.xrCamera.rotationQuaternion.multiplyInPlace(l.b.FromEulerAngles(0,i.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0)),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}},t.Name=ur.TELEPORTATION,t.Version=1,t}(cr);or.AddWebXRFeature(_o.Name,function(n,t){return function(){return new _o(n,t)}},_o.Version,!0);var Ag=function(){function n(){}return n}(),Ju=function(){function n(){}return n.CreateAsync=function(t,e){e===void 0&&(e={});var i=new n;if(!e.disableDefaultUI){var r=Object(h.a)({renderTarget:i.renderTarget},e.uiOptions||{});e.optionalFeatures&&(typeof e.optionalFeatures=="boolean"?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=e.optionalFeatures),i.enterExitUI=new Zu(t,r)}return ku.CreateAsync(t).then(function(o){if(i.baseExperience=o,e.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new Ku(o.sessionManager,o.camera,Object(h.a)({controllerOptions:{renderingGroupId:e.renderingGroupId}},e.inputOptions||{})),e.disablePointerSelection||(i.pointerSelection=i.baseExperience.featuresManager.enableFeature(vo.Name,e.useStablePlugins?"stable":"latest",{xrInput:i.input,renderingGroupId:e.renderingGroupId}),e.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(_o.Name,e.useStablePlugins?"stable":"latest",{floorMeshes:e.floorMeshes,xrInput:i.input,renderingGroupId:e.renderingGroupId}),i.teleportation.setSelectionFeature(i.pointerSelection))),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(e.outputCanvasOptions),!e.disableDefaultUI)return i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)}).then(function(){return i}).catch(function(o){return p.a.Error("Error initializing XR"),p.a.Error(o),i})},n.prototype.dispose=function(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()},n}(),Og=!0;q.a.prototype.createDefaultLight=function(n){if(n===void 0&&(n=!1),n&&this.lights)for(var t=0;t<this.lights.length;t++)this.lights[t].dispose();this.lights.length===0&&new $n.a("default light",l.e.Up(),this)},q.a.prototype.createDefaultCamera=function(n,t,e){if(n===void 0&&(n=!1),t===void 0&&(t=!1),e===void 0&&(e=!1),t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){var i=this.getWorldExtends(function(C){return C.isVisible&&C.isEnabled()}),r=i.max.subtract(i.min),o=i.min.add(r.scale(.5)),a,s=r.length()*1.5;if(isFinite(s)||(s=1,o.copyFromFloats(0,0,0)),n){var c=new Ri.a("default camera",-(Math.PI/2),Math.PI/2,s,o,this);c.lowerRadiusLimit=s*.01,c.wheelPrecision=100/s,a=c}else{var v=new Wt.a("default camera",new l.e(o.x,o.y,-s),this);v.setTarget(o),a=v}a.minZ=s*.01,a.maxZ=s*1e3,a.speed=s*.2,this.activeCamera=a;var b=this.getEngine().getInputElement();e&&b&&a.attachControl()}},q.a.prototype.createDefaultCameraOrLight=function(n,t,e){n===void 0&&(n=!1),t===void 0&&(t=!1),e===void 0&&(e=!1),this.createDefaultLight(t),this.createDefaultCamera(n,t,e)},q.a.prototype.createDefaultSkybox=function(n,t,e,i,r){if(t===void 0&&(t=!1),e===void 0&&(e=1e3),i===void 0&&(i=0),r===void 0&&(r=!0),!n)return p.a.Warn("Can not create default skybox without environment texture."),null;r&&n&&(this.environmentTexture=n);var o=ot.a.CreateBox("hdrSkyBox",e,this);if(t){var a=new Pu.a("skyBox",this);a.backFaceCulling=!1,a.reflectionTexture=n.clone(),a.reflectionTexture&&(a.reflectionTexture.coordinatesMode=Ze.a.SKYBOX_MODE),a.microSurface=1-i,a.disableLighting=!0,a.twoSidedLighting=!0,o.material=a}else{var s=new Gt.a("skyBox",this);s.backFaceCulling=!1,s.reflectionTexture=n.clone(),s.reflectionTexture&&(s.reflectionTexture.coordinatesMode=Ze.a.SKYBOX_MODE),s.disableLighting=!0,o.material=s}return o.isPickable=!1,o.infiniteDistance=!0,o.ignoreCameraMaxZ=!0,o},q.a.prototype.createDefaultEnvironment=function(n){return vs?new vs(n,this):null},q.a.prototype.createDefaultVRExperience=function(n){return n===void 0&&(n={}),new Ve(this,n)},q.a.prototype.createDefaultXRExperienceAsync=function(n){return n===void 0&&(n={}),Ju.CreateAsync(this,n).then(function(t){return t})};var $u=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){o===void 0&&(o=!1),a===void 0&&(a=!1),s===void 0&&(s=Ze.a.TRILINEAR_SAMPLINGMODE),c===void 0&&(c={autoPlay:!0,loop:!0,autoUpdateTexture:!0});var v=n.call(this,null,r,!o,a)||this;v._onUserActionRequestedObservable=null,v._stillImageCaptured=!1,v._displayingPosterTexture=!1,v._frameId=-1,v._currentSrc=null,v._createInternalTexture=function(){if(v._texture!=null)if(v._displayingPosterTexture)v._texture.dispose(),v._displayingPosterTexture=!1;else return;if(!v._getEngine().needPOTTextures||J.b.IsExponentOfTwo(v.video.videoWidth)&&J.b.IsExponentOfTwo(v.video.videoHeight)?(v.wrapU=Ze.a.WRAP_ADDRESSMODE,v.wrapV=Ze.a.WRAP_ADDRESSMODE):(v.wrapU=Ze.a.CLAMP_ADDRESSMODE,v.wrapV=Ze.a.CLAMP_ADDRESSMODE,v._generateMipMaps=!1),v._texture=v._getEngine().createDynamicTexture(v.video.videoWidth,v.video.videoHeight,v._generateMipMaps,v.samplingMode),!v.video.autoplay&&!v._settings.poster){var C=v.video.onplaying,M=!1,N=v.video.muted;v.video.muted=!0,v.video.onplaying=function(){v.video.muted=N,v.video.onplaying=C,v._updateInternalTexture(),M||v.video.pause(),v.onLoadObservable.hasObservers()&&v.onLoadObservable.notifyObservers(v)};var D=v.video.play();D?D.then(function(){}).catch(function(){M=!0,v._onUserActionRequestedObservable&&v._onUserActionRequestedObservable.hasObservers()&&v._onUserActionRequestedObservable.notifyObservers(v)}):(v.video.onplaying=C,v._updateInternalTexture(),v.onLoadObservable.hasObservers()&&v.onLoadObservable.notifyObservers(v))}else v._updateInternalTexture(),v.onLoadObservable.hasObservers()&&v.onLoadObservable.notifyObservers(v)},v.reset=function(){v._texture!=null&&(v._displayingPosterTexture||(v._texture.dispose(),v._texture=null))},v._updateInternalTexture=function(){if(v._texture!=null&&!(v.video.readyState<v.video.HAVE_CURRENT_DATA)&&!v._displayingPosterTexture){var C=v.getScene().getFrameId();v._frameId!==C&&(v._frameId=C,v._getEngine().updateVideoTexture(v._texture,v.video,v._invertY))}},v._generateMipMaps=o,v._initialSamplingMode=s,v.autoUpdateTexture=c.autoUpdateTexture,v._currentSrc=i,v.name=e||v._getName(i),v.video=v._getVideo(i),v._settings=c,c.poster&&(v.video.poster=c.poster),c.autoPlay!==void 0&&(v.video.autoplay=c.autoPlay),c.loop!==void 0&&(v.video.loop=c.loop),c.muted!==void 0&&(v.video.muted=c.muted),v.video.setAttribute("playsinline",""),v.video.addEventListener("paused",v._updateInternalTexture),v.video.addEventListener("seeked",v._updateInternalTexture),v.video.addEventListener("emptied",v.reset),v._createInternalTextureOnEvent=c.poster&&!c.autoPlay?"play":"canplay",v.video.addEventListener(v._createInternalTextureOnEvent,v._createInternalTexture),c.autoPlay&&v.video.play();var b=v.video.readyState>=v.video.HAVE_CURRENT_DATA;return c.poster&&(!c.autoPlay||!b)?(v._texture=v._getEngine().createTexture(c.poster,!1,!v.invertY,r),v._displayingPosterTexture=!0):b&&v._createInternalTexture(),v}return Object.defineProperty(t.prototype,"onUserActionRequestedObservable",{get:function(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new _.c),this._onUserActionRequestedObservable},enumerable:!1,configurable:!0}),t.prototype._getName=function(e){return e instanceof HTMLVideoElement?e.currentSrc:typeof e=="object"?e.toString():e},t.prototype._getVideo=function(e){if(e instanceof HTMLVideoElement)return J.b.SetCorsBehavior(e.currentSrc,e),e;var i=document.createElement("video");return typeof e=="string"?(J.b.SetCorsBehavior(e,i),i.src=e):(J.b.SetCorsBehavior(e[0],i),e.forEach(function(r){var o=document.createElement("source");o.src=r,i.appendChild(o)})),i},t.prototype._rebuild=function(){this.update()},t.prototype.update=function(){!this.autoUpdateTexture||this.updateTexture(!0)},t.prototype.updateTexture=function(e){!e||this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture())},t.prototype.updateURL=function(e){this.video.src=e,this._currentSrc=e},t.prototype.clone=function(){return new t(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this.reset),this.video.pause()},t.CreateFromStreamAsync=function(e,i){var r=document.createElement("video");return e.getEngine()._badOS&&(document.body.appendChild(r),r.style.transform="scale(0.0001, 0.0001)",r.style.opacity="0",r.style.position="fixed",r.style.bottom="0px",r.style.right="0px"),r.setAttribute("autoplay",""),r.setAttribute("muted","true"),r.setAttribute("playsinline",""),r.muted=!0,r.mozSrcObject!==void 0?r.mozSrcObject=i:typeof r.srcObject=="object"?r.srcObject=i:(window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,r.src=window.URL&&window.URL.createObjectURL(i)),new Promise(function(o){var a=function(){o(new t("video",r,e,!0,!0)),r.removeEventListener("playing",a)};r.addEventListener("playing",a),r.play()})},t.CreateFromWebCamAsync=function(e,i,r){var o=this;r===void 0&&(r=!1);var a;return i&&i.deviceId&&(a={exact:i.deviceId}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia({video:i,audio:r}).then(function(s){return o.CreateFromStreamAsync(e,s)}):(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia&&navigator.getUserMedia({video:{deviceId:a,width:{min:i&&i.minWidth||256,max:i&&i.maxWidth||640},height:{min:i&&i.minHeight||256,max:i&&i.maxHeight||480}},audio:r},function(s){return o.CreateFromStreamAsync(e,s)},function(s){p.a.Error(s.name)}),Promise.reject("No support for userMedia on this device"))},t.CreateFromWebCam=function(e,i,r,o){o===void 0&&(o=!1),this.CreateFromWebCamAsync(e,r,o).then(function(a){i&&i(a)}).catch(function(a){p.a.Error(a.name)})},t}(Ze.a),Mg=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return Object.defineProperty(t.prototype,"videoTexture",{get:function(){return this._texture},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"videoMode",{get:function(){return this.textureMode},set:function(e){this.textureMode=e},enumerable:!1,configurable:!0}),t.prototype._initTexture=function(e,i,r){var o=this,a={loop:r.loop,autoPlay:r.autoPlay,autoUpdateTexture:!0,poster:r.poster},s=new $u((this.name||"videoDome")+"_texture",e,i,r.generateMipMaps,this._useDirectMapping,Ze.a.TRILINEAR_SAMPLINGMODE,a);return r.clickToPlay&&(i.onPointerUp=function(){o._texture.video.play()}),s.onLoadObservable.add(function(){o.onLoadObservable.notifyObservers()}),s},t.MODE_MONOSCOPIC=tn.MODE_MONOSCOPIC,t.MODE_TOPBOTTOM=tn.MODE_TOPBOTTOM,t.MODE_SIDEBYSIDE=tn.MODE_SIDEBYSIDE,t}(tn),fr=u(612),xg=function(){function n(t){this.engine=t,this._captureGPUFrameTime=!1,this._gpuFrameTime=new fr.a,this._captureShaderCompilationTime=!1,this._shaderCompilationTime=new fr.a,this._onBeginFrameObserver=null,this._onEndFrameObserver=null,this._onBeforeShaderCompilationObserver=null,this._onAfterShaderCompilationObserver=null}return Object.defineProperty(n.prototype,"gpuFrameTimeCounter",{get:function(){return this._gpuFrameTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureGPUFrameTime",{get:function(){return this._captureGPUFrameTime},set:function(t){var e=this;t!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=t,t?(this._onBeginFrameObserver=this.engine.onBeginFrameObservable.add(function(){e._gpuFrameTimeToken||(e._gpuFrameTimeToken=e.engine.startTimeQuery())}),this._onEndFrameObserver=this.engine.onEndFrameObservable.add(function(){if(!!e._gpuFrameTimeToken){var i=e.engine.endTimeQuery(e._gpuFrameTimeToken);i>-1&&(e._gpuFrameTimeToken=null,e._gpuFrameTime.fetchNewFrame(),e._gpuFrameTime.addCount(i,!0))}})):(this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shaderCompilationTimeCounter",{get:function(){return this._shaderCompilationTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureShaderCompilationTime",{get:function(){return this._captureShaderCompilationTime},set:function(t){var e=this;t!==this._captureShaderCompilationTime&&(this._captureShaderCompilationTime=t,t?(this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add(function(){e._shaderCompilationTime.fetchNewFrame(),e._shaderCompilationTime.beginMonitoring()}),this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add(function(){e._shaderCompilationTime.endMonitoring()})):(this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null))},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null,this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null,this.engine=null},n}(),Dg=function(){function n(t){var e=this;this.scene=t,this._captureActiveMeshesEvaluationTime=!1,this._activeMeshesEvaluationTime=new fr.a,this._captureRenderTargetsRenderTime=!1,this._renderTargetsRenderTime=new fr.a,this._captureFrameTime=!1,this._frameTime=new fr.a,this._captureRenderTime=!1,this._renderTime=new fr.a,this._captureInterFrameTime=!1,this._interFrameTime=new fr.a,this._captureParticlesRenderTime=!1,this._particlesRenderTime=new fr.a,this._captureSpritesRenderTime=!1,this._spritesRenderTime=new fr.a,this._capturePhysicsTime=!1,this._physicsTime=new fr.a,this._captureAnimationsTime=!1,this._animationsTime=new fr.a,this._captureCameraRenderTime=!1,this._cameraRenderTime=new fr.a,this._onBeforeActiveMeshesEvaluationObserver=null,this._onAfterActiveMeshesEvaluationObserver=null,this._onBeforeRenderTargetsRenderObserver=null,this._onAfterRenderTargetsRenderObserver=null,this._onAfterRenderObserver=null,this._onBeforeDrawPhaseObserver=null,this._onAfterDrawPhaseObserver=null,this._onBeforeAnimationsObserver=null,this._onBeforeParticlesRenderingObserver=null,this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver=null,this._onAfterSpritesRenderingObserver=null,this._onBeforePhysicsObserver=null,this._onAfterPhysicsObserver=null,this._onAfterAnimationsObserver=null,this._onBeforeCameraRenderObserver=null,this._onAfterCameraRenderObserver=null,this._onBeforeAnimationsObserver=t.onBeforeAnimationsObservable.add(function(){e._captureActiveMeshesEvaluationTime&&e._activeMeshesEvaluationTime.fetchNewFrame(),e._captureRenderTargetsRenderTime&&e._renderTargetsRenderTime.fetchNewFrame(),e._captureFrameTime&&(J.b.StartPerformanceCounter("Scene rendering"),e._frameTime.beginMonitoring()),e._captureInterFrameTime&&e._interFrameTime.endMonitoring(),e._captureParticlesRenderTime&&e._particlesRenderTime.fetchNewFrame(),e._captureSpritesRenderTime&&e._spritesRenderTime.fetchNewFrame(),e._captureAnimationsTime&&e._animationsTime.beginMonitoring(),e.scene.getEngine()._drawCalls.fetchNewFrame()}),this._onAfterRenderObserver=t.onAfterRenderObservable.add(function(){e._captureFrameTime&&(J.b.EndPerformanceCounter("Scene rendering"),e._frameTime.endMonitoring()),e._captureRenderTime&&e._renderTime.endMonitoring(!1),e._captureInterFrameTime&&e._interFrameTime.beginMonitoring()})}return Object.defineProperty(n.prototype,"activeMeshesEvaluationTimeCounter",{get:function(){return this._activeMeshesEvaluationTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureActiveMeshesEvaluationTime",{get:function(){return this._captureActiveMeshesEvaluationTime},set:function(t){var e=this;t!==this._captureActiveMeshesEvaluationTime&&(this._captureActiveMeshesEvaluationTime=t,t?(this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add(function(){J.b.StartPerformanceCounter("Active meshes evaluation"),e._activeMeshesEvaluationTime.beginMonitoring()}),this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add(function(){J.b.EndPerformanceCounter("Active meshes evaluation"),e._activeMeshesEvaluationTime.endMonitoring()})):(this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"renderTargetsRenderTimeCounter",{get:function(){return this._renderTargetsRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureRenderTargetsRenderTime",{get:function(){return this._captureRenderTargetsRenderTime},set:function(t){var e=this;t!==this._captureRenderTargetsRenderTime&&(this._captureRenderTargetsRenderTime=t,t?(this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add(function(){J.b.StartPerformanceCounter("Render targets rendering"),e._renderTargetsRenderTime.beginMonitoring()}),this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add(function(){J.b.EndPerformanceCounter("Render targets rendering"),e._renderTargetsRenderTime.endMonitoring(!1)})):(this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"particlesRenderTimeCounter",{get:function(){return this._particlesRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureParticlesRenderTime",{get:function(){return this._captureParticlesRenderTime},set:function(t){var e=this;t!==this._captureParticlesRenderTime&&(this._captureParticlesRenderTime=t,t?(this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add(function(){J.b.StartPerformanceCounter("Particles"),e._particlesRenderTime.beginMonitoring()}),this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add(function(){J.b.EndPerformanceCounter("Particles"),e._particlesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"spritesRenderTimeCounter",{get:function(){return this._spritesRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureSpritesRenderTime",{get:function(){return this._captureSpritesRenderTime},set:function(t){var e=this;t!==this._captureSpritesRenderTime&&(this._captureSpritesRenderTime=t,!!this.scene.spriteManagers&&(t?(this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add(function(){J.b.StartPerformanceCounter("Sprites"),e._spritesRenderTime.beginMonitoring()}),this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add(function(){J.b.EndPerformanceCounter("Sprites"),e._spritesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null)))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"physicsTimeCounter",{get:function(){return this._physicsTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"capturePhysicsTime",{get:function(){return this._capturePhysicsTime},set:function(t){var e=this;t!==this._capturePhysicsTime&&(!this.scene.onBeforePhysicsObservable||(this._capturePhysicsTime=t,t?(this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add(function(){J.b.StartPerformanceCounter("Physics"),e._physicsTime.beginMonitoring()}),this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add(function(){J.b.EndPerformanceCounter("Physics"),e._physicsTime.endMonitoring()})):(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null)))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"animationsTimeCounter",{get:function(){return this._animationsTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureAnimationsTime",{get:function(){return this._captureAnimationsTime},set:function(t){var e=this;t!==this._captureAnimationsTime&&(this._captureAnimationsTime=t,t?this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add(function(){e._animationsTime.endMonitoring()}):(this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"frameTimeCounter",{get:function(){return this._frameTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureFrameTime",{get:function(){return this._captureFrameTime},set:function(t){this._captureFrameTime=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"interFrameTimeCounter",{get:function(){return this._interFrameTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureInterFrameTime",{get:function(){return this._captureInterFrameTime},set:function(t){this._captureInterFrameTime=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"renderTimeCounter",{get:function(){return this._renderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureRenderTime",{get:function(){return this._captureRenderTime},set:function(t){var e=this;t!==this._captureRenderTime&&(this._captureRenderTime=t,t?(this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add(function(){e._renderTime.beginMonitoring(),J.b.StartPerformanceCounter("Main render")}),this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add(function(){e._renderTime.endMonitoring(!1),J.b.EndPerformanceCounter("Main render")})):(this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraRenderTimeCounter",{get:function(){return this._cameraRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureCameraRenderTime",{get:function(){return this._captureCameraRenderTime},set:function(t){var e=this;t!==this._captureCameraRenderTime&&(this._captureCameraRenderTime=t,t?(this._onBeforeCameraRenderObserver=this.scene.onBeforeCameraRenderObservable.add(function(i){e._cameraRenderTime.beginMonitoring(),J.b.StartPerformanceCounter("Rendering camera "+i.name)}),this._onAfterCameraRenderObserver=this.scene.onAfterCameraRenderObservable.add(function(i){e._cameraRenderTime.endMonitoring(!1),J.b.EndPerformanceCounter("Rendering camera "+i.name)})):(this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"drawCallsCounter",{get:function(){return this.scene.getEngine()._drawCalls},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=null,this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null,this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null,this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver&&(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null),this._onAfterSpritesRenderingObserver&&(this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null),this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null,this._onBeforePhysicsObserver&&(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null),this._onAfterPhysicsObserver&&(this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null),this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null,this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null,this.scene=null},n}(),qu=u(516),Ig=u(576),Lg=u(577),Yi=u(459),j_=u(646),W_=u(647),ec="glowBlurPostProcessPixelShader",tc=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform vec2 screenSize;
uniform vec2 direction;
uniform float blurWidth;

float getLuminance(vec3 color)
{
return dot(color,vec3(0.2126,0.7152,0.0722));
}
void main(void)
{
float weights[7];
weights[0]=0.05;
weights[1]=0.1;
weights[2]=0.2;
weights[3]=0.3;
weights[4]=0.2;
weights[5]=0.1;
weights[6]=0.05;
vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);
vec2 texelStep=texelSize*direction*blurWidth;
vec2 start=vUV-3.0*texelStep;
vec4 baseColor=vec4(0.,0.,0.,0.);
vec2 texelOffset=vec2(0.,0.);
for (int i=0; i<7; i++)
{

vec4 texel=texture2D(textureSampler,start+texelOffset);
baseColor.a+=texel.a*weights[i];

float luminance=getLuminance(baseColor.rgb);
float luminanceTexel=getLuminance(texel.rgb);
float choice=step(luminanceTexel,luminance);
baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;
texelOffset+=texelStep;
}
gl_FragColor=baseColor;
}`;qe.a.ShadersStore[ec]=tc;var H_={name:ec,shader:tc};S.a.prototype.getHighlightLayerByName=function(n){for(var t=0;t<this.effectLayers.length;t++)if(this.effectLayers[t].name===n&&this.effectLayers[t].getEffectName()===Ts.EffectName)return this.effectLayers[t];return null};var ic=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v){s===void 0&&(s=Ze.a.BILINEAR_SAMPLINGMODE);var b=n.call(this,e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,o,a,s,c,v)||this;return b.direction=i,b.kernel=r,b.onApplyObservable.add(function(C){C.setFloat2("screenSize",b.width,b.height),C.setVector2("direction",b.direction),C.setFloat("blurWidth",b.kernel)}),b}return t}(ii.a),Ts=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,i)||this;return o.name=e,o.innerGlow=!0,o.outerGlow=!0,o.onBeforeBlurObservable=new _.c,o.onAfterBlurObservable=new _.c,o._instanceGlowingMeshStencilReference=t.GlowingMeshStencilReference++,o._meshes={},o._excludedMeshes={},o.neutralColor=t.NeutralColor,o._engine.isStencilEnable||p.a.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),o._options=Object(h.a)({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1},r),o._init({alphaBlendingMode:o._options.alphaBlendingMode,camera:o._options.camera,mainTextureFixedSize:o._options.mainTextureFixedSize,mainTextureRatio:o._options.mainTextureRatio,renderingGroupId:o._options.renderingGroupId}),o._shouldRender=!1,o}return Object.defineProperty(t.prototype,"blurHorizontalSize",{get:function(){return this._horizontalBlurPostprocess.kernel},set:function(e){this._horizontalBlurPostprocess.kernel=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurVerticalSize",{get:function(){return this._verticalBlurPostprocess.kernel},set:function(e){this._verticalBlurPostprocess.kernel=e},enumerable:!1,configurable:!0}),t.prototype.getEffectName=function(){return t.EffectName},t.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[Oe.b.PositionKind],["offset"],["textureSampler"],this._options.isStroke?`#define STROKE 
`:void 0)},t.prototype._createTextureAndPostProcesses=function(){var e=this,i=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,r=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;i=this._engine.needPOTTextures?W.a.GetExponentOfTwo(i,this._maxSize):i,r=this._engine.needPOTTextures?W.a.GetExponentOfTwo(r,this._maxSize):r;var o=0;this._engine.getCaps().textureHalfFloatRender?o=2:o=0,this._blurTexture=new Cr.a("HighlightLayerBlurRTT",{width:i,height:r},this._scene,!1,!0,o),this._blurTexture.wrapU=Ze.a.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(Ze.a.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._options.alphaBlendingMode===2?(this._downSamplePostprocess=new yn.b("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.onApplyObservable.add(function(a){a.setTexture("textureSampler",e._mainTexture)}),this._horizontalBlurPostprocess=new ic("HighlightLayerHBP",new l.d(1,0),this._options.blurHorizontalSize,1,null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(a){a.setFloat2("screenSize",i,r)}),this._verticalBlurPostprocess=new ic("HighlightLayerVBP",new l.d(0,1),this._options.blurVerticalSize,1,null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(a){a.setFloat2("screenSize",i,r)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new go.a("HighlightLayerHBP",new l.d(1,0),this._options.blurHorizontalSize/2,{width:i,height:r},null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,o),this._horizontalBlurPostprocess.width=i,this._horizontalBlurPostprocess.height=r,this._horizontalBlurPostprocess.onApplyObservable.add(function(a){a.setTexture("textureSampler",e._mainTexture)}),this._verticalBlurPostprocess=new go.a("HighlightLayerVBP",new l.d(0,1),this._options.blurVerticalSize/2,{width:i,height:r},null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,o),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(function(){e.onBeforeBlurObservable.notifyObservers(e);var a=e._blurTexture.getInternalTexture();a&&(e._scene.postProcessManager.directRender(e._postProcesses,a,!0),e._engine.unBindFramebuffer(a,!0)),e.onAfterBlurObservable.notifyObservers(e)}),this._postProcesses.map(function(a){a.autoClear=!1})},t.prototype.needStencil=function(){return!0},t.prototype.isReady=function(e,i){var r=e.getMaterial(),o=e.getRenderingMesh();if(!r||!o||!this._meshes)return!1;var a=null,s=this._meshes[o.uniqueId];return s&&s.glowEmissiveOnly&&r&&(a=r.emissiveTexture),n.prototype._isReady.call(this,e,i,a)},t.prototype._internalRender=function(e){e.setTexture("textureSampler",this._blurTexture);var i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(Yi.a.TriangleFillMode,0,6)),this.innerGlow&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(Yi.a.TriangleFillMode,0,6)),i.restoreStencilState()},t.prototype.shouldRender=function(){return n.prototype.shouldRender.call(this)?!!this._meshes:!1},t.prototype._shouldRenderMesh=function(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!n.prototype.hasMesh.call(this,e))},t.prototype._canRenderMesh=function(e,i){return!0},t.prototype._addCustomEffectDefines=function(e){e.push("#define HIGHLIGHT")},t.prototype._setEmissiveTextureAndColor=function(e,i,r){var o=this._meshes[e.uniqueId];o?this._emissiveTextureAndColor.color.set(o.color.r,o.color.g,o.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),o&&o.glowEmissiveOnly&&r?(this._emissiveTextureAndColor.texture=r.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null},t.prototype.addExcludedMesh=function(e){if(!!this._excludedMeshes){var i=this._excludedMeshes[e.uniqueId];i||(this._excludedMeshes[e.uniqueId]={mesh:e,beforeBind:e.onBeforeBindObservable.add(function(r){r.getEngine().setStencilBuffer(!1)}),afterRender:e.onAfterRenderObservable.add(function(r){r.getEngine().setStencilBuffer(!0)})})}},t.prototype.removeExcludedMesh=function(e){if(!!this._excludedMeshes){var i=this._excludedMeshes[e.uniqueId];i&&(i.beforeBind&&e.onBeforeBindObservable.remove(i.beforeBind),i.afterRender&&e.onAfterRenderObservable.remove(i.afterRender)),this._excludedMeshes[e.uniqueId]=null}},t.prototype.hasMesh=function(e){return!this._meshes||!n.prototype.hasMesh.call(this,e)?!1:this._meshes[e.uniqueId]!==void 0&&this._meshes[e.uniqueId]!==null},t.prototype.addMesh=function(e,i,r){var o=this;if(r===void 0&&(r=!1),!!this._meshes){var a=this._meshes[e.uniqueId];a?a.color=i:(this._meshes[e.uniqueId]={mesh:e,color:i,observerHighlight:e.onBeforeBindObservable.add(function(s){o.isEnabled&&(o._excludedMeshes&&o._excludedMeshes[s.uniqueId]?o._defaultStencilReference(s):s.getScene().getEngine().setStencilFunctionReference(o._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(function(s){o.isEnabled&&o._defaultStencilReference(s)}),glowEmissiveOnly:r},e.onDisposeObservable.add(function(){o._disposeMesh(e)})),this._shouldRender=!0}},t.prototype.removeMesh=function(e){if(!!this._meshes){var i=this._meshes[e.uniqueId];i&&(i.observerHighlight&&e.onBeforeBindObservable.remove(i.observerHighlight),i.observerDefault&&e.onAfterRenderObservable.remove(i.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(var r in this._meshes)if(this._meshes[r]){this._shouldRender=!0;break}}},t.prototype.removeAllMeshes=function(){if(!!this._meshes){for(var e in this._meshes)if(this._meshes.hasOwnProperty(e)){var i=this._meshes[e];i&&this.removeMesh(i.mesh)}}},t.prototype._defaultStencilReference=function(e){e.getScene().getEngine().setStencilFunctionReference(t.NormalMeshStencilReference)},t.prototype._disposeMesh=function(e){this.removeMesh(e),this.removeExcludedMesh(e)},t.prototype.dispose=function(){if(this._meshes){for(var e in this._meshes){var i=this._meshes[e];i&&i.mesh&&(i.observerHighlight&&i.mesh.onBeforeBindObservable.remove(i.observerHighlight),i.observerDefault&&i.mesh.onAfterRenderObservable.remove(i.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(var e in this._excludedMeshes){var i=this._excludedMeshes[e];i&&(i.beforeBind&&i.mesh.onBeforeBindObservable.remove(i.beforeBind),i.afterRender&&i.mesh.onAfterRenderObservable.remove(i.afterRender))}this._excludedMeshes=null}n.prototype.dispose.call(this)},t.prototype.getClassName=function(){return"HighlightLayer"},t.prototype.serialize=function(){var e=de.a.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(var i in this._meshes){var r=this._meshes[i];r&&e.meshes.push({glowEmissiveOnly:r.glowEmissiveOnly,color:r.color.asArray(),meshId:r.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(var o in this._excludedMeshes){var a=this._excludedMeshes[o];a&&e.excludedMeshes.push(a.mesh.id)}return e},t.Parse=function(e,i,r){var o=de.a.Parse(function(){return new t(e.name,i,e.options)},e,i,r),a;for(a=0;a<e.excludedMeshes.length;a++){var s=i.getMeshByID(e.excludedMeshes[a]);s&&o.addExcludedMesh(s)}for(a=0;a<e.meshes.length;a++){var c=e.meshes[a],s=i.getMeshByID(c.meshId);s&&o.addMesh(s,m.a.FromArray(c.color),c.glowEmissiveOnly)}return o},t.EffectName="HighlightLayer",t.NeutralColor=new m.b(0,0,0,0),t.GlowingMeshStencilReference=2,t.NormalMeshStencilReference=1,Object(h.c)([Object(de.c)()],t.prototype,"innerGlow",void 0),Object(h.c)([Object(de.c)()],t.prototype,"outerGlow",void 0),Object(h.c)([Object(de.c)()],t.prototype,"blurHorizontalSize",null),Object(h.c)([Object(de.c)()],t.prototype,"blurVerticalSize",null),Object(h.c)([Object(de.c)("options")],t.prototype,"_options",void 0),t}(qu.a);f.a.RegisteredTypes["BABYLON.HighlightLayer"]=Ts;var rc=function(){function n(t){this.name=H.a.NAME_LAYER,this.scene=t,this._engine=t.getEngine(),t.layers=new Array}return n.prototype.register=function(){this.scene._beforeCameraDrawStage.registerStep(H.a.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(H.a.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForeground),this.scene._beforeRenderTargetDrawStage.registerStep(H.a.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(H.a.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForeground)},n.prototype.rebuild=function(){for(var t=this.scene.layers,e=0,i=t;e<i.length;e++){var r=i[e];r._rebuild()}},n.prototype.dispose=function(){for(var t=this.scene.layers;t.length;)t[0].dispose()},n.prototype._draw=function(t){var e=this.scene.layers;if(e.length){this._engine.setDepthBuffer(!1);for(var i=0,r=e;i<r.length;i++){var o=r[i];t(o)&&o.render()}this._engine.setDepthBuffer(!0)}},n.prototype._drawCameraPredicate=function(t,e,i){return!t.renderOnlyInRenderTargetTextures&&t.isBackground===e&&(t.layerMask&i)!=0},n.prototype._drawCameraBackground=function(t){var e=this;this._draw(function(i){return e._drawCameraPredicate(i,!0,t.layerMask)})},n.prototype._drawCameraForeground=function(t){var e=this;this._draw(function(i){return e._drawCameraPredicate(i,!1,t.layerMask)})},n.prototype._drawRenderTargetPredicate=function(t,e,i,r){return t.renderTargetTextures.length>0&&t.isBackground===e&&t.renderTargetTextures.indexOf(r)>-1&&(t.layerMask&i)!=0},n.prototype._drawRenderTargetBackground=function(t){var e=this;this._draw(function(i){return e._drawRenderTargetPredicate(i,!0,e.scene.activeCamera.layerMask,t)})},n.prototype._drawRenderTargetForeground=function(t){var e=this;this._draw(function(i){return e._drawRenderTargetPredicate(i,!1,e.scene.activeCamera.layerMask,t)})},n.prototype.addFromContainer=function(t){var e=this;!t.layers||t.layers.forEach(function(i){e.scene.layers.push(i)})},n.prototype.removeFromContainer=function(t,e){var i=this;e===void 0&&(e=!1),!!t.layers&&t.layers.forEach(function(r){var o=i.scene.layers.indexOf(r);o!==-1&&i.scene.layers.splice(o,1),e&&r.dispose()})},n}(),nc="layerPixelShader",oc=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform vec4 color;

#include<helperFunctions>
void main(void) {
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef LINEAR
baseColor.rgb=toGammaSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
}`;qe.a.ShadersStore[nc]=oc;var k_={name:nc,shader:oc},ac="layerVertexShader",sc=`
attribute vec2 position;

uniform vec2 scale;
uniform vec2 offset;
uniform mat4 textureMatrix;

varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vec2 shiftedPosition=position*scale+offset;
vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));
gl_Position=vec4(shiftedPosition,0.0,1.0);
}`;qe.a.ShadersStore[ac]=sc;var X_={name:ac,shader:sc},Fg=function(){function n(t,e,i,r,o){this.name=t,this.scale=new l.d(1,1),this.offset=new l.d(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this._vertexBuffers={},this.onDisposeObservable=new _.c,this.onBeforeRenderObservable=new _.c,this.onAfterRenderObservable=new _.c,this.texture=e?new Ze.a(e,i,!0):null,this.isBackground=r===void 0?!0:r,this.color=o===void 0?new m.b(1,1,1,1):o,this._scene=i||Yt.a.LastCreatedScene;var a=this._scene._getComponent(H.a.NAME_LAYER);a||(a=new rc(this._scene),this._scene._addComponent(a)),this._scene.layers.push(this);var s=this._scene.getEngine(),c=[];c.push(1,1),c.push(-1,1),c.push(-1,-1),c.push(1,-1);var v=new Oe.b(s,c,Oe.b.PositionKind,!1,!1,2);this._vertexBuffers[Oe.b.PositionKind]=v,this._createIndexBuffer()}return Object.defineProperty(n.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onBeforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onAfterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!1,configurable:!0}),n.prototype._createIndexBuffer=function(){var t=this._scene.getEngine(),e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=t.createIndexBuffer(e)},n.prototype._rebuild=function(){var t=this._vertexBuffers[Oe.b.PositionKind];t&&t._rebuild(),this._createIndexBuffer()},n.prototype.render=function(){var t=this._scene.getEngine(),e="";this.alphaTest&&(e="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(e+=`\r
#define LINEAR`),this._previousDefines!==e&&(this._previousDefines=e,this._effect=t.createEffect("layer",[Oe.b.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],e));var i=this._effect;if(!(!i||!i.isReady()||!this.texture||!this.texture.isReady())){var t=this._scene.getEngine();this.onBeforeRenderObservable.notifyObservers(this),t.enableEffect(i),t.setState(!1),i.setTexture("textureSampler",this.texture),i.setMatrix("textureMatrix",this.texture.getTextureMatrix()),i.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),i.setVector2("offset",this.offset),i.setVector2("scale",this.scale),t.bindBuffers(this._vertexBuffers,this._indexBuffer,i),this.alphaTest?t.drawElementsType(Yi.a.TriangleFillMode,0,6):(t.setAlphaMode(this.alphaBlendingMode),t.drawElementsType(Yi.a.TriangleFillMode,0,6),t.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}},n.prototype.dispose=function(){var t=this._vertexBuffers[Oe.b.PositionKind];t&&(t.dispose(),this._vertexBuffers[Oe.b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];var e=this._scene.layers.indexOf(this);this._scene.layers.splice(e,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()},n}(),lc=function(){function n(t,e,i,r,o){this.size=t,this.position=e,this.alphaMode=6,this.color=i||new m.a(1,1,1),this.texture=r?new Ze.a(r,o.getScene(),!0):null,this._system=o,o.lensFlares.push(this)}return n.AddFlare=function(t,e,i,r,o){return new n(t,e,i,r,o)},n.prototype.dispose=function(){this.texture&&this.texture.dispose();var t=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(t,1)},n}(),uc="lensFlarePixelShader",cc=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform vec4 color;
void main(void) {
vec4 baseColor=texture2D(textureSampler,vUV);
gl_FragColor=baseColor*color;
}`;qe.a.ShadersStore[uc]=cc;var Y_={name:uc,shader:cc},fc="lensFlareVertexShader",hc=`
attribute vec2 position;

uniform mat4 viewportMatrix;

varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vUV=position*madd+madd;
gl_Position=viewportMatrix*vec4(position,0.0,1.0);
}`;qe.a.ShadersStore[fc]=hc;var K_={name:fc,shader:hc},Rs=function(){function n(t,e,i){this.name=t,this.lensFlares=new Array,this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=i||Yt.a.LastCreatedScene,n._SceneComponentInitialization(this._scene),this._emitter=e,this.id=t,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=function(s){return i.activeCamera&&s.material&&s.isVisible&&s.isEnabled()&&s.isBlocker&&(s.layerMask&i.activeCamera.layerMask)!=0};var r=i.getEngine(),o=[];o.push(1,1),o.push(-1,1),o.push(-1,-1),o.push(1,-1),this._vertexBuffers[Oe.b.PositionKind]=new Oe.b(r,o,Oe.b.PositionKind,!1,!1,2);var a=[];a.push(0),a.push(1),a.push(2),a.push(0),a.push(2),a.push(3),this._indexBuffer=r.createIndexBuffer(a),this._effect=r.createEffect("lensFlare",[Oe.b.PositionKind],["color","viewportMatrix"],["textureSampler"],"")}return Object.defineProperty(n.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(t){this._isEnabled=t},enumerable:!1,configurable:!0}),n.prototype.getScene=function(){return this._scene},n.prototype.getEmitter=function(){return this._emitter},n.prototype.setEmitter=function(t){this._emitter=t},n.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},n.prototype.computeEffectivePosition=function(t){var e=this.getEmitterPosition();e=l.e.Project(e,l.a.Identity(),this._scene.getTransformMatrix(),t),this._positionX=e.x,this._positionY=e.y,e=l.e.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(t.x-=this.viewportBorder,t.y-=this.viewportBorder,t.width+=this.viewportBorder*2,t.height+=this.viewportBorder*2,e.x+=this.viewportBorder,e.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);var i=this._scene.useRightHandedSystem,r=e.z>0&&!i||e.z<0&&i;return r?(this._positionX>t.x&&this._positionX<t.x+t.width&&this._positionY>t.y&&this._positionY<t.y+t.height,!0):!1},n.prototype._isVisible=function(){if(!this._isEnabled||!this._scene.activeCamera)return!1;var t=this.getEmitterPosition(),e=t.subtract(this._scene.activeCamera.globalPosition),i=e.length();e.normalize();var r=new Zt.a(this._scene.activeCamera.globalPosition,e),o=this._scene.pickWithRay(r,this.meshesSelectionPredicate,!0);return!o||!o.hit||o.distance>i},n.prototype.render=function(){if(!this._effect.isReady()||!this._scene.activeCamera)return!1;var t=this._scene.getEngine(),e=this._scene.activeCamera.viewport,i=e.toGlobal(t.getRenderWidth(!0),t.getRenderHeight(!0));if(!this.computeEffectivePosition(i)||!this._isVisible())return!1;var r,o;this._positionX<this.borderLimit+i.x?r=this.borderLimit+i.x-this._positionX:this._positionX>i.x+i.width-this.borderLimit?r=this._positionX-i.x-i.width+this.borderLimit:r=0,this._positionY<this.borderLimit+i.y?o=this.borderLimit+i.y-this._positionY:this._positionY>i.y+i.height-this.borderLimit?o=this._positionY-i.y-i.height+this.borderLimit:o=0;var a=r>o?r:o;a-=this.viewportBorder,a>this.borderLimit&&(a=this.borderLimit);var s=1-$e.a.Clamp(a/this.borderLimit,0,1);if(s<0)return!1;s>1&&(s=1),this.viewportBorder>0&&(i.x+=this.viewportBorder,i.y+=this.viewportBorder,i.width-=this.viewportBorder*2,i.height-=this.viewportBorder*2,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);var c=i.x+i.width/2,v=i.y+i.height/2,b=c-this._positionX,C=v-this._positionY;t.enableEffect(this._effect),t.setState(!1),t.setDepthBuffer(!1),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);for(var M=0;M<this.lensFlares.length;M++){var N=this.lensFlares[M];if(!(N.texture&&!N.texture.isReady())){t.setAlphaMode(N.alphaMode);var D=c-b*N.position,V=v-C*N.position,X=N.size,ee=N.size*t.getAspectRatio(this._scene.activeCamera,!0),ie=2*(D/(i.width+i.x*2))-1,ge=1-2*(V/(i.height+i.y*2)),pe=l.a.FromValues(X/2,0,0,0,0,ee/2,0,0,0,0,1,0,ie,ge,0,1);this._effect.setMatrix("viewportMatrix",pe),this._effect.setTexture("textureSampler",N.texture),this._effect.setFloat4("color",N.color.r*s,N.color.g*s,N.color.b*s,1),t.drawElementsType(Yi.a.TriangleFillMode,0,6)}}return t.setDepthBuffer(!0),t.setAlphaMode(0),!0},n.prototype.dispose=function(){var t=this._vertexBuffers[Oe.b.PositionKind];for(t&&(t.dispose(),this._vertexBuffers[Oe.b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();var e=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(e,1)},n.Parse=function(t,e,i){var r=e.getLastEntryByID(t.emitterId),o=t.name||"lensFlareSystem#"+t.emitterId,a=new n(o,r,e);a.id=t.id||o,a.borderLimit=t.borderLimit;for(var s=0;s<t.flares.length;s++){var c=t.flares[s];lc.AddFlare(c.size,c.position,m.a.FromArray(c.color),c.textureName?i+c.textureName:"",a)}return a},n.prototype.serialize=function(){var t={};t.id=this.id,t.name=this.name,t.emitterId=this.getEmitter().id,t.borderLimit=this.borderLimit,t.flares=[];for(var e=0;e<this.lensFlares.length;e++){var i=this.lensFlares[e];t.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:J.b.GetFilename(i.texture?i.texture.name:"")})}return t},n._SceneComponentInitialization=function(t){throw Re.a.WarnImport("LensFlareSystemSceneComponent")},n}();S.a.AddParser(H.a.NAME_LENSFLARESYSTEM,function(n,t,e,i){if(n.lensFlareSystems!==void 0&&n.lensFlareSystems!==null){e.lensFlareSystems||(e.lensFlareSystems=new Array);for(var r=0,o=n.lensFlareSystems.length;r<o;r++){var a=n.lensFlareSystems[r],s=Rs.Parse(a,t,i);e.lensFlareSystems.push(s)}}}),S.a.prototype.getLensFlareSystemByName=function(n){for(var t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===n)return this.lensFlareSystems[t];return null},S.a.prototype.getLensFlareSystemByID=function(n){for(var t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===n)return this.lensFlareSystems[t];return null},S.a.prototype.removeLensFlareSystem=function(n){var t=this.lensFlareSystems.indexOf(n);return t!==-1&&this.lensFlareSystems.splice(t,1),t},S.a.prototype.addLensFlareSystem=function(n){this.lensFlareSystems.push(n)};var dc=function(){function n(t){this.name=H.a.NAME_LENSFLARESYSTEM,this.scene=t,t.lensFlareSystems=new Array}return n.prototype.register=function(){this.scene._afterCameraDrawStage.registerStep(H.a.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)},n.prototype.rebuild=function(){},n.prototype.addFromContainer=function(t){var e=this;!t.lensFlareSystems||t.lensFlareSystems.forEach(function(i){e.scene.addLensFlareSystem(i)})},n.prototype.removeFromContainer=function(t,e){var i=this;!t.lensFlareSystems||t.lensFlareSystems.forEach(function(r){i.scene.removeLensFlareSystem(r),e&&r.dispose()})},n.prototype.serialize=function(t){t.lensFlareSystems=[];for(var e=this.scene.lensFlareSystems,i=0,r=e;i<r.length;i++){var o=r[i];t.lensFlareSystems.push(o.serialize())}},n.prototype.dispose=function(){for(var t=this.scene.lensFlareSystems;t.length;)t[0].dispose()},n.prototype._draw=function(t){if(this.scene.lensFlaresEnabled){var e=this.scene.lensFlareSystems;J.b.StartPerformanceCounter("Lens flares",e.length>0);for(var i=0,r=e;i<r.length;i++){var o=r[i];(t.layerMask&o.layerMask)!=0&&o.render()}J.b.EndPerformanceCounter("Lens flares",e.length>0)}},n}();Rs._SceneComponentInitialization=function(n){var t=n._getComponent(H.a.NAME_LENSFLARESYSTEM);t||(t=new dc(n),n._addComponent(t))};var pc=u(541),Bg=u(628),Ng=u(694);Nt.a.AddNodeConstructor("Light_Type_0",function(n,t){return function(){return new As(n,l.e.Zero(),t)}});var As=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,r)||this;return o._shadowAngle=Math.PI/2,o.position=i,o}return Object.defineProperty(t.prototype,"shadowAngle",{get:function(){return this._shadowAngle},set:function(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},set:function(e){var i=this.needCube();this._direction=e,this.needCube()!==i&&this._shadowGenerator&&this._shadowGenerator.recreateShadowMap()},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PointLight"},t.prototype.getTypeID=function(){return Zo.a.LIGHTTYPEID_POINTLIGHT},t.prototype.needCube=function(){return!this.direction},t.prototype.getShadowDirection=function(e){if(this.direction)return n.prototype.getShadowDirection.call(this,e);switch(e){case 0:return new l.e(1,0,0);case 1:return new l.e(-1,0,0);case 2:return new l.e(0,-1,0);case 3:return new l.e(0,1,0);case 4:return new l.e(0,0,1);case 5:return new l.e(0,0,-1)}return l.e.Zero()},t.prototype._setDefaultShadowProjectionMatrix=function(e,i,r){var o=this.getScene().activeCamera;!o||l.a.PerspectiveFovLHToRef(this.shadowAngle,1,this.getDepthMinZ(o),this.getDepthMaxZ(o),e)},t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype.transferToEffect=function(e,i){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,i):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,i),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,i),this},t.prototype.transferToNodeMaterialEffect=function(e,i){return this.computeTransformedInformation()?e.setFloat3(i,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(i,this.position.x,this.position.y,this.position.z),this},t.prototype.prepareLightSpecificDefines=function(e,i){e["POINTLIGHT"+i]=!0},Object(h.c)([Object(de.c)()],t.prototype,"shadowAngle",null),t}(fs.a),wg=u(695),gc=u(677),Vg=u(668),Ug=u(719),vr=u(474),mc=function(){function n(t){t===void 0&&(t={}),this._isEnabled=!0,this.bias=t.bias===void 0?0:t.bias,this.power=t.power===void 0?1:t.power,this.leftColor=t.leftColor||m.a.White(),this.rightColor=t.rightColor||m.a.Black(),t.isEnabled===!1&&(this.isEnabled=!1)}return Object.defineProperty(n.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(t){this._isEnabled!==t&&(this._isEnabled=t,W.a.MarkAllMaterialsAsDirty(4|16))},enumerable:!1,configurable:!0}),n.prototype.clone=function(){var t=new n;return vr.a.DeepCopy(this,t),t},n.prototype.equals=function(t){return t&&this.bias===t.bias&&this.power===t.power&&this.leftColor.equals(t.leftColor)&&this.rightColor.equals(t.rightColor)&&this.isEnabled===t.isEnabled},n.prototype.serialize=function(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}},n.Parse=function(t){return new n({isEnabled:t.isEnabled,leftColor:m.a.FromArray(t.leftColor),rightColor:m.a.FromArray(t.rightColor),bias:t.bias,power:t.power||1})},n}();de.a._FresnelParametersParser=mc.Parse;var vc=u(690),yo=u(543),Q_=u(732),Z_=u(733),Gg=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e,i,"color",{attributes:["position"],uniforms:["world","viewProjection","color"]})||this;return r.disableColorWrite=!0,r.forceDepthWrite=!0,r.setColor4("color",new m.b(0,0,0,1)),r}return t}(Tn.a),Hr=u(529),Os=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r.maxSimultaneousLights=4,r.disableLighting=!1,r.invertNormalMapX=!1,r.invertNormalMapY=!1,r.emissiveColor=new m.a(0,0,0),r.occlusionStrength=1,r.useLightmapAsShadowmap=!1,r._useAlphaFromAlbedoTexture=!0,r._useAmbientInGrayScale=!0,r}return Object.defineProperty(t.prototype,"doubleSided",{get:function(){return this._twoSidedLighting},set:function(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PBRBaseSimpleMaterial"},Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"maxSimultaneousLights",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"disableLighting",void 0),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],t.prototype,"environmentTexture",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"invertNormalMapX",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"invertNormalMapY",void 0),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],t.prototype,"normalTexture",void 0),Object(h.c)([Object(de.e)("emissive"),Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"emissiveColor",void 0),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"emissiveTexture",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],t.prototype,"occlusionStrength",void 0),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],t.prototype,"occlusionTexture",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],t.prototype,"alphaCutOff",void 0),Object(h.c)([Object(de.c)()],t.prototype,"doubleSided",null),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty",null)],t.prototype,"lightmapTexture",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"useLightmapAsShadowmap",void 0),t}(Hr.a),_c=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r._useRoughnessFromMetallicTextureAlpha=!1,r._useRoughnessFromMetallicTextureGreen=!0,r._useMetallnessFromMetallicTextureBlue=!0,r.metallic=1,r.roughness=1,r}return t.prototype.getClassName=function(){return"PBRMetallicRoughnessMaterial"},t.prototype.clone=function(e){var i=this,r=de.a.Clone(function(){return new t(e,i.getScene())},this);return r.id=e,r.name=e,this.clearCoat.copyTo(r.clearCoat),this.anisotropy.copyTo(r.anisotropy),this.brdf.copyTo(r.brdf),this.sheen.copyTo(r.sheen),this.subSurface.copyTo(r.subSurface),r},t.prototype.serialize=function(){var e=de.a.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e},t.Parse=function(e,i,r){var o=de.a.Parse(function(){return new t(e.name,i)},e,i,r);return e.clearCoat&&o.clearCoat.parse(e.clearCoat,i,r),e.anisotropy&&o.anisotropy.parse(e.anisotropy,i,r),e.brdf&&o.brdf.parse(e.brdf,i,r),e.sheen&&o.sheen.parse(e.sheen,i,r),e.subSurface&&o.subSurface.parse(e.subSurface,i,r),o},Object(h.c)([Object(de.e)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],t.prototype,"baseColor",void 0),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],t.prototype,"baseTexture",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"metallic",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"roughness",void 0),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],t.prototype,"metallicRoughnessTexture",void 0),t}(Os);f.a.RegisteredTypes["BABYLON.PBRMetallicRoughnessMaterial"]=_c;var yc=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r._useMicroSurfaceFromReflectivityMapAlpha=!0,r}return Object.defineProperty(t.prototype,"useMicroSurfaceFromReflectivityMapAlpha",{get:function(){return this._useMicroSurfaceFromReflectivityMapAlpha},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PBRSpecularGlossinessMaterial"},t.prototype.clone=function(e){var i=this,r=de.a.Clone(function(){return new t(e,i.getScene())},this);return r.id=e,r.name=e,this.clearCoat.copyTo(r.clearCoat),this.anisotropy.copyTo(r.anisotropy),this.brdf.copyTo(r.brdf),this.sheen.copyTo(r.sheen),this.subSurface.copyTo(r.subSurface),r},t.prototype.serialize=function(){var e=de.a.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e},t.Parse=function(e,i,r){var o=de.a.Parse(function(){return new t(e.name,i)},e,i,r);return e.clearCoat&&o.clearCoat.parse(e.clearCoat,i,r),e.anisotropy&&o.anisotropy.parse(e.anisotropy,i,r),e.brdf&&o.brdf.parse(e.brdf,i,r),e.sheen&&o.sheen.parse(e.sheen,i,r),e.subSurface&&o.subSurface.parse(e.subSurface,i,r),o},Object(h.c)([Object(de.e)("diffuse"),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],t.prototype,"diffuseColor",void 0),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],t.prototype,"diffuseTexture",void 0),Object(h.c)([Object(de.e)("specular"),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],t.prototype,"specularColor",void 0),Object(h.c)([Object(de.c)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_microSurface")],t.prototype,"glossiness",void 0),Object(h.c)([Object(de.m)(),Object(de.b)("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],t.prototype,"specularGlossinessTexture",void 0),t}(Os);f.a.RegisteredTypes["BABYLON.PBRSpecularGlossinessMaterial"]=yc;var bc=function(n){Object(h.d)(t,n);function t(e,i,r){r===void 0&&(r=null);var o=n.call(this,i)||this;if(!e)return o;if(o._textureMatrix=l.a.Identity(),o.name=e,o.url=e,o._onLoad=r,o._texture=o._getFromCache(e,!0),o._texture)o._triggerOnLoad();else{var a=o.getScene();a&&a.useDelayedTextureLoading?o.delayLoadState=4:o.loadTexture()}return o}return t.prototype._triggerOnLoad=function(){this._onLoad&&this._onLoad()},t.prototype.getTextureMatrix=function(){return this._textureMatrix},t.prototype.load3dlTexture=function(){var e=this,i=this._getEngine(),r;i._features.support3DTextures?r=i.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):r=i.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=r,this._texture.isReady=!1,this.isCube=!1,this.is3D=i._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;var o=function(s){if(typeof s=="string"){for(var c=null,v=null,b,C=s.split(`
`),M=0,N=0,D=0,V=0,X=0,ee=0;ee<C.length;ee++)if(b=C[ee],!!t._noneEmptyLineRegex.test(b)&&b.indexOf("#")!==0){var ie=b.split(" ");if(M===0){M=ie.length,c=new Uint8Array(M*M*M*4),v=new Float32Array(M*M*M*4);continue}if(M!=0){var ge=Math.max(parseInt(ie[0]),0),pe=Math.max(parseInt(ie[1]),0),te=Math.max(parseInt(ie[2]),0);X=Math.max(ge,X),X=Math.max(pe,X),X=Math.max(te,X);var Ce=(N+V*M+D*M*M)*4;v&&(v[Ce+0]=ge,v[Ce+1]=pe,v[Ce+2]=te),D++,D%M==0&&(V++,D=0,V%M==0&&(N++,V=0))}}if(v&&c)for(var ee=0;ee<v.length;ee++)if(ee>0&&(ee+1)%4==0)c[ee]=255;else{var Ae=v[ee];c[ee]=Ae/X*255}r.is3D?(r.updateSize(M,M,M),i.updateRawTexture3D(r,c,5,!1)):(r.updateSize(M*M,M),i.updateRawTexture(r,c,5,!1)),r.isReady=!0,e._triggerOnLoad()}},a=this.getScene();return a?a._loadFile(this.url,o):i._loadFile(this.url,o),this._texture},t.prototype.loadTexture=function(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this.load3dlTexture()},t.prototype.clone=function(){var e=new t(this.url,this.getScene()||this._getEngine());return e.level=this.level,e},t.prototype.delayLoad=function(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this.loadTexture())},t.Parse=function(e,i){var r=null;return e.name&&!e.isRenderTarget&&(r=new t(e.name,i),r.name=e.name,r.level=e.level),r},t.prototype.serialize=function(){if(!this.name)return null;var e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e},t._noneEmptyLineRegex=/\S+/,t}(jr.a);f.a.RegisteredTypes["BABYLON.ColorGradingTexture"]=bc;var Ec=u(569),Pc=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){o===void 0&&(o=!1),a===void 0&&(a=!0),s===void 0&&(s=null),c===void 0&&(c=null);var v=n.call(this,i)||this;if(v._onLoad=null,v._onError=null,!e)throw new Error("Image url is not set");return v._coordinatesMode=Ze.a.CUBIC_MODE,v.name=e,v.url=e,v._size=r,v._noMipmap=o,v.gammaSpace=a,v._onLoad=s,v._onError=c,v.hasAlpha=!1,v.isCube=!0,v._texture=v._getFromCache(e,v._noMipmap),v._texture?s&&(v._texture.isReady?J.b.SetImmediate(function(){return s()}):v._texture.onLoadedObservable.add(s)):i.useDelayedTextureLoading?v.delayLoadState=4:v.loadImage(v.loadTexture.bind(v),v._onError),v}return t.prototype.loadImage=function(e,i){var r=this,o=document.createElement("canvas"),a=new Image;a.addEventListener("load",function(){r._width=a.width,r._height=a.height,o.width=r._width,o.height=r._height;var s=o.getContext("2d");s.drawImage(a,0,0);var c=s.getImageData(0,0,a.width,a.height);r._buffer=c.data.buffer,o.remove(),e()}),a.addEventListener("error",function(s){i&&i(r.getClassName()+" could not be loaded",s)}),a.src=this.url},t.prototype.loadTexture=function(){var e=this,i=this.getScene(),r=function(){for(var o=e.getFloat32ArrayFromArrayBuffer(e._buffer),a=Ec.a.ConvertPanoramaToCubemap(o,e._width,e._height,e._size),s=[],c=0;c<6;c++){var v=a[t._FacesMapping[c]];s.push(v)}return s};!i||(this._texture=i.getEngine().createRawCubeTextureFromUrl(this.url,i,this._size,4,i.getEngine().getCaps().textureFloat?1:7,this._noMipmap,r,null,this._onLoad,this._onError))},t.prototype.getFloat32ArrayFromArrayBuffer=function(e){for(var i=new DataView(e),r=new Float32Array(e.byteLength*3/4),o=0,a=0;a<e.byteLength;a++)(a+1)%4!=0&&(r[o++]=i.getUint8(a)/255);return r},t.prototype.getClassName=function(){return"EquiRectangularCubeTexture"},t.prototype.clone=function(){var e=this.getScene();if(!e)return this;var i=new t(this.url,e,this._size,this._noMipmap,this.gammaSpace);return i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i.coordinatesIndex=this.coordinatesIndex,i.coordinatesMode=this.coordinatesMode,i},t._FacesMapping=["right","left","up","down","front","back"],t}(jr.a),zg=u(637),Cc=u(567),jg=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,r.scene||r.engine)||this;return!i||!r.engine&&!r.scene||(r=Object(h.a)(Object(h.a)({},t.DefaultOptions),r),o._generateMipMaps=r.generateMipMaps,o._samplingMode=r.samplingMode,o._textureMatrix=l.a.Identity(),o.name=e,o.element=i,o._isVideo=i instanceof HTMLVideoElement,o.anisotropicFilteringLevel=1,o._createInternalTexture()),o}return t.prototype._createInternalTexture=function(){var e=0,i=0;this._isVideo?(e=this.element.videoWidth,i=this.element.videoHeight):(e=this.element.width,i=this.element.height);var r=this._getEngine();r&&(this._texture=r.createDynamicTexture(e,i,this._generateMipMaps,this._samplingMode)),this.update()},t.prototype.getTextureMatrix=function(){return this._textureMatrix},t.prototype.update=function(e){e===void 0&&(e=null);var i=this._getEngine();if(!(this._texture==null||i==null))if(this._isVideo){var r=this.element;if(r.readyState<r.HAVE_CURRENT_DATA)return;i.updateVideoTexture(this._texture,r,e===null?!0:e)}else{var o=this.element;i.updateDynamicTexture(this._texture,o,e===null?!0:e,!1)}},t.DefaultOptions={generateMipMaps:!1,samplingMode:2,engine:null,scene:null},t}(jr.a),qo=function(){function n(){}return n.GetTGAHeader=function(t){var e=0,i={id_length:t[e++],colormap_type:t[e++],image_type:t[e++],colormap_index:t[e++]|t[e++]<<8,colormap_length:t[e++]|t[e++]<<8,colormap_size:t[e++],origin:[t[e++]|t[e++]<<8,t[e++]|t[e++]<<8],width:t[e++]|t[e++]<<8,height:t[e++]|t[e++]<<8,pixel_size:t[e++],flags:t[e++]};return i},n.UploadContent=function(t,e){if(e.length<19){p.a.Error("Unable to load TGA file - Not enough data to contain header");return}var i=18,r=n.GetTGAHeader(e);if(r.id_length+i>e.length){p.a.Error("Unable to load TGA file - Not enough data");return}i+=r.id_length;var o=!1,a=!1,s=!1;switch(r.image_type){case n._TYPE_RLE_INDEXED:o=!0;case n._TYPE_INDEXED:a=!0;break;case n._TYPE_RLE_RGB:o=!0;case n._TYPE_RGB:break;case n._TYPE_RLE_GREY:o=!0;case n._TYPE_GREY:s=!0;break}var c,v=r.pixel_size>>3,b=r.width*r.height*v,C;if(a&&(C=e.subarray(i,i+=r.colormap_length*(r.colormap_size>>3))),o){c=new Uint8Array(b);for(var M,N,D,V=0,X=new Uint8Array(v);i<b&&V<b;)if(M=e[i++],N=(M&127)+1,M&128){for(D=0;D<v;++D)X[D]=e[i++];for(D=0;D<N;++D)c.set(X,V+D*v);V+=v*N}else{for(N*=v,D=0;D<N;++D)c[V+D]=e[i++];V+=N}}else c=e.subarray(i,i+=a?r.width*r.height:b);var ee,ie,ge,pe,te,Ce;switch((r.flags&n._ORIGIN_MASK)>>n._ORIGIN_SHIFT){default:case n._ORIGIN_UL:ee=0,ge=1,Ce=r.width,ie=0,pe=1,te=r.height;break;case n._ORIGIN_BL:ee=0,ge=1,Ce=r.width,ie=r.height-1,pe=-1,te=-1;break;case n._ORIGIN_UR:ee=r.width-1,ge=-1,Ce=-1,ie=0,pe=1,te=r.height;break;case n._ORIGIN_BR:ee=r.width-1,ge=-1,Ce=-1,ie=r.height-1,pe=-1,te=-1;break}var Ae="_getImageData"+(s?"Grey":"")+r.pixel_size+"bits",De=n[Ae](r,C,c,ie,pe,te,ee,ge,Ce),Fe=t.getEngine();Fe._uploadDataToTextureDirectly(t,De)},n._getImageData8bits=function(t,e,i,r,o,a,s,c,v){var b=i,C=e,M=t.width,N=t.height,D,V=0,X,ee,ie=new Uint8Array(M*N*4);for(ee=r;ee!==a;ee+=o)for(X=s;X!==v;X+=c,V++)D=b[V],ie[(X+M*ee)*4+3]=255,ie[(X+M*ee)*4+2]=C[D*3+0],ie[(X+M*ee)*4+1]=C[D*3+1],ie[(X+M*ee)*4+0]=C[D*3+2];return ie},n._getImageData16bits=function(t,e,i,r,o,a,s,c,v){var b=i,C=t.width,M=t.height,N,D=0,V,X,ee=new Uint8Array(C*M*4);for(X=r;X!==a;X+=o)for(V=s;V!==v;V+=c,D+=2){N=b[D+0]+(b[D+1]<<8);var ie=((N&31744)>>10)*255/31|0,ge=((N&992)>>5)*255/31|0,pe=(N&31)*255/31|0;ee[(V+C*X)*4+0]=ie,ee[(V+C*X)*4+1]=ge,ee[(V+C*X)*4+2]=pe,ee[(V+C*X)*4+3]=N&32768?0:255}return ee},n._getImageData24bits=function(t,e,i,r,o,a,s,c,v){var b=i,C=t.width,M=t.height,N=0,D,V,X=new Uint8Array(C*M*4);for(V=r;V!==a;V+=o)for(D=s;D!==v;D+=c,N+=3)X[(D+C*V)*4+3]=255,X[(D+C*V)*4+2]=b[N+0],X[(D+C*V)*4+1]=b[N+1],X[(D+C*V)*4+0]=b[N+2];return X},n._getImageData32bits=function(t,e,i,r,o,a,s,c,v){var b=i,C=t.width,M=t.height,N=0,D,V,X=new Uint8Array(C*M*4);for(V=r;V!==a;V+=o)for(D=s;D!==v;D+=c,N+=4)X[(D+C*V)*4+2]=b[N+0],X[(D+C*V)*4+1]=b[N+1],X[(D+C*V)*4+0]=b[N+2],X[(D+C*V)*4+3]=b[N+3];return X},n._getImageDataGrey8bits=function(t,e,i,r,o,a,s,c,v){var b=i,C=t.width,M=t.height,N,D=0,V,X,ee=new Uint8Array(C*M*4);for(X=r;X!==a;X+=o)for(V=s;V!==v;V+=c,D++)N=b[D],ee[(V+C*X)*4+0]=N,ee[(V+C*X)*4+1]=N,ee[(V+C*X)*4+2]=N,ee[(V+C*X)*4+3]=255;return ee},n._getImageDataGrey16bits=function(t,e,i,r,o,a,s,c,v){var b=i,C=t.width,M=t.height,N=0,D,V,X=new Uint8Array(C*M*4);for(V=r;V!==a;V+=o)for(D=s;D!==v;D+=c,N+=2)X[(D+C*V)*4+0]=b[N+0],X[(D+C*V)*4+1]=b[N+0],X[(D+C*V)*4+2]=b[N+0],X[(D+C*V)*4+3]=b[N+1];return X},n._TYPE_INDEXED=1,n._TYPE_RGB=2,n._TYPE_GREY=3,n._TYPE_RLE_INDEXED=9,n._TYPE_RLE_RGB=10,n._TYPE_RLE_GREY=11,n._ORIGIN_MASK=48,n._ORIGIN_SHIFT=4,n._ORIGIN_BL=0,n._ORIGIN_BR=1,n._ORIGIN_UL=2,n._ORIGIN_UR=3,n}(),Sc=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t){return Rr.a.EndsWith(t,".tga")},n.prototype.loadCubeData=function(t,e,i,r,o){throw".env not supported in Cube."},n.prototype.loadData=function(t,e,i){var r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),o=qo.GetTGAHeader(r);i(o.width,o.height,e.generateMipMaps,!1,function(){qo.UploadContent(e,r)})},n}();W.a._TextureLoaders.push(new Sc);var Ms=u(568),Tc=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t){return Rr.a.EndsWith(t,".hdr")},n.prototype.loadCubeData=function(t,e,i,r,o){throw".env not supported in Cube."},n.prototype.loadData=function(t,e,i){for(var r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),o=Ms.a.RGBE_ReadHeader(r),a=Ms.a.RGBE_ReadPixels(r,o),s=o.width*o.height,c=new Float32Array(s*4),v=0;v<s;v+=1)c[v*4]=a[v*3],c[v*4+1]=a[v*3+1],c[v*4+2]=a[v*3+2],c[v*4+3]=1;i(o.width,o.height,e.generateMipMaps,!1,function(){var b=e.getEngine();e.type=1,e.format=5,e._gammaSpace=!1,b._uploadDataToTextureDirectly(e,c)})},n}();W.a._TextureLoaders.push(new Tc);var J_=function(){function n(){}return n}(),$_=function(){function n(){}return n}(),Wg=function(){function n(){}return n}(),bo;(function(n){n[n.cTFETC1=0]="cTFETC1",n[n.cTFBC1=1]="cTFBC1",n[n.cTFBC4=2]="cTFBC4",n[n.cTFPVRTC1_4_OPAQUE_ONLY=3]="cTFPVRTC1_4_OPAQUE_ONLY",n[n.cTFBC7_M6_OPAQUE_ONLY=4]="cTFBC7_M6_OPAQUE_ONLY",n[n.cTFETC2=5]="cTFETC2",n[n.cTFBC3=6]="cTFBC3",n[n.cTFBC5=7]="cTFBC5"})(bo||(bo={}));var Eo=function(){function n(){}return n.GetInternalFormatFromBasisFormat=function(t){var e=33777,i=33779,r=36196;if(t===bo.cTFETC1)return r;if(t===bo.cTFBC1)return e;if(t===bo.cTFBC3)return i;throw"The chosen Basis transcoder format is not currently supported"},n._CreateWorkerAsync=function(){var t=this;return this._WorkerPromise||(this._WorkerPromise=new Promise(function(e){t._Worker?e(t._Worker):J.b.LoadFileAsync(n.WasmModuleURL).then(function(i){var r=URL.createObjectURL(new Blob(["("+Hg+")()"],{type:"application/javascript"}));t._Worker=new Worker(r);var o=function(a){a.data.action==="init"&&(t._Worker.removeEventListener("message",o),e(t._Worker))};t._Worker.addEventListener("message",o),t._Worker.postMessage({action:"init",url:n.JSModuleURL,wasmBinary:i})})})),this._WorkerPromise},n.TranscodeAsync=function(t,e){var i=this,r=t instanceof ArrayBuffer?new Uint8Array(t):t;return new Promise(function(o,a){i._CreateWorkerAsync().then(function(){var s=i._actionId++,c=function(b){b.data.action==="transcode"&&b.data.id===s&&(i._Worker.removeEventListener("message",c),b.data.success?o(b.data):a("Transcode is not supported on this device"))};i._Worker.addEventListener("message",c);var v=new Uint8Array(r.byteLength);v.set(new Uint8Array(r.buffer,r.byteOffset,r.byteLength)),i._Worker.postMessage({action:"transcode",id:s,imageData:v,config:e,ignoreSupportedFormats:i._IgnoreSupportedFormats},[v.buffer])})})},n.LoadTextureFromTranscodeResult=function(t,e){for(var i=t.getEngine(),r=function(){if(o=e.fileInfo.images[a].levels[0],t._invertVScale=t.invertY,e.format===-1)if(t.type=10,t.format=4,i._features.basisNeedsPOT&&($e.a.Log2(o.width)%1!=0||$e.a.Log2(o.height)%1!=0)){var s=new gt.a(i,gt.b.Temp);t._invertVScale=t.invertY,s.type=10,s.format=4,s.width=o.width+3&~3,s.height=o.height+3&~3,i._bindTextureDirectly(i._gl.TEXTURE_2D,s,!0),i._uploadDataToTextureDirectly(s,o.transcodedPixels,a,0,4,!0),i._rescaleTexture(s,t,i.scenes[0],i._getInternalFormat(4),function(){i._releaseTexture(s),i._bindTextureDirectly(i._gl.TEXTURE_2D,t,!0)})}else t._invertVScale=!t.invertY,t.width=o.width+3&~3,t.height=o.height+3&~3,i._uploadDataToTextureDirectly(t,o.transcodedPixels,a,0,4,!0);else t.width=o.width,t.height=o.height,e.fileInfo.images[a].levels.forEach(function(c,v){i._uploadCompressedDataToTextureDirectly(t,n.GetInternalFormatFromBasisFormat(e.format),c.width,c.height,c.transcodedPixels,a,v)}),i._features.basisNeedsPOT&&($e.a.Log2(t.width)%1!=0||$e.a.Log2(t.height)%1!=0)&&(J.b.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),t._cachedWrapU=Ze.a.CLAMP_ADDRESSMODE,t._cachedWrapV=Ze.a.CLAMP_ADDRESSMODE)},o,a=0;a<e.fileInfo.images.length;a++)r()},n._IgnoreSupportedFormats=!1,n.JSModuleURL="https://preview.babylonjs.com/basisTranscoder/basis_transcoder.js",n.WasmModuleURL="https://preview.babylonjs.com/basisTranscoder/basis_transcoder.wasm",n._WorkerPromise=null,n._Worker=null,n._actionId=0,n}();function Hg(){var n={cTFETC1:0,cTFBC1:1,cTFBC4:2,cTFPVRTC1_4_OPAQUE_ONLY:3,cTFBC7_M6_OPAQUE_ONLY:4,cTFETC2:5,cTFBC3:6,cTFBC5:7},t=null;onmessage=function(a){if(a.data.action==="init")t||(Module={wasmBinary:a.data.wasmBinary},importScripts(a.data.url),t=new Promise(function(te){Module.onRuntimeInitialized=function(){Module.initializeBasis(),te()}})),t.then(function(){postMessage({action:"init"})});else if(a.data.action==="transcode"){var s=a.data.config,c=a.data.imageData,v=new Module.BasisFile(c),b=i(v),C=a.data.ignoreSupportedFormats?null:e(a.data.config,b),M=!1;C===null&&(M=!0,C=b.hasAlpha?n.cTFBC3:n.cTFBC1);var N=!0;v.startTranscoding()||(N=!1);for(var D=[],V=0;V<b.images.length&&N;V++){var X=b.images[V];if(s.loadSingleImage===void 0||s.loadSingleImage===V){var ee=X.levels.length;s.loadMipmapLevels===!1&&(ee=1);for(var ie=0;ie<ee;ie++){var ge=X.levels[ie],pe=r(v,V,ie,C,M);if(!pe){N=!1;break}ge.transcodedPixels=pe,D.push(ge.transcodedPixels.buffer)}}}v.close(),v.delete(),M&&(C=-1),N?postMessage({action:"transcode",success:N,id:a.data.id,fileInfo:b,format:C},D):postMessage({action:"transcode",success:N,id:a.data.id})}};function e(a,s){var c=null;return a.supportedCompressionFormats&&(a.supportedCompressionFormats.etc1?c=n.cTFETC1:a.supportedCompressionFormats.s3tc?c=s.hasAlpha?n.cTFBC3:n.cTFBC1:a.supportedCompressionFormats.pvrtc||a.supportedCompressionFormats.etc2&&(c=n.cTFETC2)),c}function i(a){for(var s=a.getHasAlpha(),c=a.getNumImages(),v=[],b=0;b<c;b++){for(var C={levels:[]},M=a.getNumLevels(b),N=0;N<M;N++){var D={width:a.getImageWidth(b,N),height:a.getImageHeight(b,N)};C.levels.push(D)}v.push(C)}var V={hasAlpha:s,images:v};return V}function r(a,s,c,v,b){var C=a.getImageTranscodedSizeInBytes(s,c,v),M=new Uint8Array(C);if(!a.transcodeImage(M,s,c,v,1,0))return null;if(b){var N=a.getImageWidth(s,c)+3&~3,D=a.getImageHeight(s,c)+3&~3;M=o(M,0,N,D)}return M}function o(a,s,c,v){for(var b=new Uint16Array(4),C=new Uint16Array(c*v),M=c/4,N=v/4,D=0;D<N;D++)for(var V=0;V<M;V++){var X=s+8*(D*M+V);b[0]=a[X]|a[X+1]<<8,b[1]=a[X+2]|a[X+3]<<8,b[2]=(2*(b[0]&31)+1*(b[1]&31))/3|(2*(b[0]&2016)+1*(b[1]&2016))/3&2016|(2*(b[0]&63488)+1*(b[1]&63488))/3&63488,b[3]=(2*(b[1]&31)+1*(b[0]&31))/3|(2*(b[1]&2016)+1*(b[0]&2016))/3&2016|(2*(b[1]&63488)+1*(b[0]&63488))/3&63488;for(var ee=0;ee<4;ee++){var ie=a[X+4+ee],ge=(D*4+ee)*c+V*4;C[ge++]=b[ie&3],C[ge++]=b[ie>>2&3],C[ge++]=b[ie>>4&3],C[ge++]=b[ie>>6&3]}}return C}}var Rc=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t){return Rr.a.EndsWith(t,".basis")},n.prototype.loadCubeData=function(t,e,i,r,o){if(!Array.isArray(t)){var a=e.getEngine().getCaps(),s={supportedCompressionFormats:{etc1:!!a.etc1,s3tc:!!a.s3tc,pvrtc:!!a.pvrtc,etc2:!!a.etc2}};Eo.TranscodeAsync(t,s).then(function(c){var v=c.fileInfo.images[0].levels.length>1&&e.generateMipMaps;Eo.LoadTextureFromTranscodeResult(e,c),e.getEngine()._setCubeMapTextureParams(e,v),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()}).catch(function(c){J.b.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),e.isReady=!0})}},n.prototype.loadData=function(t,e,i){var r=e.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2}};Eo.TranscodeAsync(t,o).then(function(a){var s=a.fileInfo.images[0].levels[0],c=a.fileInfo.images[0].levels.length>1&&e.generateMipMaps;i(s.width,s.height,c,a.format!==-1,function(){Eo.LoadTextureFromTranscodeResult(e,a)})}).catch(function(a){J.b.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),i(0,0,!1,!1,function(){})})},n}();W.a._TextureLoaders.push(new Rc);var kg=u(538),xs=function(){function n(t,e,i){this.id=t,this.scale=e,this.offset=i}return n}(),Xg=function(){function n(t,e,i,r){var o,a,s,c,v,b,C,M,N,D,V,X,ee;return this.name=t,this.meshes=e,this.scene=r,this.options=i,this.options.map=(o=this.options.map)!==null&&o!==void 0?o:["ambientTexture","bumpTexture","diffuseTexture","emissiveTexture","lightmapTexture","opacityTexture","reflectionTexture","refractionTexture","specularTexture"],this.options.uvsIn=(a=this.options.uvsIn)!==null&&a!==void 0?a:Oe.b.UVKind,this.options.uvsOut=(s=this.options.uvsOut)!==null&&s!==void 0?s:Oe.b.UVKind,this.options.layout=(c=this.options.layout)!==null&&c!==void 0?c:n.LAYOUT_STRIP,this.options.layout===n.LAYOUT_COLNUM&&(this.options.colnum=(v=this.options.colnum)!==null&&v!==void 0?v:8),this.options.updateInputMeshes=(b=this.options.updateInputMeshes)!==null&&b!==void 0?b:!0,this.options.disposeSources=(C=this.options.disposeSources)!==null&&C!==void 0?C:!0,this._expecting=0,this.options.fillBlanks=(M=this.options.fillBlanks)!==null&&M!==void 0?M:!0,this.options.fillBlanks===!0&&(this.options.customFillColor=(N=this.options.customFillColor)!==null&&N!==void 0?N:"black"),this.options.frameSize=(D=this.options.frameSize)!==null&&D!==void 0?D:256,this.options.paddingRatio=(V=this.options.paddingRatio)!==null&&V!==void 0?V:.0115,this._paddingValue=Math.ceil(this.options.frameSize*this.options.paddingRatio),this._paddingValue%2!=0&&this._paddingValue++,this.options.paddingMode=(X=this.options.paddingMode)!==null&&X!==void 0?X:n.SUBUV_WRAP,this.options.paddingMode===n.SUBUV_COLOR&&(this.options.paddingColor=(ee=this.options.paddingColor)!==null&&ee!==void 0?ee:new m.b(0,0,0,1)),this.sets={},this.frames=[],this}return n.prototype._createFrames=function(t){for(var e=this,i=this._calculateSize(),r=new l.d(1,1).divide(i),o=0,a=this._expecting,s=this.meshes.length,c=Object.keys(this.sets),v=0;v<c.length;v++){var b=c[v],C=new un.a(this.name+".TexturePack."+b+"Set",{width:i.x,height:i.y},this.scene,!0,Ze.a.TRILINEAR_SAMPLINGMODE,W.a.TEXTUREFORMAT_RGBA),M=C.getContext();M.fillStyle="rgba(0,0,0,0)",M.fillRect(0,0,i.x,i.y),C.update(!1),this.sets[b]=C}for(var N=this.options.frameSize||256,D=this._paddingValue,V=N+2*D,X=function(){e._calculateMeshUVFrames(N,D,i,r,e.options.updateInputMeshes||!1)},v=0;v<s;v++)for(var ee=this.meshes[v],ie=ee.material,ge=function(Ae){var De=new un.a("temp",V,pe.scene,!0),Fe=De.getContext(),We=pe._getFrameOffset(v),Pe=function(){o++,De.update(!1);var Je=Fe.getImageData(0,0,V,V),tt=e.sets[Ne],Xe=tt.getContext();if(Xe.putImageData(Je,i.x*We.x,i.y*We.y),De.dispose(),tt.update(!1),o==a){X(),t();return}},Ne=c[Ae]||"_blank";if(!ie||ie[Ne]===null)Fe.fillStyle="rgba(0,0,0,0)",pe.options.fillBlanks&&(Fe.fillStyle=pe.options.customFillColor),Fe.fillRect(0,0,V,V),Pe();else{var je=ie[Ne],Be=new Image;je instanceof un.a?Be.src=je.getContext().canvas.toDataURL("image/png"):Be.src=je.url,J.b.SetCorsBehavior(Be.src,Be),Be.onload=function(){Fe.fillStyle="rgba(0,0,0,0)",Fe.fillRect(0,0,V,V),De.update(!1),Fe.setTransform(1,0,0,-1,0,0);var Je=[0,0,1,0,1,1,0,1,-1,1,-1,0,-1-1,0,-1,1,-1];switch(e.options.paddingMode){case 0:for(var tt=0;tt<9;tt++)Fe.drawImage(Be,0,0,Be.width,Be.height,D+N*Je[tt],D+N*Je[tt+1]-V,N,N);break;case 1:for(var Xe=0;Xe<D;Xe++)Fe.drawImage(Be,0,0,Be.width,Be.height,Xe+N*Je[0],D-V,N,N),Fe.drawImage(Be,0,0,Be.width,Be.height,D*2-Xe,D-V,N,N),Fe.drawImage(Be,0,0,Be.width,Be.height,D,Xe-V,N,N),Fe.drawImage(Be,0,0,Be.width,Be.height,D,D*2-Xe-V,N,N);Fe.drawImage(Be,0,0,Be.width,Be.height,D+N*Je[0],D+N*Je[1]-V,N,N);break;case 2:Fe.fillStyle=(e.options.paddingColor||m.a.Black()).toHexString(),Fe.fillRect(0,0,V,-V),Fe.clearRect(D,D,N,N),Fe.drawImage(Be,0,0,Be.width,Be.height,D+N*Je[0],D+N*Je[1]-V,N,N);break}Fe.setTransform(1,0,0,1,0,0),Pe()}}},pe=this,te=0;te<c.length;te++)ge(te)},n.prototype._calculateSize=function(){var t=this.meshes.length||0,e=this.options.frameSize||0,i=this._paddingValue||0;switch(this.options.layout){case 0:return new l.d(e*t+2*i*t,e+2*i);case 1:var r=Math.max(2,Math.ceil(Math.sqrt(t))),o=e*r+2*i*r;return new l.d(o,o);case 2:var a=this.options.colnum||1,s=Math.max(1,Math.ceil(t/a));return new l.d(e*a+2*i*a,e*s+2*i*s)}return l.d.Zero()},n.prototype._calculateMeshUVFrames=function(t,e,i,r,o){for(var a=this.meshes.length,s=0;s<a;s++){var c=this.meshes[s],v=new l.d(t/i.x,t/i.y),b=r.clone().scale(e),C=this._getFrameOffset(s),M=C.add(b),N=new xs(s,v,M);this.frames.push(N),o&&(this._updateMeshUV(c,s),this._updateTextureReferences(c))}},n.prototype._getFrameOffset=function(t){var e=this.meshes.length,i,r,o;switch(this.options.layout){case 0:return i=1/e,new l.d(t*i,0);break;case 1:var a=Math.max(2,Math.ceil(Math.sqrt(e)));return r=Math.floor(t/a),o=t-r*a,i=1/a,new l.d(o*i,r*i);break;case 2:var s=this.options.colnum||1,c=Math.max(1,Math.ceil(e/s));return o=Math.floor(t/c),r=t-o*c,i=new l.d(1/s,1/c),new l.d(o*i.x,r*i.y);break}return l.d.Zero()},n.prototype._updateMeshUV=function(t,e){var i=this.frames[e],r=t.getVerticesData(this.options.uvsIn||Oe.b.UVKind),o=[],a=0;r.length&&(a=r.length||0);for(var s=0;s<a;s+=2)o.push(r[s]*i.scale.x+i.offset.x,r[s+1]*i.scale.y+i.offset.y);t.setVerticesData(this.options.uvsOut||Oe.b.UVKind,o)},n.prototype._updateTextureReferences=function(t,e){e===void 0&&(e=!1);for(var i=t.material,r=Object.keys(this.sets),o=function(c){c.dispose&&c.dispose()},a=0;a<r.length;a++){var s=r[a];if(e)i[s]!==null&&o(i[s]),i[s]=this.sets[s];else{if(!i)return;i[s]!==null&&(o(i[s]),i[s]=this.sets[s])}}},n.prototype.setMeshToFrame=function(t,e,i){i===void 0&&(i=!1),this._updateMeshUV(t,e),i&&this._updateTextureReferences(t,!0)},n.prototype.processAsync=function(){var t=this;return new Promise(function(e,i){try{if(t.meshes.length===0){e();return}for(var r=0,o=function(v){if(r++,t.options.map){for(var b=0;b<t.options.map.length;b++){var C=t.options.map[b],M=v[C];M!==null&&(t.sets[t.options.map[b]]||(t.sets[t.options.map[b]]=!0),t._expecting++)}r===t.meshes.length&&t._createFrames(e)}},a=function(v){var b=t.meshes[v],C=b.material;if(!C)return r++,r===t.meshes.length?{value:t._createFrames(e)}:"continue";C.forceCompilationAsync(b).then(function(){o(C)})},s=0;s<t.meshes.length;s++){var c=a(s);if(typeof c=="object")return c.value}}catch(v){return i(v)}})},n.prototype.dispose=function(){for(var t=Object.keys(this.sets),e=0;e<t.length;e++){var i=t[e];this.sets[i].dispose()}},n.prototype.download=function(t,e){var i=this;t===void 0&&(t="png"),e===void 0&&(e=1),setTimeout(function(){var r={name:i.name,sets:{},options:{},frames:[]},o=Object.keys(i.sets),a=Object.keys(i.options);try{for(var s=0;s<o.length;s++){var c=o[s],v=i.sets[c];r.sets[c]=v.getContext().canvas.toDataURL("image/"+t,e)}for(var s=0;s<a.length;s++){var b=a[s];r.options[b]=i.options[b]}for(var s=0;s<i.frames.length;s++){var C=i.frames[s];r.frames.push(C.scale.x,C.scale.y,C.offset.x,C.offset.y)}}catch(D){p.a.Warn("Unable to download: "+D);return}var M="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(r,null,4)),N=document.createElement("a");N.setAttribute("href",M),N.setAttribute("download",i.name+"_texurePackage.json"),document.body.appendChild(N),N.click(),N.remove()},0)},n.prototype.updateFromJSON=function(t){try{var e=JSON.parse(t);this.name=e.name;for(var i=Object.keys(e.options),r=0;r<i.length;r++)this.options[i[r]]=e.options[i[r]];for(var r=0;r<e.frames.length;r+=4){var o=new xs(r/4,new l.d(e.frames[r],e.frames[r+1]),new l.d(e.frames[r+2],e.frames[r+3]));this.frames.push(o)}for(var a=Object.keys(e.sets),r=0;r<a.length;r++){var s=new Ze.a(e.sets[a[r]],this.scene,!1,!1);this.sets[a[r]]=s}}catch(c){p.a.Warn("Unable to update from JSON: "+c)}},n.LAYOUT_STRIP=0,n.LAYOUT_POWER2=1,n.LAYOUT_COLNUM=2,n.SUBUV_WRAP=0,n.SUBUV_EXTEND=1,n.SUBUV_COLOR=2,n}(),Ac=function(){function n(t){this.name=H.a.NAME_PROCEDURALTEXTURE,this.scene=t,this.scene.proceduralTextures=new Array}return n.prototype.register=function(){this.scene._beforeClearStage.registerStep(H.a.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n.prototype._beforeClear=function(){if(this.scene.proceduralTexturesEnabled){J.b.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(var t=0;t<this.scene.proceduralTextures.length;t++){var e=this.scene.proceduralTextures[t];e._shouldRender()&&e.render()}J.b.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}},n}(),Oc="proceduralVertexShader",Mc=`
attribute vec2 position;

varying vec2 vPosition;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vPosition=position;
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
}`;qe.a.ShadersStore[Oc]=Mc;var q_={name:Oc,shader:Mc},Po=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v){a===void 0&&(a=null),s===void 0&&(s=!0),c===void 0&&(c=!1),v===void 0&&(v=0);var b=n.call(this,null,o,!s)||this;b.isEnabled=!0,b.autoClear=!0,b.onGeneratedObservable=new _.c,b.onBeforeGenerationObservable=new _.c,b.nodeMaterialSource=null,b._textures={},b._currentRefreshId=-1,b._frameId=-1,b._refreshRate=1,b._vertexBuffers={},b._uniforms=new Array,b._samplers=new Array,b._floats={},b._ints={},b._floatsArrays={},b._colors3={},b._colors4={},b._vectors2={},b._vectors3={},b._matrices={},b._fallbackTextureUsed=!1,b._cachedDefines=null,b._contentUpdateId=-1,o=b.getScene()||Yt.a.LastCreatedScene;var C=o._getComponent(H.a.NAME_PROCEDURALTEXTURE);C||(C=new Ac(o),o._addComponent(C)),o.proceduralTextures.push(b),b._fullEngine=o.getEngine(),b.name=e,b.isRenderTarget=!0,b._size=i,b._textureType=v,b._generateMipMaps=s,b.setFragment(r),b._fallbackTexture=a,c?(b._texture=b._fullEngine.createRenderTargetCubeTexture(i,{generateMipMaps:s,generateDepthBuffer:!1,generateStencilBuffer:!1,type:v}),b.setFloat("face",0)):b._texture=b._fullEngine.createRenderTargetTexture(i,{generateMipMaps:s,generateDepthBuffer:!1,generateStencilBuffer:!1,type:v});var M=[];return M.push(1,1),M.push(-1,1),M.push(-1,-1),M.push(1,-1),b._vertexBuffers[Oe.b.PositionKind]=new Oe.b(b._fullEngine,M,Oe.b.PositionKind,!1,!1,2),b._createIndexBuffer(),b}return t.prototype.getEffect=function(){return this._effect},t.prototype.getContent=function(){var e=this;return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(function(i){e._contentData=e.readPixels(0,0,i),e._contentUpdateId=e._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)},t.prototype._createIndexBuffer=function(){var e=this._fullEngine,i=[];i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),this._indexBuffer=e.createIndexBuffer(i)},t.prototype._rebuild=function(){var e=this._vertexBuffers[Oe.b.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Cr.a.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Cr.a.REFRESHRATE_RENDER_ONCE)},t.prototype.reset=function(){this._effect!==void 0&&this._effect.dispose()},t.prototype._getDefines=function(){return""},t.prototype.isReady=function(){var e=this,i=this._fullEngine,r;if(this.nodeMaterialSource)return this._effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;var o=this._getDefines();return this._effect&&o===this._cachedDefines&&this._effect.isReady()?!0:(this._fragment.fragmentElement!==void 0?r={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:r={vertex:"procedural",fragment:this._fragment},this._cachedDefines!==o&&(this._cachedDefines=o,this._effect=i.createEffect(r,[Oe.b.PositionKind],this._uniforms,this._samplers,o,void 0,void 0,function(){e.releaseInternalTexture(),e._fallbackTexture&&(e._texture=e._fallbackTexture._texture,e._texture&&e._texture.incrementReferences()),e._fallbackTextureUsed=!0})),this._effect.isReady())},t.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},t.prototype.setFragment=function(e){this._fragment=e},Object.defineProperty(t.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(e){this._refreshRate=e,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),t.prototype._shouldRender=function(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)},t.prototype.getRenderSize=function(){return this._size},t.prototype.resize=function(e,i){this._fallbackTextureUsed||(this.releaseInternalTexture(),this._texture=this._fullEngine.createRenderTargetTexture(e,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:this._textureType}),this._size=e,this._generateMipMaps=i)},t.prototype._checkUniform=function(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)},t.prototype.setTexture=function(e,i){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=i,this},t.prototype.setFloat=function(e,i){return this._checkUniform(e),this._floats[e]=i,this},t.prototype.setInt=function(e,i){return this._checkUniform(e),this._ints[e]=i,this},t.prototype.setFloats=function(e,i){return this._checkUniform(e),this._floatsArrays[e]=i,this},t.prototype.setColor3=function(e,i){return this._checkUniform(e),this._colors3[e]=i,this},t.prototype.setColor4=function(e,i){return this._checkUniform(e),this._colors4[e]=i,this},t.prototype.setVector2=function(e,i){return this._checkUniform(e),this._vectors2[e]=i,this},t.prototype.setVector3=function(e,i){return this._checkUniform(e),this._vectors3[e]=i,this},t.prototype.setMatrix=function(e,i){return this._checkUniform(e),this._matrices[e]=i,this},t.prototype.render=function(e){var i=this.getScene();if(!!i){var r=this._fullEngine;if(r.enableEffect(this._effect),this.onBeforeGenerationObservable.notifyObservers(this),r.setState(!1),!this.nodeMaterialSource){for(var o in this._textures)this._effect.setTexture(o,this._textures[o]);for(o in this._ints)this._effect.setInt(o,this._ints[o]);for(o in this._floats)this._effect.setFloat(o,this._floats[o]);for(o in this._floatsArrays)this._effect.setArray(o,this._floatsArrays[o]);for(o in this._colors3)this._effect.setColor3(o,this._colors3[o]);for(o in this._colors4){var a=this._colors4[o];this._effect.setFloat4(o,a.r,a.g,a.b,a.a)}for(o in this._vectors2)this._effect.setVector2(o,this._vectors2[o]);for(o in this._vectors3)this._effect.setVector3(o,this._vectors3[o]);for(o in this._matrices)this._effect.setMatrix(o,this._matrices[o])}if(!!this._texture){if(r._debugPushGroup("procedural texture generation for "+this.name,1),this.isCube)for(var s=0;s<6;s++)r.bindFramebuffer(this._texture,s,void 0,void 0,!0),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),this._effect.setFloat("face",s),this.autoClear&&r.clear(i.clearColor,!0,!1,!1),r.drawElementsType(Yi.a.TriangleFillMode,0,6);else r.bindFramebuffer(this._texture,0,void 0,void 0,!0),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),this.autoClear&&r.clear(i.clearColor,!0,!1,!1),r.drawElementsType(Yi.a.TriangleFillMode,0,6);r.unBindFramebuffer(this._texture,this.isCube),this.isCube&&r.generateMipMapsForCubemap(this._texture),r._debugPopGroup(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}}},t.prototype.clone=function(){var e=this.getSize(),i=new t(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,i},t.prototype.dispose=function(){var e=this.getScene();if(!!e){var i=e.proceduralTextures.indexOf(this);i>=0&&e.proceduralTextures.splice(i,1);var r=this._vertexBuffers[Oe.b.PositionKind];r&&(r.dispose(),this._vertexBuffers[Oe.b.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),n.prototype.dispose.call(this)}},Object(h.c)([Object(de.c)()],t.prototype,"isEnabled",void 0),Object(h.c)([Object(de.c)()],t.prototype,"autoClear",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_generateMipMaps",void 0),Object(h.c)([Object(de.c)()],t.prototype,"_size",void 0),Object(h.c)([Object(de.c)()],t.prototype,"refreshRate",null),t}(Ze.a);f.a.RegisteredTypes["BABYLON.ProceduralTexture"]=Po;var Ar=u(519),Yg=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,r,null,o,a,s)||this;return c._animate=!0,c._time=0,c._texturePath=i,c._loadJson(i),c.refreshRate=1,c}return t.prototype._loadJson=function(e){var i=this,r=function(){try{i.setFragment(i._texturePath)}catch(s){p.a.Error("No json or ShaderStore or DOM element found for CustomProceduralTexture")}},o=e+"/config.json",a=new Ar.a;a.open("GET",o),a.addEventListener("load",function(){if(a.status===200||a.responseText&&a.responseText.length>0)try{i._config=JSON.parse(a.response),i.updateShaderUniforms(),i.updateTextures(),i.setFragment(i._texturePath+"/custom"),i._animate=i._config.animate,i.refreshRate=i._config.refreshrate}catch(s){r()}else r()},!1),a.addEventListener("error",function(){r()},!1);try{a.send()}catch(s){p.a.Error("CustomProceduralTexture: Error on XHR send request.")}},t.prototype.isReady=function(){if(!n.prototype.isReady.call(this))return!1;for(var e in this._textures){var i=this._textures[e];if(!i.isReady())return!1}return!0},t.prototype.render=function(e){var i=this.getScene();this._animate&&i&&(this._time+=i.getAnimationRatio()*.03,this.updateShaderUniforms()),n.prototype.render.call(this,e)},t.prototype.updateTextures=function(){for(var e=0;e<this._config.sampler2Ds.length;e++)this.setTexture(this._config.sampler2Ds[e].sample2Dname,new Ze.a(this._texturePath+"/"+this._config.sampler2Ds[e].textureRelativeUrl,this.getScene()))},t.prototype.updateShaderUniforms=function(){if(this._config)for(var e=0;e<this._config.uniforms.length;e++){var i=this._config.uniforms[e];switch(i.type){case"float":this.setFloat(i.name,i.value);break;case"color3":this.setColor3(i.name,new m.a(i.r,i.g,i.b));break;case"color4":this.setColor4(i.name,new m.b(i.r,i.g,i.b,i.a));break;case"vector2":this.setVector2(i.name,new l.d(i.x,i.y));break;case"vector3":this.setVector3(i.name,new l.e(i.x,i.y,i.z));break}}this.setFloat("time",this._time)},Object.defineProperty(t.prototype,"animate",{get:function(){return this._animate},set:function(e){this._animate=e},enumerable:!1,configurable:!0}),t}(Po),xc="noisePixelShader",Dc=`

uniform float brightness;
uniform float persistence;
uniform float timeScale;

varying vec2 vUV;

vec2 hash22(vec2 p)
{
p=p*mat2(127.1,311.7,269.5,183.3);
p=-1.0+2.0*fract(sin(p)*43758.5453123);
return sin(p*6.283+timeScale);
}
float interpolationNoise(vec2 p)
{
vec2 pi=floor(p);
vec2 pf=p-pi;
vec2 w=pf*pf*(3.-2.*pf);
float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));
float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));
float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));
float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));
float xm1=mix(f00,f10,w.x);
float xm2=mix(f01,f11,w.x);
float ym=mix(xm1,xm2,w.y);
return ym;
}
float perlinNoise2D(float x,float y)
{
float sum=0.0;
float frequency=0.0;
float amplitude=0.0;
for(int i=0; i<OCTAVES; i++)
{
frequency=pow(2.0,float(i));
amplitude=pow(persistence,float(i));
sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;
}
return sum;
}

void main(void)
{
float x=abs(vUV.x);
float y=abs(vUV.y);
float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);
gl_FragColor=vec4(noise,noise,noise,1.0);
}
`;qe.a.ShadersStore[xc]=Dc;var ey={name:xc,shader:Dc},Ic=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){i===void 0&&(i=256),r===void 0&&(r=Yt.a.LastCreatedScene);var s=n.call(this,e,i,"noise",r,o,a)||this;return s.time=0,s.brightness=.2,s.octaves=3,s.persistence=.8,s.animationSpeedFactor=1,s.autoClear=!1,s._updateShaderUniforms(),s}return t.prototype._updateShaderUniforms=function(){var e=this.getScene();!e||(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))},t.prototype._getDefines=function(){return"#define OCTAVES "+(this.octaves|0)},t.prototype.render=function(e){this._updateShaderUniforms(),n.prototype.render.call(this,e)},t.prototype.serialize=function(){var e={};return e.customType="BABYLON.NoiseProceduralTexture",e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e},t.prototype.clone=function(){var e=this.getSize(),i=new t(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,i.brightness=this.brightness,i.octaves=this.octaves,i.persistence=this.persistence,i.animationSpeedFactor=this.animationSpeedFactor,i.time=this.time,i},t.Parse=function(e,i){var r,o=new t(e.name,e.size,i,void 0,e.generateMipMaps);return o.brightness=e.brightness,o.octaves=e.octaves,o.persistence=e.persistence,o.animationSpeedFactor=e.animationSpeedFactor,o.time=(r=e.time)!==null&&r!==void 0?r:0,o},t}(Po);f.a.RegisteredTypes["BABYLON.NoiseProceduralTexture"]=Ic;var Kg=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v,b){o===void 0&&(o=5),a===void 0&&(a=0),s===void 0&&(s=!1),c===void 0&&(c=!1),v===void 0&&(v=3),b===void 0&&(b=null);var C=n.call(this,"",e)||this;return C._texture=e.getEngine().createRawCubeTexture(i,r,o,a,s,c,v,b),C}return t.prototype.update=function(e,i,r,o,a){a===void 0&&(a=null),this._texture.getEngine().updateRawCubeTexture(this._texture,e,i,r,o,a)},t.prototype.updateRGBDAsync=function(e,i,r,o){return i===void 0&&(i=null),r===void 0&&(r=.8),o===void 0&&(o=0),t._UpdateRGBDAsync(this._texture,e,i,r,o)},t.prototype.clone=function(){var e=this;return de.a.Clone(function(){var i=e.getScene(),r=e._texture,o=new t(i,r._bufferViewArray,r.width,r.format,r.type,r.generateMipMaps,r.invertY,r.samplingMode,r._compression);return r.source===gt.b.CubeRawRGBD&&o.updateRGBDAsync(r._bufferViewArrayArray,r._sphericalPolynomial,r._lodGenerationScale,r._lodGenerationOffset),o},this)},t._UpdateRGBDAsync=function(e,i,r,o,a){return e._source=gt.b.CubeRawRGBD,e._bufferViewArrayArray=i,e._lodGenerationScale=o,e._lodGenerationOffset=a,e._sphericalPolynomial=r,Wr.UploadLevelsAsync(e,i).then(function(){e.isReady=!0})},t}(pn.a),kr=u(527),Qg=u(631),Zg=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v,b,C){c===void 0&&(c=!0),v===void 0&&(v=!1),b===void 0&&(b=Ze.a.TRILINEAR_SAMPLINGMODE),C===void 0&&(C=0);var M=n.call(this,null,s,!c,v)||this;return M.format=a,M._texture=s.getEngine().createRawTexture3D(e,i,r,o,a,c,v,b,null,C),M.is3D=!0,M}return t.prototype.update=function(e){!this._texture||this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)},t}(Ze.a),Jg=function(n){Object(h.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,i,r,o,!0)||this;return a.refractionPlane=new ce.a(0,1,0,1),a.depth=2,a.onBeforeRenderObservable.add(function(){r.clipPlane=a.refractionPlane}),a.onAfterRenderObservable.add(function(){r.clipPlane=null}),a}return t.prototype.clone=function(){var e=this.getScene();if(!e)return this;var i=this.getSize(),r=new t(this.name,i.width,e,this._generateMipMaps);return r.hasAlpha=this.hasAlpha,r.level=this.level,r.refractionPlane=this.refractionPlane.clone(),this.renderList&&(r.renderList=this.renderList.slice(0)),r.depth=this.depth,r},t.prototype.serialize=function(){if(!this.name)return null;var e=n.prototype.serialize.call(this);return e.mirrorPlane=this.refractionPlane.asArray(),e.depth=this.depth,e},t}(Cr.a),oe;(function(n){n[n.Vertex=1]="Vertex",n[n.Fragment=2]="Fragment",n[n.Neutral=4]="Neutral",n[n.VertexAndFragment=3]="VertexAndFragment"})(oe||(oe={}));var K;(function(n){n[n.Float=1]="Float",n[n.Int=2]="Int",n[n.Vector2=4]="Vector2",n[n.Vector3=8]="Vector3",n[n.Vector4=16]="Vector4",n[n.Color3=32]="Color3",n[n.Color4=64]="Color4",n[n.Matrix=128]="Matrix",n[n.Object=256]="Object",n[n.AutoDetect=1024]="AutoDetect",n[n.BasedOnInput=2048]="BasedOnInput"})(K||(K={}));var Ti;(function(n){n[n.Uniform=0]="Uniform",n[n.Attribute=1]="Attribute",n[n.Varying=2]="Varying",n[n.Undefined=3]="Undefined"})(Ti||(Ti={}));var dt;(function(n){n[n.World=1]="World",n[n.View=2]="View",n[n.Projection=3]="Projection",n[n.ViewProjection=4]="ViewProjection",n[n.WorldView=5]="WorldView",n[n.WorldViewProjection=6]="WorldViewProjection",n[n.CameraPosition=7]="CameraPosition",n[n.FogColor=8]="FogColor",n[n.DeltaTime=9]="DeltaTime"})(dt||(dt={}));var Ki;(function(n){n[n.Material=0]="Material",n[n.PostProcess=1]="PostProcess",n[n.Particle=2]="Particle",n[n.ProceduralTexture=3]="ProceduralTexture"})(Ki||(Ki={}));var _r;(function(n){n[n.Compatible=0]="Compatible",n[n.TypeIncompatible=1]="TypeIncompatible",n[n.TargetIncompatible=2]="TargetIncompatible"})(_r||(_r={}));var Ni;(function(n){n[n.Input=0]="Input",n[n.Output=1]="Output"})(Ni||(Ni={}));var ea=function(){function n(t,e,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=K.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new _.c,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=oe.VertexAndFragment,this._ownerBlock=e,this.name=t,this._direction=i}return n.AreEquivalentTypes=function(t,e){switch(t){case K.Vector3:{if(e===K.Color3)return!0;break}case K.Vector4:{if(e===K.Color4)return!0;break}case K.Color3:{if(e===K.Vector3)return!0;break}case K.Color4:{if(e===K.Vector4)return!0;break}}return!1},Object.defineProperty(n.prototype,"direction",{get:function(){return this._direction},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"associatedVariableName",{get:function(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName},set:function(t){this._associatedVariableName=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"innerType",{get:function(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"type",{get:function(){if(this._type===K.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}return this._type===K.BasedOnInput&&this._typeConnectionSource?this._typeConnectionSource.type:this._type},set:function(t){this._type=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==oe.VertexAndFragment?this._target:this._ownerBlock.target===oe.Fragment?oe.Fragment:oe.Vertex},set:function(t){this._target=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnected",{get:function(){return this.connectedPoint!==null||this.hasEndpoints},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedToInputBlock",{get:function(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectInputBlock",{get:function(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectedPoint",{get:function(){return this._connectedPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ownerBlock",{get:function(){return this._ownerBlock},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sourceBlock",{get:function(){return this._connectedPoint?this._connectedPoint.ownerBlock:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectedBlocks",{get:function(){return this._endpoints.length===0?[]:this._endpoints.map(function(t){return t.ownerBlock})},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"endpoints",{get:function(){return this._endpoints},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasEndpoints",{get:function(){return this._endpoints&&this._endpoints.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedInVertexShader",{get:function(){if(this.target===oe.Vertex)return!0;if(!this.hasEndpoints)return!1;for(var t=0,e=this._endpoints;t<e.length;t++){var i=e[t];if(i.ownerBlock.target===oe.Vertex||i.target===oe.Vertex||(i.ownerBlock.target===oe.Neutral||i.ownerBlock.target===oe.VertexAndFragment)&&i.ownerBlock.outputs.some(function(r){return r.isConnectedInVertexShader}))return!0}return!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedInFragmentShader",{get:function(){if(this.target===oe.Fragment)return!0;if(!this.hasEndpoints)return!1;for(var t=0,e=this._endpoints;t<e.length;t++){var i=e[t];if(i.ownerBlock.target===oe.Fragment||(i.ownerBlock.target===oe.Neutral||i.ownerBlock.target===oe.VertexAndFragment)&&i.ownerBlock.outputs.some(function(r){return r.isConnectedInFragmentShader}))return!0}return!1},enumerable:!1,configurable:!0}),n.prototype.createCustomInputBlock=function(){return null},n.prototype.getClassName=function(){return"NodeMaterialConnectionPoint"},n.prototype.canConnectTo=function(t){return this.checkCompatibilityState(t)===_r.Compatible},n.prototype.checkCompatibilityState=function(t){var e=this._ownerBlock;if(e.target===oe.Fragment){var i=t.ownerBlock;if(i.target===oe.Vertex)return _r.TargetIncompatible;for(var r=0,o=i.outputs;r<o.length;r++){var a=o[r];if(a.isConnectedInVertexShader)return _r.TargetIncompatible}}return this.type!==t.type&&t.innerType!==K.AutoDetect?n.AreEquivalentTypes(this.type,t.type)||t.acceptedConnectionPointTypes&&t.acceptedConnectionPointTypes.indexOf(this.type)!==-1||t._acceptedConnectionPointType&&n.AreEquivalentTypes(t._acceptedConnectionPointType.type,this.type)?_r.Compatible:_r.TypeIncompatible:t.excludedConnectionPointTypes&&t.excludedConnectionPointTypes.indexOf(this.type)!==-1?1:_r.Compatible},n.prototype.connectTo=function(t,e){if(e===void 0&&(e=!1),!e&&!this.canConnectTo(t))throw"Cannot connect these two connectors.";return this._endpoints.push(t),t._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(t),t.onConnectionObservable.notifyObservers(this),this},n.prototype.disconnectFrom=function(t){var e=this._endpoints.indexOf(t);return e===-1?this:(this._endpoints.splice(e,1),t._connectedPoint=null,this._enforceAssociatedVariableName=!1,t._enforceAssociatedVariableName=!1,this)},n.prototype.serialize=function(t){t===void 0&&(t=!0);var e={};return e.name=this.name,e.displayName=this.displayName,t&&this.connectedPoint&&(e.inputName=this.name,e.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,e.targetConnectionName=this.connectedPoint.name,e.isExposedOnFrame=!0,e.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(e.isExposedOnFrame=!0,e.exposedPortPosition=this.exposedPortPosition),e},n.prototype.dispose=function(){this.onConnectionObservable.clear()},n}(),$g=u(761),it=function(){function n(t,e,i,r){e===void 0&&(e=oe.Vertex),i===void 0&&(i=!1),r===void 0&&(r=!1),this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=e,this._originalTargetIsNeutral=e===oe.Neutral,this._isFinalMerger=i,this._isInput=r,this._name=t,this.uniqueId=$g.a.UniqueId}return Object.defineProperty(n.prototype,"name",{get:function(){return this._name},set:function(t){!this.validateBlockName(t)||(this._name=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isUnique",{get:function(){return this._isUnique},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isFinalMerger",{get:function(){return this._isFinalMerger},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isInput",{get:function(){return this._isInput},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buildId",{get:function(){return this._buildId},set:function(t){this._buildId=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return this._target},set:function(t){(this._target&t)==0&&(this._target=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"inputs",{get:function(){return this._inputs},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"outputs",{get:function(){return this._outputs},enumerable:!1,configurable:!0}),n.prototype.getInputByName=function(t){var e=this._inputs.filter(function(i){return i.name===t});return e.length?e[0]:null},n.prototype.getOutputByName=function(t){var e=this._outputs.filter(function(i){return i.name===t});return e.length?e[0]:null},n.prototype.initialize=function(t){},n.prototype.bind=function(t,e,i,r){},n.prototype._declareOutput=function(t,e){return e._getGLType(t.type)+" "+t.associatedVariableName},n.prototype._writeVariable=function(t){var e=t.connectedPoint;return e?""+t.associatedVariableName:"0."},n.prototype._writeFloat=function(t){var e=t.toString();return e.indexOf(".")===-1&&(e+=".0"),""+e},n.prototype.getClassName=function(){return"NodeMaterialBlock"},n.prototype.registerInput=function(t,e,i,r,o){return i===void 0&&(i=!1),o=o!=null?o:new ea(t,this,Ni.Input),o.type=e,o.isOptional=i,r&&(o.target=r),this._inputs.push(o),this},n.prototype.registerOutput=function(t,e,i,r){return r=r!=null?r:new ea(t,this,Ni.Output),r.type=e,i&&(r.target=i),this._outputs.push(r),this},n.prototype.getFirstAvailableInput=function(t){t===void 0&&(t=null);for(var e=0,i=this._inputs;e<i.length;e++){var r=i[e];if(!r.connectedPoint&&(!t||t.type===r.type||r.type===K.AutoDetect))return r}return null},n.prototype.getFirstAvailableOutput=function(t){t===void 0&&(t=null);for(var e=0,i=this._outputs;e<i.length;e++){var r=i[e];if(!t||!t.target||t.target===oe.Neutral||(t.target&r.target)!=0)return r}return null},n.prototype.getSiblingOutput=function(t){var e=this._outputs.indexOf(t);return e===-1||e>=this._outputs.length?null:this._outputs[e+1]},n.prototype.connectTo=function(t,e){if(this._outputs.length!==0){for(var i=e&&e.output?this.getOutputByName(e.output):this.getFirstAvailableOutput(t),r=!0;r;){var o=e&&e.input?t.getInputByName(e.input):t.getFirstAvailableInput(i);if(i&&o&&i.canConnectTo(o))i.connectTo(o),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}},n.prototype._buildBlock=function(t){},n.prototype.updateUniformsAndSamples=function(t,e,i,r){},n.prototype.provideFallbacks=function(t,e){},n.prototype.initializeDefines=function(t,e,i,r){r===void 0&&(r=!1)},n.prototype.prepareDefines=function(t,e,i,r,o){r===void 0&&(r=!1)},n.prototype.autoConfigure=function(t){},n.prototype.replaceRepeatableContent=function(t,e,i,r){},n.prototype.isReady=function(t,e,i,r){return r===void 0&&(r=!1),!0},n.prototype._linkConnectionTypes=function(t,e,i){i===void 0&&(i=!1),i?this._inputs[e]._acceptedConnectionPointType=this._inputs[t]:this._inputs[t]._linkedConnectionSource=this._inputs[e],this._inputs[e]._linkedConnectionSource=this._inputs[t]},n.prototype._processBuild=function(t,e,i,r){t.build(e,r);var o=e._vertexState!=null,a=t._buildTarget===oe.Vertex&&t.target!==oe.VertexAndFragment;if(o&&((t.target&t._buildTarget)==0||(t.target&i.target)==0||this.target!==oe.VertexAndFragment&&a)&&(!t.isInput&&e.target!==t._buildTarget||t.isInput&&t.isAttribute&&!t._noContextSwitch)){var s=i.connectedPoint;e._vertexState._emitVaryingFromString("v_"+s.associatedVariableName,e._getGLType(s.type))&&(e._vertexState.compilationString+="v_"+s.associatedVariableName+" = "+s.associatedVariableName+`;\r
`),i.associatedVariableName="v_"+s.associatedVariableName,i._enforceAssociatedVariableName=!0}},n.prototype.validateBlockName=function(t){for(var e=["position","normal","tangent","particle_positionw","uv","uv2","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"],i=0,r=e;i<r.length;i++){var o=r[i];if(t===o)return!1}return!0},n.prototype.build=function(t,e){if(this._buildId===t.sharedData.buildId)return!0;if(!this.isInput)for(var i=0,r=this._outputs;i<r.length;i++){var o=r[i];o.associatedVariableName||(o.associatedVariableName=t._getFreeVariableName(o.name))}for(var a=0,s=this._inputs;a<s.length;a++){var c=s[a];if(!c.connectedPoint){c.isOptional||t.sharedData.checks.notConnectedNonOptionalInputs.push(c);continue}if(!(this.target!==oe.Neutral&&((c.target&this.target)==0||(c.target&t.target)==0))){var v=c.connectedPoint.ownerBlock;v&&v!==this&&this._processBuild(v,t,c,e)}}if(this._buildId===t.sharedData.buildId)return!0;if(t.sharedData.verbose&&console.log((t.target===oe.Vertex?"Vertex shader":"Fragment shader")+": Building "+this.name+" ["+this.getClassName()+"]"),this.isFinalMerger)switch(t.target){case oe.Vertex:t.sharedData.checks.emitVertex=!0;break;case oe.Fragment:t.sharedData.checks.emitFragment=!0;break}!this.isInput&&t.sharedData.emitComments&&(t.compilationString+=`\r
//`+this.name+`\r
`),this._buildBlock(t),this._buildId=t.sharedData.buildId,this._buildTarget=t.target;for(var b=0,C=this._outputs;b<C.length;b++){var o=C[b];if((o.target&t.target)!=0)for(var M=0,N=o.endpoints;M<N.length;M++){var D=N[M],v=D.ownerBlock;v&&(v.target&t.target)!=0&&e.indexOf(v)!==-1&&this._processBuild(v,t,D,e)}}return!1},n.prototype._inputRename=function(t){return t},n.prototype._outputRename=function(t){return t},n.prototype._dumpPropertiesCode=function(){var t=this._codeVariableName;return t+".visibleInInspector = "+this.visibleInInspector+`;\r
 `+t+".visibleOnFrame = "+this.visibleOnFrame+`;\r
`},n.prototype._dumpCode=function(t,e){e.push(this);var i,r=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=r||this.getClassName()+"_"+this.uniqueId,t.indexOf(this._codeVariableName)!==-1){var o=0;do o++,this._codeVariableName=r+o;while(t.indexOf(this._codeVariableName)!==-1)}t.push(this._codeVariableName),i=`\r
// `+this.getClassName()+`\r
`,this.comments&&(i+="// "+this.comments+`\r
`),i+="var "+this._codeVariableName+" = new BABYLON."+this.getClassName()+'("'+this.name+`");\r
`,i+=this._dumpPropertiesCode();for(var a=0,s=this.inputs;a<s.length;a++){var c=s[a];if(!!c.isConnected){var v=c.connectedPoint,b=v.ownerBlock;e.indexOf(b)===-1&&(i+=b._dumpCode(t,e))}}for(var C=0,M=this.outputs;C<M.length;C++){var N=M[C];if(!!N.hasEndpoints)for(var D=0,V=N.endpoints;D<V.length;D++){var X=V[D],b=X.ownerBlock;b&&e.indexOf(b)===-1&&(i+=b._dumpCode(t,e))}}return i},n.prototype._dumpCodeForOutputConnections=function(t){var e="";if(t.indexOf(this)!==-1)return e;t.push(this);for(var i=0,r=this.inputs;i<r.length;i++){var o=r[i];if(!!o.isConnected){var a=o.connectedPoint,s=a.ownerBlock;e+=s._dumpCodeForOutputConnections(t),e+=s._codeVariableName+"."+s._outputRename(a.name)+".connectTo("+this._codeVariableName+"."+this._inputRename(o.name)+`);\r
`}}return e},n.prototype.clone=function(t,e){e===void 0&&(e="");var i=this.serialize(),r=f.a.GetClass(i.customType);if(r){var o=new r;return o._deserialize(i,t,e),o}return null},n.prototype.serialize=function(){var t={};t.customType="BABYLON."+this.getClassName(),t.id=this.uniqueId,t.name=this.name,t.comments=this.comments,t.visibleInInspector=this.visibleInInspector,t.visibleOnFrame=this.visibleOnFrame,t.target=this.target,t.inputs=[],t.outputs=[];for(var e=0,i=this.inputs;e<i.length;e++){var r=i[e];t.inputs.push(r.serialize())}for(var o=0,a=this.outputs;o<a.length;o++){var s=a[o];t.outputs.push(s.serialize(!1))}return t},n.prototype._deserialize=function(t,e,i){var r;this.name=t.name,this.comments=t.comments,this.visibleInInspector=!!t.visibleInInspector,this.visibleOnFrame=!!t.visibleOnFrame,this._target=(r=t.target)!==null&&r!==void 0?r:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(t)},n.prototype._deserializePortDisplayNamesAndExposedOnFrame=function(t){var e=this,i=t.inputs,r=t.outputs;i&&i.forEach(function(o,a){o.displayName&&(e.inputs[a].displayName=o.displayName),o.isExposedOnFrame&&(e.inputs[a].isExposedOnFrame=o.isExposedOnFrame,e.inputs[a].exposedPortPosition=o.exposedPortPosition)}),r&&r.forEach(function(o,a){o.displayName&&(e.outputs[a].displayName=o.displayName),o.isExposedOnFrame&&(e.outputs[a].isExposedOnFrame=o.isExposedOnFrame,e.outputs[a].exposedPortPosition=o.exposedPortPosition)})},n.prototype.dispose=function(){for(var t=0,e=this.inputs;t<e.length;t++){var i=e[t];i.dispose()}for(var r=0,o=this.outputs;r<o.length;r++){var a=o[r];a.dispose()}},n}(),Lc=function(){function n(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}return n.prototype.finalize=function(t){var e=t.sharedData.emitComments,i=this.target===oe.Fragment;this.compilationString=`\r
`+(e?`//Entry point\r
`:"")+`void main(void) {\r
`+this.compilationString,this._constantDeclaration&&(this.compilationString=`\r
`+(e?`//Constants\r
`:"")+this._constantDeclaration+`\r
`+this.compilationString);var r="";for(var o in this.functions)r+=this.functions[o]+`\r
`;this.compilationString=`\r
`+r+`\r
`+this.compilationString,!i&&this._varyingTransfer&&(this.compilationString=this.compilationString+`\r
`+this._varyingTransfer),this._injectAtEnd&&(this.compilationString=this.compilationString+`\r
`+this._injectAtEnd),this.compilationString=this.compilationString+`\r
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r
`+(e?`//Varyings\r
`:"")+this.sharedData.varyingDeclaration+`\r
`+this.compilationString),this._samplerDeclaration&&(this.compilationString=`\r
`+(e?`//Samplers\r
`:"")+this._samplerDeclaration+`\r
`+this.compilationString),this._uniformDeclaration&&(this.compilationString=`\r
`+(e?`//Uniforms\r
`:"")+this._uniformDeclaration+`\r
`+this.compilationString),this._attributeDeclaration&&!i&&(this.compilationString=`\r
`+(e?`//Attributes\r
`:"")+this._attributeDeclaration+`\r
`+this.compilationString),this.compilationString=`precision highp float;\r
`+this.compilationString;for(var a in this.extensions){var s=this.extensions[a];this.compilationString=`\r
`+s+`\r
`+this.compilationString}this._builtCompilationString=this.compilationString},Object.defineProperty(n.prototype,"_repeatableContentAnchor",{get:function(){return"###___ANCHOR"+this._repeatableContentAnchorIndex+++"___###"},enumerable:!1,configurable:!0}),n.prototype._getFreeVariableName=function(t){return t=t.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[t]===void 0?(this.sharedData.variableNames[t]=0,t==="output"||t==="texture"?t+this.sharedData.variableNames[t]:t):(this.sharedData.variableNames[t]++,t+this.sharedData.variableNames[t])},n.prototype._getFreeDefineName=function(t){return this.sharedData.defineNames[t]===void 0?this.sharedData.defineNames[t]=0:this.sharedData.defineNames[t]++,t+this.sharedData.defineNames[t]},n.prototype._excludeVariableName=function(t){this.sharedData.variableNames[t]=0},n.prototype._emit2DSampler=function(t){this.samplers.indexOf(t)<0&&(this._samplerDeclaration+="uniform sampler2D "+t+`;\r
`,this.samplers.push(t))},n.prototype._getGLType=function(t){switch(t){case K.Float:return"float";case K.Int:return"int";case K.Vector2:return"vec2";case K.Color3:case K.Vector3:return"vec3";case K.Color4:case K.Vector4:return"vec4";case K.Matrix:return"mat4"}return""},n.prototype._emitExtension=function(t,e,i){i===void 0&&(i=""),!this.extensions[t]&&(i&&(e="#if "+i+`\r
`+e+`\r
#endif`),this.extensions[t]=e)},n.prototype._emitFunction=function(t,e,i){this.functions[t]||(this.sharedData.emitComments&&(e=i+`\r
`+e),this.functions[t]=e)},n.prototype._emitCodeFromInclude=function(t,e,i){if(i&&i.repeatKey)return"#include<"+t+">[0.."+i.repeatKey+`]\r
`;var r=qe.a.IncludesShadersStore[t]+`\r
`;if(this.sharedData.emitComments&&(r=e+`\r
`+r),!i)return r;if(i.replaceStrings)for(var o=0;o<i.replaceStrings.length;o++){var a=i.replaceStrings[o];r=r.replace(a.search,a.replace)}return r},n.prototype._emitFunctionFromInclude=function(t,e,i,r){r===void 0&&(r="");var o=t+r;if(!this.functions[o]){if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[o]="#include<"+t+">[0.."+i.repeatKey+`]\r
`:this.functions[o]="#include<"+t+`>\r
`,this.sharedData.emitComments&&(this.functions[o]=e+`\r
`+this.functions[o]);return}if(this.functions[o]=qe.a.IncludesShadersStore[t],this.sharedData.emitComments&&(this.functions[o]=e+`\r
`+this.functions[o]),i.removeIfDef&&(this.functions[o]=this.functions[o].replace(/^\s*?#ifdef.+$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#endif.*$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#else.*$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[o]=this.functions[o].replace(/^\s*?attribute.+$/gm,"")),i.removeUniforms&&(this.functions[o]=this.functions[o].replace(/^\s*?uniform.+$/gm,"")),i.removeVaryings&&(this.functions[o]=this.functions[o].replace(/^\s*?varying.+$/gm,"")),i.replaceStrings)for(var a=0;a<i.replaceStrings.length;a++){var s=i.replaceStrings[a];this.functions[o]=this.functions[o].replace(s.search,s.replace)}}},n.prototype._registerTempVariable=function(t){return this.sharedData.temps.indexOf(t)!==-1?!1:(this.sharedData.temps.push(t),!0)},n.prototype._emitVaryingFromString=function(t,e,i,r){return i===void 0&&(i=""),r===void 0&&(r=!1),this.sharedData.varyings.indexOf(t)!==-1?!1:(this.sharedData.varyings.push(t),i&&(Rr.a.StartsWith(i,"defined(")?this.sharedData.varyingDeclaration+="#if "+i+`\r
`:this.sharedData.varyingDeclaration+=(r?"#ifndef":"#ifdef")+" "+i+`\r
`),this.sharedData.varyingDeclaration+="varying "+e+" "+t+`;\r
`,i&&(this.sharedData.varyingDeclaration+=`#endif\r
`),!0)},n.prototype._emitUniformFromString=function(t,e,i,r){i===void 0&&(i=""),r===void 0&&(r=!1),this.uniforms.indexOf(t)===-1&&(this.uniforms.push(t),i&&(Rr.a.StartsWith(i,"defined(")?this._uniformDeclaration+="#if "+i+`\r
`:this._uniformDeclaration+=(r?"#ifndef":"#ifdef")+" "+i+`\r
`),this._uniformDeclaration+="uniform "+e+" "+t+`;\r
`,i&&(this._uniformDeclaration+=`#endif\r
`))},n.prototype._emitFloat=function(t){return t.toString()===t.toFixed(0)?t+".0":t.toString()},n}(),qg=function(){function n(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}return n.prototype.emitErrors=function(){var t="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(t+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r
`),this.checks.emitFragment||(t+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r
`);for(var e=0,i=this.checks.notConnectedNonOptionalInputs;e<i.length;e++){var r=i[e];t+="input "+r.name+" from block "+r.ownerBlock.name+"["+r.ownerBlock.getClassName()+`] is not connected and is not optional.\r
`}if(t)throw`Build of NodeMaterial failed:\r
`+t},n}(),ta=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Vertex)||this;return i.complementW=1,i.complementZ=0,i.registerInput("vector",K.AutoDetect),i.registerInput("transform",K.Matrix),i.registerOutput("output",K.Vector4),i.registerOutput("xyz",K.Vector3),i._inputs[0].onConnectionObservable.add(function(r){if(r.ownerBlock.isInput){var o=r.ownerBlock;(o.name==="normal"||o.name==="tangent")&&(i.complementW=0)}}),i}return t.prototype.getClassName=function(){return"TransformBlock"},Object.defineProperty(t.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyz",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"transform",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.vector,r=this.transform;if(i.connectedPoint){if(this.complementW===0){var o="//"+this.name;e._emitFunctionFromInclude("helperFunctions",o),e.sharedData.blocksWithDefines.push(this);var a=e._getFreeVariableName(r.associatedVariableName+"_NUS");switch(e.compilationString+="mat3 "+a+" = mat3("+r.associatedVariableName+`);\r
`,e.compilationString+=`#ifdef NONUNIFORMSCALING\r
`,e.compilationString+=a+" = transposeMat3(inverseMat3("+a+`));\r
`,e.compilationString+=`#endif\r
`,i.connectedPoint.type){case K.Vector2:e.compilationString+=this._declareOutput(this.output,e)+(" = vec4("+a+" * vec3("+i.associatedVariableName+", "+this._writeFloat(this.complementZ)+"), "+this._writeFloat(this.complementW)+`);\r
`);break;case K.Vector3:case K.Color3:e.compilationString+=this._declareOutput(this.output,e)+(" = vec4("+a+" * "+i.associatedVariableName+", "+this._writeFloat(this.complementW)+`);\r
`);break;default:e.compilationString+=this._declareOutput(this.output,e)+(" = vec4("+a+" * "+i.associatedVariableName+".xyz, "+this._writeFloat(this.complementW)+`);\r
`);break}}else{var a=r.associatedVariableName;switch(i.connectedPoint.type){case K.Vector2:e.compilationString+=this._declareOutput(this.output,e)+(" = "+a+" * vec4("+i.associatedVariableName+", "+this._writeFloat(this.complementZ)+", "+this._writeFloat(this.complementW)+`);\r
`);break;case K.Vector3:case K.Color3:e.compilationString+=this._declareOutput(this.output,e)+(" = "+a+" * vec4("+i.associatedVariableName+", "+this._writeFloat(this.complementW)+`);\r
`);break;default:e.compilationString+=this._declareOutput(this.output,e)+(" = "+a+" * "+i.associatedVariableName+`;\r
`);break}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+(" = "+this.output.associatedVariableName+`.xyz;\r
`))}return this},t.prototype.prepareDefines=function(e,i,r,o,a){o===void 0&&(o=!1),e.nonUniformScaling&&r.setValue("NONUNIFORMSCALING",!0)},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.complementZ=this.complementZ,e.complementW=this.complementW,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".complementZ = "+this.complementZ+`;\r
`;return e+=this._codeVariableName+".complementW = "+this.complementW+`;\r
`,e},t}(it);f.a.RegisteredTypes["BABYLON.TransformBlock"]=ta;var Co=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Vertex,!0)||this;return i.registerInput("vector",K.Vector4),i}return t.prototype.getClassName=function(){return"VertexOutputBlock"},Object.defineProperty(t.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.vector;return e.compilationString+="gl_Position = "+i.associatedVariableName+`;\r
`,this},t}(it);f.a.RegisteredTypes["BABYLON.VertexOutputBlock"]=Co;var Mt;(function(n){n[n.Boolean=0]="Boolean",n[n.Float=1]="Float",n[n.Vector2=2]="Vector2",n[n.List=3]="List"})(Mt||(Mt={}));function It(n,t,e,i){return t===void 0&&(t=Mt.Boolean),e===void 0&&(e="PROPERTIES"),function(r,o){var a=r._propStore;a||(a=[],r._propStore=a),a.push({propertyName:o,displayName:n,type:t,groupName:e,options:i!=null?i:{}})}}var On=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment,!0)||this;return i.convertToGammaSpace=!1,i.convertToLinearSpace=!1,i.registerInput("rgba",K.Color4,!0),i.registerInput("rgb",K.Color3,!0),i.registerInput("a",K.Float,!0),i.rgb.acceptedConnectionPointTypes.push(K.Float),i}return t.prototype.getClassName=function(){return"FragmentOutputBlock"},Object.defineProperty(t.prototype,"rgba",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),t.prototype.prepareDefines=function(e,i,r){r.setValue(this._linearDefineName,this.convertToLinearSpace,!0),r.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.rgba,r=this.rgb,o=this.a;e.sharedData.hints.needAlphaBlending=i.isConnected||o.isConnected,e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");var a="//"+this.name;if(e._emitFunctionFromInclude("helperFunctions",a),i.connectedPoint)o.isConnected?e.compilationString+="gl_FragColor = vec4("+i.associatedVariableName+".rgb, "+o.associatedVariableName+`);\r
`:e.compilationString+="gl_FragColor = "+i.associatedVariableName+`;\r
`;else if(r.connectedPoint){var s="1.0";o.connectedPoint&&(s=o.associatedVariableName),r.connectedPoint.type===K.Float?e.compilationString+="gl_FragColor = vec4("+r.associatedVariableName+", "+r.associatedVariableName+", "+r.associatedVariableName+", "+s+`);\r
`:e.compilationString+="gl_FragColor = vec4("+r.associatedVariableName+", "+s+`);\r
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(i);return e.compilationString+="#ifdef "+this._linearDefineName+`\r
`,e.compilationString+=`gl_FragColor = toLinearSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef "+this._gammaDefineName+`\r
`,e.compilationString+=`gl_FragColor = toGammaSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,this},t.prototype._dumpPropertiesCode=function(){var e="";return e+=this._codeVariableName+".convertToGammaSpace = "+this.convertToGammaSpace+`;\r
`,e+=this._codeVariableName+".convertToLinearSpace = "+this.convertToLinearSpace+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace},Object(h.c)([It("Convert to gamma space",Mt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],t.prototype,"convertToGammaSpace",void 0),Object(h.c)([It("Convert to linear space",Mt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],t.prototype,"convertToLinearSpace",void 0),t}(it);f.a.RegisteredTypes["BABYLON.FragmentOutputBlock"]=On;var on;(function(n){n[n.None=0]="None",n[n.Time=1]="Time"})(on||(on={}));var em={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Ds={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},Fc={particle_texturemask:!0},yt=function(n){Object(h.d)(t,n);function t(e,i,r){i===void 0&&(i=oe.Vertex),r===void 0&&(r=K.AutoDetect);var o=n.call(this,e,i,!1,!0)||this;return o._mode=Ti.Undefined,o._animationType=on.None,o.min=0,o.max=0,o.isBoolean=!1,o.matrixMode=0,o._systemValue=null,o.isConstant=!1,o.groupInInspector="",o.onValueChangedObservable=new _.c,o.convertToGammaSpace=!1,o.convertToLinearSpace=!1,o._type=r,o.setDefaultValue(),o.registerOutput("output",r),o}return Object.defineProperty(t.prototype,"type",{get:function(){if(this._type===K.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=K.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=K.Vector2,this._type;case"Vector3":return this._type=K.Vector3,this._type;case"Vector4":return this._type=K.Vector4,this._type;case"Color3":return this._type=K.Color3,this._type;case"Color4":return this._type=K.Color4,this._type;case"Matrix":return this._type=K.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"tangent":case"particle_positionw":return this._type=K.Vector3,this._type;case"uv":case"uv2":case"position2d":case"particle_uv":return this._type=K.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"world0":case"world1":case"world2":case"world3":return this._type=K.Vector4,this._type;case"color":case"particle_color":case"particle_texturemask":return this._type=K.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case dt.World:case dt.WorldView:case dt.WorldViewProjection:case dt.View:case dt.ViewProjection:case dt.Projection:return this._type=K.Matrix,this._type;case dt.CameraPosition:return this._type=K.Vector3,this._type;case dt.FogColor:return this._type=K.Color3,this._type;case dt.DeltaTime:return this._type=K.Float,this._type}}return this._type},enumerable:!1,configurable:!0}),t.prototype.validateBlockName=function(e){return this.isAttribute?!0:n.prototype.validateBlockName.call(this,e)},Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.setAsAttribute=function(e){return this._mode=Ti.Attribute,e&&(this.name=e),this},t.prototype.setAsSystemValue=function(e){return this.systemValue=e,this},Object.defineProperty(t.prototype,"value",{get:function(){return this._storedValue},set:function(e){this.type===K.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=Ti.Uniform,this.onValueChangedObservable.notifyObservers(this)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"valueCallback",{get:function(){return this._valueCallback},set:function(e){this._valueCallback=e,this._mode=Ti.Uniform},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"associatedVariableName",{get:function(){return this._associatedVariableName},set:function(e){this._associatedVariableName=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"animationType",{get:function(){return this._animationType},set:function(e){this._animationType=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isUndefined",{get:function(){return this._mode===Ti.Undefined},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isUniform",{get:function(){return this._mode===Ti.Uniform},set:function(e){this._mode=e?Ti.Uniform:Ti.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isAttribute",{get:function(){return this._mode===Ti.Attribute},set:function(e){this._mode=e?Ti.Attribute:Ti.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isVarying",{get:function(){return this._mode===Ti.Varying},set:function(e){this._mode=e?Ti.Varying:Ti.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isSystemValue",{get:function(){return this._systemValue!=null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"systemValue",{get:function(){return this._systemValue},set:function(e){this._mode=Ti.Uniform,this.associatedVariableName="",this._systemValue=e},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"InputBlock"},t.prototype.animate=function(e){switch(this._animationType){case on.Time:{this.type===K.Float&&(this.value+=e.getAnimationRatio()*.01);break}}},t.prototype._emitDefine=function(e){return e[0]==="!"?"#ifndef "+e.substring(1)+`\r
`:"#ifdef "+e+`\r
`},t.prototype.initialize=function(e){this.associatedVariableName=""},t.prototype.setDefaultValue=function(){switch(this.type){case K.Float:this.value=0;break;case K.Vector2:this.value=l.d.Zero();break;case K.Vector3:this.value=l.e.Zero();break;case K.Vector4:this.value=l.f.Zero();break;case K.Color3:this.value=et.e.White();break;case K.Color4:this.value=new et.f(1,1,1,1);break;case K.Matrix:this.value=l.a.Identity();break}},t.prototype._emitConstant=function(e){switch(this.type){case K.Float:return""+e._emitFloat(this.value);case K.Vector2:return"vec2("+this.value.x+", "+this.value.y+")";case K.Vector3:return"vec3("+this.value.x+", "+this.value.y+", "+this.value.z+")";case K.Vector4:return"vec4("+this.value.x+", "+this.value.y+", "+this.value.z+", "+this.value.w+")";case K.Color3:return et.u.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&et.u.Color3[0].toGammaSpaceToRef(et.u.Color3[0]),this.convertToLinearSpace&&et.u.Color3[0].toLinearSpaceToRef(et.u.Color3[0]),"vec3("+et.u.Color3[0].r+", "+et.u.Color3[0].g+", "+et.u.Color3[0].b+")";case K.Color4:return et.u.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&et.u.Color4[0].toGammaSpaceToRef(et.u.Color4[0]),this.convertToLinearSpace&&et.u.Color4[0].toLinearSpaceToRef(et.u.Color4[0]),"vec4("+et.u.Color4[0].r+", "+et.u.Color4[0].g+", "+et.u.Color4[0].b+", "+et.u.Color4[0].a+")"}return""},Object.defineProperty(t.prototype,"_noContextSwitch",{get:function(){return Ds[this.name]},enumerable:!1,configurable:!0}),t.prototype._emit=function(e,i){var r;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=this._declareOutput(this.output,e)+(" = "+this._emitConstant(e)+`;\r
`);return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),i&&(e._uniformDeclaration+=this._emitDefine(i)),e._uniformDeclaration+="uniform "+e._getGLType(this.type)+" "+this.associatedVariableName+`;\r
`,i&&(e._uniformDeclaration+=`#endif\r
`);var o=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case dt.WorldView:o.needWorldViewMatrix=!0;break;case dt.WorldViewProjection:o.needWorldViewProjectionMatrix=!0;break}else this._animationType!==on.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=(r=em[this.name])!==null&&r!==void 0?r:this.name,this.target===oe.Vertex&&e._vertexState){Ds[this.name]?Fc[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),i):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),i):this._emit(e._vertexState,i);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),Ds[this.name]?Fc[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),i):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),i):(i&&(e._attributeDeclaration+=this._emitDefine(i)),e._attributeDeclaration+="attribute "+e._getGLType(this.type)+" "+this.associatedVariableName+`;\r
`,i&&(e._attributeDeclaration+=`#endif\r
`))}},t.prototype._transmitWorld=function(e,i,r,o){if(!!this._systemValue){var a=this.associatedVariableName;switch(this._systemValue){case dt.World:e.setMatrix(a,i);break;case dt.WorldView:e.setMatrix(a,r);break;case dt.WorldViewProjection:e.setMatrix(a,o);break}}},t.prototype._transmit=function(e,i){if(!this.isAttribute){var r=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case dt.World:case dt.WorldView:case dt.WorldViewProjection:return;case dt.View:e.setMatrix(r,i.getViewMatrix());break;case dt.Projection:e.setMatrix(r,i.getProjectionMatrix());break;case dt.ViewProjection:e.setMatrix(r,i.getTransformMatrix());break;case dt.CameraPosition:Ot.a.BindEyePosition(e,i,r,!0);break;case dt.FogColor:e.setColor3(r,i.fogColor);break;case dt.DeltaTime:e.setFloat(r,i.deltaTime/1e3)}return}var o=this._valueCallback?this._valueCallback():this._storedValue;if(o!==null)switch(this.type){case K.Float:e.setFloat(r,o);break;case K.Int:e.setInt(r,o);break;case K.Color3:et.u.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&et.u.Color3[0].toGammaSpaceToRef(et.u.Color3[0]),this.convertToLinearSpace&&et.u.Color3[0].toLinearSpaceToRef(et.u.Color3[0]),e.setColor3(r,et.u.Color3[0]);break;case K.Color4:et.u.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&et.u.Color4[0].toGammaSpaceToRef(et.u.Color4[0]),this.convertToLinearSpace&&et.u.Color4[0].toLinearSpaceToRef(et.u.Color4[0]),e.setDirectColor4(r,et.u.Color4[0]);break;case K.Vector2:e.setVector2(r,o);break;case K.Vector3:e.setVector3(r,o);break;case K.Vector4:e.setVector4(r,o);break;case K.Matrix:e.setMatrix(r,o);break}}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName;if(this.isAttribute)return e+'.setAsAttribute("'+this.name+`");\r
`;if(this.isSystemValue)return e+".setAsSystemValue(BABYLON.NodeMaterialSystemValues."+dt[this._systemValue]+`);\r
`;if(this.isUniform){var i=[],r="";switch(this.type){case K.Float:r=""+this.value;break;case K.Vector2:r="new BABYLON.Vector2("+this.value.x+", "+this.value.y+")";break;case K.Vector3:r="new BABYLON.Vector3("+this.value.x+", "+this.value.y+", "+this.value.z+")";break;case K.Vector4:r="new BABYLON.Vector4("+this.value.x+", "+this.value.y+", "+this.value.z+", "+this.value.w+")";break;case K.Color3:r="new BABYLON.Color3("+this.value.r+", "+this.value.g+", "+this.value.b+")",this.convertToGammaSpace&&(r+=".toGammaSpace()"),this.convertToLinearSpace&&(r+=".toLinearSpace()");break;case K.Color4:r="new BABYLON.Color4("+this.value.r+", "+this.value.g+", "+this.value.b+", "+this.value.a+")",this.convertToGammaSpace&&(r+=".toGammaSpace()"),this.convertToLinearSpace&&(r+=".toLinearSpace()");break;case K.Matrix:r="BABYLON.Matrix.FromArray(["+this.value.m+"])";break}return i.push(e+".value = "+r),this.type===K.Float&&i.push(e+".min = "+this.min,e+".max = "+this.max,e+".isBoolean = "+this.isBoolean,e+".matrixMode = "+this.matrixMode,e+".animationType = BABYLON.AnimatedInputBlockTypes."+on[this.animationType]),i.push(e+".isConstant = "+this.isConstant),i.push(""),i.join(`;\r
`)}return""},t.prototype.dispose=function(){this.onValueChangedObservable.clear(),n.prototype.dispose.call(this)},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===Ti.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e},t.prototype._deserialize=function(e,i,r){if(this._mode=e.mode,n.prototype._deserialize.call(this,e,i,r),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{var o=f.a.GetClass(e.valueType);o&&(this._storedValue=o.FromArray(e.value))}},t}(it);f.a.RegisteredTypes["BABYLON.InputBlock"]=yt;var Is=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.VertexAndFragment)||this;return i._samplerName="textureSampler",i.convertToGammaSpace=!1,i.convertToLinearSpace=!1,i._isUnique=!1,i.registerInput("uv",K.Vector2,!1,oe.VertexAndFragment),i.registerOutput("rgba",K.Color4,oe.Neutral),i.registerOutput("rgb",K.Color3,oe.Neutral),i.registerOutput("r",K.Float,oe.Neutral),i.registerOutput("g",K.Float,oe.Neutral),i.registerOutput("b",K.Float,oe.Neutral),i.registerOutput("a",K.Float,oe.Neutral),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),i._inputs[0]._prioritizeVertex=!1,i}return t.prototype.getClassName=function(){return"CurrentScreenBlock"},Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("textureSampler")},Object.defineProperty(t.prototype,"target",{get:function(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?oe.VertexAndFragment:oe.Fragment},enumerable:!1,configurable:!0}),t.prototype.prepareDefines=function(e,i,r){r.setValue(this._linearDefineName,this.convertToGammaSpace,!0),r.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)},t.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},t.prototype._injectVertexCode=function(e){var i=this.uv;if(i.connectedPoint.ownerBlock.isInput){var r=i.connectedPoint.ownerBlock;r.isAttribute||e._emitUniformFromString(i.associatedVariableName,"vec2")}if(this._mainUVName="vMain"+i.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=this._mainUVName+" = "+i.associatedVariableName+`.xy;\r
`,!!this._outputs.some(function(c){return c.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&this._writeOutput(e,s,s.name,!0)}}},t.prototype._writeTextureRead=function(e,i){i===void 0&&(i=!1);var r=this.uv;if(i){if(e.target===oe.Fragment)return;e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+r.associatedVariableName+`);\r
`;return}if(this.uv.ownerBlock.target===oe.Fragment){e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+r.associatedVariableName+`);\r
`;return}e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+this._mainUVName+`);\r
`},t.prototype._writeOutput=function(e,i,r,o){if(o===void 0&&(o=!1),o){if(e.target===oe.Fragment)return;e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`;return}if(this.uv.ownerBlock.target===oe.Fragment){e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`;return}e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`,e.compilationString+="#ifdef "+this._linearDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toGammaSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef "+this._gammaDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toLinearSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==oe.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!!this._outputs.some(function(s){return s.isConnectedInFragmentShader})){e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");var i="//"+this.name;e._emitFunctionFromInclude("helperFunctions",i),this._writeTextureRead(e);for(var r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&this._writeOutput(e,a,a.name)}return this}},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(r=e.texture.url.indexOf("data:")===0?"":r,this.texture=Ze.a.Parse(e.texture,i,r))},t}(it);f.a.RegisteredTypes["BABYLON.CurrentScreenBlock"]=Is;var Ls=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i._samplerName="diffuseSampler",i.convertToGammaSpace=!1,i.convertToLinearSpace=!1,i._isUnique=!1,i.registerInput("uv",K.Vector2,!1,oe.VertexAndFragment),i.registerOutput("rgba",K.Color4,oe.Neutral),i.registerOutput("rgb",K.Color3,oe.Neutral),i.registerOutput("r",K.Float,oe.Neutral),i.registerOutput("g",K.Float,oe.Neutral),i.registerOutput("b",K.Float,oe.Neutral),i.registerOutput("a",K.Float,oe.Neutral),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),i}return t.prototype.getClassName=function(){return"ParticleTextureBlock"},Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("diffuseSampler")},t.prototype.autoConfigure=function(e){if(!this.uv.isConnected){var i=e.getInputBlockByPredicate(function(r){return r.isAttribute&&r.name==="particle_uv"});i||(i=new yt("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}},t.prototype.prepareDefines=function(e,i,r){r.setValue(this._linearDefineName,this.convertToGammaSpace,!0),r.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)},t.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},t.prototype._writeOutput=function(e,i,r){e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`,e.compilationString+="#ifdef "+this._linearDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toGammaSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef "+this._gammaDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toLinearSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==oe.Vertex){this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");var i="//"+this.name;e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+this.uv.associatedVariableName+`);\r
`;for(var r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&this._writeOutput(e,a,a.name)}return this}},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(r=e.texture.url.indexOf("data:")===0?"":r,this.texture=Ze.a.Parse(e.texture,i,r))},t}(it);f.a.RegisteredTypes["BABYLON.ParticleTextureBlock"]=Ls;var Fs=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i._isUnique=!0,i.registerInput("color",K.Color4,!1,oe.Fragment),i.registerOutput("rampColor",K.Color4,oe.Fragment),i}return t.prototype.getClassName=function(){return"ParticleRampGradientBlock"},Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rampColor",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==oe.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                vec4 baseColor = `+this.color.associatedVariableName+`;
                float alpha = `+this.color.associatedVariableName+`.a;

                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));
                baseColor.rgb *= rampColor.rgb;

                // Remapped alpha
                float finalAlpha = baseColor.a;
                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);

                `+this._declareOutput(this.rampColor,e)+` = baseColor;
            #else
                `+this._declareOutput(this.rampColor,e)+" = "+this.color.associatedVariableName+`;
            #endif
        `,this},t}(it);f.a.RegisteredTypes["BABYLON.ParticleRampGradientBlock"]=Fs;var Bs=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i._isUnique=!0,i.registerInput("color",K.Color4,!1,oe.Fragment),i.registerInput("alphaTexture",K.Float,!1,oe.Fragment),i.registerInput("alphaColor",K.Float,!1,oe.Fragment),i.registerOutput("blendColor",K.Color4,oe.Fragment),i}return t.prototype.getClassName=function(){return"ParticleBlendMultiplyBlock"},Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"alphaTexture",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"alphaColor",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blendColor",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("sourceAlpha")},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==oe.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                `+this._declareOutput(this.blendColor,e)+`;
                float sourceAlpha = `+this.alphaColor.associatedVariableName+" * "+this.alphaTexture.associatedVariableName+`;
                `+this.blendColor.associatedVariableName+".rgb = "+this.color.associatedVariableName+`.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);
                `+this.blendColor.associatedVariableName+".a = "+this.color.associatedVariableName+`.a;
            #else
                `+this._declareOutput(this.blendColor,e)+" = "+this.color.associatedVariableName+`;
            #endif
        `,this},t}(it);f.a.RegisteredTypes["BABYLON.ParticleBlendMultiplyBlock"]=Bs;var So=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("xyz ",K.Vector3,!0),i.registerInput("xy ",K.Vector2,!0),i.registerInput("x",K.Float,!0),i.registerInput("y",K.Float,!0),i.registerInput("z",K.Float,!0),i.registerInput("w",K.Float,!0),i.registerOutput("xyzw",K.Vector4),i.registerOutput("xyz",K.Vector3),i.registerOutput("xy",K.Vector2),i}return t.prototype.getClassName=function(){return"VectorMergerBlock"},Object.defineProperty(t.prototype,"xyzIn",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"w",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzw",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyOut",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xy",{get:function(){return this.xyOut},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyz",{get:function(){return this.xyzOut},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.x,r=this.y,o=this.z,a=this.w,s=this.xyIn,c=this.xyzIn,v=this._outputs[0],b=this._outputs[1],C=this._outputs[2];return c.isConnected?v.hasEndpoints?e.compilationString+=this._declareOutput(v,e)+(" = vec4("+c.associatedVariableName+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):b.hasEndpoints?e.compilationString+=this._declareOutput(b,e)+(" = "+c.associatedVariableName+`;\r
`):C.hasEndpoints&&(e.compilationString+=this._declareOutput(C,e)+(" = "+c.associatedVariableName+`.xy;\r
`)):s.isConnected?v.hasEndpoints?e.compilationString+=this._declareOutput(v,e)+(" = vec4("+s.associatedVariableName+", "+(o.isConnected?this._writeVariable(o):"0.0")+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):b.hasEndpoints?e.compilationString+=this._declareOutput(b,e)+(" = vec3("+s.associatedVariableName+", "+(o.isConnected?this._writeVariable(o):"0.0")+`);\r
`):C.hasEndpoints&&(e.compilationString+=this._declareOutput(C,e)+(" = "+s.associatedVariableName+`;\r
`)):v.hasEndpoints?e.compilationString+=this._declareOutput(v,e)+(" = vec4("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+", "+(o.isConnected?this._writeVariable(o):"0.0")+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):b.hasEndpoints?e.compilationString+=this._declareOutput(b,e)+(" = vec3("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+", "+(o.isConnected?this._writeVariable(o):"0.0")+`);\r
`):C.hasEndpoints&&(e.compilationString+=this._declareOutput(C,e)+(" = vec2("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+`);\r
`)),this},t}(it);f.a.RegisteredTypes["BABYLON.VectorMergerBlock"]=So;var Ns=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.sourceRange=new l.d(-1,1),i.targetRange=new l.d(0,1),i.registerInput("input",K.AutoDetect),i.registerInput("sourceMin",K.Float,!0),i.registerInput("sourceMax",K.Float,!0),i.registerInput("targetMin",K.Float,!0),i.registerInput("targetMax",K.Float,!0),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"RemapBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sourceMin",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sourceMax",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"targetMin",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"targetMax",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),o=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),a=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),s=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(i,e)+(" = "+a+" + ("+this._inputs[0].associatedVariableName+" - "+r+") * ("+s+" - "+a+") / ("+o+" - "+r+`);\r
`),this},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".sourceRange = new BABYLON.Vector2("+this.sourceRange.x+", "+this.sourceRange.y+`);\r
`;return e+=this._codeVariableName+".targetRange = new BABYLON.Vector2("+this.targetRange.x+", "+this.targetRange.y+`);\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.sourceRange=l.d.FromArray(e.sourceRange),this.targetRange=l.d.FromArray(e.targetRange)},Object(h.c)([It("From",Mt.Vector2)],t.prototype,"sourceRange",void 0),Object(h.c)([It("To",Mt.Vector2)],t.prototype,"targetRange",void 0),t}(it);f.a.RegisteredTypes["BABYLON.RemapBlock"]=Ns;var ia=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"MultiplyBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.left.associatedVariableName+" * "+this.right.associatedVariableName+`;\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.MultiplyBlock"]=ia;var Mn=function(){function n(){this.direction1=new l.e(0,1,0),this.direction2=new l.e(0,1,0),this.minEmitBox=new l.e(-.5,-.5,-.5),this.maxEmitBox=new l.e(.5,.5,.5)}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);if(r){e.x=o,e.y=a,e.z=s;return}l.e.TransformNormalFromFloatsToRef(o,a,s,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=$e.a.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),a=$e.a.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),s=$e.a.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(r){e.x=o,e.y=a,e.z=s;return}l.e.TransformCoordinatesFromFloatsToRef(o,a,s,t,e)},n.prototype.clone=function(){var t=new n;return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2),t.setVector3("minEmitBox",this.minEmitBox),t.setVector3("maxEmitBox",this.maxEmitBox)},n.prototype.getEffectDefines=function(){return"#define BOXEMITTER"},n.prototype.getClassName=function(){return"BoxParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.minEmitBox=this.minEmitBox.asArray(),t.maxEmitBox=this.maxEmitBox.asArray(),t},n.prototype.parse=function(t){l.e.FromArrayToRef(t.direction1,0,this.direction1),l.e.FromArrayToRef(t.direction2,0,this.direction2),l.e.FromArrayToRef(t.minEmitBox,0,this.minEmitBox),l.e.FromArrayToRef(t.maxEmitBox,0,this.maxEmitBox)},n}(),ws=function(){function n(t,e,i){t===void 0&&(t=1),e===void 0&&(e=Math.PI),i===void 0&&(i=0),this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=e,this.radius=t}return Object.defineProperty(n.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this._buildHeight()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t,this._buildHeight()},enumerable:!1,configurable:!0}),n.prototype._buildHeight=function(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1},n.prototype.startDirectionFunction=function(t,e,i,r){r?l.c.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(t.getTranslation(),l.c.Vector3[0]).normalize();var o=$e.a.RandomRange(0,this.directionRandomizer),a=$e.a.RandomRange(0,this.directionRandomizer),s=$e.a.RandomRange(0,this.directionRandomizer);e.x=l.c.Vector3[0].x+o,e.y=l.c.Vector3[0].y+a,e.z=l.c.Vector3[0].z+s,e.normalize()},n.prototype.startPositionFunction=function(t,e,i,r){var o=$e.a.RandomRange(0,Math.PI*2),a;this.emitFromSpawnPointOnly?a=1e-4:(a=$e.a.RandomRange(0,this.heightRange),a=1-a*a);var s=this._radius-$e.a.RandomRange(0,this._radius*this.radiusRange);s=s*a;var c=s*Math.sin(o),v=s*Math.cos(o),b=a*this._height;if(r){e.x=c,e.y=b,e.z=v;return}l.e.TransformCoordinatesFromFloatsToRef(c,b,v,t,e)},n.prototype.clone=function(){var t=new n(this._radius,this._angle,this.directionRandomizer);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setFloat2("radius",this._radius,this.radiusRange),t.setFloat("coneAngle",this._angle),t.setFloat2("height",this._height,this.heightRange),t.setFloat("directionRandomizer",this.directionRandomizer)},n.prototype.getEffectDefines=function(){var t="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(t+=`
#define CONEEMITTERSPAWNPOINT`),t},n.prototype.getClassName=function(){return"ConeParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this._radius,t.angle=this._angle,t.directionRandomizer=this.directionRandomizer,t.radiusRange=this.radiusRange,t.heightRange=this.heightRange,t.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,t},n.prototype.parse=function(t){this.radius=t.radius,this.angle=t.angle,this.directionRandomizer=t.directionRandomizer,this.radiusRange=t.radiusRange!==void 0?t.radiusRange:1,this.heightRange=t.radiusRange!==void 0?t.heightRange:1,this.emitFromSpawnPointOnly=t.emitFromSpawnPointOnly!==void 0?t.emitFromSpawnPointOnly:!1},n}(),ra=function(){function n(t,e,i,r){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=0),this.radius=t,this.height=e,this.radiusRange=i,this.directionRandomizer=r}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=i.position.subtract(t.getTranslation()).normalize(),a=$e.a.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2),s=Math.atan2(o.x,o.z);if(s+=$e.a.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,o.y=a,o.x=Math.sin(s),o.z=Math.cos(s),o.normalize(),r){e.copyFrom(o);return}l.e.TransformNormalFromFloatsToRef(o.x,o.y,o.z,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=$e.a.RandomRange(-this.height/2,this.height/2),a=$e.a.RandomRange(0,2*Math.PI),s=$e.a.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),c=Math.sqrt(s)*this.radius,v=c*Math.cos(a),b=c*Math.sin(a);if(r){e.copyFromFloats(v,o,b);return}l.e.TransformCoordinatesFromFloatsToRef(v,o,b,t,e)},n.prototype.clone=function(){var t=new n(this.radius,this.directionRandomizer);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},n.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER"},n.prototype.getClassName=function(){return"CylinderParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.height=this.height,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},n.prototype.parse=function(t){this.radius=t.radius,this.height=t.height,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},n}(),Vs=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=1),o===void 0&&(o=new l.e(0,1,0)),a===void 0&&(a=new l.e(0,1,0));var s=n.call(this,e,i,r)||this;return s.direction1=o,s.direction2=a,s}return t.prototype.startDirectionFunction=function(e,i,r){var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);l.e.TransformNormalFromFloatsToRef(o,a,s,e,i)},t.prototype.clone=function(){var e=new t(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return vr.a.DeepCopy(this,e),e},t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},t.prototype.getEffectDefines=function(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`},t.prototype.getClassName=function(){return"CylinderDirectedParticleEmitter"},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},t.prototype.parse=function(e){n.prototype.parse.call(this,e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)},t}(ra),Us=function(){function n(t,e,i){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=0),this.radius=t,this.radiusRange=e,this.directionRandomizer=i}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=i.position.subtract(t.getTranslation()).normalize(),a=$e.a.RandomRange(0,this.directionRandomizer),s=$e.a.RandomRange(0,this.directionRandomizer),c=$e.a.RandomRange(0,this.directionRandomizer);if(o.x+=a,o.y+=s,o.z+=c,o.normalize(),r){e.copyFrom(o);return}l.e.TransformNormalFromFloatsToRef(o.x,o.y,o.z,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=this.radius-$e.a.RandomRange(0,this.radius*this.radiusRange),a=$e.a.RandomRange(0,1),s=$e.a.RandomRange(0,2*Math.PI),c=Math.acos(2*a-1),v=o*Math.cos(s)*Math.sin(c),b=o*Math.cos(c),C=o*Math.sin(s)*Math.sin(c);if(r){e.copyFromFloats(v,Math.abs(b),C);return}l.e.TransformCoordinatesFromFloatsToRef(v,Math.abs(b),C,t,e)},n.prototype.clone=function(){var t=new n(this.radius,this.directionRandomizer);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},n.prototype.getEffectDefines=function(){return"#define HEMISPHERICEMITTER"},n.prototype.getClassName=function(){return"HemisphericParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},n.prototype.parse=function(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},n}(),Gs=function(){function n(){this.direction1=new l.e(0,1,0),this.direction2=new l.e(0,1,0)}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);if(r){e.copyFromFloats(o,a,s);return}l.e.TransformNormalFromFloatsToRef(o,a,s,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){if(r){e.copyFromFloats(0,0,0);return}l.e.TransformCoordinatesFromFloatsToRef(0,0,0,t,e)},n.prototype.clone=function(){var t=new n;return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},n.prototype.getEffectDefines=function(){return"#define POINTEMITTER"},n.prototype.getClassName=function(){return"PointParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},n.prototype.parse=function(t){l.e.FromArrayToRef(t.direction1,0,this.direction1),l.e.FromArrayToRef(t.direction2,0,this.direction2)},n}(),na=function(){function n(t,e,i){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=0),this.radius=t,this.radiusRange=e,this.directionRandomizer=i}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=i.position.subtract(t.getTranslation()).normalize(),a=$e.a.RandomRange(0,this.directionRandomizer),s=$e.a.RandomRange(0,this.directionRandomizer),c=$e.a.RandomRange(0,this.directionRandomizer);if(o.x+=a,o.y+=s,o.z+=c,o.normalize(),r){e.copyFrom(o);return}l.e.TransformNormalFromFloatsToRef(o.x,o.y,o.z,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=this.radius-$e.a.RandomRange(0,this.radius*this.radiusRange),a=$e.a.RandomRange(0,1),s=$e.a.RandomRange(0,2*Math.PI),c=Math.acos(2*a-1),v=o*Math.cos(s)*Math.sin(c),b=o*Math.cos(c),C=o*Math.sin(s)*Math.sin(c);if(r){e.copyFromFloats(v,b,C);return}l.e.TransformCoordinatesFromFloatsToRef(v,b,C,t,e)},n.prototype.clone=function(){var t=new n(this.radius,this.directionRandomizer);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},n.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER"},n.prototype.getClassName=function(){return"SphereParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},n.prototype.parse=function(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},n}(),zs=function(n){Object(h.d)(t,n);function t(e,i,r){e===void 0&&(e=1),i===void 0&&(i=new l.e(0,1,0)),r===void 0&&(r=new l.e(0,1,0));var o=n.call(this,e)||this;return o.direction1=i,o.direction2=r,o}return t.prototype.startDirectionFunction=function(e,i,r){var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);l.e.TransformNormalFromFloatsToRef(o,a,s,e,i)},t.prototype.clone=function(){var e=new t(this.radius,this.direction1,this.direction2);return vr.a.DeepCopy(this,e),e},t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},t.prototype.getEffectDefines=function(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`},t.prototype.getClassName=function(){return"SphereDirectedParticleEmitter"},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},t.prototype.parse=function(e){n.prototype.parse.call(this,e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)},t}(na),xn=function(){function n(){this.particlePositionGenerator=function(){},this.particleDestinationGenerator=function(){}}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=l.c.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,o);var a=l.c.Vector3[1];o.subtractToRef(i.position,a),a.scaleToRef(1/i.lifeTime,o)}else o.set(0,0,0);if(r){e.copyFrom(o);return}l.e.TransformNormalToRef(o,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=l.c.Vector3[0];if(this.particlePositionGenerator?this.particlePositionGenerator(-1,i,o):o.set(0,0,0),r){e.copyFrom(o);return}l.e.TransformCoordinatesToRef(o,t,e)},n.prototype.clone=function(){var t=new n;return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){},n.prototype.getEffectDefines=function(){return"#define CUSTOMEMITTER"},n.prototype.getClassName=function(){return"CustomParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t},n.prototype.parse=function(t){},n}(),Bc=function(){function n(t){t===void 0&&(t=null),this._indices=null,this._positions=null,this._normals=null,this._storedNormal=l.e.Zero(),this._mesh=null,this.direction1=new l.e(0,1,0),this.direction2=new l.e(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=t}return Object.defineProperty(n.prototype,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh!==t&&(this._mesh=t,t?(this._indices=t.getIndices(),this._positions=t.getVerticesData(Oe.b.PositionKind),this._normals=t.getVerticesData(Oe.b.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))},enumerable:!1,configurable:!0}),n.prototype.startDirectionFunction=function(t,e,i,r){if(this.useMeshNormalsForDirection&&this._normals){l.e.TransformNormalToRef(this._storedNormal,t,e);return}var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);if(r){e.copyFromFloats(o,a,s);return}l.e.TransformNormalFromFloatsToRef(o,a,s,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){if(!(!this._indices||!this._positions)){var o=3*Math.random()*(this._indices.length/3)|0,a=Math.random(),s=Math.random()*(1-a),c=1-a-s,v=this._indices[o],b=this._indices[o+1],C=this._indices[o+2],M=l.c.Vector3[0],N=l.c.Vector3[1],D=l.c.Vector3[2],V=l.c.Vector3[3];l.e.FromArrayToRef(this._positions,v*3,M),l.e.FromArrayToRef(this._positions,b*3,N),l.e.FromArrayToRef(this._positions,C*3,D),V.x=a*M.x+s*N.x+c*D.x,V.y=a*M.y+s*N.y+c*D.y,V.z=a*M.z+s*N.z+c*D.z,r?e.copyFromFloats(V.x,V.y,V.z):l.e.TransformCoordinatesFromFloatsToRef(V.x,V.y,V.z,t,e),this.useMeshNormalsForDirection&&this._normals&&(l.e.FromArrayToRef(this._normals,v*3,M),l.e.FromArrayToRef(this._normals,b*3,N),l.e.FromArrayToRef(this._normals,C*3,D),this._storedNormal.x=a*M.x+s*N.x+c*D.x,this._storedNormal.y=a*M.y+s*N.y+c*D.y,this._storedNormal.z=a*M.z+s*N.z+c*D.z)}},n.prototype.clone=function(){var t=new n(this.mesh);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},n.prototype.getEffectDefines=function(){return""},n.prototype.getClassName=function(){return"MeshParticleEmitter"},n.prototype.serialize=function(){var t,e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=(t=this.mesh)===null||t===void 0?void 0:t.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e},n.prototype.parse=function(t,e){l.e.FromArrayToRef(t.direction1,0,this.direction1),l.e.FromArrayToRef(t.direction2,0,this.direction2),t.meshId&&e&&(this.mesh=e.getLastMeshByID(t.meshId)),this.useMeshNormalsForDirection=t.useMeshNormalsForDirection},n}(),To=function(){function n(t){this.animations=[],this.renderingGroupId=0,this.emitter=l.e.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._rootUrl="",this.noiseStrength=new l.e(10,10,10),this.onAnimationEnd=null,this.blendMode=n.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteRandomStartCell=!1,this.translationPivot=new l.d(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new l.e(0,0,0),this.gravity=l.e.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new m.b(1,1,1,1),this.color2=new m.b(1,1,1,1),this.colorDead=new m.b(0,0,0,1),this.textureMask=new m.b(1,1,1,1),this._isSubEmitter=!1,this.billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new mr.b,this.id=t,this.name=t}return Object.defineProperty(n.prototype,"noiseTexture",{get:function(){return this._noiseTexture},set:function(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},set:function(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())},enumerable:!1,configurable:!0}),n.prototype.getScene=function(){return this._scene},n.prototype._hasTargetStopDurationDependantGradient=function(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0},n.prototype.getDragGradients=function(){return this._dragGradients},n.prototype.getLimitVelocityGradients=function(){return this._limitVelocityGradients},n.prototype.getColorGradients=function(){return this._colorGradients},n.prototype.getSizeGradients=function(){return this._sizeGradients},n.prototype.getColorRemapGradients=function(){return this._colorRemapGradients},n.prototype.getAlphaRemapGradients=function(){return this._alphaRemapGradients},n.prototype.getLifeTimeGradients=function(){return this._lifeTimeGradients},n.prototype.getAngularSpeedGradients=function(){return this._angularSpeedGradients},n.prototype.getVelocityGradients=function(){return this._velocityGradients},n.prototype.getStartSizeGradients=function(){return this._startSizeGradients},n.prototype.getEmitRateGradients=function(){return this._emitRateGradients},Object.defineProperty(n.prototype,"direction1",{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:l.e.Zero()},set:function(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"direction2",{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:l.e.Zero()},set:function(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"minEmitBox",{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:l.e.Zero()},set:function(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"maxEmitBox",{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:l.e.Zero()},set:function(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isBillboardBased",{get:function(){return this._isBillboardBased},set:function(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t)},enumerable:!1,configurable:!0}),n.prototype._attachImageProcessingConfiguration=function(t){t!==this._imageProcessingConfiguration&&(!t&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=t)},n.prototype._reset=function(){},n.prototype._removeGradientAndTexture=function(t,e,i){if(!e)return this;for(var r=0,o=0,a=e;o<a.length;o++){var s=a[o];if(s.gradient===t){e.splice(r,1);break}r++}return i&&i.dispose(),this},n.prototype.createPointEmitter=function(t,e){var i=new Gs;return i.direction1=t,i.direction2=e,this.particleEmitterType=i,i},n.prototype.createHemisphericEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=1);var i=new Us(t,e);return this.particleEmitterType=i,i},n.prototype.createSphereEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=1);var i=new na(t,e);return this.particleEmitterType=i,i},n.prototype.createDirectedSphereEmitter=function(t,e,i){t===void 0&&(t=1),e===void 0&&(e=new l.e(0,1,0)),i===void 0&&(i=new l.e(0,1,0));var r=new zs(t,e,i);return this.particleEmitterType=r,r},n.prototype.createCylinderEmitter=function(t,e,i,r){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=0);var o=new ra(t,e,i,r);return this.particleEmitterType=o,o},n.prototype.createDirectedCylinderEmitter=function(t,e,i,r,o){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=new l.e(0,1,0)),o===void 0&&(o=new l.e(0,1,0));var a=new Vs(t,e,i,r,o);return this.particleEmitterType=a,a},n.prototype.createConeEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=Math.PI/4);var i=new ws(t,e);return this.particleEmitterType=i,i},n.prototype.createBoxEmitter=function(t,e,i,r){var o=new Mn;return this.particleEmitterType=o,this.direction1=t,this.direction2=e,this.minEmitBox=i,this.maxEmitBox=r,o},n.BLENDMODE_ONEONE=0,n.BLENDMODE_STANDARD=1,n.BLENDMODE_ADD=2,n.BLENDMODE_MULTIPLY=3,n.BLENDMODE_MULTIPLYADD=4,n}(),js=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("rgba",K.Color4,!0),i.registerInput("rgb ",K.Color3,!0),i.registerOutput("rgb",K.Color3),i.registerOutput("r",K.Float),i.registerOutput("g",K.Float),i.registerOutput("b",K.Float),i.registerOutput("a",K.Float),i.inputsAreExclusive=!0,i}return t.prototype.getClassName=function(){return"ColorSplitterBlock"},Object.defineProperty(t.prototype,"rgba",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgbIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgbOut",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),t.prototype._inputRename=function(e){return e==="rgb "?"rgbIn":e},t.prototype._outputRename=function(e){return e==="rgb"?"rgbOut":e},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.rgba.isConnected?this.rgba:this.rgbIn;if(!!i.isConnected){var r=this._outputs[0],o=this._outputs[1],a=this._outputs[2],s=this._outputs[3],c=this._outputs[4];return r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+(" = "+i.associatedVariableName+`.rgb;\r
`)),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+(" = "+i.associatedVariableName+`.r;\r
`)),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+(" = "+i.associatedVariableName+`.g;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+(" = "+i.associatedVariableName+`.b;\r
`)),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+(" = "+i.associatedVariableName+`.a;\r
`)),this}},t}(it);f.a.RegisteredTypes["BABYLON.ColorSplitterBlock"]=js;var Nc=u(760),ni;(function(n){n[n.Cos=0]="Cos",n[n.Sin=1]="Sin",n[n.Abs=2]="Abs",n[n.Exp=3]="Exp",n[n.Exp2=4]="Exp2",n[n.Round=5]="Round",n[n.Floor=6]="Floor",n[n.Ceiling=7]="Ceiling",n[n.Sqrt=8]="Sqrt",n[n.Log=9]="Log",n[n.Tan=10]="Tan",n[n.ArcTan=11]="ArcTan",n[n.ArcCos=12]="ArcCos",n[n.ArcSin=13]="ArcSin",n[n.Fract=14]="Fract",n[n.Sign=15]="Sign",n[n.Radians=16]="Radians",n[n.Degrees=17]="Degrees"})(ni||(ni={}));var Ws=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.operation=ni.Cos,i.registerInput("input",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"TrigonometryBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r="";switch(this.operation){case ni.Cos:{r="cos";break}case ni.Sin:{r="sin";break}case ni.Abs:{r="abs";break}case ni.Exp:{r="exp";break}case ni.Exp2:{r="exp2";break}case ni.Round:{r="round";break}case ni.Floor:{r="floor";break}case ni.Ceiling:{r="ceil";break}case ni.Sqrt:{r="sqrt";break}case ni.Log:{r="log";break}case ni.Tan:{r="tan";break}case ni.ArcTan:{r="atan";break}case ni.ArcCos:{r="acos";break}case ni.ArcSin:{r="asin";break}case ni.Fract:{r="fract";break}case ni.Sign:{r="sign";break}case ni.Radians:{r="radians";break}case ni.Degrees:{r="degrees";break}}return e.compilationString+=this._declareOutput(i,e)+(" = "+r+"("+this.input.associatedVariableName+`);\r
`),this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.operation=this.operation,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.operation=e.operation},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".operation = BABYLON.TrigonometryBlockOperations."+ni[this.operation]+`;\r
`;return e},t}(it);f.a.RegisteredTypes["BABYLON.TrigonometryBlock"]=Ws;var Hs={effect:null,subMesh:null},Ro=function(n){Object(h.d)(t,n);function t(){var e=n.call(this)||this;return e.NORMAL=!1,e.TANGENT=!1,e.UV1=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.BONETEXTURE=!1,e.MORPHTARGETS=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_UV=!1,e.NUM_MORPH_INFLUENCERS=0,e.MORPHTARGETS_TEXTURE=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.BUMPDIRECTUV=0,e.rebuild(),e}return t.prototype.setValue=function(e,i,r){r===void 0&&(r=!1),this[e]===void 0&&this._keys.push(e),r&&this[e]!==i&&this.markAsUnprocessed(),this[e]=i},t}(ps.a),oa=function(n){Object(h.d)(t,n);function t(e,i,r){r===void 0&&(r={});var o=n.call(this,e,i||W.a.LastCreatedScene)||this;return o._buildId=t._BuildIdGenerator++,o._buildWasSuccessful=!1,o._cachedWorldViewMatrix=new l.a,o._cachedWorldViewProjectionMatrix=new l.a,o._optimizers=new Array,o._animationFrame=-1,o.BJSNODEMATERIALEDITOR=o._getGlobalNodeMaterialEditor(),o.editorData=null,o.ignoreAlpha=!1,o.maxSimultaneousLights=4,o.onBuildObservable=new _.c,o._vertexOutputNodes=new Array,o._fragmentOutputNodes=new Array,o.attachedBlocks=new Array,o._mode=Ki.Material,o._options=Object(h.a)({emitComments:!1},r),o._attachImageProcessingConfiguration(null),o}return t.prototype._getGlobalNodeMaterialEditor=function(){if(typeof NODEEDITOR!="undefined")return NODEEDITOR;if(typeof BABYLON!="undefined"&&typeof BABYLON.NodeEditor!="undefined")return BABYLON},Object.defineProperty(t.prototype,"options",{get:function(){return this._options},set:function(e){this._options=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){return this._mode},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"NodeMaterial"},t.prototype._attachImageProcessingConfiguration=function(e){var i=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){i._markAllSubMeshesAsImageProcessingDirty()})))},t.prototype.getBlockByName=function(e){for(var i=null,r=0,o=this.attachedBlocks;r<o.length;r++){var a=o[r];if(a.name===e)if(!i)i=a;else return J.b.Warn("More than one block was found with the name `"+e+"`"),i}return i},t.prototype.getBlockByPredicate=function(e){for(var i=0,r=this.attachedBlocks;i<r.length;i++){var o=r[i];if(e(o))return o}return null},t.prototype.getInputBlockByPredicate=function(e){for(var i=0,r=this.attachedBlocks;i<r.length;i++){var o=r[i];if(o.isInput&&e(o))return o}return null},t.prototype.getInputBlocks=function(){for(var e=[],i=0,r=this.attachedBlocks;i<r.length;i++){var o=r[i];o.isInput&&e.push(o)}return e},t.prototype.registerOptimizer=function(e){var i=this._optimizers.indexOf(e);if(!(i>-1))return this._optimizers.push(e),this},t.prototype.unregisterOptimizer=function(e){var i=this._optimizers.indexOf(e);if(i!==-1)return this._optimizers.splice(i,1),this},t.prototype.addOutputNode=function(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&oe.Vertex)!=0&&this._addVertexOutputNode(e),(e.target&oe.Fragment)!=0&&this._addFragmentOutputNode(e),this},t.prototype.removeOutputNode=function(e){return e.target===null?this:((e.target&oe.Vertex)!=0&&this._removeVertexOutputNode(e),(e.target&oe.Fragment)!=0&&this._removeFragmentOutputNode(e),this)},t.prototype._addVertexOutputNode=function(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=oe.Vertex,this._vertexOutputNodes.push(e),this},t.prototype._removeVertexOutputNode=function(e){var i=this._vertexOutputNodes.indexOf(e);if(i!==-1)return this._vertexOutputNodes.splice(i,1),this},t.prototype._addFragmentOutputNode=function(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=oe.Fragment,this._fragmentOutputNodes.push(e),this},t.prototype._removeFragmentOutputNode=function(e){var i=this._fragmentOutputNodes.indexOf(e);if(i!==-1)return this._fragmentOutputNodes.splice(i,1),this},t.prototype.needAlphaBlending=function(){return this.ignoreAlpha?!1:this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending},t.prototype.needAlphaTesting=function(){return this._sharedData&&this._sharedData.hints.needAlphaTesting},t.prototype._initializeBlock=function(e,i,r){if(e.initialize(i),e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique)for(var o=e.getClassName(),a=0,s=this.attachedBlocks;a<s.length;a++){var c=s[a];if(c.getClassName()===o)throw"Cannot have multiple blocks of type "+o+" in the same NodeMaterial"}this.attachedBlocks.push(e)}for(var v=0,b=e.inputs;v<b.length;v++){var C=b[v];C.associatedVariableName="";var M=C.connectedPoint;if(M){var N=M.ownerBlock;N!==e&&((N.target===oe.VertexAndFragment||i.target===oe.Fragment&&N.target===oe.Vertex&&N._preparationId!==this._buildId)&&r.push(N),this._initializeBlock(N,i,r))}}for(var D=0,V=e.outputs;D<V.length;D++){var X=V[D];X.associatedVariableName=""}},t.prototype._resetDualBlocks=function(e,i){e.target===oe.VertexAndFragment&&(e.buildId=i);for(var r=0,o=e.inputs;r<o.length;r++){var a=o[r],s=a.connectedPoint;if(s){var c=s.ownerBlock;c!==e&&this._resetDualBlocks(c,i)}}},t.prototype.removeBlock=function(e){var i=this.attachedBlocks.indexOf(e);i>-1&&this.attachedBlocks.splice(i,1),e.isFinalMerger&&this.removeOutputNode(e)},t.prototype.build=function(e){e===void 0&&(e=!1),this._buildWasSuccessful=!1;var i=this.getScene().getEngine(),r=this._mode===Ki.Particle;if(this._vertexOutputNodes.length===0&&!r)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Lc,this._vertexCompilationState.supportUniformBuffers=i.supportsUniformBuffers,this._vertexCompilationState.target=oe.Vertex,this._fragmentCompilationState=new Lc,this._fragmentCompilationState.supportUniformBuffers=i.supportsUniformBuffers,this._fragmentCompilationState.target=oe.Fragment,this._sharedData=new qg,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=r;for(var o=[],a=[],s=0,c=this._vertexOutputNodes;s<c.length;s++){var v=c[s];o.push(v),this._initializeBlock(v,this._vertexCompilationState,a)}for(var b=0,C=this._fragmentOutputNodes;b<C.length;b++){var M=C[b];a.push(M),this._initializeBlock(M,this._fragmentCompilationState,o)}this.optimize();for(var N=0,D=o;N<D.length;N++){var v=D[N];v.build(this._vertexCompilationState,o)}this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(var V=0,X=a;V<X.length;V++){var M=X[V];this._resetDualBlocks(M,this._buildId-1)}for(var ee=0,ie=a;ee<ie.length;ee++){var M=ie[ee];M.build(this._fragmentCompilationState,a)}this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),this._buildId=t._BuildIdGenerator++,this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);for(var ge=this.getScene().meshes,pe=0,te=ge;pe<te.length;pe++){var Ce=te[pe];if(!!Ce.subMeshes)for(var Ae=0,De=Ce.subMeshes;Ae<De.length;Ae++){var Fe=De[Ae];if(Fe.getMaterial()===this&&!!Fe._materialDefines){var We=Fe._materialDefines;We.markAllAsDirty(),We.reset()}}}},t.prototype.optimize=function(){for(var e=0,i=this._optimizers;e<i.length;e++){var r=i[e];r.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}},t.prototype._prepareDefinesForAttributes=function(e,i){var r=i.NORMAL,o=i.TANGENT,a=i.UV1;i.NORMAL=e.isVerticesDataPresent(Oe.b.NormalKind),i.TANGENT=e.isVerticesDataPresent(Oe.b.TangentKind),i.UV1=e.isVerticesDataPresent(Oe.b.UVKind),(r!==i.NORMAL||o!==i.TANGENT||a!==i.UV1)&&i.markAsAttributesDirty()},t.prototype.createPostProcess=function(e,i,r,o,a,s,c){return i===void 0&&(i=1),r===void 0&&(r=1),s===void 0&&(s=0),c===void 0&&(c=5),this.mode!==Ki.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,i,r,o,a,s,c)},t.prototype.createEffectForPostProcess=function(e){this._createEffectForPostProcess(e)},t.prototype._createEffectForPostProcess=function(e,i,r,o,a,s,c,v){var b=this;r===void 0&&(r=1),o===void 0&&(o=1),c===void 0&&(c=0),v===void 0&&(v=5);var C=this.name+this._buildId,M=new Ro,N=new Ue.a(C+"PostProcess",this.getScene()),D=this._buildId;return this._processDefines(N,M),qe.a.RegisterShader(C,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(M.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,C,C):e=new ii.a(this.name+"PostProcess",C,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,r,i,o,a,s,M.toString(),c,C,{maxSimultaneousLights:this.maxSimultaneousLights},!1,v),e.nodeMaterialSource=this,e.onApplyObservable.add(function(V){D!==b._buildId&&(delete qe.a.ShadersStore[C+"VertexShader"],delete qe.a.ShadersStore[C+"PixelShader"],C=b.name+b._buildId,M.markAsUnprocessed(),D=b._buildId);var X=b._processDefines(N,M);X&&(qe.a.RegisterShader(C,b._fragmentCompilationState._builtCompilationString,b._vertexCompilationState._builtCompilationString),Nc.a.SetImmediate(function(){return e.updateEffect(M.toString(),b._fragmentCompilationState.uniforms,b._fragmentCompilationState.samplers,{maxSimultaneousLights:b.maxSimultaneousLights},void 0,void 0,C,C)})),b._checkInternals(V)}),e},t.prototype.createProceduralTexture=function(e,i){var r=this;if(this.mode!==Ki.ProceduralTexture)return console.log("Incompatible material mode"),null;var o=this.name+this._buildId,a=new Po(o,e,null,i),s=new Ue.a(o+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};var c=new Ro,v=this._processDefines(s,c);qe.a.RegisterShader(o,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);var b=this.getScene().getEngine().createEffect({vertexElement:o,fragmentElement:o},[Oe.b.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,c.toString(),v==null?void 0:v.fallbacks,void 0);a.nodeMaterialSource=this,a._effect=b;var C=this._buildId;return a.onBeforeGenerationObservable.add(function(){C!==r._buildId&&(delete qe.a.ShadersStore[o+"VertexShader"],delete qe.a.ShadersStore[o+"PixelShader"],o=r.name+r._buildId,c.markAsUnprocessed(),C=r._buildId);var M=r._processDefines(s,c);M&&(qe.a.RegisterShader(o,r._fragmentCompilationState._builtCompilationString,r._vertexCompilationState._builtCompilationString),Nc.a.SetImmediate(function(){b=r.getScene().getEngine().createEffect({vertexElement:o,fragmentElement:o},[Oe.b.PositionKind],r._fragmentCompilationState.uniforms,r._fragmentCompilationState.samplers,c.toString(),M==null?void 0:M.fallbacks,void 0),a._effect=b})),r._checkInternals(b)}),a},t.prototype._createEffectForParticles=function(e,i,r,o,a,s,c,v){var b=this;v===void 0&&(v="");var C=this.name+this._buildId+"_"+i;s||(s=new Ro),c||(c=this.getScene().getMeshByName(this.name+"Particle"),c||(c=new Ue.a(this.name+"Particle",this.getScene()),c.reservedDataStore={hidden:!0}));var M=this._buildId,N=[],D=v;if(!a){var V=this._processDefines(c,s);qe.a.RegisterShader(C,this._fragmentCompilationState._builtCompilationString),e.fillDefines(N,i),D=N.join(`
`),a=this.getScene().getEngine().createEffectForParticles(C,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString()+`
`+D,V==null?void 0:V.fallbacks,r,o,e),e.setCustomEffect(a,i)}a.onBindObservable.add(function(X){M!==b._buildId&&(delete qe.a.ShadersStore[C+"PixelShader"],C=b.name+b._buildId+"_"+i,s.markAsUnprocessed(),M=b._buildId),N.length=0,e.fillDefines(N,i);var ee=N.join(`
`);ee!==D&&(s.markAsUnprocessed(),D=ee);var ie=b._processDefines(c,s);if(ie){qe.a.RegisterShader(C,b._fragmentCompilationState._builtCompilationString),X=b.getScene().getEngine().createEffectForParticles(C,b._fragmentCompilationState.uniforms,b._fragmentCompilationState.samplers,s.toString()+`
`+D,ie==null?void 0:ie.fallbacks,r,o,e),e.setCustomEffect(X,i),b._createEffectForParticles(e,i,r,o,X,s,c,D);return}b._checkInternals(X)})},t.prototype._checkInternals=function(e){if(this._sharedData.animatedInputs){var i=this.getScene(),r=i.getFrameId();if(this._animationFrame!==r){for(var o=0,a=this._sharedData.animatedInputs;o<a.length;o++){var s=a[o];s.animate(i)}this._animationFrame=r}}for(var c=0,v=this._sharedData.bindableBlocks;c<v.length;c++){var b=v[c];b.bind(e,this)}for(var C=0,M=this._sharedData.inputBlocks;C<M.length;C++){var N=M[C];N._transmit(e,this.getScene())}},t.prototype.createEffectForParticles=function(e,i,r){if(this.mode!==Ki.Particle){console.log("Incompatible material mode");return}this._createEffectForParticles(e,To.BLENDMODE_ONEONE,i,r),this._createEffectForParticles(e,To.BLENDMODE_MULTIPLY,i,r)},t.prototype._processDefines=function(e,i,r,o){var a=this;r===void 0&&(r=!1);var s=null;if(this._sharedData.blocksWithDefines.forEach(function(N){N.initializeDefines(e,a,i,r)}),this._sharedData.blocksWithDefines.forEach(function(N){N.prepareDefines(e,a,i,r,o)}),i.isDirty){var c=i._areLightsDisposed;i.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(function(N){N.replaceRepeatableContent(a._vertexCompilationState,a._fragmentCompilationState,e,i)});var v=[];this._sharedData.dynamicUniformBlocks.forEach(function(N){N.updateUniformsAndSamples(a._vertexCompilationState,a,i,v)});var b=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(function(N){var D=b.indexOf(N);D===-1&&b.push(N)});var C=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(function(N){var D=C.indexOf(N);D===-1&&C.push(N)});var M=new ms.a;this._sharedData.blocksWithFallbacks.forEach(function(N){N.provideFallbacks(e,M)}),s={lightDisposed:c,uniformBuffers:v,mergedUniforms:b,mergedSamplers:C,fallbacks:M}}return s},t.prototype.isReadyForSubMesh=function(e,i,r){var o=this;if(r===void 0&&(r=!1),!this._buildWasSuccessful)return!1;var a=this.getScene();if(this._sharedData.animatedInputs){var s=a.getFrameId();if(this._animationFrame!==s){for(var c=0,v=this._sharedData.animatedInputs;c<v.length;c++){var b=v[c];b.animate(a)}this._animationFrame=s}}if(i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady)return!0;i._materialDefines||(i._materialDefines=new Ro);var C=i._materialDefines;if(this._isReadyForSubMesh(i))return!0;var M=a.getEngine();if(this._prepareDefinesForAttributes(e,C),this._sharedData.blockingBlocks.some(function(ee){return!ee.isReady(e,o,C,r)}))return!1;var N=this._processDefines(e,C,r,i);if(N){var D=i.effect,V=C.toString(),X=M.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:N.mergedUniforms,uniformBuffersNames:N.uniformBuffers,samplers:N.mergedSamplers,defines:V,fallbacks:N.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:C.NUM_MORPH_INFLUENCERS}},M);if(X)if(this._onEffectCreatedObservable&&(Hs.effect=X,Hs.subMesh=i,this._onEffectCreatedObservable.notifyObservers(Hs)),this.allowShaderHotSwapping&&D&&!X.isReady()){if(X=D,C.markAsUnprocessed(),N.lightDisposed)return C._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),i.setEffect(X,C)}return!i.effect||!i.effect.isReady()?!1:(C._renderId=a.getRenderId(),i.effect._wasPreviouslyReady=!0,!0)},Object.defineProperty(t.prototype,"compiledShaders",{get:function(){return`// Vertex shader\r
`+this._vertexCompilationState.compilationString+`\r
\r
// Fragment shader\r
`+this._fragmentCompilationState.compilationString},enumerable:!1,configurable:!0}),t.prototype.bindOnlyWorldMatrix=function(e){var i=this.getScene();if(!!this._activeEffect){var r=this._sharedData.hints;r.needWorldViewMatrix&&e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),r.needWorldViewProjectionMatrix&&e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(var o=0,a=this._sharedData.inputBlocks;o<a.length;o++){var s=a[o];s._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}}},t.prototype.bindForSubMesh=function(e,i,r){var o=this.getScene(),a=r.effect;if(!!a){this._activeEffect=a,this.bindOnlyWorldMatrix(e);var s=this._mustRebind(o,a,i.visibility);if(s){var c=this._sharedData;if(a&&o.getCachedEffect()!==a){for(var v=0,b=c.bindableBlocks;v<b.length;v++){var C=b[v];C.bind(a,this,i,r)}for(var M=0,N=c.inputBlocks;M<N.length;M++){var D=N[M];D._transmit(a,o)}}}this._afterBind(i,this._activeEffect)}},t.prototype.getActiveTextures=function(){var e=n.prototype.getActiveTextures.call(this);return this._sharedData&&e.push.apply(e,this._sharedData.textureBlocks.filter(function(i){return i.texture}).map(function(i){return i.texture})),e},t.prototype.getTextureBlocks=function(){return this._sharedData?this._sharedData.textureBlocks:[]},t.prototype.hasTexture=function(e){if(n.prototype.hasTexture.call(this,e))return!0;if(!this._sharedData)return!1;for(var i=0,r=this._sharedData.textureBlocks;i<r.length;i++){var o=r[i];if(o.texture===e)return!0}return!1},t.prototype.dispose=function(e,i,r){if(i)for(var o=0,a=this._sharedData.textureBlocks.filter(function(C){return C.texture}).map(function(C){return C.texture});o<a.length;o++){var s=a[o];s.dispose()}for(var c=0,v=this.attachedBlocks;c<v.length;c++){var b=v[c];b.dispose()}this.onBuildObservable.clear(),n.prototype.dispose.call(this,e,i,r)},t.prototype._createNodeEditor=function(){this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})},t.prototype.edit=function(e){var i=this;return new Promise(function(r,o){if(typeof i.BJSNODEMATERIALEDITOR=="undefined"){var a=e&&e.editorURL?e.editorURL:t.EditorURL;J.b.LoadScript(a,function(){i._createNodeEditor(),r()})}else i._createNodeEditor(),r()})},t.prototype.clear=function(){this._vertexOutputNodes=[],this._fragmentOutputNodes=[],this.attachedBlocks=[]},t.prototype.setToDefault=function(){this.clear(),this.editorData=null;var e=new yt("Position");e.setAsAttribute("position");var i=new yt("World");i.setAsSystemValue(BABYLON.NodeMaterialSystemValues.World);var r=new ta("WorldPos");e.connectTo(r),i.connectTo(r);var o=new yt("ViewProjection");o.setAsSystemValue(BABYLON.NodeMaterialSystemValues.ViewProjection);var a=new ta("WorldPos * ViewProjectionTransform");r.connectTo(a),o.connectTo(a);var s=new Co("VertexOutput");a.connectTo(s);var c=new yt("color");c.value=new m.b(.8,.8,.8,1);var v=new On("FragmentOutput");c.connectTo(v),this.addOutputNode(s),this.addOutputNode(v),this._mode=Ki.Material},t.prototype.setToDefaultPostProcess=function(){this.clear(),this.editorData=null;var e=new yt("Position");e.setAsAttribute("position2d");var i=new yt("Constant1");i.isConstant=!0,i.value=1;var r=new So("Position3D");e.connectTo(r),i.connectTo(r,{input:"w"});var o=new Co("VertexOutput");r.connectTo(o);var a=new yt("Scale");a.visibleInInspector=!0,a.value=new l.d(1,1);var s=new Ns("uv0");e.connectTo(s);var c=new ia("UV scale");s.connectTo(c),a.connectTo(c);var v=new Is("CurrentScreen");c.connectTo(v),v.texture=new Ze.a("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());var b=new On("FragmentOutput");v.connectTo(b,{output:"rgba"}),this.addOutputNode(o),this.addOutputNode(b),this._mode=Ki.PostProcess},t.prototype.setToDefaultProceduralTexture=function(){this.clear(),this.editorData=null;var e=new yt("Position");e.setAsAttribute("position2d");var i=new yt("Constant1");i.isConstant=!0,i.value=1;var r=new So("Position3D");e.connectTo(r),i.connectTo(r,{input:"w"});var o=new Co("VertexOutput");r.connectTo(o);var a=new yt("Time");a.value=0,a.min=0,a.max=0,a.isBoolean=!1,a.matrixMode=0,a.animationType=on.Time,a.isConstant=!1;var s=new yt("Color3");s.value=new m.a(1,1,1),s.isConstant=!1;var c=new On("FragmentOutput"),v=new So("VectorMerger");v.visibleInInspector=!1;var b=new Ws("Cos");b.operation=ni.Cos,e.connectTo(v),a.output.connectTo(b.input),b.output.connectTo(v.z),v.xyzOut.connectTo(c.rgb),this.addOutputNode(o),this.addOutputNode(c),this._mode=Ki.ProceduralTexture},t.prototype.setToDefaultParticle=function(){this.clear(),this.editorData=null;var e=new yt("uv");e.setAsAttribute("particle_uv");var i=new Ls("ParticleTexture");e.connectTo(i);var r=new yt("Color");r.setAsAttribute("particle_color");var o=new ia("Texture * Color");i.connectTo(o),r.connectTo(o);var a=new Fs("ParticleRampGradient");o.connectTo(a);var s=new js("ColorSplitter");r.connectTo(s);var c=new Bs("ParticleBlendMultiply");a.connectTo(c),i.connectTo(c,{output:"a"}),s.connectTo(c,{output:"a"});var v=new On("FragmentOutput");c.connectTo(v),this.addOutputNode(v),this._mode=Ki.Particle},t.prototype.loadAsync=function(e){var i=this;return this.getScene()._loadFileAsync(e).then(function(r){var o=JSON.parse(r);i.loadFromSerialization(o,"")})},t.prototype._gatherBlocks=function(e,i){if(i.indexOf(e)===-1){i.push(e);for(var r=0,o=e.inputs;r<o.length;r++){var a=o[r],s=a.connectedPoint;if(s){var c=s.ownerBlock;c!==e&&this._gatherBlocks(c,i)}}}},t.prototype.generateCode=function(){for(var e=[],i=[],r=[],o=0,a=this._vertexOutputNodes;o<a.length;o++){var s=a[o];this._gatherBlocks(s,i)}for(var c=[],v=0,b=this._fragmentOutputNodes;v<b.length;v++){var s=b[v];this._gatherBlocks(s,c)}for(var C='var nodeMaterial = new BABYLON.NodeMaterial("'+(this.name||"node material")+`");\r
`,M=0,N=i;M<N.length;M++){var D=N[M];D.isInput&&e.indexOf(D)===-1&&(C+=D._dumpCode(r,e))}for(var V=0,X=c;V<X.length;V++){var D=X[V];D.isInput&&e.indexOf(D)===-1&&(C+=D._dumpCode(r,e))}e=[],C+=`\r
// Connections\r
`;for(var ee=0,ie=this._vertexOutputNodes;ee<ie.length;ee++){var D=ie[ee];C+=D._dumpCodeForOutputConnections(e)}for(var ge=0,pe=this._fragmentOutputNodes;ge<pe.length;ge++){var D=pe[ge];C+=D._dumpCodeForOutputConnections(e)}C+=`\r
// Output nodes\r
`;for(var te=0,Ce=this._vertexOutputNodes;te<Ce.length;te++){var D=Ce[te];C+="nodeMaterial.addOutputNode("+D._codeVariableName+`);\r
`}for(var Ae=0,De=this._fragmentOutputNodes;Ae<De.length;Ae++){var D=De[Ae];C+="nodeMaterial.addOutputNode("+D._codeVariableName+`);\r
`}return C+=`nodeMaterial.build();\r
`,C},t.prototype.serialize=function(e){var i=e?{}:de.a.Serialize(this);i.editorData=JSON.parse(JSON.stringify(this.editorData));var r=[];if(e)r=e;else{i.customType="BABYLON.NodeMaterial",i.outputNodes=[];for(var o=0,a=this._vertexOutputNodes;o<a.length;o++){var s=a[o];this._gatherBlocks(s,r),i.outputNodes.push(s.uniqueId)}for(var c=0,v=this._fragmentOutputNodes;c<v.length;c++){var s=v[c];this._gatherBlocks(s,r),i.outputNodes.indexOf(s.uniqueId)===-1&&i.outputNodes.push(s.uniqueId)}}i.blocks=[];for(var b=0,C=r;b<C.length;b++){var M=C[b];i.blocks.push(M.serialize())}if(!e)for(var N=0,D=this.attachedBlocks;N<D.length;N++){var M=D[N];r.indexOf(M)===-1&&i.blocks.push(M.serialize())}return i},t.prototype._restoreConnections=function(e,i,r){for(var o=0,a=e.outputs;o<a.length;o++)for(var s=a[o],c=0,v=i.blocks;c<v.length;c++){var b=v[c],C=r[b.id];if(!!C)for(var M=0,N=b.inputs;M<N.length;M++){var D=N[M];if(r[D.targetBlockId]===e&&D.targetConnectionName===s.name){var V=C.getInputByName(D.inputName);if(!V||V.isConnected)continue;s.connectTo(V,!0),this._restoreConnections(C,i,r);continue}}}},t.prototype.loadFromSerialization=function(e,i,r){var o;i===void 0&&(i=""),r===void 0&&(r=!1),r||this.clear();for(var a={},s=0,c=e.blocks;s<c.length;s++){var v=c[s],b=f.a.GetClass(v.customType);if(b){var C=new b;C._deserialize(v,this.getScene(),i),a[v.id]=C,this.attachedBlocks.push(C)}}for(var M=0;M<e.blocks.length;M++){var N=e.blocks[M],C=a[N.id];!C||C.inputs.length&&!r||this._restoreConnections(C,e,a)}if(e.outputNodes)for(var D=0,V=e.outputNodes;D<V.length;D++){var X=V[D];this.addOutputNode(a[X])}if(e.locations||e.editorData&&e.editorData.locations){for(var ee=e.locations||e.editorData.locations,ie=0,ge=ee;ie<ge.length;ie++){var pe=ge[ie];a[pe.blockId]&&(pe.blockId=a[pe.blockId].uniqueId)}r&&this.editorData&&this.editorData.locations&&ee.concat(this.editorData.locations),e.locations?this.editorData={locations:ee}:(this.editorData=e.editorData,this.editorData.locations=ee);var te=[];for(var Ce in a)te[Ce]=a[Ce].uniqueId;this.editorData.map=te}this.comment=e.comment,r||(this._mode=(o=e.mode)!==null&&o!==void 0?o:Ki.Material)},t.prototype.clone=function(e){var i=this,r=this.serialize(),o=de.a.Clone(function(){return new t(e,i.getScene(),i.options)},this);return o.id=e,o.name=e,o.loadFromSerialization(r),o.build(),o},t.Parse=function(e,i,r){r===void 0&&(r="");var o=de.a.Parse(function(){return new t(e.name,i)},e,i,r);return o.loadFromSerialization(e,r),o.build(),o},t.ParseFromFileAsync=function(e,i,r){var o=new t(e,r);return new Promise(function(a,s){return o.loadAsync(i).then(function(){o.build(),a(o)}).catch(s)})},t.ParseFromSnippetAsync=function(e,i,r,o){var a=this;return r===void 0&&(r=""),e==="_BLANK"?Promise.resolve(this.CreateDefault("blank",i)):new Promise(function(s,c){var v=new Ar.a;v.addEventListener("readystatechange",function(){if(v.readyState==4)if(v.status==200){var b=JSON.parse(JSON.parse(v.responseText).jsonPayload),C=JSON.parse(b.nodeMaterial);o||(o=de.a.Parse(function(){return new t(e,i)},C,i,r),o.uniqueId=i.getUniqueId()),o.loadFromSerialization(C),o.snippetId=e;try{o.build(),s(o)}catch(M){c(M)}}else c("Unable to load the snippet "+e)}),v.open("GET",a.SnippetUrl+"/"+e.replace(/#/g,"/")),v.send()})},t.CreateDefault=function(e,i){var r=new t(e,i);return r.setToDefault(),r.build(),r},t._BuildIdGenerator=0,t.EditorURL="https://unpkg.com/babylonjs-node-editor@"+W.a.Version+"/babylon.nodeEditor.js",t.SnippetUrl="https://snippet.babylonjs.com",t.IgnoreTexturesAtLoadTime=!1,Object(h.c)([Object(de.c)("mode")],t.prototype,"_mode",void 0),Object(h.c)([Object(de.c)("comment")],t.prototype,"comment",void 0),t}(gs.a);f.a.RegisteredTypes["BABYLON.NodeMaterial"]=oa;var wc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Vertex)||this;return i.registerInput("matricesIndices",K.Vector4),i.registerInput("matricesWeights",K.Vector4),i.registerInput("matricesIndicesExtra",K.Vector4,!0),i.registerInput("matricesWeightsExtra",K.Vector4,!0),i.registerInput("world",K.Matrix),i.registerOutput("output",K.Matrix),i}return t.prototype.initialize=function(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")},t.prototype.getClassName=function(){return"BonesBlock"},Object.defineProperty(t.prototype,"matricesIndices",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"matricesWeights",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"matricesIndicesExtra",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"matricesWeightsExtra",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.matricesIndices.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="matricesIndices"});i||(i=new yt("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){var r=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="matricesWeights"});r||(r=new yt("matricesWeights"),r.setAsAttribute("matricesWeights")),r.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){var o=e.getInputBlockByPredicate(function(a){return a.systemValue===dt.World});o||(o=new yt("world"),o.setAsSystemValue(dt.World)),o.output.connectTo(this.world)}},t.prototype.provideFallbacks=function(e,i){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&i.addCPUSkinningFallback(0,e)},t.prototype.bind=function(e,i,r){Ot.a.BindBonesParameters(r,e)},t.prototype.prepareDefines=function(e,i,r){!r._areAttributesDirty||Ot.a.PrepareDefinesForBones(e,r)},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");var i="//"+this.name;e._emitFunctionFromInclude("bonesDeclaration",i,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});var r=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",i,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:r}]});var o=this._outputs[0],a=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0\r
`,e.compilationString+=this._declareOutput(o,e)+(" = "+a.associatedVariableName+" * "+r+`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(o,e)+(" = "+a.associatedVariableName+`;\r
`),e.compilationString+=`#endif\r
`,this},t}(it);f.a.RegisteredTypes["BABYLON.BonesBlock"]=wc;var Vc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Vertex)||this;return i.registerInput("world0",K.Vector4),i.registerInput("world1",K.Vector4),i.registerInput("world2",K.Vector4),i.registerInput("world3",K.Vector4),i.registerInput("world",K.Matrix,!0),i.registerOutput("output",K.Matrix),i.registerOutput("instanceID",K.Float),i}return t.prototype.getClassName=function(){return"InstancesBlock"},Object.defineProperty(t.prototype,"world0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world2",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world3",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"instanceID",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.world0.connectedPoint){var i=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world0"});i||(i=new yt("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){var r=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world1"});r||(r=new yt("world1"),r.setAsAttribute("world1")),r.output.connectTo(this.world1)}if(!this.world2.connectedPoint){var o=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world2"});o||(o=new yt("world2"),o.setAsAttribute("world2")),o.output.connectTo(this.world2)}if(!this.world3.connectedPoint){var a=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world3"});a||(a=new yt("world3"),a.setAsAttribute("world3")),a.output.connectTo(this.world3)}if(!this.world.connectedPoint){var s=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world"});s||(s=new yt("world"),s.setAsSystemValue(dt.World)),s.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"},t.prototype.prepareDefines=function(e,i,r,o,a){o===void 0&&(o=!1);var s=!1;r.INSTANCES!==o&&(r.setValue("INSTANCES",o),s=!0),a&&r.THIN_INSTANCES!==!!(a==null?void 0:a.getRenderingMesh().hasThinInstances)&&(r.setValue("THIN_INSTANCES",!!(a==null?void 0:a.getRenderingMesh().hasThinInstances)),s=!0),s&&r.markAsUnprocessed()},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);var r=this._outputs[0],o=this._outputs[1],a=this.world0,s=this.world1,c=this.world2,v=this.world3;return e.compilationString+=`#ifdef INSTANCES\r
`,e.compilationString+=this._declareOutput(r,e)+(" = mat4("+a.associatedVariableName+", "+s.associatedVariableName+", "+c.associatedVariableName+", "+v.associatedVariableName+`);\r
`),e.compilationString+=`#ifdef THIN_INSTANCES\r
`,e.compilationString+=r.associatedVariableName+" = "+this.world.associatedVariableName+" * "+r.associatedVariableName+`;\r
`,e.compilationString+=`#endif\r
`,i._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(o,e)+` = 0.0;\r
`:e.compilationString+=this._declareOutput(o,e)+` = float(gl_InstanceID);\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(r,e)+(" = "+this.world.associatedVariableName+`;\r
`),e.compilationString+=this._declareOutput(o,e)+` = 0.0;\r
`,e.compilationString+=`#endif\r
`,this},t}(it);f.a.RegisteredTypes["BABYLON.InstancesBlock"]=Vc;var ty=u(497),iy=u(496),Uc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Vertex)||this;return i.registerInput("position",K.Vector3),i.registerInput("normal",K.Vector3),i.registerInput("tangent",K.Vector3),i.registerInput("uv",K.Vector2),i.registerOutput("positionOutput",K.Vector3),i.registerOutput("normalOutput",K.Vector3),i.registerOutput("tangentOutput",K.Vector3),i.registerOutput("uvOutput",K.Vector2),i}return t.prototype.getClassName=function(){return"MorphTargetsBlock"},Object.defineProperty(t.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tangent",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"positionOutput",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalOutput",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tangentOutput",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uvOutput",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("morphTargetInfluences")},t.prototype.autoConfigure=function(e){if(!this.position.isConnected){var i=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="position"});i||(i=new yt("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){var r=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="normal"});r||(r=new yt("normal"),r.setAsAttribute("normal")),r.output.connectTo(this.normal)}if(!this.tangent.isConnected){var o=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="tangent"});o||(o=new yt("tangent"),o.setAsAttribute("tangent")),o.output.connectTo(this.tangent)}if(!this.uv.isConnected){var a=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="uv"});a||(a=new yt("uv"),a.setAsAttribute("uv")),a.output.connectTo(this.uv)}},t.prototype.prepareDefines=function(e,i,r){if(e.morphTargetManager){var o=e.morphTargetManager;(o==null?void 0:o.isUsingTextureForTargets)&&o.numInfluencers!==r.NUM_MORPH_INFLUENCERS&&r.markAsAttributesDirty()}!r._areAttributesDirty||Ot.a.PrepareDefinesForMorphTargets(e,r)},t.prototype.bind=function(e,i,r){r&&r.morphTargetManager&&r.morphTargetManager.numInfluencers>0&&(Ot.a.BindMorphTargetParameters(r,e),r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(e))},t.prototype.replaceRepeatableContent=function(e,i,r,o){var a=this.position,s=this.normal,c=this.tangent,v=this.uv,b=this.positionOutput,C=this.normalOutput,M=this.tangentOutput,N=this.uvOutput,D=e,V=o.NUM_MORPH_INFLUENCERS,X=r.morphTargetManager,ee=X&&X.supportsNormals&&o.NORMAL,ie=X&&X.supportsTangents&&o.TANGENT,ge=X&&X.supportsUVs&&o.UV1,pe="";(X==null?void 0:X.isUsingTextureForTargets)&&V>0&&(pe+=`float vertexID;\r
`);for(var te=0;te<V;te++)pe+=`#ifdef MORPHTARGETS\r
`,(X==null?void 0:X.isUsingTextureForTargets)?(pe+=`vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r
`,pe+=b.associatedVariableName+" += (readVector3FromRawSampler("+te+", vertexID) - "+a.associatedVariableName+") * morphTargetInfluences["+te+`];\r
`,pe+=`vertexID += 1.0;\r
`):pe+=b.associatedVariableName+" += (position"+te+" - "+a.associatedVariableName+") * morphTargetInfluences["+te+`];\r
`,ee&&(pe+=`#ifdef MORPHTARGETS_NORMAL\r
`,(X==null?void 0:X.isUsingTextureForTargets)?(pe+=C.associatedVariableName+" += (readVector3FromRawSampler("+te+", vertexID) - "+s.associatedVariableName+") * morphTargetInfluences["+te+`];\r
`,pe+=`vertexID += 1.0;\r
`):pe+=C.associatedVariableName+" += (normal"+te+" - "+s.associatedVariableName+") * morphTargetInfluences["+te+`];\r
`,pe+=`#endif\r
`),ge&&(pe+=`#ifdef MORPHTARGETS_UV\r
`,(X==null?void 0:X.isUsingTextureForTargets)?(pe+=N.associatedVariableName+" += (readVector3FromRawSampler("+te+", vertexID).xy - "+v.associatedVariableName+") * morphTargetInfluences["+te+`];\r
`,pe+=`vertexID += 1.0;\r
`):pe+=N.associatedVariableName+".xy += (uv_"+te+" - "+v.associatedVariableName+".xy) * morphTargetInfluences["+te+`];\r
`,pe+=`#endif\r
`),ie&&(pe+=`#ifdef MORPHTARGETS_TANGENT\r
`,(X==null?void 0:X.isUsingTextureForTargets)?pe+=M.associatedVariableName+" += (readVector3FromRawSampler("+te+", vertexID) - "+c.associatedVariableName+") * morphTargetInfluences["+te+`];\r
`:pe+=M.associatedVariableName+".xyz += (tangent"+te+" - "+c.associatedVariableName+".xyz) * morphTargetInfluences["+te+`];\r
`,pe+=`#endif\r
`),pe+=`#endif\r
`;if(D.compilationString=D.compilationString.replace(this._repeatableContentAnchor,pe),V>0)for(var te=0;te<V;te++)D.attributes.push(Oe.b.PositionKind+te),ee&&D.attributes.push(Oe.b.NormalKind+te),ie&&D.attributes.push(Oe.b.TangentKind+te),ge&&D.attributes.push(Oe.b.UVKind+"_"+te)},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);var i=this.position,r=this.normal,o=this.tangent,a=this.uv,s=this.positionOutput,c=this.normalOutput,v=this.tangentOutput,b=this.uvOutput,C="//"+this.name;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",C),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",C,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=this._declareOutput(s,e)+" = "+i.associatedVariableName+`;\r
`,e.compilationString+=`#ifdef NORMAL\r
`,e.compilationString+=this._declareOutput(c,e)+" = "+r.associatedVariableName+`;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(c,e)+` = vec3(0., 0., 0.);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef TANGENT\r
`,e.compilationString+=this._declareOutput(v,e)+" = "+o.associatedVariableName+`;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(v,e)+` = vec3(0., 0., 0.);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef UV1\r
`,e.compilationString+=this._declareOutput(b,e)+" = "+a.associatedVariableName+`;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(b,e)+` = vec2(0., 0.);\r
`,e.compilationString+=`#endif\r
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this},t}(it);f.a.RegisteredTypes["BABYLON.MorphTargetsBlock"]=Uc;var Gc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Vertex)||this;return i.registerInput("worldPosition",K.Vector4,!1,oe.Vertex),i.registerOutput("direction",K.Vector3),i.registerOutput("color",K.Color3),i.registerOutput("intensity",K.Float),i}return t.prototype.getClassName=function(){return"LightInformationBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"intensity",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),t.prototype.bind=function(e,i,r){if(!!r){this.light&&this.light.isDisposed&&(this.light=null);var o=this.light,a=i.getScene();if(!o&&a.lights.length&&(o=a.lights[0]),!o||!o.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}o.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,o.diffuse,o.intensity)}},t.prototype.prepareDefines=function(e,i,r){if(!!r._areLightsDirty){var o=this.light;r.setValue(this._lightTypeDefineName,!!(o&&o instanceof As))}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);var i=this.direction,r=this.color,o=this.intensity;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+="#ifdef "+this._lightTypeDefineName+`\r
`,e.compilationString+=this._declareOutput(i,e)+(" = normalize("+this.worldPosition.associatedVariableName+".xyz - "+this._lightDataUniformName+`);\r
`),e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(i,e)+(" = "+this._lightDataUniformName+`;\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=this._declareOutput(r,e)+(" = "+this._lightColorUniformName+`.rgb;\r
`),e.compilationString+=this._declareOutput(o,e)+(" = "+this._lightColorUniformName+`.a;\r
`),this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),e.lightId&&(this.light=i.getLightByID(e.lightId))},t}(it);f.a.RegisteredTypes["BABYLON.LightInformationBlock"]=Gc;var zc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i.registerInput("color",K.Color4),i.registerOutput("output",K.Color4),i._inputs[0].acceptedConnectionPointTypes.push(K.Color3),i}return t.prototype.getClassName=function(){return"ImageProcessingBlock"},Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings")},t.prototype.isReady=function(e,i,r){return!(r._areImageProcessingDirty&&i.imageProcessingConfiguration&&!i.imageProcessingConfiguration.isReady())},t.prototype.prepareDefines=function(e,i,r){r._areImageProcessingDirty&&i.imageProcessingConfiguration&&i.imageProcessingConfiguration.prepareDefines(r)},t.prototype.bind=function(e,i,r){!r||!i.imageProcessingConfiguration||i.imageProcessingConfiguration.bind(e)},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings");var i=this.color,r=this._outputs[0],o="//"+this.name;return e._emitFunctionFromInclude("helperFunctions",o),e._emitFunctionFromInclude("imageProcessingDeclaration",o),e._emitFunctionFromInclude("imageProcessingFunctions",o),i.connectedPoint.type===K.Color4||i.connectedPoint.type===K.Vector4?e.compilationString+=this._declareOutput(r,e)+" = "+i.associatedVariableName+`;\r
`:e.compilationString+=this._declareOutput(r,e)+" = vec4("+i.associatedVariableName+`, 1.0);\r
`,e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS\r
`,e.compilationString+=r.associatedVariableName+".rgb = toLinearSpace("+i.associatedVariableName+`.rgb);\r
`,e.compilationString+=`#else\r
`,e.compilationString+=`#ifdef IMAGEPROCESSING\r
`,e.compilationString+=r.associatedVariableName+".rgb = toLinearSpace("+i.associatedVariableName+`.rgb);\r
`,e.compilationString+=r.associatedVariableName+" = applyImageProcessing("+r.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this},t}(it);f.a.RegisteredTypes["BABYLON.ImageProcessingBlock"]=zc;var ry=u(614),ny=u(615),oy=u(616),jc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i._tangentSpaceParameterName="",i.invertX=!1,i.invertY=!1,i.registerInput("worldPosition",K.Vector4,!1),i.registerInput("worldNormal",K.Vector4,!1),i.registerInput("worldTangent",K.Vector4,!0),i.registerInput("uv",K.Vector2,!1),i.registerInput("normalMapColor",K.Color3,!1),i.registerInput("strength",K.Float,!1),i.registerOutput("output",K.Vector4),i}return t.prototype.getClassName=function(){return"PerturbNormalBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldTangent",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalMapColor",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"strength",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.prepareDefines=function(e,i,r){r.setValue("BUMP",!0)},t.prototype.bind=function(e,i,r){i.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1)},t.prototype.autoConfigure=function(e){if(!this.uv.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name==="uv"});i||(i=new yt("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){var r=new yt("strength");r.value=1,r.output.connectTo(this.strength)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i="//"+this.name,r=this.uv,o=this.worldPosition,a=this.worldNormal,s=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2");var c=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?""+e._emitFloat(1/this.strength.connectInputBlock.value):"1.0 / "+this.strength.associatedVariableName;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var v={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"};return s.isConnected&&(e.compilationString+="vec3 tbnNormal = normalize("+a.associatedVariableName+`.xyz);\r
`,e.compilationString+="vec3 tbnTangent = normalize("+s.associatedVariableName+`.xyz);\r
`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,e.compilationString+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[v]}),e._emitFunctionFromInclude("bumpFragmentFunctions",i,{replaceStrings:[{search:/vBumpInfos.y/g,replace:c},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vPositionW/g,replace:o.associatedVariableName+".xyz"},{search:/varying vec2 vBumpUV;/g,replace:""},{search:/uniform sampler2D bumpSampler;[\s\S]*?\}/g,replace:""}]}),e.compilationString+=this._declareOutput(this.output,e)+` = vec4(0.);\r
`,e.compilationString+=e._emitCodeFromInclude("bumpFragment",i,{replaceStrings:[{search:/perturbNormal\(TBN,vBumpUV\+uvOffset\)/g,replace:"perturbNormal(TBN, "+this.normalMapColor.associatedVariableName+")"},{search:/vBumpInfos.y/g,replace:c},{search:/vBumpUV/g,replace:r.associatedVariableName},{search:/vPositionW/g,replace:o.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:a.associatedVariableName+".xyz"},v]}),this},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".invertX = "+this.invertX+`;\r
`;return e+=this._codeVariableName+".invertY = "+this.invertY+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.invertX=this.invertX,e.invertY=this.invertY,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.invertX=e.invertX,this.invertY=e.invertY},Object(h.c)([It("Invert X axis",Mt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],t.prototype,"invertX",void 0),Object(h.c)([It("Invert Y axis",Mt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],t.prototype,"invertY",void 0),t}(it);f.a.RegisteredTypes["BABYLON.PerturbNormalBlock"]=jc;var Wc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment,!0)||this;return i.registerInput("value",K.Float,!0),i.registerInput("cutoff",K.Float,!0),i}return t.prototype.getClassName=function(){return"DiscardBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cutoff",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+="if ("+this.value.associatedVariableName+" < "+this.cutoff.associatedVariableName+`) discard;\r
`,this},t}(it);f.a.RegisteredTypes["BABYLON.DiscardBlock"]=Wc;var Hc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i.registerOutput("output",K.Float,oe.Fragment),i}return t.prototype.getClassName=function(){return"FrontFacingBlock"},Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===oe.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+` = gl_FrontFacing ? 1.0 : 0.0;\r
`,this},t}(it);f.a.RegisteredTypes["BABYLON.FrontFacingBlock"]=Hc;var kc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i.registerInput("input",K.AutoDetect,!1),i.registerOutput("dx",K.BasedOnInput),i.registerOutput("dy",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._outputs[1]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"DerivativeBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dx",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dy",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+(" = dFdx("+this.input.associatedVariableName+`);\r
`)),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+(" = dFdy("+this.input.associatedVariableName+`);\r
`)),this},t}(it);f.a.RegisteredTypes["BABYLON.DerivativeBlock"]=kc;var Xc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i.registerOutput("xy",K.Vector2,oe.Fragment),i.registerOutput("xyz",K.Vector3,oe.Fragment),i.registerOutput("xyzw",K.Vector4,oe.Fragment),i.registerOutput("x",K.Float,oe.Fragment),i.registerOutput("y",K.Float,oe.Fragment),i.registerOutput("z",K.Float,oe.Fragment),i.registerOutput("w",K.Float,oe.Fragment),i}return t.prototype.getClassName=function(){return"FragCoordBlock"},Object.defineProperty(t.prototype,"xy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyz",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzw",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),t.prototype.writeOutputs=function(e){for(var i="",r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&(i+=this._declareOutput(a,e)+" = gl_FragCoord."+a.name+`;\r
`)}return i},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===oe.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this},t}(it);f.a.RegisteredTypes["BABYLON.FragCoordBlock"]=Xc;var Yc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i.registerOutput("xy",K.Vector2,oe.Fragment),i.registerOutput("x",K.Float,oe.Fragment),i.registerOutput("y",K.Float,oe.Fragment),i}return t.prototype.getClassName=function(){return"ScreenSizeBlock"},Object.defineProperty(t.prototype,"xy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),t.prototype.bind=function(e,i,r){var o=this._scene.getEngine();e.setFloat2(this._varName,o.getRenderWidth(),o.getRenderWidth())},t.prototype.writeOutputs=function(e,i){for(var r="",o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&(r+=this._declareOutput(s,e)+" = "+i+"."+s.name+`;\r
`)}return r},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),this._scene=e.sharedData.scene,e.target===oe.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this},t}(it);f.a.RegisteredTypes["BABYLON.ScreenSizeBlock"]=Yc;var Kc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.VertexAndFragment,!1)||this;return i.registerInput("worldPosition",K.Vector4,!1,oe.Vertex),i.registerInput("view",K.Matrix,!1,oe.Vertex),i.registerInput("input",K.Color3,!1,oe.Fragment),i.registerInput("fogColor",K.Color3,!1,oe.Fragment),i.registerOutput("output",K.Color3,oe.Fragment),i.input.acceptedConnectionPointTypes.push(K.Color4),i.fogColor.acceptedConnectionPointTypes.push(K.Color4),i}return t.prototype.getClassName=function(){return"FogBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fogColor",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.view.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.systemValue===dt.View});i||(i=new yt("view"),i.setAsSystemValue(dt.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){var r=e.getInputBlockByPredicate(function(o){return o.systemValue===dt.FogColor});r||(r=new yt("fogColor",void 0,K.Color3),r.setAsSystemValue(dt.FogColor)),r.output.connectTo(this.fogColor)}},t.prototype.prepareDefines=function(e,i,r){var o=e.getScene();r.setValue("FOG",i.fogEnabled&&Ot.a.GetFogState(e,o))},t.prototype.bind=function(e,i,r){if(!!r){var o=r.getScene();e.setFloat4(this._fogParameters,o.fogMode,o.fogStart,o.fogEnd,o.fogDensity)}},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===oe.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration","//"+this.name,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});var i=e._getFreeVariableName("fog"),r=this.input,o=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");var a=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+=`#ifdef FOG\r
`,e.compilationString+="float "+i+" = CalcFogFactor("+this._fogDistanceName+", "+this._fogParameters+`);\r
`,e.compilationString+=this._declareOutput(a,e)+(" = "+i+" * "+r.associatedVariableName+".rgb + (1.0 - "+i+") * "+o.associatedVariableName+`.rgb;\r
`),e.compilationString+=`#else\r
`+this._declareOutput(a,e)+" =  "+r.associatedVariableName+`.rgb;\r
`,e.compilationString+=`#endif\r
`}else{var s=this.worldPosition,c=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=this._fogDistanceName+" = ("+c.associatedVariableName+" * "+s.associatedVariableName+`).xyz;\r
`}return this},t}(it);f.a.RegisteredTypes["BABYLON.FogBlock"]=Kc;var Qc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.VertexAndFragment)||this;return i._isUnique=!0,i.registerInput("worldPosition",K.Vector4,!1,oe.Vertex),i.registerInput("worldNormal",K.Vector4,!1,oe.Fragment),i.registerInput("cameraPosition",K.Vector3,!1,oe.Fragment),i.registerInput("glossiness",K.Float,!0,oe.Fragment),i.registerInput("glossPower",K.Float,!0,oe.Fragment),i.registerInput("diffuseColor",K.Color3,!0,oe.Fragment),i.registerInput("specularColor",K.Color3,!0,oe.Fragment),i.registerInput("view",K.Matrix,!0),i.registerOutput("diffuseOutput",K.Color3,oe.Fragment),i.registerOutput("specularOutput",K.Color3,oe.Fragment),i.registerOutput("shadow",K.Float,oe.Fragment),i}return t.prototype.getClassName=function(){return"LightBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glossiness",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glossPower",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"specularColor",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseOutput",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"specularOutput",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var i=e.getInputBlockByPredicate(function(r){return r.systemValue===dt.CameraPosition});i||(i=new yt("cameraPosition"),i.setAsSystemValue(dt.CameraPosition)),i.output.connectTo(this.cameraPosition)}},t.prototype.prepareDefines=function(e,i,r){if(!!r._areLightsDirty){var o=e.getScene();if(!this.light)Ot.a.PrepareDefinesForLights(o,e,r,!0,i.maxSimultaneousLights);else{var a={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Ot.a.PrepareDefinesForLight(o,e,this.light,this._lightId,r,!0,a),a.needRebuild&&r.rebuild()}}},t.prototype.updateUniformsAndSamples=function(e,i,r,o){for(var a=0;a<i.maxSimultaneousLights&&r["LIGHT"+a];a++){var s=e.uniforms.indexOf("vLightData"+a)>=0;Ot.a.PrepareUniformsAndSamplersForLight(a,e.uniforms,e.samplers,r["PROJECTEDLIGHTTEXTURE"+a],o,s)}},t.prototype.bind=function(e,i,r){if(!!r){var o=r.getScene();this.light?Ot.a.BindLight(this.light,this._lightId,o,e,!0):Ot.a.BindLights(o,r,e,!0,i.maxSimultaneousLights)}},t.prototype._injectVertexCode=function(e){var i=this.worldPosition,r="//"+this.name;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));var o="v_"+i.associatedVariableName;e._emitVaryingFromString(o,"vec4")&&(e.compilationString+=o+" = "+i.associatedVariableName+`;\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:i.associatedVariableName}]}):(e.compilationString+="vec4 worldPos = "+i.associatedVariableName+`;\r
`,this.view.isConnected&&(e.compilationString+="mat4 view = "+this.view.associatedVariableName+`;\r
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==oe.Fragment){this._injectVertexCode(e);return}e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);var i="//"+this.name,r=this.worldPosition;e._emitFunctionFromInclude("helperFunctions",i),e._emitFunctionFromInclude("lightsFragmentFunctions",i,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+r.associatedVariableName+".xyz"}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",i,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+r.associatedVariableName+".xyz"}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+="vec3 viewDirectionW = normalize("+this.cameraPosition.associatedVariableName+" - "+("v_"+r.associatedVariableName)+`.xyz);\r
`),e.compilationString+=`lightingInfo info;\r
`,e.compilationString+=`float shadow = 1.;\r
`,e.compilationString+="float glossiness = "+(this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0")+" * "+(this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0")+`;\r
`,e.compilationString+=`vec3 diffuseBase = vec3(0., 0., 0.);\r
`,e.compilationString+=`vec3 specularBase = vec3(0., 0., 0.);\r
`,e.compilationString+="vec3 normalW = "+this.worldNormal.associatedVariableName+`.xyz;\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",i,{repeatKey:"maxSimultaneousLights"});var o=this.diffuseOutput,a=this.specularOutput;return e.compilationString+=this._declareOutput(o,e)+(" = diffuseBase"+(this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:"")+`;\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+(" = specularBase"+(this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:"")+`;\r
`)),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+` = shadow;\r
`),this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),e.lightId&&(this.light=i.getLightByID(e.lightId))},t}(it);f.a.RegisteredTypes["BABYLON.LightBlock"]=Qc;var Zc=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i=!1);var r=n.call(this,e,i?oe.Fragment:oe.VertexAndFragment)||this;return r.convertToGammaSpace=!1,r.convertToLinearSpace=!1,r._fragmentOnly=i,r.registerInput("uv",K.Vector2,!1,oe.VertexAndFragment),r.registerOutput("rgba",K.Color4,oe.Neutral),r.registerOutput("rgb",K.Color3,oe.Neutral),r.registerOutput("r",K.Float,oe.Neutral),r.registerOutput("g",K.Float,oe.Neutral),r.registerOutput("b",K.Float,oe.Neutral),r.registerOutput("a",K.Float,oe.Neutral),r._inputs[0].acceptedConnectionPointTypes.push(K.Vector3),r._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),r._inputs[0]._prioritizeVertex=!i,r}return Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},set:function(e){var i=this,r;if(this._texture!==e){var o=(r=e==null?void 0:e.getScene())!==null&&r!==void 0?r:W.a.LastCreatedScene;!e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(i._texture)}),this._texture=e,e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(e)})}},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"TextureBlock"},Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){if(this._fragmentOnly)return oe.Fragment;if(!this.uv.isConnected||this.uv.sourceBlock.isInput)return oe.VertexAndFragment;for(var e=this.uv.connectedPoint;e;){if(e.target===oe.Fragment)return oe.Fragment;if(e.target===oe.Vertex)return oe.VertexAndFragment;if(e.target===oe.Neutral||e.target===oe.VertexAndFragment){var i=e.ownerBlock;if(i.target===oe.Fragment)return oe.Fragment;e=null;for(var r=0,o=i.inputs;r<o.length;r++){var a=o[r];if(a.connectedPoint){e=a.connectedPoint;break}}}}return oe.VertexAndFragment},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.uv.isConnected)if(e.mode===Ki.PostProcess){var i=e.getBlockByPredicate(function(o){return o.name==="uv"});i&&i.connectTo(this)}else{var r=e.mode===Ki.Particle?"particle_uv":"uv",i=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name===r});i||(i=new yt("uv"),i.setAsAttribute(r)),i.output.connectTo(this.uv)}},t.prototype.initializeDefines=function(e,i,r,o){o===void 0&&(o=!1),!!r._areTexturesDirty&&r.setValue(this._mainUVDefineName,!1)},t.prototype.prepareDefines=function(e,i,r){if(!!r._areTexturesDirty){if(!this.texture||!this.texture.getTextureMatrix){r.setValue(this._defineName,!1),r.setValue(this._mainUVDefineName,!0);return}r.setValue(this._linearDefineName,this.convertToGammaSpace),r.setValue(this._gammaDefineName,this.convertToLinearSpace),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(r.setValue(this._defineName,!1),r.setValue(this._mainUVDefineName,!0)):r.setValue(this._defineName,!0))}},t.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},t.prototype.bind=function(e,i,r){!this.texture||(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),e.setTexture(this._samplerName,this.texture))},Object.defineProperty(t.prototype,"_isMixed",{get:function(){return this.target!==oe.Fragment},enumerable:!1,configurable:!0}),t.prototype._injectVertexCode=function(e){var i=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+i.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+i.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+="#ifdef "+this._defineName+`\r
`,e.compilationString+=this._transformedUVName+" = vec2("+this._textureTransformName+" * vec4("+i.associatedVariableName+`.xy, 1.0, 0.0));\r
`,e.compilationString+="#elif defined("+this._mainUVDefineName+`)\r
`,e.compilationString+=this._mainUVName+" = "+i.associatedVariableName+`.xy;\r
`,e.compilationString+=`#endif\r
`,!!this._outputs.some(function(s){return s.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&this._writeOutput(e,a,a.name,!0)}}},t.prototype._writeTextureRead=function(e,i){i===void 0&&(i=!1);var r=this.uv;if(i){if(e.target===oe.Fragment)return;e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+r.associatedVariableName+`);\r
`;return}if(this.uv.ownerBlock.target===oe.Fragment){e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+r.associatedVariableName+`);\r
`;return}e.compilationString+="#ifdef "+this._defineName+`\r
`,e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+this._transformedUVName+`);\r
`,e.compilationString+="#elif defined("+this._mainUVDefineName+`)\r
`,e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+this._mainUVName+`);\r
`,e.compilationString+=`#endif\r
`},t.prototype._generateConversionCode=function(e,i,r){r!=="a"&&(e.compilationString+="#ifdef "+this._linearDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toGammaSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef "+this._gammaDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toLinearSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`)},t.prototype._writeOutput=function(e,i,r,o){if(o===void 0&&(o=!1),o){if(e.target===oe.Fragment)return;e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`,this._generateConversionCode(e,i,r);return}if(this.uv.ownerBlock.target===oe.Fragment){e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`,this._generateConversionCode(e,i,r);return}var a=" * "+this._textureInfoName;e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+a+`;\r
`,this._generateConversionCode(e,i,r)},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),(e.target===oe.Vertex||this._fragmentOnly||e.target===oe.Fragment&&this._tempTextureRead===void 0)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===oe.Fragment||this._isMixed&&e.target===oe.Vertex)&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==oe.Fragment){this._injectVertexCode(e);return}if(!!this._outputs.some(function(s){return s.isConnectedInFragmentShader})){this._isMixed&&e._emit2DSampler(this._samplerName);var i="//"+this.name;e._emitFunctionFromInclude("helperFunctions",i),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(var r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&this._writeOutput(e,a,a.name)}return this}},t.prototype._dumpPropertiesCode=function(){if(!this.texture)return"";var e=this._codeVariableName+'.texture = new BABYLON.Texture("'+this.texture.name+'", null, '+this.texture.noMipmap+", "+this.texture.invertY+`);\r
`;return e+=this._codeVariableName+".texture.wrapU = "+this.texture.wrapU+`;\r
`,e+=this._codeVariableName+".texture.wrapV = "+this.texture.wrapV+`;\r
`,e+=this._codeVariableName+".texture.uAng = "+this.texture.uAng+`;\r
`,e+=this._codeVariableName+".texture.vAng = "+this.texture.vAng+`;\r
`,e+=this._codeVariableName+".texture.wAng = "+this.texture.wAng+`;\r
`,e+=this._codeVariableName+".texture.uOffset = "+this.texture.uOffset+`;\r
`,e+=this._codeVariableName+".texture.vOffset = "+this.texture.vOffset+`;\r
`,e+=this._codeVariableName+".texture.uScale = "+this.texture.uScale+`;\r
`,e+=this._codeVariableName+".texture.vScale = "+this.texture.vScale+`;\r
`,e+=this._codeVariableName+".texture.coordinatesMode = "+this.texture.coordinatesMode+`;\r
`,e+=this._codeVariableName+".convertToGammaSpace = "+this.convertToGammaSpace+`;\r
`,e+=this._codeVariableName+".convertToLinearSpace = "+this.convertToLinearSpace+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,e.texture&&!oa.IgnoreTexturesAtLoadTime&&(r=e.texture.url.indexOf("data:")===0?"":r,this.texture=Ze.a.Parse(e.texture,i,r))},t}(it);f.a.RegisteredTypes["BABYLON.TextureBlock"]=Zc;var ks=function(n){Object(h.d)(t,n);function t(e){return n.call(this,e,oe.VertexAndFragment)||this}return Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},set:function(e){var i=this,r;if(this._texture!==e){var o=(r=e==null?void 0:e.getScene())!==null&&r!==void 0?r:W.a.LastCreatedScene;!e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(i._texture)}),this._texture=e,e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(e)})}},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"ReflectionTextureBaseBlock"},t.prototype._getTexture=function(){return this.texture},t.prototype.autoConfigure=function(e){if(!this.position.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="position"});i||(i=new yt("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){var r=e.getInputBlockByPredicate(function(a){return a.systemValue===dt.World});r||(r=new yt("world"),r.setAsSystemValue(dt.World)),r.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){var o=e.getInputBlockByPredicate(function(a){return a.systemValue===dt.View});o||(o=new yt("view"),o.setAsSystemValue(dt.View)),o.output.connectTo(this.view)}},t.prototype.prepareDefines=function(e,i,r){if(!!r._areTexturesDirty){var o=this._getTexture();!o||!o.getTextureMatrix||(r.setValue(this._define3DName,o.isCube,!0),r.setValue(this._defineLocalCubicName,!!o.boundingBoxSize,!0),r.setValue(this._defineExplicitName,o.coordinatesMode===0,!0),r.setValue(this._defineSkyboxName,o.coordinatesMode===5,!0),r.setValue(this._defineCubicName,o.coordinatesMode===3||o.coordinatesMode===6,!0),r.setValue("INVERTCUBICMAP",o.coordinatesMode===6,!0),r.setValue(this._defineSphericalName,o.coordinatesMode===1,!0),r.setValue(this._definePlanarName,o.coordinatesMode===2,!0),r.setValue(this._defineProjectionName,o.coordinatesMode===4,!0),r.setValue(this._defineEquirectangularName,o.coordinatesMode===7,!0),r.setValue(this._defineEquirectangularFixedName,o.coordinatesMode===8,!0),r.setValue(this._defineMirroredEquirectangularFixedName,o.coordinatesMode===9,!0))}},t.prototype.isReady=function(){var e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())},t.prototype.bind=function(e,i,r){var o=this._getTexture();!r||!o||(e.setMatrix(this._reflectionMatrixName,o.getReflectionTextureMatrix()),o.isCube?e.setTexture(this._cubeSamplerName,o):e.setTexture(this._2DSamplerName,o))},t.prototype.handleVertexSide=function(e){this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");var i="",r="v_"+this.worldPosition.associatedVariableName;return e._emitVaryingFromString(r,"vec4")&&(i+=r+" = "+this.worldPosition.associatedVariableName+`;\r
`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName)&&(i+="#ifdef "+this._defineSkyboxName+`\r
`,i+=this._positionUVWName+" = "+this.position.associatedVariableName+`.xyz;\r
`,i+=`#endif\r
`),e._emitVaryingFromString(this._directionWName,"vec3","defined("+this._defineEquirectangularFixedName+") || defined("+this._defineMirroredEquirectangularFixedName+")")&&(i+="#if defined("+this._defineEquirectangularFixedName+") || defined("+this._defineMirroredEquirectangularFixedName+`)\r
`,i+=this._directionWName+" = normalize(vec3("+this.world.associatedVariableName+" * vec4("+this.position.associatedVariableName+`.xyz, 0.0)));\r
`,i+=`#endif\r
`),i},t.prototype.handleFragmentSideInits=function(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+="#ifdef "+this._define3DName+`\r
`,e._samplerDeclaration+="uniform samplerCube "+this._cubeSamplerName+`;\r
`,e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+="uniform sampler2D "+this._2DSamplerName+`;\r
`,e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);var i="//"+this.name;e._emitFunction("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),e._emitFunctionFromInclude("reflectionFunction",i,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords")},t.prototype.handleFragmentSideCodeReflectionCoords=function(e,i,r){r===void 0&&(r=!1),i||(i="v_"+this.worldPosition.associatedVariableName);var o=this._reflectionMatrixName,a="normalize("+this._directionWName+")",s=""+this._positionUVWName,c=""+this.cameraPosition.associatedVariableName,v=""+this.view.associatedVariableName;e+=".xyz";var b=`
            #ifdef `+this._defineMirroredEquirectangularFixedName+`
                vec3 `+this._reflectionVectorName+" = computeMirroredFixedEquirectangularCoords("+i+", "+e+", "+a+`);
            #endif

            #ifdef `+this._defineEquirectangularFixedName+`
                vec3 `+this._reflectionVectorName+" = computeFixedEquirectangularCoords("+i+", "+e+", "+a+`);
            #endif

            #ifdef `+this._defineEquirectangularName+`
                vec3 `+this._reflectionVectorName+" = computeEquirectangularCoords("+i+", "+e+", "+c+".xyz, "+o+`);
            #endif

            #ifdef `+this._defineSphericalName+`
                vec3 `+this._reflectionVectorName+" = computeSphericalCoords("+i+", "+e+", "+v+", "+o+`);
            #endif

            #ifdef `+this._definePlanarName+`
                vec3 `+this._reflectionVectorName+" = computePlanarCoords("+i+", "+e+", "+c+".xyz, "+o+`);
            #endif

            #ifdef `+this._defineCubicName+`
                #ifdef `+this._defineLocalCubicName+`
                    vec3 `+this._reflectionVectorName+" = computeCubicLocalCoords("+i+", "+e+", "+c+".xyz, "+o+`, vReflectionSize, vReflectionPosition);
                #else
                vec3 `+this._reflectionVectorName+" = computeCubicCoords("+i+", "+e+", "+c+".xyz, "+o+`);
                #endif
            #endif

            #ifdef `+this._defineProjectionName+`
                vec3 `+this._reflectionVectorName+" = computeProjectionCoords("+i+", "+v+", "+o+`);
            #endif

            #ifdef `+this._defineSkyboxName+`
                vec3 `+this._reflectionVectorName+" = computeSkyBoxCoords("+s+", "+o+`);
            #endif

            #ifdef `+this._defineExplicitName+`
                vec3 `+this._reflectionVectorName+` = vec3(0, 0, 0);
            #endif

            #ifdef `+this._defineOppositeZ+`
                `+this._reflectionVectorName+`.z *= -1.0;
            #endif\r
`;return r||(b+=`
                #ifdef `+this._define3DName+`
                    vec3 `+this._reflectionCoordsName+" = "+this._reflectionVectorName+`;
                #else
                    vec2 `+this._reflectionCoordsName+" = "+this._reflectionVectorName+`.xy;
                    #ifdef `+this._defineProjectionName+`
                        `+this._reflectionCoordsName+" /= "+this._reflectionVectorName+`.z;
                    #endif
                    `+this._reflectionCoordsName+".y = 1.0 - "+this._reflectionCoordsName+`.y;
                #endif\r
`),b},t.prototype.handleFragmentSideCodeReflectionColor=function(e,i){i===void 0&&(i=".rgb");var r="vec"+(i.length===0?"4":i.length-1),o=r+" "+this._reflectionColorName+`;
            #ifdef `+this._define3DName+`\r
`;return e?o+=this._reflectionColorName+" = textureCubeLodEXT("+this._cubeSamplerName+", "+this._reflectionVectorName+", "+e+")"+i+`;\r
`:o+=this._reflectionColorName+" = textureCube("+this._cubeSamplerName+", "+this._reflectionVectorName+")"+i+`;\r
`,o+=`
            #else\r
`,e?o+=this._reflectionColorName+" = texture2DLodEXT("+this._2DSamplerName+", "+this._reflectionCoordsName+", "+e+")"+i+`;\r
`:o+=this._reflectionColorName+" = texture2D("+this._2DSamplerName+", "+this._reflectionCoordsName+")"+i+`;\r
`,o+=`#endif\r
`,o},t.prototype.writeOutputs=function(e,i){var r="";if(e.target===oe.Fragment)for(var o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&(r+=this._declareOutput(s,e)+" = "+i+"."+s.name+`;\r
`)}return r},t.prototype._buildBlock=function(e){return n.prototype._buildBlock.call(this,e),this},t.prototype._dumpPropertiesCode=function(){if(!this.texture)return"";var e;if(this.texture.isCube){var i=this.texture.forcedExtension;e=this._codeVariableName+'.texture = new BABYLON.CubeTexture("'+this.texture.name+'", undefined, undefined, '+this.texture.noMipmap+", null, undefined, undefined, undefined, "+this.texture._prefiltered+", "+(i?'"'+i+'"':"null")+`);\r
`}else e=this._codeVariableName+'.texture = new BABYLON.Texture("'+this.texture.name+`", null);\r
`;return e+=this._codeVariableName+".texture.coordinatesMode = "+this.texture.coordinatesMode+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),e.texture&&(r=e.texture.url.indexOf("data:")===0?"":r,e.texture.isCube?this.texture=pn.a.Parse(e.texture,i,r):this.texture=Ze.a.Parse(e.texture,i,r))},t}(it);f.a.RegisteredTypes["BABYLON.ReflectionTextureBaseBlock"]=ks;var Jc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.registerInput("position",K.Vector3,!1,oe.Vertex),i.registerInput("worldPosition",K.Vector4,!1,oe.Vertex),i.registerInput("worldNormal",K.Vector4,!1,oe.Fragment),i.registerInput("world",K.Matrix,!1,oe.Vertex),i.registerInput("cameraPosition",K.Vector3,!1,oe.Fragment),i.registerInput("view",K.Matrix,!1,oe.Fragment),i.registerOutput("rgb",K.Color3,oe.Fragment),i.registerOutput("rgba",K.Color4,oe.Fragment),i.registerOutput("r",K.Float,oe.Fragment),i.registerOutput("g",K.Float,oe.Fragment),i.registerOutput("b",K.Float,oe.Fragment),i.registerOutput("a",K.Float,oe.Fragment),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),i}return t.prototype.getClassName=function(){return"ReflectionTextureBlock"},Object.defineProperty(t.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(n.prototype.autoConfigure.call(this,e),!this.cameraPosition.isConnected){var i=e.getInputBlockByPredicate(function(r){return r.systemValue===dt.CameraPosition});i||(i=new yt("cameraPosition"),i.setAsSystemValue(dt.CameraPosition)),i.output.connectTo(this.cameraPosition)}},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec3(0.)"),this;if(e.target!==oe.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.handleFragmentSideInits(e);var i=e._getFreeVariableName("normalWUnit");return e.compilationString+="vec4 "+i+" = normalize("+this.worldNormal.associatedVariableName+`);\r
`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(i),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this},t}(ks);f.a.RegisteredTypes["BABYLON.ReflectionTextureBlock"]=Jc;var $c=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"AddBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.left.associatedVariableName+" + "+this.right.associatedVariableName+`;\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.AddBlock"]=$c;var qc=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("input",K.AutoDetect),i.registerInput("factor",K.Float),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"ScaleBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"factor",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.input.associatedVariableName+" * "+this.factor.associatedVariableName+`;\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.ScaleBlock"]=qc;var ef=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.minimum=0,i.maximum=1,i.registerInput("value",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"ClampBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = clamp("+this.value.associatedVariableName+", "+this._writeFloat(this.minimum)+", "+this._writeFloat(this.maximum)+`);\r
`),this},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".minimum = "+this.minimum+`;\r
`;return e+=this._codeVariableName+".maximum = "+this.maximum+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.minimum=this.minimum,e.maximum=this.maximum,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.minimum=e.minimum,this.maximum=e.maximum},Object(h.c)([It("Minimum",Mt.Float)],t.prototype,"minimum",void 0),Object(h.c)([It("Maximum",Mt.Float)],t.prototype,"maximum",void 0),t}(it);f.a.RegisteredTypes["BABYLON.ClampBlock"]=ef;var tf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.Vector3),i._linkConnectionTypes(0,1),i._inputs[0].excludedConnectionPointTypes.push(K.Float),i._inputs[0].excludedConnectionPointTypes.push(K.Matrix),i._inputs[0].excludedConnectionPointTypes.push(K.Vector2),i._inputs[1].excludedConnectionPointTypes.push(K.Float),i._inputs[1].excludedConnectionPointTypes.push(K.Matrix),i._inputs[1].excludedConnectionPointTypes.push(K.Vector2),i}return t.prototype.getClassName=function(){return"CrossBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = cross("+this.left.associatedVariableName+".xyz, "+this.right.associatedVariableName+`.xyz);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.CrossBlock"]=tf;var rf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.Float),i._linkConnectionTypes(0,1),i._inputs[0].excludedConnectionPointTypes.push(K.Float),i._inputs[0].excludedConnectionPointTypes.push(K.Matrix),i._inputs[1].excludedConnectionPointTypes.push(K.Float),i._inputs[1].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"DotBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = dot("+this.left.associatedVariableName+", "+this.right.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.DotBlock"]=rf;var nf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("input",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._inputs[0].excludedConnectionPointTypes.push(K.Float),i._inputs[0].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"NormalizeBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this._inputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = normalize("+r.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.NormalizeBlock"]=nf;var of=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("rgb ",K.Color3,!0),i.registerInput("r",K.Float,!0),i.registerInput("g",K.Float,!0),i.registerInput("b",K.Float,!0),i.registerInput("a",K.Float,!0),i.registerOutput("rgba",K.Color4),i.registerOutput("rgb",K.Color3),i}return t.prototype.getClassName=function(){return"ColorMergerBlock"},Object.defineProperty(t.prototype,"rgbIn",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgbOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this.rgbOut},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.r,r=this.g,o=this.b,a=this.a,s=this.rgbIn,c=this._outputs[0],v=this._outputs[1];return s.isConnected?c.hasEndpoints?e.compilationString+=this._declareOutput(c,e)+(" = vec4("+s.associatedVariableName+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):v.hasEndpoints&&(e.compilationString+=this._declareOutput(v,e)+(" = "+s.associatedVariableName+`;\r
`)):c.hasEndpoints?e.compilationString+=this._declareOutput(c,e)+(" = vec4("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+", "+(o.isConnected?this._writeVariable(o):"0.0")+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):v.hasEndpoints&&(e.compilationString+=this._declareOutput(v,e)+(" = vec3("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+", "+(o.isConnected?this._writeVariable(o):"0.0")+`);\r
`)),this},t}(it);f.a.RegisteredTypes["BABYLON.ColorMergerBlock"]=of;var af=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("xyzw",K.Vector4,!0),i.registerInput("xyz ",K.Vector3,!0),i.registerInput("xy ",K.Vector2,!0),i.registerOutput("xyz",K.Vector3),i.registerOutput("xy",K.Vector2),i.registerOutput("x",K.Float),i.registerOutput("y",K.Float),i.registerOutput("z",K.Float),i.registerOutput("w",K.Float),i.inputsAreExclusive=!0,i}return t.prototype.getClassName=function(){return"VectorSplitterBlock"},Object.defineProperty(t.prototype,"xyzw",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyIn",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzOut",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"w",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),t.prototype._inputRename=function(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}},t.prototype._outputRename=function(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,r=this._outputs[0],o=this._outputs[1],a=this._outputs[2],s=this._outputs[3],c=this._outputs[4],v=this._outputs[5];return r.hasEndpoints&&(i===this.xyIn?e.compilationString+=this._declareOutput(r,e)+(" = vec3("+i.associatedVariableName+`, 0.0);\r
`):e.compilationString+=this._declareOutput(r,e)+(" = "+i.associatedVariableName+`.xyz;\r
`)),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+(" = "+i.associatedVariableName+`.xy;\r
`)),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+(" = "+i.associatedVariableName+`.x;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+(" = "+i.associatedVariableName+`.y;\r
`)),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+(" = "+i.associatedVariableName+`.z;\r
`)),v.hasEndpoints&&(e.compilationString+=this._declareOutput(v,e)+(" = "+i.associatedVariableName+`.w;\r
`)),this},t}(it);f.a.RegisteredTypes["BABYLON.VectorSplitterBlock"]=af;var sf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerInput("gradient",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i._linkConnectionTypes(1,2,!0),i._inputs[2].acceptedConnectionPointTypes.push(K.Float),i}return t.prototype.getClassName=function(){return"LerpBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gradient",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = mix("+this.left.associatedVariableName+" , "+this.right.associatedVariableName+", "+this.gradient.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.LerpBlock"]=sf;var lf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"DivideBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.left.associatedVariableName+" / "+this.right.associatedVariableName+`;\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.DivideBlock"]=lf;var uf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"SubtractBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.left.associatedVariableName+" - "+this.right.associatedVariableName+`;\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.SubtractBlock"]=uf;var cf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("value",K.Float),i.registerInput("edge",K.Float),i.registerOutput("output",K.Float),i}return t.prototype.getClassName=function(){return"StepBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"edge",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = step("+this.edge.associatedVariableName+", "+this.value.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.StepBlock"]=cf;var Xs=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("input",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._outputs[0].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"OneMinusBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = 1. - "+this.input.associatedVariableName+`;\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.OneMinusBlock"]=Xs,f.a.RegisteredTypes["BABYLON.OppositeBlock"]=Xs;var Ys=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("worldPosition",K.Vector4),i.registerInput("cameraPosition",K.Vector3),i.registerOutput("output",K.Vector3),i}return t.prototype.getClassName=function(){return"ViewDirectionBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var i=e.getInputBlockByPredicate(function(r){return r.systemValue===dt.CameraPosition});i||(i=new yt("cameraPosition"),i.setAsSystemValue(dt.CameraPosition)),i.output.connectTo(this.cameraPosition)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = normalize("+this.cameraPosition.associatedVariableName+" - "+this.worldPosition.associatedVariableName+`.xyz);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.ViewDirectionBlock"]=Ys;var ay=u(762),ff=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("worldNormal",K.Vector4),i.registerInput("viewDirection",K.Vector3),i.registerInput("bias",K.Float),i.registerInput("power",K.Float),i.registerOutput("fresnel",K.Float),i}return t.prototype.getClassName=function(){return"FresnelBlock"},Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewDirection",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bias",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"power",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fresnel",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.viewDirection.isConnected){var i=new Ys("View direction");i.output.connectTo(this.viewDirection),i.autoConfigure(e)}if(!this.bias.isConnected){var r=new yt("bias");r.value=0,r.output.connectTo(this.bias)}if(!this.power.isConnected){var o=new yt("power");o.value=1,o.output.connectTo(this.power)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i="//"+this.name;return e._emitFunctionFromInclude("fresnelFunction",i,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+(" = computeFresnelTerm("+this.viewDirection.associatedVariableName+".xyz, "+this.worldNormal.associatedVariableName+".xyz, "+this.bias.associatedVariableName+", "+this.power.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.FresnelBlock"]=ff;var hf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"MaxBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = max("+this.left.associatedVariableName+", "+this.right.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.MaxBlock"]=hf;var df=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"MinBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = min("+this.left.associatedVariableName+", "+this.right.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.MinBlock"]=df;var pf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.Float),i._linkConnectionTypes(0,1),i._inputs[0].excludedConnectionPointTypes.push(K.Float),i._inputs[0].excludedConnectionPointTypes.push(K.Matrix),i._inputs[1].excludedConnectionPointTypes.push(K.Float),i._inputs[1].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"DistanceBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = length("+this.left.associatedVariableName+" - "+this.right.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.DistanceBlock"]=pf;var gf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("value",K.AutoDetect),i.registerOutput("output",K.Float),i._inputs[0].excludedConnectionPointTypes.push(K.Float),i._inputs[0].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"LengthBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = length("+this.value.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.LengthBlock"]=gf;var mf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("value",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"NegateBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = -1.0 * "+this.value.associatedVariableName+`;\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.NegateBlock"]=mf;var vf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("value",K.AutoDetect),i.registerInput("power",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"PowBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"power",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = pow("+this.value.associatedVariableName+", "+this.power.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.PowBlock"]=vf;var _f=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("seed",K.Vector2),i.registerOutput("output",K.Float),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),i._inputs[0].acceptedConnectionPointTypes.push(K.Color3),i._inputs[0].acceptedConnectionPointTypes.push(K.Color4),i}return t.prototype.getClassName=function(){return"RandomNumberBlock"},Object.defineProperty(t.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r="//"+this.name;return e._emitFunctionFromInclude("helperFunctions",r),e.compilationString+=this._declareOutput(i,e)+(" = getRand("+this.seed.associatedVariableName+`.xy);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.RandomNumberBlock"]=_f;var yf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("x",K.Float),i.registerInput("y",K.Float),i.registerOutput("output",K.Float),i}return t.prototype.getClassName=function(){return"ArcTan2Block"},Object.defineProperty(t.prototype,"x",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = atan("+this.x.associatedVariableName+", "+this.y.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.ArcTan2Block"]=yf;var bf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("value",K.AutoDetect),i.registerInput("edge0",K.Float),i.registerInput("edge1",K.Float),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"SmoothStepBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"edge0",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"edge1",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = smoothstep("+this.edge0.associatedVariableName+", "+this.edge1.associatedVariableName+", "+this.value.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.SmoothStepBlock"]=bf;var Ef=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("input",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._outputs[0].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"ReciprocalBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = 1. / "+this.input.associatedVariableName+`;\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.ReciprocalBlock"]=Ef;var Pf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("value",K.AutoDetect),i.registerInput("reference",K.AutoDetect),i.registerInput("distance",K.Float),i.registerInput("replacement",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i._linkConnectionTypes(0,3),i._inputs[0].excludedConnectionPointTypes.push(K.Float),i._inputs[0].excludedConnectionPointTypes.push(K.Matrix),i._inputs[1].excludedConnectionPointTypes.push(K.Float),i._inputs[1].excludedConnectionPointTypes.push(K.Matrix),i._inputs[3].excludedConnectionPointTypes.push(K.Float),i._inputs[3].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"ReplaceColorBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reference",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"distance",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"replacement",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+`;\r
`,e.compilationString+="if (length("+this.value.associatedVariableName+" - "+this.reference.associatedVariableName+") < "+this.distance.associatedVariableName+`) {\r
`,e.compilationString+=i.associatedVariableName+" = "+this.replacement.associatedVariableName+`;\r
`,e.compilationString+=`} else {\r
`,e.compilationString+=i.associatedVariableName+" = "+this.value.associatedVariableName+`;\r
`,e.compilationString+=`}\r
`,this},t}(it);f.a.RegisteredTypes["BABYLON.ReplaceColorBlock"]=Pf;var Cf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("value",K.AutoDetect),i.registerInput("steps",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i._inputs[0].excludedConnectionPointTypes.push(K.Matrix),i._inputs[1].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"PosterizeBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"steps",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = floor("+this.value.associatedVariableName+" / (1.0 / "+this.steps.associatedVariableName+")) * (1.0 / "+this.steps.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.PosterizeBlock"]=Cf;var gn;(function(n){n[n.SawTooth=0]="SawTooth",n[n.Square=1]="Square",n[n.Triangle=2]="Triangle"})(gn||(gn={}));var Sf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.kind=gn.SawTooth,i.registerInput("input",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._inputs[0].excludedConnectionPointTypes.push(K.Matrix),i}return t.prototype.getClassName=function(){return"WaveBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];switch(this.kind){case gn.SawTooth:{e.compilationString+=this._declareOutput(i,e)+(" = "+this.input.associatedVariableName+" - floor(0.5 + "+this.input.associatedVariableName+`);\r
`);break}case gn.Square:{e.compilationString+=this._declareOutput(i,e)+(" = 1.0 - 2.0 * round(fract("+this.input.associatedVariableName+`));\r
`);break}case gn.Triangle:{e.compilationString+=this._declareOutput(i,e)+(" = 2.0 * abs(2.0 * ("+this.input.associatedVariableName+" - floor(0.5 + "+this.input.associatedVariableName+`))) - 1.0;\r
`);break}}return this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.kind=this.kind,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.kind=e.kind},t}(it);f.a.RegisteredTypes["BABYLON.WaveBlock"]=Sf;var aa=function(){function n(t,e){this.step=t,this.color=e}return Object.defineProperty(n.prototype,"step",{get:function(){return this._step},set:function(t){this._step=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!1,configurable:!0}),n}(),Tf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.colorSteps=[new aa(0,m.a.Black()),new aa(1,m.a.White())],i.onValueChangedObservable=new _.c,i.registerInput("gradient",K.Float),i.registerOutput("output",K.Color3),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector2),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),i._inputs[0].acceptedConnectionPointTypes.push(K.Color3),i._inputs[0].acceptedConnectionPointTypes.push(K.Color4),i}return t.prototype.colorStepsUpdated=function(){this.onValueChangedObservable.notifyObservers(this)},t.prototype.getClassName=function(){return"GradientBlock"},Object.defineProperty(t.prototype,"gradient",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._writeColorConstant=function(e){var i=this.colorSteps[e];return"vec3("+i.color.r+", "+i.color.g+", "+i.color.b+")"},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=this._declareOutput(i,e)+` = vec3(0., 0., 0.);\r
`;return}var r=e._getFreeVariableName("gradientTempColor"),o=e._getFreeVariableName("gradientTempPosition");e.compilationString+="vec3 "+r+" = "+this._writeColorConstant(0)+`;\r
`,e.compilationString+="float "+o+`;\r
`;var a=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==K.Float&&(a+=".x");for(var s=1;s<this.colorSteps.length;s++){var c=this.colorSteps[s],v=this.colorSteps[s-1];e.compilationString+=o+" = clamp(("+a+" - "+e._emitFloat(v.step)+") / ("+e._emitFloat(c.step)+" -  "+e._emitFloat(v.step)+"), 0.0, 1.0) * step("+e._emitFloat(s)+", "+e._emitFloat(this.colorSteps.length-1)+`);\r
`,e.compilationString+=r+" = mix("+r+", "+this._writeColorConstant(s)+", "+o+`);\r
`}return e.compilationString+=this._declareOutput(i,e)+(" = "+r+`;\r
`),this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);e.colorSteps=[];for(var i=0,r=this.colorSteps;i<r.length;i++){var o=r[i];e.colorSteps.push({step:o.step,color:{r:o.color.r,g:o.color.g,b:o.color.b}})}return e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.colorSteps=[];for(var o=0,a=e.colorSteps;o<a.length;o++){var s=a[o];this.colorSteps.push(new aa(s.step,new m.a(s.color.r,s.color.g,s.color.b)))}},t.prototype._dumpPropertiesCode=function(){var e="";e+=this._codeVariableName+`.colorSteps = [];\r
`;for(var i=0,r=this.colorSteps;i<r.length;i++){var o=r[i];e+=this._codeVariableName+".colorSteps.push(new BABYLON.GradientBlockColorStep("+o.step+", new BABYLON.Color3("+o.color.r+", "+o.color.g+", "+o.color.b+`)));\r
`}return e},t}(it);f.a.RegisteredTypes["BABYLON.GradientBlock"]=Tf;var Rf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerInput("gradient",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i._linkConnectionTypes(1,2,!0),i._inputs[2].acceptedConnectionPointTypes.push(K.Float),i}return t.prototype.getClassName=function(){return"NLerpBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gradient",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = normalize(mix("+this.left.associatedVariableName+" , "+this.right.associatedVariableName+", "+this.gradient.associatedVariableName+`));\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.NLerpBlock"]=Rf;var Af=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.manhattanDistance=!1,i.registerInput("seed",K.Vector3),i.registerInput("jitter",K.Float),i.registerOutput("output",K.Vector2),i}return t.prototype.getClassName=function(){return"WorleyNoise3DBlock"},Object.defineProperty(t.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"jitter",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!!this._outputs[0].hasEndpoints){var i=`vec3 permute(vec3 x){\r
`;return i+=`    return mod((34.0 * x + 1.0) * x, 289.0);\r
`,i+=`}\r
\r
`,i+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r
`,i+=`    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r
`,i+=`}\r
\r
`,i+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r
`,i+=`    float K = 0.142857142857; // 1/7\r
`,i+=`    float Ko = 0.428571428571; // 1/2-K/2\r
`,i+=`    float  K2 = 0.020408163265306; // 1/(7*7)\r
`,i+=`    float Kz = 0.166666666667; // 1/6\r
`,i+=`    float Kzo = 0.416666666667; // 1/2-1/6*2\r
`,i+=`\r
`,i+=`    vec3 Pi = mod(floor(P), 289.0);\r
`,i+=`    vec3 Pf = fract(P) - 0.5;\r
`,i+=`\r
`,i+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r
`,i+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r
`,i+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r
`,i+=`\r
`,i+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r
`,i+=`    vec3 p1 = permute(p + Pi.y - 1.0);\r
`,i+=`    vec3 p2 = permute(p + Pi.y);\r
`,i+=`    vec3 p3 = permute(p + Pi.y + 1.0);\r
`,i+=`\r
`,i+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);\r
`,i+=`    vec3 p12 = permute(p1 + Pi.z);\r
`,i+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);\r
`,i+=`\r
`,i+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);\r
`,i+=`    vec3 p22 = permute(p2 + Pi.z);\r
`,i+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);\r
`,i+=`\r
`,i+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);\r
`,i+=`    vec3 p32 = permute(p3 + Pi.z);\r
`,i+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);\r
`,i+=`\r
`,i+=`    vec3 ox11 = fract(p11*K) - Ko;\r
`,i+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r
`,i+=`\r
`,i+=`    vec3 ox12 = fract(p12*K) - Ko;\r
`,i+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox13 = fract(p13*K) - Ko;\r
`,i+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox21 = fract(p21*K) - Ko;\r
`,i+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox22 = fract(p22*K) - Ko;\r
`,i+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox23 = fract(p23*K) - Ko;\r
`,i+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox31 = fract(p31*K) - Ko;\r
`,i+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox32 = fract(p32*K) - Ko;\r
`,i+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox33 = fract(p33*K) - Ko;\r
`,i+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 dx11 = Pfx + jitter*ox11;\r
`,i+=`    vec3 dy11 = Pfy.x + jitter*oy11;\r
`,i+=`    vec3 dz11 = Pfz.x + jitter*oz11;\r
`,i+=`\r
`,i+=`    vec3 dx12 = Pfx + jitter*ox12;\r
`,i+=`    vec3 dy12 = Pfy.x + jitter*oy12;\r
`,i+=`    vec3 dz12 = Pfz.y + jitter*oz12;\r
`,i+=`\r
`,i+=`    vec3 dx13 = Pfx + jitter*ox13;\r
`,i+=`    vec3 dy13 = Pfy.x + jitter*oy13;\r
`,i+=`    vec3 dz13 = Pfz.z + jitter*oz13;\r
`,i+=`\r
`,i+=`    vec3 dx21 = Pfx + jitter*ox21;\r
`,i+=`    vec3 dy21 = Pfy.y + jitter*oy21;\r
`,i+=`    vec3 dz21 = Pfz.x + jitter*oz21;\r
`,i+=`\r
`,i+=`    vec3 dx22 = Pfx + jitter*ox22;\r
`,i+=`    vec3 dy22 = Pfy.y + jitter*oy22;\r
`,i+=`    vec3 dz22 = Pfz.y + jitter*oz22;\r
`,i+=`\r
`,i+=`    vec3 dx23 = Pfx + jitter*ox23;\r
`,i+=`    vec3 dy23 = Pfy.y + jitter*oy23;\r
`,i+=`    vec3 dz23 = Pfz.z + jitter*oz23;\r
`,i+=`\r
`,i+=`    vec3 dx31 = Pfx + jitter*ox31;\r
`,i+=`    vec3 dy31 = Pfy.z + jitter*oy31;\r
`,i+=`    vec3 dz31 = Pfz.x + jitter*oz31;\r
`,i+=`\r
`,i+=`    vec3 dx32 = Pfx + jitter*ox32;\r
`,i+=`    vec3 dy32 = Pfy.z + jitter*oy32;\r
`,i+=`    vec3 dz32 = Pfz.y + jitter*oz32;\r
`,i+=`\r
`,i+=`    vec3 dx33 = Pfx + jitter*ox33;\r
`,i+=`    vec3 dy33 = Pfy.z + jitter*oy33;\r
`,i+=`    vec3 dz33 = Pfz.z + jitter*oz33;\r
`,i+=`\r
`,i+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r
`,i+=`    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r
`,i+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r
`,i+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r
`,i+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r
`,i+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r
`,i+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r
`,i+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r
`,i+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r
`,i+=`\r
`,i+=`    vec3 d1a = min(d11, d12);\r
`,i+=`    d12 = max(d11, d12);\r
`,i+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r
`,i+=`    d13 = max(d1a, d13);\r
`,i+=`    d12 = min(d12, d13); // 2nd smallest now not in d13\r
`,i+=`    vec3 d2a = min(d21, d22);\r
`,i+=`    d22 = max(d21, d22);\r
`,i+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r
`,i+=`    d23 = max(d2a, d23);\r
`,i+=`    d22 = min(d22, d23); // 2nd smallest now not in d23\r
`,i+=`    vec3 d3a = min(d31, d32);\r
`,i+=`    d32 = max(d31, d32);\r
`,i+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r
`,i+=`    d33 = max(d3a, d33);\r
`,i+=`    d32 = min(d32, d33); // 2nd smallest now not in d33\r
`,i+=`    vec3 da = min(d11, d21);\r
`,i+=`    d21 = max(d11, d21);\r
`,i+=`    d11 = min(da, d31); // Smallest now in d11\r
`,i+=`    d31 = max(da, d31); // 2nd smallest now not in d31\r
`,i+=`    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r
`,i+=`    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r
`,i+=`    d12 = min(d12, d21); // 2nd smallest now not in d21\r
`,i+=`    d12 = min(d12, d22); // nor in d22\r
`,i+=`    d12 = min(d12, d31); // nor in d31\r
`,i+=`    d12 = min(d12, d32); // nor in d32\r
`,i+=`    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r
`,i+=`    d11.y = min(d11.y,d12.z); // Only two more to go\r
`,i+=`    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r
`,i+=`    return sqrt(d11.xy); // F1, F2\r
`,i+=`}\r
\r
`,e._emitFunction("worley3D",i,"// Worley3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+(" = worley("+this.seed.associatedVariableName+", "+this.jitter.associatedVariableName+", "+this.manhattanDistance+`);\r
`),this}},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".manhattanDistance = "+this.manhattanDistance+`;\r
`;return e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.manhattanDistance=this.manhattanDistance,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.manhattanDistance=e.manhattanDistance},Object(h.c)([It("Use Manhattan Distance",Mt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],t.prototype,"manhattanDistance",void 0),t}(it);f.a.RegisteredTypes["BABYLON.WorleyNoise3DBlock"]=Af;var Of=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("seed",K.Vector3),i.registerOutput("output",K.Float),i}return t.prototype.getClassName=function(){return"SimplexPerlin3DBlock"},Object.defineProperty(t.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!!this._outputs[0].hasEndpoints){var i=`const float SKEWFACTOR = 1.0/3.0;\r
`;return i+=`const float UNSKEWFACTOR = 1.0/6.0;\r
`,i+=`const float SIMPLEX_CORNER_POS = 0.5;\r
`,i+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r
`,i+=`float SimplexPerlin3D( vec3 P ){\r
`,i+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r
`,i+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",i+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r
`,i+=`    vec3 g = step(x0.yzx, x0.xyz);\r
`,i+=`    vec3 l = 1.0 - g;\r
`,i+=`    vec3 Pi_1 = min( g.xyz, l.zxy );\r
`,i+=`    vec3 Pi_2 = max( g.xyz, l.zxy );\r
`,i+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r
`,i+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r
`,i+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r
`,i+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r
`,i+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r
`,i+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r
`,i+=`    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r
`,i+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r
`,i+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r
`,i+=`    Pt *= Pt;\r
`,i+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r
`,i+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r
`,i+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r
`,i+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r
`,i+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r
`,i+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r
`,i+=`    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,i+=`    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,i+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r
`,i+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r
`,i+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r
`,i+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r
`,i+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r
`,i+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r
`,i+=`    kernel_weights = max(0.5 - kernel_weights, 0.0);\r
`,i+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r
`,i+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r
`,i+=`}\r
`,e._emitFunction("SimplexPerlin3D",i,"// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+(" = SimplexPerlin3D("+this.seed.associatedVariableName+`);\r
`),this}},t}(it);f.a.RegisteredTypes["BABYLON.SimplexPerlin3DBlock"]=Of;var Mf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("normalMap0",K.Vector3),i.registerInput("normalMap1",K.Vector3),i.registerOutput("output",K.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(K.Color3),i._inputs[0].acceptedConnectionPointTypes.push(K.Color4),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),i._inputs[1].acceptedConnectionPointTypes.push(K.Color3),i._inputs[1].acceptedConnectionPointTypes.push(K.Color4),i._inputs[1].acceptedConnectionPointTypes.push(K.Vector4),i}return t.prototype.getClassName=function(){return"NormalBlendBlock"},Object.defineProperty(t.prototype,"normalMap0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalMap1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this._inputs[0],o=this._inputs[1],a=e._getFreeVariableName("stepR"),s=e._getFreeVariableName("stepG");return e.compilationString+="float "+a+" = step(0.5, "+r.associatedVariableName+`.r);\r
`,e.compilationString+="float "+s+" = step(0.5, "+r.associatedVariableName+`.g);\r
`,e.compilationString+=this._declareOutput(i,e)+`;\r
`,e.compilationString+=i.associatedVariableName+".r = (1.0 - "+a+") * "+r.associatedVariableName+".r * "+o.associatedVariableName+".r * 2.0 + "+a+" * (1.0 - "+r.associatedVariableName+".r) * (1.0 - "+o.associatedVariableName+`.r) * 2.0;\r
`,e.compilationString+=i.associatedVariableName+".g = (1.0 - "+s+") * "+r.associatedVariableName+".g * "+o.associatedVariableName+".g * 2.0 + "+s+" * (1.0 - "+r.associatedVariableName+".g) * (1.0 - "+o.associatedVariableName+`.g) * 2.0;\r
`,e.compilationString+=i.associatedVariableName+".b = "+r.associatedVariableName+".b * "+o.associatedVariableName+`.b;\r
`,this},t}(it);f.a.RegisteredTypes["BABYLON.NormalBlendBlock"]=Mf;var xf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("input",K.Vector2),i.registerInput("angle",K.Float),i.registerOutput("output",K.Vector2),i}return t.prototype.getClassName=function(){return"Rotate2dBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"angle",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.angle.isConnected){var i=new yt("angle");i.value=0,i.output.connectTo(this.angle)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this.angle,o=this.input;return e.compilationString+=this._declareOutput(i,e)+(" = vec2(cos("+r.associatedVariableName+") * "+o.associatedVariableName+".x - sin("+r.associatedVariableName+") * "+o.associatedVariableName+".y, sin("+r.associatedVariableName+") * "+o.associatedVariableName+".x + cos("+r.associatedVariableName+") * "+o.associatedVariableName+`.y);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.Rotate2dBlock"]=xf;var Df=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("incident",K.Vector3),i.registerInput("normal",K.Vector3),i.registerOutput("output",K.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),i._inputs[0].acceptedConnectionPointTypes.push(K.Color3),i._inputs[0].acceptedConnectionPointTypes.push(K.Color4),i._inputs[1].acceptedConnectionPointTypes.push(K.Vector4),i._inputs[1].acceptedConnectionPointTypes.push(K.Color3),i._inputs[1].acceptedConnectionPointTypes.push(K.Color4),i}return t.prototype.getClassName=function(){return"ReflectBlock"},Object.defineProperty(t.prototype,"incident",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = reflect("+this.incident.associatedVariableName+".xyz, "+this.normal.associatedVariableName+`.xyz);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.ReflectBlock"]=Df;var If=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("incident",K.Vector3),i.registerInput("normal",K.Vector3),i.registerInput("ior",K.Float),i.registerOutput("output",K.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(K.Vector4),i._inputs[0].acceptedConnectionPointTypes.push(K.Color3),i._inputs[0].acceptedConnectionPointTypes.push(K.Color4),i._inputs[1].acceptedConnectionPointTypes.push(K.Vector4),i._inputs[1].acceptedConnectionPointTypes.push(K.Color3),i._inputs[1].acceptedConnectionPointTypes.push(K.Color4),i}return t.prototype.getClassName=function(){return"RefractBlock"},Object.defineProperty(t.prototype,"incident",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ior",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = refract("+this.incident.associatedVariableName+".xyz, "+this.normal.associatedVariableName+".xyz, "+this.ior.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.RefractBlock"]=If;var Lf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("color",K.Color3),i.registerInput("level",K.Float),i.registerOutput("output",K.Color3),i}return t.prototype.getClassName=function(){return"DesaturateBlock"},Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"level",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this.color,o=r.associatedVariableName,a=e._getFreeVariableName("colorMin"),s=e._getFreeVariableName("colorMax"),c=e._getFreeVariableName("colorMerge");return e.compilationString+="float "+a+" = min(min("+o+".x, "+o+".y), "+o+`.z);\r
`,e.compilationString+="float "+s+" = max(max("+o+".x, "+o+".y), "+o+`.z);\r
`,e.compilationString+="float "+c+" = 0.5 * ("+a+" + "+s+`);\r
`,e.compilationString+=this._declareOutput(i,e)+(" = mix("+o+", vec3("+c+", "+c+", "+c+"), "+this.level.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.DesaturateBlock"]=Lf;var yr=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,i,r)||this;return c._blockType=o,c._blockName=a,c._nameForCheking=s,c._nameForCheking||(c._nameForCheking=e),c.needDualDirectionValidation=!0,c}return t.prototype.checkCompatibilityState=function(e){return e instanceof t&&e.name===this._nameForCheking?_r.Compatible:_r.TypeIncompatible},t.prototype.createCustomInputBlock=function(){return[new this._blockType(this._blockName),this.name]},t}(ea),Ks=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i.albedoScaling=!1,i.linkSheenWithAlbedo=!1,i._isUnique=!0,i.registerInput("intensity",K.Float,!0,oe.Fragment),i.registerInput("color",K.Color3,!0,oe.Fragment),i.registerInput("roughness",K.Float,!0,oe.Fragment),i.registerOutput("sheen",K.Object,oe.Fragment,new yr("sheen",i,Ni.Output,t,"SheenBlock")),i}return t.prototype.initialize=function(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")},t.prototype.getClassName=function(){return"SheenBlock"},Object.defineProperty(t.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"roughness",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sheen",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r),r.setValue("SHEEN",!0),r.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),r.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),r.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),r.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)},t.prototype.getCode=function(e){var i="",r=this.color.isConnected?this.color.associatedVariableName:"vec3(1.)",o=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",a=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",s="vec4(0.)";return i=`#ifdef SHEEN
            sheenOutParams sheenOut;

            vec4 vSheenColor = vec4(`+r+", "+o+`);

            sheenBlock(
                vSheenColor,
            #ifdef SHEEN_ROUGHNESS
                `+a+`,
            #endif
                roughness,
            #ifdef SHEEN_TEXTURE
                `+s+`,
            #endif
                reflectance,
            #ifdef SHEEN_LINKWITHALBEDO
                baseColor,
                surfaceAlbedo,
            #endif
            #ifdef ENVIRONMENTBRDF
                NdotV,
                environmentBrdf,
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                AARoughnessFactors,
                `+(e==null?void 0:e._vReflectionMicrosurfaceInfosName)+`,
                `+(e==null?void 0:e._vReflectionInfosName)+`,
                `+(e==null?void 0:e.reflectionColor)+`,
                vLightingIntensity,
                #ifdef `+(e==null?void 0:e._define3DName)+`
                    `+(e==null?void 0:e._cubeSamplerName)+`,
                #else
                    `+(e==null?void 0:e._2DSamplerName)+`,
                #endif
                reflectionOut.reflectionCoords,
                NdotVUnclamped,
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `+(e==null?void 0:e._define3DName)+`
                        `+(e==null?void 0:e._cubeSamplerName)+`,
                        `+(e==null?void 0:e._cubeSamplerName)+`,
                    #else
                        `+(e==null?void 0:e._2DSamplerName)+`,
                        `+(e==null?void 0:e._2DSamplerName)+`,
                    #endif
                #endif
                #if !defined(`+(e==null?void 0:e._defineSkyboxName)+`) && defined(RADIANCEOCCLUSION)
                    seo,
                #endif
                #if !defined(`+(e==null?void 0:e._defineSkyboxName)+") && defined(HORIZONOCCLUSION) && defined(BUMP) && defined("+(e==null?void 0:e._define3DName)+`)
                    eho,
                #endif
            #endif
                sheenOut
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif\r
`,i},t.prototype._buildBlock=function(e){return e.target===oe.Fragment&&e.sharedData.blocksWithDefines.push(this),this},t.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+=this._codeVariableName+".albedoScaling = "+this.albedoScaling+`;\r
`,e+=this._codeVariableName+".linkSheenWithAlbedo = "+this.linkSheenWithAlbedo+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo},Object(h.c)([It("Albedo scaling",Mt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],t.prototype,"albedoScaling",void 0),Object(h.c)([It("Link sheen with albedo",Mt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],t.prototype,"linkSheenWithAlbedo",void 0),t}(it);f.a.RegisteredTypes["BABYLON.SheenBlock"]=Ks;var Ff=u(514),Qs=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i._isUnique=!0,i.registerInput("intensity",K.Float,!0,oe.Fragment),i.registerInput("direction",K.Vector2,!0,oe.Fragment),i.registerInput("uv",K.Vector2,!0),i.registerInput("worldTangent",K.Vector4,!0),i.registerOutput("anisotropy",K.Object,oe.Fragment,new yr("anisotropy",i,Ni.Output,t,"AnisotropyBlock")),i}return t.prototype.initialize=function(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")},t.prototype.getClassName=function(){return"AnisotropyBlock"},Object.defineProperty(t.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldTangent",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"anisotropy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._generateTBNSpace=function(e){var i="",r="//"+this.name,o=this.uv,a=this.worldPositionConnectionPoint,s=this.worldNormalConnectionPoint,c=this.worldTangent;o.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var v={search:/defined\(TANGENT\)/g,replace:c.isConnected?"defined(TANGENT)":"defined(IGNORE)"};return c.isConnected&&(i+="vec3 tbnNormal = normalize("+s.associatedVariableName+`.xyz);\r
`,i+="vec3 tbnTangent = normalize("+c.associatedVariableName+`.xyz);\r
`,i+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,i+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),i+=`
            #if defined(`+(c.isConnected?"TANGENT":"IGNORE")+`) && defined(NORMAL)
                mat3 TBN = vTBN;
            #else
                mat3 TBN = cotangent_frame(`+(s.associatedVariableName+".xyz")+", "+("v_"+a.associatedVariableName+".xyz")+", "+(o.isConnected?o.associatedVariableName:"vec2(0.)")+`, vec2(1., 1.));
            #endif\r
`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",r,{replaceStrings:[v]}),i},t.prototype.getCode=function(e,i){i===void 0&&(i=!1);var r="";i&&(r+=this._generateTBNSpace(e));var o=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",a=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)";return r+=`anisotropicOutParams anisotropicOut;
            anisotropicBlock(
                vec3(`+a+", "+o+`),
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW,
                anisotropicOut
            );\r
`,r},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r),r.setValue("ANISOTROPIC",!0),r.setValue("ANISOTROPIC_TEXTURE",!1,!0)},t.prototype._buildBlock=function(e){return e.target===oe.Fragment&&e.sharedData.blocksWithDefines.push(this),this},t}(it);f.a.RegisteredTypes["BABYLON.AnisotropyBlock"]=Qs;var Zs=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.useSphericalHarmonics=!0,i.forceIrradianceInFragment=!1,i._isUnique=!0,i.registerInput("position",K.Vector3,!1,oe.Vertex),i.registerInput("world",K.Matrix,!1,oe.Vertex),i.registerInput("color",K.Color3,!0,oe.Fragment),i.registerOutput("reflection",K.Object,oe.Fragment,new yr("reflection",i,Ni.Output,t,"ReflectionBlock")),i}return t.prototype.getClassName=function(){return"ReflectionBlock"},Object.defineProperty(t.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this.worldPositionConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this.worldNormalConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this.cameraPositionConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this.viewConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflection",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasTexture",{get:function(){return!!this._getTexture()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflectionColor",{get:function(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"},enumerable:!1,configurable:!0}),t.prototype._getTexture=function(){return this.texture?this.texture:this._scene.environmentTexture},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r);var o=this._getTexture(),a=o&&o.getTextureMatrix;r.setValue("REFLECTION",a,!0),!!a&&(r.setValue(this._defineLODReflectionAlpha,o.lodLevelInAlpha,!0),r.setValue(this._defineLinearSpecularReflection,o.linearSpecularLOD,!0),r.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!o.invertZ:o.invertZ,!0),r.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),r.setValue("GAMMAREFLECTION",o.gammaSpace,!0),r.setValue("RGBDREFLECTION",o.isRGBD,!0),o&&o.coordinatesMode!==Ze.a.SKYBOX_MODE&&o.isCube&&(r.setValue("USESPHERICALFROMREFLECTIONMAP",!0),r.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?r.setValue("USESPHERICALINVERTEX",!1):r.setValue("USESPHERICALINVERTEX",!0)))},t.prototype.bind=function(e,i,r,o){n.prototype.bind.call(this,e,i,r);var a=this._getTexture();if(!(!a||!o)){a.isCube?e.setTexture(this._cubeSamplerName,a):e.setTexture(this._2DSamplerName,a);var s=a.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,s,a.lodGenerationScale,a.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,s,$e.a.Log2(s));var c=o._materialDefines,v=a.sphericalPolynomial;if(c.USESPHERICALFROMREFLECTIONMAP&&v)if(c.SPHERICAL_HARMONICS){var b=v.preScaledHarmonics;e.setVector3("vSphericalL00",b.l00),e.setVector3("vSphericalL1_1",b.l1_1),e.setVector3("vSphericalL10",b.l10),e.setVector3("vSphericalL11",b.l11),e.setVector3("vSphericalL2_2",b.l2_2),e.setVector3("vSphericalL2_1",b.l2_1),e.setVector3("vSphericalL20",b.l20),e.setVector3("vSphericalL21",b.l21),e.setVector3("vSphericalL22",b.l22)}else e.setFloat3("vSphericalX",v.x.x,v.x.y,v.x.z),e.setFloat3("vSphericalY",v.y.x,v.y.y,v.y.z),e.setFloat3("vSphericalZ",v.z.x,v.z.y,v.z.z),e.setFloat3("vSphericalXX_ZZ",v.xx.x-v.zz.x,v.xx.y-v.zz.y,v.xx.z-v.zz.z),e.setFloat3("vSphericalYY_ZZ",v.yy.x-v.zz.x,v.yy.y-v.zz.y,v.yy.z-v.zz.z),e.setFloat3("vSphericalZZ",v.zz.x,v.zz.y,v.zz.z),e.setFloat3("vSphericalXY",v.xy.x,v.xy.y,v.xy.z),e.setFloat3("vSphericalYZ",v.yz.x,v.yz.y,v.yz.z),e.setFloat3("vSphericalZX",v.zx.x,v.zx.y,v.zx.z)}},t.prototype.handleVertexSide=function(e){var i=n.prototype.handleVertexSide.call(this,e);e._emitFunctionFromInclude("harmonicsFunctions","//"+this.name,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});var r=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),i+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                vec3 `+r+" = vec3("+this._reflectionMatrixName+" * vec4(normalize("+this.worldNormal.associatedVariableName+`).xyz, 0)).xyz;
                #ifdef `+this._defineOppositeZ+`
                    `+r+`.z *= -1.0;
                #endif
                `+this._vEnvironmentIrradianceName+" = computeEnvironmentIrradiance("+r+`);
            #endif\r
`,i},t.prototype.getCode=function(e,i){var r="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions","//"+this.name,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`
            #ifdef `+this._define3DName+`
                #define sampleReflection(s, c) textureCube(s, c)
            #else
                #define sampleReflection(s, c) texture2D(s, c)
            #endif\r
`,"//"+this.name),e._emitFunction("sampleReflectionLod",`
            #ifdef `+this._define3DName+`
                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`,"//"+this.name);var o=`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                `+this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0)+`
                return `+this._reflectionVectorName+`;
            }\r
`;return e._emitFunction("computeReflectionCoordsPBR",o,"//"+this.name),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),r+=`#ifdef REFLECTION
            vec2 `+this._vReflectionInfosName+` = vec2(1., 0.);

            reflectionOutParams reflectionOut;

            reflectionBlock(
                `+("v_"+this.worldPosition.associatedVariableName+".xyz")+`,
                `+i+`,
                alphaG,
                `+this._vReflectionMicrosurfaceInfosName+`,
                `+this._vReflectionInfosName+`,
                `+this.reflectionColor+`,
            #ifdef ANISOTROPIC
                anisotropicOut,
            #endif
            #if defined(`+this._defineLODReflectionAlpha+") && !defined("+this._defineSkyboxName+`)
                NdotVUnclamped,
            #endif
            #ifdef `+this._defineLinearSpecularReflection+`
                roughness,
            #endif
            #ifdef `+this._define3DName+`
                `+this._cubeSamplerName+`,
            #else
                `+this._2DSamplerName+`,
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                `+this._vEnvironmentIrradianceName+`,
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    `+this._reflectionMatrixName+`,
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                irradianceSampler, // ** not handled **
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef `+this._define3DName+`
                    `+this._cubeSamplerName+`,
                    `+this._cubeSamplerName+`,
                #else
                    `+this._2DSamplerName+`,
                    `+this._2DSamplerName+`,
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                `+this._vReflectionFilteringInfoName+`,
            #endif
                reflectionOut
            );
        #endif\r
`,r},t.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,e.target!==oe.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this},t.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return this.texture&&(e+=this._codeVariableName+".texture.gammaSpace = "+this.texture.gammaSpace+`;\r
`),e+=this._codeVariableName+".useSphericalHarmonics = "+this.useSphericalHarmonics+`;\r
`,e+=this._codeVariableName+".forceIrradianceInFragment = "+this.forceIrradianceInFragment+`;\r
`,e},t.prototype.serialize=function(){var e,i,r=n.prototype.serialize.call(this);return r.useSphericalHarmonics=this.useSphericalHarmonics,r.forceIrradianceInFragment=this.forceIrradianceInFragment,r.gammaSpace=(i=(e=this.texture)===null||e===void 0?void 0:e.gammaSpace)!==null&&i!==void 0?i:!0,r},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)},Object(h.c)([It("Spherical Harmonics",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"useSphericalHarmonics",void 0),Object(h.c)([It("Force irradiance in fragment",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"forceIrradianceInFragment",void 0),t}(ks);f.a.RegisteredTypes["BABYLON.ReflectionBlock"]=Zs;var Bf=u(626),sa=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i.remapF0OnInterfaceChange=!0,i._isUnique=!0,i.registerInput("intensity",K.Float,!1,oe.Fragment),i.registerInput("roughness",K.Float,!0,oe.Fragment),i.registerInput("indexOfRefraction",K.Float,!0,oe.Fragment),i.registerInput("normalMapColor",K.Color3,!0,oe.Fragment),i.registerInput("uv",K.Vector2,!0,oe.Fragment),i.registerInput("tintColor",K.Color3,!0,oe.Fragment),i.registerInput("tintAtDistance",K.Float,!0,oe.Fragment),i.registerInput("tintThickness",K.Float,!0,oe.Fragment),i.registerInput("worldTangent",K.Vector4,!0),i.registerOutput("clearcoat",K.Object,oe.Fragment,new yr("clearcoat",i,Ni.Output,t,"ClearCoatBlock")),i}return t.prototype.initialize=function(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams")},t.prototype.getClassName=function(){return"ClearCoatBlock"},Object.defineProperty(t.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"roughness",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"indexOfRefraction",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalMapColor",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintAtDistance",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintThickness",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldTangent",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clearcoat",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.intensity.isConnected){var i=new yt("ClearCoat intensity",oe.Fragment,K.Float);i.value=1,i.output.connectTo(this.intensity)}},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r),r.setValue("CLEARCOAT",!0),r.setValue("CLEARCOAT_TEXTURE",!1,!0),r.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),r.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),r.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),r.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===Bf.a._DefaultIndexOfRefraction:!0,!0),r.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)},t.prototype.bind=function(e,i,r,o){var a,s;n.prototype.bind.call(this,e,i,r);var c=(s=(a=this.indexOfRefraction.connectInputBlock)===null||a===void 0?void 0:a.value)!==null&&s!==void 0?s:Bf.a._DefaultIndexOfRefraction,v=1-c,b=1+c,C=Math.pow(-v/b,2),M=1/c;e.setFloat4("vClearCoatRefractionParams",C,M,v,b);var N=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,D=(N==null?void 0:N.perturbedNormal.isConnected)?N.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",(D==null?void 0:D.invertX)?1:-1,(D==null?void 0:D.invertY)?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",(D==null?void 0:D.invertX)?-1:1,(D==null?void 0:D.invertY)?-1:1)},t.prototype._generateTBNSpace=function(e,i,r){var o="",a="//"+this.name,s=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var c={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"};return s.isConnected&&(o+="vec3 tbnNormal = normalize("+r+`.xyz);\r
`,o+="vec3 tbnTangent = normalize("+s.associatedVariableName+`.xyz);\r
`,o+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,o+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",a,{replaceStrings:[c]}),o},t.GetCode=function(e,i,r,o,a,s,c){var v="",b=(i==null?void 0:i.intensity.isConnected)?i.intensity.associatedVariableName:"1.",C=(i==null?void 0:i.roughness.isConnected)?i.roughness.associatedVariableName:"0.",M=(i==null?void 0:i.normalMapColor.isConnected)?i.normalMapColor.associatedVariableName:"vec3(0.)",N=(i==null?void 0:i.uv.isConnected)?i.uv.associatedVariableName:"vec2(0.)",D=(i==null?void 0:i.tintColor.isConnected)?i.tintColor.associatedVariableName:"vec3(1.)",V=(i==null?void 0:i.tintThickness.isConnected)?i.tintThickness.associatedVariableName:"1.",X=(i==null?void 0:i.tintAtDistance.isConnected)?i.tintAtDistance.associatedVariableName:"1.",ee="vec4(0.)";return i&&(e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2")),a&&i&&(v+=i._generateTBNSpace(e,o,c),s=i.worldTangent.isConnected),v+=`clearcoatOutParams clearcoatOut;

        #ifdef CLEARCOAT
            vec2 vClearCoatParams = vec2(`+b+", "+C+`);
            vec4 vClearCoatTintParams = vec4(`+D+", "+V+`);

            clearcoatBlock(
                `+o+`.xyz,
                geometricNormalW,
                viewDirectionW,
                vClearCoatParams,
                specularEnvironmentR0,
            #ifdef CLEARCOAT_TEXTURE
                vec2(0.),
            #endif
            #ifdef CLEARCOAT_TINT
                vClearCoatTintParams,
                `+X+`,
                vClearCoatRefractionParams,
                #ifdef CLEARCOAT_TINT_TEXTURE
                    `+ee+`,
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                vec2(0., 1.),
                vec4(`+M+`, 0.),
                `+N+`,
                #if defined(`+(s?"TANGENT":"IGNORE")+`) && defined(NORMAL)
                    vTBN,
                #else
                    vClearCoatTangentSpaceParams,
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    normalMatrix,
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                faceNormal,
            #endif
            #ifdef REFLECTION
                `+(r==null?void 0:r._vReflectionMicrosurfaceInfosName)+`,
                `+(r==null?void 0:r._vReflectionInfosName)+`,
                `+(r==null?void 0:r.reflectionColor)+`,
                vLightingIntensity,
                #ifdef `+(r==null?void 0:r._define3DName)+`
                    `+(r==null?void 0:r._cubeSamplerName)+`,
                #else
                    `+(r==null?void 0:r._2DSamplerName)+`,
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `+(r==null?void 0:r._define3DName)+`
                        `+(r==null?void 0:r._cubeSamplerName)+`,
                        `+(r==null?void 0:r._cubeSamplerName)+`,
                    #else
                        `+(r==null?void 0:r._2DSamplerName)+`,
                        `+(r==null?void 0:r._2DSamplerName)+`,
                    #endif
                #endif
            #endif
            #if defined(ENVIRONMENTBRDF) && !defined(`+(r==null?void 0:r._defineSkyboxName)+`)
                #ifdef RADIANCEOCCLUSION
                    ambientMonochrome,
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                (gl_FrontFacing ? 1. : -1.),
            #endif
                clearcoatOut
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif\r
`,v},t.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,e.target===oe.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this},t.prototype._dumpPropertiesCode=function(){var e="";return e+=this._codeVariableName+".remapF0OnInterfaceChange = "+this.remapF0OnInterfaceChange+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e},t.prototype._deserialize=function(e,i,r){var o;n.prototype._deserialize.call(this,e,i,r),this.remapF0OnInterfaceChange=(o=e.remapF0OnInterfaceChange)!==null&&o!==void 0?o:!0},Object(h.c)([It("Remap F0 on interface change",Mt.Boolean,"ADVANCED")],t.prototype,"remapF0OnInterfaceChange",void 0),t}(it);f.a.RegisteredTypes["BABYLON.ClearCoatBlock"]=sa;var Js=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i.linkRefractionWithTransparency=!1,i.invertRefractionY=!1,i._isUnique=!0,i.registerInput("intensity",K.Float,!1,oe.Fragment),i.registerInput("tintAtDistance",K.Float,!0,oe.Fragment),i.registerOutput("refraction",K.Object,oe.Fragment,new yr("refraction",i,Ni.Output,t,"RefractionBlock")),i}return t.prototype.getClassName=function(){return"RefractionBlock"},Object.defineProperty(t.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintAtDistance",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this.viewConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"refraction",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasTexture",{get:function(){return!!this._getTexture()},enumerable:!1,configurable:!0}),t.prototype._getTexture=function(){return this.texture?this.texture:this._scene.environmentTexture},t.prototype.autoConfigure=function(e){if(!this.intensity.isConnected){var i=new yt("Refraction intensity",oe.Fragment,K.Float);i.value=1,i.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){var r=e.getInputBlockByPredicate(function(o){return o.systemValue===dt.View});r||(r=new yt("view"),r.setAsSystemValue(dt.View)),r.output.connectTo(this.view)}},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r);var o=this._getTexture(),a=o&&o.getTextureMatrix;r.setValue("SS_REFRACTION",a,!0),!!a&&(r.setValue(this._define3DName,o.isCube,!0),r.setValue(this._defineLODRefractionAlpha,o.lodLevelInAlpha,!0),r.setValue(this._defineLinearSpecularRefraction,o.linearSpecularLOD,!0),r.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!o.invertZ:o.invertZ,!0),r.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),r.setValue("SS_GAMMAREFRACTION",o.gammaSpace,!0),r.setValue("SS_RGBDREFRACTION",o.isRGBD,!0))},t.prototype.isReady=function(){var e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())},t.prototype.bind=function(e,i,r,o){var a,s;n.prototype.bind.call(this,e,i,r);var c=this._getTexture();if(!!c){c.isCube?e.setTexture(this._cubeSamplerName,c):e.setTexture(this._2DSamplerName,c),e.setMatrix(this._refractionMatrixName,c.getReflectionTextureMatrix());var v=1;c.isCube||c.depth&&(v=c.depth);var b=(s=(a=this.indexOfRefractionConnectionPoint.connectInputBlock)===null||a===void 0?void 0:a.value)!==null&&s!==void 0?s:1.5;e.setFloat4(this._vRefractionInfosName,c.level,1/b,v,this.invertRefractionY?-1:1),e.setFloat3(this._vRefractionMicrosurfaceInfosName,c.getSize().width,c.lodGenerationScale,c.lodGenerationOffset);var C=c.getSize().width;e.setFloat2(this._vRefractionFilteringInfoName,C,$e.a.Log2(C))}},t.prototype.getCode=function(e){var i="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+="#ifdef "+this._define3DName+`\r
`,e._samplerDeclaration+="uniform samplerCube "+this._cubeSamplerName+`;\r
`,e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+="uniform sampler2D "+this._2DSamplerName+`;\r
`,e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`
            #ifdef `+this._define3DName+`
                #define sampleRefraction(s, c) textureCube(s, c)
            #else
                #define sampleRefraction(s, c) texture2D(s, c)
            #endif\r
`,"//"+this.name),e._emitFunction("sampleRefractionLod",`
            #ifdef `+this._define3DName+`
                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`,"//"+this.name),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec3"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),i},t.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,this},t.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return this.texture&&(this.texture.isCube?e=this._codeVariableName+'.texture = new BABYLON.CubeTexture("'+this.texture.name+`");\r
`:e=this._codeVariableName+'.texture = new BABYLON.Texture("'+this.texture.name+`");\r
`,e+=this._codeVariableName+".texture.coordinatesMode = "+this.texture.coordinatesMode+`;\r
`),e+=this._codeVariableName+".linkRefractionWithTransparency = "+this.linkRefractionWithTransparency+`;\r
`,e+=this._codeVariableName+".invertRefractionY = "+this.invertRefractionY+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),e.texture&&(r=e.texture.url.indexOf("data:")===0?"":r,e.texture.isCube?this.texture=pn.a.Parse(e.texture,i,r):this.texture=Ze.a.Parse(e.texture,i,r)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY},Object(h.c)([It("Link refraction to transparency",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"linkRefractionWithTransparency",void 0),Object(h.c)([It("Invert refraction Y",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"invertRefractionY",void 0),t}(it);f.a.RegisteredTypes["BABYLON.RefractionBlock"]=Js;var la=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Fragment)||this;return i._isUnique=!0,i.registerInput("thickness",K.Float,!1,oe.Fragment),i.registerInput("tintColor",K.Color3,!0,oe.Fragment),i.registerInput("translucencyIntensity",K.Float,!0,oe.Fragment),i.registerInput("translucencyDiffusionDist",K.Color3,!0,oe.Fragment),i.registerInput("refraction",K.Object,!0,oe.Fragment,new yr("refraction",i,Ni.Input,Js,"RefractionBlock")),i.registerOutput("subsurface",K.Object,oe.Fragment,new yr("subsurface",i,Ni.Output,t,"SubSurfaceBlock")),i}return t.prototype.initialize=function(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity")},t.prototype.getClassName=function(){return"SubSurfaceBlock"},Object.defineProperty(t.prototype,"thickness",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintColor",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"translucencyIntensity",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"translucencyDiffusionDist",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"refraction",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"subsurface",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.thickness.isConnected){var i=new yt("SubSurface thickness",oe.Fragment,K.Float);i.value=0,i.output.connectTo(this.thickness)}},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r);var o=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;r.setValue("SUBSURFACE",o||this.refraction.isConnected,!0),r.setValue("SS_TRANSLUCENCY",o,!0),r.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),r.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),r.setValue("SS_MASK_FROM_THICKNESS_TEXTURE_GLTF",!1,!0)},t.GetCode=function(e,i,r,o){var a,s,c,v,b,C,M,N,D,V,X,ee,ie,ge,pe,te,Ce="",Ae=(i==null?void 0:i.thickness.isConnected)?i.thickness.associatedVariableName:"0.",De=(i==null?void 0:i.tintColor.isConnected)?i.tintColor.associatedVariableName:"vec3(1.)",Fe=(i==null?void 0:i.translucencyIntensity.isConnected)?i==null?void 0:i.translucencyIntensity.associatedVariableName:"1.",We=(i==null?void 0:i.translucencyDiffusionDist.isConnected)?i==null?void 0:i.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",Pe=(i==null?void 0:i.refraction.isConnected)?(a=i==null?void 0:i.refraction.connectedPoint)===null||a===void 0?void 0:a.ownerBlock:null,Ne=(Pe==null?void 0:Pe.tintAtDistance.isConnected)?Pe.tintAtDistance.associatedVariableName:"1.",je=(Pe==null?void 0:Pe.intensity.isConnected)?Pe.intensity.associatedVariableName:"1.",Be=(Pe==null?void 0:Pe.view.isConnected)?Pe.view.associatedVariableName:"";return Ce+=(s=Pe==null?void 0:Pe.getCode(e))!==null&&s!==void 0?s:"",Ce+=`subSurfaceOutParams subSurfaceOut;

        #ifdef SUBSURFACE
            vec2 vThicknessParam = vec2(0., `+Ae+`);
            vec4 vTintColor = vec4(`+De+", "+Ne+`);
            vec3 vSubSurfaceIntensity = vec3(`+je+", "+Fe+`, 0.);

            subSurfaceBlock(
                vSubSurfaceIntensity,
                vThicknessParam,
                vTintColor,
                normalW,
                specularEnvironmentReflectance,
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                vec4(0.),
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    `+(r==null?void 0:r._reflectionMatrixName)+`,
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            reflectionOut.irradianceVector,
                        #endif
                        #if defined(REALTIME_FILTERING)
                            `+(r==null?void 0:r._cubeSamplerName)+`,
                            `+(r==null?void 0:r._vReflectionFilteringInfoName)+`,
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        irradianceSampler,
                    #endif
                #endif
            #endif
            #ifdef SS_REFRACTION
                `+o+`.xyz,
                viewDirectionW,
                `+Be+`,
                surfaceAlbedo,
                `+((c=Pe==null?void 0:Pe._vRefractionInfosName)!==null&&c!==void 0?c:"")+`,
                `+((v=Pe==null?void 0:Pe._refractionMatrixName)!==null&&v!==void 0?v:"")+`,
                `+((b=Pe==null?void 0:Pe._vRefractionMicrosurfaceInfosName)!==null&&b!==void 0?b:"")+`,
                vLightingIntensity,
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha,
                #endif
                #ifdef `+((C=Pe==null?void 0:Pe._defineLODRefractionAlpha)!==null&&C!==void 0?C:"IGNORE")+`
                    NdotVUnclamped,
                #endif
                #ifdef `+((M=Pe==null?void 0:Pe._defineLinearSpecularRefraction)!==null&&M!==void 0?M:"IGNORE")+`
                    roughness,
                #else
                    alphaG,
                #endif
                #ifdef `+((N=Pe==null?void 0:Pe._define3DName)!==null&&N!==void 0?N:"IGNORE")+`
                    `+((D=Pe==null?void 0:Pe._cubeSamplerName)!==null&&D!==void 0?D:"")+`,
                #else
                    `+((V=Pe==null?void 0:Pe._2DSamplerName)!==null&&V!==void 0?V:"")+`,
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `+((X=Pe==null?void 0:Pe._define3DName)!==null&&X!==void 0?X:"IGNORE")+`
                        `+((ee=Pe==null?void 0:Pe._cubeSamplerName)!==null&&ee!==void 0?ee:"")+`,
                        `+((ie=Pe==null?void 0:Pe._cubeSamplerName)!==null&&ie!==void 0?ie:"")+`,
                    #else
                        `+((ge=Pe==null?void 0:Pe._2DSamplerName)!==null&&ge!==void 0?ge:"")+`,
                        `+((pe=Pe==null?void 0:Pe._2DSamplerName)!==null&&pe!==void 0?pe:"")+`,
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    anisotropicOut,
                #endif
                #ifdef REALTIME_FILTERING
                    `+((te=Pe==null?void 0:Pe._vRefractionFilteringInfoName)!==null&&te!==void 0?te:"")+`,
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                `+We+`,
            #endif
                subSurfaceOut
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif\r
`,Ce},t.prototype._buildBlock=function(e){return e.target===oe.Fragment&&e.sharedData.blocksWithDefines.push(this),this},t}(it);f.a.RegisteredTypes["BABYLON.SubSurfaceBlock"]=la;var tm={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]},Nf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.VertexAndFragment)||this;return i._environmentBRDFTexture=null,i._metallicReflectanceColor=m.a.White(),i._metallicF0Factor=1,i.directIntensity=1,i.environmentIntensity=1,i.specularIntensity=1,i.lightFalloff=0,i.useAlphaTest=!1,i.alphaTestCutoff=.5,i.useAlphaBlending=!1,i.useRadianceOverAlpha=!0,i.useSpecularOverAlpha=!0,i.enableSpecularAntiAliasing=!1,i.realTimeFiltering=!1,i.realTimeFilteringQuality=8,i.useEnergyConservation=!0,i.useRadianceOcclusion=!0,i.useHorizonOcclusion=!0,i.unlit=!1,i.forceNormalForward=!1,i.debugMode=0,i.debugLimit=0,i.debugFactor=1,i._isUnique=!0,i.registerInput("worldPosition",K.Vector4,!1,oe.Vertex),i.registerInput("worldNormal",K.Vector4,!1,oe.Fragment),i.registerInput("view",K.Matrix,!1),i.registerInput("cameraPosition",K.Vector3,!1,oe.Fragment),i.registerInput("perturbedNormal",K.Vector4,!0,oe.Fragment),i.registerInput("baseColor",K.Color3,!0,oe.Fragment),i.registerInput("metallic",K.Float,!1,oe.Fragment),i.registerInput("roughness",K.Float,!1,oe.Fragment),i.registerInput("ambientOcc",K.Float,!0,oe.Fragment),i.registerInput("opacity",K.Float,!0,oe.Fragment),i.registerInput("indexOfRefraction",K.Float,!0,oe.Fragment),i.registerInput("ambientColor",K.Color3,!0,oe.Fragment),i.registerInput("reflection",K.Object,!0,oe.Fragment,new yr("reflection",i,Ni.Input,Zs,"ReflectionBlock")),i.registerInput("clearcoat",K.Object,!0,oe.Fragment,new yr("clearcoat",i,Ni.Input,sa,"ClearCoatBlock")),i.registerInput("sheen",K.Object,!0,oe.Fragment,new yr("sheen",i,Ni.Input,Ks,"SheenBlock")),i.registerInput("subsurface",K.Object,!0,oe.Fragment,new yr("subsurface",i,Ni.Input,la,"SubSurfaceBlock")),i.registerInput("anisotropy",K.Object,!0,oe.Fragment,new yr("anisotropy",i,Ni.Input,Qs,"AnisotropyBlock")),i.registerOutput("ambientClr",K.Color3,oe.Fragment),i.registerOutput("diffuseDir",K.Color3,oe.Fragment),i.registerOutput("specularDir",K.Color3,oe.Fragment),i.registerOutput("clearcoatDir",K.Color3,oe.Fragment),i.registerOutput("sheenDir",K.Color3,oe.Fragment),i.registerOutput("diffuseInd",K.Color3,oe.Fragment),i.registerOutput("specularInd",K.Color3,oe.Fragment),i.registerOutput("clearcoatInd",K.Color3,oe.Fragment),i.registerOutput("sheenInd",K.Color3,oe.Fragment),i.registerOutput("refraction",K.Color3,oe.Fragment),i.registerOutput("lighting",K.Color3,oe.Fragment),i.registerOutput("shadow",K.Float,oe.Fragment),i.registerOutput("alpha",K.Float,oe.Fragment),i}return t.prototype.initialize=function(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")},t.prototype.getClassName=function(){return"PBRMetallicRoughnessBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"perturbedNormal",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"baseColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"metallic",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"roughness",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ambientOcc",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"opacity",{get:function(){return this._inputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"indexOfRefraction",{get:function(){return this._inputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ambientColor",{get:function(){return this._inputs[11]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflection",{get:function(){return this._inputs[12]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clearcoat",{get:function(){return this._inputs[13]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sheen",{get:function(){return this._inputs[14]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"subsurface",{get:function(){return this._inputs[15]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"anisotropy",{get:function(){return this._inputs[16]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ambientClr",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseDir",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"specularDir",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clearcoatDir",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sheenDir",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseIndirect",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"specularIndirect",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clearcoatIndirect",{get:function(){return this._outputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sheenIndirect",{get:function(){return this._outputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"refraction",{get:function(){return this._outputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lighting",{get:function(){return this._outputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._outputs[11]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._outputs[12]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.systemValue===dt.CameraPosition});i||(i=new yt("cameraPosition"),i.setAsSystemValue(dt.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){var r=e.getInputBlockByPredicate(function(o){return o.systemValue===dt.View});r||(r=new yt("view"),r.setAsSystemValue(dt.View)),r.output.connectTo(this.view)}},t.prototype.prepareDefines=function(e,i,r){r.setValue("PBR",!0),r.setValue("METALLICWORKFLOW",!0),r.setValue("DEBUGMODE",this.debugMode,!0),r.setValue("NORMALXYSCALE",!0),r.setValue("BUMP",this.perturbedNormal.isConnected,!0),r.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),r.setValue("ALBEDO",!1,!0),r.setValue("OPACITY",this.opacity.isConnected,!0),r.setValue("AMBIENT",!0,!0),r.setValue("AMBIENTINGRAYSCALE",!1,!0),r.setValue("REFLECTIVITY",!1,!0),r.setValue("AOSTOREINMETALMAPRED",!1,!0),r.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),r.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),r.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===Hr.a.LIGHTFALLOFF_STANDARD?(r.setValue("USEPHYSICALLIGHTFALLOFF",!1),r.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===Hr.a.LIGHTFALLOFF_GLTF?(r.setValue("USEPHYSICALLIGHTFALLOFF",!1),r.setValue("USEGLTFLIGHTFALLOFF",!0)):(r.setValue("USEPHYSICALLIGHTFALLOFF",!0),r.setValue("USEGLTFLIGHTFALLOFF",!1));var o=this.alphaTestCutoff.toString();r.setValue("ALPHABLEND",this.useAlphaBlending,!0),r.setValue("ALPHAFROMALBEDO",!1,!0),r.setValue("ALPHATEST",this.useAlphaTest,!0),r.setValue("ALPHATESTVALUE",o.indexOf(".")<0?o+".":o,!0),r.setValue("OPACITYRGB",!1,!0),r.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),r.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),r.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),r.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);var a=e.getScene();if(a.getEngine()._features.needTypeSuffixInShaderConstants?r.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):r.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),r.setValue("BRDF_V_HEIGHT_CORRELATED",!0),r.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),r.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),r.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),r.setValue("UNLIT",this.unlit,!0),r.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&en.a.ReflectionTextureEnabled?(r.setValue("ENVIRONMENTBRDF",!0),r.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(r.setValue("ENVIRONMENTBRDF",!1),r.setValue("ENVIRONMENTBRDF_RGBD",!1)),!!r._areLightsDirty)if(!this.light)Ot.a.PrepareDefinesForLights(a,e,r,!0,i.maxSimultaneousLights),r._needNormals=!0,Ot.a.PrepareDefinesForMultiview(a,r);else{var s={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Ot.a.PrepareDefinesForLight(a,e,this.light,this._lightId,r,!0,s),s.needRebuild&&r.rebuild()}},t.prototype.updateUniformsAndSamples=function(e,i,r,o){for(var a=0;a<i.maxSimultaneousLights&&r["LIGHT"+a];a++){var s=e.uniforms.indexOf("vLightData"+a)>=0;Ot.a.PrepareUniformsAndSamplersForLight(a,e.uniforms,e.samplers,r["PROJECTEDLIGHTTEXTURE"+a],o,s)}},t.prototype.isReady=function(){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady())},t.prototype.bind=function(e,i,r){var o,a;if(!!r){var s=r.getScene();this.light?Ot.a.BindLight(this.light,this._lightId,s,e,!0):Ot.a.BindLights(s,r,e,!0,i.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);var c=this._scene.ambientColor;c&&e.setColor3("ambientFromScene",c);var v=s.useRightHandedSystem===(s._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,v?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);var b=1,C=(a=(o=this.indexOfRefraction.connectInputBlock)===null||o===void 0?void 0:o.value)!==null&&a!==void 0?a:1.5,M=Math.pow((C-b)/(C+b),2);this._metallicReflectanceColor.scaleToRef(M*this._metallicF0Factor,m.c.Color3[0]);var N=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,m.c.Color3[0],N)}},t.prototype._injectVertexCode=function(e){var i,r,o=this.worldPosition,a="//"+this.name;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",a,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",a,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));var s="v_"+o.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+=s+" = "+o.associatedVariableName+`;\r
`);var c=this.reflection.isConnected?(i=this.reflection.connectedPoint)===null||i===void 0?void 0:i.ownerBlock:null;c&&(c.viewConnectionPoint=this.view),e.compilationString+=(r=c==null?void 0:c.handleVertexSide(e))!==null&&r!==void 0?r:"",e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0\r
`,e._injectAtEnd+=`vClipSpacePosition = gl_Position;\r
`,e._injectAtEnd+=`#endif\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",a,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:o.associatedVariableName}]}):(e.compilationString+="vec4 worldPos = "+o.associatedVariableName+`;\r
`,this.view.isConnected&&(e.compilationString+="mat4 view = "+this.view.associatedVariableName+`;\r
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",a,{repeatKey:"maxSimultaneousLights"}))},t.prototype._getAlbedoOpacityCode=function(){var e=`albedoOpacityOutParams albedoOpacityOut;\r
`,i=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",r=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return e+=`albedoOpacityBlock(
                vec4(`+i+`, 1.),
            #ifdef ALBEDO
                vec4(1.),
                vec2(1., 1.),
            #endif
            #ifdef OPACITY
                vec4(`+r+`),
                vec2(1., 1.),
            #endif
                albedoOpacityOut
            );

            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;
            float alpha = albedoOpacityOut.alpha;\r
`,e},t.prototype._getAmbientOcclusionCode=function(){var e=`ambientOcclusionOutParams aoOut;\r
`,i=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return e+=`ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3(`+i+`),
                vec4(0., 1.0, 1.0, 0.),
            #endif
                aoOut
            );\r
`,e},t.prototype._getReflectivityCode=function(e){var i=`reflectivityOutParams reflectivityOut;\r
`,r="1.";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),i+=`vec3 baseColor = surfaceAlbedo;

            reflectivityBlock(
                vec4(`+this.metallic.associatedVariableName+", "+this.roughness.associatedVariableName+`, 0., 0.),
            #ifdef METALLICWORKFLOW
                surfaceAlbedo,
                `+this._vMetallicReflectanceFactorsName+`,
            #endif
            #ifdef REFLECTIVITY
                vec3(0., 0., `+r+`),
                vec4(1.),
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor,
            #endif
            #ifdef MICROSURFACEMAP
                microSurfaceTexel, <== not handled!
            #endif
                reflectivityOut
            );

            float microSurface = reflectivityOut.microSurface;
            float roughness = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif\r
`,i},t.prototype._buildBlock=function(e){var i,r,o,a,s,c,v,b,C,M,N,D,V,X,ee,ie,ge,pe,te,Ce,Ae,De,Fe,We,Pe,Ne,je,Be,Je,tt,Xe,Ct,At,Rt,rt,Bt,jt,at,Lt;n.prototype._buildBlock.call(this,e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=Ff.a.GetEnvironmentBRDFTexture(this._scene));var Qe=this.reflection.isConnected?(i=this.reflection.connectedPoint)===null||i===void 0?void 0:i.ownerBlock:null;if(Qe&&(Qe.worldPositionConnectionPoint=this.worldPosition,Qe.cameraPositionConnectionPoint=this.cameraPosition,Qe.worldNormalConnectionPoint=this.worldNormal),e.target!==oe.Fragment)return this._injectVertexCode(e),this;e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this);var lt="//"+this.name,wt="v_"+this.worldPosition.associatedVariableName,fi=this.perturbedNormal;this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",lt,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",lt,{repeatKey:"maxSimultaneousLights"}),e._emitFunctionFromInclude("helperFunctions",lt),e._emitFunctionFromInclude("importanceSampling",lt),e._emitFunctionFromInclude("pbrHelperFunctions",lt),e._emitFunctionFromInclude("imageProcessingFunctions",lt),e._emitFunctionFromInclude("shadowsFragmentFunctions",lt,{replaceStrings:[{search:/vPositionW/g,replace:wt+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",lt,{replaceStrings:[{search:/vPositionW/g,replace:wt+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",lt),e._emitFunctionFromInclude("pbrBRDFFunctions",lt,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(r=Qe==null?void 0:Qe._defineSkyboxName)!==null&&r!==void 0?r:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",lt),e._emitFunctionFromInclude("pbrDirectLightingFunctions",lt,{replaceStrings:[{search:/vPositionW/g,replace:wt+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",lt),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",lt),e._emitFunctionFromInclude("pbrBlockReflectivity",lt),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",lt),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",lt),e._emitFunctionFromInclude("pbrBlockAnisotropic",lt),e._emitUniformFromString("vLightingIntensity","vec4"),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+="vec4 "+this._vNormalWName+" = normalize("+this.worldNormal.associatedVariableName+`);\r
`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+="vec3 viewDirectionW = normalize("+this.cameraPosition.associatedVariableName+" - "+wt+`.xyz);\r
`),e.compilationString+="vec3 geometricNormalW = "+this._vNormalWName+`.xyz;\r
`,e.compilationString+="vec3 normalW = "+(fi.isConnected?"normalize("+fi.associatedVariableName+".xyz)":"geometricNormalW")+`;\r
`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",lt,{replaceStrings:[{search:/vPositionW/g,replace:wt+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",lt),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",lt),e.compilationString+=`#ifdef UNLIT
                vec3 diffuseBase = vec3(1., 1., 1.);
            #else\r
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",lt,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(o=Qe==null?void 0:Qe._defineSkyboxName)!==null&&o!==void 0?o:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(a=Qe==null?void 0:Qe._define3DName)!==null&&a!==void 0?a:"REFLECTIONMAP_3D"}]});var si=this.anisotropy.isConnected?(s=this.anisotropy.connectedPoint)===null||s===void 0?void 0:s.ownerBlock:null;si&&(si.worldPositionConnectionPoint=this.worldPosition,si.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=si.getCode(e,!this.perturbedNormal.isConnected)),Qe&&Qe.hasTexture&&(e.compilationString+=Qe.getCode(e,si?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",lt,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(c=Qe==null?void 0:Qe._define3DName)!==null&&c!==void 0?c:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(v=Qe==null?void 0:Qe._defineOppositeZ)!==null&&v!==void 0?v:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(b=Qe==null?void 0:Qe._defineProjectionName)!==null&&b!==void 0?b:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(C=Qe==null?void 0:Qe._defineSkyboxName)!==null&&C!==void 0?C:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(M=Qe==null?void 0:Qe._defineLODReflectionAlpha)!==null&&M!==void 0?M:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(N=Qe==null?void 0:Qe._defineLinearSpecularReflection)!==null&&N!==void 0?N:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:(D=Qe==null?void 0:Qe._vReflectionFilteringInfoName)!==null&&D!==void 0?D:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",lt,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});var xi=this.sheen.isConnected?(V=this.sheen.connectedPoint)===null||V===void 0?void 0:V.ownerBlock:null;xi&&(e.compilationString+=xi.getCode(Qe)),e._emitFunctionFromInclude("pbrBlockSheen",lt,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(X=Qe==null?void 0:Qe._define3DName)!==null&&X!==void 0?X:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(ee=Qe==null?void 0:Qe._defineSkyboxName)!==null&&ee!==void 0?ee:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(ie=Qe==null?void 0:Qe._defineLODReflectionAlpha)!==null&&ie!==void 0?ie:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(ge=Qe==null?void 0:Qe._defineLinearSpecularReflection)!==null&&ge!==void 0?ge:"LINEARSPECULARREFLECTION"}]});var bi=this.clearcoat.isConnected?(pe=this.clearcoat.connectedPoint)===null||pe===void 0?void 0:pe.ownerBlock:null,St=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,$t=this.perturbedNormal.isConnected&&((te=this.perturbedNormal.connectedPoint)===null||te===void 0?void 0:te.ownerBlock).worldTangent.isConnected,vi=this.anisotropy.isConnected&&((Ce=this.anisotropy.connectedPoint)===null||Ce===void 0?void 0:Ce.ownerBlock).worldTangent.isConnected,hi=$t||!this.perturbedNormal.isConnected&&vi;e.compilationString+=sa.GetCode(e,bi,Qe,wt,St,hi,this.worldNormal.associatedVariableName),St&&(hi=(Ae=bi==null?void 0:bi.worldTangent.isConnected)!==null&&Ae!==void 0?Ae:!1),e._emitFunctionFromInclude("pbrBlockClearcoat",lt,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(De=Qe==null?void 0:Qe._define3DName)!==null&&De!==void 0?De:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(Fe=Qe==null?void 0:Qe._defineOppositeZ)!==null&&Fe!==void 0?Fe:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(We=Qe==null?void 0:Qe._defineProjectionName)!==null&&We!==void 0?We:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(Pe=Qe==null?void 0:Qe._defineSkyboxName)!==null&&Pe!==void 0?Pe:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(Ne=Qe==null?void 0:Qe._defineLODReflectionAlpha)!==null&&Ne!==void 0?Ne:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(je=Qe==null?void 0:Qe._defineLinearSpecularReflection)!==null&&je!==void 0?je:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:hi?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",lt,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(Be=Qe==null?void 0:Qe._defineSkyboxName)!==null&&Be!==void 0?Be:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(Je=Qe==null?void 0:Qe._define3DName)!==null&&Je!==void 0?Je:"REFLECTIONMAP_3D"}]});var di=this.subsurface.isConnected?(tt=this.subsurface.connectedPoint)===null||tt===void 0?void 0:tt.ownerBlock:null,ct=this.subsurface.isConnected?(Ct=((Xe=this.subsurface.connectedPoint)===null||Xe===void 0?void 0:Xe.ownerBlock).refraction.connectedPoint)===null||Ct===void 0?void 0:Ct.ownerBlock:null;ct&&(ct.viewConnectionPoint=this.view,ct.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=la.GetCode(e,di,Qe,wt),e._emitFunctionFromInclude("pbrBlockSubSurface",lt,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(At=Qe==null?void 0:Qe._define3DName)!==null&&At!==void 0?At:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(Rt=Qe==null?void 0:Qe._defineOppositeZ)!==null&&Rt!==void 0?Rt:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(rt=Qe==null?void 0:Qe._defineProjectionName)!==null&&rt!==void 0?rt:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:(Bt=ct==null?void 0:ct._define3DName)!==null&&Bt!==void 0?Bt:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:(jt=ct==null?void 0:ct._defineLODRefractionAlpha)!==null&&jt!==void 0?jt:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:(at=ct==null?void 0:ct._defineLinearSpecularRefraction)!==null&&at!==void 0?at:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:(Lt=ct==null?void 0:ct._defineOppositeZ)!==null&&Lt!==void 0?Lt:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",lt),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",lt,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",lt,{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",lt),e.compilationString+=`#endif\r
`;var oi=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)",sn=Hr.a.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();sn.indexOf(".")===-1&&(sn+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",lt,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:oi+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:sn}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",lt,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",lt,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",lt,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:wt},{search:/albedoTexture\.rgb;/g,replace:`vec3(1.);\r
gl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r
`}]});for(var Kr=0,Nn=this._outputs;Kr<Nn.length;Kr++){var Qr=Nn[Kr];if(Qr.hasEndpoints){var _n=tm[Qr.name];if(_n){var Oa=_n[0],wn=_n[1];wn&&(e.compilationString+="#if "+wn+`\r
`),e.compilationString+=this._declareOutput(Qr,e)+" = "+Oa+`;\r
`,wn&&(e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(Qr,e)+` = vec3(0.);\r
`,e.compilationString+=`#endif\r
`)}else console.error("There's no remapping for the "+Qr.name+" end point! No code generated")}}return this},t.prototype._dumpPropertiesCode=function(){var e="";return e+=this._codeVariableName+".lightFalloff = "+this.lightFalloff+`;\r
`,e+=this._codeVariableName+".useAlphaTest = "+this.useAlphaTest+`;\r
`,e+=this._codeVariableName+".alphaTestCutoff = "+this.alphaTestCutoff+`;\r
`,e+=this._codeVariableName+".useAlphaBlending = "+this.useAlphaBlending+`;\r
`,e+=this._codeVariableName+".useRadianceOverAlpha = "+this.useRadianceOverAlpha+`;\r
`,e+=this._codeVariableName+".useSpecularOverAlpha = "+this.useSpecularOverAlpha+`;\r
`,e+=this._codeVariableName+".enableSpecularAntiAliasing = "+this.enableSpecularAntiAliasing+`;\r
`,e+=this._codeVariableName+".realTimeFiltering = "+this.realTimeFiltering+`;\r
`,e+=this._codeVariableName+".realTimeFilteringQuality = "+this.realTimeFilteringQuality+`;\r
`,e+=this._codeVariableName+".useEnergyConservation = "+this.useEnergyConservation+`;\r
`,e+=this._codeVariableName+".useRadianceOcclusion = "+this.useRadianceOcclusion+`;\r
`,e+=this._codeVariableName+".useHorizonOcclusion = "+this.useHorizonOcclusion+`;\r
`,e+=this._codeVariableName+".unlit = "+this.unlit+`;\r
`,e+=this._codeVariableName+".forceNormalForward = "+this.forceNormalForward+`;\r
`,e+=this._codeVariableName+".debugMode = "+this.debugMode+`;\r
`,e+=this._codeVariableName+".debugLimit = "+this.debugLimit+`;\r
`,e+=this._codeVariableName+".debugFactor = "+this.debugFactor+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e},t.prototype._deserialize=function(e,i,r){var o,a;n.prototype._deserialize.call(this,e,i,r),e.lightId&&(this.light=i.getLightByID(e.lightId)),this.lightFalloff=(o=e.lightFalloff)!==null&&o!==void 0?o:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=(a=e.realTimeFilteringQuality)!==null&&a!==void 0?a:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor},Object(h.c)([It("Direct lights",Mt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],t.prototype,"directIntensity",void 0),Object(h.c)([It("Environment lights",Mt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],t.prototype,"environmentIntensity",void 0),Object(h.c)([It("Specular highlights",Mt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],t.prototype,"specularIntensity",void 0),Object(h.c)([It("Light falloff",Mt.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:Hr.a.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:Hr.a.LIGHTFALLOFF_GLTF},{label:"Standard",value:Hr.a.LIGHTFALLOFF_STANDARD}]})],t.prototype,"lightFalloff",void 0),Object(h.c)([It("Alpha Testing",Mt.Boolean,"OPACITY")],t.prototype,"useAlphaTest",void 0),Object(h.c)([It("Alpha CutOff",Mt.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],t.prototype,"alphaTestCutoff",void 0),Object(h.c)([It("Alpha blending",Mt.Boolean,"OPACITY")],t.prototype,"useAlphaBlending",void 0),Object(h.c)([It("Radiance over alpha",Mt.Boolean,"RENDERING",{notifiers:{update:!0}})],t.prototype,"useRadianceOverAlpha",void 0),Object(h.c)([It("Specular over alpha",Mt.Boolean,"RENDERING",{notifiers:{update:!0}})],t.prototype,"useSpecularOverAlpha",void 0),Object(h.c)([It("Specular anti-aliasing",Mt.Boolean,"RENDERING",{notifiers:{update:!0}})],t.prototype,"enableSpecularAntiAliasing",void 0),Object(h.c)([It("Realtime filtering",Mt.Boolean,"RENDERING",{notifiers:{update:!0}})],t.prototype,"realTimeFiltering",void 0),Object(h.c)([It("Realtime filtering quality",Mt.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],t.prototype,"realTimeFilteringQuality",void 0),Object(h.c)([It("Energy Conservation",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"useEnergyConservation",void 0),Object(h.c)([It("Radiance occlusion",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"useRadianceOcclusion",void 0),Object(h.c)([It("Horizon occlusion",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"useHorizonOcclusion",void 0),Object(h.c)([It("Unlit",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"unlit",void 0),Object(h.c)([It("Force normal forward",Mt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"forceNormalForward",void 0),Object(h.c)([It("Debug mode",Mt.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],t.prototype,"debugMode",void 0),Object(h.c)([It("Split position",Mt.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],t.prototype,"debugLimit",void 0),Object(h.c)([It("Output factor",Mt.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],t.prototype,"debugFactor",void 0),t}(it);f.a.RegisteredTypes["BABYLON.PBRMetallicRoughnessBlock"]=Nf;var wf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("left",K.AutoDetect),i.registerInput("right",K.AutoDetect),i.registerOutput("output",K.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"ModBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = mod("+this.left.associatedVariableName+", "+this.right.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.ModBlock"]=wf;var Vf=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e,oe.Neutral)||this;return i.registerInput("row0",K.Vector4),i.registerInput("row1",K.Vector4),i.registerInput("row2",K.Vector4),i.registerInput("row3",K.Vector4),i.registerOutput("output",K.Matrix),i}return t.prototype.getClassName=function(){return"MatrixBuilder"},Object.defineProperty(t.prototype,"row0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"row1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"row2",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"row3",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.row0.isConnected){var i=new yt("row0");i.value=new l.f(1,0,0,0),i.output.connectTo(this.row0)}if(!this.row1.isConnected){var r=new yt("row1");r.value=new l.f(0,1,0,0),r.output.connectTo(this.row1)}if(!this.row2.isConnected){var o=new yt("row2");o.value=new l.f(0,0,1,0),o.output.connectTo(this.row2)}if(!this.row3.isConnected){var a=new yt("row3");a.value=new l.f(0,0,0,1),a.output.connectTo(this.row3)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this.row0,o=this.row1,a=this.row2,s=this.row3;return e.compilationString+=this._declareOutput(i,e)+(" = mat4("+r.associatedVariableName+", "+o.associatedVariableName+", "+a.associatedVariableName+", "+s.associatedVariableName+`);\r
`),this},t}(it);f.a.RegisteredTypes["BABYLON.MatrixBuilder"]=Vf;var im=function(){function n(){}return n.prototype.optimize=function(t,e){},n}(),Uf=u(630),rm=u(709),nm=function(){function n(){this.mm=new Map}return n.prototype.get=function(t,e){var i=this.mm.get(t);if(i!==void 0)return i.get(e)},n.prototype.set=function(t,e,i){var r=this.mm.get(t);r===void 0&&this.mm.set(t,r=new Map),r.set(e,i)},n}(),om=function(){function n(t,e,i){var r=this;this._baseMaterial=t,this._scene=e,this._options=i,this._subMeshToEffect=new Map,this._subMeshToDepthEffect=new nm,this._meshes=new Map;var o=t.getClassName()==="NodeMaterial"?"u_":"";if(o){this._matriceNames={world:o+"World",view:o+"View",projection:o+"Projection",viewProjection:o+"ViewProjection",worldView:o+"WorldxView",worldViewProjection:o+"WorldxViewxProjection"};for(var a=t,s=a.getInputBlocks(),c=0;c<s.length;++c)switch(s[c]._systemValue){case dt.World:this._matriceNames.world=s[c].associatedVariableName;break;case dt.View:this._matriceNames.view=s[c].associatedVariableName;break;case dt.Projection:this._matriceNames.projection=s[c].associatedVariableName;break;case dt.ViewProjection:this._matriceNames.viewProjection=s[c].associatedVariableName;break;case dt.WorldView:this._matriceNames.worldView=s[c].associatedVariableName;break;case dt.WorldViewProjection:this._matriceNames.worldViewProjection=s[c].associatedVariableName;break}}else this._matriceNames={world:o+"world",view:o+"view",projection:o+"projection",viewProjection:o+"viewProjection",worldView:o+"worldView",worldViewProjection:o+"worldViewProjection"};this._onEffectCreatedObserver=this._baseMaterial.onEffectCreatedObservable.add(function(v){var b,C=(b=v.subMesh)===null||b===void 0?void 0:b.getMesh();C&&!r._meshes.has(C)&&r._meshes.set(C,C.onDisposeObservable.add(function(M){for(var N=r._subMeshToEffect.keys(),D=N.next();D.done!==!0;D=N.next()){var V=D.value;(V==null?void 0:V.getMesh())===M&&(r._subMeshToEffect.delete(V),r._subMeshToDepthEffect.mm.delete(V))}})),r._subMeshToEffect.set(v.subMesh,v.effect),r._subMeshToDepthEffect.mm.delete(v.subMesh)})}return Object.defineProperty(n.prototype,"standalone",{get:function(){var t,e;return(e=(t=this._options)===null||t===void 0?void 0:t.standalone)!==null&&e!==void 0?e:!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"baseMaterial",{get:function(){return this._baseMaterial},enumerable:!1,configurable:!0}),n.prototype.getEffect=function(t,e){var i,r,o,a,s,c;return(c=(o=(r=(i=this._subMeshToDepthEffect.mm.get(t))===null||i===void 0?void 0:i.get(e))===null||r===void 0?void 0:r.depthEffect)!==null&&o!==void 0?o:(s=(a=this._subMeshToDepthEffect.mm.get(null))===null||a===void 0?void 0:a.get(e))===null||s===void 0?void 0:s.depthEffect)!==null&&c!==void 0?c:null},n.prototype.isReadyForSubMesh=function(t,e,i,r){var o,a;return this.standalone&&this._baseMaterial.isReadyForSubMesh(t.getMesh(),t,r),(a=(o=this._makeEffect(t,e,i))===null||o===void 0?void 0:o.isReady())!==null&&a!==void 0?a:!1},n.prototype.dispose=function(){this._baseMaterial.onEffectCreatedObservable.remove(this._onEffectCreatedObserver),this._onEffectCreatedObserver=null;for(var t=this._meshes.entries(),e=t.next();e.done!==!0;e=t.next()){var i=e.value,r=i[0],o=i[1];r.onDisposeObservable.remove(o)}},n.prototype._makeEffect=function(t,e,i){var r,o=(r=this._subMeshToEffect.get(t))!==null&&r!==void 0?r:this._subMeshToEffect.get(null);if(!o)return null;var a=this._subMeshToDepthEffect.get(t,i);a||(a={depthEffect:null,depthDefines:"",token:rm.a.RandomId()},this._subMeshToDepthEffect.set(t,i,a));var s=e.join(`
`);if(a.depthEffect&&s===a.depthDefines)return a.depthEffect;a.depthDefines=s;var c=o.rawVertexSourceCode,v=o.rawFragmentSourceCode,b=this._options&&this._options.remappedVariables?"#include<shadowMapVertexNormalBias>("+this._options.remappedVariables.join(",")+")":qe.a.IncludesShadersStore.shadowMapVertexNormalBias,C=this._options&&this._options.remappedVariables?"#include<shadowMapVertexMetric>("+this._options.remappedVariables.join(",")+")":qe.a.IncludesShadersStore.shadowMapVertexMetric,M=this._options&&this._options.remappedVariables?"#include<shadowMapFragmentSoftTransparentShadow>("+this._options.remappedVariables.join(",")+")":qe.a.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow,N=qe.a.IncludesShadersStore.shadowMapFragment;c=c.replace(/void\s+?main/g,qe.a.IncludesShadersStore.shadowMapVertexDeclaration+`\r
void main`),c=c.replace(/#define SHADOWDEPTH_NORMALBIAS|#define CUSTOM_VERTEX_UPDATE_WORLDPOS/g,b),c.indexOf("#define SHADOWDEPTH_METRIC")!==-1?c=c.replace(/#define SHADOWDEPTH_METRIC/g,C):c=c.replace(/}\s*$/g,C+`\r
}`),c=c.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");var D=v.indexOf("#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW")>=0||v.indexOf("#define CUSTOM_FRAGMENT_BEFORE_FOG")>=0,V=v.indexOf("#define SHADOWDEPTH_FRAGMENT")!==-1,X="";D?v=v.replace(/#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW|#define CUSTOM_FRAGMENT_BEFORE_FOG/g,M):X=M+`\r
`,v=v.replace(/void\s+?main/g,qe.a.IncludesShadersStore.shadowMapFragmentDeclaration+`\r
void main`),V?v=v.replace(/#define SHADOWDEPTH_FRAGMENT/g,N):X+=N+`\r
`,X&&(v=v.replace(/}\s*$/g,X+"}")),v=v.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");var ee=o.getUniformNames().slice();return ee.push("biasAndScaleSM","depthValuesSM","lightDataSM","softTransparentShadowSM"),a.depthEffect=this._scene.getEngine().createEffect({vertexSource:c,fragmentSource:v,vertexToken:a.token,fragmentToken:a.token},{attributes:o.getAttributesNames(),uniformsNames:ee,uniformBuffersNames:o.getUniformBuffersNames(),samplers:o.getSamplers(),defines:s+`
`+o.defines.replace("#define SHADOWS","").replace(/#define SHADOW\d/g,""),indexParameters:o.getIndexParameters()},this._scene.getEngine()),a.depthEffect},n}(),Gf=u(710),am=u(696),Ao=u(559),zf=0,sm=function(){function n(t,e,i,r){this.pos=t,this.normal=e,this.uv=i,this.vertColor=r}return n.prototype.clone=function(){var t,e;return new n(this.pos.clone(),this.normal.clone(),(t=this.uv)===null||t===void 0?void 0:t.clone(),(e=this.vertColor)===null||e===void 0?void 0:e.clone())},n.prototype.flip=function(){this.normal=this.normal.scale(-1)},n.prototype.interpolate=function(t,e){return new n(l.e.Lerp(this.pos,t.pos,e),l.e.Lerp(this.normal,t.normal,e),this.uv&&t.uv?l.d.Lerp(this.uv,t.uv,e):void 0,this.vertColor&&t.vertColor?m.b.Lerp(this.vertColor,t.vertColor,e):void 0)},n}(),lm=function(){function n(t,e){this.normal=t,this.w=e}return n.FromPoints=function(t,e,i){var r=i.subtract(t),o=e.subtract(t);if(r.lengthSquared()===0||o.lengthSquared()===0)return null;var a=l.e.Normalize(l.e.Cross(r,o));return new n(a,l.e.Dot(a,t))},n.prototype.clone=function(){return new n(this.normal.clone(),this.w)},n.prototype.flip=function(){this.normal.scaleInPlace(-1),this.w=-this.w},n.prototype.splitPolygon=function(t,e,i,r,o){var a=0,s=1,c=2,v=3,b=0,C=[],M,N;for(M=0;M<t.vertices.length;M++){N=l.e.Dot(this.normal,t.vertices[M].pos)-this.w;var D=N<-n.EPSILON?c:N>n.EPSILON?s:a;b|=D,C.push(D)}switch(b){case a:(l.e.Dot(this.normal,t.plane.normal)>0?e:i).push(t);break;case s:r.push(t);break;case c:o.push(t);break;case v:var V=[],X=[];for(M=0;M<t.vertices.length;M++){var ee=(M+1)%t.vertices.length,ie=C[M],ge=C[ee],pe=t.vertices[M],te=t.vertices[ee];if(ie!==c&&V.push(pe),ie!==s&&X.push(ie!==c?pe.clone():pe),(ie|ge)===v){N=(this.w-l.e.Dot(this.normal,pe.pos))/l.e.Dot(this.normal,te.pos.subtract(pe.pos));var Ce=pe.interpolate(te,N);V.push(Ce),X.push(Ce.clone())}}var Ae;V.length>=3&&(Ae=new $s(V,t.shared),Ae.plane&&r.push(Ae)),X.length>=3&&(Ae=new $s(X,t.shared),Ae.plane&&o.push(Ae));break}},n.EPSILON=1e-5,n}(),$s=function(){function n(t,e){this.vertices=t,this.shared=e,this.plane=lm.FromPoints(t[0].pos,t[1].pos,t[2].pos)}return n.prototype.clone=function(){var t=this.vertices.map(function(e){return e.clone()});return new n(t,this.shared)},n.prototype.flip=function(){this.vertices.reverse().map(function(t){t.flip()}),this.plane.flip()},n}(),br=function(){function n(t){this.plane=null,this.front=null,this.back=null,this.polygons=new Array,t&&this.build(t)}return n.prototype.clone=function(){var t=new n;return t.plane=this.plane&&this.plane.clone(),t.front=this.front&&this.front.clone(),t.back=this.back&&this.back.clone(),t.polygons=this.polygons.map(function(e){return e.clone()}),t},n.prototype.invert=function(){for(var t=0;t<this.polygons.length;t++)this.polygons[t].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var e=this.front;this.front=this.back,this.back=e},n.prototype.clipPolygons=function(t){if(!this.plane)return t.slice();for(var e=new Array,i=new Array,r=0;r<t.length;r++)this.plane.splitPolygon(t[r],e,i,e,i);return this.front&&(e=this.front.clipPolygons(e)),this.back?i=this.back.clipPolygons(i):i=[],e.concat(i)},n.prototype.clipTo=function(t){this.polygons=t.clipPolygons(this.polygons),this.front&&this.front.clipTo(t),this.back&&this.back.clipTo(t)},n.prototype.allPolygons=function(){var t=this.polygons.slice();return this.front&&(t=t.concat(this.front.allPolygons())),this.back&&(t=t.concat(this.back.allPolygons())),t},n.prototype.build=function(t){if(!!t.length){this.plane||(this.plane=t[0].plane.clone());for(var e=new Array,i=new Array,r=0;r<t.length;r++)this.plane.splitPolygon(t[r],this.polygons,this.polygons,e,i);e.length&&(this.front||(this.front=new n),this.front.build(e)),i.length&&(this.back||(this.back=new n),this.back.build(i))}},n}(),um=function(){function n(){this.polygons=new Array}return n.FromMesh=function(t){var e,i,r=void 0,o,a=void 0,s,c=new Array,v,b,C,M,N=null,D;if(t instanceof ot.a)t.computeWorldMatrix(!0),b=t.getWorldMatrix(),C=t.position.clone(),M=t.rotation.clone(),t.rotationQuaternion&&(N=t.rotationQuaternion.clone()),D=t.scaling.clone();else throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";for(var V=t.getIndices(),X=t.getVerticesData(Oe.b.PositionKind),ee=t.getVerticesData(Oe.b.NormalKind),ie=t.getVerticesData(Oe.b.UVKind),ge=t.getVerticesData(Oe.b.ColorKind),pe=t.subMeshes,te=0,Ce=pe.length;te<Ce;te++)for(var Ae=pe[te].indexStart,De=pe[te].indexCount+pe[te].indexStart;Ae<De;Ae+=3){v=[];for(var Fe=0;Fe<3;Fe++){var We=new l.e(ee[V[Ae+Fe]*3],ee[V[Ae+Fe]*3+1],ee[V[Ae+Fe]*3+2]);ie&&(r=new l.d(ie[V[Ae+Fe]*2],ie[V[Ae+Fe]*2+1])),ge&&(a=new m.b(ge[V[Ae+Fe]*4],ge[V[Ae+Fe]*4+1],ge[V[Ae+Fe]*4+2],ge[V[Ae+Fe]*4+3]));var Pe=new l.e(X[V[Ae+Fe]*3],X[V[Ae+Fe]*3+1],X[V[Ae+Fe]*3+2]);o=l.e.TransformCoordinates(Pe,b),i=l.e.TransformNormal(We,b),e=new sm(o,i,r,a),v.push(e)}s=new $s(v,{subMeshId:te,meshId:zf,materialIndex:pe[te].materialIndex}),s.plane&&c.push(s)}var Ne=n.FromPolygons(c);return Ne.matrix=b,Ne.position=C,Ne.rotation=M,Ne.scaling=D,Ne.rotationQuaternion=N,zf++,Ne},n.FromPolygons=function(t){var e=new n;return e.polygons=t,e},n.prototype.clone=function(){var t=new n;return t.polygons=this.polygons.map(function(e){return e.clone()}),t.copyTransformAttributes(this),t},n.prototype.union=function(t){var e=new br(this.clone().polygons),i=new br(t.clone().polygons);return e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.unionInPlace=function(t){var e=new br(this.polygons),i=new br(t.polygons);e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),this.polygons=e.allPolygons()},n.prototype.subtract=function(t){var e=new br(this.clone().polygons),i=new br(t.clone().polygons);return e.invert(),e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),e.invert(),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.subtractInPlace=function(t){var e=new br(this.polygons),i=new br(t.polygons);e.invert(),e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),e.invert(),this.polygons=e.allPolygons()},n.prototype.intersect=function(t){var e=new br(this.clone().polygons),i=new br(t.clone().polygons);return e.invert(),i.clipTo(e),i.invert(),e.clipTo(i),i.clipTo(e),e.build(i.allPolygons()),e.invert(),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.intersectInPlace=function(t){var e=new br(this.polygons),i=new br(t.polygons);e.invert(),i.clipTo(e),i.invert(),e.clipTo(i),i.clipTo(e),e.build(i.allPolygons()),e.invert(),this.polygons=e.allPolygons()},n.prototype.inverse=function(){var t=this.clone();return t.inverseInPlace(),t},n.prototype.inverseInPlace=function(){this.polygons.map(function(t){t.flip()})},n.prototype.copyTransformAttributes=function(t){return this.matrix=t.matrix,this.position=t.position,this.rotation=t.rotation,this.scaling=t.scaling,this.rotationQuaternion=t.rotationQuaternion,this},n.prototype.buildMeshGeometry=function(t,e,i){var r=this.matrix.clone();r.invert();var o=new ot.a(t,e),a=[],s=[],c=[],v=null,b=null,C=l.e.Zero(),M=l.e.Zero(),N=l.d.Zero(),D=new m.b(0,0,0,0),V=this.polygons,X=[0,0,0],ee,ie={},ge,pe=0,te={},Ce;i&&V.sort(function(Rt,rt){return Rt.shared.meshId===rt.shared.meshId?Rt.shared.subMeshId-rt.shared.subMeshId:Rt.shared.meshId-rt.shared.meshId});for(var Ae=0,De=V.length;Ae<De;Ae++){ee=V[Ae],te[ee.shared.meshId]||(te[ee.shared.meshId]={}),te[ee.shared.meshId][ee.shared.subMeshId]||(te[ee.shared.meshId][ee.shared.subMeshId]={indexStart:Infinity,indexEnd:-Infinity,materialIndex:ee.shared.materialIndex}),Ce=te[ee.shared.meshId][ee.shared.subMeshId];for(var Fe=2,We=ee.vertices.length;Fe<We;Fe++){X[0]=0,X[1]=Fe-1,X[2]=Fe;for(var Pe=0;Pe<3;Pe++){C.copyFrom(ee.vertices[X[Pe]].pos),M.copyFrom(ee.vertices[X[Pe]].normal),ee.vertices[X[Pe]].uv&&(v||(v=[]),N.copyFrom(ee.vertices[X[Pe]].uv)),ee.vertices[X[Pe]].vertColor&&(b||(b=[]),D.copyFrom(ee.vertices[X[Pe]].vertColor));var Ne=l.e.TransformCoordinates(C,r),je=l.e.TransformNormal(M,r);ge=ie[Ne.x+","+Ne.y+","+Ne.z];var Be=!1;v&&!(v[ge*2]===N.x||v[ge*2+1]===N.y)&&(Be=!0);var Je=!1;b&&!(b[ge*4]===D.r||b[ge*4+1]===D.g||b[ge*4+2]===D.b||b[ge*4+3]===D.a)&&(Je=!0),(!(typeof ge!="undefined"&&c[ge*3]===je.x&&c[ge*3+1]===je.y&&c[ge*3+2]===je.z)||Be||Je)&&(a.push(Ne.x,Ne.y,Ne.z),v&&v.push(N.x,N.y),c.push(M.x,M.y,M.z),b&&b.push(D.r,D.g,D.b,D.a),ge=ie[Ne.x+","+Ne.y+","+Ne.z]=a.length/3-1),s.push(ge),Ce.indexStart=Math.min(pe,Ce.indexStart),Ce.indexEnd=Math.max(pe,Ce.indexEnd),pe++}}}if(o.setVerticesData(Oe.b.PositionKind,a),o.setVerticesData(Oe.b.NormalKind,c),v&&o.setVerticesData(Oe.b.UVKind,v),b&&o.setVerticesData(Oe.b.ColorKind,b),o.setIndices(s,null),i){var tt=0,Xe;o.subMeshes=new Array;for(var Ct in te){Xe=-1;for(var At in te[Ct])Ce=te[Ct][At],Ao.a.CreateFromIndices(Ce.materialIndex+tt,Ce.indexStart,Ce.indexEnd-Ce.indexStart+1,o),Xe=Math.max(Ce.materialIndex,Xe);tt+=++Xe}}return o},n.prototype.toMesh=function(t,e,i,r){e===void 0&&(e=null);var o=this.buildMeshGeometry(t,i,r);return o.material=e,o.position.copyFrom(this.position),o.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(o.rotationQuaternion=this.rotationQuaternion.clone()),o.scaling.copyFrom(this.scaling),o.computeWorldMatrix(!0),o},n}(),cm=u(661),fm=u(730),an=u(485),hm=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){o===void 0&&(o=1),a===void 0&&(a=60),s===void 0&&(s=!0);var c=n.call(this,e,r)||this;c._sectionPolygonPointsCount=4,c._running=!1,c._autoStart=s,c._generator=i,c._diameter=o,c._length=a,c._sectionVectors=[],c._sectionNormalVectors=[];for(var v=0;v<c._sectionPolygonPointsCount;v++)c._sectionVectors[v]=l.e.Zero(),c._sectionNormalVectors[v]=l.e.Zero();return c._createMesh(),c}return t.prototype.getClassName=function(){return"TrailMesh"},t.prototype._createMesh=function(){var e=new an.a,i=[],r=[],o=[],a=l.e.Zero();this._generator instanceof Ue.a&&this._generator._boundingInfo?a=this._generator._boundingInfo.boundingBox.centerWorld:a=this._generator.position;for(var s=2*Math.PI/this._sectionPolygonPointsCount,c=0;c<this._sectionPolygonPointsCount;c++)i.push(a.x+Math.cos(c*s)*this._diameter,a.y+Math.sin(c*s)*this._diameter,a.z);for(var c=1;c<=this._length;c++){for(var v=0;v<this._sectionPolygonPointsCount;v++)i.push(a.x+Math.cos(v*s)*this._diameter,a.y+Math.sin(v*s)*this._diameter,a.z);for(var b=i.length/3-2*this._sectionPolygonPointsCount,v=0;v<this._sectionPolygonPointsCount-1;v++)o.push(b+v,b+v+this._sectionPolygonPointsCount,b+v+this._sectionPolygonPointsCount+1),o.push(b+v,b+v+this._sectionPolygonPointsCount+1,b+v+1);o.push(b+this._sectionPolygonPointsCount-1,b+this._sectionPolygonPointsCount-1+this._sectionPolygonPointsCount,b+this._sectionPolygonPointsCount),o.push(b+this._sectionPolygonPointsCount-1,b+this._sectionPolygonPointsCount,b)}an.a.ComputeNormals(i,o,r),e.positions=i,e.normals=r,e.indices=o,e.applyToMesh(this,!0),this._autoStart&&this.start()},t.prototype.start=function(){var e=this;this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add(function(){e.update()}))},t.prototype.stop=function(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))},t.prototype.update=function(){var e=this.getVerticesData(Oe.b.PositionKind),i=this.getVerticesData(Oe.b.NormalKind),r=this._generator.getWorldMatrix();if(e&&i){for(var o=3*this._sectionPolygonPointsCount;o<e.length;o++)e[o-3*this._sectionPolygonPointsCount]=e[o]-i[o]/this._length*this._diameter;for(var o=3*this._sectionPolygonPointsCount;o<i.length;o++)i[o-3*this._sectionPolygonPointsCount]=i[o];for(var a=e.length-3*this._sectionPolygonPointsCount,s=2*Math.PI/this._sectionPolygonPointsCount,o=0;o<this._sectionPolygonPointsCount;o++)this._sectionVectors[o].copyFromFloats(Math.cos(o*s)*this._diameter,Math.sin(o*s)*this._diameter,0),this._sectionNormalVectors[o].copyFromFloats(Math.cos(o*s),Math.sin(o*s),0),l.e.TransformCoordinatesToRef(this._sectionVectors[o],r,this._sectionVectors[o]),l.e.TransformNormalToRef(this._sectionNormalVectors[o],r,this._sectionNormalVectors[o]);for(var o=0;o<this._sectionPolygonPointsCount;o++)e[a+3*o]=this._sectionVectors[o].x,e[a+3*o+1]=this._sectionVectors[o].y,e[a+3*o+2]=this._sectionVectors[o].z,i[a+3*o]=this._sectionNormalVectors[o].x,i[a+3*o+1]=this._sectionNormalVectors[o].y,i[a+3*o+2]=this._sectionNormalVectors[o].z;this.updateVerticesData(Oe.b.PositionKind,e,!0,!1),this.updateVerticesData(Oe.b.NormalKind,i,!0,!1)}},t.prototype.clone=function(e,i){return e===void 0&&(e=""),new t(e,i===void 0?this._generator:i,this.getScene(),this._diameter,this._length,this._autoStart)},t.prototype.serialize=function(e){n.prototype.serialize.call(this,e)},t.Parse=function(e,i){return new t(e.name,e._generator,i,e._diameter,e._length,e._autoStart)},t}(ot.a),dm=u(731),Oo=u(692),pm=u(648),gm=function(){function n(t,e,i){this.quality=t,this.distance=e,this.optimizeMesh=i}return n}(),jf=function(){function n(){this.running=!1,this._simplificationArray=[]}return n.prototype.addTask=function(t){this._simplificationArray.push(t)},n.prototype.executeNext=function(){var t=this._simplificationArray.pop();t?(this.running=!0,this.runSimplification(t)):this.running=!1},n.prototype.runSimplification=function(t){var e=this;if(t.parallelProcessing)t.settings.forEach(function(o){var a=e.getSimplifier(t);a.simplify(o,function(s){o.distance!==void 0&&t.mesh.addLODLevel(o.distance,s),s.isVisible=!0,o.quality===t.settings[t.settings.length-1].quality&&t.successCallback&&t.successCallback(),e.executeNext()})});else{var i=this.getSimplifier(t),r=function(o,a){i.simplify(o,function(s){o.distance!==void 0&&t.mesh.addLODLevel(o.distance,s),s.isVisible=!0,a()})};J.a.Run(t.settings.length,function(o){r(t.settings[o.index],function(){o.executeNext()})},function(){t.successCallback&&t.successCallback(),e.executeNext()})}},n.prototype.getSimplifier=function(t){switch(t.simplificationType){case Mo.QUADRATIC:default:return new Hf(t.mesh)}},n}(),Mo;(function(n){n[n.QUADRATIC=0]="QUADRATIC"})(Mo||(Mo={}));var mm=function(){function n(t){this.vertices=t,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}return n}(),vm=function(){function n(t,e){this.position=t,this.id=e,this.isBorder=!0,this.q=new Wf,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}return n.prototype.updatePosition=function(t){this.position.copyFrom(t)},n}(),Wf=function(){function n(t){this.data=new Array(10);for(var e=0;e<10;++e)t&&t[e]?this.data[e]=t[e]:this.data[e]=0}return n.prototype.det=function(t,e,i,r,o,a,s,c,v){var b=this.data[t]*this.data[o]*this.data[v]+this.data[i]*this.data[r]*this.data[c]+this.data[e]*this.data[a]*this.data[s]-this.data[i]*this.data[o]*this.data[s]-this.data[t]*this.data[a]*this.data[c]-this.data[e]*this.data[r]*this.data[v];return b},n.prototype.addInPlace=function(t){for(var e=0;e<10;++e)this.data[e]+=t.data[e]},n.prototype.addArrayInPlace=function(t){for(var e=0;e<10;++e)this.data[e]+=t[e]},n.prototype.add=function(t){for(var e=new n,i=0;i<10;++i)e.data[i]=this.data[i]+t.data[i];return e},n.FromData=function(t,e,i,r){return new n(n.DataFromNumbers(t,e,i,r))},n.DataFromNumbers=function(t,e,i,r){return[t*t,t*e,t*i,t*r,e*e,e*i,e*r,i*i,i*r,r*r]},n}(),_m=function(){function n(t,e){this.vertexId=t,this.triangleId=e}return n}(),Hf=function(){function n(t){this._mesh=t,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=ho.a}return n.prototype.simplify=function(t,e){var i=this;this.initDecimatedMesh(),J.a.Run(this._mesh.subMeshes.length,function(r){i.initWithMesh(r.index,function(){i.runDecimation(t,r.index,function(){r.executeNext()})},t.optimizeMesh)},function(){setTimeout(function(){e(i._reconstructedMesh)},0)})},n.prototype.runDecimation=function(t,e,i){var r=this,o=~~(this.triangles.length*t.quality),a=0,s=this.triangles.length,c=function(v,b){setTimeout(function(){v%5==0&&r.updateMesh(v===0);for(var C=0;C<r.triangles.length;++C)r.triangles[C].isDirty=!1;var M=1e-9*Math.pow(v+3,r.aggressiveness),N=function(D){var V=~~((r.triangles.length/2+D)%r.triangles.length),X=r.triangles[V];if(!!X&&!(X.error[3]>M||X.deleted||X.isDirty)){for(var ee=0;ee<3;++ee)if(X.error[ee]<M){var ie=[],ge=[],pe=X.vertices[ee],te=X.vertices[(ee+1)%3];if(pe.isBorder||te.isBorder)continue;var Ce=l.e.Zero();r.calculateError(pe,te,Ce);var Ae=new Array;if(r.isFlipped(pe,te,Ce,ie,Ae)||r.isFlipped(te,pe,Ce,ge,Ae)||ie.indexOf(!0)<0||ge.indexOf(!0)<0)continue;var De=new Array;if(Ae.forEach(function(Ne){De.indexOf(Ne)===-1&&(Ne.deletePending=!0,De.push(Ne))}),De.length%2!=0)continue;pe.q=te.q.add(pe.q),pe.updatePosition(Ce);var Fe=r.references.length;a=r.updateTriangles(pe,pe,ie,a),a=r.updateTriangles(pe,te,ge,a);var We=r.references.length-Fe;if(We<=pe.triangleCount){if(We)for(var Pe=0;Pe<We;Pe++)r.references[pe.triangleStart+Pe]=r.references[Fe+Pe]}else pe.triangleStart=Fe;pe.triangleCount=We;break}}};J.a.SyncAsyncForLoop(r.triangles.length,r.syncIterations,N,b,function(){return s-a<=o})},0)};J.a.Run(this.decimationIterations,function(v){s-a<=o?v.breakLoop():c(v.index,function(){v.executeNext()})},function(){setTimeout(function(){r.reconstructMesh(e),i()},0)})},n.prototype.initWithMesh=function(t,e,i){var r=this;this.vertices=[],this.triangles=[];var o=this._mesh.getVerticesData(Oe.b.PositionKind),a=this._mesh.getIndices(),s=this._mesh.subMeshes[t],c=function(M){if(i){for(var N=0;N<r.vertices.length;++N)if(r.vertices[N].position.equalsWithEpsilon(M,1e-4))return r.vertices[N]}return null},v=[],b=function(M){if(!!o){var N=M+s.verticesStart,D=l.e.FromArray(o,N*3),V=c(D)||new vm(D,r.vertices.length);V.originalOffsets.push(N),V.id===r.vertices.length&&r.vertices.push(V),v.push(V.id)}},C=s.verticesCount;J.a.SyncAsyncForLoop(C,this.syncIterations/4>>0,b,function(){var M=function(N){if(!!a){var D=s.indexStart/3+N,V=D*3,X=a[V+0],ee=a[V+1],ie=a[V+2],ge=r.vertices[v[X-s.verticesStart]],pe=r.vertices[v[ee-s.verticesStart]],te=r.vertices[v[ie-s.verticesStart]],Ce=new mm([ge,pe,te]);Ce.originalOffset=V,r.triangles.push(Ce)}};J.a.SyncAsyncForLoop(s.indexCount/3,r.syncIterations,M,function(){r.init(e)})})},n.prototype.init=function(t){var e=this,i=function(r){var o=e.triangles[r];o.normal=l.e.Cross(o.vertices[1].position.subtract(o.vertices[0].position),o.vertices[2].position.subtract(o.vertices[0].position)).normalize();for(var a=0;a<3;a++)o.vertices[a].q.addArrayInPlace(Wf.DataFromNumbers(o.normal.x,o.normal.y,o.normal.z,-l.e.Dot(o.normal,o.vertices[0].position)))};J.a.SyncAsyncForLoop(this.triangles.length,this.syncIterations,i,function(){var r=function(o){for(var a=e.triangles[o],s=0;s<3;++s)a.error[s]=e.calculateError(a.vertices[s],a.vertices[(s+1)%3]);a.error[3]=Math.min(a.error[0],a.error[1],a.error[2])};J.a.SyncAsyncForLoop(e.triangles.length,e.syncIterations,r,function(){t()})})},n.prototype.reconstructMesh=function(t){var e=[],i;for(i=0;i<this.vertices.length;++i)this.vertices[i].triangleCount=0;var r,o;for(i=0;i<this.triangles.length;++i)if(!this.triangles[i].deleted){for(r=this.triangles[i],o=0;o<3;++o)r.vertices[o].triangleCount=1;e.push(r)}var a=this._reconstructedMesh.getVerticesData(Oe.b.PositionKind)||[],s=this._reconstructedMesh.getVerticesData(Oe.b.NormalKind)||[],c=this._reconstructedMesh.getVerticesData(Oe.b.UVKind)||[],v=this._reconstructedMesh.getVerticesData(Oe.b.ColorKind)||[],b=this._mesh.getVerticesData(Oe.b.NormalKind),C=this._mesh.getVerticesData(Oe.b.UVKind),M=this._mesh.getVerticesData(Oe.b.ColorKind),N=0;for(i=0;i<this.vertices.length;++i){var D=this.vertices[i];D.id=N,D.triangleCount&&D.originalOffsets.forEach(function(te){a.push(D.position.x),a.push(D.position.y),a.push(D.position.z),b&&b.length&&(s.push(b[te*3]),s.push(b[te*3+1]),s.push(b[te*3+2])),C&&C.length&&(c.push(C[te*2]),c.push(C[te*2+1])),M&&M.length&&(v.push(M[te*4]),v.push(M[te*4+1]),v.push(M[te*4+2]),v.push(M[te*4+3])),++N})}var V=this._reconstructedMesh.getTotalIndices(),X=this._reconstructedMesh.getTotalVertices(),ee=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];var ie=this._reconstructedMesh.getIndices(),ge=this._mesh.getIndices();for(i=0;i<e.length;++i)r=e[i],[0,1,2].forEach(function(te){var Ce=ge[r.originalOffset+te],Ae=r.vertices[te].originalOffsets.indexOf(Ce);Ae<0&&(Ae=0),ie.push(r.vertices[te].id+Ae+X)});this._reconstructedMesh.setIndices(ie),this._reconstructedMesh.setVerticesData(Oe.b.PositionKind,a),s.length>0&&this._reconstructedMesh.setVerticesData(Oe.b.NormalKind,s),c.length>0&&this._reconstructedMesh.setVerticesData(Oe.b.UVKind,c),v.length>0&&this._reconstructedMesh.setVerticesData(Oe.b.ColorKind,v);var pe=this._mesh.subMeshes[t];t>0&&(this._reconstructedMesh.subMeshes=[],ee.forEach(function(te){Ao.a.AddToMesh(te.materialIndex,te.verticesStart,te.verticesCount,te.indexStart,te.indexCount,te.getMesh())}),Ao.a.AddToMesh(pe.materialIndex,X,N,V,e.length*3,this._reconstructedMesh))},n.prototype.initDecimatedMesh=function(){this._reconstructedMesh=new ot.a(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId},n.prototype.isFlipped=function(t,e,i,r,o){for(var a=0;a<t.triangleCount;++a){var s=this.triangles[this.references[t.triangleStart+a].triangleId];if(!s.deleted){var c=this.references[t.triangleStart+a].vertexId,v=s.vertices[(c+1)%3],b=s.vertices[(c+2)%3];if(v===e||b===e){r[a]=!0,o.push(s);continue}var C=v.position.subtract(i);C=C.normalize();var M=b.position.subtract(i);if(M=M.normalize(),Math.abs(l.e.Dot(C,M))>.999)return!0;var N=l.e.Cross(C,M).normalize();if(r[a]=!1,l.e.Dot(N,s.normal)<.2)return!0}}return!1},n.prototype.updateTriangles=function(t,e,i,r){for(var o=r,a=0;a<e.triangleCount;++a){var s=this.references[e.triangleStart+a],c=this.triangles[s.triangleId];if(!c.deleted){if(i[a]&&c.deletePending){c.deleted=!0,o++;continue}c.vertices[s.vertexId]=t,c.isDirty=!0,c.error[0]=this.calculateError(c.vertices[0],c.vertices[1])+c.borderFactor/2,c.error[1]=this.calculateError(c.vertices[1],c.vertices[2])+c.borderFactor/2,c.error[2]=this.calculateError(c.vertices[2],c.vertices[0])+c.borderFactor/2,c.error[3]=Math.min(c.error[0],c.error[1],c.error[2]),this.references.push(s)}}return o},n.prototype.identifyBorder=function(){for(var t=0;t<this.vertices.length;++t){var e=[],i=[],r=this.vertices[t],o;for(o=0;o<r.triangleCount;++o)for(var a=this.triangles[this.references[r.triangleStart+o].triangleId],s=0;s<3;s++){for(var c=0,v=a.vertices[s];c<e.length&&i[c]!==v.id;)++c;c===e.length?(e.push(1),i.push(v.id)):e[c]++}for(o=0;o<e.length;++o)e[o]===1?this.vertices[i[o]].isBorder=!0:this.vertices[i[o]].isBorder=!1}},n.prototype.updateMesh=function(t){t===void 0&&(t=!1);var e;if(!t){var i=[];for(e=0;e<this.triangles.length;++e)this.triangles[e].deleted||i.push(this.triangles[e]);this.triangles=i}for(e=0;e<this.vertices.length;++e)this.vertices[e].triangleCount=0,this.vertices[e].triangleStart=0;var r,o,a;for(e=0;e<this.triangles.length;++e)for(r=this.triangles[e],o=0;o<3;++o)a=r.vertices[o],a.triangleCount++;var s=0;for(e=0;e<this.vertices.length;++e)this.vertices[e].triangleStart=s,s+=this.vertices[e].triangleCount,this.vertices[e].triangleCount=0;var c=new Array(this.triangles.length*3);for(e=0;e<this.triangles.length;++e)for(r=this.triangles[e],o=0;o<3;++o)a=r.vertices[o],c[a.triangleStart+a.triangleCount]=new _m(o,e),a.triangleCount++;this.references=c,t&&this.identifyBorder()},n.prototype.vertexError=function(t,e){var i=e.x,r=e.y,o=e.z;return t.data[0]*i*i+2*t.data[1]*i*r+2*t.data[2]*i*o+2*t.data[3]*i+t.data[4]*r*r+2*t.data[5]*r*o+2*t.data[6]*r+t.data[7]*o*o+2*t.data[8]*o+t.data[9]},n.prototype.calculateError=function(t,e,i){var r=t.q.add(e.q),o=t.isBorder&&e.isBorder,a=0,s=r.det(0,1,2,1,4,5,2,5,7);if(s!==0&&!o)i||(i=l.e.Zero()),i.x=-1/s*r.det(1,2,3,4,5,6,5,7,8),i.y=1/s*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/s*r.det(0,1,3,1,4,6,2,5,8),a=this.vertexError(r,i);else{var c=t.position.add(e.position).divide(new l.e(2,2,2)),v=this.vertexError(r,t.position),b=this.vertexError(r,e.position),C=this.vertexError(r,c);a=Math.min(v,b,C),a===v?i&&i.copyFrom(t.position):a===b?i&&i.copyFrom(e.position):i&&i.copyFrom(c)}return a},n}();Object.defineProperty(q.a.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new jf;var n=this._getComponent(H.a.NAME_SIMPLIFICATIONQUEUE);n||(n=new kf(this),this._addComponent(n))}return this._simplificationQueue},set:function(n){this._simplificationQueue=n},enumerable:!0,configurable:!0}),ot.a.prototype.simplify=function(n,t,e,i){return t===void 0&&(t=!0),e===void 0&&(e=Mo.QUADRATIC),this.getScene().simplificationQueue.addTask({settings:n,parallelProcessing:t,mesh:this,simplificationType:e,successCallback:i}),this};var kf=function(){function n(t){this.name=H.a.NAME_SIMPLIFICATIONQUEUE,this.scene=t}return n.prototype.register=function(){this.scene._beforeCameraUpdateStage.registerStep(H.a.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n.prototype._beforeCameraUpdate=function(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()},n}(),Xf=u(737),ym=u(721),bm=u(734),Yf=u(697),Em=u(706),Pm=u(735),Cm=u(736),Sm=u(617),Tm=u(738),Rm=u(739),Am=u(740),Om=u(636),Mm=u(741),xm=u(742),Dm=u(708),sy=u(555),Im=u(608),Kf=u(561),Lm=function(){function n(t){if(t===void 0&&(t=Recast),this.bjsRECAST={},this.name="RecastJSPlugin",this._maximumSubStepCount=10,this._timeStep=1/60,typeof t=="function"?t(this.bjsRECAST):this.bjsRECAST=t,!this.isSupported()){p.a.Error("RecastJS is not available. Please make sure you included the js file.");return}this.setTimeStep()}return n.prototype.setTimeStep=function(t){t===void 0&&(t=1/60),this._timeStep=t},n.prototype.getTimeStep=function(){return this._timeStep},n.prototype.setMaximumSubStepCount=function(t){t===void 0&&(t=10),this._maximumSubStepCount=t},n.prototype.getMaximumSubStepCount=function(){return this._maximumSubStepCount},n.prototype.createNavMesh=function(t,e){var i=new this.bjsRECAST.rcConfig;i.cs=e.cs,i.ch=e.ch,i.borderSize=e.borderSize?e.borderSize:0,i.tileSize=e.tileSize?e.tileSize:0,i.walkableSlopeAngle=e.walkableSlopeAngle,i.walkableHeight=e.walkableHeight,i.walkableClimb=e.walkableClimb,i.walkableRadius=e.walkableRadius,i.maxEdgeLen=e.maxEdgeLen,i.maxSimplificationError=e.maxSimplificationError,i.minRegionArea=e.minRegionArea,i.mergeRegionArea=e.mergeRegionArea,i.maxVertsPerPoly=e.maxVertsPerPoly,i.detailSampleDist=e.detailSampleDist,i.detailSampleMaxError=e.detailSampleMaxError,this.navMesh=new this.bjsRECAST.NavMesh;var r,o,a,s=[],c=[],v=0;for(r=0;r<t.length;r++)if(t[r]){var b=t[r],C=b.getIndices();if(!C)continue;var M=b.getVerticesData(Oe.b.PositionKind,!1,!1);if(!M)continue;var N=[],D=b.computeWorldMatrix(!0);if(b.hasThinInstances)for(var V=b.thinInstanceGetWorldMatrices(),X=0;X<V.length;X++){var ee=new et.k,ie=V[X];ie.multiplyToRef(D,ee),N.push(ee)}else N.push(D);for(var ge=0;ge<N.length;ge++){var pe=N[ge];for(o=0;o<C.length;o++)s.push(C[o]+v);var te=et.z.Zero(),Ce=et.z.Zero();for(a=0;a<M.length;a+=3)et.z.FromArrayToRef(M,a,Ce),et.z.TransformCoordinatesToRef(Ce,pe,te),c.push(te.x,te.y,te.z);v+=M.length/3}}this.navMesh.build(c,v,s,s.length,i)},n.prototype.createDebugNavMesh=function(t){var e,i,r=this.navMesh.getDebugNavMesh(),o=r.getTriangleCount(),a=[],s=[];for(e=0;e<o*3;e++)a.push(e);for(e=0;e<o;e++)for(i=0;i<3;i++){var c=r.getTriangle(e).getPoint(i);s.push(c.x,c.y,c.z)}var v=new ot.a("NavMeshDebug",t),b=new an.a;return b.indices=a,b.positions=s,b.applyToMesh(v,!1),v},n.prototype.getClosestPoint=function(t){var e=new this.bjsRECAST.Vec3(t.x,t.y,t.z),i=this.navMesh.getClosestPoint(e),r=new et.z(i.x,i.y,i.z);return r},n.prototype.getClosestPointToRef=function(t,e){var i=new this.bjsRECAST.Vec3(t.x,t.y,t.z),r=this.navMesh.getClosestPoint(i);e.set(r.x,r.y,r.z)},n.prototype.getRandomPointAround=function(t,e){var i=new this.bjsRECAST.Vec3(t.x,t.y,t.z),r=this.navMesh.getRandomPointAround(i,e),o=new et.z(r.x,r.y,r.z);return o},n.prototype.getRandomPointAroundToRef=function(t,e,i){var r=new this.bjsRECAST.Vec3(t.x,t.y,t.z),o=this.navMesh.getRandomPointAround(r,e);i.set(o.x,o.y,o.z)},n.prototype.moveAlong=function(t,e){var i=new this.bjsRECAST.Vec3(t.x,t.y,t.z),r=new this.bjsRECAST.Vec3(e.x,e.y,e.z),o=this.navMesh.moveAlong(i,r),a=new et.z(o.x,o.y,o.z);return a},n.prototype.moveAlongToRef=function(t,e,i){var r=new this.bjsRECAST.Vec3(t.x,t.y,t.z),o=new this.bjsRECAST.Vec3(e.x,e.y,e.z),a=this.navMesh.moveAlong(r,o);i.set(a.x,a.y,a.z)},n.prototype.computePath=function(t,e){var i,r=new this.bjsRECAST.Vec3(t.x,t.y,t.z),o=new this.bjsRECAST.Vec3(e.x,e.y,e.z),a=this.navMesh.computePath(r,o),s=a.getPointCount(),c=[];for(i=0;i<s;i++){var v=a.getPoint(i);c.push(new et.z(v.x,v.y,v.z))}return c},n.prototype.createCrowd=function(t,e,i){var r=new Qf(this,t,e,i);return r},n.prototype.setDefaultQueryExtent=function(t){var e=new this.bjsRECAST.Vec3(t.x,t.y,t.z);this.navMesh.setDefaultQueryExtent(e)},n.prototype.getDefaultQueryExtent=function(){var t=this.navMesh.getDefaultQueryExtent();return new et.z(t.x,t.y,t.z)},n.prototype.buildFromNavmeshData=function(t){var e=t.length*t.BYTES_PER_ELEMENT,i=this.bjsRECAST._malloc(e),r=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,i,e);r.set(t);var o=new this.bjsRECAST.NavmeshData;o.dataPointer=r.byteOffset,o.size=t.length,this.navMesh=new this.bjsRECAST.NavMesh,this.navMesh.buildFromNavmeshData(o),this.bjsRECAST._free(r.byteOffset)},n.prototype.getNavmeshData=function(){var t=this.navMesh.getNavmeshData(),e=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,t.dataPointer,t.size),i=new Uint8Array(t.size);return i.set(e),this.navMesh.freeNavmeshData(t),i},n.prototype.getDefaultQueryExtentToRef=function(t){var e=this.navMesh.getDefaultQueryExtent();t.set(e.x,e.y,e.z)},n.prototype.dispose=function(){},n.prototype.addCylinderObstacle=function(t,e,i){return this.navMesh.addCylinderObstacle(new this.bjsRECAST.Vec3(t.x,t.y,t.z),e,i)},n.prototype.addBoxObstacle=function(t,e,i){return this.navMesh.addBoxObstacle(new this.bjsRECAST.Vec3(t.x,t.y,t.z),new this.bjsRECAST.Vec3(e.x,e.y,e.z),i)},n.prototype.removeObstacle=function(t){this.navMesh.removeObstacle(t)},n.prototype.isSupported=function(){return this.bjsRECAST!==void 0},n}(),Qf=function(){function n(t,e,i,r){var o=this;this.recastCrowd={},this.transforms=new Array,this.agents=new Array,this._onBeforeAnimationsObserver=null,this.bjsRECASTPlugin=t,this.recastCrowd=new this.bjsRECASTPlugin.bjsRECAST.Crowd(e,i,this.bjsRECASTPlugin.navMesh.getNavMesh()),this._scene=r,this._onBeforeAnimationsObserver=r.onBeforeAnimationsObservable.add(function(){o.update(r.getEngine().getDeltaTime()*.001)})}return n.prototype.addAgent=function(t,e,i){var r=new this.bjsRECASTPlugin.bjsRECAST.dtCrowdAgentParams;r.radius=e.radius,r.height=e.height,r.maxAcceleration=e.maxAcceleration,r.maxSpeed=e.maxSpeed,r.collisionQueryRange=e.collisionQueryRange,r.pathOptimizationRange=e.pathOptimizationRange,r.separationWeight=e.separationWeight,r.updateFlags=7,r.obstacleAvoidanceType=0,r.queryFilterType=0,r.userData=0;var o=this.recastCrowd.addAgent(new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z),r);return this.transforms.push(i),this.agents.push(o),o},n.prototype.getAgentPosition=function(t){var e=this.recastCrowd.getAgentPosition(t);return new et.z(e.x,e.y,e.z)},n.prototype.getAgentPositionToRef=function(t,e){var i=this.recastCrowd.getAgentPosition(t);e.set(i.x,i.y,i.z)},n.prototype.getAgentVelocity=function(t){var e=this.recastCrowd.getAgentVelocity(t);return new et.z(e.x,e.y,e.z)},n.prototype.getAgentVelocityToRef=function(t,e){var i=this.recastCrowd.getAgentVelocity(t);e.set(i.x,i.y,i.z)},n.prototype.getAgentNextTargetPath=function(t){var e=this.recastCrowd.getAgentNextTargetPath(t);return new et.z(e.x,e.y,e.z)},n.prototype.getAgentNextTargetPathToRef=function(t,e){var i=this.recastCrowd.getAgentNextTargetPath(t);e.set(i.x,i.y,i.z)},n.prototype.getAgentState=function(t){return this.recastCrowd.getAgentState(t)},n.prototype.overOffmeshConnection=function(t){return this.recastCrowd.overOffmeshConnection(t)},n.prototype.agentGoto=function(t,e){this.recastCrowd.agentGoto(t,new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z))},n.prototype.agentTeleport=function(t,e){this.recastCrowd.agentTeleport(t,new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z))},n.prototype.updateAgentParameters=function(t,e){var i=this.recastCrowd.getAgentParameters(t);e.radius!==void 0&&(i.radius=e.radius),e.height!==void 0&&(i.height=e.height),e.maxAcceleration!==void 0&&(i.maxAcceleration=e.maxAcceleration),e.maxSpeed!==void 0&&(i.maxSpeed=e.maxSpeed),e.collisionQueryRange!==void 0&&(i.collisionQueryRange=e.collisionQueryRange),e.pathOptimizationRange!==void 0&&(i.pathOptimizationRange=e.pathOptimizationRange),e.separationWeight!==void 0&&(i.separationWeight=e.separationWeight),this.recastCrowd.setAgentParameters(t,i)},n.prototype.removeAgent=function(t){this.recastCrowd.removeAgent(t);var e=this.agents.indexOf(t);e>-1&&(this.agents.splice(e,1),this.transforms.splice(e,1))},n.prototype.getAgents=function(){return this.agents},n.prototype.update=function(t){this.bjsRECASTPlugin.navMesh.update();var e=this.bjsRECASTPlugin.getTimeStep(),i=this.bjsRECASTPlugin.getMaximumSubStepCount();if(e<=et.i)this.recastCrowd.update(t);else{var r=Math.floor(t/e);i&&r>i&&(r=i),r<1&&(r=1);for(var o=t/r,a=0;a<r;a++)this.recastCrowd.update(o)}for(var s=0;s<this.agents.length;s++)this.transforms[s].position=this.getAgentPosition(this.agents[s])},n.prototype.setDefaultQueryExtent=function(t){var e=new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z);this.recastCrowd.setDefaultQueryExtent(e)},n.prototype.getDefaultQueryExtent=function(){var t=this.recastCrowd.getDefaultQueryExtent();return new et.z(t.x,t.y,t.z)},n.prototype.getDefaultQueryExtentToRef=function(t){var e=this.recastCrowd.getDefaultQueryExtent();t.set(e.x,e.y,e.z)},n.prototype.getCorners=function(t){var e,i=this.recastCrowd.getPath(t),r=i.getPointCount(),o=[];for(e=0;e<r;e++){var a=i.getPoint(e);o.push(new et.z(a.x,a.y,a.z))}return o},n.prototype.dispose=function(){this.recastCrowd.destroy(),this._scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null},n}();W.a.OfflineProviderFactory=function(n,t,e){return e===void 0&&(e=!1),new Zf(n,t,e)};var Zf=function(){function n(t,e,i){var r=this;i===void 0&&(i=!1),this._idbFactory=typeof window!="undefined"?window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB:indexedDB,this._callbackManifestChecked=e,this._currentSceneUrl=n._ReturnFullUrlLocation(t),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,n.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,J.b.SetImmediate(function(){r._callbackManifestChecked(!0)})):this._checkManifestFile():this._callbackManifestChecked(!0)}return Object.defineProperty(n.prototype,"enableSceneOffline",{get:function(){return this._enableSceneOffline},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"enableTexturesOffline",{get:function(){return this._enableTexturesOffline},enumerable:!1,configurable:!0}),n.prototype._checkManifestFile=function(){var t=this,e=function(){t._enableSceneOffline=!1,t._enableTexturesOffline=!1,t._callbackManifestChecked(!1)},i=!1,r=this._currentSceneUrl+".manifest",o=new Ar.a;navigator.onLine&&(i=!0,r=r+(r.match(/\?/)==null?"?":"&")+Date.now()),o.open("GET",r),o.addEventListener("load",function(){if(o.status===200||n._ValidateXHRData(o,1))try{var a=JSON.parse(o.response);t._enableSceneOffline=a.enableSceneOffline,t._enableTexturesOffline=a.enableTexturesOffline&&n.IsUASupportingBlobStorage,a.version&&!isNaN(parseInt(a.version))&&(t._manifestVersionFound=a.version),t._callbackManifestChecked&&t._callbackManifestChecked(!0)}catch(s){e()}else e()},!1),o.addEventListener("error",function(){if(i){i=!1;var a=t._currentSceneUrl+".manifest";o.open("GET",a),o.send()}else e()},!1);try{o.send()}catch(a){p.a.Error("Error on XHR send request."),this._callbackManifestChecked(!1)}},n.prototype.open=function(t,e){var i=this,r=function(){i._isSupported=!1,e&&e()};if(!this._idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline))this._isSupported=!1,e&&e();else if(this._db)t&&t();else{this._hasReachedQuota=!1,this._isSupported=!0;var o=this._idbFactory.open("babylonjs",1);o.onerror=function(){r()},o.onblocked=function(){p.a.Error("IDB request blocked. Please reload the page."),r()},o.onsuccess=function(){i._db=o.result,t()},o.onupgradeneeded=function(a){if(i._db=a.target.result,i._db)try{i._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),i._db.createObjectStore("versions",{keyPath:"sceneUrl"}),i._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(s){p.a.Error("Error while creating object stores. Exception: "+s.message),r()}}}},n.prototype.loadImage=function(t,e){var i=this,r=n._ReturnFullUrlLocation(t),o=function(){!i._hasReachedQuota&&i._db!==null?i._saveImageIntoDBAsync(r,e):e.src=t};this._mustUpdateRessources?o():this._loadImageFromDBAsync(r,e,o)},n.prototype._loadImageFromDBAsync=function(t,e,i){if(this._isSupported&&this._db!==null){var r,o=this._db.transaction(["textures"]);o.onabort=function(){e.src=t},o.oncomplete=function(){var s;if(r){var c=window.URL||window.webkitURL;s=c.createObjectURL(r.data),e.onerror=function(){p.a.Error("Error loading image from blob URL: "+s+" switching back to web url: "+t),e.src=t},e.src=s}else i()};var a=o.objectStore("textures").get(t);a.onsuccess=function(s){r=s.target.result},a.onerror=function(){p.a.Error("Error loading texture "+t+" from DB."),e.src=t}}else p.a.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),e.src=t},n.prototype._saveImageIntoDBAsync=function(t,e){var i=this;if(this._isSupported){var r=function(){var s;if(a){var c=window.URL||window.webkitURL;try{s=c.createObjectURL(a)}catch(v){s=c.createObjectURL(a)}}s&&(e.src=s)};if(n.IsUASupportingBlobStorage){var o=new Ar.a,a;o.open("GET",t),o.responseType="blob",o.addEventListener("load",function(){if(o.status===200&&i._db){a=o.response;var s=i._db.transaction(["textures"],"readwrite");s.onabort=function(b){try{var C=b.srcElement||b.target,M=C.error;M&&M.name==="QuotaExceededError"&&(i._hasReachedQuota=!0)}catch(N){}r()},s.oncomplete=function(){r()};var c={textureUrl:t,data:a};try{var v=s.objectStore("textures").put(c);v.onsuccess=function(){},v.onerror=function(){r()}}catch(b){b.code===25&&(n.IsUASupportingBlobStorage=!1,i._enableTexturesOffline=!1),e.src=t}}else e.src=t},!1),o.addEventListener("error",function(){p.a.Error("Error in XHR request in BABYLON.Database."),e.src=t},!1),o.send()}else e.src=t}else p.a.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),e.src=t},n.prototype._checkVersionFromDB=function(t,e){var i=this,r=function(){i._saveVersionIntoDBAsync(t,e)};this._loadVersionFromDBAsync(t,e,r)},n.prototype._loadVersionFromDBAsync=function(t,e,i){var r=this;if(this._isSupported&&this._db){var o;try{var a=this._db.transaction(["versions"]);a.oncomplete=function(){o?r._manifestVersionFound!==o.data?(r._mustUpdateRessources=!0,i()):e(o.data):(r._mustUpdateRessources=!0,i())},a.onabort=function(){e(-1)};var s=a.objectStore("versions").get(t);s.onsuccess=function(c){o=c.target.result},s.onerror=function(){p.a.Error("Error loading version for scene "+t+" from DB."),e(-1)}}catch(c){p.a.Error("Error while accessing 'versions' object store (READ OP). Exception: "+c.message),e(-1)}}else p.a.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),e(-1)},n.prototype._saveVersionIntoDBAsync=function(t,e){var i=this;if(this._isSupported&&!this._hasReachedQuota&&this._db)try{var r=this._db.transaction(["versions"],"readwrite");r.onabort=function(s){try{var c=s.srcElement.error;c&&c.name==="QuotaExceededError"&&(i._hasReachedQuota=!0)}catch(v){}e(-1)},r.oncomplete=function(){e(i._manifestVersionFound)};var o={sceneUrl:t,data:this._manifestVersionFound},a=r.objectStore("versions").put(o);a.onsuccess=function(){},a.onerror=function(){p.a.Error("Error in DB add version request in BABYLON.Database.")}}catch(s){p.a.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+s.message),e(-1)}else e(-1)},n.prototype.loadFile=function(t,e,i,r,o){var a=this,s=n._ReturnFullUrlLocation(t),c=function(){a._saveFileAsync(s,e,i,o,r)};this._checkVersionFromDB(s,function(v){v!==-1?a._mustUpdateRessources?a._saveFileAsync(s,e,i,o,r):a._loadFileAsync(s,e,c):r&&r()})},n.prototype._loadFileAsync=function(t,e,i){if(this._isSupported&&this._db){var r;t.indexOf(".babylon")!==-1?r="scenes":r="textures";var o,a=this._db.transaction([r]);a.oncomplete=function(){o?e(o.data):i()},a.onabort=function(){i()};var s=a.objectStore(r).get(t);s.onsuccess=function(c){o=c.target.result},s.onerror=function(){p.a.Error("Error loading file "+t+" from DB."),i()}}else p.a.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),e()},n.prototype._saveFileAsync=function(t,e,i,r,o){var a=this;if(this._isSupported){var s;t.indexOf(".babylon")!==-1?s="scenes":s="textures";var c=new Ar.a,v;c.open("GET",t+"?"+Date.now()),r&&(c.responseType="arraybuffer"),i&&(c.onprogress=i),c.addEventListener("load",function(){if(c.status===200||c.status<400&&n._ValidateXHRData(c,r?6:1))if(v=r?c.response:c.responseText,!a._hasReachedQuota&&a._db){var b=a._db.transaction([s],"readwrite");b.onabort=function(N){try{var D=N.srcElement.error;D&&D.name==="QuotaExceededError"&&(a._hasReachedQuota=!0)}catch(V){}e(v)},b.oncomplete=function(){e(v)};var C;s==="scenes"?C={sceneUrl:t,data:v,version:a._manifestVersionFound}:C={textureUrl:t,data:v};try{var M=b.objectStore(s).put(C);M.onsuccess=function(){},M.onerror=function(){p.a.Error("Error in DB add file request in BABYLON.Database.")}}catch(N){e(v)}}else e(v);else c.status>=400&&o?o(c):e()},!1),c.addEventListener("error",function(){p.a.Error("error on XHR request."),e()},!1),c.send()}else p.a.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),e()},n._ValidateXHRData=function(t,e){e===void 0&&(e=7);try{if(e&1){if(t.responseText&&t.responseText.length>0)return!0;if(e===1)return!1}if(e&2){var i=qo.GetTGAHeader(t.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(e===2)return!1}if(e&4){var r=new Uint8Array(t.response,0,3);return r[0]===68&&r[1]===68&&r[2]===83}}catch(o){}return!1},n.IsUASupportingBlobStorage=!0,n.IDBStorageEnabled=!1,n._ParseURL=function(t){var e=document.createElement("a");e.href=t;var i=t.substring(0,t.lastIndexOf("#")),r=t.substring(i.lastIndexOf("/")+1,t.length),o=t.substring(0,t.indexOf(r,0));return o},n._ReturnFullUrlLocation=function(t){return t.indexOf("http:/")===-1&&t.indexOf("https:/")===-1&&typeof window!="undefined"?n._ParseURL(window.location.href)+t:t},n}(),qs=function(){function n(t,e,i){this.gradient=t,this.color1=e,this.color2=i}return n.prototype.getColorToRef=function(t){if(!this.color2){t.copyFrom(this.color1);return}m.b.LerpToRef(this.color1,this.color2,Math.random(),t)},n}(),Jf=function(){function n(t,e){this.gradient=t,this.color=e}return n}(),el=function(){function n(t,e,i){this.gradient=t,this.factor1=e,this.factor2=i}return n.prototype.getFactor=function(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()},n}(),Qi=function(){function n(){}return n.GetCurrentGradient=function(t,e,i){if(e[0].gradient>t){i(e[0],e[0],1);return}for(var r=0;r<e.length-1;r++){var o=e[r],a=e[r+1];if(t>=o.gradient&&t<=a.gradient){var s=(t-o.gradient)/(a.gradient-o.gradient);i(o,a,s);return}}var c=e.length-1;i(e[c],e[c],1)},n}(),$f=function(){function n(t){this.particleSystem=t,this.position=l.e.Zero(),this.direction=l.e.Zero(),this.color=new m.b(0,0,0,0),this.colorStep=new m.b(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new l.d(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new m.b(0,0,0,0),this._currentColor2=new m.b(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=n._Count++,!!this.particleSystem.isAnimationSheetEnabled&&this.updateCellInfoFromSystem()}return n.prototype.updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID},n.prototype.updateCellIndex=function(){var t=this.age,e=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),e===0?(e=1,t=this._randomCellOffset):t+=this._randomCellOffset);var i=this._initialEndSpriteCellID-this._initialStartSpriteCellID,r=$e.a.Clamp(t*e%this.lifeTime/this.lifeTime);this.cellIndex=this._initialStartSpriteCellID+r*i|0},n.prototype._inheritParticleInfoToSubEmitter=function(t){if(t.particleSystem.emitter.position){var e=t.particleSystem.emitter;if(e.position.copyFrom(this.position),t.inheritDirection){var i=l.c.Vector3[0];this.direction.normalizeToRef(i),e.setDirection(i,0,Math.PI/2)}}else{var r=t.particleSystem.emitter;r.copyFrom(this.position)}this.direction.scaleToRef(t.inheritedVelocityAmount/2,l.c.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(l.c.Vector3[0])},n.prototype._inheritParticleInfoToSubEmitters=function(){var t=this;this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(function(e){t._inheritParticleInfoToSubEmitter(e)})},n.prototype._reset=function(){this.age=0,this.id=n._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0},n.prototype.copyTo=function(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this._initialStartSpriteCellID,t._initialEndSpriteCellID=this._initialEndSpriteCellID),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new l.f(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))},n._Count=0,n}(),Dn;(function(n){n[n.ATTACHED=0]="ATTACHED",n[n.END=1]="END"})(Dn||(Dn={}));var xo=function(){function n(t){if(this.particleSystem=t,this.type=Dn.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!t.emitter||!t.emitter.dispose){var e=f.a.GetClass("BABYLON.AbstractMesh");t.emitter=new e("SubemitterSystemEmitter",t.getScene())}t.onDisposeObservable.add(function(){t.emitter&&t.emitter.dispose&&t.emitter.dispose()})}return n.prototype.clone=function(){var t=this.particleSystem.emitter;if(!t)t=new l.e;else if(t instanceof l.e)t=t.clone();else if(t.getClassName().indexOf("Mesh")!==-1){var e=f.a.GetClass("BABYLON.Mesh");t=new e("",t.getScene()),t.isVisible=!1}var i=new n(this.particleSystem.clone("",t));return i.particleSystem.name+="Clone",i.type=this.type,i.inheritDirection=this.inheritDirection,i.inheritedVelocityAmount=this.inheritedVelocityAmount,i.particleSystem._disposeEmitterOnDispose=!0,i.particleSystem.disposeOnStop=!0,i},n.prototype.serialize=function(){var t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(),t},n._ParseParticleSystem=function(t,e,i){throw Re.a.WarnImport("ParseParticle")},n.Parse=function(t,e,i){var r=t.particleSystem,o=new n(n._ParseParticleSystem(r,e,i));return o.type=t.type,o.inheritDirection=t.inheritDirection,o.inheritedVelocityAmount=t.inheritedVelocityAmount,o.particleSystem._isSubEmitter=!0,o},n.prototype.dispose=function(){this.particleSystem.dispose()},n}(),qf="particlesPixelShader",eh=`
varying vec2 vUV;
varying vec4 vColor;
uniform vec4 textureMask;
uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
uniform sampler2D rampSampler;
#endif
void main(void) {
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);
vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;
float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);
vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));
baseColor.rgb*=rampColor.rgb;

float finalAlpha=baseColor.a;
baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;
baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif


#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);
baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
}`;qe.a.ShadersStore[qf]=eh;var ly={name:qf,shader:eh},th="particlesVertexShader",ih=`
attribute vec3 position;
attribute vec4 color;
attribute float angle;
attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;

uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos;
#endif

varying vec2 vUV;
varying vec4 vColor;
varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix=mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix=mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#endif
void main(void) {
vec2 cornerPos;
cornerPos=(vec2(offset.x-0.5,offset.y-0.5)-translationPivot)*size+translationPivot;
#ifdef BILLBOARD

vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=position-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=position-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;
vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif

gl_Position=projection*vec4(viewPos,1.0);
#else

vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=normalize(direction);
vPositionW=rotate(yaxis,rotatedCorner);
gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);
float columnOffset=cellIndex-rowOffset/particlesInfos.z;
vec2 uvScale=particlesInfos.xy;
vec2 uvOffset=vec2(offset.x ,1.0-offset.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif

#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
}`;qe.a.ShadersStore[th]=ih;var uy={name:th,shader:ih},mi=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){o===void 0&&(o=null),a===void 0&&(a=!1),s===void 0&&(s=.01);var c=n.call(this,e)||this;c._inheritedVelocityOffset=new l.e,c.onDisposeObservable=new _.c,c.onStoppedObservable=new _.c,c._particles=new Array,c._stockParticles=new Array,c._newPartsExcess=0,c._vertexBuffers={},c._scaledColorStep=new m.b(0,0,0,0),c._colorDiff=new m.b(0,0,0,0),c._scaledDirection=l.e.Zero(),c._scaledGravity=l.e.Zero(),c._currentRenderId=-1,c._useInstancing=!1,c._started=!1,c._stopped=!1,c._actualFrame=0,c._currentEmitRate1=0,c._currentEmitRate2=0,c._currentStartSize1=0,c._currentStartSize2=0,c._rawTextureWidth=256,c._useRampGradients=!1,c._disposeEmitterOnDispose=!1,c.isLocal=!1,c._onBeforeDrawParticlesObservable=null,c.recycleParticle=function(b){var C=c._particles.pop();C!==b&&C.copyTo(b),c._stockParticles.push(C)},c._createParticle=function(){var b;if(c._stockParticles.length!==0?(b=c._stockParticles.pop(),b._reset()):b=new $f(c),c._subEmitters&&c._subEmitters.length>0){var C=c._subEmitters[Math.floor(Math.random()*c._subEmitters.length)];b._attachedSubEmitters=[],C.forEach(function(M){if(M.type===Dn.ATTACHED){var N=M.clone();b._attachedSubEmitters.push(N),N.particleSystem.start()}})}return b},c._emitFromParticle=function(b){if(!(!c._subEmitters||c._subEmitters.length===0)){var C=Math.floor(Math.random()*c._subEmitters.length);c._subEmitters[C].forEach(function(M){if(M.type===Dn.END){var N=M.clone();b._inheritParticleInfoToSubEmitter(N),N.particleSystem._rootParticleSystem=c,c.activeSubSystems.push(N.particleSystem),N.particleSystem.start()}})}},c._capacity=i,c._epsilon=s,c._isAnimationSheetEnabled=a,!r||r.getClassName()==="Scene"?(c._scene=r||Yt.a.LastCreatedScene,c._engine=c._scene.getEngine(),c.uniqueId=c._scene.getUniqueId(),c._scene.particleSystems.push(c)):(c._engine=r,c.defaultProjectionMatrix=l.a.PerspectiveFovLH(.8,1,.1,100)),c._engine.getCaps().vertexArrayObject&&(c._vertexArrayObject=null),c._attachImageProcessingConfiguration(null),c._customEffect={0:o},c._useInstancing=c._engine.getCaps().instancedArrays,c._createIndexBuffer(),c._createVertexBuffers(),c.particleEmitterType=new Mn;var v=null;return c.updateFunction=function(b){var C,M=null;c.noiseTexture&&(M=c.noiseTexture.getSize(),(C=c.noiseTexture.getContent())===null||C===void 0||C.then(function(X){v=X}));for(var N=function(){D=b[V];var X=c._scaledUpdateSpeed,ee=D.age;if(D.age+=X,D.age>D.lifeTime){var ie=D.age-ee,ge=D.lifeTime-ee;X=ge*X/ie,D.age=D.lifeTime}var pe=D.age/D.lifeTime;c._colorGradients&&c._colorGradients.length>0?Qi.GetCurrentGradient(pe,c._colorGradients,function(Pe,Ne,je){Pe!==D._currentColorGradient&&(D._currentColor1.copyFrom(D._currentColor2),Ne.getColorToRef(D._currentColor2),D._currentColorGradient=Pe),m.b.LerpToRef(D._currentColor1,D._currentColor2,je,D.color)}):(D.colorStep.scaleToRef(X,c._scaledColorStep),D.color.addInPlace(c._scaledColorStep),D.color.a<0&&(D.color.a=0)),c._angularSpeedGradients&&c._angularSpeedGradients.length>0&&Qi.GetCurrentGradient(pe,c._angularSpeedGradients,function(Pe,Ne,je){Pe!==D._currentAngularSpeedGradient&&(D._currentAngularSpeed1=D._currentAngularSpeed2,D._currentAngularSpeed2=Ne.getFactor(),D._currentAngularSpeedGradient=Pe),D.angularSpeed=$e.a.Lerp(D._currentAngularSpeed1,D._currentAngularSpeed2,je)}),D.angle+=D.angularSpeed*X;var te=X;if(c._velocityGradients&&c._velocityGradients.length>0&&Qi.GetCurrentGradient(pe,c._velocityGradients,function(Pe,Ne,je){Pe!==D._currentVelocityGradient&&(D._currentVelocity1=D._currentVelocity2,D._currentVelocity2=Ne.getFactor(),D._currentVelocityGradient=Pe),te*=$e.a.Lerp(D._currentVelocity1,D._currentVelocity2,je)}),D.direction.scaleToRef(te,c._scaledDirection),c._limitVelocityGradients&&c._limitVelocityGradients.length>0&&Qi.GetCurrentGradient(pe,c._limitVelocityGradients,function(Pe,Ne,je){Pe!==D._currentLimitVelocityGradient&&(D._currentLimitVelocity1=D._currentLimitVelocity2,D._currentLimitVelocity2=Ne.getFactor(),D._currentLimitVelocityGradient=Pe);var Be=$e.a.Lerp(D._currentLimitVelocity1,D._currentLimitVelocity2,je),Je=D.direction.length();Je>Be&&D.direction.scaleInPlace(c.limitVelocityDamping)}),c._dragGradients&&c._dragGradients.length>0&&Qi.GetCurrentGradient(pe,c._dragGradients,function(Pe,Ne,je){Pe!==D._currentDragGradient&&(D._currentDrag1=D._currentDrag2,D._currentDrag2=Ne.getFactor(),D._currentDragGradient=Pe);var Be=$e.a.Lerp(D._currentDrag1,D._currentDrag2,je);c._scaledDirection.scaleInPlace(1-Be)}),c.isLocal&&D._localPosition?(D._localPosition.addInPlace(c._scaledDirection),l.e.TransformCoordinatesToRef(D._localPosition,c._emitterWorldMatrix,D.position)):D.position.addInPlace(c._scaledDirection),v&&M&&D._randomNoiseCoordinates1){var Ce=c._fetchR(D._randomNoiseCoordinates1.x,D._randomNoiseCoordinates1.y,M.width,M.height,v),Ae=c._fetchR(D._randomNoiseCoordinates1.z,D._randomNoiseCoordinates2.x,M.width,M.height,v),De=c._fetchR(D._randomNoiseCoordinates2.y,D._randomNoiseCoordinates2.z,M.width,M.height,v),Fe=l.c.Vector3[0],We=l.c.Vector3[1];Fe.copyFromFloats((2*Ce-1)*c.noiseStrength.x,(2*Ae-1)*c.noiseStrength.y,(2*De-1)*c.noiseStrength.z),Fe.scaleToRef(X,We),D.direction.addInPlace(We)}if(c.gravity.scaleToRef(X,c._scaledGravity),D.direction.addInPlace(c._scaledGravity),c._sizeGradients&&c._sizeGradients.length>0&&Qi.GetCurrentGradient(pe,c._sizeGradients,function(Pe,Ne,je){Pe!==D._currentSizeGradient&&(D._currentSize1=D._currentSize2,D._currentSize2=Ne.getFactor(),D._currentSizeGradient=Pe),D.size=$e.a.Lerp(D._currentSize1,D._currentSize2,je)}),c._useRampGradients&&(c._colorRemapGradients&&c._colorRemapGradients.length>0&&Qi.GetCurrentGradient(pe,c._colorRemapGradients,function(Pe,Ne,je){var Be=$e.a.Lerp(Pe.factor1,Ne.factor1,je),Je=$e.a.Lerp(Pe.factor2,Ne.factor2,je);D.remapData.x=Be,D.remapData.y=Je-Be}),c._alphaRemapGradients&&c._alphaRemapGradients.length>0&&Qi.GetCurrentGradient(pe,c._alphaRemapGradients,function(Pe,Ne,je){var Be=$e.a.Lerp(Pe.factor1,Ne.factor1,je),Je=$e.a.Lerp(Pe.factor2,Ne.factor2,je);D.remapData.z=Be,D.remapData.w=Je-Be})),c._isAnimationSheetEnabled&&D.updateCellIndex(),D._inheritParticleInfoToSubEmitters(),D.age>=D.lifeTime)return c._emitFromParticle(D),D._attachedSubEmitters&&(D._attachedSubEmitters.forEach(function(Pe){Pe.particleSystem.disposeOnStop=!0,Pe.particleSystem.stop()}),D._attachedSubEmitters=null),c.recycleParticle(D),V--,"continue"},D,V=0;V<b.length;V++)N()},c}return Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"useRampGradients",{get:function(){return this._useRampGradients},set:function(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"particles",{get:function(){return this._particles},enumerable:!1,configurable:!0}),t.prototype.getActiveCount=function(){return this._particles.length},t.prototype.getClassName=function(){return"ParticleSystem"},t.prototype.isStopping=function(){return this._stopped&&this.isAlive()},t.prototype.getCustomEffect=function(e){var i;return e===void 0&&(e=0),(i=this._customEffect[e])!==null&&i!==void 0?i:this._customEffect[0]},t.prototype.setCustomEffect=function(e,i){i===void 0&&(i=0),this._customEffect[i]=e},Object.defineProperty(t.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new _.c),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vertexShaderName",{get:function(){return"particles"},enumerable:!1,configurable:!0}),t.prototype._addFactorGradient=function(e,i,r,o){var a=new el(i,r,o);e.push(a),e.sort(function(s,c){return s.gradient<c.gradient?-1:s.gradient>c.gradient?1:0})},t.prototype._removeFactorGradient=function(e,i){if(!!e)for(var r=0,o=0,a=e;o<a.length;o++){var s=a[o];if(s.gradient===i){e.splice(r,1);break}r++}},t.prototype.addLifeTimeGradient=function(e,i,r){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,i,r),this},t.prototype.removeLifeTimeGradient=function(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this},t.prototype.addSizeGradient=function(e,i,r){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,i,r),this},t.prototype.removeSizeGradient=function(e){return this._removeFactorGradient(this._sizeGradients,e),this},t.prototype.addColorRemapGradient=function(e,i,r){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,i,r),this},t.prototype.removeColorRemapGradient=function(e){return this._removeFactorGradient(this._colorRemapGradients,e),this},t.prototype.addAlphaRemapGradient=function(e,i,r){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,i,r),this},t.prototype.removeAlphaRemapGradient=function(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this},t.prototype.addAngularSpeedGradient=function(e,i,r){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,i,r),this},t.prototype.removeAngularSpeedGradient=function(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this},t.prototype.addVelocityGradient=function(e,i,r){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,i,r),this},t.prototype.removeVelocityGradient=function(e){return this._removeFactorGradient(this._velocityGradients,e),this},t.prototype.addLimitVelocityGradient=function(e,i,r){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,i,r),this},t.prototype.removeLimitVelocityGradient=function(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this},t.prototype.addDragGradient=function(e,i,r){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,i,r),this},t.prototype.removeDragGradient=function(e){return this._removeFactorGradient(this._dragGradients,e),this},t.prototype.addEmitRateGradient=function(e,i,r){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,i,r),this},t.prototype.removeEmitRateGradient=function(e){return this._removeFactorGradient(this._emitRateGradients,e),this},t.prototype.addStartSizeGradient=function(e,i,r){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,i,r),this},t.prototype.removeStartSizeGradient=function(e){return this._removeFactorGradient(this._startSizeGradients,e),this},t.prototype._createRampGradientTexture=function(){if(!(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)){for(var e=new Uint8Array(this._rawTextureWidth*4),i=m.c.Color3[0],r=0;r<this._rawTextureWidth;r++){var o=r/this._rawTextureWidth;Qi.GetCurrentGradient(o,this._rampGradients,function(a,s,c){m.a.LerpToRef(a.color,s.color,c,i),e[r*4]=i.r*255,e[r*4+1]=i.g*255,e[r*4+2]=i.b*255,e[r*4+3]=255})}this._rampGradientsTexture=kr.a.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}},t.prototype.getRampGradients=function(){return this._rampGradients},t.prototype.forceRefreshGradients=function(){this._syncRampGradientTexture()},t.prototype._syncRampGradientTexture=function(){!this._rampGradients||(this._rampGradients.sort(function(e,i){return e.gradient<i.gradient?-1:e.gradient>i.gradient?1:0}),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())},t.prototype.addRampGradient=function(e,i){this._rampGradients||(this._rampGradients=[]);var r=new Jf(e,i);return this._rampGradients.push(r),this._syncRampGradientTexture(),this},t.prototype.removeRampGradient=function(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this},t.prototype.addColorGradient=function(e,i,r){this._colorGradients||(this._colorGradients=[]);var o=new qs(e,i,r);return this._colorGradients.push(o),this._colorGradients.sort(function(a,s){return a.gradient<s.gradient?-1:a.gradient>s.gradient?1:0}),this},t.prototype.removeColorGradient=function(e){if(!this._colorGradients)return this;for(var i=0,r=0,o=this._colorGradients;r<o.length;r++){var a=o[r];if(a.gradient===e){this._colorGradients.splice(i,1);break}i++}return this},t.prototype._fetchR=function(e,i,r,o,a){e=Math.abs(e)*.5+.5,i=Math.abs(i)*.5+.5;var s=e*r%r|0,c=i*o%o|0,v=(s+c*r)*4;return a[v]/255},t.prototype._reset=function(){this._resetEffect()},t.prototype._resetEffect=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()},t.prototype._createVertexBuffers=function(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===t.BILLBOARDMODE_STRETCHED)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);var e=this._engine;this._vertexData=new Float32Array(this._capacity*this._vertexBufferSize*(this._useInstancing?1:4)),this._vertexBuffer=new Oe.a(e,this._vertexData,!0,this._vertexBufferSize);var i=0,r=this._vertexBuffer.createVertexBuffer(Oe.b.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Oe.b.PositionKind]=r,i+=3;var o=this._vertexBuffer.createVertexBuffer(Oe.b.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Oe.b.ColorKind]=o,i+=4;var a=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=a,i+=1;var s=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=s,i+=2,this._isAnimationSheetEnabled){var c=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=c,i+=1}if(!this._isBillboardBased||this.billboardMode===t.BILLBOARDMODE_STRETCHED){var v=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=v,i+=3}if(this._useRampGradients){var b=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=b,i+=4}var C;if(this._useInstancing){var M=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Oe.a(e,M,!1,2),C=this._spriteBuffer.createVertexBuffer("offset",0,2)}else C=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=C},t.prototype._createIndexBuffer=function(){if(!this._useInstancing){for(var e=[],i=0,r=0;r<this._capacity;r++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}},t.prototype.getCapacity=function(){return this._capacity},t.prototype.isAlive=function(){return this._alive},t.prototype.isStarted=function(){return this._started},t.prototype._prepareSubEmitterInternalArray=function(){var e=this;this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(function(i){i instanceof t?e._subEmitters.push([new xo(i)]):i instanceof xo?e._subEmitters.push([i]):i instanceof Array&&e._subEmitters.push(i)})},t.prototype.start=function(e){var i=this,r;if(e===void 0&&(e=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(function(){i.start(0)},e);return}if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((r=this.emitter)===null||r===void 0?void 0:r.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);var o=this.noiseTexture;if(o&&o.onGeneratedObservable)o.onGeneratedObservable.addOnce(function(){setTimeout(function(){for(var s=0;s<i.preWarmCycles;s++)i.animate(!0),o.render()})});else for(var a=0;a<this.preWarmCycles;a++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)},t.prototype.stop=function(e){e===void 0&&(e=!0),!this._stopped&&(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,e&&this._stopSubEmitters())},t.prototype.reset=function(){this._stockParticles=[],this._particles=[]},t.prototype._appendParticleVertex=function(e,i,r,o){var a=e*this._vertexBufferSize;if(this._vertexData[a++]=i.position.x+this.worldOffset.x,this._vertexData[a++]=i.position.y+this.worldOffset.y,this._vertexData[a++]=i.position.z+this.worldOffset.z,this._vertexData[a++]=i.color.r,this._vertexData[a++]=i.color.g,this._vertexData[a++]=i.color.b,this._vertexData[a++]=i.color.a,this._vertexData[a++]=i.angle,this._vertexData[a++]=i.scale.x*i.size,this._vertexData[a++]=i.scale.y*i.size,this._isAnimationSheetEnabled&&(this._vertexData[a++]=i.cellIndex),this._isBillboardBased)this.billboardMode===t.BILLBOARDMODE_STRETCHED&&(this._vertexData[a++]=i.direction.x,this._vertexData[a++]=i.direction.y,this._vertexData[a++]=i.direction.z);else if(i._initialDirection){var s=i._initialDirection;this.isLocal&&(l.e.TransformNormalToRef(s,this._emitterWorldMatrix,l.c.Vector3[0]),s=l.c.Vector3[0]),s.x===0&&s.z===0&&(s.x=.001),this._vertexData[a++]=s.x,this._vertexData[a++]=s.y,this._vertexData[a++]=s.z}else{var c=i.direction;this.isLocal&&(l.e.TransformNormalToRef(c,this._emitterWorldMatrix,l.c.Vector3[0]),c=l.c.Vector3[0]),c.x===0&&c.z===0&&(c.x=.001),this._vertexData[a++]=c.x,this._vertexData[a++]=c.y,this._vertexData[a++]=c.z}this._useRampGradients&&i.remapData&&(this._vertexData[a++]=i.remapData.x,this._vertexData[a++]=i.remapData.y,this._vertexData[a++]=i.remapData.z,this._vertexData[a++]=i.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),o===0?o=this._epsilon:o===1&&(o=1-this._epsilon)),this._vertexData[a++]=r,this._vertexData[a++]=o)},t.prototype._stopSubEmitters=function(){!this.activeSubSystems||(this.activeSubSystems.forEach(function(e){e.stop(!0)}),this.activeSubSystems=new Array)},t.prototype._removeFromRoot=function(){if(!!this._rootParticleSystem){var e=this._rootParticleSystem.activeSubSystems.indexOf(this);e!==-1&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}},t.prototype._update=function(e){var i=this;if(this._alive=this._particles.length>0,this.emitter.position){var r=this.emitter;this._emitterWorldMatrix=r.getWorldMatrix()}else{var o=this.emitter;this._emitterWorldMatrix=l.a.Translation(o.x,o.y,o.z)}this.updateFunction(this._particles);for(var a,s=function(){if(c._particles.length===c._capacity)return"break";if(a=c._createParticle(),c._particles.push(a),c.targetStopDuration&&c._lifeTimeGradients&&c._lifeTimeGradients.length>0){var M=$e.a.Clamp(c._actualFrame/c.targetStopDuration);Qi.GetCurrentGradient(M,c._lifeTimeGradients,function(V,X){var ee=V,ie=X,ge=ee.getFactor(),pe=ie.getFactor(),te=(M-ee.gradient)/(ie.gradient-ee.gradient);a.lifeTime=$e.a.Lerp(ge,pe,te)})}else a.lifeTime=$e.a.RandomRange(c.minLifeTime,c.maxLifeTime);var N=$e.a.RandomRange(c.minEmitPower,c.maxEmitPower);if(c.startPositionFunction?c.startPositionFunction(c._emitterWorldMatrix,a.position,a,c.isLocal):c.particleEmitterType.startPositionFunction(c._emitterWorldMatrix,a.position,a,c.isLocal),c.isLocal&&(a._localPosition?a._localPosition.copyFrom(a.position):a._localPosition=a.position.clone(),l.e.TransformCoordinatesToRef(a._localPosition,c._emitterWorldMatrix,a.position)),c.startDirectionFunction?c.startDirectionFunction(c._emitterWorldMatrix,a.direction,a,c.isLocal):c.particleEmitterType.startDirectionFunction(c._emitterWorldMatrix,a.direction,a,c.isLocal),N===0?a._initialDirection?a._initialDirection.copyFrom(a.direction):a._initialDirection=a.direction.clone():a._initialDirection=null,a.direction.scaleInPlace(N),!c._sizeGradients||c._sizeGradients.length===0?a.size=$e.a.RandomRange(c.minSize,c.maxSize):(a._currentSizeGradient=c._sizeGradients[0],a._currentSize1=a._currentSizeGradient.getFactor(),a.size=a._currentSize1,c._sizeGradients.length>1?a._currentSize2=c._sizeGradients[1].getFactor():a._currentSize2=a._currentSize1),a.scale.copyFromFloats($e.a.RandomRange(c.minScaleX,c.maxScaleX),$e.a.RandomRange(c.minScaleY,c.maxScaleY)),c._startSizeGradients&&c._startSizeGradients[0]&&c.targetStopDuration){var D=c._actualFrame/c.targetStopDuration;Qi.GetCurrentGradient(D,c._startSizeGradients,function(V,X,ee){V!==i._currentStartSizeGradient&&(i._currentStartSize1=i._currentStartSize2,i._currentStartSize2=X.getFactor(),i._currentStartSizeGradient=V);var ie=$e.a.Lerp(i._currentStartSize1,i._currentStartSize2,ee);a.scale.scaleInPlace(ie)})}!c._angularSpeedGradients||c._angularSpeedGradients.length===0?a.angularSpeed=$e.a.RandomRange(c.minAngularSpeed,c.maxAngularSpeed):(a._currentAngularSpeedGradient=c._angularSpeedGradients[0],a.angularSpeed=a._currentAngularSpeedGradient.getFactor(),a._currentAngularSpeed1=a.angularSpeed,c._angularSpeedGradients.length>1?a._currentAngularSpeed2=c._angularSpeedGradients[1].getFactor():a._currentAngularSpeed2=a._currentAngularSpeed1),a.angle=$e.a.RandomRange(c.minInitialRotation,c.maxInitialRotation),c._velocityGradients&&c._velocityGradients.length>0&&(a._currentVelocityGradient=c._velocityGradients[0],a._currentVelocity1=a._currentVelocityGradient.getFactor(),c._velocityGradients.length>1?a._currentVelocity2=c._velocityGradients[1].getFactor():a._currentVelocity2=a._currentVelocity1),c._limitVelocityGradients&&c._limitVelocityGradients.length>0&&(a._currentLimitVelocityGradient=c._limitVelocityGradients[0],a._currentLimitVelocity1=a._currentLimitVelocityGradient.getFactor(),c._limitVelocityGradients.length>1?a._currentLimitVelocity2=c._limitVelocityGradients[1].getFactor():a._currentLimitVelocity2=a._currentLimitVelocity1),c._dragGradients&&c._dragGradients.length>0&&(a._currentDragGradient=c._dragGradients[0],a._currentDrag1=a._currentDragGradient.getFactor(),c._dragGradients.length>1?a._currentDrag2=c._dragGradients[1].getFactor():a._currentDrag2=a._currentDrag1),!c._colorGradients||c._colorGradients.length===0?(v=$e.a.RandomRange(0,1),m.b.LerpToRef(c.color1,c.color2,v,a.color),c.colorDead.subtractToRef(a.color,c._colorDiff),c._colorDiff.scaleToRef(1/a.lifeTime,a.colorStep)):(a._currentColorGradient=c._colorGradients[0],a._currentColorGradient.getColorToRef(a.color),a._currentColor1.copyFrom(a.color),c._colorGradients.length>1?c._colorGradients[1].getColorToRef(a._currentColor2):a._currentColor2.copyFrom(a.color)),c._isAnimationSheetEnabled&&(a._initialStartSpriteCellID=c.startSpriteCellID,a._initialEndSpriteCellID=c.endSpriteCellID),a.direction.addInPlace(c._inheritedVelocityOffset),c._useRampGradients&&(a.remapData=new l.f(0,1,0,1)),c.noiseTexture&&(a._randomNoiseCoordinates1?(a._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),a._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(a._randomNoiseCoordinates1=new l.e(Math.random(),Math.random(),Math.random()),a._randomNoiseCoordinates2=new l.e(Math.random(),Math.random(),Math.random()))),a._inheritParticleInfoToSubEmitters()},c=this,v,b=0;b<e;b++){var C=s();if(C==="break")break}},t._GetAttributeNamesOrOptions=function(e,i,r){e===void 0&&(e=!1),i===void 0&&(i=!1),r===void 0&&(r=!1);var o=[Oe.b.PositionKind,Oe.b.ColorKind,"angle","offset","size"];return e&&o.push("cellIndex"),i||o.push("direction"),r&&o.push("remapData"),o},t._GetEffectCreationOptions=function(e){e===void 0&&(e=!1);var i=["invView","view","projection","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","textureMask","translationPivot","eyePosition"];return e&&i.push("particlesInfos"),i},t.prototype.fillDefines=function(e,i){if(this._scene&&(this._scene.clipPlane&&e.push("#define CLIPPLANE"),this._scene.clipPlane2&&e.push("#define CLIPPLANE2"),this._scene.clipPlane3&&e.push("#define CLIPPLANE3"),this._scene.clipPlane4&&e.push("#define CLIPPLANE4"),this._scene.clipPlane5&&e.push("#define CLIPPLANE5"),this._scene.clipPlane6&&e.push("#define CLIPPLANE6")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i===t.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case t.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case t.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case t.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break;default:break}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))},t.prototype.fillUniformsAttributesAndSamplerNames=function(e,i,r){i.push.apply(i,t._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==t.BILLBOARDMODE_STRETCHED,this._useRampGradients)),e.push.apply(e,t._GetEffectCreationOptions(this._isAnimationSheetEnabled)),r.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(mr.a.PrepareUniforms(e,this._imageProcessingConfigurationDefines),mr.a.PrepareSamplers(r,this._imageProcessingConfigurationDefines))},t.prototype._getEffect=function(e){var i=this.getCustomEffect(e);if(i)return i;var r=[];this.fillDefines(r,e);var o=r.join(`
`);if(this._cachedDefines!==o){this._cachedDefines=o;var a=[],s=[],c=[];this.fillUniformsAttributesAndSamplerNames(s,a,c),this._effect=this._engine.createEffect("particles",a,s,c,o)}return this._effect},t.prototype.animate=function(e){var i=this,r;if(e===void 0&&(e=!1),!!this._started){if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:((r=this._scene)===null||r===void 0?void 0:r.getAnimationRatio())||1);var o;if(this.manualEmitCount>-1)o=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{var a=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){var s=this._actualFrame/this.targetStopDuration;Qi.GetCurrentGradient(s,this._emitRateGradients,function(C,M,N){C!==i._currentEmitRateGradient&&(i._currentEmitRate1=i._currentEmitRate2,i._currentEmitRate2=M.getFactor(),i._currentEmitRateGradient=C),a=$e.a.Lerp(i._currentEmitRate1,i._currentEmitRate2,N)})}o=a*this._scaledUpdateSpeed>>0,this._newPartsExcess+=a*this._scaledUpdateSpeed-o}if(this._newPartsExcess>1&&(o+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?o=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(o),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){for(var c=0,v=0;v<this._particles.length;v++){var b=this._particles[v];this._appendParticleVertices(c,b),c+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.update(this._vertexData)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}},t.prototype._appendParticleVertices=function(e,i){this._appendParticleVertex(e++,i,0,0),this._useInstancing||(this._appendParticleVertex(e++,i,1,0),this._appendParticleVertex(e++,i,1,1),this._appendParticleVertex(e++,i,0,1))},t.prototype.rebuild=function(){this._createIndexBuffer(),this._vertexBuffer&&this._vertexBuffer._rebuild();for(var e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()},t.prototype.isReady=function(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==t.BLENDMODE_MULTIPLYADD){if(!this._getEffect(this.blendMode).isReady())return!1}else if(!this._getEffect(t.BLENDMODE_MULTIPLY).isReady()||!this._getEffect(t.BLENDMODE_ADD).isReady())return!1;return!0},t.prototype._render=function(e){var i,r,o=this._getEffect(e),a=this._engine;a.enableEffect(o);var s=(i=this.defaultViewMatrix)!==null&&i!==void 0?i:this._scene.getViewMatrix();if(o.setTexture("diffuseSampler",this.particleTexture),o.setMatrix("view",s),o.setMatrix("projection",(r=this.defaultProjectionMatrix)!==null&&r!==void 0?r:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){var c=this.particleTexture.getBaseSize();o.setFloat3("particlesInfos",this.spriteCellWidth/c.width,this.spriteCellHeight/c.height,this.spriteCellWidth/c.width)}if(o.setVector2("translationPivot",this.translationPivot),o.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){var v=this._scene.activeCamera;o.setVector3("eyePosition",v.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),o.setTexture("rampSampler",this._rampGradientsTexture));var b=o.defines;switch(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&vc.a.BindClipPlane(o,this._scene),b.indexOf("#define BILLBOARDMODE_ALL")>=0&&(s.invertToRef(l.c.Matrix[0]),o.setMatrix("invView",l.c.Matrix[0])),this._vertexArrayObject!==void 0?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,o)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):a.bindBuffers(this._vertexBuffers,this._indexBuffer,o),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(o),e){case t.BLENDMODE_ADD:a.setAlphaMode(1);break;case t.BLENDMODE_ONEONE:a.setAlphaMode(6);break;case t.BLENDMODE_STANDARD:a.setAlphaMode(2);break;case t.BLENDMODE_MULTIPLY:a.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(o),this._useInstancing?a.drawArraysType(7,0,4,this._particles.length):a.drawElementsType(0,0,this._particles.length*6),this._particles.length},t.prototype.render=function(){if(!this.isReady()||!this._particles.length)return 0;var e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));var i=0;return this.blendMode===t.BLENDMODE_MULTIPLYADD?i=this._render(t.BLENDMODE_MULTIPLY)+this._render(t.BLENDMODE_ADD):i=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),i},t.prototype.dispose=function(e){if(e===void 0&&(e=!0),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this._subEmitters&&this._subEmitters.length){for(var i=0;i<this._subEmitters.length;i++)for(var r=0,o=this._subEmitters[i];r<o.length;r++){var a=o[r];a.dispose()}this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){var i=this._scene.particleSystems.indexOf(this);i>-1&&this._scene.particleSystems.splice(i,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()},t.prototype.clone=function(e,i){var r=Object(h.a)({},this._customEffect),o=null,a=this._engine;if(a.createEffectForParticles&&this.customShader!=null){o=this.customShader;var s=o.shaderOptions.defines.length>0?o.shaderOptions.defines.join(`
`):"";r[0]=a.createEffectForParticles(o.shaderPath.fragmentElement,o.shaderOptions.uniforms,o.shaderOptions.samplers,s)}var c=this.serialize(),v=t.Parse(c,this._scene||this._engine,this._rootUrl);return v.name=e,v.customShader=o,v._customEffect=r,i===void 0&&(i=this.emitter),this.noiseTexture&&(v.noiseTexture=this.noiseTexture.clone()),v.emitter=i,this.preventAutoStart||v.start(),v},t.prototype.serialize=function(e){e===void 0&&(e=!1);var i={};if(t._Serialize(i,this,e),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,this.subEmitters){i.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(var r=0,o=this._subEmitters;r<o.length;r++){for(var a=o[r],s=[],c=0,v=a;c<v.length;c++){var b=v[c];s.push(b.serialize())}i.subEmitters.push(s)}}return i},t._Serialize=function(e,i,r){if(e.name=i.name,e.id=i.id,e.capacity=i.getCapacity(),e.disposeOnStop=i.disposeOnStop,e.manualEmitCount=i.manualEmitCount,i.emitter.position){var o=i.emitter;e.emitterId=o.id}else{var a=i.emitter;e.emitter=a.asArray()}i.particleEmitterType&&(e.particleEmitterType=i.particleEmitterType.serialize()),i.particleTexture&&(r?e.texture=i.particleTexture.serialize():(e.textureName=i.particleTexture.name,e.invertY=!!i.particleTexture._invertY)),e.isLocal=i.isLocal,de.a.AppendSerializedAnimations(i,e),e.beginAnimationOnStart=i.beginAnimationOnStart,e.beginAnimationFrom=i.beginAnimationFrom,e.beginAnimationTo=i.beginAnimationTo,e.beginAnimationLoop=i.beginAnimationLoop,e.startDelay=i.startDelay,e.renderingGroupId=i.renderingGroupId,e.isBillboardBased=i.isBillboardBased,e.billboardMode=i.billboardMode,e.minAngularSpeed=i.minAngularSpeed,e.maxAngularSpeed=i.maxAngularSpeed,e.minSize=i.minSize,e.maxSize=i.maxSize,e.minScaleX=i.minScaleX,e.maxScaleX=i.maxScaleX,e.minScaleY=i.minScaleY,e.maxScaleY=i.maxScaleY,e.minEmitPower=i.minEmitPower,e.maxEmitPower=i.maxEmitPower,e.minLifeTime=i.minLifeTime,e.maxLifeTime=i.maxLifeTime,e.emitRate=i.emitRate,e.gravity=i.gravity.asArray(),e.noiseStrength=i.noiseStrength.asArray(),e.color1=i.color1.asArray(),e.color2=i.color2.asArray(),e.colorDead=i.colorDead.asArray(),e.updateSpeed=i.updateSpeed,e.targetStopDuration=i.targetStopDuration,e.blendMode=i.blendMode,e.preWarmCycles=i.preWarmCycles,e.preWarmStepOffset=i.preWarmStepOffset,e.minInitialRotation=i.minInitialRotation,e.maxInitialRotation=i.maxInitialRotation,e.startSpriteCellID=i.startSpriteCellID,e.endSpriteCellID=i.endSpriteCellID,e.spriteCellChangeSpeed=i.spriteCellChangeSpeed,e.spriteCellWidth=i.spriteCellWidth,e.spriteCellHeight=i.spriteCellHeight,e.spriteRandomStartCell=i.spriteRandomStartCell,e.isAnimationSheetEnabled=i.isAnimationSheetEnabled;var s=i.getColorGradients();if(s){e.colorGradients=[];for(var c=0,v=s;c<v.length;c++){var b=v[c],C={gradient:b.gradient,color1:b.color1.asArray()};b.color2?C.color2=b.color2.asArray():C.color2=b.color1.asArray(),e.colorGradients.push(C)}}var M=i.getRampGradients();if(M){e.rampGradients=[];for(var N=0,D=M;N<D.length;N++){var V=D[N],C={gradient:V.gradient,color:V.color.asArray()};e.rampGradients.push(C)}e.useRampGradients=i.useRampGradients}var X=i.getColorRemapGradients();if(X){e.colorRemapGradients=[];for(var ee=0,ie=X;ee<ie.length;ee++){var ge=ie[ee],C={gradient:ge.gradient,factor1:ge.factor1};ge.factor2!==void 0?C.factor2=ge.factor2:C.factor2=ge.factor1,e.colorRemapGradients.push(C)}}var pe=i.getAlphaRemapGradients();if(pe){e.alphaRemapGradients=[];for(var te=0,Ce=pe;te<Ce.length;te++){var Ae=Ce[te],C={gradient:Ae.gradient,factor1:Ae.factor1};Ae.factor2!==void 0?C.factor2=Ae.factor2:C.factor2=Ae.factor1,e.alphaRemapGradients.push(C)}}var De=i.getSizeGradients();if(De){e.sizeGradients=[];for(var Fe=0,We=De;Fe<We.length;Fe++){var Pe=We[Fe],C={gradient:Pe.gradient,factor1:Pe.factor1};Pe.factor2!==void 0?C.factor2=Pe.factor2:C.factor2=Pe.factor1,e.sizeGradients.push(C)}}var Ne=i.getAngularSpeedGradients();if(Ne){e.angularSpeedGradients=[];for(var je=0,Be=Ne;je<Be.length;je++){var Je=Be[je],C={gradient:Je.gradient,factor1:Je.factor1};Je.factor2!==void 0?C.factor2=Je.factor2:C.factor2=Je.factor1,e.angularSpeedGradients.push(C)}}var tt=i.getVelocityGradients();if(tt){e.velocityGradients=[];for(var Xe=0,Ct=tt;Xe<Ct.length;Xe++){var At=Ct[Xe],C={gradient:At.gradient,factor1:At.factor1};At.factor2!==void 0?C.factor2=At.factor2:C.factor2=At.factor1,e.velocityGradients.push(C)}}var Rt=i.getDragGradients();if(Rt){e.dragGradients=[];for(var rt=0,Bt=Rt;rt<Bt.length;rt++){var jt=Bt[rt],C={gradient:jt.gradient,factor1:jt.factor1};jt.factor2!==void 0?C.factor2=jt.factor2:C.factor2=jt.factor1,e.dragGradients.push(C)}}var at=i.getEmitRateGradients();if(at){e.emitRateGradients=[];for(var Lt=0,Qe=at;Lt<Qe.length;Lt++){var lt=Qe[Lt],C={gradient:lt.gradient,factor1:lt.factor1};lt.factor2!==void 0?C.factor2=lt.factor2:C.factor2=lt.factor1,e.emitRateGradients.push(C)}}var wt=i.getStartSizeGradients();if(wt){e.startSizeGradients=[];for(var fi=0,si=wt;fi<si.length;fi++){var xi=si[fi],C={gradient:xi.gradient,factor1:xi.factor1};xi.factor2!==void 0?C.factor2=xi.factor2:C.factor2=xi.factor1,e.startSizeGradients.push(C)}}var bi=i.getLifeTimeGradients();if(bi){e.lifeTimeGradients=[];for(var St=0,$t=bi;St<$t.length;St++){var vi=$t[St],C={gradient:vi.gradient,factor1:vi.factor1};vi.factor2!==void 0?C.factor2=vi.factor2:C.factor2=vi.factor1,e.lifeTimeGradients.push(C)}}var hi=i.getLimitVelocityGradients();if(hi){e.limitVelocityGradients=[];for(var di=0,ct=hi;di<ct.length;di++){var oi=ct[di],C={gradient:oi.gradient,factor1:oi.factor1};oi.factor2!==void 0?C.factor2=oi.factor2:C.factor2=oi.factor1,e.limitVelocityGradients.push(C)}e.limitVelocityDamping=i.limitVelocityDamping}i.noiseTexture&&(e.noiseTexture=i.noiseTexture.serialize())},t._Parse=function(e,i,r,o){var a,s,c;r instanceof fn.a?c=null:c=r;var v=f.a.GetClass("BABYLON.Texture");if(v&&c&&(e.texture?i.particleTexture=v.Parse(e.texture,c,o):e.textureName&&(i.particleTexture=new v(o+e.textureName,c,!1,e.invertY!==void 0?e.invertY:!0),i.particleTexture.name=e.textureName)),!e.emitterId&&e.emitterId!==0&&e.emitter===void 0?i.emitter=l.e.Zero():e.emitterId&&c?i.emitter=c.getLastMeshByID(e.emitterId):i.emitter=l.e.FromArray(e.emitter),i.isLocal=!!e.isLocal,e.renderingGroupId!==void 0&&(i.renderingGroupId=e.renderingGroupId),e.isBillboardBased!==void 0&&(i.isBillboardBased=e.isBillboardBased),e.billboardMode!==void 0&&(i.billboardMode=e.billboardMode),e.animations){for(var b=0;b<e.animations.length;b++){var C=e.animations[b],M=f.a.GetClass("BABYLON.Animation");M&&i.animations.push(M.Parse(C))}i.beginAnimationOnStart=e.beginAnimationOnStart,i.beginAnimationFrom=e.beginAnimationFrom,i.beginAnimationTo=e.beginAnimationTo,i.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&c&&c.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),i.startDelay=e.startDelay|0,i.minAngularSpeed=e.minAngularSpeed,i.maxAngularSpeed=e.maxAngularSpeed,i.minSize=e.minSize,i.maxSize=e.maxSize,e.minScaleX&&(i.minScaleX=e.minScaleX,i.maxScaleX=e.maxScaleX,i.minScaleY=e.minScaleY,i.maxScaleY=e.maxScaleY),e.preWarmCycles!==void 0&&(i.preWarmCycles=e.preWarmCycles,i.preWarmStepOffset=e.preWarmStepOffset),e.minInitialRotation!==void 0&&(i.minInitialRotation=e.minInitialRotation,i.maxInitialRotation=e.maxInitialRotation),i.minLifeTime=e.minLifeTime,i.maxLifeTime=e.maxLifeTime,i.minEmitPower=e.minEmitPower,i.maxEmitPower=e.maxEmitPower,i.emitRate=e.emitRate,i.gravity=l.e.FromArray(e.gravity),e.noiseStrength&&(i.noiseStrength=l.e.FromArray(e.noiseStrength)),i.color1=m.b.FromArray(e.color1),i.color2=m.b.FromArray(e.color2),i.colorDead=m.b.FromArray(e.colorDead),i.updateSpeed=e.updateSpeed,i.targetStopDuration=e.targetStopDuration,i.blendMode=e.blendMode,e.colorGradients)for(var N=0,D=e.colorGradients;N<D.length;N++){var V=D[N];i.addColorGradient(V.gradient,m.b.FromArray(V.color1),V.color2?m.b.FromArray(V.color2):void 0)}if(e.rampGradients){for(var X=0,ee=e.rampGradients;X<ee.length;X++){var ie=ee[X];i.addRampGradient(ie.gradient,m.a.FromArray(ie.color))}i.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(var ge=0,pe=e.colorRemapGradients;ge<pe.length;ge++){var te=pe[ge];i.addColorRemapGradient(te.gradient,te.factor1!==void 0?te.factor1:te.factor,te.factor2)}if(e.alphaRemapGradients)for(var Ce=0,Ae=e.alphaRemapGradients;Ce<Ae.length;Ce++){var De=Ae[Ce];i.addAlphaRemapGradient(De.gradient,De.factor1!==void 0?De.factor1:De.factor,De.factor2)}if(e.sizeGradients)for(var Fe=0,We=e.sizeGradients;Fe<We.length;Fe++){var Pe=We[Fe];i.addSizeGradient(Pe.gradient,Pe.factor1!==void 0?Pe.factor1:Pe.factor,Pe.factor2)}if(e.angularSpeedGradients)for(var Ne=0,je=e.angularSpeedGradients;Ne<je.length;Ne++){var Be=je[Ne];i.addAngularSpeedGradient(Be.gradient,Be.factor1!==void 0?Be.factor1:Be.factor,Be.factor2)}if(e.velocityGradients)for(var Je=0,tt=e.velocityGradients;Je<tt.length;Je++){var Xe=tt[Je];i.addVelocityGradient(Xe.gradient,Xe.factor1!==void 0?Xe.factor1:Xe.factor,Xe.factor2)}if(e.dragGradients)for(var Ct=0,At=e.dragGradients;Ct<At.length;Ct++){var Rt=At[Ct];i.addDragGradient(Rt.gradient,Rt.factor1!==void 0?Rt.factor1:Rt.factor,Rt.factor2)}if(e.emitRateGradients)for(var rt=0,Bt=e.emitRateGradients;rt<Bt.length;rt++){var jt=Bt[rt];i.addEmitRateGradient(jt.gradient,jt.factor1!==void 0?jt.factor1:jt.factor,jt.factor2)}if(e.startSizeGradients)for(var at=0,Lt=e.startSizeGradients;at<Lt.length;at++){var Qe=Lt[at];i.addStartSizeGradient(Qe.gradient,Qe.factor1!==void 0?Qe.factor1:Qe.factor,Qe.factor2)}if(e.lifeTimeGradients)for(var lt=0,wt=e.lifeTimeGradients;lt<wt.length;lt++){var fi=wt[lt];i.addLifeTimeGradient(fi.gradient,fi.factor1!==void 0?fi.factor1:fi.factor,fi.factor2)}if(e.limitVelocityGradients){for(var si=0,xi=e.limitVelocityGradients;si<xi.length;si++){var bi=xi[si];i.addLimitVelocityGradient(bi.gradient,bi.factor1!==void 0?bi.factor1:bi.factor,bi.factor2)}i.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&c){var St=f.a.GetClass("BABYLON.ProceduralTexture");i.noiseTexture=St.Parse(e.noiseTexture,c,o)}var $t;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":$t=new na;break;case"SphereDirectedParticleEmitter":$t=new zs;break;case"ConeEmitter":case"ConeParticleEmitter":$t=new ws;break;case"CylinderParticleEmitter":$t=new ra;break;case"CylinderDirectedParticleEmitter":$t=new Vs;break;case"HemisphericParticleEmitter":$t=new Us;break;case"PointParticleEmitter":$t=new Gs;break;case"MeshParticleEmitter":$t=new Bc;break;case"BoxEmitter":case"BoxParticleEmitter":default:$t=new Mn;break}$t.parse(e.particleEmitterType,c)}else $t=new Mn,$t.parse(e,c);i.particleEmitterType=$t,i.startSpriteCellID=e.startSpriteCellID,i.endSpriteCellID=e.endSpriteCellID,i.spriteCellWidth=e.spriteCellWidth,i.spriteCellHeight=e.spriteCellHeight,i.spriteCellChangeSpeed=e.spriteCellChangeSpeed,i.spriteRandomStartCell=e.spriteRandomStartCell,i.disposeOnStop=(a=e.disposeOnStop)!==null&&a!==void 0?a:!1,i.manualEmitCount=(s=e.manualEmitCount)!==null&&s!==void 0?s:-1},t.Parse=function(e,i,r,o){o===void 0&&(o=!1);var a=e.name,s=null,c=null,v,b;if(i instanceof fn.a?v=i:(b=i,v=b.getEngine()),e.customShader&&v.createEffectForParticles){c=e.customShader;var C=c.shaderOptions.defines.length>0?c.shaderOptions.defines.join(`
`):"";s=v.createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,C)}var M=new t(a,e.capacity,i,s,e.isAnimationSheetEnabled);if(M.customShader=c,M._rootUrl=r,e.id&&(M.id=e.id),e.subEmitters){M.subEmitters=[];for(var N=0,D=e.subEmitters;N<D.length;N++){for(var V=D[N],X=[],ee=0,ie=V;ee<ie.length;ee++){var ge=ie[ee];X.push(xo.Parse(ge,i,r))}M.subEmitters.push(X)}}return t._Parse(e,M,i,r),e.textureMask&&(M.textureMask=m.b.FromArray(e.textureMask)),e.preventAutoStart&&(M.preventAutoStart=e.preventAutoStart),!o&&!M.preventAutoStart&&M.start(),M},t.BILLBOARDMODE_Y=2,t.BILLBOARDMODE_ALL=7,t.BILLBOARDMODE_STRETCHED=8,t}(To);xo._ParseParticleSystem=mi.Parse;var rh="gpuUpdateParticlesPixelShader",nh=`#version 300 es
void main() {
discard;
}
`;qe.a.ShadersStore[rh]=nh;var cy={name:rh,shader:nh},oh="gpuUpdateParticlesVertexShader",ah=`#version 300 es
#define PI 3.14159
uniform float currentCount;
uniform float timeDelta;
uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;
uniform vec2 emitPower;
uniform vec2 sizeRange;
uniform vec4 scaleRange;
#ifndef COLORGRADIENTS
uniform vec4 color1;
uniform vec4 color2;
#endif
uniform vec3 gravity;
uniform sampler2D randomSampler;
uniform sampler2D randomSampler2;
uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
uniform vec3 minEmitBox;
uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;
uniform float radiusRange;
uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;
uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;
uniform float height;
uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;
uniform float coneAngle;
uniform vec2 height;
uniform float directionRandomizer;
#endif

in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;
in float life;
in vec4 seed;
in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;
in vec3 noiseCoordinates2;
#endif

out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;
out float outLife;
out vec4 outSeed;
out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;
out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;
uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;
uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec3 cellInfos;
#endif
vec3 getRandomVec3(float offset) {
return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;
}
vec4 getRandomVec4(float offset) {
return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));
}
void main() {
float newAge=age+timeDelta;

if (newAge>=life && stopFactor != 0.) {
vec3 newPosition;
vec3 newDirection;

vec4 randoms=getRandomVec4(seed.x);

outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;
outAge=newAge-life;

outSeed=seed;

#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;
outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a;
#ifndef COLORGRADIENTS

outColor=color1+(color2-color1)*randoms.b;
#endif

#ifndef ANGULARSPEEDGRADIENTS
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;
outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif

#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
newPosition=vec3(0,0,0);
newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;
newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);

float phi=2.0*PI*randoms2.x;
float theta=acos(2.0*randoms2.y-1.0);
float randX=cos(phi)*sin(theta);
float randY=cos(theta);
float randZ=sin(phi)*sin(theta);
newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);
newDirection=newPosition+directionRandomizer*randoms3;
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);

float phi=2.0*PI*randoms2.x;
float theta=acos(2.0*randoms2.y-1.0);
float randX=cos(phi)*sin(theta);
float randY=cos(theta);
float randZ=sin(phi)*sin(theta);
newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else

newDirection=newPosition+directionRandomizer*randoms3;
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);

float yPos=(randoms2.x-0.5)*height;
float angle=randoms2.y*PI*2.;
float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));
float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));
float xPos=positionRadius*cos(angle);
float zPos=positionRadius*sin(angle);
newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else

angle=angle+((randoms3.x-0.5)*PI);
newDirection=vec3(cos(angle),randoms3.y-0.5,sin(angle));
newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;

h=1.-h*h;
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;
lRadius=lRadius*h;
float randX=lRadius*sin(s);
float randZ=lRadius*cos(s);
float randY=h*height.x;
newPosition=vec3(randX,randY,randZ);

if (abs(cos(coneAngle)) == 1.0) {
newDirection=vec3(0.,1.0,0.);
} else {
vec3 randoms3=getRandomVec3(seed.z);
newDirection=normalize(newPosition+directionRandomizer*randoms3);
}
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;
outInitialPosition=initialPosition;
#else

newPosition=vec3(0.,0.,0.);

newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;
outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {
float directionScale=timeDelta;
outAge=newAge;
float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient;
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;
outSeed=seed;
#ifndef COLORGRADIENTS
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;
outSize.yz=size.yz;
#else
outSize=size;
#endif
#ifndef BILLBOARD
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;
float currentVelocity=length(updatedDirection);
if (currentVelocity>limitVelocity) {
updatedDirection=updatedDirection*limitVelocityDamping;
}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;
float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;
float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;
vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;
outDirection=outDirection+force*timeDelta;
outNoiseCoordinates1=noiseCoordinates1;
outNoiseCoordinates2=noiseCoordinates2;
#endif
#endif
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;
outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET
float offsetAge=outAge;
float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;
offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif
float ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}
}`;qe.a.ShadersStore[oh]=ah;var fy={name:oh,shader:ah},sh="clipPlaneFragmentDeclaration2",lh=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif`;qe.a.IncludesShadersStore[sh]=lh;var hy={name:sh,shader:lh},uh="gpuRenderParticlesPixelShader",ch=`#version 300 es
uniform sampler2D diffuseSampler;
in vec2 vUV;
in vec4 vColor;
out vec4 outFragColor;
#include<clipPlaneFragmentDeclaration2>
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
void main() {
#include<clipPlaneFragment>
vec4 textureColor=texture(diffuseSampler,vUV);
outFragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;
outFragColor.rgb=outFragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif


#ifdef IMAGEPROCESSINGPOSTPROCESS
outFragColor.rgb=toLinearSpace(outFragColor.rgb);
#else
#ifdef IMAGEPROCESSING
outFragColor.rgb=toLinearSpace(outFragColor.rgb);
outFragColor=applyImageProcessing(outFragColor);
#endif
#endif
}
`;qe.a.ShadersStore[uh]=ch;var dy={name:uh,shader:ch},fh="clipPlaneVertexDeclaration2",hh=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
out float fClipDistance6;
#endif`;qe.a.IncludesShadersStore[fh]=hh;var py={name:fh,shader:hh},dh="gpuRenderParticlesVertexShader",ph=`#version 300 es
uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif

in vec3 position;
in float age;
in float life;
in vec3 size;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
in vec3 direction;
#endif
in float angle;
#ifdef ANIMATESHEET
in float cellIndex;
#endif
in vec2 offset;
in vec2 uv;
out vec2 vUV;
out vec4 vColor;
out vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;
in vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix=mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix=mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);
float columnOffset=cellIndex-rowOffset*sheetInfos.z;
vec2 uvScale=sheetInfos.xy;
vec2 uvOffset=vec2(uv.x ,1.0-uv.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=age/life;
#ifdef COLORGRADIENTS
vColor=texture(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x+translationPivot;
#ifdef BILLBOARD
vec4 rotatedCorner;
rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=(position+worldOffset)-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);
vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=(position+worldOffset)-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);
vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else

rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;

#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else

vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=0.;
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
vec3 yaxis=normalize(initialDirection);
vPositionW=rotate(yaxis,rotatedCorner);

vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;

#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
}`;qe.a.ShadersStore[dh]=ph;var gy={name:dh,shader:ph},mn=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!1),a===void 0&&(a=null);var s=n.call(this,e)||this;s.layerMask=268435455,s._accumulatedCount=0,s._targetIndex=0,s._currentRenderId=-1,s._started=!1,s._stopped=!1,s._timeDelta=0,s._actualFrame=0,s._rawTextureWidth=256,s.onDisposeObservable=new _.c,s.onStoppedObservable=new _.c,s.forceDepthWrite=!1,s._preWarmDone=!1,s.isLocal=!1,s._onBeforeDrawParticlesObservable=null,!r||r.getClassName()==="Scene"?(s._scene=r||Yt.a.LastCreatedScene,s._engine=s._scene.getEngine(),s.uniqueId=s._scene.getUniqueId(),s._scene.particleSystems.push(s)):(s._engine=r,s.defaultProjectionMatrix=l.a.PerspectiveFovLH(.8,1,.1,100)),s._customEffect={0:a},s._attachImageProcessingConfiguration(null),i.randomTextureSize||delete i.randomTextureSize;var c=Object(h.a)({capacity:5e4,randomTextureSize:s._engine.getCaps().maxTextureSize},i),v=i;isFinite(v)&&(c.capacity=v),s._capacity=c.capacity,s._activeCount=c.capacity,s._currentActiveCount=0,s._isAnimationSheetEnabled=o,s._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]},s.particleEmitterType=new Mn;for(var b=Math.min(s._engine.getCaps().maxTextureSize,c.randomTextureSize),C=[],M=0;M<b;++M)C.push(Math.random()),C.push(Math.random()),C.push(Math.random()),C.push(Math.random());s._randomTexture=new kr.a(new Float32Array(C),b,1,5,r,!1,!1,1,1),s._randomTexture.wrapU=1,s._randomTexture.wrapV=1,C=[];for(var M=0;M<b;++M)C.push(Math.random()),C.push(Math.random()),C.push(Math.random()),C.push(Math.random());return s._randomTexture2=new kr.a(new Float32Array(C),b,1,5,r,!1,!1,1,1),s._randomTexture2.wrapU=1,s._randomTexture2.wrapV=1,s._randomTextureSize=b,s}return Object.defineProperty(t,"IsSupported",{get:function(){return Yt.a.LastCreatedEngine?Yt.a.LastCreatedEngine.name==="WebGL"&&Yt.a.LastCreatedEngine.version>1:!1},enumerable:!1,configurable:!0}),t.prototype.getCapacity=function(){return this._capacity},Object.defineProperty(t.prototype,"activeParticleCount",{get:function(){return this._activeCount},set:function(e){this._activeCount=Math.min(e,this._capacity)},enumerable:!1,configurable:!0}),t.prototype.isReady=function(){return this._updateEffect?!(!this.emitter||!this._updateEffect.isReady()||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this._getEffect().isReady()||!this.particleTexture||!this.particleTexture.isReady()):(this._recreateUpdateEffect(),this._recreateRenderEffect(),!1)},t.prototype.isStarted=function(){return this._started},t.prototype.isStopped=function(){return this._stopped},t.prototype.isStopping=function(){return!1},t.prototype.getActiveCount=function(){return this._currentActiveCount},t.prototype.start=function(e){var i=this;if(e===void 0&&(e=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(function(){i.start(0)},e);return}this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)},t.prototype.stop=function(){this._stopped||(this._stopped=!0)},t.prototype.reset=function(){this._releaseBuffers(),this._releaseVAOs(),this._currentActiveCount=0,this._targetIndex=0},t.prototype.getClassName=function(){return"GPUParticleSystem"},t.prototype.getCustomEffect=function(e){var i;return e===void 0&&(e=0),(i=this._customEffect[e])!==null&&i!==void 0?i:this._customEffect[0]},t.prototype.setCustomEffect=function(e,i){i===void 0&&(i=0),this._customEffect[i]=e},Object.defineProperty(t.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new _.c),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vertexShaderName",{get:function(){return"gpuRenderParticles"},enumerable:!1,configurable:!0}),t.prototype._removeGradientAndTexture=function(e,i,r){return n.prototype._removeGradientAndTexture.call(this,e,i,r),this._releaseBuffers(),this},t.prototype.addColorGradient=function(e,i,r){this._colorGradients||(this._colorGradients=[]);var o=new qs(e,i);return this._colorGradients.push(o),this._refreshColorGradient(!0),this._releaseBuffers(),this},t.prototype._refreshColorGradient=function(e){e===void 0&&(e=!1),this._colorGradients&&(e&&this._colorGradients.sort(function(i,r){return i.gradient<r.gradient?-1:i.gradient>r.gradient?1:0}),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))},t.prototype.forceRefreshGradients=function(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()},t.prototype.removeColorGradient=function(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this},t.prototype._addFactorGradient=function(e,i,r){var o=new el(i,r);e.push(o),this._releaseBuffers()},t.prototype.addSizeGradient=function(e,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,i),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeSizeGradient=function(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this},t.prototype._refreshFactorGradient=function(e,i,r){if(r===void 0&&(r=!1),!!e){r&&e.sort(function(a,s){return a.gradient<s.gradient?-1:a.gradient>s.gradient?1:0});var o=this;o[i]&&(o[i].dispose(),o[i]=null)}},t.prototype.addAngularSpeedGradient=function(e,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,i),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeAngularSpeedGradient=function(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this},t.prototype.addVelocityGradient=function(e,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,i),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeVelocityGradient=function(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this},t.prototype.addLimitVelocityGradient=function(e,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,i),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeLimitVelocityGradient=function(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this},t.prototype.addDragGradient=function(e,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,i),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeDragGradient=function(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this},t.prototype.addEmitRateGradient=function(e,i,r){return this},t.prototype.removeEmitRateGradient=function(e){return this},t.prototype.addStartSizeGradient=function(e,i,r){return this},t.prototype.removeStartSizeGradient=function(e){return this},t.prototype.addColorRemapGradient=function(e,i,r){return this},t.prototype.removeColorRemapGradient=function(){return this},t.prototype.addAlphaRemapGradient=function(e,i,r){return this},t.prototype.removeAlphaRemapGradient=function(){return this},t.prototype.addRampGradient=function(e,i){return this},t.prototype.removeRampGradient=function(){return this},t.prototype.getRampGradients=function(){return null},Object.defineProperty(t.prototype,"useRampGradients",{get:function(){return!1},set:function(e){},enumerable:!1,configurable:!0}),t.prototype.addLifeTimeGradient=function(e,i,r){return this},t.prototype.removeLifeTimeGradient=function(e){return this},t.prototype._reset=function(){this._releaseBuffers()},t.prototype._createUpdateVAO=function(e){var i={};i.position=e.createVertexBuffer("position",0,3);var r=3;this.particleEmitterType instanceof xn&&(i.initialPosition=e.createVertexBuffer("initialPosition",r,3),r+=3),i.age=e.createVertexBuffer("age",r,1),r+=1,i.life=e.createVertexBuffer("life",r,1),r+=1,i.seed=e.createVertexBuffer("seed",r,4),r+=4,i.size=e.createVertexBuffer("size",r,3),r+=3,this._colorGradientsTexture||(i.color=e.createVertexBuffer("color",r,4),r+=4),i.direction=e.createVertexBuffer("direction",r,3),r+=3,this._isBillboardBased||(i.initialDirection=e.createVertexBuffer("initialDirection",r,3),r+=3),this._angularSpeedGradientsTexture?(i.angle=e.createVertexBuffer("angle",r,1),r+=1):(i.angle=e.createVertexBuffer("angle",r,2),r+=2),this._isAnimationSheetEnabled&&(i.cellIndex=e.createVertexBuffer("cellIndex",r,1),r+=1,this.spriteRandomStartCell&&(i.cellStartOffset=e.createVertexBuffer("cellStartOffset",r,1),r+=1)),this.noiseTexture&&(i.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",r,3),r+=3,i.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",r,3),r+=3);var o=this._engine.recordVertexArrayObject(i,null,this._updateEffect);return this._engine.bindArrayBuffer(null),o},t.prototype._createRenderVAO=function(e,i){var r={};r.position=e.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);var o=3;this.particleEmitterType instanceof xn&&(o+=3),r.age=e.createVertexBuffer("age",o,1,this._attributesStrideSize,!0),o+=1,r.life=e.createVertexBuffer("life",o,1,this._attributesStrideSize,!0),o+=5,r.size=e.createVertexBuffer("size",o,3,this._attributesStrideSize,!0),o+=3,this._colorGradientsTexture||(r.color=e.createVertexBuffer("color",o,4,this._attributesStrideSize,!0),o+=4),this.billboardMode===mi.BILLBOARDMODE_STRETCHED&&(r.direction=e.createVertexBuffer("direction",o,3,this._attributesStrideSize,!0)),o+=3,this._isBillboardBased||(r.initialDirection=e.createVertexBuffer("initialDirection",o,3,this._attributesStrideSize,!0),o+=3),r.angle=e.createVertexBuffer("angle",o,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?o++:o+=2,this._isAnimationSheetEnabled&&(r.cellIndex=e.createVertexBuffer("cellIndex",o,1,this._attributesStrideSize,!0),o+=1,this.spriteRandomStartCell&&(r.cellStartOffset=e.createVertexBuffer("cellStartOffset",o,1,this._attributesStrideSize,!0),o+=1)),this.noiseTexture&&(r.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",o,3,this._attributesStrideSize,!0),o+=3,r.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",o,3,this._attributesStrideSize,!0),o+=3),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2);var a=this._engine.recordVertexArrayObject(r,null,this._getEffect());return this._engine.bindArrayBuffer(null),a},t.prototype._initialize=function(e){if(e===void 0&&(e=!1),!(this._buffer0&&!e)){var i=this._engine,r=new Array;this._attributesStrideSize=21,this._targetIndex=0,this.particleEmitterType instanceof xn&&(this._attributesStrideSize+=3),this.isBillboardBased||(this._attributesStrideSize+=3),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6);for(var o=this.particleEmitterType instanceof xn,a=l.c.Vector3[0],s=0;s<this._capacity;s++)r.push(0),r.push(0),r.push(0),o&&(this.particleEmitterType.particlePositionGenerator(s,null,a),r.push(a.x),r.push(a.y),r.push(a.z)),r.push(0),r.push(0),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(0),r.push(0),r.push(0),this._colorGradientsTexture||(r.push(0),r.push(0),r.push(0),r.push(0)),o?(this.particleEmitterType.particleDestinationGenerator(s,null,a),r.push(a.x),r.push(a.y),r.push(a.z)):(r.push(0),r.push(0),r.push(0)),this.isBillboardBased||(r.push(0),r.push(0),r.push(0)),r.push(0),this._angularSpeedGradientsTexture||r.push(0),this._isAnimationSheetEnabled&&(r.push(0),this.spriteRandomStartCell&&r.push(0)),this.noiseTexture&&(r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()));var c=new Float32Array([.5,.5,1,1,-.5,.5,0,1,-.5,-.5,0,0,.5,-.5,1,0]);this._buffer0=new Oe.a(i,r,!1,this._attributesStrideSize),this._buffer1=new Oe.a(i,r,!1,this._attributesStrideSize),this._spriteBuffer=new Oe.a(i,c,!1,4),this._updateVAO=[],this._updateVAO.push(this._createUpdateVAO(this._buffer0)),this._updateVAO.push(this._createUpdateVAO(this._buffer1)),this._renderVAO=[],this._renderVAO.push(this._createRenderVAO(this._buffer1,this._spriteBuffer)),this._renderVAO.push(this._createRenderVAO(this._buffer0,this._spriteBuffer)),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}},t.prototype._recreateUpdateEffect=function(){var e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),!(this._updateEffect&&this._updateEffectOptions.defines===e)&&(this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this.particleEmitterType instanceof xn&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.defines=e,this._updateEffect=new qe.a("gpuUpdateParticles",this._updateEffectOptions,this._engine))},t.prototype._getEffect=function(){var e;return(e=this.getCustomEffect())!==null&&e!==void 0?e:this._renderEffect},t.prototype.fillDefines=function(e,i){if(i===void 0&&(i=0),this._scene&&(this._scene.clipPlane&&e.push("#define CLIPPLANE"),this._scene.clipPlane2&&e.push("#define CLIPPLANE2"),this._scene.clipPlane3&&e.push("#define CLIPPLANE3"),this._scene.clipPlane4&&e.push("#define CLIPPLANE4"),this._scene.clipPlane5&&e.push("#define CLIPPLANE5"),this._scene.clipPlane6&&e.push("#define CLIPPLANE6")),this.blendMode===mi.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case mi.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case mi.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case mi.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break;default:break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))},t.prototype.fillUniformsAttributesAndSamplerNames=function(e,i,r){i.push("position","age","life","size","color","offset","uv","direction","initialDirection","angle","cellIndex"),e.push("emitterWM","worldOffset","view","projection","colorDead","invView","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","sheetInfos","translationPivot","eyePosition"),r.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(mr.a.PrepareUniforms(e,this._imageProcessingConfigurationDefines),mr.a.PrepareSamplers(r,this._imageProcessingConfigurationDefines))},t.prototype._recreateRenderEffect=function(){var e=this.getCustomEffect();if(e)return e;var i=[];this.fillDefines(i);var r=i.join(`
`);if(this._renderEffect&&this._renderEffect.defines===r)return this._renderEffect;var o=[],a=[],s=[];return this.fillUniformsAttributesAndSamplerNames(a,o,s),this._renderEffect=new qe.a("gpuRenderParticles",o,a,s,this._engine,r),this._renderEffect},t.prototype.animate=function(e){var i;e===void 0&&(e=!1),this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:((i=this._scene)===null||i===void 0?void 0:i.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()},t.prototype._createFactorGradientTexture=function(e,i){var r=this[i];if(!(!e||!e.length||r)){for(var o=new Float32Array(this._rawTextureWidth),a=0;a<this._rawTextureWidth;a++){var s=a/this._rawTextureWidth;Qi.GetCurrentGradient(s,e,function(c,v,b){o[a]=$e.a.Lerp(c.factor1,v.factor1,b)})}this[i]=kr.a.CreateRTexture(o,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1)}},t.prototype._createSizeGradientTexture=function(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")},t.prototype._createAngularSpeedGradientTexture=function(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")},t.prototype._createVelocityGradientTexture=function(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")},t.prototype._createLimitVelocityGradientTexture=function(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")},t.prototype._createDragGradientTexture=function(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")},t.prototype._createColorGradientTexture=function(){if(!(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)){for(var e=new Uint8Array(this._rawTextureWidth*4),i=m.c.Color4[0],r=0;r<this._rawTextureWidth;r++){var o=r/this._rawTextureWidth;Qi.GetCurrentGradient(o,this._colorGradients,function(a,s,c){m.b.LerpToRef(a.color1,s.color1,c,i),e[r*4]=i.r*255,e[r*4+1]=i.g*255,e[r*4+2]=i.b*255,e[r*4+3]=i.a*255})}this._colorGradientsTexture=kr.a.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}},t.prototype.render=function(e){var i,r;if(e===void 0&&(e=!1),!this._started||(this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture(),this._recreateUpdateEffect(),this._recreateRenderEffect(),!this.isReady()))return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(var o=0;o<this.preWarmCycles;o++)this.animate(!0),this.render(!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId())return 0;this._currentRenderId=this._scene.getFrameId()}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){var a=this._accumulatedCount|0;this._accumulatedCount-=a,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+a)}if(!this._currentActiveCount)return 0;this._engine.enableEffect(this._updateEffect);var s=this._engine;if(!s.setState)throw new Error("GPU particles cannot work with a full Engine. ThinEngine is not supported");this._updateEffect.setFloat("currentCount",this._currentActiveCount),this._updateEffect.setFloat("timeDelta",this._timeDelta),this._updateEffect.setFloat("stopFactor",this._stopped?0:1),this._updateEffect.setTexture("randomSampler",this._randomTexture),this._updateEffect.setTexture("randomSampler2",this._randomTexture2),this._updateEffect.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateEffect.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateEffect.setDirectColor4("color1",this.color1),this._updateEffect.setDirectColor4("color2",this.color2)),this._updateEffect.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateEffect.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateEffect.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateEffect.setVector3("gravity",this.gravity),this._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._sizeGradientsTexture),this._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._angularSpeedGradientsTexture),this._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._velocityGradientsTexture),this._limitVelocityGradientsTexture&&(this._updateEffect.setTexture("limitVelocityGradientSampler",this._limitVelocityGradientsTexture),this._updateEffect.setFloat("limitVelocityDamping",this.limitVelocityDamping)),this._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._dragGradientsTexture),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateEffect),this._isAnimationSheetEnabled&&this._updateEffect.setFloat3("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed),this.noiseTexture&&(this._updateEffect.setTexture("noiseSampler",this.noiseTexture),this._updateEffect.setVector3("noiseStrength",this.noiseStrength));var c;if(this.emitter.position){var v=this.emitter;c=v.getWorldMatrix()}else{var b=this.emitter;c=l.a.Translation(b.x,b.y,b.z)}if(this.isLocal||this._updateEffect.setMatrix("emitterWM",c),this._engine.bindVertexArrayObject(this._updateVAO[this._targetIndex],null),s.bindTransformFeedbackBuffer(this._targetBuffer.getBuffer()),s.setRasterizerState(!1),s.beginTransformFeedback(!0),s.drawArraysType(3,0,this._currentActiveCount),s.endTransformFeedback(),s.setRasterizerState(!0),s.bindTransformFeedbackBuffer(null),!e){var C=this._getEffect();this._engine.enableEffect(C);var M=((i=this._scene)===null||i===void 0?void 0:i.getViewMatrix())||l.a.IdentityReadOnly;if(C.setMatrix("view",M),C.setMatrix("projection",(r=this.defaultProjectionMatrix)!==null&&r!==void 0?r:this._scene.getProjectionMatrix()),C.setTexture("diffuseSampler",this.particleTexture),C.setVector2("translationPivot",this.translationPivot),C.setVector3("worldOffset",this.worldOffset),this.isLocal&&C.setMatrix("emitterWM",c),this._colorGradientsTexture?C.setTexture("colorGradientSampler",this._colorGradientsTexture):C.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){var N=this.particleTexture.getBaseSize();C.setFloat3("sheetInfos",this.spriteCellWidth/N.width,this.spriteCellHeight/N.height,N.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){var D=this._scene.activeCamera;C.setVector3("eyePosition",D.globalPosition)}var V=C.defines;if(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&Ot.a.BindClipPlane(C,this._scene),V.indexOf("#define BILLBOARDMODE_ALL")>=0){var X=M.clone();X.invert(),C.setMatrix("invView",X)}switch(this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(C),this.blendMode){case mi.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case mi.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case mi.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case mi.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4);break}this.forceDepthWrite&&s.setDepthWrite(!0),this._engine.bindVertexArrayObject(this._renderVAO[this._targetIndex],null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(C),this._engine.drawArraysType(8,0,4,this._currentActiveCount),this._engine.setAlphaMode(0)}this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);var ee=this._sourceBuffer;return this._sourceBuffer=this._targetBuffer,this._targetBuffer=ee,this._currentActiveCount},t.prototype.rebuild=function(){this._initialize(!0)},t.prototype._releaseBuffers=function(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null)},t.prototype._releaseVAOs=function(){if(!!this._updateVAO){for(var e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO=[];for(var e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO=[]}},t.prototype.dispose=function(e){if(e===void 0&&(e=!0),this._scene){var i=this._scene.particleSystems.indexOf(this);i>-1&&this._scene.particleSystems.splice(i,1)}this._releaseBuffers(),this._releaseVAOs(),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},t.prototype.clone=function(e,i){var r=this.serialize(),o=t.Parse(r,this._scene||this._engine,this._rootUrl),a=Object(h.a)({},this._customEffect);return o.name=e,o._customEffect=a,i===void 0&&(i=this.emitter),o.emitter=i,o.noiseTexture=this.noiseTexture,o},t.prototype.serialize=function(e){e===void 0&&(e=!1);var i={};return mi._Serialize(i,this,e),i.activeParticleCount=this.activeParticleCount,i.randomTextureSize=this._randomTextureSize,i},t.Parse=function(e,i,r,o){o===void 0&&(o=!1);var a=e.name,s=new t(a,{capacity:e.capacity,randomTextureSize:e.randomTextureSize},i);return s._rootUrl=r,e.activeParticleCount&&(s.activeParticleCount=e.activeParticleCount),mi._Parse(e,s,i,r),e.preventAutoStart&&(s.preventAutoStart=e.preventAutoStart),!o&&!s.preventAutoStart&&s.start(),s},t}(To),my=function(){function n(){}return n}(),ua=function(){function n(){this.systems=new Array}return Object.defineProperty(n.prototype,"emitterNode",{get:function(){return this._emitterNode},enumerable:!1,configurable:!0}),n.prototype.setEmitterAsSphere=function(t,e,i){this._emitterNode&&this._emitterNode.dispose(),this._emitterCreationOptions={kind:"Sphere",options:t,renderingGroupId:e};var r=nr.a.CreateSphere("emitterSphere",{diameter:t.diameter,segments:t.segments},i);r.renderingGroupId=e;var o=new Gt.a("emitterSphereMaterial",i);o.emissiveColor=t.color,r.material=o;for(var a=0,s=this.systems;a<s.length;a++){var c=s[a];c.emitter=r}this._emitterNode=r},n.prototype.start=function(t){for(var e=0,i=this.systems;e<i.length;e++){var r=i[e];t&&(r.emitter=t),r.start()}},n.prototype.dispose=function(){for(var t=0,e=this.systems;t<e.length;t++){var i=e[t];i.dispose()}this.systems=[],this._emitterNode&&(this._emitterNode.dispose(),this._emitterNode=null)},n.prototype.serialize=function(t){t===void 0&&(t=!1);var e={};e.systems=[];for(var i=0,r=this.systems;i<r.length;i++){var o=r[i];e.systems.push(o.serialize(t))}return this._emitterNode&&(e.emitter=this._emitterCreationOptions),e},n.Parse=function(t,e,i){i===void 0&&(i=!1);var r=new n,o=this.BaseAssetsUrl+"/textures/";e=e||Yt.a.LastCreatedScene;for(var a=0,s=t.systems;a<s.length;a++){var c=s[a];r.systems.push(i?mn.Parse(c,e,o,!0):mi.Parse(c,e,o,!0))}if(t.emitter){var v=t.emitter.options;switch(t.emitter.kind){case"Sphere":r.setEmitterAsSphere({diameter:v.diameter,segments:v.segments,color:m.a.FromArray(v.color)},t.emitter.renderingGroupId,e);break}}return r},n.BaseAssetsUrl="https://assets.babylonjs.com/particles",n}(),Fm=function(){function n(){}return n.CreateDefault=function(t,e,i,r){e===void 0&&(e=500),r===void 0&&(r=!1);var o;return r?o=new mn("default system",{capacity:e},i):o=new mi("default system",e,i),o.emitter=t,o.particleTexture=new Ze.a("https://www.babylonjs.com/assets/Flare.png",o.getScene()),o.createConeEmitter(.1,Math.PI/4),o.color1=new m.b(1,1,1,1),o.color2=new m.b(1,1,1,1),o.colorDead=new m.b(1,1,1,0),o.minSize=.1,o.maxSize=.1,o.minEmitPower=2,o.maxEmitPower=2,o.updateSpeed=1/60,o.emitRate=30,o},n.CreateAsync=function(t,e,i){i===void 0&&(i=!1),e||(e=Yt.a.LastCreatedScene);var r={};return e._addPendingData(r),new Promise(function(o,a){if(i&&!mn.IsSupported)return e._removePendingData(r),a("Particle system with GPU is not supported.");J.b.LoadFile(n.BaseAssetsUrl+"/systems/"+t+".json",function(s){e._removePendingData(r);var c=JSON.parse(s.toString());return o(ua.Parse(c,e,i))},void 0,void 0,void 0,function(){return e._removePendingData(r),a("An error occurred with the creation of your particle system. Check if your type '"+t+"' exists.")})})},n.ExportSet=function(t){for(var e=new ua,i=0,r=t;i<r.length;i++){var o=r[i];e.systems.push(o)}return e},n.ParseFromFileAsync=function(t,e,i,r,o){return r===void 0&&(r=!1),o===void 0&&(o=""),new Promise(function(a,s){var c=new Ar.a;c.addEventListener("readystatechange",function(){if(c.readyState==4)if(c.status==200){var v=JSON.parse(c.responseText),b=void 0;r?b=mn.Parse(v,i,o):b=mi.Parse(v,i,o),t&&(b.name=t),a(b)}else s("Unable to load the particle system")}),c.open("GET",e),c.send()})},n.CreateFromSnippetAsync=function(t,e,i,r){var o=this;if(i===void 0&&(i=!1),r===void 0&&(r=""),t==="_BLANK"){var a=this.CreateDefault(null);return a.start(),Promise.resolve(a)}return new Promise(function(s,c){var v=new Ar.a;v.addEventListener("readystatechange",function(){if(v.readyState==4)if(v.status==200){var b=JSON.parse(JSON.parse(v.responseText).jsonPayload),C=JSON.parse(b.particleSystem),M=void 0;i?M=mn.Parse(C,e,r):M=mi.Parse(C,e,r),M.snippetId=t,s(M)}else c("Unable to load the snippet "+t)}),v.open("GET",o.SnippetUrl+"/"+t.replace(/#/g,"/")),v.send()})},n.BaseAssetsUrl=ua.BaseAssetsUrl,n.SnippetUrl="https://snippet.babylonjs.com",n}();S.a.AddParser(H.a.NAME_PARTICLESYSTEM,function(n,t,e,i){var r=S.a.GetIndividualParser(H.a.NAME_PARTICLESYSTEM);if(!!r&&n.particleSystems!==void 0&&n.particleSystems!==null)for(var o=0,a=n.particleSystems.length;o<a;o++){var s=n.particleSystems[o];e.particleSystems.push(r(s,t,i))}}),S.a.AddIndividualParser(H.a.NAME_PARTICLESYSTEM,function(n,t,e){if(n.activeParticleCount){var i=mn.Parse(n,t,e);return i}else{var i=mi.Parse(n,t,e);return i}}),W.a.prototype.createEffectForParticles=function(n,t,e,i,r,o,a,s){var c;t===void 0&&(t=[]),e===void 0&&(e=[]),i===void 0&&(i="");var v=[],b=[],C=[];return s?s.fillUniformsAttributesAndSamplerNames(b,v,C):(v=mi._GetAttributeNamesOrOptions(),b=mi._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),e.indexOf("diffuseSampler")===-1&&e.push("diffuseSampler"),this.createEffect({vertex:(c=s==null?void 0:s.vertexShaderName)!==null&&c!==void 0?c:"particles",fragmentElement:n},v,b.concat(t),C.concat(e),i,r,o,a)},ot.a.prototype.getEmittedParticleSystems=function(){for(var n=new Array,t=0;t<this.getScene().particleSystems.length;t++){var e=this.getScene().particleSystems[t];e.emitter===this&&n.push(e)}return n},ot.a.prototype.getHierarchyEmittedParticleSystems=function(){var n=new Array,t=this.getDescendants();t.push(this);for(var e=0;e<this.getScene().particleSystems.length;e++){var i=this.getScene().particleSystems[e],r=i.emitter;r.position&&t.indexOf(r)!==-1&&n.push(i)}return n};var tl=function(){function n(t,e,i,r,o,a,s,c,v,b){v===void 0&&(v=null),b===void 0&&(b=null),this.idx=0,this.id=0,this.color=new m.b(1,1,1,1),this.position=l.e.Zero(),this.rotation=l.e.Zero(),this.scaling=l.e.One(),this.uvs=new l.f(0,0,1,1),this.velocity=l.e.Zero(),this.pivot=l.e.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.materialIndex=null,this.props=null,this.cullingStrategy=Ue.a.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=l.e.Zero(),this.idx=t,this.id=e,this._pos=i,this._ind=r,this._model=o,this.shapeId=a,this.idxInShape=s,this._sps=c,v&&(this._modelBoundingInfo=v,this._boundingInfo=new ke.a(v.minimum,v.maximum)),b!==null&&(this.materialIndex=b)}return n.prototype.copyToRef=function(t){return t.position.copyFrom(this.position),t.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(t.rotationQuaternion?t.rotationQuaternion.copyFrom(this.rotationQuaternion):t.rotationQuaternion=this.rotationQuaternion.clone()),t.scaling.copyFrom(this.scaling),this.color&&(t.color?t.color.copyFrom(this.color):t.color=this.color.clone()),t.uvs.copyFrom(this.uvs),t.velocity.copyFrom(this.velocity),t.pivot.copyFrom(this.pivot),t.translateFromPivot=this.translateFromPivot,t.alive=this.alive,t.isVisible=this.isVisible,t.parentId=this.parentId,t.cullingStrategy=this.cullingStrategy,this.materialIndex!==null&&(t.materialIndex=this.materialIndex),this},Object.defineProperty(n.prototype,"scale",{get:function(){return this.scaling},set:function(t){this.scaling=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(t){this.rotationQuaternion=t},enumerable:!1,configurable:!0}),n.prototype.intersectsMesh=function(t){return!this._boundingInfo||!t._boundingInfo?!1:this._sps._bSphereOnly?Et.a.Intersects(this._boundingInfo.boundingSphere,t._boundingInfo.boundingSphere):this._boundingInfo.intersects(t._boundingInfo,!1)},n.prototype.isInFrustum=function(t){return this._boundingInfo!==null&&this._boundingInfo.isInFrustum(t,this.cullingStrategy)},n.prototype.getRotationMatrix=function(t){var e;if(this.rotationQuaternion)e=this.rotationQuaternion;else{e=l.c.Quaternion[0];var i=this.rotation;l.b.RotationYawPitchRollToRef(i.y,i.x,i.z,e)}e.toRotationMatrix(t)},n}(),il=function(){function n(t,e,i,r,o,a,s,c,v){this._indicesLength=0,this.shapeID=t,this._shape=e,this._indices=i,this._indicesLength=i.length,this._shapeUV=a,this._shapeColors=o,this._normals=r,this._positionFunction=s,this._vertexFunction=c,this._material=v}return n}(),gh=function(){function n(t,e,i,r){this.idx=0,this.ind=0,this.indicesLength=0,this.sqDistance=0,this.materialIndex=0,this.idx=t,this.ind=e,this.indicesLength=i,this.materialIndex=r}return n}(),mh=function(){function n(){this.position=l.e.Zero(),this.color=new m.b(1,1,1,1),this.uv=l.d.Zero()}return Object.defineProperty(n.prototype,"x",{get:function(){return this.position.x},set:function(t){this.position.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this.position.y},set:function(t){this.position.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"z",{get:function(){return this.position.z},set:function(t){this.position.z=t},enumerable:!1,configurable:!0}),n}(),Bm=function(){function n(t,e,i){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!1,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._expandable=!1,this._shapeCounter=0,this._copy=new tl(0,0,0,0,null,0,0,this),this._color=new m.b(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this._isNotBuilt=!0,this._lastParticleId=0,this._idxOfId=[],this._multimaterialEnabled=!1,this._useModelMaterial=!1,this._depthSortFunction=function(r,o){return o.sqDistance-r.sqDistance},this._materialSortFunction=function(r,o){return r.materialIndex-o.materialIndex},this._autoUpdateSubMeshes=!1,this.name=t,this._scene=e||Yt.a.LastCreatedScene,this._camera=e.activeCamera,this._pickable=i?i.isPickable:!1,this._depthSort=i?i.enableDepthSort:!1,this._multimaterialEnabled=i?i.enableMultiMaterial:!1,this._useModelMaterial=i?i.useModelMaterial:!1,this._multimaterialEnabled=this._useModelMaterial?!0:this._multimaterialEnabled,this._expandable=i?i.expandable:!1,this._particlesIntersect=i?i.particleIntersection:!1,this._bSphereOnly=i?i.boundingSphereOnly:!1,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,i&&i.updatable!==void 0?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]),(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]),this._multimaterialEnabled&&(this._multimaterial=new yo.a(this.name+"MultiMaterial",this._scene),this._materials=[],this._materialIndexesById={}),this._tmpVertex=new mh}return n.prototype.buildMesh=function(){if(!this._isNotBuilt&&this.mesh)return this.mesh;if(this.nbParticles===0&&!this.mesh){var t=Yf.a.CreateDisc("",{radius:1,tessellation:3},this._scene);this.addShape(t,1),t.dispose()}if(this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),!this.mesh){var e=new ot.a(this.name,this._scene);this.mesh=e}!this._updatable&&this._multimaterialEnabled&&this._sortParticlesByMaterial(),this.recomputeNormals&&an.a.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();var i=new an.a;if(i.indices=this._depthSort?this._indices:this._indices32,i.set(this._positions32,Oe.b.PositionKind),i.set(this._normals32,Oe.b.NormalKind),this._uvs32.length>0&&i.set(this._uvs32,Oe.b.UVKind),this._colors32.length>0&&i.set(this._colors32,Oe.b.ColorKind),i.applyToMesh(this.mesh,this._updatable),this.mesh.isPickable=this._pickable,this._pickable)for(var r=0,o=0;o<this.nbParticles;o++)for(var a=this.particles[o],s=a._model._indicesLength,c=0;c<s;c++){var v=c%3;if(v==0){var b={idx:a.idx,faceId:r};this.pickedParticles[r]=b,r++}}return this._multimaterialEnabled&&this.setMultiMaterial(this._materials),this._expandable||(!this._depthSort&&!this._multimaterialEnabled&&(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0)),this._isNotBuilt=!1,this.recomputeNormals=!1,this.mesh},n.prototype.digest=function(t,e){var i=e&&e.facetNb||1,r=e&&e.number||0,o=e&&e.delta||0,a=t.getVerticesData(Oe.b.PositionKind),s=t.getIndices(),c=t.getVerticesData(Oe.b.UVKind),v=t.getVerticesData(Oe.b.ColorKind),b=t.getVerticesData(Oe.b.NormalKind),C=e&&e.storage?e.storage:null,M=0,N=s.length/3;r?(r=r>N?N:r,i=Math.round(N/r),o=0):i=i>N?N:i;for(var D=[],V=[],X=[],ee=[],ie=[],ge=l.e.Zero(),pe=i;M<N;){i=pe+Math.floor((1+o)*Math.random()),M>N-i&&(i=N-M),D.length=0,V.length=0,X.length=0,ee.length=0,ie.length=0;for(var te=0,Ce=M*3;Ce<(M+i)*3;Ce++){X.push(te);var Ae=s[Ce],De=Ae*3;if(D.push(a[De],a[De+1],a[De+2]),V.push(b[De],b[De+1],b[De+2]),c){var Fe=Ae*2;ee.push(c[Fe],c[Fe+1])}if(v){var We=Ae*4;ie.push(v[We],v[We+1],v[We+2],v[We+3])}te++}var Pe=this.nbParticles,Ne=this._posToShape(D),je=this._uvsToShapeUV(ee),Be=J.b.Slice(X),Je=J.b.Slice(ie),tt=J.b.Slice(V);ge.copyFromFloats(0,0,0);var Xe;for(Xe=0;Xe<Ne.length;Xe++)ge.addInPlace(Ne[Xe]);ge.scaleInPlace(1/Ne.length);var Ct=new l.e(Infinity,Infinity,Infinity),At=new l.e(-Infinity,-Infinity,-Infinity);for(Xe=0;Xe<Ne.length;Xe++)Ne[Xe].subtractInPlace(ge),Ct.minimizeInPlaceFromFloats(Ne[Xe].x,Ne[Xe].y,Ne[Xe].z),At.maximizeInPlaceFromFloats(Ne[Xe].x,Ne[Xe].y,Ne[Xe].z);var Rt;this._particlesIntersect&&(Rt=new ke.a(Ct,At));var rt=null;this._useModelMaterial&&(rt=t.material?t.material:this._setDefaultMaterial());var Bt=new il(this._shapeCounter,Ne,Be,tt,Je,je,null,null,rt),jt=this._positions.length,at=this._indices.length;this._meshBuilder(this._index,at,Ne,this._positions,Be,this._indices,ee,this._uvs,Je,this._colors,tt,this._normals,Pe,0,null,Bt),this._addParticle(Pe,this._lastParticleId,jt,at,Bt,this._shapeCounter,0,Rt,C),this.particles[this.nbParticles].position.addInPlace(ge),C||(this._index+=Ne.length,Pe++,this.nbParticles++,this._lastParticleId++),this._shapeCounter++,M+=i}return this._isNotBuilt=!0,this},n.prototype._unrotateFixedNormals=function(){for(var t=0,e=0,i=l.c.Vector3[0],r=l.c.Quaternion[0],o=l.c.Matrix[0],a=0;a<this.particles.length;a++){var s=this.particles[a],c=s._model._shape;if(s.rotationQuaternion)s.rotationQuaternion.conjugateToRef(r);else{var v=s.rotation;l.b.RotationYawPitchRollToRef(v.y,v.x,v.z,r),r.conjugateInPlace()}r.toRotationMatrix(o);for(var b=0;b<c.length;b++)e=t+b*3,l.e.TransformNormalFromFloatsToRef(this._normals32[e],this._normals32[e+1],this._normals32[e+2],o,i),i.toArray(this._fixedNormal32,e);t=e+3}},n.prototype._resetCopy=function(){var t=this._copy;t.position.setAll(0),t.rotation.setAll(0),t.rotationQuaternion=null,t.scaling.setAll(1),t.uvs.copyFromFloats(0,0,1,1),t.color=null,t.translateFromPivot=!1,t.shapeId=0,t.materialIndex=null},n.prototype._meshBuilder=function(t,e,i,r,o,a,s,c,v,b,C,M,N,D,V,X){var ee,ie=0,ge=0,pe=0;this._resetCopy();var te=this._copy,Ce=!!(V&&V.storage);if(te.idx=N,te.idxInShape=D,te.shapeId=X.shapeID,this._useModelMaterial){var Ae=X._material.uniqueId,De=this._materialIndexesById;De.hasOwnProperty(Ae)||(De[Ae]=this._materials.length,this._materials.push(X._material));var Fe=De[Ae];te.materialIndex=Fe}if(V&&V.positionFunction&&(V.positionFunction(te,N,D),this._mustUnrotateFixedNormals=!0),Ce)return te;var We=l.c.Matrix[0],Pe=this._tmpVertex,Ne=Pe.position,je=Pe.color,Be=Pe.uv,Je=l.c.Vector3[1],tt=l.c.Vector3[2],Xe=l.c.Vector3[3];l.a.IdentityToRef(We),te.getRotationMatrix(We),te.pivot.multiplyToRef(te.scaling,Xe),te.translateFromPivot?tt.setAll(0):tt.copyFrom(Xe);var Ct=V&&V.vertexFunction;for(ee=0;ee<i.length;ee++){if(Ne.copyFrom(i[ee]),te.color&&je.copyFrom(te.color),s&&Be.copyFromFloats(s[ie],s[ie+1]),Ct&&V.vertexFunction(te,Pe,ee),Ne.multiplyInPlace(te.scaling).subtractInPlace(Xe),l.e.TransformCoordinatesToRef(Ne,We,Je),Je.addInPlace(tt).addInPlace(te.position),r.push(Je.x,Je.y,Je.z),s){var At=te.uvs;c.push((At.z-At.x)*Be.x+At.x,(At.w-At.y)*Be.y+At.y),ie+=2}if(te.color)this._color.copyFrom(je);else{var Rt=this._color;v&&v[ge]!==void 0?(Rt.r=v[ge],Rt.g=v[ge+1],Rt.b=v[ge+2],Rt.a=v[ge+3]):(Rt.r=1,Rt.g=1,Rt.b=1,Rt.a=1)}b.push(this._color.r,this._color.g,this._color.b,this._color.a),ge+=4,!this.recomputeNormals&&C&&(l.e.TransformNormalFromFloatsToRef(C[pe],C[pe+1],C[pe+2],We,Ne),M.push(Ne.x,Ne.y,Ne.z),pe+=3)}for(ee=0;ee<o.length;ee++){var rt=t+o[ee];a.push(rt),rt>65535&&(this._needs32Bits=!0)}if(this._depthSort||this._multimaterialEnabled){var Bt=te.materialIndex!==null?te.materialIndex:0;this.depthSortedParticles.push(new gh(N,e,o.length,Bt))}return te},n.prototype._posToShape=function(t){for(var e=[],i=0;i<t.length;i+=3)e.push(l.e.FromArray(t,i));return e},n.prototype._uvsToShapeUV=function(t){var e=[];if(t)for(var i=0;i<t.length;i++)e.push(t[i]);return e},n.prototype._addParticle=function(t,e,i,r,o,a,s,c,v){c===void 0&&(c=null),v===void 0&&(v=null);var b=new tl(t,e,i,r,o,a,s,this,c),C=v||this.particles;return C.push(b),b},n.prototype.addShape=function(t,e,i){var r=t.getVerticesData(Oe.b.PositionKind),o=t.getIndices(),a=t.getVerticesData(Oe.b.UVKind),s=t.getVerticesData(Oe.b.ColorKind),c=t.getVerticesData(Oe.b.NormalKind);this.recomputeNormals=!c;var v=J.b.SliceToArray(o),b=J.b.SliceToArray(c),C=s?J.b.SliceToArray(s):[],M=i&&i.storage?i.storage:null,N=null;this._particlesIntersect&&(N=t.getBoundingInfo());var D=this._posToShape(r),V=this._uvsToShapeUV(a),X=i?i.positionFunction:null,ee=i?i.vertexFunction:null,ie=null;this._useModelMaterial&&(ie=t.material?t.material:this._setDefaultMaterial());for(var ge=new il(this._shapeCounter,D,v,b,C,V,X,ee,ie),pe=0;pe<e;pe++)this._insertNewParticle(this.nbParticles,pe,ge,D,o,a,s,c,N,M,i);return this._shapeCounter++,this._isNotBuilt=!0,this._shapeCounter-1},n.prototype._rebuildParticle=function(t,e){e===void 0&&(e=!1),this._resetCopy();var i=this._copy;t._model._positionFunction&&t._model._positionFunction(i,t.idx,t.idxInShape);var r=l.c.Matrix[0],o=l.c.Vector3[0],a=l.c.Vector3[1],s=l.c.Vector3[2],c=l.c.Vector3[3];i.getRotationMatrix(r),t.pivot.multiplyToRef(t.scaling,c),i.translateFromPivot?s.copyFromFloats(0,0,0):s.copyFrom(c);for(var v=t._model._shape,b=0;b<v.length;b++)o.copyFrom(v[b]),t._model._vertexFunction&&t._model._vertexFunction(i,o,b),o.multiplyInPlace(i.scaling).subtractInPlace(c),l.e.TransformCoordinatesToRef(o,r,a),a.addInPlace(s).addInPlace(i.position).toArray(this._positions32,t._pos+b*3);e&&(t.position.setAll(0),t.rotation.setAll(0),t.rotationQuaternion=null,t.scaling.setAll(1),t.uvs.setAll(0),t.pivot.setAll(0),t.translateFromPivot=!1,t.parentId=null)},n.prototype.rebuildMesh=function(t){t===void 0&&(t=!1);for(var e=0;e<this.particles.length;e++)this._rebuildParticle(this.particles[e],t);return this.mesh.updateVerticesData(Oe.b.PositionKind,this._positions32,!1,!1),this},n.prototype.removeParticles=function(t,e){var i=e-t+1;if(!this._expandable||i<=0||i>=this.nbParticles||!this._updatable)return[];var r=this.particles,o=this.nbParticles;if(e<o-1)for(var a=e+1,s=r[a]._pos-r[t]._pos,c=r[a]._ind-r[t]._ind,v=a;v<o;v++){var b=r[v];b._pos-=s,b._ind-=c}var C=r.splice(t,i);this._positions.length=0,this._indices.length=0,this._colors.length=0,this._uvs.length=0,this._normals.length=0,this._index=0,this._idxOfId.length=0,(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]);for(var M=0,N=r.length,D=0;D<N;D++){var V=r[D],X=V._model,ee=X._shape,ie=X._indices,ge=X._normals,pe=X._shapeColors,te=X._shapeUV;V.idx=D,this._idxOfId[V.id]=D,this._meshBuilder(this._index,M,ee,this._positions,ie,this._indices,te,this._uvs,pe,this._colors,ge,this._normals,V.idx,V.idxInShape,null,X),this._index+=ee.length,M+=ie.length}return this.nbParticles-=i,this._isNotBuilt=!0,C},n.prototype.insertParticlesFromArray=function(t){if(!this._expandable)return this;for(var e=0,i=t[0].shapeId,r=t.length,o=0;o<r;o++){var a=t[o],s=a._model,c=s._shape,v=s._indices,b=s._shapeUV,C=s._shapeColors,M=s._normals,N=!M;this.recomputeNormals=N||this.recomputeNormals;var D=a._boundingInfo,V=this._insertNewParticle(this.nbParticles,e,s,c,v,b,C,M,D,null,null);a.copyToRef(V),e++,i!=a.shapeId&&(i=a.shapeId,e=0)}return this._isNotBuilt=!0,this},n.prototype._insertNewParticle=function(t,e,i,r,o,a,s,c,v,b,C){var M=this._positions.length,N=this._indices.length,D=this._meshBuilder(this._index,N,r,this._positions,o,this._indices,a,this._uvs,s,this._colors,c,this._normals,t,e,C,i),V=null;return this._updatable&&(V=this._addParticle(this.nbParticles,this._lastParticleId,M,N,i,this._shapeCounter,e,v,b),V.position.copyFrom(D.position),V.rotation.copyFrom(D.rotation),D.rotationQuaternion&&(V.rotationQuaternion?V.rotationQuaternion.copyFrom(D.rotationQuaternion):V.rotationQuaternion=D.rotationQuaternion.clone()),D.color&&(V.color?V.color.copyFrom(D.color):V.color=D.color.clone()),V.scaling.copyFrom(D.scaling),V.uvs.copyFrom(D.uvs),D.materialIndex!==null&&(V.materialIndex=D.materialIndex),this.expandable&&(this._idxOfId[V.id]=V.idx)),b||(this._index+=r.length,this.nbParticles++,this._lastParticleId++),V},n.prototype.setParticles=function(t,e,i){if(t===void 0&&(t=0),e===void 0&&(e=this.nbParticles-1),i===void 0&&(i=!0),!this._updatable||this._isNotBuilt)return this;this.beforeUpdateParticles(t,e,i);var r=l.c.Matrix[0],o=l.c.Matrix[1],a=this.mesh,s=this._colors32,c=this._positions32,v=this._normals32,b=this._uvs32,C=this._indices32,M=this._indices,N=this._fixedNormal32,D=l.c.Vector3,V=D[5].copyFromFloats(1,0,0),X=D[6].copyFromFloats(0,1,0),ee=D[7].copyFromFloats(0,0,1),ie=D[8].setAll(Number.MAX_VALUE),ge=D[9].setAll(-Number.MAX_VALUE),pe=D[10].setAll(0),te=this._tmpVertex,Ce=te.position,Ae=te.color,De=te.uv;if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(o)),this.billboard){var Fe=D[0];this._camera.getDirectionToRef(xe.a.Z,Fe),l.e.TransformNormalToRef(Fe,o,ee),ee.normalize();var We=this._camera.getViewMatrix(!0);l.e.TransformNormalFromFloatsToRef(We.m[1],We.m[5],We.m[9],o,X),l.e.CrossToRef(X,ee,V),X.normalize(),V.normalize()}this._depthSort&&l.e.TransformCoordinatesToRef(this._camera.globalPosition,o,pe),l.a.IdentityToRef(r);var Pe=0,Ne=0,je=0,Be=0,Je=0,tt=0,Xe=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),e=e>=this.nbParticles?this.nbParticles-1:e,this._computeBoundingBox&&(t!=0||e!=this.nbParticles-1)){var Ct=this.mesh._boundingInfo;Ct&&(ie.copyFrom(Ct.minimum),ge.copyFrom(Ct.maximum))}Ne=this.particles[t]._pos;var At=Ne/3|0;Be=At*4,tt=At*2;for(var Rt=t;Rt<=e;Rt++){var rt=this.particles[Rt];this.updateParticle(rt);var Bt=rt._model._shape,jt=rt._model._shapeUV,at=rt._rotationMatrix,Lt=rt.position,Qe=rt.rotation,lt=rt.scaling,wt=rt._globalPosition;if(this._depthSort&&this._depthSortParticles){var fi=this.depthSortedParticles[Rt];fi.idx=rt.idx,fi.ind=rt._ind,fi.indicesLength=rt._model._indicesLength,fi.sqDistance=l.e.DistanceSquared(rt.position,pe)}if(!rt.alive||rt._stillInvisible&&!rt.isVisible){Xe=Bt.length,Ne+=Xe*3,Be+=Xe*4,tt+=Xe*2;continue}if(rt.isVisible){rt._stillInvisible=!1;var si=D[12];rt.pivot.multiplyToRef(lt,si),this.billboard&&(Qe.x=0,Qe.y=0),(this._computeParticleRotation||this.billboard)&&rt.getRotationMatrix(r);var xi=rt.parentId!==null;if(xi){var bi=this.getParticleById(rt.parentId);if(bi){var St=bi._rotationMatrix,$t=bi._globalPosition,vi=Lt.x*St[1]+Lt.y*St[4]+Lt.z*St[7],hi=Lt.x*St[0]+Lt.y*St[3]+Lt.z*St[6],di=Lt.x*St[2]+Lt.y*St[5]+Lt.z*St[8];if(wt.x=$t.x+hi,wt.y=$t.y+vi,wt.z=$t.z+di,this._computeParticleRotation||this.billboard){var ct=r.m;at[0]=ct[0]*St[0]+ct[1]*St[3]+ct[2]*St[6],at[1]=ct[0]*St[1]+ct[1]*St[4]+ct[2]*St[7],at[2]=ct[0]*St[2]+ct[1]*St[5]+ct[2]*St[8],at[3]=ct[4]*St[0]+ct[5]*St[3]+ct[6]*St[6],at[4]=ct[4]*St[1]+ct[5]*St[4]+ct[6]*St[7],at[5]=ct[4]*St[2]+ct[5]*St[5]+ct[6]*St[8],at[6]=ct[8]*St[0]+ct[9]*St[3]+ct[10]*St[6],at[7]=ct[8]*St[1]+ct[9]*St[4]+ct[10]*St[7],at[8]=ct[8]*St[2]+ct[9]*St[5]+ct[10]*St[8]}}else rt.parentId=null}else if(wt.x=Lt.x,wt.y=Lt.y,wt.z=Lt.z,this._computeParticleRotation||this.billboard){var ct=r.m;at[0]=ct[0],at[1]=ct[1],at[2]=ct[2],at[3]=ct[4],at[4]=ct[5],at[5]=ct[6],at[6]=ct[8],at[7]=ct[9],at[8]=ct[10]}var oi=D[11];for(rt.translateFromPivot?oi.setAll(0):oi.copyFrom(si),Xe=0;Xe<Bt.length;Xe++){Pe=Ne+Xe*3,je=Be+Xe*4,Je=tt+Xe*2;var sn=2*Xe,Kr=sn+1;Ce.copyFrom(Bt[Xe]),this._computeParticleColor&&rt.color&&Ae.copyFrom(rt.color),this._computeParticleTexture&&De.copyFromFloats(jt[sn],jt[Kr]),this._computeParticleVertex&&this.updateParticleVertex(rt,te,Xe);var Nn=Ce.x*lt.x-si.x,Qr=Ce.y*lt.y-si.y,_n=Ce.z*lt.z-si.z,hi=Nn*at[0]+Qr*at[3]+_n*at[6],vi=Nn*at[1]+Qr*at[4]+_n*at[7],di=Nn*at[2]+Qr*at[5]+_n*at[8];hi+=oi.x,vi+=oi.y,di+=oi.z;var Oa=c[Pe]=wt.x+V.x*hi+X.x*vi+ee.x*di,wn=c[Pe+1]=wt.y+V.y*hi+X.y*vi+ee.y*di,rp=c[Pe+2]=wt.z+V.z*hi+X.z*vi+ee.z*di;if(this._computeBoundingBox&&(ie.minimizeInPlaceFromFloats(Oa,wn,rp),ge.maximizeInPlaceFromFloats(Oa,wn,rp)),!this._computeParticleVertex){var pl=N[Pe],gl=N[Pe+1],ml=N[Pe+2],vl=pl*at[0]+gl*at[3]+ml*at[6],_l=pl*at[1]+gl*at[4]+ml*at[7],yl=pl*at[2]+gl*at[5]+ml*at[8];v[Pe]=V.x*vl+X.x*_l+ee.x*yl,v[Pe+1]=V.y*vl+X.y*_l+ee.y*yl,v[Pe+2]=V.z*vl+X.z*_l+ee.z*yl}if(this._computeParticleColor&&rt.color){var Ma=this._colors32;Ma[je]=Ae.r,Ma[je+1]=Ae.g,Ma[je+2]=Ae.b,Ma[je+3]=Ae.a}if(this._computeParticleTexture){var hr=rt.uvs;b[Je]=De.x*(hr.z-hr.x)+hr.x,b[Je+1]=De.y*(hr.w-hr.y)+hr.y}}}else for(rt._stillInvisible=!0,Xe=0;Xe<Bt.length;Xe++){if(Pe=Ne+Xe*3,je=Be+Xe*4,Je=tt+Xe*2,c[Pe]=c[Pe+1]=c[Pe+2]=0,v[Pe]=v[Pe+1]=v[Pe+2]=0,this._computeParticleColor&&rt.color){var xa=rt.color;s[je]=xa.r,s[je+1]=xa.g,s[je+2]=xa.b,s[je+3]=xa.a}if(this._computeParticleTexture){var hr=rt.uvs;b[Je]=jt[Xe*2]*(hr.z-hr.x)+hr.x,b[Je+1]=jt[Xe*2+1]*(hr.w-hr.y)+hr.y}}if(this._particlesIntersect){var np=rt._boundingInfo,Wv=np.boundingBox,Hv=np.boundingSphere,bl=rt._modelBoundingInfo;if(!this._bSphereOnly){var El=bl.boundingBox.vectors,Pl=D[1],Cl=D[2];Pl.setAll(Number.MAX_VALUE),Cl.setAll(-Number.MAX_VALUE);for(var Lo=0;Lo<8;Lo++){var Sl=El[Lo].x*lt.x,Tl=El[Lo].y*lt.y,Rl=El[Lo].z*lt.z,hi=Sl*at[0]+Tl*at[3]+Rl*at[6],vi=Sl*at[1]+Tl*at[4]+Rl*at[7],di=Sl*at[2]+Tl*at[5]+Rl*at[8],op=Lt.x+V.x*hi+X.x*vi+ee.x*di,ap=Lt.y+V.y*hi+X.y*vi+ee.y*di,sp=Lt.z+V.z*hi+X.z*vi+ee.z*di;Pl.minimizeInPlaceFromFloats(op,ap,sp),Cl.maximizeInPlaceFromFloats(op,ap,sp)}Wv.reConstruct(Pl,Cl,a._worldMatrix)}var lp=bl.minimum.multiplyToRef(lt,D[1]),up=bl.maximum.multiplyToRef(lt,D[2]),cp=up.addToRef(lp,D[3]).scaleInPlace(.5).addInPlace(wt),fp=up.subtractToRef(lp,D[4]).scaleInPlace(.5*this._bSphereRadiusFactor),kv=cp.subtractToRef(fp,D[1]),Xv=cp.addToRef(fp,D[2]);Hv.reConstruct(kv,Xv,a._worldMatrix)}Ne=Pe+3,Be=je+4,tt=Je+2}if(i){if(this._computeParticleColor&&a.updateVerticesData(Oe.b.ColorKind,s,!1,!1),this._computeParticleTexture&&a.updateVerticesData(Oe.b.UVKind,b,!1,!1),a.updateVerticesData(Oe.b.PositionKind,c,!1,!1),!a.areNormalsFrozen||a.isFacetDataEnabled){if(this._computeParticleVertex||a.isFacetDataEnabled){var Yv=a.isFacetDataEnabled?a.getFacetDataParameters():null;an.a.ComputeNormals(c,C,v,Yv);for(var Zr=0;Zr<v.length;Zr++)N[Zr]=v[Zr]}a.areNormalsFrozen||a.updateVerticesData(Oe.b.NormalKind,v,!1,!1)}if(this._depthSort&&this._depthSortParticles){var Al=this.depthSortedParticles;Al.sort(this._depthSortFunction);for(var Kv=Al.length,hp=0,Ol=0,Ml=0;Ml<Kv;Ml++)for(var xl=Al[Ml],Qv=xl.indicesLength,Zv=xl.ind,Zr=0;Zr<Qv;Zr++)if(C[hp]=M[Zv+Zr],hp++,this._pickable){var Jv=Zr%3;if(Jv==0){var dp=this.pickedParticles[Ol];dp.idx=xl.idx,dp.faceId=Ol,Ol++}}a.updateIndices(C)}}return this._computeBoundingBox&&(a._boundingInfo?a._boundingInfo.reConstruct(ie,ge,a._worldMatrix):a._boundingInfo=new ke.a(ie,ge,a._worldMatrix)),this._autoUpdateSubMeshes&&this.computeSubMeshes(),this.afterUpdateParticles(t,e,i),this},n.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null,this.pickedBySubMesh=null,this._materials=null,this._materialIndexes=null,this._indicesByMaterial=null,this._idxOfId=null},n.prototype.pickedParticle=function(t){if(t.hit){var e=t.subMeshId,i=t.faceId,r=this.pickedBySubMesh;if(r[e]&&r[e][i])return r[e][i]}return null},n.prototype.getParticleById=function(t){var e=this.particles[t];if(e&&e.id==t)return e;var i=this.particles,r=this._idxOfId[t];if(r!==void 0)return i[r];for(var o=0,a=this.nbParticles;o<a;){var s=i[o];if(s.id==t)return s;o++}return null},n.prototype.getParticlesByShapeId=function(t){var e=[];return this.getParticlesByShapeIdToRef(t,e),e},n.prototype.getParticlesByShapeIdToRef=function(t,e){e.length=0;for(var i=0;i<this.nbParticles;i++){var r=this.particles[i];r.shapeId==t&&e.push(r)}return this},n.prototype.computeSubMeshes=function(){if(!this.mesh||!this._multimaterialEnabled)return this;var t=this.depthSortedParticles;if(this.particles.length>0)for(var e=0;e<this.particles.length;e++){var i=this.particles[e];i.materialIndex||(i.materialIndex=0);var r=t[e];r.materialIndex=i.materialIndex,r.ind=i._ind,r.indicesLength=i._model._indicesLength,r.idx=i.idx}this._sortParticlesByMaterial();var o=this._indicesByMaterial,a=this._materialIndexes,s=this.mesh;s.subMeshes=[];for(var c=s.getTotalVertices(),v=0;v<a.length;v++){var b=o[v],C=o[v+1]-b,M=a[v];new Ao.a(M,0,c,b,C,s)}return this},n.prototype._sortParticlesByMaterial=function(){var t=[0];this._indicesByMaterial=t;var e=[];this._materialIndexes=e;var i=this.depthSortedParticles;i.sort(this._materialSortFunction);var r=i.length,o=this._indices32,a=this._indices,s=0,c=0,v=0,b=i[0].materialIndex;e.push(b),this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]);for(var C=0;C<r;C++){var M=i[C],N=M.indicesLength,D=M.ind;M.materialIndex!==b&&(b=M.materialIndex,t.push(v),e.push(b),this._pickable&&(s++,this.pickedBySubMesh[s]=[],c=0));for(var V=0,X=0;X<N;X++){if(o[v]=a[D+X],this._pickable){var ee=X%3;if(ee==0){var ie=this.pickedBySubMesh[s][c];ie?(ie.idx=M.idx,ie.faceId=V):this.pickedBySubMesh[s][c]={idx:M.idx,faceId:V},c++,V++}}v++}}return t.push(o.length),this._updatable&&this.mesh.updateIndices(o),this},n.prototype._setMaterialIndexesById=function(){this._materialIndexesById={};for(var t=0;t<this._materials.length;t++){var e=this._materials[t].uniqueId;this._materialIndexesById[e]=t}},n.prototype._filterUniqueMaterialId=function(t){var e=t.filter(function(i,r,o){return o.indexOf(i)===r});return e},n.prototype._setDefaultMaterial=function(){return this._defaultMaterial||(this._defaultMaterial=new Gt.a(this.name+"DefaultMaterial",this._scene)),this._defaultMaterial},n.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},n.prototype.setVisibilityBox=function(t){var e=t/2;this.mesh._boundingInfo=new ke.a(new l.e(-e,-e,-e),new l.e(e,e,e))},Object.defineProperty(n.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(t){this._isVisibilityBoxLocked=t;var e=this.mesh.getBoundingInfo();e.isLocked=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(t){this._computeParticleRotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(t){this._computeParticleColor=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(t){this._computeParticleTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(t){this._computeParticleVertex=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(t){this._computeBoundingBox=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"depthSortParticles",{get:function(){return this._depthSortParticles},set:function(t){this._depthSortParticles=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"expandable",{get:function(){return this._expandable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"multimaterialEnabled",{get:function(){return this._multimaterialEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useModelMaterial",{get:function(){return this._useModelMaterial},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"materials",{get:function(){return this._materials},enumerable:!1,configurable:!0}),n.prototype.setMultiMaterial=function(t){this._materials=this._filterUniqueMaterialId(t),this._setMaterialIndexesById(),this._multimaterial&&this._multimaterial.dispose(),this._multimaterial=new yo.a(this.name+"MultiMaterial",this._scene);for(var e=0;e<this._materials.length;e++)this._multimaterial.subMaterials.push(this._materials[e]);this.computeSubMeshes(),this.mesh.material=this._multimaterial},Object.defineProperty(n.prototype,"multimaterial",{get:function(){return this._multimaterial},set:function(t){this._multimaterial=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"autoUpdateSubMeshes",{get:function(){return this._autoUpdateSubMeshes},set:function(t){this._autoUpdateSubMeshes=t},enumerable:!1,configurable:!0}),n.prototype.initParticles=function(){},n.prototype.recycleParticle=function(t){return t},n.prototype.updateParticle=function(t){return t},n.prototype.updateParticleVertex=function(t,e,i){return this},n.prototype.beforeUpdateParticles=function(t,e,i){},n.prototype.afterUpdateParticles=function(t,e,i){},n}(),vh=u(610),_h=u(665),yh=u(544),In=u(510);q.a.prototype.getPhysicsEngine=function(){return this._physicsEngine},q.a.prototype.enablePhysics=function(n,t){if(n===void 0&&(n=null),this._physicsEngine)return!0;var e=this._getComponent(H.a.NAME_PHYSICSENGINE);e||(e=new bh(this),this._addComponent(e));try{return this._physicsEngine=new yh.a(n,t),this._physicsTimeAccumulator=0,!0}catch(i){return p.a.Error(i.message),!1}},q.a.prototype.disablePhysicsEngine=function(){!this._physicsEngine||(this._physicsEngine.dispose(),this._physicsEngine=null)},q.a.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==void 0},q.a.prototype.deleteCompoundImpostor=function(n){var t=n.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},q.a.prototype._advancePhysicsEngineStep=function(n){if(this._physicsEngine){var t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=n;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(n/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}},Object.defineProperty(Ue.a.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(n){var t=this;this._physicsImpostor!==n&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=n,n&&(this._disposePhysicsObserver=this.onDisposeObservable.add(function(){t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)})))},enumerable:!0,configurable:!0}),Ue.a.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},Ue.a.prototype.applyImpulse=function(n,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(n,t),this):this},Ue.a.prototype.setPhysicsLinkWith=function(n,t,e,i){return!this.physicsImpostor||!n.physicsImpostor?this:(this.physicsImpostor.createJoint(n.physicsImpostor,In.e.HingeJoint,{mainPivot:t,connectedPivot:e,nativeParams:i}),this)};var bh=function(){function n(t){var e=this;this.name=H.a.NAME_PHYSICSENGINE,this.scene=t,this.scene.onBeforePhysicsObservable=new _.c,this.scene.onAfterPhysicsObservable=new _.c,this.scene.getDeterministicFrameTime=function(){return e.scene._physicsEngine?e.scene._physicsEngine.getTimeStep()*1e3:1e3/60}}return n.prototype.register=function(){},n.prototype.rebuild=function(){},n.prototype.dispose=function(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()},n}(),Nm=function(){function n(t){if(this._scene=t,this._physicsEngine=this._scene.getPhysicsEngine(),!this._physicsEngine){p.a.Warn("Physics engine not enabled. Please enable the physics before you can use the methods.");return}}return n.prototype.applyRadialExplosionImpulse=function(t,e,i,r){if(!this._physicsEngine)return p.a.Warn("Physics engine not enabled. Please enable the physics before you call this method."),null;var o=this._physicsEngine.getImpostors();if(o.length===0)return null;typeof e=="number"&&(e=new Ln,e.radius=e,e.strength=i||e.strength,e.falloff=r||e.falloff);var a=new Eh(this._scene,e),s=Array();return o.forEach(function(c){var v=a.getImpostorHitData(c,t);!v||(c.applyImpulse(v.force,v.contactPoint),s.push({impostor:c,hitData:v}))}),a.triggerAffectedImpostorsCallback(s),a.dispose(!1),a},n.prototype.applyRadialExplosionForce=function(t,e,i,r){if(!this._physicsEngine)return p.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;var o=this._physicsEngine.getImpostors();if(o.length===0)return null;typeof e=="number"&&(e=new Ln,e.radius=e,e.strength=i||e.strength,e.falloff=r||e.falloff);var a=new Eh(this._scene,e),s=Array();return o.forEach(function(c){var v=a.getImpostorHitData(c,t);!v||(c.applyForce(v.force,v.contactPoint),s.push({impostor:c,hitData:v}))}),a.triggerAffectedImpostorsCallback(s),a.dispose(!1),a},n.prototype.gravitationalField=function(t,e,i,r){if(!this._physicsEngine)return p.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;var o=this._physicsEngine.getImpostors();if(o.length===0)return null;typeof e=="number"&&(e=new Ln,e.radius=e,e.strength=i||e.strength,e.falloff=r||e.falloff);var a=new wm(this,this._scene,t,e);return a.dispose(!1),a},n.prototype.updraft=function(t,e,i,r,o){if(!this._physicsEngine)return p.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(this._physicsEngine.getImpostors().length===0)return null;typeof e=="number"&&(e=new rl,e.radius=e,e.strength=i||e.strength,e.height=r||e.height,e.updraftMode=o||e.updraftMode);var a=new Vm(this._scene,t,e);return a.dispose(!1),a},n.prototype.vortex=function(t,e,i,r){if(!this._physicsEngine)return p.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(this._physicsEngine.getImpostors().length===0)return null;typeof e=="number"&&(e=new nl,e.radius=e,e.strength=i||e.strength,e.height=r||e.height);var o=new Um(this._scene,t,e);return o.dispose(!1),o},n}(),Eh=function(){function n(t,e){this._scene=t,this._options=e,this._dataFetched=!1,this._options=Object(h.a)(Object(h.a)({},new Ln),this._options)}return n.prototype.getData=function(){return this._dataFetched=!0,{sphere:this._sphere}},n.prototype.getImpostorHitData=function(t,e){if(t.mass===0||!this._intersectsWithSphere(t,e,this._options.radius)||t.object.getClassName()!=="Mesh"&&t.object.getClassName()!=="InstancedMesh")return null;var i=t.getObjectCenter(),r=i.subtract(e),o=new Zt.a(e,r,this._options.radius),a=o.intersectsMesh(t.object),s=a.pickedPoint;if(!s)return null;var c=l.e.Distance(e,s);if(c>this._options.radius)return null;var v=this._options.falloff===Do.Constant?this._options.strength:this._options.strength*(1-c/this._options.radius),b=r.multiplyByFloats(v,v,v);return{force:b,contactPoint:s,distanceFromOrigin:c}},n.prototype.triggerAffectedImpostorsCallback=function(t){this._options.affectedImpostorsCallback&&this._options.affectedImpostorsCallback(t)},n.prototype.dispose=function(t){var e=this;t===void 0&&(t=!0),t?this._sphere.dispose():setTimeout(function(){e._dataFetched||e._sphere.dispose()},0)},n.prototype._prepareSphere=function(){this._sphere||(this._sphere=nr.a.CreateSphere("radialExplosionEventSphere",this._options.sphere,this._scene),this._sphere.isVisible=!1)},n.prototype._intersectsWithSphere=function(t,e,i){var r=t.object;return this._prepareSphere(),this._sphere.position=e,this._sphere.scaling=new l.e(i*2,i*2,i*2),this._sphere._updateBoundingInfo(),this._sphere.computeWorldMatrix(!0),this._sphere.intersectsMesh(r,!0)},n}(),wm=function(){function n(t,e,i,r){this._physicsHelper=t,this._scene=e,this._origin=i,this._options=r,this._dataFetched=!1,this._options=Object(h.a)(Object(h.a)({},new Ln),this._options),this._tickCallback=this._tick.bind(this),this._options.strength=this._options.strength*-1}return n.prototype.getData=function(){return this._dataFetched=!0,{sphere:this._sphere}},n.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},n.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},n.prototype.dispose=function(t){var e=this;t===void 0&&(t=!0),t?this._sphere.dispose():setTimeout(function(){e._dataFetched||e._sphere.dispose()},0)},n.prototype._tick=function(){if(this._sphere)this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);else{var t=this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);t&&(this._sphere=t.getData().sphere.clone("radialExplosionEventSphereClone"))}},n}(),Vm=function(){function n(t,e,i){this._scene=t,this._origin=e,this._options=i,this._originTop=l.e.Zero(),this._originDirection=l.e.Zero(),this._cylinderPosition=l.e.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=Object(h.a)(Object(h.a)({},new rl),this._options),this._origin.addToRef(new l.e(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new l.e(0,this._options.height,0),this._originTop),this._options.updraftMode===Fn.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}return n.prototype.getData=function(){return this._dataFetched=!0,{cylinder:this._cylinder}},n.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},n.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},n.prototype.dispose=function(t){var e=this;t===void 0&&(t=!0),!!this._cylinder&&(t?this._cylinder.dispose():setTimeout(function(){e._dataFetched||e._cylinder.dispose()},0))},n.prototype.getImpostorHitData=function(t){if(t.mass===0||!this._intersectsWithCylinder(t))return null;var e=t.getObjectCenter();if(this._options.updraftMode===Fn.Perpendicular)var i=this._originDirection;else var i=e.subtract(this._originTop);var r=l.e.Distance(this._origin,e),o=this._options.strength*-1,a=i.multiplyByFloats(o,o,o);return{force:a,contactPoint:e,distanceFromOrigin:r}},n.prototype._tick=function(){var t=this;this._physicsEngine.getImpostors().forEach(function(e){var i=t.getImpostorHitData(e);!i||e.applyForce(i.force,i.contactPoint)})},n.prototype._prepareCylinder=function(){this._cylinder||(this._cylinder=Tr.a.CreateCylinder("updraftEventCylinder",{height:this._options.height,diameter:this._options.radius*2},this._scene),this._cylinder.isVisible=!1)},n.prototype._intersectsWithCylinder=function(t){var e=t.object;return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)},n}(),Um=function(){function n(t,e,i){this._scene=t,this._origin=e,this._options=i,this._originTop=l.e.Zero(),this._cylinderPosition=l.e.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=Object(h.a)(Object(h.a)({},new nl),this._options),this._origin.addToRef(new l.e(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new l.e(0,this._options.height,0),this._originTop),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}return n.prototype.getData=function(){return this._dataFetched=!0,{cylinder:this._cylinder}},n.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},n.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},n.prototype.dispose=function(t){var e=this;t===void 0&&(t=!0),t?this._cylinder.dispose():setTimeout(function(){e._dataFetched||e._cylinder.dispose()},0)},n.prototype.getImpostorHitData=function(t){if(t.mass===0||!this._intersectsWithCylinder(t)||t.object.getClassName()!=="Mesh"&&t.object.getClassName()!=="InstancedMesh")return null;var e=t.getObjectCenter(),i=new l.e(this._origin.x,e.y,this._origin.z),r=e.subtract(i),o=new Zt.a(i,r,this._options.radius),a=o.intersectsMesh(t.object),s=a.pickedPoint;if(!s)return null;var c=a.distance/this._options.radius,v=s.normalize();if(c>this._options.centripetalForceThreshold&&(v=v.negate()),c>this._options.centripetalForceThreshold)var b=v.x*this._options.centripetalForceMultiplier,C=v.y*this._options.updraftForceMultiplier,M=v.z*this._options.centripetalForceMultiplier;else var N=l.e.Cross(i,e).normalize(),b=(N.x+v.x)*this._options.centrifugalForceMultiplier,C=this._originTop.y*this._options.updraftForceMultiplier,M=(N.z+v.z)*this._options.centrifugalForceMultiplier;var D=new l.e(b,C,M);return D=D.multiplyByFloats(this._options.strength,this._options.strength,this._options.strength),{force:D,contactPoint:e,distanceFromOrigin:c}},n.prototype._tick=function(){var t=this;this._physicsEngine.getImpostors().forEach(function(e){var i=t.getImpostorHitData(e);!i||e.applyForce(i.force,i.contactPoint)})},n.prototype._prepareCylinder=function(){this._cylinder||(this._cylinder=Tr.a.CreateCylinder("vortexEventCylinder",{height:this._options.height,diameter:this._options.radius*2},this._scene),this._cylinder.isVisible=!1)},n.prototype._intersectsWithCylinder=function(t){var e=t.object;return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)},n}(),Ln=function(){function n(){this.radius=5,this.strength=10,this.falloff=Do.Constant,this.sphere={segments:32,diameter:1}}return n}(),rl=function(){function n(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=Fn.Center}return n}(),nl=function(){function n(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}return n}(),Do;(function(n){n[n.Constant=0]="Constant",n[n.Linear=1]="Linear"})(Do||(Do={}));var Fn;(function(n){n[n.Center=0]="Center",n[n.Perpendicular=1]="Perpendicular"})(Fn||(Fn={}));var Xr=u(503),Gm=u(632),zm=u(634),jm=u(633),Ph="blackAndWhitePixelShader",Ch=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float degree;
void main(void)
{
vec3 color=texture2D(textureSampler,vUV).rgb;
float luminance=dot(color,vec3(0.3,0.59,0.11));
vec3 blackAndWhite=vec3(luminance,luminance,luminance);
gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);
}`;qe.a.ShadersStore[Ph]=Ch;var vy={name:Ph,shader:Ch},Sh=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,"blackAndWhite",["degree"],null,i,r,o,a,s)||this;return c.degree=1,c.onApplyObservable.add(function(v){v.setFloat("degree",c.degree)}),c}return t.prototype.getClassName=function(){return"BlackAndWhitePostProcess"},t._Parse=function(e,i,r,o){return de.a.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},Object(h.c)([Object(de.c)()],t.prototype,"degree",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.BlackAndWhitePostProcess"]=Sh;var Wm=u(578),Hm=u(585),km=u(579),Xm=u(582),Th="colorCorrectionPixelShader",Rh=`
uniform sampler2D textureSampler;
uniform sampler2D colorTable;

varying vec2 vUV;

const float SLICE_COUNT=16.0;

vec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {
float sliceSize=1.0/width;
float slicePixelSize=sliceSize/width;
float sliceInnerSize=slicePixelSize*(width-1.0);
float zSlice0=min(floor(uv.z*width),width-1.0);
float zSlice1=min(zSlice0+1.0,width-1.0);
float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;
float s0=xOffset+(zSlice0*sliceSize);
float s1=xOffset+(zSlice1*sliceSize);
vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));
vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));
float zOffset=mod(uv.z*width,1.0);
vec4 result=mix(slice0Color,slice1Color,zOffset);
return result;
}
void main(void)
{
vec4 screen_color=texture2D(textureSampler,vUV);
gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);
}`;qe.a.ShadersStore[Th]=Rh;var _y={name:Th,shader:Rh},Ah=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){var v=n.call(this,e,"colorCorrection",null,["colorTable"],r,o,a,s,c)||this;return v._colorTableTexture=new Ze.a(i,o.getScene(),!0,!1,Ze.a.TRILINEAR_SAMPLINGMODE),v._colorTableTexture.anisotropicFilteringLevel=1,v._colorTableTexture.wrapU=Ze.a.CLAMP_ADDRESSMODE,v._colorTableTexture.wrapV=Ze.a.CLAMP_ADDRESSMODE,v.colorTableUrl=i,v.onApply=function(b){b.setTexture("colorTable",v._colorTableTexture)},v}return t.prototype.getClassName=function(){return"ColorCorrectionPostProcess"},t._Parse=function(e,i,r,o){return de.a.Parse(function(){return new t(e.name,e.colorTableUrl,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},Object(h.c)([Object(de.c)()],t.prototype,"colorTableUrl",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.ColorCorrectionPostProcess"]=Ah;var Oh="convolutionPixelShader",Mh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform float kernel[9];
void main(void)
{
vec2 onePixel=vec2(1.0,1.0)/screenSize;
vec4 colorSum =
texture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +
texture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +
texture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +
texture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +
texture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +
texture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +
texture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];
float kernelWeight =
kernel[0] +
kernel[1] +
kernel[2] +
kernel[3] +
kernel[4] +
kernel[5] +
kernel[6] +
kernel[7] +
kernel[8];
if (kernelWeight<=0.0) {
kernelWeight=1.0;
}
gl_FragColor=vec4((colorSum/kernelWeight).rgb,1);
}`;qe.a.ShadersStore[Oh]=Mh;var yy={name:Oh,shader:Mh},xh=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v){v===void 0&&(v=0);var b=n.call(this,e,"convolution",["kernel","screenSize"],null,r,o,a,s,c,null,v)||this;return b.kernel=i,b.onApply=function(C){C.setFloat2("screenSize",b.width,b.height),C.setArray("kernel",b.kernel)},b}return t.prototype.getClassName=function(){return"ConvolutionPostProcess"},t._Parse=function(e,i,r,o){return de.a.Parse(function(){return new t(e.name,e.kernel,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable,e.textureType)},e,r,o)},t.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],t.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],t.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],t.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],t.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],t.GaussianKernel=[0,1,0,1,1,1,0,1,0],Object(h.c)([Object(de.c)()],t.prototype,"kernel",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.ConvolutionPostProcess"]=xh;var Ym=u(580),Dh=u(570),Ih=u(583),Lh="displayPassPixelShader",Fh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D passSampler;
void main(void)
{
gl_FragColor=texture2D(passSampler,vUV);
}`;qe.a.ShadersStore[Lh]=Fh;var by={name:Lh,shader:Fh},Bh=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){return n.call(this,e,"displayPass",["passSampler"],["passSampler"],i,r,o,a,s)||this}return t.prototype.getClassName=function(){return"DisplayPassPostProcess"},t._Parse=function(e,i,r,o){return de.a.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},t}(ii.a);f.a.RegisteredTypes["BABYLON.DisplayPassPostProcess"]=Bh;var Km=u(584),Nh="filterPixelShader",wh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform mat4 kernelMatrix;
void main(void)
{
vec3 baseColor=texture2D(textureSampler,vUV).rgb;
vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;
gl_FragColor=vec4(updatedColor,1.0);
}`;qe.a.ShadersStore[Nh]=wh;var Ey={name:Nh,shader:wh},Vh=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){var v=n.call(this,e,"filter",["kernelMatrix"],null,r,o,a,s,c)||this;return v.kernelMatrix=i,v.onApply=function(b){b.setMatrix("kernelMatrix",v.kernelMatrix)},v}return t.prototype.getClassName=function(){return"FilterPostProcess"},t._Parse=function(e,i,r,o){return de.a.Parse(function(){return new t(e.name,e.kernelMatrix,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},Object(h.c)([Object(de.j)()],t.prototype,"kernelMatrix",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.FilterPostProcess"]=Vh;var Uh=u(517),Qm=u(586),Gh="highlightsPixelShader",zh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);
void main(void)
{
vec4 tex=texture2D(textureSampler,vUV);
vec3 c=tex.rgb;
float luma=dot(c.rgb,RGBLuminanceCoefficients);


gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a);
}`;qe.a.ShadersStore[Gh]=zh;var Py={name:Gh,shader:zh},Zm=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){return c===void 0&&(c=0),n.call(this,e,"highlights",null,null,i,r,o,a,s,null,c)||this}return t.prototype.getClassName=function(){return"HighlightsPostProcess"},t}(ii.a),Jm=u(571),$m=u(590),jh="refractionPixelShader",Wh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D refractionSampler;

uniform vec3 baseColor;
uniform float depth;
uniform float colorLevel;
void main() {
float ref=1.0-texture2D(refractionSampler,vUV).r;
vec2 uv=vUV-vec2(0.5);
vec2 offset=uv*depth*ref;
vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;
gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);
}`;qe.a.ShadersStore[jh]=Wh;var Cy={name:jh,shader:Wh},Hh=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v,b,C){var M=n.call(this,e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],s,c,v,b,C)||this;return M._ownRefractionTexture=!0,M.color=r,M.depth=o,M.colorLevel=a,M.refractionTextureUrl=i,M.onActivateObservable.add(function(N){M._refTexture=M._refTexture||new Ze.a(i,N.getScene())}),M.onApplyObservable.add(function(N){N.setColor3("baseColor",M.color),N.setFloat("depth",M.depth),N.setFloat("colorLevel",M.colorLevel),N.setTexture("refractionSampler",M._refTexture)}),M}return Object.defineProperty(t.prototype,"refractionTexture",{get:function(){return this._refTexture},set:function(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"RefractionPostProcess"},t.prototype.dispose=function(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),n.prototype.dispose.call(this,e)},t._Parse=function(e,i,r,o){return de.a.Parse(function(){return new t(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},Object(h.c)([Object(de.c)()],t.prototype,"color",void 0),Object(h.c)([Object(de.c)()],t.prototype,"depth",void 0),Object(h.c)([Object(de.c)()],t.prototype,"colorLevel",void 0),Object(h.c)([Object(de.c)()],t.prototype,"refractionTextureUrl",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.RefractionPostProcess"]=Hh;var Yr=u(602),qm=u(587),kh="tonemapPixelShader",Xh=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform float _ExposureAdjustment;
#if defined(HABLE_TONEMAPPING)
const float A=0.15;
const float B=0.50;
const float C=0.10;
const float D=0.20;
const float E=0.02;
const float F=0.30;
const float W=11.2;
#endif
float Luminance(vec3 c)
{
return dot(c,vec3(0.22,0.707,0.071));
}
void main(void)
{
vec3 colour=texture2D(textureSampler,vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
float lum=Luminance(colour.rgb);
float lumTm=lum*_ExposureAdjustment;
float scale=lumTm/(1.0+lumTm);
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=_ExposureAdjustment;
const float ExposureBias=2.0;
vec3 x=ExposureBias*colour;
vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
x=vec3(W,W,W);
vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);
colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=_ExposureAdjustment;
vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);
vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);
colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour=vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);
#endif
gl_FragColor=vec4(colour.rgb,1.0);
}`;qe.a.ShadersStore[kh]=Xh;var Sy={name:kh,shader:Xh},vn;(function(n){n[n.Hable=0]="Hable",n[n.Reinhard=1]="Reinhard",n[n.HejiDawson=2]="HejiDawson",n[n.Photographic=3]="Photographic"})(vn||(vn={}));var ev=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){a===void 0&&(a=2),c===void 0&&(c=0);var v=n.call(this,e,"tonemap",["_ExposureAdjustment"],null,1,o,a,s,!0,null,c)||this;v._operator=i,v.exposureAdjustment=r;var b="#define ";return v._operator===vn.Hable?b+="HABLE_TONEMAPPING":v._operator===vn.Reinhard?b+="REINHARD_TONEMAPPING":v._operator===vn.HejiDawson?b+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":v._operator===vn.Photographic&&(b+="PHOTOGRAPHIC_TONEMAPPING"),v.updateEffect(b),v.onApply=function(C){C.setFloat("_ExposureAdjustment",v.exposureAdjustment)},v}return t.prototype.getClassName=function(){return"TonemapPostProcess"},t}(ii.a),Ty=u(664),Yh="volumetricLightScatteringPixelShader",Kh=`uniform sampler2D textureSampler;
uniform sampler2D lightScatteringSampler;
uniform float decay;
uniform float exposure;
uniform float weight;
uniform float density;
uniform vec2 meshPositionOnScreen;
varying vec2 vUV;
void main(void) {
vec2 tc=vUV;
vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);
deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;
float illuminationDecay=1.0;
vec4 color=texture2D(lightScatteringSampler,tc)*0.4;
for(int i=0; i<NUM_SAMPLES; i++) {
tc-=deltaTexCoord;
vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;
dataSample*=illuminationDecay*weight;
color+=dataSample;
illuminationDecay*=decay;
}
vec4 realColor=texture2D(textureSampler,vUV);
gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));
}
`;qe.a.ShadersStore[Yh]=Kh;var Ry={name:Yh,shader:Kh},Ay=u(507),Oy=u(508),Qh="volumetricLightScatteringPassVertexShader",Zh=`
attribute vec3 position;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
void main(void)
{
vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;qe.a.ShadersStore[Qh]=Zh;var My={name:Qh,shader:Zh},Jh="volumetricLightScatteringPassPixelShader",$h=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);
if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);
}
`;qe.a.ShadersStore[Jh]=$h;var xy={name:Jh,shader:$h},qh=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v,b){a===void 0&&(a=100),s===void 0&&(s=Ze.a.BILINEAR_SAMPLINGMODE);var C=n.call(this,e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],i.postProcessRatio||i,r,s,c,v,"#define NUM_SAMPLES "+a)||this;return C._screenCoordinates=l.d.Zero(),C.customMeshPosition=l.e.Zero(),C.useCustomMeshPosition=!1,C.invert=!0,C.excludedMeshes=new Array,C.exposure=.3,C.decay=.96815,C.weight=.58767,C.density=.926,b=r===null?b:r.getScene(),c=b.getEngine(),C._viewPort=new lr.a(0,0,1,1).toGlobal(c.getRenderWidth(),c.getRenderHeight()),C.mesh=o!==null?o:t.CreateDefaultMesh("VolumetricLightScatteringMesh",b),C._createPass(b,i.passRatio||i),C.onActivate=function(M){C.isSupported||C.dispose(M),C.onActivate=null},C.onApplyObservable.add(function(M){C._updateMeshScreenCoordinates(b),M.setTexture("lightScatteringSampler",C._volumetricLightScatteringRTT),M.setFloat("exposure",C.exposure),M.setFloat("decay",C.decay),M.setFloat("weight",C.weight),M.setFloat("density",C.density),M.setVector2("meshPositionOnScreen",C._screenCoordinates)}),C}return Object.defineProperty(t.prototype,"useDiffuseColor",{get:function(){return p.a.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1},set:function(e){p.a.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"VolumetricLightScatteringPostProcess"},t.prototype._isReady=function(e,i){var r=e.getMesh();if(r===this.mesh&&r.material)return r.material.isReady(r);var o=[],a=[Oe.b.PositionKind],s=e.getMaterial();s&&(s.needAlphaTesting()&&o.push("#define ALPHATEST"),r.isVerticesDataPresent(Oe.b.UVKind)&&(a.push(Oe.b.UVKind),o.push("#define UV1")),r.isVerticesDataPresent(Oe.b.UV2Kind)&&(a.push(Oe.b.UV2Kind),o.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders?(a.push(Oe.b.MatricesIndicesKind),a.push(Oe.b.MatricesWeightsKind),o.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),o.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0))):o.push("#define NUM_BONE_INFLUENCERS 0"),i&&(o.push("#define INSTANCES"),Ot.a.PushAttributesForInstances(a),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));var c=o.join(`
`);return this._cachedDefines!==c&&(this._cachedDefines=c,this._volumetricLightScatteringPass=r.getScene().getEngine().createEffect("volumetricLightScatteringPass",a,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],c,void 0,void 0,void 0,{maxSimultaneousMorphTargets:r.numBoneInfluencers})),this._volumetricLightScatteringPass.isReady()},t.prototype.setCustomMeshPosition=function(e){this.customMeshPosition=e},t.prototype.getCustomMeshPosition=function(){return this.customMeshPosition},t.prototype.dispose=function(e){var i=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);i!==-1&&e.getScene().customRenderTargets.splice(i,1),this._volumetricLightScatteringRTT.dispose(),n.prototype.dispose.call(this,e)},t.prototype.getPass=function(){return this._volumetricLightScatteringRTT},t.prototype._meshExcluded=function(e){return this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1},t.prototype._createPass=function(e,i){var r=this,o=e.getEngine();this._volumetricLightScatteringRTT=new Cr.a("volumetricLightScatteringMap",{width:o.getRenderWidth()*i,height:o.getRenderHeight()*i},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=Ze.a.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;var a=this.getCamera();a?a.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);var s=function(b){var C=b.getRenderingMesh(),M=b.getEffectiveMesh();if(!r._meshExcluded(C)){M._internalAbstractMeshDataInfo._isActiveIntermediate=!1;var N=b.getMaterial();if(!!N){var D=C.getScene(),V=D.getEngine();V.setState(N.backFaceCulling);var X=C._getInstancesRenderList(b._id,!!b.getReplacementMesh());if(!X.mustReturn){var ee=V.getCaps().instancedArrays&&(X.visibleInstances[b._id]!==null||C.hasThinInstances);if(r._isReady(b,ee)){var ie=r._volumetricLightScatteringPass;if(C===r.mesh&&(b.effect?ie=b.effect:ie=N.getEffect()),V.enableEffect(ie),C._bind(b,ie,N.fillMode),C===r.mesh)N.bind(M.getWorldMatrix(),C);else{if(r._volumetricLightScatteringPass.setMatrix("viewProjection",D.getTransformMatrix()),N&&N.needAlphaTesting()){var ge=N.getAlphaTestTexture();r._volumetricLightScatteringPass.setTexture("diffuseSampler",ge),ge&&r._volumetricLightScatteringPass.setMatrix("diffuseMatrix",ge.getTextureMatrix())}C.useBones&&C.computeBonesUsingShaders&&C.skeleton&&r._volumetricLightScatteringPass.setMatrices("mBones",C.skeleton.getTransformMatrices(C))}C._processRendering(M,b,r._volumetricLightScatteringPass,Yi.a.TriangleFillMode,X,ee,function(pe,te){return ie.setMatrix("world",te)})}}}}},c,v=new m.b(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){c=e.clearColor,e.clearColor=v}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){e.clearColor=c}),this._volumetricLightScatteringRTT.customRenderFunction=function(b,C,M,N){var D=e.getEngine(),V;if(N.length){for(D.setColorWrite(!1),V=0;V<N.length;V++)s(N.data[V]);D.setColorWrite(!0)}for(V=0;V<b.length;V++)s(b.data[V]);for(V=0;V<C.length;V++)s(C.data[V]);if(M.length){for(V=0;V<M.length;V++){var X=M.data[V],ee=X.getBoundingInfo();ee&&e.activeCamera&&(X._alphaIndex=X.getMesh().alphaIndex,X._distanceToCamera=ee.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}var ie=M.data.slice(0,M.length);for(ie.sort(function(ge,pe){return ge._alphaIndex>pe._alphaIndex?1:ge._alphaIndex<pe._alphaIndex?-1:ge._distanceToCamera<pe._distanceToCamera?1:ge._distanceToCamera>pe._distanceToCamera?-1:0}),D.setAlphaMode(2),V=0;V<ie.length;V++)s(ie[V]);D.setAlphaMode(0)}}},t.prototype._updateMeshScreenCoordinates=function(e){var i=e.getTransformMatrix(),r;this.useCustomMeshPosition?r=this.customMeshPosition:this.attachedNode?r=this.attachedNode.position:r=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;var o=l.e.Project(r,l.a.Identity(),i,this._viewPort);this._screenCoordinates.x=o.x/this._viewPort.width,this._screenCoordinates.y=o.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)},t.CreateDefaultMesh=function(e,i){var r=ot.a.CreatePlane(e,1,i);r.billboardMode=Ue.a.BILLBOARDMODE_ALL;var o=new Gt.a(e+"Material",i);return o.emissiveColor=new m.a(1,1,1),r.material=o,r},Object(h.c)([Object(de.o)()],t.prototype,"customMeshPosition",void 0),Object(h.c)([Object(de.c)()],t.prototype,"useCustomMeshPosition",void 0),Object(h.c)([Object(de.c)()],t.prototype,"invert",void 0),Object(h.c)([Object(de.k)()],t.prototype,"mesh",void 0),Object(h.c)([Object(de.c)()],t.prototype,"excludedMeshes",void 0),Object(h.c)([Object(de.c)()],t.prototype,"exposure",void 0),Object(h.c)([Object(de.c)()],t.prototype,"decay",void 0),Object(h.c)([Object(de.c)()],t.prototype,"weight",void 0),Object(h.c)([Object(de.c)()],t.prototype,"density",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.VolumetricLightScatteringPostProcess"]=qh;var tv=u(581),iv=u(547),ed="screenSpaceCurvaturePixelShader",td=`

precision highp float;

varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D normalSampler;
uniform float curvature_ridge;
uniform float curvature_valley;
#ifndef CURVATURE_OFFSET
#define CURVATURE_OFFSET 1
#endif
float curvature_soft_clamp(float curvature,float control)
{
if (curvature<0.5/control)
return curvature*(1.0-curvature*control);
return 0.25/control;
}
float calculate_curvature(ivec2 texel,float ridge,float valley)
{
vec2 normal_up=texelFetchOffset(normalSampler,texel,0,ivec2(0,CURVATURE_OFFSET)).rb;
vec2 normal_down=texelFetchOffset(normalSampler,texel,0,ivec2(0,-CURVATURE_OFFSET)).rb;
vec2 normal_left=texelFetchOffset(normalSampler,texel,0,ivec2(-CURVATURE_OFFSET,0)).rb;
vec2 normal_right=texelFetchOffset(normalSampler,texel,0,ivec2( CURVATURE_OFFSET,0)).rb;
float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));
if (normal_diff<0.0)
return -2.0*curvature_soft_clamp(-normal_diff,valley);
return 2.0*curvature_soft_clamp(normal_diff,ridge);
}
void main(void)
{
ivec2 texel=ivec2(gl_FragCoord.xy);
vec4 baseColor=texture2D(textureSampler,vUV);
float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);
baseColor.rgb*=curvature+1.0;
gl_FragColor=baseColor;
}`;qe.a.ShadersStore[ed]=td;var Dy={name:ed,shader:td},id=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v,b){v===void 0&&(v=0),b===void 0&&(b=!1);var C=n.call(this,e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],r,o,a,s,c,void 0,v,void 0,null,b)||this;return C.ridge=1,C.valley=1,C._geometryBufferRenderer=i.enableGeometryBufferRenderer(),C._geometryBufferRenderer?C.onApply=function(M){M.setFloat("curvature_ridge",.5/Math.max(C.ridge*C.ridge,1e-4)),M.setFloat("curvature_valley",.7/Math.max(C.valley*C.valley,1e-4));var N=C._geometryBufferRenderer.getGBuffer().textures[1];M.setTexture("normalSampler",N)}:p.a.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first."),C}return t.prototype.getClassName=function(){return"ScreenSpaceCurvaturePostProcess"},Object.defineProperty(t,"IsSupported",{get:function(){var e=Yt.a.LastCreatedEngine;return e?e.getCaps().drawBuffersExtension:!1},enumerable:!1,configurable:!0}),t._Parse=function(e,i,r,o){return de.a.Parse(function(){return new t(e.name,r,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.textureType,e.reusable)},e,r,o)},Object(h.c)([Object(de.c)()],t.prototype,"ridge",void 0),Object(h.c)([Object(de.c)()],t.prototype,"valley",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.ScreenSpaceCurvaturePostProcess"]=id;var rv=u(635);Object.defineProperty(q.a.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(n){this._forceShowBoundingBoxes=n,n&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),q.a.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new rd(this)),this._boundingBoxRenderer},Object.defineProperty(Ue.a.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(n){this._showBoundingBox=n,n&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});var rd=function(){function n(t){this.name=H.a.NAME_BOUNDINGBOXRENDERER,this.frontColor=new m.a(1,1,1),this.backColor=new m.a(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new _.c,this.onAfterBoxRenderingObservable=new _.c,this.onResourcesReadyObservable=new _.c,this.enabled=!0,this.renderList=new Pt.a(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=t,t._addComponent(this)}return n.prototype.register=function(){this.scene._beforeEvaluateActiveMeshStage.registerStep(H.a.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(H.a.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(H.a.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(H.a.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)},n.prototype._evaluateSubMesh=function(t,e){if(t.showSubMeshesBoundingBox){var i=e.getBoundingInfo();i!=null&&(i.boundingBox._tag=t.renderingGroupId,this.renderList.push(i.boundingBox))}},n.prototype._preActiveMesh=function(t){if(t.showBoundingBox||this.scene.forceShowBoundingBoxes){var e=t.getBoundingInfo();e.boundingBox._tag=t.renderingGroupId,this.renderList.push(e.boundingBox)}},n.prototype._prepareResources=function(){if(!this._colorShader){this._colorShader=new Tn.a("colorShader",this.scene,"color",{attributes:[Oe.b.PositionKind],uniforms:["world","viewProjection","color"]}),this._colorShader.reservedDataStore={hidden:!0};var t=this.scene.getEngine(),e=an.a.CreateBox({size:1});this._vertexBuffers[Oe.b.PositionKind]=new Oe.b(t,e.positions,Oe.b.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=e.indices,this.onResourcesReadyObservable.notifyObservers(this)}},n.prototype._createIndexBuffer=function(){var t=this.scene.getEngine();this._indexBuffer=t.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])},n.prototype.rebuild=function(){var t=this._vertexBuffers[Oe.b.PositionKind];t&&t._rebuild(),this._createIndexBuffer()},n.prototype.reset=function(){this.renderList.reset()},n.prototype.render=function(t){if(!(this.renderList.length===0||!this.enabled)&&(this._prepareResources(),!!this._colorShader.isReady())){var e=this.scene.getEngine();e.setDepthWrite(!1),this._colorShader._preBind();for(var i=0;i<this.renderList.length;i++){var r=this.renderList.data[i];if(r._tag===t){this.onBeforeBoxRenderingObservable.notifyObservers(r);var o=r.minimum,a=r.maximum,s=a.subtract(o),c=o.add(s.scale(.5)),v=l.a.Scaling(s.x,s.y,s.z).multiply(l.a.Translation(c.x,c.y,c.z)).multiply(r.getWorldMatrix());e.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),this.showBackLines&&(e.setDepthFunctionToGreaterOrEqual(),this.scene.resetCachedMaterial(),this._colorShader.setColor4("color",this.backColor.toColor4()),this._colorShader.bind(v),e.drawElementsType(Yi.a.LineListDrawMode,0,24)),e.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._colorShader.setColor4("color",this.frontColor.toColor4()),this._colorShader.bind(v),e.drawElementsType(Yi.a.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(r)}}this._colorShader.unbind(),e.setDepthFunctionToLessOrEqual(),e.setDepthWrite(!0)}},n.prototype.renderOcclusionBoundingBox=function(t){if(this._prepareResources(),!(!this._colorShader.isReady()||!t._boundingInfo)){var e=this.scene.getEngine();this._fillIndexBuffer||(this._fillIndexBuffer=e.createIndexBuffer(this._fillIndexData)),e.setDepthWrite(!1),e.setColorWrite(!1),this._colorShader._preBind();var i=t._boundingInfo.boundingBox,r=i.minimum,o=i.maximum,a=o.subtract(r),s=r.add(a.scale(.5)),c=l.a.Scaling(a.x,a.y,a.z).multiply(l.a.Translation(s.x,s.y,s.z)).multiply(i.getWorldMatrix());e.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,this._colorShader.getEffect()),e.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._colorShader.bind(c),e.drawElementsType(Yi.a.TriangleFillMode,0,36),this._colorShader.unbind(),e.setDepthFunctionToLessOrEqual(),e.setDepthWrite(!0),e.setColorWrite(!0)}},n.prototype.dispose=function(){if(!!this._colorShader){this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose();var t=this._vertexBuffers[Oe.b.PositionKind];t&&(t.dispose(),this._vertexBuffers[Oe.b.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}},n}(),nv=u(556),ov=u(666),nd="linePixelShader",od=`uniform vec4 color;
void main(void) {
gl_FragColor=color;
}`;qe.a.ShadersStore[nd]=od;var Iy={name:nd,shader:od},ad="lineVertexShader",sd=`#include<instancesDeclaration>

attribute vec3 position;
attribute vec4 normal;

uniform mat4 viewProjection;
uniform float width;
uniform float aspectRatio;
void main(void) {
#include<instancesVertex>
mat4 worldViewProjection=viewProjection*finalWorld;
vec4 viewPosition=worldViewProjection*vec4(position,1.0);
vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);
vec2 currentScreen=viewPosition.xy/viewPosition.w;
vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;
currentScreen.x*=aspectRatio;
nextScreen.x*=aspectRatio;
vec2 dir=normalize(nextScreen-currentScreen);
vec2 normalDir=vec2(-dir.y,dir.x);
normalDir*=width/2.0;
normalDir.x/=aspectRatio;
vec4 offset=vec4(normalDir*normal.w,0.0,0.0);
gl_Position=viewPosition+offset;
}`;qe.a.ShadersStore[ad]=sd;var Ly={name:ad,shader:sd};Ue.a.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},Ue.a.prototype.enableEdgesRendering=function(n,t,e){return n===void 0&&(n=.95),t===void 0&&(t=!1),this.disableEdgesRendering(),this._edgesRenderer=new ol(this,n,t,!0,e),this},Object.defineProperty(Ue.a.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),Oo.b.prototype.enableEdgesRendering=function(n,t){return n===void 0&&(n=.95),t===void 0&&(t=!1),this.disableEdgesRendering(),this._edgesRenderer=new ld(this,n,t),this},Oo.a.prototype.enableEdgesRendering=function(n,t){return n===void 0&&(n=.95),t===void 0&&(t=!1),Oo.b.prototype.enableEdgesRendering.apply(this,arguments),this};var av=function(){function n(){this.edges=new Array,this.edgesConnectedCount=0}return n}(),ol=function(){function n(t,e,i,r,o){var a=this;e===void 0&&(e=.95),i===void 0&&(i=!1),r===void 0&&(r=!0);var s;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new Pt.a(32),this._source=t,this._checkVerticesInsteadOfIndices=i,this._options=o!=null?o:null,this._epsilon=e,this._prepareRessources(),r&&(((s=o==null?void 0:o.useAlternateEdgeFinder)!==null&&s!==void 0?s:!0)?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(function(){a._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(function(){a.dispose()})}return Object.defineProperty(n.prototype,"linesPositions",{get:function(){return this._linesPositions},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"linesNormals",{get:function(){return this._linesNormals},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"linesIndices",{get:function(){return this._linesIndices},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"lineShader",{get:function(){return this._lineShader},set:function(t){this._lineShader=t},enumerable:!1,configurable:!0}),n.GetShader=function(t){if(!t._edgeRenderLineShader){var e=new Tn.a("lineShader",t,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]});e.disableDepthWrite=!0,e.backFaceCulling=!1,t._edgeRenderLineShader=e}return t._edgeRenderLineShader},n.prototype._prepareRessources=function(){this._lineShader||(this._lineShader=n.GetShader(this._source.getScene()))},n.prototype._rebuild=function(){var t=this._buffers[Oe.b.PositionKind];t&&t._rebuild(),t=this._buffers[Oe.b.NormalKind],t&&t._rebuild();var e=this._source.getScene(),i=e.getEngine();this._ib=i.createIndexBuffer(this._linesIndices)},n.prototype.dispose=function(){this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);var t=this._buffers[Oe.b.PositionKind];t&&(t.dispose(),this._buffers[Oe.b.PositionKind]=null),t=this._buffers[Oe.b.NormalKind],t&&(t.dispose(),this._buffers[Oe.b.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose()},n.prototype._processEdgeForAdjacencies=function(t,e,i,r,o){return t===i&&e===r||t===r&&e===i?0:t===r&&e===o||t===o&&e===r?1:t===o&&e===i||t===i&&e===o?2:-1},n.prototype._processEdgeForAdjacenciesWithVertices=function(t,e,i,r,o){var a=1e-10;return t.equalsWithEpsilon(i,a)&&e.equalsWithEpsilon(r,a)||t.equalsWithEpsilon(r,a)&&e.equalsWithEpsilon(i,a)?0:t.equalsWithEpsilon(r,a)&&e.equalsWithEpsilon(o,a)||t.equalsWithEpsilon(o,a)&&e.equalsWithEpsilon(r,a)?1:t.equalsWithEpsilon(o,a)&&e.equalsWithEpsilon(i,a)||t.equalsWithEpsilon(i,a)&&e.equalsWithEpsilon(o,a)?2:-1},n.prototype._checkEdge=function(t,e,i,r,o){var a;if(e===void 0)a=!0;else{var s=l.e.Dot(i[t],i[e]);a=s<this._epsilon}a&&this.createLine(r,o,this._linesPositions.length/3)},n.prototype.createLine=function(t,e,i){this._linesPositions.push(t.x,t.y,t.z,t.x,t.y,t.z,e.x,e.y,e.z,e.x,e.y,e.z),this._linesNormals.push(e.x,e.y,e.z,-1,e.x,e.y,e.z,1,t.x,t.y,t.z,-1,t.x,t.y,t.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)},n.prototype._tessellateTriangle=function(t,e,i,r){var o=function(Pe,Ne,je){je>=0&&Ne.push(je);for(var Be=0;Be<Pe.length;++Be)Ne.push(Pe[Be][0])},a=0;t[1].length>=t[0].length&&t[1].length>=t[2].length?a=1:t[2].length>=t[0].length&&t[2].length>=t[1].length&&(a=2);for(var s=0;s<3;++s)s===a?t[s].sort(function(Pe,Ne){return Pe[1]<Ne[1]?-1:Pe[1]>Ne[1]?1:0}):t[s].sort(function(Pe,Ne){return Pe[1]>Ne[1]?-1:Pe[1]<Ne[1]?1:0});var c=[],v=[];o(t[a],c,-1);for(var b=c.length,C=a+2;C>=a+1;--C)o(t[C%3],v,C!==a+2?r[i[e+(C+1)%3]]:-1);var M=v.length,N=0,D=0;i.push(r[i[e+a]],c[0],v[0]),i.push(r[i[e+(a+1)%3]],v[M-1],c[b-1]);for(var V=b<=M,X=V?b:M,ee=V?M:b,ie=V?b-1:M-1,ge=V?0:1,pe=b+M-2,te=V?N:D,Ce=V?D:N,Ae=V?c:v,De=V?v:c,Fe=0;pe-- >0;){ge?i.push(Ae[te],De[Ce]):i.push(De[Ce],Ae[te]),Fe+=X;var We=void 0;Fe>=ee&&te<ie?(We=Ae[++te],Fe-=ee):We=De[++Ce],i.push(We)}i[e+0]=i[i.length-3],i[e+1]=i[i.length-2],i[e+2]=i[i.length-1],i.length=i.length-3},n.prototype._generateEdgesLinesAlternate=function(){var t,e,i,r,o,a,s,c,v,b=this._source.getVerticesData(Oe.b.PositionKind),C=this._source.getIndices();if(!(!C||!b)){Array.isArray(C)||(C=J.b.SliceToArray(C));var M=(e=(t=this._options)===null||t===void 0?void 0:t.useFastVertexMerger)!==null&&e!==void 0?e:!0,N=M?Math.round(-Math.log((r=(i=this._options)===null||i===void 0?void 0:i.epsilonVertexMerge)!==null&&r!==void 0?r:1e-6)/Math.log(10)):(a=(o=this._options)===null||o===void 0?void 0:o.epsilonVertexMerge)!==null&&a!==void 0?a:1e-6,D=[],V=[];if(M)for(var X={},ee=0;ee<b.length;ee+=3){var ie=b[ee+0],ge=b[ee+1],pe=b[ee+2],te=ie.toFixed(N)+"|"+ge.toFixed(N)+"|"+pe.toFixed(N);if(X[te]!==void 0)D.push(X[te]);else{var Ce=ee/3;X[te]=Ce,D.push(Ce),V.push(Ce)}}else for(var ee=0;ee<b.length;ee+=3){for(var ie=b[ee+0],ge=b[ee+1],pe=b[ee+2],Ae=!1,De=0;De<ee&&!Ae;De+=3){var Fe=b[De+0],We=b[De+1],Pe=b[De+2];if(Math.abs(ie-Fe)<N&&Math.abs(ge-We)<N&&Math.abs(pe-Pe)<N){D.push(De/3),Ae=!0;break}}Ae||(D.push(ee/3),V.push(ee/3))}if((s=this._options)===null||s===void 0?void 0:s.applyTessellation){for(var Ne=(v=(c=this._options)===null||c===void 0?void 0:c.epsilonVertexAligned)!==null&&v!==void 0?v:1e-6,je=[],Be=0;Be<C.length;Be+=3)for(var Je=void 0,tt=0;tt<3;++tt){var Xe=D[C[Be+tt]],Ct=D[C[Be+(tt+1)%3]],At=D[C[Be+(tt+2)%3]];if(Xe!==Ct)for(var Rt=b[Xe*3+0],rt=b[Xe*3+1],Bt=b[Xe*3+2],jt=b[Ct*3+0],at=b[Ct*3+1],Lt=b[Ct*3+2],Qe=Math.sqrt((jt-Rt)*(jt-Rt)+(at-rt)*(at-rt)+(Lt-Bt)*(Lt-Bt)),lt=0;lt<V.length-1;lt++){var wt=V[lt];if(!(wt===Xe||wt===Ct||wt===At)){var fi=b[wt*3+0],si=b[wt*3+1],xi=b[wt*3+2],bi=Math.sqrt((fi-Rt)*(fi-Rt)+(si-rt)*(si-rt)+(xi-Bt)*(xi-Bt)),St=Math.sqrt((fi-jt)*(fi-jt)+(si-at)*(si-at)+(xi-Lt)*(xi-Lt));Math.abs(bi+St-Qe)<Ne&&(Je||(Je={index:Be,edgesPoints:[[],[],[]]},je.push(Je)),Je.edgesPoints[tt].push([wt,bi]))}}}for(var $t=0;$t<je.length;++$t){var vi=je[$t];this._tessellateTriangle(vi.edgesPoints,vi.index,C,D)}je=null}for(var hi={},Be=0;Be<C.length;Be+=3)for(var di=void 0,tt=0;tt<3;++tt){var Xe=D[C[Be+tt]],Ct=D[C[Be+(tt+1)%3]],At=D[C[Be+(tt+2)%3]];if(Xe!==Ct){if(l.c.Vector3[0].copyFromFloats(b[Xe*3+0],b[Xe*3+1],b[Xe*3+2]),l.c.Vector3[1].copyFromFloats(b[Ct*3+0],b[Ct*3+1],b[Ct*3+2]),l.c.Vector3[2].copyFromFloats(b[At*3+0],b[At*3+1],b[At*3+2]),di||(l.c.Vector3[1].subtractToRef(l.c.Vector3[0],l.c.Vector3[3]),l.c.Vector3[2].subtractToRef(l.c.Vector3[1],l.c.Vector3[4]),di=l.e.Cross(l.c.Vector3[3],l.c.Vector3[4]),di.normalize()),Xe>Ct){var ct=Xe;Xe=Ct,Ct=ct}var te=Xe+"_"+Ct,oi=hi[te];if(oi){if(!oi.done){var sn=l.e.Dot(di,oi.normal);sn<this._epsilon&&this.createLine(l.c.Vector3[0],l.c.Vector3[1],this._linesPositions.length/3),oi.done=!0}}else hi[te]={normal:di,done:!1,index:Be,i:tt}}}for(var te in hi){var oi=hi[te];if(!oi.done){var Xe=D[C[oi.index+oi.i]],Ct=D[C[oi.index+(oi.i+1)%3]];l.c.Vector3[0].copyFromFloats(b[Xe*3+0],b[Xe*3+1],b[Xe*3+2]),l.c.Vector3[1].copyFromFloats(b[Ct*3+0],b[Ct*3+1],b[Ct*3+2]),this.createLine(l.c.Vector3[0],l.c.Vector3[1],this._linesPositions.length/3)}}var Kr=this._source.getScene().getEngine();this._buffers[Oe.b.PositionKind]=new Oe.b(Kr,this._linesPositions,Oe.b.PositionKind,!1),this._buffers[Oe.b.NormalKind]=new Oe.b(Kr,this._linesNormals,Oe.b.NormalKind,!1,!1,4),this._buffersForInstances[Oe.b.PositionKind]=this._buffers[Oe.b.PositionKind],this._buffersForInstances[Oe.b.NormalKind]=this._buffers[Oe.b.NormalKind],this._ib=Kr.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},n.prototype._generateEdgesLines=function(){var t=this._source.getVerticesData(Oe.b.PositionKind),e=this._source.getIndices();if(!(!e||!t)){var i=new Array,r=new Array,o,a;for(o=0;o<e.length;o+=3){a=new av;var s=e[o],c=e[o+1],v=e[o+2];a.p0=new l.e(t[s*3],t[s*3+1],t[s*3+2]),a.p1=new l.e(t[c*3],t[c*3+1],t[c*3+2]),a.p2=new l.e(t[v*3],t[v*3+1],t[v*3+2]);var b=l.e.Cross(a.p1.subtract(a.p0),a.p2.subtract(a.p1));b.normalize(),r.push(b),i.push(a)}for(o=0;o<i.length;o++){a=i[o];for(var C=o+1;C<i.length;C++){var M=i[C];if(a.edgesConnectedCount===3)break;if(M.edgesConnectedCount!==3)for(var N=e[C*3],D=e[C*3+1],V=e[C*3+2],X=0;X<3;X++){var ee=0;if(a.edges[X]===void 0){switch(X){case 0:this._checkVerticesInsteadOfIndices?ee=this._processEdgeForAdjacenciesWithVertices(a.p0,a.p1,M.p0,M.p1,M.p2):ee=this._processEdgeForAdjacencies(e[o*3],e[o*3+1],N,D,V);break;case 1:this._checkVerticesInsteadOfIndices?ee=this._processEdgeForAdjacenciesWithVertices(a.p1,a.p2,M.p0,M.p1,M.p2):ee=this._processEdgeForAdjacencies(e[o*3+1],e[o*3+2],N,D,V);break;case 2:this._checkVerticesInsteadOfIndices?ee=this._processEdgeForAdjacenciesWithVertices(a.p2,a.p0,M.p0,M.p1,M.p2):ee=this._processEdgeForAdjacencies(e[o*3+2],e[o*3],N,D,V);break}if(ee!==-1&&(a.edges[X]=C,M.edges[ee]=o,a.edgesConnectedCount++,M.edgesConnectedCount++,a.edgesConnectedCount===3))break}}}}for(o=0;o<i.length;o++){var ie=i[o];this._checkEdge(o,ie.edges[0],r,ie.p0,ie.p1),this._checkEdge(o,ie.edges[1],r,ie.p1,ie.p2),this._checkEdge(o,ie.edges[2],r,ie.p2,ie.p0)}var ge=this._source.getScene().getEngine();this._buffers[Oe.b.PositionKind]=new Oe.b(ge,this._linesPositions,Oe.b.PositionKind,!1),this._buffers[Oe.b.NormalKind]=new Oe.b(ge,this._linesNormals,Oe.b.NormalKind,!1,!1,4),this._buffersForInstances[Oe.b.PositionKind]=this._buffers[Oe.b.PositionKind],this._buffersForInstances[Oe.b.NormalKind]=this._buffers[Oe.b.NormalKind],this._ib=ge.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},n.prototype.isReady=function(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)},n.prototype.render=function(){var t=this._source.getScene();if(!(!this.isReady()||!t.activeCamera)){var e=t.getEngine();this._lineShader._preBind(),this._source.edgesColor.a!==1?e.setAlphaMode(2):e.setAlphaMode(0);var i=this._source.hasInstances&&this.customInstances.length>0,r=i||this._source.hasThinInstances,o=0;if(r)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){var a=this._source._instanceDataStorage;if(o=this.customInstances.length,!a.isFrozen){for(var s=0,c=0;c<o;++c)this.customInstances.data[c].copyToArray(a.instancesData,s),s+=16;a.instancesBuffer.updateDirectly(a.instancesData,0,o)}}else o=this._source.thinInstanceCount;e.bindBuffers(r?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),t.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),t.activeCamera.mode===Z.a.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",e.getAspectRatio(t.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),e.drawElementsType(Yi.a.TriangleFillMode,0,this._indicesCount,o),this._lineShader.unbind(),r&&e.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset()}},n}(),ld=function(n){Object(h.d)(t,n);function t(e,i,r){i===void 0&&(i=.95),r===void 0&&(r=!1);var o=n.call(this,e,i,r,!1)||this;return o._generateEdgesLines(),o}return t.prototype._generateEdgesLines=function(){var e=this._source.getVerticesData(Oe.b.PositionKind),i=this._source.getIndices();if(!(!i||!e)){for(var r=l.c.Vector3[0],o=l.c.Vector3[1],a=i.length-1,s=0,c=0;s<a;s+=2,c+=4)l.e.FromArrayToRef(e,3*i[s],r),l.e.FromArrayToRef(e,3*i[s+1],o),this.createLine(r,o,c);var v=this._source.getScene().getEngine();this._buffers[Oe.b.PositionKind]=new Oe.b(v,this._linesPositions,Oe.b.PositionKind,!1),this._buffers[Oe.b.NormalKind]=new Oe.b(v,this._linesNormals,Oe.b.NormalKind,!1,!1,4),this._ib=v.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},t}(ol),sv=u(502),lv=u(598),uv=u(649),Fy=u(644),ud="fibonacci",cd=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
#define TWO_PI 6.2831855


vec2 Golden2dSeq(int i,float n)
{


return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));
}
vec2 SampleDiskGolden(int i,int sampleCount)
{
vec2 f=Golden2dSeq(i,float(sampleCount));
return vec2(sqrt(f.x),TWO_PI*f.y);
}`;qe.a.IncludesShadersStore[ud]=cd;var By={name:ud,shader:cd},Ny=u(627),fd="diffusionProfile",hd=`uniform vec3 diffusionS[5];
uniform float diffusionD[5];
uniform float filterRadii[5];`;qe.a.IncludesShadersStore[fd]=hd;var wy={name:fd,shader:hd},dd="subSurfaceScatteringPixelShader",pd=`
#include<fibonacci>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;
uniform vec2 texelSize;
uniform sampler2D textureSampler;
uniform sampler2D irradianceSampler;
uniform sampler2D depthSampler;
uniform sampler2D albedoSampler;
uniform vec2 viewportSize;
uniform float metersPerUnit;
const float LOG2_E=1.4426950408889634;
const float SSS_PIXELS_PER_SAMPLE=4.;
const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true


vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{
vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S);
vec3 expSum=exp_13*(1.+exp_13*exp_13);
return (S*rcp(8.*PI))*expSum;
}






vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{
u=1.-u;
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));
float n=exp2(log2(g)*(-1.0/3.0));
float p=(g*n)*n;
float c=1.+p+n;
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u);
float x=(3./LOG2_E)*log2(c)-d;






float rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));
float r=x*rcpS;
float rcpPdf=(8.*PI*rcpS)*rcpExp;
return vec2(r,rcpPdf);
}


vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif



float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));
float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{

float scale=rcp(float(n));
float offset=rcp(float(n))*0.5;

float sinPhase,cosPhase;
sinPhase=sin(phase);
cosPhase=cos(phase);
vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);
float r=bdp.x;
float rcpPdf=bdp.y;
float phi=SampleDiskGolden(i,n).y;
float sinPhi,cosPhi;
sinPhi=sin(phi);
cosPhi=cos(phi);
float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi;
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi;
vec2 vec=r*vec2(cosPsi,sinPsi);

vec2 position;
float xy2;
position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;
xy2=r*r;
vec4 textureSample=texture2D(irradianceSampler,position);
float viewZ=texture2D(depthSampler,position).r;
vec3 irradiance=textureSample.rgb;
if (testLightingForSSS(textureSample.a))
{

float relZ=viewZ-centerPosVS.z;
vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);
totalIrradiance+=weight*irradiance;
totalWeight+=weight;
}
else
{






}
}
void main(void)
{
vec4 irradianceAndDiffusionProfile=texture2D(irradianceSampler,vUV);
vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;
int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));
float centerDepth=0.;
vec4 inputColor=texture2D(textureSampler,vUV);
bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);
if (passedStencilTest)
{
centerDepth=texture2D(depthSampler,vUV).r;
}
if (!passedStencilTest) {
gl_FragColor=inputColor;
return;
}
float distScale=1.;
vec3 S=diffusionS[diffusionProfileIndex];
float d=diffusionD[diffusionProfileIndex];
float filterRadius=filterRadii[diffusionProfileIndex];

vec2 centerPosNDC=vUV;
vec2 cornerPosNDC=vUV+0.5*texelSize;
vec3 centerPosVS=vec3(centerPosNDC*viewportSize,1.0)*centerDepth;
vec3 cornerPosVS=vec3(cornerPosNDC*viewportSize,1.0)*centerDepth;

float mmPerUnit=1000.*(metersPerUnit*rcp(distScale));
float unitsPerMm=rcp(mmPerUnit);


float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);
float pixelsPerMm=rcp(unitsPerPixel)*unitsPerMm;

float filterArea=PI*Sq(filterRadius*pixelsPerMm);
int sampleCount=int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));
int sampleBudget=_SssSampleBudget;
int texturingMode=0;
vec3 albedo=texture2D(albedoSampler,vUV).rgb;
if (distScale == 0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);
gl_FragColor=vec4(green,1.0);
return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);
return;
}
#ifdef DEBUG_SSS_SAMPLES
vec3 red=vec3(1.,0.,0.);
vec3 blue=vec3(0.,0.,1.);
gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);
return;
#endif

float phase=0.;
int n=min(sampleCount,sampleBudget);

vec3 centerWeight=vec3(0.);
vec3 totalIrradiance=vec3(0.);
vec3 totalWeight=vec3(0.);
for (int i=0; i<n; i++)
{

EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);
}

totalWeight=max(totalWeight,HALF_MIN);
gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);
}`;qe.a.ShadersStore[dd]=pd;var Vy={name:dd,shader:pd},Uy=u(534),cv=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c,v){o===void 0&&(o=null),v===void 0&&(v=0);var b=n.call(this,e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],r,o,a||Ze.a.BILINEAR_SAMPLINGMODE,s,c,null,v,"postprocess",void 0,!0)||this;return b._scene=i,b.updateEffect(),b.onApplyObservable.add(function(C){if(!i.prePassRenderer||!i.subSurfaceConfiguration){p.a.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}var M=b.texelSize;C.setFloat("metersPerUnit",i.subSurfaceConfiguration.metersPerUnit),C.setFloat2("texelSize",M.x,M.y),C.setTexture("irradianceSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(0)]),C.setTexture("depthSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(5)]),C.setTexture("albedoSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(7)]),C.setFloat2("viewportSize",Math.tan(i.activeCamera.fov/2)*i.getEngine().getAspectRatio(i.activeCamera,!0),Math.tan(i.activeCamera.fov/2)),C.setArray3("diffusionS",i.subSurfaceConfiguration.ssDiffusionS),C.setArray("diffusionD",i.subSurfaceConfiguration.ssDiffusionD),C.setArray("filterRadii",i.subSurfaceConfiguration.ssFilterRadii)}),b}return t.prototype.getClassName=function(){return"SubSurfaceScatteringPostProcess"},t}(ii.a),gd=function(){function n(t){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=H.a.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new m.a(1,1,1)),this._scene=t,n._SceneComponentInitialization(this._scene)}return Object.defineProperty(n.prototype,"ssDiffusionS",{get:function(){return this._ssDiffusionS},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ssDiffusionD",{get:function(){return this._ssDiffusionD},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ssFilterRadii",{get:function(){return this._ssFilterRadii},enumerable:!1,configurable:!0}),n.prototype.addDiffusionProfile=function(t){if(this.ssDiffusionD.length>=5)return p.a.Error("You already reached the maximum number of diffusion profiles."),0;for(var e=0;e<this._ssDiffusionS.length/3;e++)if(this._ssDiffusionS[e*3]===t.r&&this._ssDiffusionS[e*3+1]===t.g&&this._ssDiffusionS[e*3+2]===t.b)return e;return this._ssDiffusionS.push(t.r,t.b,t.g),this._ssDiffusionD.push(Math.max(Math.max(t.r,t.b),t.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(t)),this.ssDiffusionProfileColors.push(t),this._ssDiffusionD.length-1},n.prototype.createPostProcess=function(){return this.postProcess=new cv("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess},n.prototype.clearAllDiffusionProfiles=function(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]},n.prototype.dispose=function(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()},n.prototype.getDiffusionProfileParameters=function(t){var e=.997,i=Math.max(t.r,t.g,t.b);return this._sampleBurleyDiffusionProfile(e,i)},n.prototype._sampleBurleyDiffusionProfile=function(t,e){t=1-t;var i=1+4*t*(2*t+Math.sqrt(1+4*t*t)),r=Math.pow(i,-1/3),o=i*r*r,a=1+o+r,s=3*Math.log(a/(4*t));return s*e},n._SceneComponentInitialization=function(t){throw Re.a.WarnImport("PrePassRendererSceneComponent")},n}();S.a.AddParser(H.a.NAME_SUBSURFACE,function(n,t){if(n.ssDiffusionProfileColors!==void 0&&n.ssDiffusionProfileColors!==null&&(t.enableSubSurfaceForPrePass(),t.subSurfaceConfiguration))for(var e=0,i=n.ssDiffusionProfileColors.length;e<i;e++){var r=n.ssDiffusionProfileColors[e];t.subSurfaceConfiguration.addDiffusionProfile(new m.a(r.r,r.g,r.b))}}),Object.defineProperty(q.a.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(n){n&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=n)},enumerable:!0,configurable:!0}),q.a.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;var n=this.enablePrePassRenderer();return n?(this._subSurfaceConfiguration=new gd(this),n.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null},q.a.prototype.disableSubSurfaceForPrePass=function(){!this._subSurfaceConfiguration||(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};var md=function(){function n(t){this.name=H.a.NAME_PREPASSRENDERER,this.scene=t}return n.prototype.register=function(){},n.prototype.serialize=function(t){if(!!this.scene.subSurfaceConfiguration){var e=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;t.ssDiffusionProfileColors=[];for(var i=0;i<e.length;i++)t.ssDiffusionProfileColors.push({r:e[i].r,g:e[i].g,b:e[i].b})}},n.prototype.addFromContainer=function(t){},n.prototype.removeFromContainer=function(t,e){!this.scene.prePassRenderer||this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n}();gd._SceneComponentInitialization=function(n){var t=n._getComponent(H.a.NAME_SUBSURFACE);t||(t=new md(n),n._addComponent(t))};var Gy=u(558),zy=u(701),vd="outlinePixelShader",_d=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform vec4 color;
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<logDepthDeclaration>
void main(void) {
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#include<logDepthFragment>
gl_FragColor=color;
}`;qe.a.ShadersStore[vd]=_d;var jy={name:vd,shader:_d},Wy=u(703),yd="outlineVertexShader",bd=`
attribute vec3 position;
attribute vec3 normal;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

uniform float offset;
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<logDepthDeclaration>
void main(void)
{
vec3 positionUpdated=position;
vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
vec3 offsetPosition=positionUpdated+(normalUpdated*offset);
#include<instancesVertex>
#include<bonesVertex>
gl_Position=viewProjection*finalWorld*vec4(offsetPosition,1.0);
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<logDepthVertex>
}
`;qe.a.ShadersStore[yd]=bd;var Hy={name:yd,shader:bd};q.a.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new Ed(this)),this._outlineRenderer},Object.defineProperty(ot.a.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(n){n&&this.getScene().getOutlineRenderer(),this._renderOutline=n},enumerable:!0,configurable:!0}),Object.defineProperty(ot.a.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(n){n&&this.getScene().getOutlineRenderer(),this._renderOverlay=n},enumerable:!0,configurable:!0});var Ed=function(){function n(t){this.name=H.a.NAME_OUTLINERENDERER,this.zOffset=1,this.scene=t,this._engine=t.getEngine(),this.scene._addComponent(this)}return n.prototype.register=function(){this.scene._beforeRenderingMeshStage.registerStep(H.a.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(H.a.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n.prototype.render=function(t,e,i){var r=this;i===void 0&&(i=!1);var o=this.scene,a=o.getEngine(),s=a.getCaps().instancedArrays&&(e.visibleInstances[t._id]!==null&&e.visibleInstances[t._id]!==void 0||t.getRenderingMesh().hasThinInstances);if(!!this.isReady(t,s)){var c=t.getMesh(),v=c._internalAbstractMeshDataInfo._actAsRegularMesh?c:null,b=t.getRenderingMesh(),C=v||b,M=t.getMaterial();if(!(!M||!o.activeCamera)){if(a.enableEffect(this._effect),M.useLogarithmicDepth&&this._effect.setFloat("logarithmicDepthConstant",2/(Math.log(o.activeCamera.maxZ+1)/Math.LN2)),this._effect.setFloat("offset",i?0:b.outlineWidth),this._effect.setColor4("color",i?b.overlayColor:b.outlineColor,i?b.overlayAlpha:M.alpha),this._effect.setMatrix("viewProjection",o.getTransformMatrix()),this._effect.setMatrix("world",C.getWorldMatrix()),b.useBones&&b.computeBonesUsingShaders&&b.skeleton&&this._effect.setMatrices("mBones",b.skeleton.getTransformMatrices(b)),b.morphTargetManager&&b.morphTargetManager.isUsingTextureForTargets&&b.morphTargetManager._bind(this._effect),Ot.a.BindMorphTargetParameters(b,this._effect),b._bind(t,this._effect,M.fillMode),M&&M.needAlphaTesting()){var N=M.getAlphaTestTexture();N&&(this._effect.setTexture("diffuseSampler",N),this._effect.setMatrix("diffuseMatrix",N.getTextureMatrix()))}a.setZOffset(-this.zOffset),b._processRendering(C,t,this._effect,M.fillMode,e,s,function(D,V){r._effect.setMatrix("world",V)}),a.setZOffset(0)}}},n.prototype.isReady=function(t,e){var i=[],r=[Oe.b.PositionKind,Oe.b.NormalKind],o=t.getMesh(),a=t.getMaterial();a&&(a.needAlphaTesting()&&(i.push("#define ALPHATEST"),o.isVerticesDataPresent(Oe.b.UVKind)&&(r.push(Oe.b.UVKind),i.push("#define UV1")),o.isVerticesDataPresent(Oe.b.UV2Kind)&&(r.push(Oe.b.UV2Kind),i.push("#define UV2"))),a.useLogarithmicDepth&&i.push("#define LOGARITHMICDEPTH")),o.useBones&&o.computeBonesUsingShaders?(r.push(Oe.b.MatricesIndicesKind),r.push(Oe.b.MatricesWeightsKind),o.numBoneInfluencers>4&&(r.push(Oe.b.MatricesIndicesExtraKind),r.push(Oe.b.MatricesWeightsExtraKind)),i.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers),i.push("#define BonesPerMesh "+(o.skeleton?o.skeleton.bones.length+1:0))):i.push("#define NUM_BONE_INFLUENCERS 0");var s=o.morphTargetManager,c=0;s&&s.numInfluencers>0&&(c=s.numInfluencers,i.push("#define MORPHTARGETS"),i.push("#define NUM_MORPH_INFLUENCERS "+c),s.isUsingTextureForTargets&&i.push("#define MORPHTARGETS_TEXTURE"),Ot.a.PrepareAttributesForMorphTargetsInfluencers(r,o,c)),e&&(i.push("#define INSTANCES"),Ot.a.PushAttributesForInstances(r),t.getRenderingMesh().hasThinInstances&&i.push("#define THIN_INSTANCES"));var v=i.join(`
`);return this._cachedDefines!==v&&(this._cachedDefines=v,this._effect=this.scene.getEngine().createEffect("outline",r,["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],["diffuseSampler","morphTargets"],v,void 0,void 0,void 0,{maxSimultaneousMorphTargets:c})),this._effect.isReady()},n.prototype._beforeRenderingMesh=function(t,e,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),t.renderOutline){var r=e.getMaterial();r&&r.needAlphaBlendingForMesh(t)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(n._StencilReference),this._engine.setStencilFunctionReference(n._StencilReference),this.render(e,i,!0),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(e,i),this._engine.setDepthWrite(this._savedDepthWrite),r&&r.needAlphaBlendingForMesh(t)&&this._engine.restoreStencilState()}},n.prototype._afterRenderingMesh=function(t,e,i){if(t.renderOverlay){var r=this._engine.getAlphaMode(),o=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(e,i,!0),this._engine.setAlphaMode(r),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=o}t.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(e,i),this._engine.setColorWrite(!0))},n._StencilReference=4,n}(),fv=u(720),Pd=u(591),hv=function(){function n(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}return Object.defineProperty(n.prototype,"animationStarted",{get:function(){return this._animationStarted},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fromIndex",{get:function(){return this._fromIndex},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"toIndex",{get:function(){return this._toIndex},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"loopAnimation",{get:function(){return this._loopAnimation},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"delay",{get:function(){return Math.max(this._delay,1)},enumerable:!1,configurable:!0}),n.prototype.playAnimation=function(t,e,i,r,o){this._fromIndex=t,this._toIndex=e,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=o,t<e?this._direction=1:(this._direction=-1,this._toIndex=t,this._fromIndex=e),this.cellIndex=t,this._time=0},n.prototype.stopAnimation=function(){this._animationStarted=!1},n.prototype._animate=function(t){!this._animationStarted||(this._time+=t,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))},n}(),Cd=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this)||this;return r.name=e,r.animations=new Array,r.isPickable=!1,r.useAlphaForPicking=!1,r.onDisposeObservable=new _.c,r._onAnimationEnd=null,r._endAnimation=function(){r._onAnimationEnd&&r._onAnimationEnd(),r.disposeWhenFinishedAnimating&&r.dispose()},r.color=new m.b(1,1,1,1),r.position=l.e.Zero(),r._manager=i,r._manager.sprites.push(r),r.uniqueId=r._manager.scene.getUniqueId(),r}return Object.defineProperty(t.prototype,"size",{get:function(){return this.width},set:function(e){this.width=e,this.height=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"manager",{get:function(){return this._manager},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"Sprite"},Object.defineProperty(t.prototype,"fromIndex",{get:function(){return this._fromIndex},set:function(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"toIndex",{get:function(){return this._toIndex},set:function(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loopAnimation",{get:function(){return this._loopAnimation},set:function(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"delay",{get:function(){return Math.max(this._delay,1)},set:function(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)},enumerable:!1,configurable:!0}),t.prototype.playAnimation=function(e,i,r,o,a){a===void 0&&(a=null),this._onAnimationEnd=a,n.prototype.playAnimation.call(this,e,i,r,o,this._endAnimation)},t.prototype.dispose=function(){for(var e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},t.prototype.serialize=function(){var e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e},t.Parse=function(e,i){var r=new t(e.name,i);return r.position=l.e.FromArray(e.position),r.color=m.b.FromArray(e.color),r.width=e.width,r.height=e.height,r.angle=e.angle,r.cellIndex=e.cellIndex,r.cellRef=e.cellRef,r.invertU=e.invertU,r.invertV=e.invertV,r.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,r.isPickable=e.isPickable,r.isVisible=e.isVisible,r.useAlphaForPicking=e.useAlphaForPicking,r.fromIndex=e.fromIndex,r.toIndex=e.toIndex,r.loopAnimation=e.loopAnimation,r.delay=e.delay,e.animationStarted&&r.playAnimation(r.fromIndex,r.toIndex,r.loopAnimation,r.delay),r},t}(hv);q.a.prototype._internalPickSprites=function(n,t,e,i){if(!mt.a)return null;var r=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers.length>0)for(var o=0;o<this.spriteManagers.length;o++){var a=this.spriteManagers[o];if(!!a.isPickable){var s=a.intersects(n,i,t,e);if(!(!s||!s.hit)&&!(!e&&r!=null&&s.distance>=r.distance)&&(r=s,e))break}}return r||new mt.a},q.a.prototype._internalMultiPickSprites=function(n,t,e){if(!mt.a)return null;var i=new Array;if(!e){if(!this.activeCamera)return null;e=this.activeCamera}if(this.spriteManagers.length>0)for(var r=0;r<this.spriteManagers.length;r++){var o=this.spriteManagers[r];if(!!o.isPickable){var a=o.multiIntersects(n,e,t);a!==null&&(i=i.concat(a))}}return i},q.a.prototype.pickSprite=function(n,t,e,i,r){return this._tempSpritePickingRay?(this.createPickingRayInCameraSpaceToRef(n,t,this._tempSpritePickingRay,r),this._internalPickSprites(this._tempSpritePickingRay,e,i,r)):null},q.a.prototype.pickSpriteWithRay=function(n,t,e,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}return Zt.a.TransformToRef(n,i.getViewMatrix(),this._tempSpritePickingRay),this._internalPickSprites(this._tempSpritePickingRay,t,e,i)},q.a.prototype.multiPickSprite=function(n,t,e,i){return this.createPickingRayInCameraSpaceToRef(n,t,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,e,i)},q.a.prototype.multiPickSpriteWithRay=function(n,t,e){if(!this._tempSpritePickingRay)return null;if(!e){if(!this.activeCamera)return null;e=this.activeCamera}return Zt.a.TransformToRef(n,e.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,t,e)},q.a.prototype.setPointerOverSprite=function(n){this._pointerOverSprite!==n&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,O.a.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=n,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,O.a.CreateNewFromSprite(this._pointerOverSprite,this)))},q.a.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};var Sd=function(){function n(t){this.name=H.a.NAME_SPRITE,this.scene=t,this.scene.spriteManagers=new Array,this.scene._tempSpritePickingRay=Zt.a?Zt.a.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new _.c,this.scene.onAfterSpritesRenderingObservable=new _.c,this._spritePredicate=function(e){return e.actionManager?e.isPickable&&e.actionManager.hasPointerTriggers:!1}}return n.prototype.register=function(){this.scene._pointerMoveStage.registerStep(H.a.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(H.a.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(H.a.STEP_POINTERUP_SPRITE,this,this._pointerUp)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();for(var t=this.scene.spriteManagers;t.length;)t[0].dispose()},n.prototype._pickSpriteButKeepRay=function(t,e,i,r,o){var a=this.scene.pickSprite(e,i,this._spritePredicate,r,o);return a&&(a.ray=t?t.ray:null),a},n.prototype._pointerMove=function(t,e,i,r,o){var a=this.scene;return r?a.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,t,e,!1,a.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite?(a.setPointerOverSprite(i.pickedSprite),a.doNotHandleCursors||(a._pointerOverSprite&&a._pointerOverSprite.actionManager&&a._pointerOverSprite.actionManager.hoverCursor?o.style.cursor=a._pointerOverSprite.actionManager.hoverCursor:o.style.cursor=a.hoverCursor)):a.setPointerOverSprite(null)),i},n.prototype._pointerDown=function(t,e,i,r){var o=this.scene;if(o._pickedDownSprite=null,o.spriteManagers.length>0&&(i=o.pickSprite(t,e,this._spritePredicate,!1,o.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager)){switch(o._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,O.a.CreateNewFromSprite(i.pickedSprite,o,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,O.a.CreateNewFromSprite(i.pickedSprite,o,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,O.a.CreateNewFromSprite(i.pickedSprite,o,r));break}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,O.a.CreateNewFromSprite(i.pickedSprite,o,r))}return i},n.prototype._pointerUp=function(t,e,i,r){var o=this.scene;if(o.spriteManagers.length>0){var a=o.pickSprite(t,e,this._spritePredicate,!1,o.cameraToUseForPointers||void 0);a&&(a.hit&&a.pickedSprite&&a.pickedSprite.actionManager&&(a.pickedSprite.actionManager.processTrigger(7,O.a.CreateNewFromSprite(a.pickedSprite,o,r)),a.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||a.pickedSprite.actionManager.processTrigger(1,O.a.CreateNewFromSprite(a.pickedSprite,o,r)))),o._pickedDownSprite&&o._pickedDownSprite.actionManager&&o._pickedDownSprite!==a.pickedSprite&&o._pickedDownSprite.actionManager.processTrigger(16,O.a.CreateNewFromSprite(o._pickedDownSprite,o,r)))}return i},n}(),Td="imageProcessingCompatibility",Rd=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif`;qe.a.IncludesShadersStore[Td]=Rd;var ky={name:Td,shader:Rd},Ad="spritesPixelShader",Od=`uniform bool alphaTest;
varying vec4 vColor;

varying vec2 vUV;
uniform sampler2D diffuseSampler;

#include<fogFragmentDeclaration>
void main(void) {
vec4 color=texture2D(diffuseSampler,vUV);
if (alphaTest)
{
if (color.a<0.95)
discard;
}
color*=vColor;
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
}`;qe.a.ShadersStore[Ad]=Od;var Xy={name:Ad,shader:Od},Md="spritesVertexShader",xd=`
attribute vec4 position;
attribute vec2 options;
attribute vec2 offsets;
attribute vec2 inverts;
attribute vec4 cellInfo;
attribute vec4 color;

uniform mat4 view;
uniform mat4 projection;

varying vec2 vUV;
varying vec4 vColor;
#include<fogVertexDeclaration>
void main(void) {
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz;
vec2 cornerPos;
float angle=position.w;
vec2 size=vec2(options.x,options.y);
vec2 offset=offsets.xy;
cornerPos=vec2(offset.x-0.5,offset.y-0.5)*size;

vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;

viewPos+=rotatedCorner;
gl_Position=projection*vec4(viewPos,1.0);

vColor=color;

vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));
vec2 uvPlace=cellInfo.xy;
vec2 uvSize=cellInfo.zw;
vUV.x=uvPlace.x+uvSize.x*uvOffset.x;
vUV.y=uvPlace.y+uvSize.y*uvOffset.y;

#ifdef FOG
vFogDistance=viewPos;
#endif
}`;qe.a.ShadersStore[Md]=xd;var Yy={name:Md,shader:xd},dv=function(){function n(t,e,i,r){if(i===void 0&&(i=.01),r===void 0&&(r=null),this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this.fogEnabled=!0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._capacity=e,this._epsilon=i,this._engine=t,this._useInstancing=t.getCaps().instancedArrays,this._useVAO=t.getCaps().vertexArrayObject&&!t.disableVertexArrayObjects,this._scene=r,!this._useInstancing){for(var o=[],a=0,s=0;s<e;s++)o.push(a),o.push(a+1),o.push(a+2),o.push(a),o.push(a+2),o.push(a+3),a+=4;this._indexBuffer=t.createIndexBuffer(o)}this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(e*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new Oe.a(t,this._vertexData,!0,this._vertexBufferSize);var c=this._buffer.createVertexBuffer(Oe.b.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),v=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing),b=6,C;if(this._useInstancing){var M=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Oe.a(t,M,!1,2),C=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else C=this._buffer.createVertexBuffer("offsets",b,2,this._vertexBufferSize,this._useInstancing),b+=2;var N=this._buffer.createVertexBuffer("inverts",b,2,this._vertexBufferSize,this._useInstancing),D=this._buffer.createVertexBuffer("cellInfo",b+2,4,this._vertexBufferSize,this._useInstancing),V=this._buffer.createVertexBuffer(Oe.b.ColorKind,b+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Oe.b.PositionKind]=c,this._vertexBuffers.options=v,this._vertexBuffers.offsets=C,this._vertexBuffers.inverts=N,this._vertexBuffers.cellInfo=D,this._vertexBuffers[Oe.b.ColorKind]=V,this._effectBase=this._engine.createEffect("sprites",[Oe.b.PositionKind,"options","offsets","inverts","cellInfo",Oe.b.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],""),this._scene&&(this._effectFog=this._scene.getEngine().createEffect("sprites",[Oe.b.PositionKind,"options","offsets","inverts","cellInfo",Oe.b.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG"))}return Object.defineProperty(n.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),n.prototype.render=function(t,e,i,r,o){if(o===void 0&&(o=null),!(!this.texture||!this.texture.isReady()||!t.length)){var a=this._effectBase,s=!1;if(this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&(a=this._effectFog,s=!0),!!a.isReady()){for(var c=this._engine,v=!!(this._scene&&this._scene.useRightHandedSystem),b=this.texture.getBaseSize(),C=Math.min(this._capacity,t.length),M=0,N=!0,D=0;D<C;D++){var V=t[D];!V||!V.isVisible||(N=!1,V._animate(e),this._appendSpriteVertex(M++,V,0,0,b,v,o),this._useInstancing||(this._appendSpriteVertex(M++,V,1,0,b,v,o),this._appendSpriteVertex(M++,V,1,1,b,v,o),this._appendSpriteVertex(M++,V,0,1,b,v,o)))}if(!N){this._buffer.update(this._vertexData);var X=c.depthCullingState.cull||!0,ee=c.depthCullingState.zOffset;if(v&&this._scene.getEngine().setState(X,ee,!1,!1),c.enableEffect(a),a.setTexture("diffuseSampler",this.texture),a.setMatrix("view",i),a.setMatrix("projection",r),s){var ie=this._scene;a.setFloat4("vFogInfos",ie.fogMode,ie.fogStart,ie.fogEnd,ie.fogDensity),a.setColor3("vFogColor",ie.fogColor)}this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=c.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,a)),c.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):c.bindBuffers(this._vertexBuffers,this._indexBuffer,a),c.depthCullingState.depthFunc=515,this.disableDepthWrite||(a.setBool("alphaTest",!0),c.setColorWrite(!1),this._useInstancing?c.drawArraysType(7,0,4,M):c.drawElementsType(0,0,M/4*6),c.setColorWrite(!0),a.setBool("alphaTest",!1)),c.setAlphaMode(this.blendMode),this._useInstancing?c.drawArraysType(7,0,4,M):c.drawElementsType(0,0,M/4*6),this.autoResetAlpha&&c.setAlphaMode(0),v&&this._scene.getEngine().setState(X,ee,!1,!0),c.unbindInstanceAttributes()}}}},n.prototype._appendSpriteVertex=function(t,e,i,r,o,a,s){var c=t*this._vertexBufferSize;if(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),s)s(e,o);else{e.cellIndex||(e.cellIndex=0);var v=o.width/this.cellWidth,b=e.cellIndex/v>>0;e._xOffset=(e.cellIndex-b*v)*this.cellWidth/o.width,e._yOffset=b*this.cellHeight/o.height,e._xSize=this.cellWidth,e._ySize=this.cellHeight}this._vertexData[c]=e.position.x,this._vertexData[c+1]=e.position.y,this._vertexData[c+2]=e.position.z,this._vertexData[c+3]=e.angle,this._vertexData[c+4]=e.width,this._vertexData[c+5]=e.height,this._useInstancing?c-=2:(this._vertexData[c+6]=i,this._vertexData[c+7]=r),a?this._vertexData[c+8]=e.invertU?0:1:this._vertexData[c+8]=e.invertU?1:0,this._vertexData[c+9]=e.invertV?1:0,this._vertexData[c+10]=e._xOffset,this._vertexData[c+11]=e._yOffset,this._vertexData[c+12]=e._xSize/o.width,this._vertexData[c+13]=e._ySize/o.height,this._vertexData[c+14]=e.color.r,this._vertexData[c+15]=e.color.g,this._vertexData[c+16]=e.color.b,this._vertexData[c+17]=e.color.a},n.prototype.dispose=function(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null)},n}(),Dd=function(){function n(t,e,i,r,o,a,s,c,v){var b=this;a===void 0&&(a=.01),s===void 0&&(s=Ze.a.TRILINEAR_SAMPLINGMODE),c===void 0&&(c=!1),v===void 0&&(v=null),this.name=t,this.sprites=new Array,this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.onDisposeObservable=new _.c,this.disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=function(M,N){M.cellRef||(M.cellIndex=0);var D=M.cellIndex;typeof D=="number"&&isFinite(D)&&Math.floor(D)===D&&(M.cellRef=b._spriteMap[M.cellIndex]),M._xOffset=b._cellData[M.cellRef].frame.x/N.width,M._yOffset=b._cellData[M.cellRef].frame.y/N.height,M._xSize=b._cellData[M.cellRef].frame.w,M._ySize=b._cellData[M.cellRef].frame.h},o||(o=W.a.LastCreatedScene),o._getComponent(H.a.NAME_SPRITE)||o._addComponent(new Sd(o)),this._fromPacked=c,this._scene=o;var C=this._scene.getEngine();if(this._spriteRenderer=new dv(C,i,a,o),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else if(r!==void 0)this.cellWidth=r,this.cellHeight=r;else{this._spriteRenderer=null;return}this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),e&&(this.texture=new Ze.a(e,o,!0,!1,s)),this._fromPacked&&this._makePacked(e,v)}return Object.defineProperty(n.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"children",{get:function(){return this.sprites},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"capacity",{get:function(){return this._spriteRenderer.capacity},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"texture",{get:function(){return this._spriteRenderer.texture},set:function(t){t.wrapU=Ze.a.CLAMP_ADDRESSMODE,t.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=t,this._textureContent=null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cellWidth",{get:function(){return this._spriteRenderer.cellWidth},set:function(t){this._spriteRenderer.cellWidth=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cellHeight",{get:function(){return this._spriteRenderer.cellHeight},set:function(t){this._spriteRenderer.cellHeight=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fogEnabled",{get:function(){return this._spriteRenderer.fogEnabled},set:function(t){this._spriteRenderer.fogEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"blendMode",{get:function(){return this._spriteRenderer.blendMode},set:function(t){this._spriteRenderer.blendMode=t},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"SpriteManager"},n.prototype._makePacked=function(t,e){var i=this;if(e!==null)try{var r=void 0;if(typeof e=="string"?r=JSON.parse(e):r=e,r.frames.length){for(var o={},a=0;a<r.frames.length;a++){var s=r.frames[a];if(typeof Object.keys(s)[0]!="string")throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");var c=s[Object.keys(s)[0]];o[c]=s}r.frames=o}var v=Reflect.ownKeys(r.frames);this._spriteMap=v,this._packedAndReady=!0,this._cellData=r.frames}catch(D){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{var b=/\./g,C=void 0;do C=b.lastIndex,b.test(t);while(b.lastIndex>0);var M=t.substring(0,C-1)+".json",N=new XMLHttpRequest;N.open("GET",M,!0),N.onerror=function(){p.a.Error("JSON ERROR: Unable to load JSON file."),i._fromPacked=!1,i._packedAndReady=!1},N.onload=function(){try{var D=JSON.parse(N.response),V=Reflect.ownKeys(D.frames);i._spriteMap=V,i._packedAndReady=!0,i._cellData=D.frames}catch(X){throw i._fromPacked=!1,i._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}},N.send()}},n.prototype._checkTextureAlpha=function(t,e,i,r,o){if(!t.useAlphaForPicking||!this.texture)return!0;var a=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(a.width*a.height*4),this.texture.readPixels(0,0,this._textureContent));var s=l.c.Vector3[0];s.copyFrom(e.direction),s.normalize(),s.scaleInPlace(i),s.addInPlace(e.origin);var c=(s.x-r.x)/(o.x-r.x)-.5,v=1-(s.y-r.y)/(o.y-r.y)-.5,b=t.angle,C=.5+(c*Math.cos(b)-v*Math.sin(b)),M=.5+(c*Math.sin(b)+v*Math.cos(b)),N=t._xOffset*a.width+C*t._xSize|0,D=t._yOffset*a.height+M*t._ySize|0,V=this._textureContent[(N+D*a.width)*4+3];return V>.5},n.prototype.intersects=function(t,e,i,r){for(var o=Math.min(this.capacity,this.sprites.length),a=l.e.Zero(),s=l.e.Zero(),c=Number.MAX_VALUE,v=null,b=l.c.Vector3[0],C=l.c.Vector3[1],M=e.getViewMatrix(),N=0;N<o;N++){var D=this.sprites[N];if(!!D){if(i){if(!i(D))continue}else if(!D.isPickable)continue;if(l.e.TransformCoordinatesToRef(D.position,M,C),a.copyFromFloats(C.x-D.width/2,C.y-D.height/2,C.z),s.copyFromFloats(C.x+D.width/2,C.y+D.height/2,C.z),t.intersectsBoxMinMax(a,s)){var V=l.e.Distance(C,t.origin);if(c>V){if(!this._checkTextureAlpha(D,t,V,a,s))continue;if(c=V,v=D,r)break}}}}if(v){var X=new mt.a;M.invertToRef(l.c.Matrix[0]),X.hit=!0,X.pickedSprite=v,X.distance=c;var ee=l.c.Vector3[2];return ee.copyFrom(t.direction),ee.normalize(),ee.scaleInPlace(c),t.origin.addToRef(ee,b),X.pickedPoint=l.e.TransformCoordinates(b,l.c.Matrix[0]),X}return null},n.prototype.multiIntersects=function(t,e,i){for(var r=Math.min(this.capacity,this.sprites.length),o=l.e.Zero(),a=l.e.Zero(),s,c=[],v=l.c.Vector3[0].copyFromFloats(0,0,0),b=l.c.Vector3[1].copyFromFloats(0,0,0),C=e.getViewMatrix(),M=0;M<r;M++){var N=this.sprites[M];if(!!N){if(i){if(!i(N))continue}else if(!N.isPickable)continue;if(l.e.TransformCoordinatesToRef(N.position,C,b),o.copyFromFloats(b.x-N.width/2,b.y-N.height/2,b.z),a.copyFromFloats(b.x+N.width/2,b.y+N.height/2,b.z),t.intersectsBoxMinMax(o,a)){if(s=l.e.Distance(b,t.origin),!this._checkTextureAlpha(N,t,s,o,a))continue;var D=new mt.a;c.push(D),C.invertToRef(l.c.Matrix[0]),D.hit=!0,D.pickedSprite=N,D.distance=s;var V=l.c.Vector3[2];V.copyFrom(t.direction),V.normalize(),V.scaleInPlace(s),t.origin.addToRef(V,v),D.pickedPoint=l.e.TransformCoordinates(v,l.c.Matrix[0])}}}return c},n.prototype.render=function(){if(!(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))){var t=this._scene.getEngine(),e=t.getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}},n.prototype.dispose=function(){this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null;var t=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},n.prototype.serialize=function(t){t===void 0&&(t=!1);var e={};e.name=this.name,e.capacity=this.capacity,e.cellWidth=this.cellWidth,e.cellHeight=this.cellHeight,this.texture&&(t?e.texture=this.texture.serialize():(e.textureUrl=this.texture.name,e.invertY=this.texture._invertY)),e.sprites=[];for(var i=0,r=this.sprites;i<r.length;i++){var o=r[i];e.sprites.push(o.serialize())}return e},n.Parse=function(t,e,i){var r=new n(t.name,"",t.capacity,{width:t.cellWidth,height:t.cellHeight},e);t.texture?r.texture=Ze.a.Parse(t.texture,e,i):t.textureName&&(r.texture=new Ze.a(i+t.textureUrl,e,!1,t.invertY!==void 0?t.invertY:!0));for(var o=0,a=t.sprites;o<a.length;o++){var s=a[o];Cd.Parse(s,r)}return r},n.ParseFromFileAsync=function(t,e,i,r){return r===void 0&&(r=""),new Promise(function(o,a){var s=new Ar.a;s.addEventListener("readystatechange",function(){if(s.readyState==4)if(s.status==200){var c=JSON.parse(s.responseText),v=n.Parse(c,i||W.a.LastCreatedScene,r);t&&(v.name=t),o(v)}else a("Unable to load the sprite manager")}),s.open("GET",e),s.send()})},n.CreateFromSnippetAsync=function(t,e,i){var r=this;return i===void 0&&(i=""),t==="_BLANK"?Promise.resolve(new n("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,e)):new Promise(function(o,a){var s=new Ar.a;s.addEventListener("readystatechange",function(){if(s.readyState==4)if(s.status==200){var c=JSON.parse(JSON.parse(s.responseText).jsonPayload),v=JSON.parse(c.spriteManager),b=n.Parse(v,e||W.a.LastCreatedScene,i);b.snippetId=t,o(b)}else a("Unable to load the snippet "+t)}),s.open("GET",r.SnippetUrl+"/"+t.replace(/#/g,"/")),s.send()})},n.SnippetUrl="https://snippet.babylonjs.com",n}(),Id="spriteMapPixelShader",Ld=`precision highp float;
varying vec3 vPosition;
varying vec2 vUV;
varying vec2 tUV;
uniform float time;
uniform float spriteCount;
uniform sampler2D spriteSheet;
uniform vec2 spriteMapSize;
uniform vec2 outputSize;
uniform vec2 stageSize;
uniform sampler2D frameMap;
uniform sampler2D tileMaps[LAYERS];
uniform sampler2D animationMap;
uniform vec3 colorMul;
float mt;
const float fdStep=1./4.;
const float aFrameSteps=1./MAX_ANIMATION_FRAMES;
mat4 getFrameData(float frameID){
float fX=frameID/spriteCount;
return mat4(
texture2D(frameMap,vec2(fX,0.),0.),
texture2D(frameMap,vec2(fX,fdStep*1.),0.),
texture2D(frameMap,vec2(fX,fdStep*2.),0.),
vec4(0.)
);
}
void main(){
vec4 color=vec4(0.);
vec2 tileUV=fract(tUV);
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
vec2 tileID=floor(tUV);
vec2 sheetUnits=1./spriteMapSize;
float spriteUnits=1./spriteCount;
vec2 stageUnits=1./stageSize;
for(int i=0; i<LAYERS; i++) {
float frameID;
#define LAYER_ID_SWITCH
vec4 animationData=texture2D(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);
if(animationData.y>0.) {
mt=mod(time*animationData.z,1.0);
for(float f=0.; f<MAX_ANIMATION_FRAMES; f++){
if(animationData.y>mt){
frameID=animationData.x;
break;
}
animationData=texture2D(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);
}
}

mat4 frameData=getFrameData(frameID+0.5);
vec2 frameSize=(frameData[0].wz)/spriteMapSize;
vec2 offset=frameData[0].xy*sheetUnits;
vec2 ratio=frameData[2].xy/frameData[0].wz;

if (frameData[2].z == 1.){
tileUV.xy=tileUV.yx;
}
if (i == 0){
color=texture2D(spriteSheet,tileUV*frameSize+offset);
} else {
vec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);
float alpha=min(color.a+nc.a,1.0);
vec3 mixed=mix(color.xyz,nc.xyz,nc.a);
color=vec4(mixed,alpha);
}
}
color.xyz*=colorMul;
gl_FragColor=color;
}`;qe.a.ShadersStore[Id]=Ld;var Ky={name:Id,shader:Ld},Fd="spriteMapVertexShader",Bd=`precision highp float;

attribute vec3 position;
attribute vec3 normal;
attribute vec2 uv;

varying vec3 vPosition;
varying vec2 vUV;
varying vec2 tUV;
varying vec2 stageUnits;
varying vec2 levelUnits;
varying vec2 tileID;

uniform float time;
uniform mat4 worldViewProjection;
uniform vec2 outputSize;
uniform vec2 stageSize;
uniform vec2 spriteMapSize;
uniform float stageScale;
void main() {
vec4 p=vec4( position,1. );
vPosition=p.xyz;
vUV=uv;
tUV=uv*stageSize;
gl_Position=worldViewProjection*p;
}`;qe.a.ShadersStore[Fd]=Bd;var Qy={name:Fd,shader:Bd},pv=function(){function n(t,e,i,r,o){var a=this;this.name=t,this.sprites=[],this.atlasJSON=e,this.sprites=this.atlasJSON.frames,this.spriteSheet=i,this.options=r,r.stageSize=r.stageSize||new l.d(1,1),r.outputSize=r.outputSize||r.stageSize,r.outputPosition=r.outputPosition||l.e.Zero(),r.outputRotation=r.outputRotation||l.e.Zero(),r.layerCount=r.layerCount||1,r.maxAnimationFrames=r.maxAnimationFrames||0,r.baseTile=r.baseTile||0,r.flipU=r.flipU||!1,r.colorMultiply=r.colorMultiply||new l.e(1,1,1),this._scene=o,this._frameMap=this._createFrameBuffer(),this._tileMaps=new Array;for(var s=0;s<r.layerCount;s++)this._tileMaps.push(this._createTileBuffer(null,s));this._animationMap=this._createTileAnimationBuffer(null);var c=[];c.push("#define LAYERS "+r.layerCount),r.flipU&&c.push("#define FLIPU"),c.push("#define MAX_ANIMATION_FRAMES "+r.maxAnimationFrames+".0");var v=qe.a.ShadersStore.spriteMapPixelShader,b;if(o.getEngine()._features.supportSwitchCaseInShader){b="switch(i) {";for(var s=0;s<r.layerCount;s++)b+="case "+s+" : frameID = texture(tileMaps["+s+"], (tileID + 0.5) / stageSize, 0.).x;",b+="break;";b+="}"}else{b="";for(var s=0;s<r.layerCount;s++)b+="if ("+s+" == i) { frameID = texture2D(tileMaps["+s+"], (tileID + 0.5) / stageSize, 0.).x; }"}qe.a.ShadersStore["spriteMap"+this.name+"PixelShader"]=v.replace("#define LAYER_ID_SWITCH",b),this._material=new Tn.a("spriteMap:"+this.name,this._scene,{vertex:"spriteMap",fragment:"spriteMap"+this.name},{defines:c,attributes:["position","normal","uv"],uniforms:["worldViewProjection","time","stageSize","outputSize","spriteMapSize","spriteCount","time","colorMul","mousePosition","curTile","flipU"],samplers:["spriteSheet","frameMap","tileMaps","animationMap"],needAlphaBlending:!0}),this._time=0,this._material.setFloat("spriteCount",this.spriteCount),this._material.setVector2("stageSize",r.stageSize),this._material.setVector2("outputSize",r.outputSize),this._material.setTexture("spriteSheet",this.spriteSheet),this._material.setVector2("spriteMapSize",new l.d(1,1)),this._material.setVector3("colorMul",r.colorMultiply);var C=0,M=function(){if(a.spriteSheet&&a.spriteSheet.isReady()&&a.spriteSheet._texture){a._material.setVector2("spriteMapSize",new l.d(a.spriteSheet._texture.baseWidth||1,a.spriteSheet._texture.baseHeight||1));return}C<100&&setTimeout(function(){C++,M()},100)};M(),this._material.setVector3("colorMul",r.colorMultiply),this._material.setTexture("frameMap",this._frameMap),this._material.setTextureArray("tileMaps",this._tileMaps),this._material.setTexture("animationMap",this._animationMap),this._material.setFloat("time",this._time),this._output=ot.a.CreatePlane(t+":output",1,o,!0),this._output.scaling.x=r.outputSize.x,this._output.scaling.y=r.outputSize.y,this.position=r.outputPosition,this.rotation=r.outputRotation;var N=function(){a._time+=a._scene.getEngine().getDeltaTime(),a._material.setFloat("time",a._time)};this._scene.onBeforeRenderObservable.add(N),this._output.material=this._material}return Object.defineProperty(n.prototype,"spriteCount",{get:function(){return this.sprites.length},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"position",{get:function(){return this._output.position},set:function(t){this._output.position=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rotation",{get:function(){return this._output.rotation},set:function(t){this._output.rotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"animationMap",{get:function(){return this._animationMap},set:function(t){var e=t._texture._bufferView,i=this._createTileAnimationBuffer(e);this._animationMap.dispose(),this._animationMap=i,this._material.setTexture("animationMap",this._animationMap)},enumerable:!1,configurable:!0}),n.prototype.getTileID=function(){var t=this.getMousePosition();return t.multiplyInPlace(this.options.stageSize||l.d.Zero()),t.x=Math.floor(t.x),t.y=Math.floor(t.y),t},n.prototype.getMousePosition=function(){var t=this._output,e=this._scene.pick(this._scene.pointerX,this._scene.pointerY,function(r){return r===t});if(!e||!e.hit||!e.getTextureCoordinates)return new l.d(-1,-1);var i=e.getTextureCoordinates();return i||new l.d(-1,-1)},n.prototype._createFrameBuffer=function(){for(var t=new Array,e=0;e<this.spriteCount;e++)t.push(0,0,0,0),t.push(0,0,0,0),t.push(0,0,0,0),t.push(0,0,0,0);for(var e=0;e<this.spriteCount;e++){var i=this.sprites[e].frame,r=this.sprites[e].spriteSourceSize,o=this.sprites[e].sourceSize,a=this.sprites[e].rotated?1:0,s=this.sprites[e].trimmed?1:0;t[e*4]=i.x,t[e*4+1]=i.y,t[e*4+2]=i.w,t[e*4+3]=i.h,t[e*4+this.spriteCount*4]=r.x,t[e*4+1+this.spriteCount*4]=r.y,t[e*4+3+this.spriteCount*4]=r.h,t[e*4+this.spriteCount*8]=o.w,t[e*4+1+this.spriteCount*8]=o.h,t[e*4+2+this.spriteCount*8]=a,t[e*4+3+this.spriteCount*8]=s}var c=new Float32Array(t),v=kr.a.CreateRGBATexture(c,this.spriteCount,4,this._scene,!1,!1,Ze.a.NEAREST_NEAREST,W.a.TEXTURETYPE_FLOAT);return v},n.prototype._createTileBuffer=function(t,e){e===void 0&&(e=0);var i=new Array,r=this.options.stageSize.y||0,o=this.options.stageSize.x||0;if(t)i=t;else{var a=this.options.baseTile;e!=0&&(a=0);for(var s=0;s<r;s++)for(var c=0;c<o*4;c+=4)i.push(a,0,0,0)}var v=new Float32Array(i),b=kr.a.CreateRGBATexture(v,o,r,this._scene,!1,!1,Ze.a.NEAREST_NEAREST,W.a.TEXTURETYPE_FLOAT);return b},n.prototype.changeTiles=function(t,e,i){t===void 0&&(t=0),i===void 0&&(i=0);var r;if(r=this._tileMaps[t]._texture._bufferView,r!==null){var o=new Array;e instanceof l.d?o.push(e):o=e;for(var a=this.options.stageSize.x||0,s=0;s<o.length;s++){var c=o[s];c.x=Math.floor(c.x),c.y=Math.floor(c.y);var v=c.x*4+c.y*(a*4);r[v]=i}var b=this._createTileBuffer(r);this._tileMaps[t].dispose(),this._tileMaps[t]=b,this._material.setTextureArray("tileMap",this._tileMaps)}},n.prototype._createTileAnimationBuffer=function(t){var e=new Array,i;if(t)i=t;else{for(var r=0;r<this.spriteCount;r++){e.push(0,0,0,0);for(var o=1;o<(this.options.maxAnimationFrames||4);)e.push(0,0,0,0),o++}i=new Float32Array(e)}var a=kr.a.CreateRGBATexture(i,this.spriteCount,this.options.maxAnimationFrames||4,this._scene,!1,!1,Ze.a.NEAREST_NEAREST,W.a.TEXTURETYPE_FLOAT);return a},n.prototype.addAnimationToTile=function(t,e,i,r,o){t===void 0&&(t=0),e===void 0&&(e=0),i===void 0&&(i=0),r===void 0&&(r=0),o===void 0&&(o=1);var a=this._animationMap._texture._bufferView,s=t*4+this.spriteCount*4*e;if(!!a){a[s]=i,a[s+1]=r,a[s+2]=o;var c=this._createTileAnimationBuffer(a);this._animationMap.dispose(),this._animationMap=c,this._material.setTexture("animationMap",this._animationMap)}},n.prototype.saveTileMaps=function(){for(var t="",e=0;e<this._tileMaps.length;e++)e>0&&(t+=`
\r`),t+=this._tileMaps[e]._texture._bufferView.toString();var i=document.createElement("a");i.href="data:octet/stream;charset=utf-8,"+encodeURI(t),i.target="_blank",i.download=this.name+".tilemaps",i.click(),i.remove()},n.prototype.loadTileMaps=function(t){var e=this,i=new XMLHttpRequest;i.open("GET",t);var r=this.options.layerCount||0;i.onload=function(){for(var o=i.response.split(`
\r`),a=0;a<r;a++){var s=o[a].split(",").map(Number),c=e._createTileBuffer(s);e._tileMaps[a].dispose(),e._tileMaps[a]=c}e._material.setTextureArray("tileMap",e._tileMaps)},i.send()},n.prototype.dispose=function(){this._output.dispose(),this._material.dispose(),this._animationMap.dispose(),this._tileMaps.forEach(function(t){t.dispose()}),this._frameMap.dispose()},n}(),gv=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){a===void 0&&(a=null),s===void 0&&(s=.01),c===void 0&&(c=Ze.a.TRILINEAR_SAMPLINGMODE);var v=n.call(this,e,i,r,64,o,s,c,!0,a)||this;return v.name=e,v}return t}(Dd),mv=u(713),vv=u(711),Or;(function(n){n[n.INIT=0]="INIT",n[n.RUNNING=1]="RUNNING",n[n.DONE=2]="DONE",n[n.ERROR=3]="ERROR"})(Or||(Or={}));var Mr=function(){function n(t){this.name=t,this._isCompleted=!1,this._taskState=Or.INIT}return Object.defineProperty(n.prototype,"isCompleted",{get:function(){return this._isCompleted},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"taskState",{get:function(){return this._taskState},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"errorObject",{get:function(){return this._errorObject},enumerable:!1,configurable:!0}),n.prototype._setErrorObject=function(t,e){this._errorObject||(this._errorObject={message:t,exception:e})},n.prototype.run=function(t,e,i){var r=this;this._taskState=Or.RUNNING,this.runTask(t,function(){r.onDoneCallback(e,i)},function(o,a){r.onErrorCallback(i,o,a)})},n.prototype.runTask=function(t,e,i){throw new Error("runTask is not implemented")},n.prototype.reset=function(){this._taskState=Or.INIT},n.prototype.onErrorCallback=function(t,e,i){this._taskState=Or.ERROR,this._errorObject={message:e,exception:i},this.onError&&this.onError(this,e,i),t()},n.prototype.onDoneCallback=function(t,e){try{this._taskState=Or.DONE,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),t()}catch(i){this.onErrorCallback(e,"Task is done, error executing success callback(s)",i)}},n}(),Nd=function(){function n(t,e,i){this.remainingCount=t,this.totalCount=e,this.task=i}return n}(),wd=function(n){Object(h.d)(t,n);function t(e,i,r,o){var a=n.call(this,e)||this;return a.name=e,a.meshesNames=i,a.rootUrl=r,a.sceneFilename=o,a}return t.prototype.runTask=function(e,i,r){var o=this;Mi.a.LoadAssetContainer(this.rootUrl,this.sceneFilename,e,function(a){o.loadedContainer=a,o.loadedMeshes=a.meshes,o.loadedParticleSystems=a.particleSystems,o.loadedSkeletons=a.skeletons,o.loadedAnimationGroups=a.animationGroups,i()},null,function(a,s,c){r(s,c)})},t}(Mr),Vd=function(n){Object(h.d)(t,n);function t(e,i,r,o){var a=n.call(this,e)||this;return a.name=e,a.meshesNames=i,a.rootUrl=r,a.sceneFilename=o,a}return t.prototype.runTask=function(e,i,r){var o=this;Mi.a.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,function(a,s,c,v){o.loadedMeshes=a,o.loadedParticleSystems=s,o.loadedSkeletons=c,o.loadedAnimationGroups=v,i()},null,function(a,s,c){r(s,c)})},t}(Mr),Ud=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.name=e,r.url=i,r}return t.prototype.runTask=function(e,i,r){var o=this;e._loadFile(this.url,function(a){o.text=a,i()},void 0,!1,!1,function(a,s){a&&r(a.status+" "+a.statusText,s)})},t}(Mr),Gd=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.name=e,r.url=i,r}return t.prototype.runTask=function(e,i,r){var o=this;e._loadFile(this.url,function(a){o.data=a,i()},void 0,!0,!0,function(a,s){a&&r(a.status+" "+a.statusText,s)})},t}(Mr),zd=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.name=e,r.url=i,r}return t.prototype.runTask=function(e,i,r){var o=this,a=new Image;J.b.SetCorsBehavior(this.url,a),a.onload=function(){o.image=a,i()},a.onerror=function(s){r("Error loading image",s)},a.src=this.url},t}(Mr),jd=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!0),a===void 0&&(a=Ze.a.TRILINEAR_SAMPLINGMODE);var s=n.call(this,e)||this;return s.name=e,s.url=i,s.noMipmap=r,s.invertY=o,s.samplingMode=a,s}return t.prototype.runTask=function(e,i,r){var o=function(){i()},a=function(s,c){r(s,c)};this.texture=new Ze.a(this.url,e,this.noMipmap,this.invertY,this.samplingMode,o,a)},t}(Mr),Wd=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e)||this;return c.name=e,c.url=i,c.extensions=r,c.noMipmap=o,c.files=a,c.prefiltered=s,c}return t.prototype.runTask=function(e,i,r){var o=function(){i()},a=function(s,c){r(s,c)};this.texture=new pn.a(this.url,e,this.extensions,this.noMipmap,this.files,o,a,void 0,this.prefiltered)},t}(Mr),Hd=function(n){Object(h.d)(t,n);function t(e,i,r,o,a,s,c){o===void 0&&(o=!1),a===void 0&&(a=!0),s===void 0&&(s=!1),c===void 0&&(c=!1);var v=n.call(this,e)||this;return v.name=e,v.url=i,v.size=r,v.noMipmap=o,v.generateHarmonics=a,v.gammaSpace=s,v.reserved=c,v}return t.prototype.runTask=function(e,i,r){var o=function(){i()},a=function(s,c){r(s,c)};this.texture=new Cc.a(this.url,e,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,o,a)},t}(Mr),kd=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!1),a===void 0&&(a=!0);var s=n.call(this,e)||this;return s.name=e,s.url=i,s.size=r,s.noMipmap=o,s.gammaSpace=a,s}return t.prototype.runTask=function(e,i,r){var o=function(){i()},a=function(s,c){r(s,c)};this.texture=new Pc(this.url,e,this.size,this.noMipmap,this.gammaSpace,o,a)},t}(Mr),_v=function(){function n(t){this._isLoading=!1,this._tasks=new Array,this._waitingTasksCount=0,this._totalTasksCount=0,this.onTaskSuccessObservable=new _.c,this.onTaskErrorObservable=new _.c,this.onTasksDoneObservable=new _.c,this.onProgressObservable=new _.c,this.useDefaultLoadingScreen=!0,this.autoHideLoadingUI=!0,this._scene=t}return n.prototype.addContainerTask=function(t,e,i,r){var o=new wd(t,e,i,r);return this._tasks.push(o),o},n.prototype.addMeshTask=function(t,e,i,r){var o=new Vd(t,e,i,r);return this._tasks.push(o),o},n.prototype.addTextFileTask=function(t,e){var i=new Ud(t,e);return this._tasks.push(i),i},n.prototype.addBinaryFileTask=function(t,e){var i=new Gd(t,e);return this._tasks.push(i),i},n.prototype.addImageTask=function(t,e){var i=new zd(t,e);return this._tasks.push(i),i},n.prototype.addTextureTask=function(t,e,i,r,o){o===void 0&&(o=Ze.a.TRILINEAR_SAMPLINGMODE);var a=new jd(t,e,i,r,o);return this._tasks.push(a),a},n.prototype.addCubeTextureTask=function(t,e,i,r,o,a){var s=new Wd(t,e,i,r,o,a);return this._tasks.push(s),s},n.prototype.addHDRCubeTextureTask=function(t,e,i,r,o,a,s){r===void 0&&(r=!1),o===void 0&&(o=!0),a===void 0&&(a=!1),s===void 0&&(s=!1);var c=new Hd(t,e,i,r,o,a,s);return this._tasks.push(c),c},n.prototype.addEquiRectangularCubeTextureAssetTask=function(t,e,i,r,o){r===void 0&&(r=!1),o===void 0&&(o=!0);var a=new kd(t,e,i,r,o);return this._tasks.push(a),a},n.prototype.removeTask=function(t){var e=this._tasks.indexOf(t);e>-1&&this._tasks.splice(e,1)},n.prototype._decreaseWaitingTasksCount=function(t){this._waitingTasksCount--;try{this.onProgress&&this.onProgress(this._waitingTasksCount,this._totalTasksCount,t),this.onProgressObservable.notifyObservers(new Nd(this._waitingTasksCount,this._totalTasksCount,t))}catch(a){p.a.Error("Error running progress callbacks."),console.log(a)}if(this._waitingTasksCount===0){try{var e=this._tasks.slice();this.onFinish&&this.onFinish(e);for(var i=0,r=e;i<r.length;i++){var t=r[i];if(t.taskState===Or.DONE){var o=this._tasks.indexOf(t);o>-1&&this._tasks.splice(o,1)}}this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(a){p.a.Error("Error running tasks-done callbacks."),console.log(a)}this._isLoading=!1,this.autoHideLoadingUI&&this._scene.getEngine().hideLoadingUI()}},n.prototype._runTask=function(t){var e=this,i=function(){try{e.onTaskSuccess&&e.onTaskSuccess(t),e.onTaskSuccessObservable.notifyObservers(t),e._decreaseWaitingTasksCount(t)}catch(o){r("Error executing task success callbacks",o)}},r=function(o,a){t._setErrorObject(o,a),e.onTaskError&&e.onTaskError(t),e.onTaskErrorObservable.notifyObservers(t),e._decreaseWaitingTasksCount(t)};t.run(this._scene,i,r)},n.prototype.reset=function(){return this._isLoading=!1,this._tasks=new Array,this},n.prototype.load=function(){if(this._isLoading)return this;if(this._isLoading=!0,this._waitingTasksCount=this._tasks.length,this._totalTasksCount=this._tasks.length,this._waitingTasksCount===0)return this._isLoading=!1,this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(var t=0;t<this._tasks.length;t++){var e=this._tasks[t];e.taskState===Or.INIT&&this._runTask(e)}return this},n.prototype.loadAsync=function(){var t=this;return new Promise(function(e,i){if(t._isLoading){e();return}t.onTasksDoneObservable.addOnce(function(r){r&&r.length?i(r):e()}),t.load()})},n}(),yv=u(698),bv=function(){function n(t,e){this._meshesOrigins=[],this._toCenterVectors=[],this._scaledDirection=l.e.Zero(),this._newPosition=l.e.Zero(),this._centerPosition=l.e.Zero(),this._meshes=t.slice(),e?this._centerMesh=e:this._setCenterMesh();var i=this._meshes.indexOf(this._centerMesh);i>=0&&this._meshes.splice(i,1),this._centerPosition=this._centerMesh.getAbsolutePosition().clone();for(var r=0;r<this._meshes.length;r++)if(this._meshes[r]){var o=this._meshes[r];this._meshesOrigins[r]=o.getAbsolutePosition().clone(),this._toCenterVectors[r]=l.e.Zero(),o._boundingInfo&&this._centerMesh._boundingInfo&&o._boundingInfo.boundingBox.centerWorld.subtractToRef(this._centerMesh._boundingInfo.boundingBox.centerWorld,this._toCenterVectors[r])}}return n.prototype._setCenterMesh=function(){for(var t=l.e.Zero(),e=l.e.Zero(),i=Number.MAX_VALUE,r=0;r<this._meshes.length;r++)if(this._meshes[r]){var o=this._meshes[r],a=o.getBoundingInfo();a&&e.addInPlace(a.boundingBox.centerWorld)}t=e.scale(1/this._meshes.length);for(var r=0;r<this._meshes.length;r++)if(this._meshes[r]){var o=this._meshes[r],a=o.getBoundingInfo();if(a){var s=a.boundingBox.centerWorld.subtract(t).lengthSquared();s<i&&(this._centerMesh=o,i=s)}}},n.prototype.getClassName=function(){return"MeshExploder"},n.prototype.getMeshes=function(){var t=this._meshes.slice();return t.unshift(this._centerMesh),t},n.prototype.explode=function(t){t===void 0&&(t=1);for(var e=0;e<this._meshes.length;e++)this._meshes[e]&&this._meshesOrigins[e]&&this._toCenterVectors[e]&&(this._toCenterVectors[e].scaleToRef(t,this._scaledDirection),this._meshesOrigins[e].addToRef(this._scaledDirection,this._newPosition),this._meshes[e].setAbsolutePosition(this._newPosition));this._centerMesh.setAbsolutePosition(this._centerPosition)},n}(),Xd=u(611),Ev=function(){function n(t,e,i,r,o,a,s,c,v){var b=this;this.onProcessFileCallback=function(){return!0},this.loadAsync=function(C,M){return Mi.a.LoadAsync("file:",C,b._engine,M)},this._engine=t,this._currentScene=e,this._sceneLoadedCallback=i,this._progressCallback=r,this._additionalRenderLoopLogicCallback=o,this._textureLoadingCallback=a,this._startingProcessingFilesCallback=s,this._onReloadCallback=c,this._errorCallback=v}return Object.defineProperty(n,"FilesToLoad",{get:function(){return Xd.a.FilesToLoad},enumerable:!1,configurable:!0}),n.prototype.monitorElementForDragNDrop=function(t){var e=this;t&&(this._elementToMonitor=t,this._dragEnterHandler=function(i){e.drag(i)},this._dragOverHandler=function(i){e.drag(i)},this._dropHandler=function(i){e.drop(i)},this._elementToMonitor.addEventListener("dragenter",this._dragEnterHandler,!1),this._elementToMonitor.addEventListener("dragover",this._dragOverHandler,!1),this._elementToMonitor.addEventListener("drop",this._dropHandler,!1))},Object.defineProperty(n.prototype,"filesToLoad",{get:function(){return this._filesToLoad},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){!this._elementToMonitor||(this._elementToMonitor.removeEventListener("dragenter",this._dragEnterHandler),this._elementToMonitor.removeEventListener("dragover",this._dragOverHandler),this._elementToMonitor.removeEventListener("drop",this._dropHandler))},n.prototype.renderFunction=function(){if(this._additionalRenderLoopLogicCallback&&this._additionalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){var t=this._currentScene.getWaitingItemsCount();t>0&&this._textureLoadingCallback(t)}this._currentScene.render()}},n.prototype.drag=function(t){t.stopPropagation(),t.preventDefault()},n.prototype.drop=function(t){t.stopPropagation(),t.preventDefault(),this.loadFiles(t)},n.prototype._traverseFolder=function(t,e,i,r){var o=this,a=t.createReader(),s=t.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,"$1/");a.readEntries(function(c){i.count+=c.length;for(var v=0,b=c;v<b.length;v++){var C=b[v];C.isFile?C.file(function(M){M.correctName=s+M.name,e.push(M),--i.count==0&&r()}):C.isDirectory&&o._traverseFolder(C,e,i,r)}--i.count==0&&r()})},n.prototype._processFiles=function(t){for(var e=this,i=0;i<t.length;i++){var r=t[i].correctName.toLowerCase(),o=r.split(".").pop();!this.onProcessFileCallback(t[i],r,o,function(a){return e._sceneFileToLoad=a})||(Mi.a.IsPluginForExtensionAvailable("."+o)&&(this._sceneFileToLoad=t[i]),n.FilesToLoad[r]=t[i])}},n.prototype.loadFiles=function(t){var e=this;if(t&&t.dataTransfer&&t.dataTransfer.files&&(this._filesToLoad=t.dataTransfer.files),t&&t.target&&t.target.files&&(this._filesToLoad=t.target.files),!(!this._filesToLoad||this._filesToLoad.length===0)&&(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(this._filesToLoad),this._filesToLoad&&this._filesToLoad.length>0)){for(var i=new Array,r=[],o=t.dataTransfer?t.dataTransfer.items:null,a=0;a<this._filesToLoad.length;a++){var s=this._filesToLoad[a],c=s.name.toLowerCase(),v=void 0;if(s.correctName=c,o){var b=o[a];b.getAsEntry?v=b.getAsEntry():b.webkitGetAsEntry&&(v=b.webkitGetAsEntry())}v&&v.isDirectory?r.push(v):i.push(s)}if(r.length===0)this._processFiles(i),this._processReload();else for(var C={count:r.length},M=0,N=r;M<N.length;M++){var D=N[M];this._traverseFolder(D,i,C,function(){e._processFiles(i),C.count===0&&e._processReload()})}}},n.prototype._processReload=function(){this._onReloadCallback?this._onReloadCallback(this._sceneFileToLoad):this.reload()},n.prototype.reload=function(){var t=this;this._sceneFileToLoad?(this._currentScene&&(p.a.errorsCount>0&&p.a.ClearLogCache(),this._engine.stopRenderLoop()),Mi.a.ShowLoadingScreen=!1,this._engine.displayLoadingUI(),this.loadAsync(this._sceneFileToLoad,this._progressCallback).then(function(e){t._currentScene&&t._currentScene.dispose(),t._currentScene=e,t._sceneLoadedCallback&&t._sceneLoadedCallback(t._sceneFileToLoad,t._currentScene),t._currentScene.executeWhenReady(function(){t._engine.hideLoadingUI(),t._engine.runRenderLoop(function(){t.renderFunction()})})}).catch(function(e){t._engine.hideLoadingUI(),t._errorCallback&&t._errorCallback(t._sceneFileToLoad,t._currentScene,e.message)})):p.a.Error("Please provide a valid .babylon file.")},n}(),Yd=u(716),Pv=u(715),xr=function(){function n(t){t===void 0&&(t=0),this.priority=t}return n.prototype.getDescription=function(){return""},n.prototype.apply=function(t,e){return!0},n}(),ca=function(n){Object(h.d)(t,n);function t(e,i,r){e===void 0&&(e=0),i===void 0&&(i=1024),r===void 0&&(r=.5);var o=n.call(this,e)||this;return o.priority=e,o.maximumSize=i,o.step=r,o}return t.prototype.getDescription=function(){return"Reducing render target texture size to "+this.maximumSize},t.prototype.apply=function(e,i){for(var r=!0,o=0;o<e.textures.length;o++){var a=e.textures[o];if(!(!a.canRescale||a.getContext)){var s=a.getSize(),c=Math.max(s.width,s.height);c>this.maximumSize&&(a.scale(this.step),r=!1)}}return r},t}(xr),al=function(n){Object(h.d)(t,n);function t(e,i,r){e===void 0&&(e=0),i===void 0&&(i=2),r===void 0&&(r=.25);var o=n.call(this,e)||this;return o.priority=e,o.maximumScale=i,o.step=r,o._currentScale=-1,o._directionOffset=1,o}return t.prototype.getDescription=function(){return"Setting hardware scaling level to "+this._currentScale},t.prototype.apply=function(e,i){return this._currentScale===-1&&(this._currentScale=e.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,e.getEngine().setHardwareScalingLevel(this._currentScale),this._directionOffset===1?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale},t}(xr),fa=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning shadows on/off"},t.prototype.apply=function(e,i){return e.shadowsEnabled=i.isInImprovementMode,!0},t}(xr),ha=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning post-processes on/off"},t.prototype.apply=function(e,i){return e.postProcessesEnabled=i.isInImprovementMode,!0},t}(xr),da=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning lens flares on/off"},t.prototype.apply=function(e,i){return e.lensFlaresEnabled=i.isInImprovementMode,!0},t}(xr),Kd=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"},t.prototype.apply=function(e,i){return this.onApply?this.onApply(e,i):!0},t}(xr),pa=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning particles on/off"},t.prototype.apply=function(e,i){return e.particlesEnabled=i.isInImprovementMode,!0},t}(xr),sl=function(n){Object(h.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning render targets off"},t.prototype.apply=function(e,i){return e.renderTargetsEnabled=i.isInImprovementMode,!0},t}(xr),ga=function(n){Object(h.d)(t,n);function t(){var e=n!==null&&n.apply(this,arguments)||this;return e._canBeMerged=function(i){if(!(i instanceof ot.a))return!1;var r=i;return!(r.isDisposed()||!r.isVisible||!r.isEnabled()||r.instances.length>0||r.skeleton||r.hasLODLevels)},e}return Object.defineProperty(t,"UpdateSelectionTree",{get:function(){return t._UpdateSelectionTree},set:function(e){t._UpdateSelectionTree=e},enumerable:!1,configurable:!0}),t.prototype.getDescription=function(){return"Merging similar meshes together"},t.prototype.apply=function(e,i,r){for(var o=e.meshes.slice(0),a=o.length,s=0;s<a;s++){var c=new Array,v=o[s];if(!!this._canBeMerged(v)){c.push(v);for(var b=s+1;b<a;b++){var C=o[b];!this._canBeMerged(C)||C.material===v.material&&C.checkCollisions===v.checkCollisions&&(c.push(C),a--,o.splice(b,1),b--)}c.length<2||ot.a.MergeMeshes(c,void 0,!0)}}var M=e;return M.createOrUpdateSelectionOctree&&(r!=null?r&&M.createOrUpdateSelectionOctree():t.UpdateSelectionTree&&M.createOrUpdateSelectionOctree()),!0},t._UpdateSelectionTree=!1,t}(xr),ll=function(){function n(t,e){t===void 0&&(t=60),e===void 0&&(e=2e3),this.targetFrameRate=t,this.trackerDuration=e,this.optimizations=new Array}return n.prototype.addOptimization=function(t){return this.optimizations.push(t),this},n.prototype.addCustomOptimization=function(t,e,i){i===void 0&&(i=0);var r=new Kd(i);return r.onApply=t,r.onGetDescription=e,this.optimizations.push(r),this},n.LowDegradationAllowed=function(t){var e=new n(t),i=0;return e.addOptimization(new ga(i)),e.addOptimization(new fa(i)),e.addOptimization(new da(i)),i++,e.addOptimization(new ha(i)),e.addOptimization(new pa(i)),i++,e.addOptimization(new ca(i,1024)),e},n.ModerateDegradationAllowed=function(t){var e=new n(t),i=0;return e.addOptimization(new ga(i)),e.addOptimization(new fa(i)),e.addOptimization(new da(i)),i++,e.addOptimization(new ha(i)),e.addOptimization(new pa(i)),i++,e.addOptimization(new ca(i,512)),i++,e.addOptimization(new sl(i)),i++,e.addOptimization(new al(i,2)),e},n.HighDegradationAllowed=function(t){var e=new n(t),i=0;return e.addOptimization(new ga(i)),e.addOptimization(new fa(i)),e.addOptimization(new da(i)),i++,e.addOptimization(new ha(i)),e.addOptimization(new pa(i)),i++,e.addOptimization(new ca(i,256)),i++,e.addOptimization(new sl(i)),i++,e.addOptimization(new al(i,4)),e},n}(),Cv=function(){function n(t,e,i,r){var o=this;if(i===void 0&&(i=!0),r===void 0&&(r=!1),this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new _.c,this.onNewOptimizationAppliedObservable=new _.c,this.onFailureObservable=new _.c,e?this._options=e:this._options=new ll,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i)for(var a=0,s=0,c=this._options.optimizations;s<c.length;s++){var v=c[s];v.priority=a++}this._improvementMode=r,this._scene=t||Yt.a.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(function(){o._sceneDisposeObserver=null,o.dispose()})}return Object.defineProperty(n.prototype,"isInImprovementMode",{get:function(){return this._improvementMode},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentPriorityLevel",{get:function(){return this._currentPriorityLevel},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentFrameRate",{get:function(){return this._currentFrameRate},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"targetFrameRate",{get:function(){return this._targetFrameRate},set:function(t){this._targetFrameRate=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"trackerDuration",{get:function(){return this._trackerDuration},set:function(t){this._trackerDuration=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"optimizations",{get:function(){return this._options.optimizations},enumerable:!1,configurable:!0}),n.prototype.stop=function(){this._isRunning=!1},n.prototype.reset=function(){this._currentPriorityLevel=0},n.prototype.start=function(){var t=this;this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady(function(){setTimeout(function(){t._checkCurrentState()},t._trackerDuration)}))},n.prototype._checkCurrentState=function(){var t=this;if(!!this._isRunning){var e=this._scene,i=this._options;if(this._currentFrameRate=Math.round(e.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate){this._isRunning=!1,this.onSuccessObservable.notifyObservers(this);return}for(var r=!0,o=!0,a=0;a<i.optimizations.length;a++){var s=i.optimizations[a];s.priority===this._currentPriorityLevel&&(o=!1,r=r&&s.apply(e,this),this.onNewOptimizationAppliedObservable.notifyObservers(s))}if(o){this._isRunning=!1,this.onFailureObservable.notifyObservers(this);return}r&&this._currentPriorityLevel++,e.executeWhenReady(function(){setTimeout(function(){t._checkCurrentState()},t._trackerDuration)})}},n.prototype.dispose=function(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)},n.OptimizeAsync=function(t,e,i,r){var o=new n(t,e||ll.ModerateDegradationAllowed(),!1);return i&&o.onSuccessObservable.add(function(){i()}),r&&o.onFailureObservable.add(function(){r()}),o.start(),o},n}(),ma=[],ul=function(n,t){ma[n.id]||n.doNotSerialize||(t.vertexData.push(n.serializeVerticeData()),ma[n.id]=!0)},Qd=function(n,t){var e={},i=n._geometry;return i&&(n.getScene().getGeometryByID(i.id)||ul(i,t.geometries)),n.serialize&&n.serialize(e),e},Sv=function(n,t){if(n.delayLoadState===1||n.delayLoadState===0){if(n.material&&!n.material.doNotSerialize)if(n.material instanceof yo.a){if(t.multiMaterials=t.multiMaterials||[],t.materials=t.materials||[],!t.multiMaterials.some(function(s){return s.id===n.material.id})){t.multiMaterials.push(n.material.serialize());for(var e=function(s){s&&(t.materials.some(function(c){return c.id===s.id})||t.materials.push(s.serialize()))},i=0,r=n.material.subMaterials;i<r.length;i++){var o=r[i];e(o)}}}else t.materials=t.materials||[],t.materials.some(function(s){return s.id===n.material.id})||t.materials.push(n.material.serialize());var a=n._geometry;a&&(t.geometries||(t.geometries={},t.geometries.boxes=[],t.geometries.spheres=[],t.geometries.cylinders=[],t.geometries.toruses=[],t.geometries.grounds=[],t.geometries.planes=[],t.geometries.torusKnots=[],t.geometries.vertexData=[]),ul(a,t.geometries)),n.skeleton&&!n.skeleton.doNotSerialize&&(t.skeletons=t.skeletons||[],t.skeletons.push(n.skeleton.serialize())),t.meshes=t.meshes||[],t.meshes.push(Qd(n,t))}},cl=function(){function n(){}return n.ClearCache=function(){ma=[]},n.Serialize=function(t){return n._Serialize(t)},n._Serialize=function(t,e){e===void 0&&(e=!0);var i={};if(e&&!t.getEngine()._features.supportSyncTextureRead&&Ze.a.ForceSerializeBuffers&&console.warn("The serialization object may not contain the proper base64 encoded texture data! You should use the SerializeAsync method instead."),n.ClearCache(),i.useDelayedTextureLoading=t.useDelayedTextureLoading,i.autoClear=t.autoClear,i.clearColor=t.clearColor.asArray(),i.ambientColor=t.ambientColor.asArray(),i.gravity=t.gravity.asArray(),i.collisionsEnabled=t.collisionsEnabled,t.fogMode&&t.fogMode!==0&&(i.fogMode=t.fogMode,i.fogColor=t.fogColor.asArray(),i.fogStart=t.fogStart,i.fogEnd=t.fogEnd,i.fogDensity=t.fogDensity),t.isPhysicsEnabled()){var r=t.getPhysicsEngine();r&&(i.physicsEnabled=!0,i.physicsGravity=r.gravity.asArray(),i.physicsEngine=r.getPhysicsPluginName())}t.metadata&&(i.metadata=t.metadata),i.morphTargetManagers=[];for(var o=0,a=t.meshes;o<a.length;o++){var s=a[o],c=s.morphTargetManager;c&&i.morphTargetManagers.push(c.serialize())}i.lights=[];var v,b;for(v=0;v<t.lights.length;v++)b=t.lights[v],b.doNotSerialize||i.lights.push(b.serialize());for(i.cameras=[],v=0;v<t.cameras.length;v++){var C=t.cameras[v];C.doNotSerialize||i.cameras.push(C.serialize())}if(t.activeCamera&&(i.activeCameraID=t.activeCamera.id),de.a.AppendSerializedAnimations(t,i),t.animationGroups&&t.animationGroups.length>0){i.animationGroups=[];for(var M=0;M<t.animationGroups.length;M++){var N=t.animationGroups[M];i.animationGroups.push(N.serialize())}}if(t.reflectionProbes&&t.reflectionProbes.length>0)for(i.reflectionProbes=[],v=0;v<t.reflectionProbes.length;v++){var D=t.reflectionProbes[v];i.reflectionProbes.push(D.serialize())}i.materials=[],i.multiMaterials=[];var V;for(v=0;v<t.materials.length;v++)V=t.materials[v],V.doNotSerialize||i.materials.push(V.serialize());for(i.multiMaterials=[],v=0;v<t.multiMaterials.length;v++){var X=t.multiMaterials[v];i.multiMaterials.push(X.serialize())}for(t.environmentTexture&&(i.environmentTexture=t.environmentTexture.name),i.environmentIntensity=t.environmentIntensity,i.skeletons=[],v=0;v<t.skeletons.length;v++){var ee=t.skeletons[v];ee.doNotSerialize||i.skeletons.push(ee.serialize())}for(i.transformNodes=[],v=0;v<t.transformNodes.length;v++)t.transformNodes[v].doNotSerialize||i.transformNodes.push(t.transformNodes[v].serialize());i.geometries={},i.geometries.boxes=[],i.geometries.spheres=[],i.geometries.cylinders=[],i.geometries.toruses=[],i.geometries.grounds=[],i.geometries.planes=[],i.geometries.torusKnots=[],i.geometries.vertexData=[],ma=[];var ie=t.getGeometries();for(v=0;v<ie.length;v++){var ge=ie[v];ge.isReady()&&ul(ge,i.geometries)}for(i.meshes=[],v=0;v<t.meshes.length;v++){var s=t.meshes[v];if(s instanceof ot.a){var pe=s;pe.doNotSerialize||(pe.delayLoadState===1||pe.delayLoadState===0)&&i.meshes.push(Qd(pe,i))}}for(i.particleSystems=[],v=0;v<t.particleSystems.length;v++)i.particleSystems.push(t.particleSystems[v].serialize(!1));for(i.postProcesses=[],v=0;v<t.postProcesses.length;v++)i.postProcesses.push(t.postProcesses[v].serialize());t.actionManager&&(i.actions=t.actionManager.serialize("scene"));for(var te=0,Ce=t._serializableComponents;te<Ce.length;te++){var Ae=Ce[te];Ae.serialize(i)}return i},n.SerializeAsync=function(t){var e=n._Serialize(t,!1),i=[];return this._CollectPromises(e,i),Promise.all(i).then(function(){return e})},n._CollectPromises=function(t,e){if(Array.isArray(t))for(var i=function(v){var b=t[v];b instanceof Promise?e.push(b.then(function(C){return t[v]=C})):(b instanceof Object||Array.isArray(b))&&r._CollectPromises(b,e)},r=this,o=0;o<t.length;++o)i(o);else if(t instanceof Object){var a=function(v){if(t.hasOwnProperty(v)){var b=t[v];b instanceof Promise?e.push(b.then(function(C){return t[v]=C})):(b instanceof Object||Array.isArray(b))&&s._CollectPromises(b,e)}},s=this;for(var c in t)a(c)}},n.SerializeMesh=function(t,e,i){e===void 0&&(e=!1),i===void 0&&(i=!1);var r={};if(n.ClearCache(),t=t instanceof Array?t:[t],e||i)for(var o=0;o<t.length;++o)i&&t[o].getDescendants().forEach(function(a){a instanceof ot.a&&t.indexOf(a)<0&&!a.doNotSerialize&&t.push(a)}),e&&t[o].parent&&t.indexOf(t[o].parent)<0&&!t[o].parent.doNotSerialize&&t.push(t[o].parent);return t.forEach(function(a){Sv(a,r)}),r},n}(),Zd=u(663),Tv=u(566),Rv=function(){function n(t,e){if(e===void 0&&(e=null),!n.IsSupported(t))throw"Your browser does not support recording so far.";var i=t.getRenderingCanvas();if(!i)throw"The babylon engine must have a canvas to be recorded";this._canvas=i,this._canvas.isRecording=!1,this._options=Object(h.a)(Object(h.a)({},n._defaultOptions),e);var r=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(var o=0,a=this._options.audioTracks;o<a.length;o++){var s=a[o];r.addTrack(s)}this._mediaRecorder=new MediaRecorder(r,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=this._handleDataAvailable.bind(this),this._mediaRecorder.onerror=this._handleError.bind(this),this._mediaRecorder.onstop=this._handleStop.bind(this)}return n.IsSupported=function(t){var e=t.getRenderingCanvas();return!!e&&typeof e.captureStream=="function"},Object.defineProperty(n.prototype,"isRecording",{get:function(){return!!this._canvas&&this._canvas.isRecording},enumerable:!1,configurable:!0}),n.prototype.stopRecording=function(){!this._canvas||!this._mediaRecorder||!this.isRecording||(this._canvas.isRecording=!1,this._mediaRecorder.stop())},n.prototype.startRecording=function(t,e){var i=this;if(t===void 0&&(t="babylonjs.webm"),e===void 0&&(e=7),!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return e>0&&setTimeout(function(){i.stopRecording()},e*1e3),this._fileName=t,this._recordedChunks=[],this._resolve=null,this._reject=null,this._canvas.isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise(function(r,o){i._resolve=r,i._reject=o})},n.prototype.dispose=function(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null},n.prototype._handleDataAvailable=function(t){t.data.size>0&&this._recordedChunks.push(t.data)},n.prototype._handleError=function(t){if(this.stopRecording(),this._reject)this._reject(t.error);else throw new t.error},n.prototype._handleStop=function(){this.stopRecording();var t=new Blob(this._recordedChunks);this._resolve&&this._resolve(t),window.URL.createObjectURL(t),this._fileName&&J.b.Download(t,this._fileName)},n._defaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3},n}(),Io=function(){function n(){}return n.CreateScreenshot=function(t,e,i,r,o,a){o===void 0&&(o="image/png"),a===void 0&&(a=!1);var s=n._getScreenshotSize(t,e,i),c=s.height,v=s.width;if(!(c&&v)){p.a.Error("Invalid 'size' parameter !");return}J.b._ScreenshotCanvas||(J.b._ScreenshotCanvas=document.createElement("canvas")),J.b._ScreenshotCanvas.width=v,J.b._ScreenshotCanvas.height=c;var b=J.b._ScreenshotCanvas.getContext("2d"),C=t.getRenderWidth()/t.getRenderHeight(),M=v,N=M/C;N>c&&(N=c,M=N*C);var D=Math.max(0,v-M)/2,V=Math.max(0,c-N)/2;t.onEndFrameObservable.addOnce(function(){var X=t.getRenderingCanvas();b&&X&&b.drawImage(X,D,V,M,N),a?(J.b.EncodeScreenshotCanvasData(void 0,o),r&&r("")):J.b.EncodeScreenshotCanvasData(r,o)})},n.CreateScreenshotAsync=function(t,e,i,r){return r===void 0&&(r="image/png"),new Promise(function(o,a){n.CreateScreenshot(t,e,i,function(s){typeof s!="undefined"?o(s):a(new Error("Data is undefined"))},r)})},n.CreateScreenshotWithResizeAsync=function(t,e,i,r,o){return o===void 0&&(o="image/png"),new Promise(function(a,s){n.CreateScreenshot(t,e,{width:i,height:r},function(){a()},o,!0)})},n.CreateScreenshotUsingRenderTarget=function(t,e,i,r,o,a,s,c,v,b){o===void 0&&(o="image/png"),a===void 0&&(a=1),s===void 0&&(s=!1),v===void 0&&(v=!1),b===void 0&&(b=!1);var C=n._getScreenshotSize(t,e,i),M=C.height,N=C.width,D={width:N,height:M};if(!(M&&N)){p.a.Error("Invalid 'size' parameter !");return}var V=e.getScene(),X=null,ee=V.activeCameras;V.activeCameras=null,V.activeCamera!==e&&(X=V.activeCamera,V.activeCamera=e),V.render();var ie=new Cr.a("screenShot",D,V,!1,!1,0,!1,Ze.a.NEAREST_SAMPLINGMODE,void 0,b,void 0,void 0,void 0,a);ie.renderList=null,ie.samples=a,ie.renderSprites=v,t.onEndFrameObservable.addOnce(function(){ie.readPixels(void 0,void 0,void 0,!1).then(function(te){J.b.DumpData(N,M,te,r,o,c,!0),ie.dispose()})});var ge=function(){V.incrementRenderId(),V.resetCachedMaterial(),ie.render(!0),V.incrementRenderId(),V.resetCachedMaterial(),X&&(V.activeCamera=X),V.activeCameras=ee,e.getProjectionMatrix(!0),V.render()};if(s){var pe=new Uh.a("antialiasing",1,V.activeCamera);ie.addPostProcess(pe),pe.getEffect().isReady()?ge():pe.getEffect().onCompiled=function(){ge()}}else ge()},n.CreateScreenshotUsingRenderTargetAsync=function(t,e,i,r,o,a,s,c){return r===void 0&&(r="image/png"),o===void 0&&(o=1),a===void 0&&(a=!1),c===void 0&&(c=!1),new Promise(function(v,b){n.CreateScreenshotUsingRenderTarget(t,e,i,function(C){typeof C!="undefined"?v(C):b(new Error("Data is undefined"))},r,o,a,s,c)})},n._getScreenshotSize=function(t,e,i){var r=0,o=0;if(typeof i=="object"){var a=i.precision?Math.abs(i.precision):1;i.width&&i.height?(r=i.height*a,o=i.width*a):i.width&&!i.height?(o=i.width*a,r=Math.round(o/t.getAspectRatio(e))):i.height&&!i.width?(r=i.height*a,o=Math.round(r*t.getAspectRatio(e))):(o=Math.round(t.getRenderWidth()*a),r=Math.round(o/t.getAspectRatio(e)))}else isNaN(i)||(r=i,o=i);return o&&(o=Math.floor(o)),r&&(r=Math.floor(r)),{height:r|0,width:o|0}},n}();J.b.CreateScreenshot=Io.CreateScreenshot,J.b.CreateScreenshotAsync=Io.CreateScreenshotAsync,J.b.CreateScreenshotUsingRenderTarget=Io.CreateScreenshotUsingRenderTarget,J.b.CreateScreenshotUsingRenderTargetAsync=Io.CreateScreenshotUsingRenderTargetAsync;var fl;(function(n){n[n.Checkbox=0]="Checkbox",n[n.Slider=1]="Slider",n[n.Vector3=2]="Vector3",n[n.Quaternion=3]="Quaternion",n[n.Color3=4]="Color3",n[n.String=5]="String"})(fl||(fl={}));var Av=u(712),va=u(662),Ov=u(699),Mv=u(638),xv=u(629),Dv=function(){function n(){}return n._GetStorage=function(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch(e){var t={};return{getItem:function(i){var r=t[i];return r===void 0?null:r},setItem:function(i,r){t[i]=r}}}},n.ReadString=function(t,e){var i=this._Storage.getItem(t);return i!==null?i:e},n.WriteString=function(t,e){this._Storage.setItem(t,e)},n.ReadBoolean=function(t,e){var i=this._Storage.getItem(t);return i!==null?i==="true":e},n.WriteBoolean=function(t,e){this._Storage.setItem(t,e?"true":"false")},n.ReadNumber=function(t,e){var i=this._Storage.getItem(t);return i!==null?parseFloat(i):e},n.WriteNumber=function(t,e){this._Storage.setItem(t,e.toString())},n._Storage=n._GetStorage(),n}(),Iv=function(){function n(){this._trackedScene=null}return n.prototype.track=function(t){this._trackedScene=t,this._savedJSON=cl.Serialize(t)},n.prototype.getDelta=function(){if(!this._trackedScene)return null;var t=Ze.a.ForceSerializeBuffers;Ze.a.ForceSerializeBuffers=!1;var e=cl.Serialize(this._trackedScene),i={};for(var r in e)this._compareCollections(r,this._savedJSON[r],e[r],i);return Ze.a.ForceSerializeBuffers=t,i},n.prototype._compareArray=function(t,e,i,r){if(e.length===0&&i.length===0)return!0;if(e.length&&!isNaN(e[0])||i.length&&!isNaN(i[0])){if(e.length!==i.length)return!1;if(e.length===0)return!0;for(var o=0;o<e.length;o++)if(e[o]!==i[o])return r[t]=i,!1;return!0}for(var a=[],s=function(){var C=e[o],M=C.uniqueId;a.push(M);var N=i.filter(function(X){return X.uniqueId===M});if(N.length){var D=N[0],V={};c._compareObjects(C,D,V)||(r[t]||(r[t]=[]),V.__state={id:D.id||D.name},r[t].push(V))}else{var V={__state:{deleteId:C.id||C.name}};r[t].push(V)}},c=this,o=0;o<e.length;o++)s();for(var o=0;o<i.length;o++){var v=i[o],b=v.uniqueId;a.indexOf(b)===-1&&(r[t]||(r[t]=[]),r[t].push(v))}return!0},n.prototype._compareObjects=function(t,e,i){var r=!1;for(var o in t)if(!!t.hasOwnProperty(o)){var a=t[o],s=e[o],c=!1;Array.isArray(a)?c=JSON.stringify(a)!==JSON.stringify(s):(!isNaN(a)||Object.prototype.toString.call(a)=="[object String]")&&(c=a!==s),c&&(r=!0,i[o]=s)}return!r},n.prototype._compareCollections=function(t,e,i,r){if(e!==i&&e&&i){if(Array.isArray(e)&&Array.isArray(i)){if(this._compareArray(t,e,i,r))return}else if(typeof e=="object"&&typeof i=="object"){var o={};this._compareObjects(e,i,o)||(r[t]=o);return}}},n.GetShadowGeneratorById=function(t,e){for(var i=t.lights.map(function(s){return s.getShadowGenerator()}),r=0,o=i;r<o.length;r++){var a=o[r];if(a&&a.id===e)return a}return null},n.ApplyDelta=function(t,e){var i=this;typeof t=="string"&&(t=JSON.parse(t));var r=e;for(var o in t){var a=t[o],s=r[o];if(Array.isArray(s)||o==="shadowGenerators")switch(o){case"cameras":this._ApplyDeltaForEntity(a,e,e.getCameraByID.bind(e),function(c){return Z.a.Parse(c,e)});break;case"lights":this._ApplyDeltaForEntity(a,e,e.getLightByID.bind(e),function(c){return Zo.a.Parse(c,e)});break;case"shadowGenerators":this._ApplyDeltaForEntity(a,e,function(c){return i.GetShadowGeneratorById(e,c)},function(c){return pc.a.Parse(c,e)});break;case"meshes":this._ApplyDeltaForEntity(a,e,e.getMeshByID.bind(e),function(c){return ot.a.Parse(c,e,"")});break;case"skeletons":this._ApplyDeltaForEntity(a,e,e.getSkeletonById.bind(e),function(c){return ut.a.Parse(c,e)});break;case"materials":this._ApplyDeltaForEntity(a,e,e.getMaterialByID.bind(e),function(c){return Yi.a.Parse(c,e,"")});break;case"multiMaterials":this._ApplyDeltaForEntity(a,e,e.getMaterialByID.bind(e),function(c){return yo.a.Parse(c,e,"")});break;case"transformNodes":this._ApplyDeltaForEntity(a,e,e.getTransformNodeByID.bind(e),function(c){return po.a.Parse(c,e,"")});break;case"particleSystems":this._ApplyDeltaForEntity(a,e,e.getParticleSystemByID.bind(e),function(c){return mi.Parse(c,e,"")});break;case"morphTargetManagers":this._ApplyDeltaForEntity(a,e,e.getMorphTargetById.bind(e),function(c){return Kf.a.Parse(c,e)});break;case"postProcesses":this._ApplyDeltaForEntity(a,e,e.getPostProcessByName.bind(e),function(c){return ii.a.Parse(c,e,"")});break}else isNaN(s)?s.fromArray&&s.fromArray(a):r[o]=a}},n._ApplyPropertiesToEntity=function(t,e){for(var i in t){var r=t[i],o=e[i];o!==void 0&&(!isNaN(o)||Array.isArray(o)?e[i]=r:o.fromArray&&o.fromArray(r))}},n._ApplyDeltaForEntity=function(t,e,i,r){for(var o=0,a=t;o<a.length;o++){var s=a[o];if(s.__state&&s.__state.id!==void 0){var c=i(s.__state.id);c&&this._ApplyPropertiesToEntity(s,c)}else if(s.__state&&s.__state.deleteId!==void 0){var v=i(s.__state.deleteId);v==null||v.dispose()}else r(s)}},n}(),Bn;(function(n){var t=function(){function i(r,o,a,s){o===void 0&&(o=null),a===void 0&&(a=null),s===void 0&&(s=null),o=o!=null?o:function(){return 1},a=a!=null?a:function(){return 1},s=s!=null?s:function(C,M){return C===M?0:1},this._characterToIdx=new Map,this._insertionCosts=new Array(r.length),this._deletionCosts=new Array(r.length),this._substitutionCosts=new Array(r.length);for(var c,v=0;v<r.length;++v){c=r[v],this._characterToIdx.set(c,v),this._insertionCosts[v]=o(c),this._deletionCosts[v]=a(c),this._substitutionCosts[v]=new Array(r.length);for(var b=v;b<r.length;++b)this._substitutionCosts[v][b]=s(c,r[b])}}return i.prototype.serialize=function(){var r={},o=new Array(this._characterToIdx.size);return this._characterToIdx.forEach(function(a,s){o[a]=s}),r.characters=o,r.insertionCosts=this._insertionCosts,r.deletionCosts=this._deletionCosts,r.substitutionCosts=this._substitutionCosts,JSON.stringify(r)},i.Deserialize=function(r){var o=JSON.parse(r),a=new i(o.characters);return a._insertionCosts=o.insertionCosts,a._deletionCosts=o.deletionCosts,a._substitutionCosts=o.substitutionCosts,a},i.prototype.getCharacterIdx=function(r){return this._characterToIdx.get(r)},i.prototype.getInsertionCost=function(r){return this._insertionCosts[r]},i.prototype.getDeletionCost=function(r){return this._deletionCosts[r]},i.prototype.getSubstitutionCost=function(r,o){var a=Math.min(r,o),s=Math.max(r,o);return this._substitutionCosts[a][s]},i}();n.Alphabet=t;var e=function(){function i(r,o){var a=this;if(r.length>i.MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+i.MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=o,this._characters=r.map(function(s){return a._alphabet.getCharacterIdx(s)})}return i.prototype.serialize=function(){return JSON.stringify(this._characters)},i.Deserialize=function(r,o){var a=new i([],o);return a._characters=JSON.parse(r),a},i.prototype.distance=function(r){return i._distance(this,r)},i._distance=function(r,o){var a=r._alphabet;if(a!==o._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");var s=r._characters,c=o._characters,v=s.length,b=c.length,C=i._costMatrix;C[0][0]=0;for(var M=0;M<v;++M)C[M+1][0]=C[M][0]+a.getInsertionCost(s[M]);for(var M=0;M<b;++M)C[0][M+1]=C[0][M]+a.getInsertionCost(c[M]);for(var N=0;N<v;++N)for(var D=0;D<b;++D)i._insertionCost=C[N+1][D]+a.getInsertionCost(c[D]),i._deletionCost=C[N][D+1]+a.getDeletionCost(s[N]),i._substitutionCost=C[N][D]+a.getSubstitutionCost(s[N],c[D]),C[N+1][D+1]=Math.min(i._insertionCost,i._deletionCost,i._substitutionCost);return C[v][b]},i.MAX_SEQUENCE_LENGTH=256,i._costMatrix=Object(h.f)([],Array(i.MAX_SEQUENCE_LENGTH+1)).map(function(r){return new Array(i.MAX_SEQUENCE_LENGTH+1)}),i}();n.Sequence=e})(Bn||(Bn={}));var Lv=function(){function n(t){t===void 0&&(t=.01),this._points=[],this._segmentLength=t}return n.prototype.serialize=function(){return JSON.stringify(this)},n.Deserialize=function(t){var e=JSON.parse(t),i=new n(e._segmentLength);return i._points=e._points.map(function(r){return new l.e(r._x,r._y,r._z)}),i},n.prototype.getLength=function(){return this._points.length*this._segmentLength},n.prototype.add=function(t){var e=this,i=this._points.length;if(i===0)this._points.push(t.clone());else for(var r=function(){return e._segmentLength/l.e.Distance(e._points[i-1],t)},o=r();o<=1;o=r()){var a=this._points[i-1].scale(1-o);t.scaleAndAddToRef(o,a),this._points.push(a),++i}},n.prototype.resampleAtTargetResolution=function(t){var e=new n(this.getLength()/t);return this._points.forEach(function(i){e.add(i)}),e},n.prototype.tokenize=function(t){for(var e=[],i=new l.e,r=2;r<this._points.length;++r)n._transformSegmentDirToRef(this._points[r-2],this._points[r-1],this._points[r],i)&&e.push(n._tokenizeSegment(i,t));return e},n._transformSegmentDirToRef=function(t,e,i,r){var o=.98;return e.subtractToRef(t,n._forwardDir),n._forwardDir.normalize(),e.scaleToRef(-1,n._inverseFromVec),n._inverseFromVec.normalize(),Math.abs(l.e.Dot(n._forwardDir,n._inverseFromVec))>o?!1:(l.e.CrossToRef(n._forwardDir,n._inverseFromVec,n._upDir),n._upDir.normalize(),l.a.LookAtLHToRef(t,e,n._upDir,n._lookMatrix),i.subtractToRef(e,n._fromToVec),n._fromToVec.normalize(),l.e.TransformNormalToRef(n._fromToVec,n._lookMatrix,r),!0)},n._tokenizeSegment=function(t,e){n._bestMatch=0,n._score=l.e.Dot(t,e[0]),n._bestScore=n._score;for(var i=1;i<e.length;++i)n._score=l.e.Dot(t,e[i]),n._score>n._bestScore&&(n._bestMatch=i,n._bestScore=n._score);return n._bestMatch},n._forwardDir=new l.e,n._inverseFromVec=new l.e,n._upDir=new l.e,n._fromToVec=new l.e,n._lookMatrix=new l.a,n}(),Jd=function(){function n(t){this.chars=new Array(t)}return n.Generate=function(t,e,i,r,o){t===void 0&&(t=64),e===void 0&&(e=256),i===void 0&&(i=.1),r===void 0&&(r=.001),o===void 0&&(o=[]);for(var a=.001,s=a*a,c=new n(t),v=0;v<t;++v)c.chars[v]=new l.e(Math.random()-.5,Math.random()-.5,Math.random()-.5),c.chars[v].normalize();for(var v=0;v<o.length;++v)c.chars[v].copyFrom(o[v]);for(var b,C,M=new l.e,N=new l.e,D=function(ee,ie,ge){return(1-ge)*ee+ge*ie},V=0;V<e;++V){b=D(i,r,V/(e-1));for(var X=function(ee){M.copyFromFloats(0,0,0),c.chars.forEach(function(ie){c.chars[ee].subtractToRef(ie,N),C=N.lengthSquared(),C>s&&N.scaleAndAddToRef(1/(N.lengthSquared()*C),M)}),M.scaleInPlace(b),c.chars[ee].addInPlace(M),c.chars[ee].normalize()},v=o.length;v<c.chars.length;++v)X(v)}return c},n.prototype.serialize=function(){return JSON.stringify(this.chars)},n.Deserialize=function(t){for(var e=JSON.parse(t),i=new n(e.length),r=0;r<e.length;++r)i.chars[r]=new l.e(e[r]._x,e[r]._y,e[r]._z);return i},n}(),hl=function(){function n(){this._sequences=[]}return n.prototype.serialize=function(){return JSON.stringify(this._sequences.map(function(t){return t.serialize()}))},n.Deserialize=function(t,e){var i=new n;return i._sequences=JSON.parse(t).map(function(r){return Bn.Sequence.Deserialize(r,e)}),i},n.CreateFromTrajectory=function(t,e,i){return n.CreateFromTokenizationPyramid(n._getTokenizationPyramid(t,e),i)},n.CreateFromTokenizationPyramid=function(t,e){var i=new n;return i._sequences=t.map(function(r){return new Bn.Sequence(r,e)}),i},n._getTokenizationPyramid=function(t,e,i){i===void 0&&(i=n.FINEST_DESCRIPTOR_RESOLUTION);for(var r=[],o=i;o>4;o=Math.floor(o/2))r.push(t.resampleAtTargetResolution(o).tokenize(e.chars));return r},n.prototype.distance=function(t){for(var e=0,i,r=0;r<this._sequences.length;++r)i=Math.pow(2,r),e+=i*this._sequences[r].distance(t._sequences[r]);return e},n.FINEST_DESCRIPTOR_RESOLUTION=32,n}(),$d=function(){function n(t){t===void 0&&(t=[]),this._descriptors=t,this._centroidIdx=-1,this._averageDistance=0,this._refreshDescription()}return n.prototype.serialize=function(){var t={};return t.descriptors=this._descriptors.map(function(e){return e.serialize()}),t.centroidIdx=this._centroidIdx,t.averageDistance=this._averageDistance,JSON.stringify(t)},n.Deserialize=function(t,e){var i=JSON.parse(t),r=new n;return r._descriptors=i.descriptors.map(function(o){return hl.Deserialize(o,e)}),r._centroidIdx=i.centroidIdx,r._averageDistance=i.averageDistance,r},n.prototype.add=function(t){this._descriptors.push(t),this._refreshDescription()},n.prototype.getMatchCost=function(t){return t.distance(this._descriptors[this._centroidIdx])/this._averageDistance},n.prototype.getMatchMinimumDistance=function(t){return Math.min.apply(Math,this._descriptors.map(function(e){return e.distance(t)}))},n.prototype._refreshDescription=function(){var t=this;this._centroidIdx=-1;for(var e,i=this._descriptors.map(function(o){return e=0,t._descriptors.forEach(function(a){e+=o.distance(a)}),e}),r=0;r<i.length;++r)(this._centroidIdx<0||i[r]<i[this._centroidIdx])&&(this._centroidIdx=r);this._averageDistance=0,this._descriptors.forEach(function(o){t._averageDistance+=o.distance(t._descriptors[t._centroidIdx])}),this._descriptors.length>0&&(this._averageDistance=Math.max(this._averageDistance/this._descriptors.length,n.MIN_AVERAGE_DISTANCE))},n.MIN_AVERAGE_DISTANCE=1,n}(),Fv=function(){function n(){this._maximumAllowableMatchCost=4,this._nameToDescribedTrajectory=new Map}return n.prototype.serialize=function(){var t={};return t.maximumAllowableMatchCost=this._maximumAllowableMatchCost,t.vector3Alphabet=this._vector3Alphabet.serialize(),t.levenshteinAlphabet=this._levenshteinAlphabet.serialize(),t.nameToDescribedTrajectory=[],this._nameToDescribedTrajectory.forEach(function(e,i){t.nameToDescribedTrajectory.push(i),t.nameToDescribedTrajectory.push(e.serialize())}),JSON.stringify(t)},n.Deserialize=function(t){var e=JSON.parse(t),i=new n;i._maximumAllowableMatchCost=e.maximumAllowableMatchCost,i._vector3Alphabet=Jd.Deserialize(e.vector3Alphabet),i._levenshteinAlphabet=Bn.Alphabet.Deserialize(e.levenshteinAlphabet);for(var r=0;r<e.nameToDescribedTrajectory.length;r+=2)i._nameToDescribedTrajectory.set(e.nameToDescribedTrajectory[r],$d.Deserialize(e.nameToDescribedTrajectory[r+1],i._levenshteinAlphabet));return i},n.Generate=function(){for(var t=Jd.Generate(64,256,.1,.001,[l.e.Forward()]),e=new Array(t.chars.length),i=0;i<e.length;++i)e[i]=i;var r=new Bn.Alphabet(e,function(a){return a===0?0:1},function(a){return a===0?0:1},function(a,s){return Math.min(1-l.e.Dot(t.chars[a],t.chars[s]),1)}),o=new n;return o._vector3Alphabet=t,o._levenshteinAlphabet=r,o},n.prototype.addTrajectoryToClassification=function(t,e){this._nameToDescribedTrajectory.has(e)||this._nameToDescribedTrajectory.set(e,new $d),this._nameToDescribedTrajectory.get(e).add(hl.CreateFromTrajectory(t,this._vector3Alphabet,this._levenshteinAlphabet))},n.prototype.deleteClassification=function(t){return this._nameToDescribedTrajectory.delete(t)},n.prototype.classifyTrajectory=function(t){var e=this,i=hl.CreateFromTrajectory(t,this._vector3Alphabet,this._levenshteinAlphabet),r=[];if(this._nameToDescribedTrajectory.forEach(function(v,b){v.getMatchCost(i)<e._maximumAllowableMatchCost&&r.push(b)}),r.length===0)return null;for(var o=0,a=this._nameToDescribedTrajectory.get(r[o]).getMatchMinimumDistance(i),s,c=0;c<r.length;++c)s=this._nameToDescribedTrajectory.get(r[c]).getMatchMinimumDistance(i),s<a&&(a=s,o=c);return r[o]},n}(),Bv=u(725),_a=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r.options=i,r._direction=new l.e(0,0,-1),r._mat=new l.a,r._onSelectEnabled=!1,r._origin=new l.e(0,0,0),r.lastNativeXRHitResults=[],r.onHitTestResultObservable=new _.c,r._onHitTestResults=function(o){var a=o.map(function(s){var c=l.a.FromArray(s.hitMatrix);return r._xrSessionManager.scene.useRightHandedSystem||c.toggleModelMatrixHandInPlace(),r.options.worldParentNode&&c.multiplyToRef(r.options.worldParentNode.getWorldMatrix(),c),{xrHitResult:s,transformationMatrix:c}});r.lastNativeXRHitResults=o,r.onHitTestResultObservable.notifyObservers(a)},r._onSelect=function(o){!r._onSelectEnabled||t.XRHitTestWithSelectEvent(o,r._xrSessionManager.referenceSpace)},r.xrNativeFeatureName="hit-test",J.b.Warn("A newer version of this plugin is available"),r}return t.XRHitTestWithRay=function(e,i,r,o){return e.requestHitTest(i,r).then(function(a){var s=o||function(c){return!!c.hitMatrix};return a.filter(s)})},t.XRHitTestWithSelectEvent=function(e,i){var r=e.frame.getPose(e.inputSource.targetRaySpace,i);if(!r)return Promise.resolve([]);var o=new XRRay(r.transform);return this.XRHitTestWithRay(e.frame.session,o,i)},t.prototype.attach=function(){return n.prototype.attach.call(this)?(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0):!1},t.prototype.detach=function(){return n.prototype.detach.call(this)?(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onHitTestResultObservable.clear()},t.prototype._onXRFrame=function(e){if(!(!this.attached||this.options.testOnPointerDownOnly)){var i=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!!i){l.a.FromArrayToRef(i.transform.matrix,0,this._mat),l.e.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),l.e.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();var r=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});t.XRHitTestWithRay(this._xrSessionManager.session,r,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}},t.Name=ur.HIT_TEST,t.Version=1,t}(cr);or.AddWebXRFeature(_a.Name,function(n,t){return function(){return new _a(n,t)}},_a.Version,!1);var Nv=0,ya=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r._options=i,r._lastFrameDetected=new Set,r._trackedAnchors=[],r._futureAnchors=[],r.onAnchorAddedObservable=new _.c,r.onAnchorRemovedObservable=new _.c,r.onAnchorUpdatedObservable=new _.c,r._tmpVector=new l.e,r._tmpQuaternion=new l.b,r.xrNativeFeatureName="anchors",r}return Object.defineProperty(t.prototype,"referenceSpaceForFrameAnchors",{set:function(e){this._referenceSpaceForFrameAnchors=e},enumerable:!1,configurable:!0}),t.prototype._populateTmpTransformation=function(e,i){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(i),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}},t.prototype.addAnchorPointUsingHitTestResultAsync=function(e,i,r){return i===void 0&&(i=new l.e),r===void 0&&(r=new l.b),Object(h.b)(this,void 0,void 0,function(){var o,a,s,c=this;return Object(h.e)(this,function(v){switch(v.label){case 0:if(this._populateTmpTransformation(i,r),o=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),e.xrHitResult.createAnchor)return[3,1];throw this.detach(),new Error("Anchors not enabled in this environment/browser");case 1:return v.trys.push([1,3,,4]),[4,e.xrHitResult.createAnchor(o)];case 2:return a=v.sent(),[2,new Promise(function(b,C){c._futureAnchors.push({nativeAnchor:a,resolved:!1,submitted:!0,xrTransformation:o,resolve:b,reject:C})})];case 3:throw s=v.sent(),new Error(s);case 4:return[2]}})})},t.prototype.addAnchorAtPositionAndRotationAsync=function(e,i,r){return i===void 0&&(i=new l.b),r===void 0&&(r=!1),Object(h.b)(this,void 0,void 0,function(){var o,a,s,c=this;return Object(h.e)(this,function(v){switch(v.label){case 0:return this._populateTmpTransformation(e,i),o=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),r&&this.attached&&this._xrSessionManager.currentFrame?[4,this._createAnchorAtTransformation(o,this._xrSessionManager.currentFrame)]:[3,2];case 1:return s=v.sent(),[3,3];case 2:s=void 0,v.label=3;case 3:return a=s,[2,new Promise(function(b,C){c._futureAnchors.push({nativeAnchor:a,resolved:!1,submitted:!1,xrTransformation:o,resolve:b,reject:C})})]}})})},Object.defineProperty(t.prototype,"anchors",{get:function(){return this._trackedAnchors},enumerable:!1,configurable:!0}),t.prototype.detach=function(){if(!n.prototype.detach.call(this))return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){var e=this._trackedAnchors.pop();if(e){try{e.remove()}catch(i){}this.onAnchorRemovedObservable.notifyObservers(e)}}return!0},t.prototype.dispose=function(){this._futureAnchors.length=0,n.prototype.dispose.call(this),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()},t.prototype._onXRFrame=function(e){var i=this;if(!(!this.attached||!e)){var r=e.trackedAnchors;if(r){var o=this._trackedAnchors.filter(function(s){return!r.has(s.xrAnchor)}).map(function(s){var c=i._trackedAnchors.indexOf(s);return c}),a=0;o.forEach(function(s){var c=i._trackedAnchors.splice(s-a,1)[0];i.onAnchorRemovedObservable.notifyObservers(c),a++}),r.forEach(function(s){if(i._lastFrameDetected.has(s)){var M=i._findIndexInAnchorArray(s),v=i._trackedAnchors[M];try{i._updateAnchorWithXRFrame(s,v,e),v.attachedNode&&(v.attachedNode.rotationQuaternion=v.attachedNode.rotationQuaternion||new l.b,v.transformationMatrix.decompose(v.attachedNode.scaling,v.attachedNode.rotationQuaternion,v.attachedNode.position)),i.onAnchorUpdatedObservable.notifyObservers(v)}catch(D){J.b.Warn("Anchor could not be updated")}}else{var c={id:Nv++,xrAnchor:s,remove:function(){return s.delete()}},v=i._updateAnchorWithXRFrame(s,c,e);i._trackedAnchors.push(v),i.onAnchorAddedObservable.notifyObservers(v);var b=i._futureAnchors.filter(function(N){return N.nativeAnchor===s}),C=b[0];C&&(C.resolve(v),C.resolved=!0)}}),this._lastFrameDetected=r}this._futureAnchors.forEach(function(s){!s.resolved&&!s.submitted&&(i._createAnchorAtTransformation(s.xrTransformation,e).then(function(c){s.nativeAnchor=c},function(c){s.resolved=!0,s.reject(c)}),s.submitted=!0)})}},t.prototype._findIndexInAnchorArray=function(e){for(var i=0;i<this._trackedAnchors.length;++i)if(this._trackedAnchors[i].xrAnchor===e)return i;return-1},t.prototype._updateAnchorWithXRFrame=function(e,i,r){var o=r.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(o){var a=i.transformationMatrix||new l.a;l.a.FromArrayToRef(o.transform.matrix,0,a),this._xrSessionManager.scene.useRightHandedSystem||a.toggleModelMatrixHandInPlace(),i.transformationMatrix=a,this._options.worldParentNode&&a.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),a)}return i},t.prototype._createAnchorAtTransformation=function(e,i){var r;return Object(h.b)(this,void 0,void 0,function(){return Object(h.e)(this,function(o){if(i.createAnchor)try{return[2,i.createAnchor(e,(r=this._referenceSpaceForFrameAnchors)!==null&&r!==void 0?r:this._xrSessionManager.referenceSpace)]}catch(a){throw new Error(a)}else throw this.detach(),new Error("Anchors are not enabled in your browser");return[2]})})},t.Name=ur.ANCHOR_SYSTEM,t.Version=1,t}(cr);or.AddWebXRFeature(ya.Name,function(n,t){return function(){return new ya(n,t)}},ya.Version);var wv=0,ba=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r._options=i,r._detectedPlanes=[],r._enabled=!1,r._lastFrameDetected=new Set,r.onPlaneAddedObservable=new _.c,r.onPlaneRemovedObservable=new _.c,r.onPlaneUpdatedObservable=new _.c,r.xrNativeFeatureName="plane-detection",r._xrSessionManager.session?r._init():r._xrSessionManager.onXRSessionInit.addOnce(function(){r._init()}),r}return t.prototype.detach=function(){if(!n.prototype.detach.call(this))return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){var e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()},t.prototype.isCompatible=function(){return typeof XRPlane!="undefined"},t.prototype._onXRFrame=function(e){var i=this;if(!(!this.attached||!this._enabled||!e)){var r=e.worldInformation.detectedPlanes;if(r){var o=this._detectedPlanes.filter(function(s){return!r.has(s.xrPlane)}).map(function(s){return i._detectedPlanes.indexOf(s)}),a=0;o.forEach(function(s){var c=i._detectedPlanes.splice(s-a,1)[0];i.onPlaneRemovedObservable.notifyObservers(c),a++}),r.forEach(function(s){if(i._lastFrameDetected.has(s)){if(s.lastChangedTime===i._xrSessionManager.currentTimestamp){var b=i._findIndexInPlaneArray(s),v=i._detectedPlanes[b];i._updatePlaneWithXRPlane(s,v,e),i.onPlaneUpdatedObservable.notifyObservers(v)}}else{var c={id:wv++,xrPlane:s,polygonDefinition:[]},v=i._updatePlaneWithXRPlane(s,c,e);i._detectedPlanes.push(v),i.onPlaneAddedObservable.notifyObservers(v)}}),this._lastFrameDetected=r}}},t.prototype._init=function(){var e=this,i,r,o=function(){e._enabled=!0,e._detectedPlanes.length&&(e._detectedPlanes.length=0)};if(!!this._xrSessionManager.isNative&&!!this._options.preferredDetectorOptions&&!!this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),!this._xrSessionManager.session.updateWorldTrackingState){var a=(r=(i=this._xrSessionManager.session.worldTrackingState)===null||i===void 0?void 0:i.planeDetectionState)===null||r===void 0?void 0:r.enabled;a&&o();return}this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),o()},t.prototype._updatePlaneWithXRPlane=function(e,i,r){var o=this;i.polygonDefinition=e.polygon.map(function(c){var v=o._xrSessionManager.scene.useRightHandedSystem?1:-1;return new l.e(c.x,c.y,c.z*v)});var a=r.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(a){var s=i.transformationMatrix||new l.a;l.a.FromArrayToRef(a.transform.matrix,0,s),this._xrSessionManager.scene.useRightHandedSystem||s.toggleModelMatrixHandInPlace(),i.transformationMatrix=s,this._options.worldParentNode&&s.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),s)}return i},t.prototype._findIndexInPlaneArray=function(e){for(var i=0;i<this._detectedPlanes.length;++i)if(this._detectedPlanes[i].xrPlane===e)return i;return-1},t.Name=ur.PLANE_DETECTION,t.Version=1,t}(cr);or.AddWebXRFeature(ba.Name,function(n,t){return function(){return new ba(n,t)}},ba.Version);var Ea=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r.options=i,r.onBackgroundStateChangedObservable=new _.c,r}return t.prototype.attach=function(){return this._setBackgroundState(!1),n.prototype.attach.call(this)},t.prototype.detach=function(){return this._setBackgroundState(!0),n.prototype.detach.call(this)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onBackgroundStateChangedObservable.clear()},t.prototype._onXRFrame=function(e){},t.prototype._setBackgroundState=function(e){var i=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){var r=i.getMeshByName("BackgroundSkybox");r&&r.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){var o=i.getMeshByName("BackgroundPlane");o&&o.setEnabled(e)}}else{var a=i.getMeshByName("BackgroundHelper");a&&a.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach(function(s){return s.setEnabled(e)}),this.onBackgroundStateChangedObservable.notifyObservers(e)},t.Name=ur.BACKGROUND_REMOVER,t.Version=1,t}(cr);or.AddWebXRFeature(Ea.Name,function(n,t){return function(){return new Ea(n,t)}},Ea.Version,!0);var Vv=function(){function n(){}return n}(),Pa=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r._options=i,r._attachController=function(o){if(!r._controllers[o.uniqueId])if(r._xrSessionManager.scene.isPhysicsEnabled()||p.a.Warn("physics engine not enabled, skipped. Please add this controller manually."),r._options.physicsProperties.useControllerMesh&&o.inputSource.gamepad)o.onMotionControllerInitObservable.addOnce(function(C){C.onModelLoadedObservable.addOnce(function(){var M=new Xr.a(C.rootMesh,Xr.a.MeshImpostor,Object(h.a)({mass:0},r._options.physicsProperties)),N=o.grip||o.pointer;r._controllers[o.uniqueId]={xrController:o,impostor:M,oldPos:N.position.clone(),oldRotation:N.rotationQuaternion.clone()}})});else{var a=r._options.physicsProperties.impostorType||Xr.a.SphereImpostor,s=r._options.physicsProperties.impostorSize||.1,c=nr.a.CreateSphere("impostor-mesh-"+o.uniqueId,{diameterX:typeof s=="number"?s:s.width,diameterY:typeof s=="number"?s:s.height,diameterZ:typeof s=="number"?s:s.depth});c.isVisible=r._debugMode,c.isPickable=!1,c.rotationQuaternion=new l.b;var v=o.grip||o.pointer;c.position.copyFrom(v.position),c.rotationQuaternion.copyFrom(v.rotationQuaternion);var b=new Xr.a(c,a,Object(h.a)({mass:0},r._options.physicsProperties));r._controllers[o.uniqueId]={xrController:o,impostor:b,impostorMesh:c}}},r._controllers={},r._debugMode=!1,r._delta=0,r._lastTimestamp=0,r._tmpQuaternion=new l.b,r._tmpVector=new l.e,r._options.physicsProperties||(r._options.physicsProperties={}),r}return t.prototype._enablePhysicsDebug=function(){var e=this;this._debugMode=!0,Object.keys(this._controllers).forEach(function(i){var r=e._controllers[i];r.impostorMesh&&(r.impostorMesh.isVisible=!0)})},t.prototype.addController=function(e){this._attachController(e)},t.prototype.attach=function(){var e=this;if(!n.prototype.attach.call(this))return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(o){e._detachController(o.uniqueId)}),this._options.enableHeadsetImpostor){var i=this._options.headsetImpostorParams||{impostorType:Xr.a.SphereImpostor,restitution:.8,impostorSize:.3},r=i.impostorSize||.3;this._headsetMesh=nr.a.CreateSphere("headset-mesh",{diameterX:typeof r=="number"?r:r.width,diameterY:typeof r=="number"?r:r.height,diameterZ:typeof r=="number"?r:r.depth}),this._headsetMesh.rotationQuaternion=new l.b,this._headsetMesh.isVisible=!1,this._headsetImpostor=new Xr.a(this._headsetMesh,i.impostorType,Object(h.a)({mass:0},i))}return!0},t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(i){e._detachController(i)}),this._headsetMesh&&this._headsetMesh.dispose(),!0):!1},t.prototype.getHeadsetImpostor=function(){return this._headsetImpostor},t.prototype.getImpostorForController=function(e){var i=typeof e=="string"?e:e.uniqueId;return this._controllers[i]?this._controllers[i].impostor:null},t.prototype.setPhysicsProperties=function(e){this._options.physicsProperties=Object(h.a)(Object(h.a)({},this._options.physicsProperties),e)},t.prototype._onXRFrame=function(e){var i=this;this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.position),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion)),Object.keys(this._controllers).forEach(function(r){var o=i._controllers[r],a=o.xrController.grip||o.xrController.pointer,s=o.oldPos||o.impostorMesh.position,c=o.oldRotation||o.impostorMesh.rotationQuaternion;if(a.position.subtractToRef(s,i._tmpVector),i._tmpVector.scaleInPlace(1e3/i._delta),o.impostor.setLinearVelocity(i._tmpVector),i._debugMode&&console.log(i._tmpVector,"linear"),!c.equalsWithEpsilon(a.rotationQuaternion)){c.conjugateInPlace().multiplyToRef(a.rotationQuaternion,i._tmpQuaternion);var v=Math.sqrt(i._tmpQuaternion.x*i._tmpQuaternion.x+i._tmpQuaternion.y*i._tmpQuaternion.y+i._tmpQuaternion.z*i._tmpQuaternion.z);if(i._tmpVector.set(i._tmpQuaternion.x,i._tmpQuaternion.y,i._tmpQuaternion.z),v<.001)i._tmpVector.scaleInPlace(2);else{var b=2*Math.atan2(v,i._tmpQuaternion.w);i._tmpVector.scaleInPlace(b/(v*(i._delta/1e3)))}o.impostor.setAngularVelocity(i._tmpVector),i._debugMode&&console.log(i._tmpVector,i._tmpQuaternion,"angular")}s.copyFrom(a.position),c.copyFrom(a.rotationQuaternion)})},t.prototype._detachController=function(e){var i=this._controllers[e];!i||(i.impostorMesh&&i.impostorMesh.dispose(),delete this._controllers[e])},t.Name=ur.PHYSICS_CONTROLLERS,t.Version=1,t}(cr);or.AddWebXRFeature(Pa.Name,function(n,t){return function(){return new Pa(n,t)}},Pa.Version,!0);var Ca=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r.options=i,r._tmpMat=new l.a,r._tmpPos=new l.e,r._tmpQuat=new l.b,r.initHitTestSource=function(o){if(!!o){var a=new XRRay(r.options.offsetRay||{}),s={space:r.options.useReferenceSpace?o:r._xrSessionManager.viewerReferenceSpace,offsetRay:a};if(r.options.entityTypes&&(s.entityTypes=r.options.entityTypes),!s.space){J.b.Warn("waiting for viewer reference space to initialize");return}r._xrSessionManager.session.requestHitTestSource(s).then(function(c){r._xrHitTestSource&&r._xrHitTestSource.cancel(),r._xrHitTestSource=c})}},r.autoCloneTransformation=!1,r.onHitTestResultObservable=new _.c,r.paused=!1,r.xrNativeFeatureName="hit-test",J.b.Warn("Hit test is an experimental and unstable feature."),r}return t.prototype.attach=function(){var e=this;if(!n.prototype.attach.call(this)||!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this.initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this.initHitTestSource)),this.options.enableTransientHitTest){var i=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:"generic-touchscreen",offsetRay:i,entityTypes:this.options.entityTypes}).then(function(r){e._transientXrHitTestSource=r})}return!0},t.prototype.detach=function(){return n.prototype.detach.call(this)?(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this.initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onHitTestResultObservable.clear()},t.prototype._onXRFrame=function(e){var i=this;if(!(!this.attached||this.paused)){if(this._xrHitTestSource){var r=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(r)}if(this._transientXrHitTestSource){var o=e.getHitTestResultsForTransientInput(this._transientXrHitTestSource);o.forEach(function(a){i._processWebXRHitTestResult(a.results,a.inputSource)})}}},t.prototype._processWebXRHitTestResult=function(e,i){var r=this,o=[];e.forEach(function(a){var s=a.getPose(r._xrSessionManager.referenceSpace);if(!!s){var c=s.transform.position,v=s.transform.orientation;r._tmpPos.set(c.x,c.y,c.z),r._tmpQuat.set(v.x,v.y,v.z,v.w),l.a.FromFloat32ArrayToRefScaled(s.transform.matrix,0,1,r._tmpMat),r._xrSessionManager.scene.useRightHandedSystem||(r._tmpPos.z*=-1,r._tmpQuat.z*=-1,r._tmpQuat.w*=-1,r._tmpMat.toggleModelMatrixHandInPlace());var b={position:r.autoCloneTransformation?r._tmpPos.clone():r._tmpPos,rotationQuaternion:r.autoCloneTransformation?r._tmpQuat.clone():r._tmpQuat,transformationMatrix:r.autoCloneTransformation?r._tmpMat.clone():r._tmpMat,inputSource:i,isTransient:!!i,xrHitResult:a};o.push(b)}}),this.onHitTestResultObservable.notifyObservers(o)},t.Name=ur.HIT_TEST,t.Version=2,t}(cr);or.AddWebXRFeature(Ca.Name,function(n,t){return function(){return new Ca(n,t)}},Ca.Version,!1);var Sa=function(n){Object(h.d)(t,n);function t(e){var i=n.call(this,e)||this;return i._enabled=!1,i._featurePointCloud=[],i.onFeaturePointsAddedObservable=new _.c,i.onFeaturePointsUpdatedObservable=new _.c,i.xrNativeFeatureName="bjsfeature-points",i._xrSessionManager.session?i._init():i._xrSessionManager.onXRSessionInit.addOnce(function(){i._init()}),i}return Object.defineProperty(t.prototype,"featurePointCloud",{get:function(){return this._featurePointCloud},enumerable:!1,configurable:!0}),t.prototype.detach=function(){return n.prototype.detach.call(this)?(this.featurePointCloud.length=0,!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()},t.prototype._onXRFrame=function(e){if(!(!this.attached||!this._enabled||!e)){var i=e.featurePointCloud;if(!(!i||i.length===0)){if(i.length%5!=0)throw new Error("Received malformed feature point cloud of length: "+i.length);for(var r=i.length/5,o=new Array,a=new Array,s=0;s<r;s++){var c=s*5,v=i[c+4];this._featurePointCloud[v]?o.push(v):(this._featurePointCloud[v]={position:new l.e,confidenceValue:0},a.push(v)),this._featurePointCloud[v].position.x=i[c],this._featurePointCloud[v].position.y=i[c+1],this._featurePointCloud[v].position.z=i[c+2],this._featurePointCloud[v].confidenceValue=i[c+3]}a.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(a),o.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(o)}}},t.prototype._init=function(){!this._xrSessionManager.session.trySetFeaturePointCloudEnabled||!this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)||(this._enabled=!0)},t.Name=ur.FEATURE_POINTS,t.Version=1,t}(cr);or.AddWebXRFeature(Sa.Name,function(n){return function(){return new Sa(n)}},Sa.Version);var bt;(function(n){n.wrist="wrist",n["thumb-metacarpal"]="thumb-metacarpal",n["thumb-phalanx-proximal"]="thumb-phalanx-proximal",n["thumb-phalanx-distal"]="thumb-phalanx-distal",n["thumb-tip"]="thumb-tip",n["index-finger-metacarpal"]="index-finger-metacarpal",n["index-finger-phalanx-proximal"]="index-finger-phalanx-proximal",n["index-finger-phalanx-intermediate"]="index-finger-phalanx-intermediate",n["index-finger-phalanx-distal"]="index-finger-phalanx-distal",n["index-finger-tip"]="index-finger-tip",n["middle-finger-metacarpal"]="middle-finger-metacarpal",n["middle-finger-phalanx-proximal"]="middle-finger-phalanx-proximal",n["middle-finger-phalanx-intermediate"]="middle-finger-phalanx-intermediate",n["middle-finger-phalanx-distal"]="middle-finger-phalanx-distal",n["middle-finger-tip"]="middle-finger-tip",n["ring-finger-metacarpal"]="ring-finger-metacarpal",n["ring-finger-phalanx-proximal"]="ring-finger-phalanx-proximal",n["ring-finger-phalanx-intermediate"]="ring-finger-phalanx-intermediate",n["ring-finger-phalanx-distal"]="ring-finger-phalanx-distal",n["ring-finger-tip"]="ring-finger-tip",n["pinky-finger-metacarpal"]="pinky-finger-metacarpal",n["pinky-finger-phalanx-proximal"]="pinky-finger-phalanx-proximal",n["pinky-finger-phalanx-intermediate"]="pinky-finger-phalanx-intermediate",n["pinky-finger-phalanx-distal"]="pinky-finger-phalanx-distal",n["pinky-finger-tip"]="pinky-finger-tip"})(bt||(bt={}));var qd=[bt.wrist,bt["thumb-metacarpal"],bt["thumb-phalanx-proximal"],bt["thumb-phalanx-distal"],bt["thumb-tip"],bt["index-finger-metacarpal"],bt["index-finger-phalanx-proximal"],bt["index-finger-phalanx-intermediate"],bt["index-finger-phalanx-distal"],bt["index-finger-tip"],bt["middle-finger-metacarpal"],bt["middle-finger-phalanx-proximal"],bt["middle-finger-phalanx-intermediate"],bt["middle-finger-phalanx-distal"],bt["middle-finger-tip"],bt["ring-finger-metacarpal"],bt["ring-finger-phalanx-proximal"],bt["ring-finger-phalanx-intermediate"],bt["ring-finger-phalanx-distal"],bt["ring-finger-tip"],bt["pinky-finger-metacarpal"],bt["pinky-finger-phalanx-proximal"],bt["pinky-finger-phalanx-intermediate"],bt["pinky-finger-phalanx-distal"],bt["pinky-finger-tip"]],ep=function(){function n(t,e,i,r,o,a,s){var c=this;this.xrController=t,this.trackedMeshes=e,this._handMesh=i,this._rigMapping=r,this._nearInteractionMesh=a,this._leftHandedMeshes=s,this._defaultHandMesh=!1,this._transformNodeMapping=[],this._boneMapping=[],this._useBones=!1,this.onHandMeshReadyObservable=new _.c,this.handPartsDefinition=this.generateHandPartsDefinition(),this._scene=e.get("wrist").getScene(),this.onHandMeshReadyObservable.add(function(){if(!!c._rigMapping){var v=c._scene.getTransformNodeByName(c._rigMapping[0]);if(!v){var b=c._scene.getBoneByName(c._rigMapping[0]);b&&(c._useBones=!0)}}}),this._handMesh&&this._rigMapping?(this._defaultHandMesh=!1,this._handMesh.alwaysSelectAsActiveMesh=!0,this._handMesh.getChildMeshes().forEach(function(v){return v.alwaysSelectAsActiveMesh=!0}),this.onHandMeshReadyObservable.notifyObservers(this)):o||this._generateDefaultHandMesh(),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add(function(v){v.rootMesh&&v.rootMesh.setEnabled(!1)})),this.xrController.onMotionControllerInitObservable.add(function(v){v.onModelLoadedObservable.add(function(b){b.rootMesh&&b.rootMesh.setEnabled(!1)}),v.rootMesh&&v.rootMesh.setEnabled(!1)})}return n.prototype.generateHandPartsDefinition=function(){var t;return t={},t.wrist=[bt.wrist],t.thumb=[bt["thumb-metacarpal"],bt["thumb-phalanx-proximal"],bt["thumb-phalanx-distal"],bt["thumb-tip"]],t.index=[bt["index-finger-metacarpal"],bt["index-finger-phalanx-proximal"],bt["index-finger-phalanx-intermediate"],bt["index-finger-phalanx-distal"],bt["index-finger-tip"]],t.middle=[bt["middle-finger-metacarpal"],bt["middle-finger-phalanx-proximal"],bt["middle-finger-phalanx-intermediate"],bt["middle-finger-phalanx-distal"],bt["middle-finger-tip"]],t.ring=[bt["ring-finger-metacarpal"],bt["ring-finger-phalanx-proximal"],bt["ring-finger-phalanx-intermediate"],bt["ring-finger-phalanx-distal"],bt["ring-finger-tip"]],t.little=[bt["pinky-finger-metacarpal"],bt["pinky-finger-phalanx-proximal"],bt["pinky-finger-phalanx-intermediate"],bt["pinky-finger-phalanx-distal"],bt["pinky-finger-tip"]],t},Object.defineProperty(n.prototype,"handMesh",{get:function(){return this._handMesh},enumerable:!1,configurable:!0}),n.prototype.updateFromXRFrame=function(t,e,i){var r=this;i===void 0&&(i=2);var o=this.xrController.inputSource.hand;if(!!o&&(this.trackedMeshes.forEach(function(s,c){var v=o.get(c);if(v){var b=t.getJointPose(v,e);if(!b||!b.transform)return;var C=b.transform.position,M=b.transform.orientation;s.position.set(C.x,C.y,C.z),s.rotationQuaternion.set(M.x,M.y,M.z,M.w);var N=(b.radius||.008)*i;if(s.scaling.set(N,N,N),r._leftHandedMeshes&&!s.getScene().useRightHandedSystem&&(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1),r._handMesh&&r._rigMapping){var D=qd.indexOf(c);r._rigMapping[D]&&(r._useBones?(r._boneMapping[D]=r._boneMapping[D]||r._scene.getBoneByName(r._rigMapping[D]),r._boneMapping[D]&&(r._boneMapping[D].setPosition(s.position),r._boneMapping[D].setRotationQuaternion(s.rotationQuaternion),s.isVisible=!1)):(r._transformNodeMapping[D]=r._transformNodeMapping[D]||r._scene.getTransformNodeByName(r._rigMapping[D]),r._transformNodeMapping[D]&&(r._transformNodeMapping[D].position.copyFrom(s.position),r._transformNodeMapping[D].rotationQuaternion.copyFrom(s.rotationQuaternion),s.isVisible=!1)))}!r._leftHandedMeshes&&!s.getScene().useRightHandedSystem&&(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1)}}),this._nearInteractionMesh&&this.trackedMeshes.has("index-finger-tip"))){var a=this.trackedMeshes.get("index-finger-tip").position;this._nearInteractionMesh.position.set(a.x,a.y,a.z)}},n.prototype.getHandPartMeshes=function(t){var e=this;return this.handPartsDefinition[t].map(function(i){return e.trackedMeshes.get(i)})},n.prototype.dispose=function(){var t;this.trackedMeshes.forEach(function(e){return e.dispose()}),(t=this._nearInteractionMesh)===null||t===void 0||t.dispose(),this.onHandMeshReadyObservable.clear(),this._defaultHandMesh&&this._handMesh&&this._handMesh.dispose()},n.prototype._generateDefaultHandMesh=function(){return Object(h.b)(this,void 0,void 0,function(){var t,e,i,r,o,a,s,c;return Object(h.e)(this,function(v){switch(v.label){case 0:return v.trys.push([0,3,,4]),t=this.xrController.inputSource.handedness==="right"?"right":"left",e=(t==="right"?"r":"l")+"_hand_"+(this._scene.useRightHandedSystem?"r":"l")+"hs.glb",[4,Mi.a.ImportMeshAsync("","https://assets.babylonjs.com/meshes/HandMeshes/",e,this._scene)];case 1:return i=v.sent(),r={base:m.a.FromInts(116,63,203),fresnel:m.a.FromInts(149,102,229),fingerColor:m.a.FromInts(177,130,255),tipFresnel:m.a.FromInts(220,200,255)},o=new oa("leftHandShader",this._scene,{emitComments:!1}),[4,o.loadAsync("https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json")];case 2:if(v.sent(),o.build(!1),o.needDepthPrePass=!0,o.transparencyMode=Yi.a.MATERIAL_ALPHABLEND,o.alphaMode=W.a.ALPHA_COMBINE,a={base:o.getBlockByName("baseColor"),fresnel:o.getBlockByName("fresnelColor"),fingerColor:o.getBlockByName("fingerColor"),tipFresnel:o.getBlockByName("tipFresnelColor")},a.base.value=r.base,a.fresnel.value=r.fresnel,a.fingerColor.value=r.fingerColor,a.tipFresnel.value=r.tipFresnel,i.meshes[1].material=o,i.meshes[1].alwaysSelectAsActiveMesh=!0,this._defaultHandMesh=!0,this._handMesh=i.meshes[0],this._rigMapping=["wrist_","thumb_metacarpal_","thumb_proxPhalanx_","thumb_distPhalanx_","thumb_tip_","index_metacarpal_","index_proxPhalanx_","index_intPhalanx_","index_distPhalanx_","index_tip_","middle_metacarpal_","middle_proxPhalanx_","middle_intPhalanx_","middle_distPhalanx_","middle_tip_","ring_metacarpal_","ring_proxPhalanx_","ring_intPhalanx_","ring_distPhalanx_","ring_tip_","little_metacarpal_","little_proxPhalanx_","little_intPhalanx_","little_distPhalanx_","little_tip_"].map(function(b){return""+b+(t==="right"?"R":"L")}),s=this._scene.getTransformNodeByName(this._rigMapping[0]),s)s.parent&&s.parent.rotate(xe.a.Y,Math.PI);else throw new Error("could not find the wrist node");return this.onHandMeshReadyObservable.notifyObservers(this),[3,4];case 3:return c=v.sent(),J.b.Error("error loading hand mesh"),console.log(c),[3,4];case 4:return[2]}})})},n}(),Ta=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.options=i,r.onHandAddedObservable=new _.c,r.onHandRemovedObservable=new _.c,r._hands={},r._attachHand=function(o){var a,s,c,v,b,C,M,N,D,V,X,ee;if(!(!o.inputSource.hand||r._hands[o.uniqueId])){var ie=o.inputSource.hand,ge=new Map,pe=((a=r.options.jointMeshes)===null||a===void 0?void 0:a.sourceMesh)||nr.a.CreateSphere("jointParent",{diameter:1});pe.scaling.set(.01,.01,.01),pe.isVisible=!!((s=r.options.jointMeshes)===null||s===void 0?void 0:s.keepOriginalVisible);for(var te=0;te<ie.size;++te){var Ce=pe.createInstance(o.uniqueId+"-handJoint-"+te);if((c=r.options.jointMeshes)===null||c===void 0?void 0:c.onHandJointMeshGenerated){var Ae=r.options.jointMeshes.onHandJointMeshGenerated(Ce,te,o.uniqueId);Ae&&Ae!==Ce&&(Ce.dispose(),Ce=Ae)}if(Ce.isPickable=!1,(v=r.options.jointMeshes)===null||v===void 0?void 0:v.enablePhysics){var De=r.options.jointMeshes.physicsProps||{},Fe=De.impostorType!==void 0?De.impostorType:Xr.a.SphereImpostor;Ce.physicsImpostor=new Xr.a(Ce,Fe,Object(h.a)({mass:0},De))}Ce.rotationQuaternion=new l.b,((b=r.options.jointMeshes)===null||b===void 0?void 0:b.invisible)&&(Ce.isVisible=!1),ge.set(qd[te],Ce)}var We=null;((C=r.options.jointMeshes)===null||C===void 0?void 0:C.sceneForNearInteraction)&&(We=nr.a.CreateSphere(o.uniqueId+"-handJoint-indexCollidable",{},r.options.jointMeshes.sceneForNearInteraction),We.isVisible=!1,Zd.a.AddTagsTo(We,"touchEnabled"));var Pe=o.inputSource.handedness==="right"?"right":"left",Ne=((M=r.options.jointMeshes)===null||M===void 0?void 0:M.handMeshes)&&((N=r.options.jointMeshes)===null||N===void 0?void 0:N.handMeshes[Pe]),je=((D=r.options.jointMeshes)===null||D===void 0?void 0:D.rigMapping)&&((V=r.options.jointMeshes)===null||V===void 0?void 0:V.rigMapping[Pe]),Be=new ep(o,ge,Ne,je,(X=r.options.jointMeshes)===null||X===void 0?void 0:X.disableDefaultHandMesh,We,(ee=r.options.jointMeshes)===null||ee===void 0?void 0:ee.leftHandedSystemMeshes);r._hands[o.uniqueId]={handObject:Be,id:t._idCounter++},r.onHandAddedObservable.notifyObservers(Be)}},r.xrNativeFeatureName="hand-tracking",r}return t.prototype.isCompatible=function(){return typeof XRHand!="undefined"},t.prototype.attach=function(){var e=this;return n.prototype.attach.call(this)?(this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,function(i){e._detachHand(i.uniqueId)}),!0):!1},t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(Object.keys(this._hands).forEach(function(i){e._detachHand(i)}),!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onHandAddedObservable.clear()},t.prototype.getHandByControllerId=function(e){var i;return((i=this._hands[e])===null||i===void 0?void 0:i.handObject)||null},t.prototype.getHandByHandedness=function(e){var i=this,r=Object.keys(this._hands).map(function(a){return i._hands[a].handObject.xrController.inputSource.handedness}),o=r.indexOf(e);return o!==-1?this._hands[o].handObject:null},t.prototype._onXRFrame=function(e){var i=this;Object.keys(this._hands).forEach(function(r){var o;i._hands[r].handObject.updateFromXRFrame(e,i._xrSessionManager.referenceSpace,(o=i.options.jointMeshes)===null||o===void 0?void 0:o.scaleFactor)})},t.prototype._detachHand=function(e){this._hands[e]&&(this.onHandRemovedObservable.notifyObservers(this._hands[e].handObject),this._hands[e].handObject.dispose(),delete this._hands[e])},t._idCounter=0,t.Name=ur.HAND_TRACKING,t.Version=1,t}(cr);or.AddWebXRFeature(Ta.Name,function(n,t){return function(){return new Ta(n,t)}},Ta.Version,!1);var Uv=0,Ra=function(n){Object(h.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r._options=i,r._detectedMeshes=new Map,r.onMeshAddedObservable=new _.c,r.onMeshRemovedObservable=new _.c,r.onMeshUpdatedObservable=new _.c,r.xrNativeFeatureName="mesh-detection",r._xrSessionManager.session?r._init():r._xrSessionManager.onXRSessionInit.addOnce(function(){r._init()}),r}return t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(!!this._xrSessionManager.isNative&&!!this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach(function(i){e.onMeshRemovedObservable.notifyObservers(i)}),this._detectedMeshes.clear()),!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()},t.prototype._onXRFrame=function(e){var i=this,r;try{if(!this.attached||!e)return;var o=(r=e.worldInformation)===null||r===void 0?void 0:r.detectedMeshes;if(o){var a=new Set;this._detectedMeshes.forEach(function(s,c){o.has(c)||a.add(c)}),a.forEach(function(s){var c=i._detectedMeshes.get(s);c&&(i.onMeshRemovedObservable.notifyObservers(c),i._detectedMeshes.delete(s))}),o.forEach(function(s){if(i._detectedMeshes.has(s)){if(s.lastChangedTime===i._xrSessionManager.currentTimestamp){var v=i._detectedMeshes.get(s);v&&(i._updateVertexDataWithXRMesh(s,v,e),i.onMeshUpdatedObservable.notifyObservers(v))}}else{var c={id:Uv++,xrMesh:s},v=i._updateVertexDataWithXRMesh(s,c,e);i._detectedMeshes.set(s,v),i.onMeshAddedObservable.notifyObservers(v)}})}}catch(s){console.log(s.stack)}},t.prototype._init=function(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),!!this._options.preferredDetectorOptions&&!!this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))},t.prototype._updateVertexDataWithXRMesh=function(e,i,r){if(i.xrMesh=e,i.worldParentNode=this._options.worldParentNode,this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)i.positions=e.positions,i.normals=e.normals;else{i.positions=new Float32Array(e.positions.length);for(var o=0;o<e.positions.length;o+=3)i.positions[o]=e.positions[o],i.positions[o+1]=e.positions[o+1],i.positions[o+2]=-1*e.positions[o+2];if(e.normals){i.normals=new Float32Array(e.normals.length);for(var o=0;o<e.normals.length;o+=3)i.normals[o]=e.normals[o],i.normals[o+1]=e.normals[o+1],i.normals[o+2]=-1*e.normals[o+2]}}i.indices=e.indices;var a=r.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(a){var s=i.transformationMatrix||new et.k;et.k.FromArrayToRef(a.transform.matrix,0,s),this._xrSessionManager.scene.useRightHandedSystem||s.toggleModelMatrixHandInPlace(),i.transformationMatrix=s,this._options.worldParentNode&&s.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),s)}}return i},t.Name=ur.MESH_DETECTION,t.Version=1,t}(cr);or.AddWebXRFeature(Ra.Name,function(n,t){return function(){return new Ra(n,t)}},Ra.Version,!1);var Aa=function(n){Object(h.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.options=i,r.onUntrackableImageFoundObservable=new _.c,r.onTrackableImageFoundObservable=new _.c,r.onTrackedImageUpdatedObservable=new _.c,r._trackedImages=[],r.xrNativeFeatureName="image-tracking",r.options.images.length===0||(r._xrSessionManager.session?r._init():r._xrSessionManager.onXRSessionInit.addOnce(function(){r._init()})),r}return t.prototype.attach=function(){return n.prototype.attach.call(this)},t.prototype.detach=function(){return n.prototype.detach.call(this)},t.prototype.isCompatible=function(){return typeof XRImageTrackingResult!="undefined"},t.prototype.getTrackedImageById=function(e){return this._trackedImages[e]||null},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._trackedImages.forEach(function(e){e.originalBitmap.close()}),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()},t.prototype.getXRSessionInitExtension=function(){return Object(h.b)(this,void 0,void 0,function(){var e,i,r=this;return Object(h.e)(this,function(o){switch(o.label){case 0:return!this.options.images||!this.options.images.length?[2,{}]:(e=this.options.images.map(function(a){if(typeof a.src=="string"){var s=new Promise(function(c,v){if(typeof a.src=="string"){var b=new Image;b.src=a.src,b.onload=function(){b.decode().then(function(){createImageBitmap(b).then(function(C){c(C)})})},b.onerror=function(){J.b.Error("Error loading image "+a.src),v("Error loading image "+a.src)}}});return s}else return Promise.resolve(a.src)}),[4,Promise.all(e)]);case 1:return i=o.sent(),this._originalTrackingRequest=i.map(function(a,s){return{image:a,widthInMeters:r.options.images[s].estimatedRealWorldWidth}}),[2,{trackedImages:this._originalTrackingRequest}]}})})},t.prototype._onXRFrame=function(e){if(!!e.getImageTrackingResults)for(var i=e.getImageTrackingResults(),r=0,o=i;r<o.length;r++){var a=o[r],s=!1,c=a.index,v=this._trackedImages[c];if(!!v){v.xrTrackingResult=a,v.realWorldWidth!==a.measuredWidthInMeters&&(v.realWorldWidth=a.measuredWidthInMeters,s=!0);var b=e.getPose(a.imageSpace,this._xrSessionManager.referenceSpace);if(b){var C=v.transformationMatrix;l.a.FromArrayToRef(b.transform.matrix,0,C),this._xrSessionManager.scene.useRightHandedSystem||C.toggleModelMatrixHandInPlace(),s=!0}var M=a.trackingState,N=M==="emulated";v.emulated!==N&&(v.emulated=N,s=!0),s&&this.onTrackedImageUpdatedObservable.notifyObservers(v)}}},t.prototype._init=function(){return Object(h.b)(this,void 0,void 0,function(){var e,i,r,o;return Object(h.e)(this,function(a){switch(a.label){case 0:return this._xrSessionManager.session.getTrackedImageScores?[4,this._xrSessionManager.session.getTrackedImageScores()]:[2];case 1:for(e=a.sent(),i=0;i<e.length;++i)e[i]=="untrackable"?this.onUntrackableImageFoundObservable.notifyObservers(i):(r=this._originalTrackingRequest[i].image,o={id:i,originalBitmap:r,transformationMatrix:new l.a,ratio:r.width/r.height},this._trackedImages[i]=o,this.onTrackableImageFoundObservable.notifyObservers(o));return[2]}})})},t.Name=ur.IMAGE_TRACKING,t.Version=1,t}(cr);or.AddWebXRFeature(Aa.Name,function(n,t){return function(){return new Aa(n,t)}},Aa.Version,!1);var tp=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,Gv["left-right"],i,r)||this;return o._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},o.profileId="microsoft-mixed-reality",o}return t.prototype._getFilenameAndPath=function(){var e="";this.handedness==="left"?e=t.MODEL_LEFT_FILENAME:e=t.MODEL_RIGHT_FILENAME;var i="default",r=t.MODEL_BASE_URL+i+"/";return{filename:e,path:r}},t.prototype._getModelLoadingConstraints=function(){var e=Mi.a.IsPluginForExtensionAvailable(".glb");return e||p.a.Warn("glTF / glb loaded was not registered, using generic controller instead"),e},t.prototype._processLoadedModel=function(e){var i=this;!this.rootMesh||(this.getComponentIds().forEach(function(r,o){if(!i.disableAnimation&&r&&i.rootMesh){var a=i._mapping.buttons[r],s=a.rootNodeName;if(!s){p.a.Log("Skipping unknown button at index: "+o+" with mapped name: "+r);return}var c=i._getChildByName(i.rootMesh,s);if(!c){p.a.Warn("Missing button mesh with name: "+s);return}if(a.valueMesh=i._getImmediateChildByName(c,i._mapping.defaultButton.valueNodeName),a.pressedMesh=i._getImmediateChildByName(c,i._mapping.defaultButton.pressedNodeName),a.unpressedMesh=i._getImmediateChildByName(c,i._mapping.defaultButton.unpressedNodeName),a.valueMesh&&a.pressedMesh&&a.unpressedMesh){var v=i.getComponent(r);v&&v.onButtonStateChangedObservable.add(function(b){i._lerpTransform(a,b.value)},void 0,!0)}else p.a.Warn("Missing button submesh under mesh with name: "+s)}}),this.getComponentIds().forEach(function(r,o){var a=i.getComponent(r);!a.isAxes()||["x-axis","y-axis"].forEach(function(s){if(!!i.rootMesh){var c=i._mapping.axes[r][s],v=i._getChildByName(i.rootMesh,c.rootNodeName);if(!v){p.a.Warn("Missing axis mesh with name: "+c.rootNodeName);return}c.valueMesh=i._getImmediateChildByName(v,i._mapping.defaultAxis.valueNodeName),c.minMesh=i._getImmediateChildByName(v,i._mapping.defaultAxis.minNodeName),c.maxMesh=i._getImmediateChildByName(v,i._mapping.defaultAxis.maxNodeName),c.valueMesh&&c.minMesh&&c.maxMesh?a&&a.onAxisValueChangedObservable.add(function(b){var C=s==="x-axis"?b.x:b.y;i._lerpTransform(c,C,!0)},void 0,!0):p.a.Warn("Missing axis submesh under mesh with name: "+c.rootNodeName)}})}))},t.prototype._setRootMesh=function(e){this.rootMesh=new ot.a(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(var i,r=0;r<e.length;r++){var o=e[r];o.isPickable=!1,o.parent||(i=o)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0))},t.prototype._updateModel=function(){},t.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",t.MODEL_LEFT_FILENAME="left.glb",t.MODEL_RIGHT_FILENAME="right.glb",t}(An);ar.RegisterController("windows-mixed-reality",function(n,t){return new tp(t,n.gamepad,n.handedness)});var Gv={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}},dl=function(n){Object(h.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!1),a===void 0&&(a=!1);var s=n.call(this,e,zv[r],i,r)||this;return s._forceLegacyControllers=a,s.profileId="oculus-touch",s}return t.prototype._getFilenameAndPath=function(){var e="";this.handedness==="left"?e=t.MODEL_LEFT_FILENAME:e=t.MODEL_RIGHT_FILENAME;var i=this._isQuest()?t.QUEST_MODEL_BASE_URL:t.MODEL_BASE_URL;return{filename:e,path:i}},t.prototype._getModelLoadingConstraints=function(){return!0},t.prototype._processLoadedModel=function(e){var i=this,r=this._isQuest(),o=this.handedness==="right"?-1:1;this.getComponentIds().forEach(function(a){var s=a&&i.getComponent(a);s&&s.onButtonStateChangedObservable.add(function(c){if(!(!i.rootMesh||i.disableAnimation))switch(a){case"xr-standard-trigger":r||(i._modelRootNode.getChildren()[3].rotation.x=-c.value*.2,i._modelRootNode.getChildren()[3].position.y=-c.value*.005,i._modelRootNode.getChildren()[3].position.z=-c.value*.005);return;case"xr-standard-squeeze":r||(i._modelRootNode.getChildren()[4].position.x=o*c.value*.0035);return;case"xr-standard-thumbstick":return;case"a-button":case"x-button":r||(c.pressed?i._modelRootNode.getChildren()[1].position.y=-.001:i._modelRootNode.getChildren()[1].position.y=0);return;case"b-button":case"y-button":r||(c.pressed?i._modelRootNode.getChildren()[2].position.y=-.001:i._modelRootNode.getChildren()[2].position.y=0);return}},void 0,!0)})},t.prototype._setRootMesh=function(e){this.rootMesh=new ot.a(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0)),e.forEach(function(i){i.isPickable=!1}),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh},t.prototype._updateModel=function(){},t.prototype._isQuest=function(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers},t.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",t.MODEL_LEFT_FILENAME="left.babylon",t.MODEL_RIGHT_FILENAME="right.babylon",t.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",t}(An);ar.RegisterController("oculus-touch",function(n,t){return new dl(t,n.gamepad,n.handedness)}),ar.RegisterController("oculus-touch-legacy",function(n,t){return new dl(t,n.gamepad,n.handedness,!0)});var zv={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}},ip=function(n){Object(h.d)(t,n);function t(e,i,r){var o=n.call(this,e,jv[r],i,r)||this;return o.profileId="htc-vive",o}return t.prototype._getFilenameAndPath=function(){var e=t.MODEL_FILENAME,i=t.MODEL_BASE_URL;return{filename:e,path:i}},t.prototype._getModelLoadingConstraints=function(){return!0},t.prototype._processLoadedModel=function(e){var i=this;this.getComponentIds().forEach(function(r){var o=r&&i.getComponent(r);o&&o.onButtonStateChangedObservable.add(function(a){if(!(!i.rootMesh||i.disableAnimation))switch(r){case"xr-standard-trigger":i._modelRootNode.getChildren()[6].rotation.x=-a.value*.15;return;case"xr-standard-touchpad":return;case"xr-standard-squeeze":return}},void 0,!0)})},t.prototype._setRootMesh=function(e){this.rootMesh=new ot.a(this.profileId+" "+this.handedness,this.scene),e.forEach(function(i){i.isPickable=!1}),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0))},t.prototype._updateModel=function(){},t.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",t.MODEL_FILENAME="wand.babylon",t}(An);ar.RegisterController("htc-vive",function(n,t){return new ip(t,n.gamepad,n.handedness)});var jv={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}}}}]);

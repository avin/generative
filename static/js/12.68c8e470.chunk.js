(this.webpackJsonpgenerative=this.webpackJsonpgenerative||[]).push([[12,7,337,338,339,340,341],{232:function(Ue,P,u){"use strict";u.r(P),P.default=`#ifdef GL_ES
precision highp float;
#define GLSLIFY 1
#endif

// Samplers
varying vec2 vUV;
uniform sampler2D textureSampler;

void main(void) {
  vec3 col = texture2D(textureSampler, vUV).rgb;

  vec2 uv = vUV.xy;

  col *= 0.5 + 0.5 * pow(16.0 * uv.x * uv.y * (1.0 - uv.x) * (1.0 - uv.y), 0.1);

  col = clamp(col, 0.0, 1.0);
  col = col * 0.6 + 0.4 * col * col * (3.0 - 2.0 * col) + vec3(0.0, 0.0, 0.04);

  gl_FragColor = vec4(col, 1.);
}
`},233:function(Ue,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
attribute vec3 mPos;

#define MOD3 vec3(.1031, .11369, .13787)

vec3 hash33(vec3 p3) {
  p3 = fract(p3 * MOD3);
  p3 += dot(p3, p3.yxz + 19.19);
  return -1.0 + 2.0 * fract(vec3((p3.x + p3.y) * p3.z, (p3.x + p3.z) * p3.y, (p3.y + p3.z) * p3.x));
}

float nRand(vec2 n) { return fract(sin(dot(n.xy, vec2(12.9898, 78.233))) * 43758.5453); }

float noise(vec3 p) {
  const float K1 = 0.333333333;
  const float K2 = 0.166666667;

  vec3 i = floor(p + (p.x + p.y + p.z) * K1);
  vec3 d0 = p - (i - (i.x + i.y + i.z) * K2);

  vec3 e = step(vec3(0.0), d0 - d0.yzx);
  vec3 i1 = e * (1.0 - e.zxy);
  vec3 i2 = 1.0 - e.zxy * (1.0 - e);

  vec3 d1 = d0 - (i1 - 1.0 * K2);
  vec3 d2 = d0 - (i2 - 2.0 * K2);
  vec3 d3 = d0 - (1.0 - 3.0 * K2);

  vec4 h = max(0.6 - vec4(dot(d0, d0), dot(d1, d1), dot(d2, d2), dot(d3, d3)), 0.0);
  vec4 n = h * h * h * h *
           vec4(dot(d0, hash33(i)), dot(d1, hash33(i + i1)), dot(d2, hash33(i + i2)), dot(d3, hash33(i + 1.0)));

  return dot(vec4(31.316), n);
}
`},234:function(Ue,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
// ----------

//float ts = iTime * .5;
//float t = iTime * .1;
//float tScale = 1. + iTime * .5;

float ts = .15;
float t = .1 + iTime;
// float tScale = 1.5;

float mx = noise(mPos * 2. + vec3(10.) + vec3(t, 0, 0)) * ts;
float my = noise(mPos * 2. + vec3(1000.) + vec3(t, 0, 0)) * ts;
float mz = noise(mPos * 2. + vec3(2000.) + vec3(t, 0, 0)) * ts;

float tScale = noise(mPos * 2. + vec3(500.) + vec3(0, 0, 0))*.5 + .5;

positionUpdated += vec3(mx, my, mz);

positionUpdated *= smoothstep(.8, .5, tScale);
`},235:function(Ue,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
`},236:function(Ue,P,u){"use strict";u.r(P),P.default=`#define GLSLIFY 1
`},33:function(Ue,P,u){"use strict";u.r(P);var T=u(445),S=u(449),j=u(498),O=u(475),M=u(441),H=u(506),A=u(648),p=u(555),f=u(602),h=u(766),m=u(447),d=u(485),g=u(463),v=u(695),l=u(780),y=u(782),E=u(812),R=u.t(812,1),F=u(758),B=u(435),L=u(704),I=u(549),k=u(232),Z=u(233),Y=u(234),U=u(235),Q=u(236),G=(re,Re,Ie)=>new Promise((Ce,X)=>{var ae=N=>{try{w(Ie.next(N))}catch(W){X(W)}},ee=N=>{try{w(Ie.throw(N))}catch(W){X(W)}},w=N=>N.done?Ce(N.value):Promise.resolve(N.value).then(ae,ee);w((Ie=Ie.apply(re,Re)).next())});const K=[...E[0],"#ffff00"],fe={animate:!0,context:Object(I.a)()},ce=re=>G(void 0,[re],function*({canvas:Re,width:Ie,height:Ce}){const X=new T.a(Re,!0,{preserveDrawingBuffer:!0,stencil:!0}),ae=+new Date,ee=new S.a(X);ee.clearColor=M.b.FromColor3(new M.a(245/255,248/255,250/255));const w=Math.PI/4,N=Math.PI/3,W=new H.a("camera",w,N,6,new O.z(0,0,0),ee);W.wheelPrecision=50,W.minZ=.1,W.attachControl(Re,!0);const $=new j.a("hemiLight",new O.z(0,1,0),ee);$.diffuse=new M.a(1,1,1),$.groundColor=new M.a(.125,.125,.125),$.specular=new M.a(1,1,1),g.a.ShowLoadingScreen=!1,yield g.a.AppendAsync("./","static/assets/models/torus-big.glb",ee),ee.meshes.forEach(Ne=>Ne.setEnabled(!1));const J=ee.meshes.slice(1,7);let le=0,ne=0,be=0;J.forEach(Ne=>{const Le=Ne.getVerticesData(m.b.PositionKind).length/3;le+=Le*16,ne+=Le*4,be+=Le*3});const Me=new Float32Array(le),Te=new Float32Array(ne),Ae=new Float32Array(be),se=A.a.CreateSphere("sphere",{diameter:.05,segments:4},ee);let te=0;J.forEach((Ne,Le)=>{const pe=Ne.getVerticesData(m.b.PositionKind);Ne.dispose();const He=M.a.FromHexString(K[Le%K.length]).toLinearSpace().toLinearSpace();for(let rt=0;rt<pe.length/3;rt+=1){const ot=pe[rt*3+0],et=pe[rt*3+1],ht=pe[rt*3+2];O.z.GetAngleBetweenVectors(new O.z(ot,et,ht),new O.z(1,0,0),new O.z(0,1,0))<1.4&&(O.k.Translation(ot,et,ht).copyToArray(Me,te*16),Te[te*4+0]=He.r,Te[te*4+1]=He.g,Te[te*4+2]=He.b,Te[te*4+3]=1,Ae[te*3+0]=ot,Ae[te*3+1]=et,Ae[te*3+2]=ht),te+=1}}),se.thinInstanceSetBuffer("matrix",Me,16),se.thinInstanceSetBuffer("color",Te,4),se.thinInstanceSetBuffer("mPos",Ae,3);const he=new h.a("plastic",ee);he.metallic=0,he.roughness=.2,se.material=he,he.AddAttribute("mPos"),he.Vertex_Definitions(Z.default),he.Vertex_Before_PositionUpdated(Y.default),he.Fragment_Definitions(U.default),he.Fragment_Custom_Alpha(Q.default),he.AddUniform("iTime","float"),he.onBind=()=>{const Ne=(+new Date-ae)*.001;he.getEffect().setFloat("iTime",Ne)},B.a.ShadersStore.customFragmentShader=k.default,new L.PostProcess("shade-sides","custom",null,null,1,W);const de=new f.a("default",!0,ee,[W]);return de.fxaaEnabled=!0,de.samples=8,de.imageProcessingEnabled=!1,{render({time:Ne,width:Le,height:pe,frame:He,deltaTime:rt}){ee.render()},resize({pixelRatio:Ne,width:Le,height:pe}){X.resize()},unload(){X.dispose()}}});P.default={sketch:ce,settings:fe}},444:function(Ue,P,u){"use strict";u.d(P,"a",function(){return h});var T=u(434),S=u(490),j=u(438),O=u(436),M=u(534),H=u(445),A=u(500),p=u(439),f=u(437),h=function(){function m(d,g,v,l,y,E,R,F,B,L,I,k,Z,Y,U){R===void 0&&(R=1),L===void 0&&(L=null),I===void 0&&(I=0),k===void 0&&(k="postprocess"),Y===void 0&&(Y=!1),U===void 0&&(U=5),this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this._textures=new S.a(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new O.d(1,1),this._texelSize=O.d.Zero(),this.onActivateObservable=new j.c,this.onSizeChangedObservable=new j.c,this.onApplyObservable=new j.c,this.onBeforeRenderObservable=new j.c,this.onAfterRenderObservable=new j.c,this.name=d,E!=null?(this._camera=E,this._scene=E.getScene(),E.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):F&&(this._engine=F,this._engine.postProcesses.push(this)),this._options=y,this.renderTargetSamplingMode=R||1,this._reusable=B||!1,this._textureType=I,this._textureFormat=U,this._samplers=l||[],this._samplers.push("textureSampler"),this._fragmentUrl=g,this._vertexUrl=k,this._parameters=v||[],this._parameters.push("scale"),this._indexParameters=Z,Y||this.updateEffect(L)}return Object.defineProperty(m.prototype,"samples",{get:function(){return this._samples},set:function(d){var g=this;this._samples=Math.min(d,this._engine.getCaps().maxMSAASamples),this._textures.forEach(function(v){v.samples!==g._samples&&g._engine.updateRenderTargetTextureSampleCount(v,g._samples)})},enumerable:!1,configurable:!0}),m.prototype.getEffectName=function(){return this._fragmentUrl},Object.defineProperty(m.prototype,"onActivate",{set:function(d){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),d&&(this._onActivateObserver=this.onActivateObservable.add(d))},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"onSizeChanged",{set:function(d){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(d)},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"onApply",{set:function(d){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(d)},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"onBeforeRender",{set:function(d){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(d)},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"onAfterRender",{set:function(d){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(d)},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"inputTexture",{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(d){this._forcedOutputTexture=d},enumerable:!1,configurable:!0}),m.prototype.restoreDefaultInputTexture=function(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())},m.prototype.getCamera=function(){return this._camera},Object.defineProperty(m.prototype,"texelSize",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)},enumerable:!1,configurable:!0}),m.prototype.getClassName=function(){return"PostProcess"},m.prototype.getEngine=function(){return this._engine},m.prototype.getEffect=function(){return this._effect},m.prototype.shareOutputWith=function(d){return this._disposeTextures(),this._shareOutputWithPostProcess=d,this},m.prototype.useOwnOutput=function(){this._textures.length==0&&(this._textures=new S.a(2)),this._shareOutputWithPostProcess=null},m.prototype.updateEffect=function(d,g,v,l,y,E,R,F){d===void 0&&(d=null),g===void 0&&(g=null),v===void 0&&(v=null),this._postProcessDefines=d,this._effect=this._engine.createEffect({vertex:R!=null?R:this._vertexUrl,fragment:F!=null?F:this._fragmentUrl},["position"],g||this._parameters,v||this._samplers,d!==null?d:"",void 0,y,E,l||this._indexParameters)},m.prototype.isReusable=function(){return this._reusable},m.prototype.markTextureDirty=function(){this.width=-1},m.prototype._createRenderTargetTexture=function(d,g,v){v===void 0&&(v=0);for(var l=0;l<this._textureCache.length;l++)if(this._textureCache[l].texture.width===d.width&&this._textureCache[l].texture.height===d.height&&this._textureCache[l].postProcessChannel===v)return this._textureCache[l].texture;var y=this._engine.createRenderTargetTexture(d,g);return this._textureCache.push({texture:y,postProcessChannel:v,lastUsedRenderId:-1}),y},m.prototype._flushTextureCache=function(){for(var d=this._renderId,g=this._textureCache.length-1;g>=0;g--)if(d-this._textureCache[g].lastUsedRenderId>100){for(var v=!1,l=0;l<this._textures.length;l++)if(this._textures.data[l]===this._textureCache[g].texture){v=!0;break}v||(this._engine._releaseTexture(this._textureCache[g].texture),this._textureCache.splice(g,1))}},m.prototype._resize=function(d,g,v,l,y){this._textures.length>0&&this._textures.reset(),this.width=d,this.height=g;var E={width:this.width,height:this.height},R={generateMipMaps:l,generateDepthBuffer:y||v._postProcesses.indexOf(this)===0,generateStencilBuffer:(y||v._postProcesses.indexOf(this)===0)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat};this._textures.push(this._createRenderTargetTexture(E,R,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(E,R,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)},m.prototype.activate=function(d,g,v){var l=this;g===void 0&&(g=null),d=d||this._camera;var y=d.getScene(),E=y.getEngine(),R=E.getCaps().maxTextureSize,F=(g?g.width:this._engine.getRenderWidth(!0))*this._options|0,B=(g?g.height:this._engine.getRenderHeight(!0))*this._options|0,L=d.parent;L&&(L.leftCamera==d||L.rightCamera==d)&&(F/=2);var I=this._options.width||F,k=this._options.height||B,Z=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var Y=E.currentViewport;Y&&(I*=Y.width,k*=Y.height)}(Z||this.alwaysForcePOT)&&(this._options.width||(I=E.needPOTTextures?H.a.GetExponentOfTwo(I,R,this.scaleMode):I),this._options.height||(k=E.needPOTTextures?H.a.GetExponentOfTwo(k,R,this.scaleMode):k)),(this.width!==I||this.height!==k)&&this._resize(I,k,d,Z,v),this._textures.forEach(function(K){K.samples!==l.samples&&l._engine.updateRenderTargetTextureSampleCount(K,l.samples)}),this._flushTextureCache(),this._renderId++}var U;if(this._shareOutputWithPostProcess)U=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)U=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{U=this.inputTexture;for(var Q=void 0,G=0;G<this._textureCache.length;G++)if(this._textureCache[G].texture===U){Q=this._textureCache[G];break}Q&&(Q.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(F/I,B/k),this._engine.bindFramebuffer(U,0,F,B,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(U,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker("post process "+this.name+" input"),this.onActivateObservable.notifyObservers(d),this.autoClear&&this.alphaMode===0&&this._engine.clear(this.clearColor?this.clearColor:y.clearColor,y._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),U},Object.defineProperty(m.prototype,"isSupported",{get:function(){return this._effect.isSupported},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"aspectRatio",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height},enumerable:!1,configurable:!0}),m.prototype.isReady=function(){return this._effect&&this._effect.isReady()},m.prototype.apply=function(){if(!this._effect||!this._effect.isReady())return null;this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);var d;return this._shareOutputWithPostProcess?d=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?d=this._forcedOutputTexture:d=this.inputTexture,this._effect._bindTexture("textureSampler",d),this._effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effect),this._effect},m.prototype._disposeTextures=function(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()},m.prototype._disposeTextureCache=function(){for(var d=this._textureCache.length-1;d>=0;d--)this._engine._releaseTexture(this._textureCache[d].texture);this._textureCache.length=0},m.prototype.setPrePassRenderer=function(d){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=d.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1},m.prototype.dispose=function(d){d=d||this._camera,this._disposeTextures();var g;if(this._scene&&(g=this._scene.postProcesses.indexOf(this),g!==-1&&this._scene.postProcesses.splice(g,1)),g=this._engine.postProcesses.indexOf(this),g!==-1&&this._engine.postProcesses.splice(g,1),!!d){if(d.detachPostProcess(this),g=d._postProcesses.indexOf(this),g===0&&d._postProcesses.length>0){var v=this._camera._getFirstPostProcess();v&&v.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}},m.prototype.serialize=function(){var d=p.a.Serialize(this),g=this.getCamera()||this._scene&&this._scene.activeCamera;return d.customType="BABYLON."+this.getClassName(),d.cameraId=g?g.id:null,d.reusable=this._reusable,d.textureType=this._textureType,d.fragmentUrl=this._fragmentUrl,d.parameters=this._parameters,d.samplers=this._samplers,d.options=this._options,d.defines=this._postProcessDefines,d.textureFormat=this._textureFormat,d.vertexUrl=this._vertexUrl,d.indexParameters=this._indexParameters,d},m.prototype.clone=function(){var d=this.serialize();d._engine=this._engine,d.cameraId=null;var g=m.Parse(d,this._scene,"");return g?(g.onActivateObservable=this.onActivateObservable.clone(),g.onSizeChangedObservable=this.onSizeChangedObservable.clone(),g.onApplyObservable=this.onApplyObservable.clone(),g.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),g.onAfterRenderObservable=this.onAfterRenderObservable.clone(),g._prePassEffectConfiguration=this._prePassEffectConfiguration,g):null},m.Parse=function(d,g,v){var l=f.a.GetClass(d.customType);if(!l||!l._Parse)return null;var y=g?g.getCameraByID(d.cameraId):null;return l._Parse(d,y,g,v)},m._Parse=function(d,g,v,l){return p.a.Parse(function(){return new m(d.name,d.fragmentUrl,d.parameters,d.samplers,d.options,g,d.renderTargetSamplingMode,d._engine,d.reusable,d.defines,d.textureType,d.vertexUrl,d.indexParameters,!1,d.textureFormat)},d,v,l)},Object(T.c)([Object(p.c)()],m.prototype,"uniqueId",void 0),Object(T.c)([Object(p.c)()],m.prototype,"name",void 0),Object(T.c)([Object(p.c)()],m.prototype,"width",void 0),Object(T.c)([Object(p.c)()],m.prototype,"height",void 0),Object(T.c)([Object(p.c)()],m.prototype,"renderTargetSamplingMode",void 0),Object(T.c)([Object(p.f)()],m.prototype,"clearColor",void 0),Object(T.c)([Object(p.c)()],m.prototype,"autoClear",void 0),Object(T.c)([Object(p.c)()],m.prototype,"alphaMode",void 0),Object(T.c)([Object(p.c)()],m.prototype,"alphaConstants",void 0),Object(T.c)([Object(p.c)()],m.prototype,"enablePixelPerfectMode",void 0),Object(T.c)([Object(p.c)()],m.prototype,"forceFullscreenViewport",void 0),Object(T.c)([Object(p.c)()],m.prototype,"scaleMode",void 0),Object(T.c)([Object(p.c)()],m.prototype,"alwaysForcePOT",void 0),Object(T.c)([Object(p.c)("samples")],m.prototype,"_samples",void 0),Object(T.c)([Object(p.c)()],m.prototype,"adaptScaleToCurrentViewport",void 0),m}();f.a.RegisteredTypes["BABYLON.PostProcess"]=h},458:function(Ue,P,u){"use strict";u.d(P,"a",function(){return m});var T=u(434),S=u(438),j=u(443),O=u(436),M=u(442),H=u(590),A=u(591),p=u(500),f=u(522),h=u(445),m=function(d){Object(T.d)(g,d);function g(v,l,y,E,R,F,B,L,I,k,Z,Y,U,Q){R===void 0&&(R=!0),F===void 0&&(F=0),B===void 0&&(B=!1),L===void 0&&(L=M.a.TRILINEAR_SAMPLINGMODE),I===void 0&&(I=!0),k===void 0&&(k=!1),Z===void 0&&(Z=!1),Y===void 0&&(Y=5),U===void 0&&(U=!1);var G,K=d.call(this,null,y,!E,void 0,L,void 0,void 0,void 0,void 0,Y)||this;return K.renderParticles=!0,K.renderSprites=!1,K.ignoreCameraViewport=!1,K.onBeforeBindObservable=new S.c,K.onAfterUnbindObservable=new S.c,K.onBeforeRenderObservable=new S.c,K.onAfterRenderObservable=new S.c,K.onClearObservable=new S.c,K.onResizeObservable=new S.c,K._currentRefreshId=-1,K._refreshRate=1,K._samples=1,K.boundingBoxPosition=O.e.Zero(),y=K.getScene(),!y||(K._coordinatesMode=M.a.PROJECTION_MODE,K.renderList=new Array,K.name=v,K.isRenderTarget=!0,K._initialSizeParameter=l,K._processSizeParameter(l),K._resizeObserver=K.getScene().getEngine().onResizeObservable.add(function(){}),K._generateMipMaps=!!E,K._doNotChangeAspectRatio=R,K._renderingManager=new A.b(y),K._renderingManager._useSceneAutoClearSetup=!0,Z)||(K._renderTargetOptions={generateMipMaps:E,type:F,format:(G=K._format)!==null&&G!==void 0?G:void 0,samplingMode:K.samplingMode,generateDepthBuffer:I,generateStencilBuffer:k,samples:Q},K.samplingMode===M.a.NEAREST_SAMPLINGMODE&&(K.wrapU=M.a.CLAMP_ADDRESSMODE,K.wrapV=M.a.CLAMP_ADDRESSMODE),U||(B?(K._texture=y.getEngine().createRenderTargetCubeTexture(K.getRenderSize(),K._renderTargetOptions),K.coordinatesMode=M.a.INVCUBIC_MODE,K._textureMatrix=O.a.Identity()):K._texture=y.getEngine().createRenderTargetTexture(K._size,K._renderTargetOptions),Q!==void 0&&(K.samples=Q))),K}return Object.defineProperty(g.prototype,"renderList",{get:function(){return this._renderList},set:function(v){this._renderList=v,this._renderList&&this._hookArray(this._renderList)},enumerable:!1,configurable:!0}),g.prototype._hookArray=function(v){var l=this,y=v.push;v.push=function(){for(var R=[],F=0;F<arguments.length;F++)R[F]=arguments[F];var B=v.length===0,L=y.apply(v,R);return B&&l.getScene()&&l.getScene().meshes.forEach(function(I){I._markSubMeshesAsLightDirty()}),L};var E=v.splice;v.splice=function(R,F){var B=E.apply(v,[R,F]);return v.length===0&&l.getScene().meshes.forEach(function(L){L._markSubMeshesAsLightDirty()}),B}},Object.defineProperty(g.prototype,"postProcesses",{get:function(){return this._postProcesses},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"_prePassEnabled",{get:function(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"onAfterUnbind",{set:function(v){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(v)},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"onBeforeRender",{set:function(v){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(v)},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"onAfterRender",{set:function(v){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(v)},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"onClear",{set:function(v){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(v)},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"renderTargetOptions",{get:function(){return this._renderTargetOptions},enumerable:!1,configurable:!0}),g.prototype._onRatioRescale=function(){this._sizeRatio&&this.resize(this._initialSizeParameter)},Object.defineProperty(g.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(v){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(v))){this._boundingBoxSize=v;var l=this.getScene();l&&l.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"depthStencilTexture",{get:function(){var v;return((v=this.getInternalTexture())===null||v===void 0?void 0:v._depthStencilTexture)||null},enumerable:!1,configurable:!0}),g.prototype.createDepthStencilTexture=function(v,l,y,E){var R;v===void 0&&(v=0),l===void 0&&(l=!0),y===void 0&&(y=!1),E===void 0&&(E=1);var F=this.getInternalTexture();if(!(!this.getScene()||!F)){(R=F._depthStencilTexture)===null||R===void 0||R.dispose();var B=this.getScene().getEngine();F._depthStencilTexture=B.createDepthStencilTexture(this._size,{bilinearFiltering:l,comparisonFunction:v,generateStencil:y,isCube:this.isCube,samples:E})}},g.prototype._processSizeParameter=function(v){if(v.ratio){this._sizeRatio=v.ratio;var l=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(l.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(l.getRenderHeight(),this._sizeRatio)}}else this._size=v},Object.defineProperty(g.prototype,"samples",{get:function(){return this._samples},set:function(v){if(this._samples!==v){var l=this.getScene();!l||(this._samples=l.getEngine().updateRenderTargetTextureSampleCount(this._texture,v))}},enumerable:!1,configurable:!0}),g.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(g.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(v){this._refreshRate=v,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),g.prototype.addPostProcess=function(v){if(!this._postProcessManager){var l=this.getScene();if(!l)return;this._postProcessManager=new H.a(l),this._postProcesses=new Array}this._postProcesses.push(v),this._postProcesses[0].autoClear=!1},g.prototype.clearPostProcesses=function(v){if(v===void 0&&(v=!1),!!this._postProcesses){if(v)for(var l=0,y=this._postProcesses;l<y.length;l++){var E=y[l];E.dispose()}this._postProcesses=[]}},g.prototype.removePostProcess=function(v){if(!!this._postProcesses){var l=this._postProcesses.indexOf(v);l!==-1&&(this._postProcesses.splice(l,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}},g.prototype._shouldRender=function(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},g.prototype.getRenderSize=function(){return this.getRenderWidth()},g.prototype.getRenderWidth=function(){return this._size.width?this._size.width:this._size},g.prototype.getRenderHeight=function(){return this._size.width?this._size.height:this._size},g.prototype.getRenderLayers=function(){var v=this._size.layers;return v||0},Object.defineProperty(g.prototype,"canRescale",{get:function(){return!0},enumerable:!1,configurable:!0}),g.prototype.scale=function(v){var l=Math.max(1,this.getRenderSize()*v);this.resize(l)},g.prototype.getReflectionTextureMatrix=function(){return this.isCube?this._textureMatrix:d.prototype.getReflectionTextureMatrix.call(this)},g.prototype.resize=function(v){var l=this.isCube;this.releaseInternalTexture();var y=this.getScene();!y||(this._processSizeParameter(v),l?this._texture=y.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._texture=y.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))},g.prototype.render=function(v,l){v===void 0&&(v=!1),l===void 0&&(l=!1);var y=this.getScene();if(!!y){var E=y.getEngine();if(this.useCameraPostProcesses!==void 0&&(v=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(var R=0;R<this._waitingRenderList.length;R++){var F=this._waitingRenderList[R],B=y.getMeshByID(F);B&&this.renderList.push(B)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];var y=this.getScene();if(!y)return;for(var L=y.meshes,R=0;R<L.length;R++){var I=L[R];this.renderListPredicate(I)&&this.renderList.push(I)}}this.onBeforeBindObservable.notifyObservers(this);var k;if(this.activeCamera?(k=this.activeCamera,E.setViewport(this.activeCamera.viewport,this.getRenderWidth(),this.getRenderHeight()),this.activeCamera!==y.activeCamera&&y.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(!0))):(k=y.activeCamera,k&&E.setViewport(k.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1,this.is2DArray)for(var Z=0;Z<this.getRenderLayers();Z++)this.renderToTarget(0,v,l,Z,k),y.incrementRenderId(),y.resetCachedMaterial();else if(this.isCube)for(var Y=0;Y<6;Y++)this.renderToTarget(Y,v,l,void 0,k),y.incrementRenderId(),y.resetCachedMaterial();else this.renderToTarget(0,v,l,void 0,k);this.onAfterUnbindObservable.notifyObservers(this),y.activeCamera&&((y.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==y.activeCamera)&&y.setTransformMatrix(y.activeCamera.getViewMatrix(),y.activeCamera.getProjectionMatrix(!0)),E.setViewport(y.activeCamera.viewport)),y.resetCachedMaterial()}},g.prototype._bestReflectionRenderTargetDimension=function(v,l){var y=128,E=v*l,R=h.a.NearestPOT(E+y*y/(y+E));return Math.min(h.a.FloorPOT(v),R)},g.prototype._prepareRenderingManager=function(v,l,y,E){var R=this.getScene();if(!!R){this._renderingManager.reset();for(var F=R.getRenderId(),B=0;B<l;B++){var L=v[B];if(L&&!L.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(L,this.refreshRate)){this.resetRefreshCounter();continue}}else if(!L.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!L._internalAbstractMeshDataInfo._currentLODIsUpToDate&&R.activeCamera&&(L._internalAbstractMeshDataInfo._currentLOD=R.customLODSelector?R.customLODSelector(L,R.activeCamera):L.getLOD(R.activeCamera),L._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!L._internalAbstractMeshDataInfo._currentLOD)continue;var I=L._internalAbstractMeshDataInfo._currentLOD;I._preActivateForIntermediateRendering(F);var k=void 0;if(E&&y?k=(L.layerMask&y.layerMask)==0:k=!1,L.isEnabled()&&L.isVisible&&L.subMeshes&&!k&&(I!==L&&I._activate(F,!0),L._activate(F,!0)&&L.subMeshes.length)){L.isAnInstance?L._internalAbstractMeshDataInfo._actAsRegularMesh&&(I=L):I._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,I._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(var Z=0;Z<I.subMeshes.length;Z++){var Y=I.subMeshes[Z];this._renderingManager.dispatch(Y,I)}}}}for(var U=0;U<R.particleSystems.length;U++){var Q=R.particleSystems[U],G=Q.emitter;!Q.isStarted()||!G||!G.position||!G.isEnabled()||v.indexOf(G)>=0&&this._renderingManager.dispatchParticles(Q)}}},g.prototype._bindFrameBuffer=function(v,l){v===void 0&&(v=0),l===void 0&&(l=0);var y=this.getScene();if(!!y){var E=y.getEngine();this._texture&&E.bindFramebuffer(this._texture,this.isCube?v:void 0,void 0,void 0,this.ignoreCameraViewport,0,l)}},g.prototype.unbindFrameBuffer=function(v,l){var y=this;!this._texture||v.unBindFramebuffer(this._texture,this.isCube,function(){y.onAfterRenderObservable.notifyObservers(l)})},g.prototype._prepareFrame=function(v,l,y,E){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!E||!v.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(l,y)},g.prototype.renderToTarget=function(v,l,y,E,R){E===void 0&&(E=0),R===void 0&&(R=null);var F=this.getScene();if(!!F){var B=F.getEngine();if(!!this._texture){B._debugPushGroup("render to face #"+v+" layer #"+E,1),this._prepareFrame(F,v,E,l),this.is2DArray?this.onBeforeRenderObservable.notifyObservers(E):this.onBeforeRenderObservable.notifyObservers(v);var L=null,I=this.renderList?this.renderList:F.getActiveMeshes().data,k=this.renderList?this.renderList.length:F.getActiveMeshes().length;this.getCustomRenderList&&(L=this.getCustomRenderList(this.is2DArray?E:v,I,k)),L?this._prepareRenderingManager(L,L.length,R,!1):(this._defaultRenderListPrepared||(this._prepareRenderingManager(I,k,R,!this.renderList),this._defaultRenderListPrepared=!0),L=I);for(var Z=0,Y=F._beforeRenderTargetClearStage;Z<Y.length;Z++){var U=Y[Z];U.action(this,v,E)}this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(B):B.clear(this.clearColor||F.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||F.updateTransformMatrix(!0);for(var Q=0,G=F._beforeRenderTargetDrawStage;Q<G.length;Q++){var U=G[Q];U.action(this,v,E)}this._renderingManager.render(this.customRenderFunction,L,this.renderParticles,this.renderSprites);for(var K=0,fe=F._afterRenderTargetDrawStage;K<fe.length;K++){var U=fe[K];U.action(this,v,E)}var ce=this._texture.generateMipMaps;this._texture.generateMipMaps=!1,this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._texture,v,this._postProcesses,this.ignoreCameraViewport):l&&F.postProcessManager._finalizeFrame(!1,this._texture,v),this._texture.generateMipMaps=ce,this._doNotChangeAspectRatio||F.updateTransformMatrix(!0),y&&j.b.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),B),this.unbindFrameBuffer(B,v),this.isCube&&v===5&&B.generateMipMapsForCubemap(this._texture),B._debugPopGroup(1)}}},g.prototype.setRenderingOrder=function(v,l,y,E){l===void 0&&(l=null),y===void 0&&(y=null),E===void 0&&(E=null),this._renderingManager.setRenderingOrder(v,l,y,E)},g.prototype.setRenderingAutoClearDepthStencil=function(v,l){this._renderingManager.setRenderingAutoClearDepthStencil(v,l),this._renderingManager._useSceneAutoClearSetup=!1},g.prototype.clone=function(){var v=this.getSize(),l=new g(this.name,v,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return l.hasAlpha=this.hasAlpha,l.level=this.level,l.coordinatesMode=this.coordinatesMode,this.renderList&&(l.renderList=this.renderList.slice(0)),l},g.prototype.serialize=function(){if(!this.name)return null;var v=d.prototype.serialize.call(this);if(v.renderTargetSize=this.getRenderSize(),v.renderList=[],this.renderList)for(var l=0;l<this.renderList.length;l++)v.renderList.push(this.renderList[l].id);return v},g.prototype.disposeFramebufferObjects=function(){var v=this.getInternalTexture(),l=this.getScene();v&&l&&l.getEngine()._releaseFramebufferObjects(v)},g.prototype.dispose=function(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;var v=this.getScene();if(!!v){var l=v.customRenderTargets.indexOf(this);l>=0&&v.customRenderTargets.splice(l,1);for(var y=0,E=v.cameras;y<E.length;y++){var R=E[y];l=R.customRenderTargets.indexOf(this),l>=0&&R.customRenderTargets.splice(l,1)}this.depthStencilTexture&&this.getScene().getEngine()._releaseTexture(this.depthStencilTexture),d.prototype.dispose.call(this)}},g.prototype._rebuild=function(){this.refreshRate===g.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=g.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()},g.prototype.freeRenderingGroups=function(){this._renderingManager&&this._renderingManager.freeRenderingGroups()},g.prototype.getViewCount=function(){return 1},g.REFRESHRATE_RENDER_ONCE=0,g.REFRESHRATE_RENDER_ONEVERYFRAME=1,g.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,g}(M.a);M.a._CreateRenderTargetTexture=function(d,g,v,l){return new m(d,g,v,l)}},461:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(449),S=u(438),j=u(464),O=u(448),M=u(498),H=u(436),A=u(441),p=function(){function f(h,m){var d=this;m===void 0&&(m=!0),this.originalScene=h,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.onPointerOutObservable=new S.c,this.utilityLayerScene=new T.a(h.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=h.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.detachControl(),m&&(this._originalPointerObserver=h.onPrePointerObservable.add(function(g,v){if(!!d.utilityLayerScene.activeCamera&&!(!d.processAllEvents&&g.type!==j.a.POINTERMOVE&&g.type!==j.a.POINTERUP&&g.type!==j.a.POINTERDOWN&&g.type!==j.a.POINTERDOUBLETAP)){d.utilityLayerScene.pointerX=h.pointerX,d.utilityLayerScene.pointerY=h.pointerY;var l=g.event;if(h.isPointerCaptured(l.pointerId)){d._pointerCaptures[l.pointerId]=!1;return}var y=g.ray?d.utilityLayerScene.pickWithRay(g.ray):d.utilityLayerScene.pick(h.pointerX,h.pointerY);if(!g.ray&&y&&(g.ray=y.ray),d.utilityLayerScene.onPrePointerObservable.notifyObservers(g),d.onlyCheckPointerDownEvents&&g.type!=j.a.POINTERDOWN){g.skipOnPointerObservable||d.utilityLayerScene.onPointerObservable.notifyObservers(new j.b(g.type,g.event,y),g.type),g.type===j.a.POINTERUP&&d._pointerCaptures[l.pointerId]&&(d._pointerCaptures[l.pointerId]=!1);return}if(d.utilityLayerScene.autoClearDepthAndStencil||d.pickUtilitySceneFirst)y&&y.hit&&(g.skipOnPointerObservable||d.utilityLayerScene.onPointerObservable.notifyObservers(new j.b(g.type,g.event,y),g.type),g.skipOnPointerObservable=!0);else{var E=g.ray?h.pickWithRay(g.ray):h.pick(h.pointerX,h.pointerY),R=g.event;E&&y&&(y.distance===0&&E.pickedMesh?d.mainSceneTrackerPredicate&&d.mainSceneTrackerPredicate(E.pickedMesh)?(d._notifyObservers(g,E,R),g.skipOnPointerObservable=!0):g.type===j.a.POINTERDOWN?d._pointerCaptures[R.pointerId]=!0:d._lastPointerEvents[R.pointerId]&&(d.onPointerOutObservable.notifyObservers(R.pointerId),delete d._lastPointerEvents[R.pointerId]):!d._pointerCaptures[R.pointerId]&&(y.distance<E.distance||E.distance===0)?(d._notifyObservers(g,y,R),g.skipOnPointerObservable||(g.skipOnPointerObservable=y.distance>0)):!d._pointerCaptures[R.pointerId]&&y.distance>E.distance&&(d.mainSceneTrackerPredicate&&d.mainSceneTrackerPredicate(E.pickedMesh)?(d._notifyObservers(g,E,R),g.skipOnPointerObservable=!0):d._lastPointerEvents[R.pointerId]&&(d.onPointerOutObservable.notifyObservers(R.pointerId),delete d._lastPointerEvents[R.pointerId])),g.type===j.a.POINTERUP&&d._pointerCaptures[R.pointerId]&&(d._pointerCaptures[R.pointerId]=!1))}}}),this._originalPointerObserver&&h.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterCameraRenderObservable.add(function(g){d.shouldRender&&g==d.getRenderCamera()&&d.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(function(){d.dispose()}),this._updateCamera()}return f.prototype.getRenderCamera=function(h){if(this._renderCamera)return this._renderCamera;var m=void 0;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?m=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:m=this.originalScene.activeCamera,h&&m&&m.isRigCamera?m.rigParent:m},f.prototype.setRenderCamera=function(h){this._renderCamera=h},f.prototype._getSharedGizmoLight=function(){return this._sharedGizmoLight||(this._sharedGizmoLight=new M.a("shared gizmo light",new H.e(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=A.a.Gray()),this._sharedGizmoLight},Object.defineProperty(f,"DefaultUtilityLayer",{get:function(){return f._DefaultUtilityLayer==null&&(f._DefaultUtilityLayer=new f(O.a.LastCreatedScene),f._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(function(){f._DefaultUtilityLayer=null})),f._DefaultUtilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(f,"DefaultKeepDepthUtilityLayer",{get:function(){return f._DefaultKeepDepthUtilityLayer==null&&(f._DefaultKeepDepthUtilityLayer=new f(O.a.LastCreatedScene),f._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,f._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(function(){f._DefaultKeepDepthUtilityLayer=null})),f._DefaultKeepDepthUtilityLayer},enumerable:!1,configurable:!0}),f.prototype._notifyObservers=function(h,m,d){h.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new j.b(h.type,h.event,m),h.type),this._lastPointerEvents[d.pointerId]=!0)},f.prototype.render=function(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){var h=this.utilityLayerScene.activeCamera.getScene(),m=this.utilityLayerScene.activeCamera;m._scene=this.utilityLayerScene,m.leftCamera&&(m.leftCamera._scene=this.utilityLayerScene),m.rightCamera&&(m.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),m._scene=h,m.leftCamera&&(m.leftCamera._scene=h),m.rightCamera&&(m.rightCamera._scene=h)}},f.prototype.dispose=function(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()},f.prototype._updateCamera=function(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()},f._DefaultUtilityLayer=null,f._DefaultKeepDepthUtilityLayer=null,f}()},463:function(Ue,P,u){"use strict";u.d(P,"b",function(){return h}),u.d(P,"a",function(){return m});var T=u(443),S=u(438),j=u(611),O=u(449),M=u(445),H=u(448),A=u(440),p=u(668),f=u(473),h;(function(d){d[d.Clean=0]="Clean",d[d.Stop=1]="Stop",d[d.Sync=2]="Sync",d[d.NoSync=3]="NoSync"})(h||(h={}));var m=function(){function d(){}return Object.defineProperty(d,"ForceFullSceneLoadingForIncremental",{get:function(){return p.a.ForceFullSceneLoadingForIncremental},set:function(g){p.a.ForceFullSceneLoadingForIncremental=g},enumerable:!1,configurable:!0}),Object.defineProperty(d,"ShowLoadingScreen",{get:function(){return p.a.ShowLoadingScreen},set:function(g){p.a.ShowLoadingScreen=g},enumerable:!1,configurable:!0}),Object.defineProperty(d,"loggingLevel",{get:function(){return p.a.loggingLevel},set:function(g){p.a.loggingLevel=g},enumerable:!1,configurable:!0}),Object.defineProperty(d,"CleanBoneMatrixWeights",{get:function(){return p.a.CleanBoneMatrixWeights},set:function(g){p.a.CleanBoneMatrixWeights=g},enumerable:!1,configurable:!0}),d.GetDefaultPlugin=function(){return d._registeredPlugins[".babylon"]},d._GetPluginForExtension=function(g){var v=d._registeredPlugins[g];return v||(A.a.Warn("Unable to find a plugin to load "+g+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/how_to/load_from_any_file_type"),d.GetDefaultPlugin())},d._GetPluginForDirectLoad=function(g){for(var v in d._registeredPlugins){var l=d._registeredPlugins[v].plugin;if(l.canDirectLoad&&l.canDirectLoad(g))return d._registeredPlugins[v]}return d.GetDefaultPlugin()},d._GetPluginForFilename=function(g){var v=g.indexOf("?");v!==-1&&(g=g.substring(0,v));var l=g.lastIndexOf("."),y=g.substring(l,g.length).toLowerCase();return d._GetPluginForExtension(y)},d._GetDirectLoad=function(g){return g.substr(0,5)==="data:"?g.substr(5):null},d._LoadData=function(g,v,l,y,E,R,F){var B=d._GetDirectLoad(g.url),L=F?d._GetPluginForExtension(F):B?d._GetPluginForDirectLoad(g.url):d._GetPluginForFilename(g.url),I;if(L.plugin.createPlugin!==void 0?I=L.plugin.createPlugin():I=L.plugin,!I)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(d.OnPluginActivatedObservable.notifyObservers(I),B){if(I.directLoad){var k=I.directLoad(v,B);k.then?k.then(function(ae){l(I,ae)}).catch(function(ae){E("Error in directLoad of _loadData: "+ae,ae)}):l(I,k)}else l(I,B);return I}var Z=L.isBinary,Y=function(ae,ee){if(v.isDisposed){E("Scene has been disposed");return}l(I,ae,ee)},U=null,Q=!1,G=I.onDisposeObservable;G&&G.add(function(){Q=!0,U&&(U.abort(),U=null),R()});var K=function(){if(!Q){var ae=function(w,N){Y(w,N?N.responseURL:void 0)},ee=function(w){E(w.message,w)};U=I.requestFile?I.requestFile(v,g.url,ae,y,Z,ee):v._requestFile(g.url,ae,y,!0,Z,ee)}};if(f.a.StartsWith(g.url,"file:"))if(g.file){var fe=function(ae){E(ae.message,ae)};U=I.readFile?I.readFile(v,g.file,Y,y,Z,fe):v._readFile(g.file,Y,y,Z,fe)}else E("Unable to find file named "+g.name);else{var ce=v.getEngine(),re=ce.enableOfflineSupport;if(re){for(var Re=!1,Ie=0,Ce=v.disableOfflineSupportExceptionRules;Ie<Ce.length;Ie++){var X=Ce[Ie];if(X.test(g.url)){Re=!0;break}}re=!Re}re&&M.a.OfflineProviderFactory?v.offlineProvider=M.a.OfflineProviderFactory(g.url,K,ce.disableManifestCheck):K()}return I},d._GetFileInfo=function(g,v){var l,y,E=null;if(!v)l=g,y=T.b.GetFilename(g),g=T.b.GetFolderPath(g);else if(v.name){var R=v;l=g+R.name,y=R.name,E=R}else if(typeof v=="string"&&f.a.StartsWith(v,"data:"))l=v,y="";else{var F=v;if(F.substr(0,1)==="/")return T.b.Error("Wrong sceneFilename parameter"),null;l=g+F,y=F}return!E&&y&&f.a.StartsWith(l,"file:")&&(E=j.a.FilesToLoad[y.toLowerCase()]||null),{url:l,rootUrl:g,name:y,file:E}},d.GetPluginForExtension=function(g){return d._GetPluginForExtension(g).plugin},d.IsPluginForExtensionAvailable=function(g){return!!d._registeredPlugins[g]},d.RegisterPlugin=function(g){if(typeof g.extensions=="string"){var v=g.extensions;d._registeredPlugins[v.toLowerCase()]={plugin:g,isBinary:!1}}else{var l=g.extensions;Object.keys(l).forEach(function(y){d._registeredPlugins[y.toLowerCase()]={plugin:g,isBinary:l[y].isBinary}})}},d.ImportMesh=function(g,v,l,y,E,R,F,B){if(l===void 0&&(l=""),y===void 0&&(y=H.a.LastCreatedScene),E===void 0&&(E=null),R===void 0&&(R=null),F===void 0&&(F=null),B===void 0&&(B=null),!y)return A.a.Error("No scene available to import mesh to"),null;var L=d._GetFileInfo(v,l);if(!L)return null;var I={};y._addPendingData(I);var k=function(){y._removePendingData(I)},Z=function(Q,G){var K="Unable to import meshes from "+L.url+": "+Q;F?F(y,K,G):A.a.Error(K),k()},Y=R?function(Q){try{R(Q)}catch(G){Z("Error in onProgress callback: "+G,G)}}:void 0,U=function(Q,G,K,fe,ce,re,Re){if(y.importedMeshesFiles.push(L.url),E)try{E(Q,G,K,fe,ce,re,Re)}catch(Ie){Z("Error in onSuccess callback: "+Ie,Ie)}y._removePendingData(I)};return d._LoadData(L,y,function(Q,G,K){if(Q.rewriteRootURL&&(L.rootUrl=Q.rewriteRootURL(L.rootUrl,K)),Q.importMesh){var fe=Q,ce=new Array,re=new Array,Re=new Array;if(!fe.importMesh(g,y,G,L.rootUrl,ce,re,Re,Z))return;y.loadingPluginName=Q.name,U(ce,re,Re,[],[],[],[])}else{var Ie=Q;Ie.importMeshAsync(g,y,G,L.rootUrl,Y,L.name).then(function(Ce){y.loadingPluginName=Q.name,U(Ce.meshes,Ce.particleSystems,Ce.skeletons,Ce.animationGroups,Ce.transformNodes,Ce.geometries,Ce.lights)}).catch(function(Ce){Z(Ce.message,Ce)})}},Y,Z,k,B)},d.ImportMeshAsync=function(g,v,l,y,E,R){return l===void 0&&(l=""),y===void 0&&(y=H.a.LastCreatedScene),E===void 0&&(E=null),R===void 0&&(R=null),new Promise(function(F,B){d.ImportMesh(g,v,l,y,function(L,I,k,Z,Y,U,Q){F({meshes:L,particleSystems:I,skeletons:k,animationGroups:Z,transformNodes:Y,geometries:U,lights:Q})},E,function(L,I,k){B(k||new Error(I))},R)})},d.Load=function(g,v,l,y,E,R,F){return v===void 0&&(v=""),l===void 0&&(l=H.a.LastCreatedEngine),y===void 0&&(y=null),E===void 0&&(E=null),R===void 0&&(R=null),F===void 0&&(F=null),l?d.Append(g,v,new O.a(l),y,E,R,F):(T.b.Error("No engine available"),null)},d.LoadAsync=function(g,v,l,y,E){return v===void 0&&(v=""),l===void 0&&(l=H.a.LastCreatedEngine),y===void 0&&(y=null),E===void 0&&(E=null),new Promise(function(R,F){d.Load(g,v,l,function(B){R(B)},y,function(B,L,I){F(I||new Error(L))},E)})},d.Append=function(g,v,l,y,E,R,F){var B=this;if(v===void 0&&(v=""),l===void 0&&(l=H.a.LastCreatedScene),y===void 0&&(y=null),E===void 0&&(E=null),R===void 0&&(R=null),F===void 0&&(F=null),!l)return A.a.Error("No scene available to append to"),null;var L=d._GetFileInfo(g,v);if(!L)return null;d.ShowLoadingScreen&&!this._showingLoadingScreen&&(this._showingLoadingScreen=!0,l.getEngine().displayLoadingUI(),l.executeWhenReady(function(){l.getEngine().hideLoadingUI(),B._showingLoadingScreen=!1}));var I={};l._addPendingData(I);var k=function(){l._removePendingData(I)},Z=function(Q,G){var K="Unable to load from "+L.url+(Q?": "+Q:"");R?R(l,K,G):A.a.Error(K),k()},Y=E?function(Q){try{E(Q)}catch(G){Z("Error in onProgress callback",G)}}:void 0,U=function(){if(y)try{y(l)}catch(Q){Z("Error in onSuccess callback",Q)}l._removePendingData(I)};return d._LoadData(L,l,function(Q,G){if(Q.load){var K=Q;if(!K.load(l,G,L.rootUrl,Z))return;l.loadingPluginName=Q.name,U()}else{var fe=Q;fe.loadAsync(l,G,L.rootUrl,Y,L.name).then(function(){l.loadingPluginName=Q.name,U()}).catch(function(ce){Z(ce.message,ce)})}},Y,Z,k,F)},d.AppendAsync=function(g,v,l,y,E){return v===void 0&&(v=""),l===void 0&&(l=H.a.LastCreatedScene),y===void 0&&(y=null),E===void 0&&(E=null),new Promise(function(R,F){d.Append(g,v,l,function(B){R(B)},y,function(B,L,I){F(I||new Error(L))},E)})},d.LoadAssetContainer=function(g,v,l,y,E,R,F){if(v===void 0&&(v=""),l===void 0&&(l=H.a.LastCreatedScene),y===void 0&&(y=null),E===void 0&&(E=null),R===void 0&&(R=null),F===void 0&&(F=null),!l)return A.a.Error("No scene available to load asset container to"),null;var B=d._GetFileInfo(g,v);if(!B)return null;var L={};l._addPendingData(L);var I=function(){l._removePendingData(L)},k=function(U,Q){var G="Unable to load assets from "+B.url+(U?": "+U:"");Q&&Q.message&&(G+=" ("+Q.message+")"),R?R(l,G,Q):A.a.Error(G),I()},Z=E?function(U){try{E(U)}catch(Q){k("Error in onProgress callback",Q)}}:void 0,Y=function(U){if(y)try{y(U)}catch(Q){k("Error in onSuccess callback",Q)}l._removePendingData(L)};return d._LoadData(B,l,function(U,Q){if(U.loadAssetContainer){var G=U,K=G.loadAssetContainer(l,Q,B.rootUrl,k);if(!K)return;l.loadingPluginName=U.name,Y(K)}else if(U.loadAssetContainerAsync){var fe=U;fe.loadAssetContainerAsync(l,Q,B.rootUrl,Z,B.name).then(function(ce){l.loadingPluginName=U.name,Y(ce)}).catch(function(ce){k(ce.message,ce)})}else k("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},Z,k,I,F)},d.LoadAssetContainerAsync=function(g,v,l,y,E){return v===void 0&&(v=""),l===void 0&&(l=H.a.LastCreatedScene),y===void 0&&(y=null),E===void 0&&(E=null),new Promise(function(R,F){d.LoadAssetContainer(g,v,l,function(B){R(B)},y,function(B,L,I){F(I||new Error(L))},E)})},d.ImportAnimations=function(g,v,l,y,E,R,F,B,L,I){if(v===void 0&&(v=""),l===void 0&&(l=H.a.LastCreatedScene),y===void 0&&(y=!0),E===void 0&&(E=h.Clean),R===void 0&&(R=null),F===void 0&&(F=null),B===void 0&&(B=null),L===void 0&&(L=null),I===void 0&&(I=null),!l){A.a.Error("No scene available to load animations to");return}if(y){for(var k=0,Z=l.animatables;k<Z.length;k++){var Y=Z[k];Y.reset()}l.stopAllAnimations(),l.animationGroups.slice().forEach(function(K){K.dispose()});var U=l.getNodes();U.forEach(function(K){K.animations&&(K.animations=[])})}else switch(E){case h.Clean:l.animationGroups.slice().forEach(function(K){K.dispose()});break;case h.Stop:l.animationGroups.forEach(function(K){K.stop()});break;case h.Sync:l.animationGroups.forEach(function(K){K.reset(),K.restart()});break;case h.NoSync:break;default:A.a.Error("Unknown animation group loading mode value '"+E+"'");return}var Q=l.animatables.length,G=function(K){K.mergeAnimationsTo(l,l.animatables.slice(Q),R),K.dispose(),l.onAnimationFileImportedObservable.notifyObservers(l),F&&F(l)};this.LoadAssetContainer(g,v,l,G,B,L,I)},d.ImportAnimationsAsync=function(g,v,l,y,E,R,F,B,L,I){return v===void 0&&(v=""),l===void 0&&(l=H.a.LastCreatedScene),y===void 0&&(y=!0),E===void 0&&(E=h.Clean),R===void 0&&(R=null),F===void 0&&(F=null),B===void 0&&(B=null),L===void 0&&(L=null),I===void 0&&(I=null),new Promise(function(k,Z){d.ImportAnimations(g,v,l,y,E,R,function(Y){k(Y)},B,function(Y,U,Q){Z(Q||new Error(U))},I)})},d.NO_LOGGING=0,d.MINIMAL_LOGGING=1,d.SUMMARY_LOGGING=2,d.DETAILED_LOGGING=3,d.OnPluginActivatedObservable=new S.c,d._registeredPlugins={},d._showingLoadingScreen=!1,d}()},466:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});var T=u(443),S=function(){function j(O,M,H,A){this._name=M,this._singleInstance=A||!0,this._getPostProcesses=H,this._cameras={},this._indicesForCamera={},this._postProcesses={}}return Object.defineProperty(j.prototype,"isSupported",{get:function(){for(var O in this._postProcesses)if(this._postProcesses.hasOwnProperty(O)){for(var M=this._postProcesses[O],H=0;H<M.length;H++)if(!M[H].isSupported)return!1}return!0},enumerable:!1,configurable:!0}),j.prototype._update=function(){},j.prototype._attachCameras=function(O){var M=this,H,A=T.b.MakeArray(O||this._cameras);if(!!A)for(var p=0;p<A.length;p++){var f=A[p];if(!!f){var h=f.name;if(this._singleInstance?H=0:H=h,!this._postProcesses[H]){var m=this._getPostProcesses();m&&(this._postProcesses[H]=Array.isArray(m)?m:[m])}this._indicesForCamera[h]||(this._indicesForCamera[h]=[]),this._postProcesses[H].forEach(function(d){var g=f.attachPostProcess(d);M._indicesForCamera[h].push(g)}),this._cameras[h]||(this._cameras[h]=f)}}},j.prototype._detachCameras=function(O){var M=T.b.MakeArray(O||this._cameras);if(!!M)for(var H=0;H<M.length;H++){var A=M[H],p=A.name,f=this._postProcesses[this._singleInstance?0:p];f&&f.forEach(function(h){A.detachPostProcess(h)}),this._cameras[p]&&(this._cameras[p]=null)}},j.prototype._enable=function(O){var M=this,H=T.b.MakeArray(O||this._cameras);if(!!H)for(var A=0;A<H.length;A++)for(var p=H[A],f=p.name,h=0;h<this._indicesForCamera[f].length;h++)(p._postProcesses[this._indicesForCamera[f][h]]===void 0||p._postProcesses[this._indicesForCamera[f][h]]===null)&&this._postProcesses[this._singleInstance?0:f].forEach(function(m){H[A].attachPostProcess(m,M._indicesForCamera[f][h])})},j.prototype._disable=function(O){var M=T.b.MakeArray(O||this._cameras);if(!!M)for(var H=0;H<M.length;H++){var A=M[H],p=A.name;this._postProcesses[this._singleInstance?0:p].forEach(function(f){A.detachPostProcess(f)})}},j.prototype.getPostProcesses=function(O){return this._singleInstance?this._postProcesses[0]:O?this._postProcesses[O.name]:null},j}()},469:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(588),S=u(436),j=u(539),O=u(667),M=u(449),H=u(451),A=function(){function p(f,h,m){m===void 0&&(m=Number.MAX_VALUE),this.origin=f,this.direction=h,this.length=m}return p.prototype.intersectsBoxMinMax=function(f,h,m){m===void 0&&(m=0);var d=p._TmpVector3[0].copyFromFloats(f.x-m,f.y-m,f.z-m),g=p._TmpVector3[1].copyFromFloats(h.x+m,h.y+m,h.z+m),v=0,l=Number.MAX_VALUE,y,E,R,F;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<d.x||this.origin.x>g.x)return!1}else if(y=1/this.direction.x,E=(d.x-this.origin.x)*y,R=(g.x-this.origin.x)*y,R===-Infinity&&(R=Infinity),E>R&&(F=E,E=R,R=F),v=Math.max(E,v),l=Math.min(R,l),v>l)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<d.y||this.origin.y>g.y)return!1}else if(y=1/this.direction.y,E=(d.y-this.origin.y)*y,R=(g.y-this.origin.y)*y,R===-Infinity&&(R=Infinity),E>R&&(F=E,E=R,R=F),v=Math.max(E,v),l=Math.min(R,l),v>l)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<d.z||this.origin.z>g.z)return!1}else if(y=1/this.direction.z,E=(d.z-this.origin.z)*y,R=(g.z-this.origin.z)*y,R===-Infinity&&(R=Infinity),E>R&&(F=E,E=R,R=F),v=Math.max(E,v),l=Math.min(R,l),v>l)return!1;return!0},p.prototype.intersectsBox=function(f,h){return h===void 0&&(h=0),this.intersectsBoxMinMax(f.minimum,f.maximum,h)},p.prototype.intersectsSphere=function(f,h){h===void 0&&(h=0);var m=f.center.x-this.origin.x,d=f.center.y-this.origin.y,g=f.center.z-this.origin.z,v=m*m+d*d+g*g,l=f.radius+h,y=l*l;if(v<=y)return!0;var E=m*this.direction.x+d*this.direction.y+g*this.direction.z;if(E<0)return!1;var R=v-E*E;return R<=y},p.prototype.intersectsTriangle=function(f,h,m){var d=p._TmpVector3[0],g=p._TmpVector3[1],v=p._TmpVector3[2],l=p._TmpVector3[3],y=p._TmpVector3[4];h.subtractToRef(f,d),m.subtractToRef(f,g),S.e.CrossToRef(this.direction,g,v);var E=S.e.Dot(d,v);if(E===0)return null;var R=1/E;this.origin.subtractToRef(f,l);var F=S.e.Dot(l,v)*R;if(F<0||F>1)return null;S.e.CrossToRef(l,d,y);var B=S.e.Dot(this.direction,y)*R;if(B<0||F+B>1)return null;var L=S.e.Dot(g,y)*R;return L>this.length?null:new O.a(1-F-B,F,L)},p.prototype.intersectsPlane=function(f){var h,m=S.e.Dot(f.normal,this.direction);if(Math.abs(m)<999999997475243e-21)return null;var d=S.e.Dot(f.normal,this.origin);return h=(-f.d-d)/m,h<0?h<-999999997475243e-21?null:0:h},p.prototype.intersectsAxis=function(f,h){switch(h===void 0&&(h=0),f){case"y":var m=(this.origin.y-h)/this.direction.y;return m>0?null:new S.e(this.origin.x+this.direction.x*-m,h,this.origin.z+this.direction.z*-m);case"x":var m=(this.origin.x-h)/this.direction.x;return m>0?null:new S.e(h,this.origin.y+this.direction.y*-m,this.origin.z+this.direction.z*-m);case"z":var m=(this.origin.z-h)/this.direction.z;return m>0?null:new S.e(this.origin.x+this.direction.x*-m,this.origin.y+this.direction.y*-m,h);default:return null}},p.prototype.intersectsMesh=function(f,h){var m=S.c.Matrix[0];return f.getWorldMatrix().invertToRef(m),this._tmpRay?p.TransformToRef(this,m,this._tmpRay):this._tmpRay=p.Transform(this,m),f.intersects(this._tmpRay,h)},p.prototype.intersectsMeshes=function(f,h,m){m?m.length=0:m=[];for(var d=0;d<f.length;d++){var g=this.intersectsMesh(f[d],h);g.hit&&m.push(g)}return m.sort(this._comparePickingInfo),m},p.prototype._comparePickingInfo=function(f,h){return f.distance<h.distance?-1:f.distance>h.distance?1:0},p.prototype.intersectionSegment=function(f,h,m){var d=this.origin,g=S.c.Vector3[0],v=S.c.Vector3[1],l=S.c.Vector3[2],y=S.c.Vector3[3];h.subtractToRef(f,g),this.direction.scaleToRef(p.rayl,l),d.addToRef(l,v),f.subtractToRef(d,y);var E=S.e.Dot(g,g),R=S.e.Dot(g,l),F=S.e.Dot(l,l),B=S.e.Dot(g,y),L=S.e.Dot(l,y),I=E*F-R*R,k,Z,Y=I,U,Q,G=I;I<p.smallnum?(Z=0,Y=1,Q=L,G=F):(Z=R*L-F*B,Q=E*L-R*B,Z<0?(Z=0,Q=L,G=F):Z>Y&&(Z=Y,Q=L+R,G=F)),Q<0?(Q=0,-B<0?Z=0:-B>E?Z=Y:(Z=-B,Y=E)):Q>G&&(Q=G,-B+R<0?Z=0:-B+R>E?Z=Y:(Z=-B+R,Y=E)),k=Math.abs(Z)<p.smallnum?0:Z/Y,U=Math.abs(Q)<p.smallnum?0:Q/G;var K=S.c.Vector3[4];l.scaleToRef(U,K);var fe=S.c.Vector3[5];g.scaleToRef(k,fe),fe.addInPlace(y);var ce=S.c.Vector3[6];fe.subtractToRef(K,ce);var re=U>0&&U<=this.length&&ce.lengthSquared()<m*m;return re?fe.length():-1},p.prototype.update=function(f,h,m,d,g,v,l){return this.unprojectRayToRef(f,h,m,d,g,v,l),this},p.Zero=function(){return new p(S.e.Zero(),S.e.Zero())},p.CreateNew=function(f,h,m,d,g,v,l){var y=p.Zero();return y.update(f,h,m,d,g,v,l)},p.CreateNewFromTo=function(f,h,m){m===void 0&&(m=S.a.IdentityReadOnly);var d=h.subtract(f),g=Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z);return d.normalize(),p.Transform(new p(f,d,g),m)},p.Transform=function(f,h){var m=new p(new S.e(0,0,0),new S.e(0,0,0));return p.TransformToRef(f,h,m),m},p.TransformToRef=function(f,h,m){S.e.TransformCoordinatesToRef(f.origin,h,m.origin),S.e.TransformNormalToRef(f.direction,h,m.direction),m.length=f.length;var d=m.direction,g=d.length();if(!(g===0||g===1)){var v=1/g;d.x*=v,d.y*=v,d.z*=v,m.length*=g}},p.prototype.unprojectRayToRef=function(f,h,m,d,g,v,l){var y=S.c.Matrix[0];g.multiplyToRef(v,y),y.multiplyToRef(l,y),y.invert();var E=S.c.Vector3[0];E.x=f/m*2-1,E.y=-(h/d*2-1),E.z=-1;var R=S.c.Vector3[1].copyFromFloats(E.x,E.y,1),F=S.c.Vector3[2],B=S.c.Vector3[3];S.e._UnprojectFromInvertedMatrixToRef(E,y,F),S.e._UnprojectFromInvertedMatrixToRef(R,y,B),this.origin.copyFrom(F),B.subtractToRef(F,this.direction),this.direction.normalize()},p._TmpVector3=T.a.BuildArray(6,S.e.Zero),p.smallnum=1e-8,p.rayl=1e9,p}();M.a.prototype.createPickingRay=function(p,f,h,m,d){d===void 0&&(d=!1);var g=A.Zero();return this.createPickingRayToRef(p,f,h,g,m,d),g},M.a.prototype.createPickingRayToRef=function(p,f,h,m,d,g){g===void 0&&(g=!1);var v=this.getEngine();if(!d){if(!this.activeCamera)return this;d=this.activeCamera}var l=d.viewport,y=l.toGlobal(v.getRenderWidth(),v.getRenderHeight());return p=p/v.getHardwareScalingLevel()-y.x,f=f/v.getHardwareScalingLevel()-(v.getRenderHeight()-y.y-y.height),m.update(p,f,y.width,y.height,h||S.a.IdentityReadOnly,g?S.a.IdentityReadOnly:d.getViewMatrix(),d.getProjectionMatrix()),this},M.a.prototype.createPickingRayInCameraSpace=function(p,f,h){var m=A.Zero();return this.createPickingRayInCameraSpaceToRef(p,f,m,h),m},M.a.prototype.createPickingRayInCameraSpaceToRef=function(p,f,h,m){if(!j.a)return this;var d=this.getEngine();if(!m){if(!this.activeCamera)throw new Error("Active camera not set");m=this.activeCamera}var g=m.viewport,v=g.toGlobal(d.getRenderWidth(),d.getRenderHeight()),l=S.a.Identity();return p=p/d.getHardwareScalingLevel()-v.x,f=f/d.getHardwareScalingLevel()-(d.getRenderHeight()-v.y-v.height),h.update(p,f,v.width,v.height,l,l,m.getProjectionMatrix()),this},M.a.prototype._internalPickForMesh=function(p,f,h,m,d,g,v,l){var y=f(m),E=h.intersects(y,d,v,g,m,l);return!E||!E.hit||!d&&p!=null&&E.distance>=p.distance?null:E},M.a.prototype._internalPick=function(p,f,h,m,d){if(!j.a)return null;for(var g=null,v=0;v<this.meshes.length;v++){var l=this.meshes[v];if(f){if(!f(l))continue}else if(!l.isEnabled()||!l.isVisible||!l.isPickable)continue;var y=l.skeleton&&l.skeleton.overrideMesh?l.skeleton.overrideMesh.getWorldMatrix():l.getWorldMatrix();if(l.hasThinInstances&&l.thinInstanceEnablePicking){var E=this._internalPickForMesh(g,p,l,y,!0,!0,d);if(E){if(m)return g;for(var R=S.c.Matrix[1],F=l.thinInstanceGetWorldMatrices(),B=0;B<F.length;B++){var L=F[B];L.multiplyToRef(y,R);var I=this._internalPickForMesh(g,p,l,R,h,m,d,!0);if(I&&(g=I,g.thinInstanceIndex=B,h))return g}}}else{var E=this._internalPickForMesh(g,p,l,y,h,m,d);if(E&&(g=E,h))return g}}return g||new j.a},M.a.prototype._internalMultiPick=function(p,f,h){if(!j.a)return null;for(var m=new Array,d=0;d<this.meshes.length;d++){var g=this.meshes[d];if(f){if(!f(g))continue}else if(!g.isEnabled()||!g.isVisible||!g.isPickable)continue;var v=g.skeleton&&g.skeleton.overrideMesh?g.skeleton.overrideMesh.getWorldMatrix():g.getWorldMatrix();if(g.hasThinInstances&&g.thinInstanceEnablePicking){var l=this._internalPickForMesh(null,p,g,v,!0,!0,h);if(l)for(var y=S.c.Matrix[1],E=g.thinInstanceGetWorldMatrices(),R=0;R<E.length;R++){var F=E[R];F.multiplyToRef(v,y);var B=this._internalPickForMesh(null,p,g,y,!1,!1,h,!0);B&&(B.thinInstanceIndex=R,m.push(B))}}else{var l=this._internalPickForMesh(null,p,g,v,!1,!1,h);l&&m.push(l)}}return m},M.a.prototype.pickWithBoundingInfo=function(p,f,h,m,d){var g=this;if(!j.a)return null;var v=this._internalPick(function(l){return g._tempPickingRay||(g._tempPickingRay=A.Zero()),g.createPickingRayToRef(p,f,l,g._tempPickingRay,d||null),g._tempPickingRay},h,m,!0);return v&&(v.ray=this.createPickingRay(p,f,S.a.Identity(),d||null)),v},M.a.prototype.pick=function(p,f,h,m,d,g){var v=this;if(!j.a)return null;var l=this._internalPick(function(y){return v._tempPickingRay||(v._tempPickingRay=A.Zero()),v.createPickingRayToRef(p,f,y,v._tempPickingRay,d||null),v._tempPickingRay},h,m,!1,g);return l&&(l.ray=this.createPickingRay(p,f,S.a.Identity(),d||null)),l},M.a.prototype.pickWithRay=function(p,f,h,m){var d=this,g=this._internalPick(function(v){return d._pickWithRayInverseMatrix||(d._pickWithRayInverseMatrix=S.a.Identity()),v.invertToRef(d._pickWithRayInverseMatrix),d._cachedRayForTransform||(d._cachedRayForTransform=A.Zero()),A.TransformToRef(p,d._pickWithRayInverseMatrix,d._cachedRayForTransform),d._cachedRayForTransform},f,h,!1,m);return g&&(g.ray=p),g},M.a.prototype.multiPick=function(p,f,h,m,d){var g=this;return this._internalMultiPick(function(v){return g.createPickingRay(p,f,v,m||null)},h,d)},M.a.prototype.multiPickWithRay=function(p,f,h){var m=this;return this._internalMultiPick(function(d){return m._pickWithRayInverseMatrix||(m._pickWithRayInverseMatrix=S.a.Identity()),d.invertToRef(m._pickWithRayInverseMatrix),m._cachedRayForTransform||(m._cachedRayForTransform=A.Zero()),A.TransformToRef(p,m._pickWithRayInverseMatrix,m._cachedRayForTransform),m._cachedRayForTransform},f,h)},H.a.prototype.getForwardRay=function(p,f,h){return p===void 0&&(p=100),this.getForwardRayToRef(new A(S.e.Zero(),S.e.Zero(),p),p,f,h)},H.a.prototype.getForwardRayToRef=function(p,f,h,m){return f===void 0&&(f=100),h||(h=this.getWorldMatrix()),p.length=f,m?p.origin.copyFrom(m):p.origin.copyFrom(this.position),S.c.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),S.e.TransformNormalToRef(S.c.Vector3[2],h,S.c.Vector3[3]),S.e.NormalizeToRef(S.c.Vector3[3],p.direction),p}},471:function(Ue,P,u){"use strict";u.d(P,"a",function(){return M});var T=u(436),S=u(446),j=u(461),O=u(464),M=function(){function H(A){var p=this;A===void 0&&(A=j.a.DefaultUtilityLayer),this.gizmoLayer=A,this._attachedMesh=null,this._attachedNode=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this.updateGizmoPositionToMatchAttachedMesh=!0,this.updateScale=!0,this._interactionsEnabled=!0,this._tempQuaternion=new T.b(0,0,0,1),this._tempVector=new T.e,this._tempVector2=new T.e,this._tempMatrix1=new T.a,this._tempMatrix2=new T.a,this._rightHandtoLeftHandMatrix=T.a.RotationY(Math.PI),this._rootMesh=new S.a("gizmoRootNode",A.utilityLayerScene),this._rootMesh.rotationQuaternion=T.b.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add(function(){p._update()})}return Object.defineProperty(H.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(A){this._scaleRatio=A},enumerable:!1,configurable:!0}),Object.defineProperty(H.prototype,"isHovered",{get:function(){return this._isHovered},enumerable:!1,configurable:!0}),Object.defineProperty(H.prototype,"attachedMesh",{get:function(){return this._attachedMesh},set:function(A){this._attachedMesh=A,A&&(this._attachedNode=A),this._rootMesh.setEnabled(!!A),this._attachedNodeChanged(A)},enumerable:!1,configurable:!0}),Object.defineProperty(H.prototype,"attachedNode",{get:function(){return this._attachedNode},set:function(A){this._attachedNode=A,this._attachedMesh=null,this._rootMesh.setEnabled(!!A),this._attachedNodeChanged(A)},enumerable:!1,configurable:!0}),H.prototype.setCustomMesh=function(A){if(A.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach(function(p){p.dispose()}),A.parent=this._rootMesh,this._customMeshSet=!0},Object.defineProperty(H.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(A){this._updateGizmoRotationToMatchAttachedMesh=A},enumerable:!1,configurable:!0}),H.prototype._attachedNodeChanged=function(A){},H.prototype._update=function(){if(this.attachedNode){var A=this.attachedNode;if(this.attachedMesh&&(A=this.attachedMesh._effectiveMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh){var p=A.getWorldMatrix().getRow(3),f=p?p.toVector3():new T.e(0,0,0);this._rootMesh.position.copyFrom(f)}if(this.updateGizmoRotationToMatchAttachedMesh?A.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1),this.updateScale){var h=this.gizmoLayer.utilityLayerScene.activeCamera,m=h.globalPosition;h.devicePosition&&(m=h.devicePosition),this._rootMesh.position.subtractToRef(m,this._tempVector);var d=this._tempVector.length()*this.scaleRatio;this._rootMesh.scaling.set(d,d,d),A._getWorldMatrixDeterminant()<0&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}},H.prototype._matrixChanged=function(){if(!!this._attachedNode){if(this._attachedNode._isCamera){var A=this._attachedNode,p,f;if(A.parent){var h=this._tempMatrix2;A.parent._worldMatrix.invertToRef(h),this._attachedNode._worldMatrix.multiplyToRef(h,this._tempMatrix1),p=this._tempMatrix1}else p=this._attachedNode._worldMatrix;A.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(p,this._tempMatrix2),f=this._tempMatrix2):f=p,f.decompose(this._tempVector2,this._tempQuaternion,this._tempVector);var m=this._attachedNode.getClassName()==="FreeCamera"||this._attachedNode.getClassName()==="FlyCamera"||this._attachedNode.getClassName()==="ArcFollowCamera"||this._attachedNode.getClassName()==="TargetCamera"||this._attachedNode.getClassName()==="TouchCamera"||this._attachedNode.getClassName()==="UniversalCamera";if(m){var d=this._attachedNode;d.rotation=this._tempQuaternion.toEulerAngles(),d.rotationQuaternion&&(d.rotationQuaternion.copyFrom(this._tempQuaternion),d.rotationQuaternion.normalize())}A.position.copyFrom(this._tempVector)}else if(this._attachedNode._isMesh||this._attachedNode.getClassName()==="AbstractMesh"||this._attachedNode.getClassName()==="TransformNode"||this._attachedNode.getClassName()==="InstancedMesh"){var g=this._attachedNode;if(g.parent){var h=this._tempMatrix1,v=this._tempMatrix2;g.parent.getWorldMatrix().invertToRef(h),this._attachedNode.getWorldMatrix().multiplyToRef(h,v),v.decompose(g.scaling,this._tempQuaternion,g.position)}else this._attachedNode._worldMatrix.decompose(g.scaling,this._tempQuaternion,g.position);g.billboardMode||(g.rotationQuaternion?(g.rotationQuaternion.copyFrom(this._tempQuaternion),g.rotationQuaternion.normalize()):g.rotation=this._tempQuaternion.toEulerAngles())}else if(this._attachedNode.getClassName()==="Bone"){var l=this._attachedNode,y=l.getParent();if(y){var E=this._tempMatrix1,R=this._tempMatrix2;y.getWorldMatrix().invertToRef(E),l.getWorldMatrix().multiplyToRef(E,R);var F=l.getLocalMatrix();F.copyFrom(R)}else{var F=l.getLocalMatrix();F.copyFrom(l.getWorldMatrix())}l.markAsDirty()}}},H.GizmoAxisPointerObserver=function(A,p){var f=!1,h=A.utilityLayerScene.onPointerObservable.add(function(m){var d,g;if(m.pickInfo){if(m.type===O.a.POINTERMOVE){if(f)return;p.forEach(function(l){var y,E;if(l.colliderMeshes&&l.gizmoMeshes){var R=((y=l.colliderMeshes)===null||y===void 0?void 0:y.indexOf((E=m==null?void 0:m.pickInfo)===null||E===void 0?void 0:E.pickedMesh))!=-1,F=R||l.active?l.hoverMaterial:l.material;l.gizmoMeshes.forEach(function(B){B.material=F,B.color&&(B.color=F.diffuseColor)})}})}if(m.type===O.a.POINTERDOWN&&p.has((d=m.pickInfo.pickedMesh)===null||d===void 0?void 0:d.parent)){f=!0;var v=p.get((g=m.pickInfo.pickedMesh)===null||g===void 0?void 0:g.parent);v.active=!0,p.forEach(function(l){var y,E,R=((y=l.colliderMeshes)===null||y===void 0?void 0:y.indexOf((E=m==null?void 0:m.pickInfo)===null||E===void 0?void 0:E.pickedMesh))!=-1,F=R||l.active?l.hoverMaterial:l.disableMaterial;l.gizmoMeshes.forEach(function(B){B.material=F,B.color&&(B.color=F.diffuseColor)})})}m.type===O.a.POINTERUP&&p.forEach(function(l){l.active=!1,f=!1,l.gizmoMeshes.forEach(function(y){y.material=l.material,y.color&&(y.color=l.material.diffuseColor)})})}});return h},H.prototype.dispose=function(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)},H}()},472:function(Ue,P,u){"use strict";u.d(P,"a",function(){return U});var T=u(434),S=u(444),j=u(442),O=u(435),M="kernelBlurVaryingDeclaration",H="varying vec2 sampleCoord{X};";O.a.IncludesShadersStore[M]=H;var A={name:M,shader:H},p=u(535),f="kernelBlurFragment",h=`#ifdef DOF
factor=sampleCoC(sampleCoord{X});
computedWeight=KERNEL_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif`;O.a.IncludesShadersStore[f]=h;var m={name:f,shader:h},d="kernelBlurFragment2",g=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});
computedWeight=KERNEL_DEP_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif`;O.a.IncludesShadersStore[d]=g;var v={name:d,shader:g},l="kernelBlurPixelShader",y=`
uniform sampler2D textureSampler;
uniform vec2 delta;

varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;
uniform vec2 cameraMinMaxZ;
float sampleDistance(const in vec2 offset) {
float depth=texture2D(circleOfConfusionSampler,offset).g;
return cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth;
}
float sampleCoC(const in vec2 offset) {
float coc=texture2D(circleOfConfusionSampler,offset).r;
return coc;
}
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
void main(void)
{
float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT;
float factor=0.0;

#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;O.a.ShadersStore[l]=y;var E={name:l,shader:y},R="kernelBlurVertex",F="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";O.a.IncludesShadersStore[R]=F;var B={name:R,shader:F},L="kernelBlurVertexShader",I=`
attribute vec2 position;

uniform vec2 delta;

varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
void main(void) {
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
}`;O.a.ShadersStore[L]=I;var k={name:L,shader:I},Z=u(437),Y=u(439),U=function(Q){Object(T.d)(G,Q);function G(K,fe,ce,re,Re,Ie,Ce,X,ae,ee,w){Ie===void 0&&(Ie=j.a.BILINEAR_SAMPLINGMODE),ae===void 0&&(ae=0),ee===void 0&&(ee=""),w===void 0&&(w=!1);var N=Q.call(this,K,"kernelBlur",["delta","direction","cameraMinMaxZ"],["circleOfConfusionSampler"],re,Re,Ie,Ce,X,null,ae,"kernelBlur",{varyingCount:0,depCount:0},!0)||this;return N.blockCompilation=w,N._packedFloat=!1,N._staticDefines="",N._staticDefines=ee,N.direction=fe,N.onApplyObservable.add(function(W){N._outputTexture?W.setFloat2("delta",1/N._outputTexture.width*N.direction.x,1/N._outputTexture.height*N.direction.y):W.setFloat2("delta",1/N.width*N.direction.x,1/N.height*N.direction.y)}),N.kernel=ce,N}return Object.defineProperty(G.prototype,"kernel",{get:function(){return this._idealKernel},set:function(K){this._idealKernel!==K&&(K=Math.max(K,1),this._idealKernel=K,this._kernel=this._nearestBestKernel(K),this.blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(G.prototype,"packedFloat",{get:function(){return this._packedFloat},set:function(K){this._packedFloat!==K&&(this._packedFloat=K,this.blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),G.prototype.getClassName=function(){return"BlurPostProcess"},G.prototype.updateEffect=function(K,fe,ce,re,Re,Ie){K===void 0&&(K=null),fe===void 0&&(fe=null),ce===void 0&&(ce=null),this._updateParameters(Re,Ie)},G.prototype._updateParameters=function(K,fe){for(var ce=this._kernel,re=(ce-1)/2,Re=[],Ie=[],Ce=0,X=0;X<ce;X++){var ae=X/(ce-1),ee=this._gaussianWeight(ae*2-1);Re[X]=X-re,Ie[X]=ee,Ce+=ee}for(var X=0;X<Ie.length;X++)Ie[X]/=Ce;for(var w=[],N=[],W=[],X=0;X<=re;X+=2){var $=Math.min(X+1,Math.floor(re)),J=X===$;if(J)W.push({o:Re[X],w:Ie[X]});else{var le=$===re,ne=Ie[X]+Ie[$]*(le?.5:1),be=Re[X]+1/(1+Ie[X]/Ie[$]);be===0?(W.push({o:Re[X],w:Ie[X]}),W.push({o:Re[X+1],w:Ie[X+1]})):(W.push({o:be,w:ne}),W.push({o:-be,w:ne}))}}for(var X=0;X<W.length;X++)N[X]=W[X].o,w[X]=W[X].w;Re=N,Ie=w;var Me=this.getEngine().getCaps().maxVaryingVectors,Te=Math.max(Me,0)-1,Ae=Math.min(Re.length,Te),se="";se+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(se+="#define CENTER_WEIGHT "+this._glslFloat(Ie[Ae-1])+`\r
`,Ae--);for(var X=0;X<Ae;X++)se+="#define KERNEL_OFFSET"+X+" "+this._glslFloat(Re[X])+`\r
`,se+="#define KERNEL_WEIGHT"+X+" "+this._glslFloat(Ie[X])+`\r
`;for(var te=0,X=Te;X<Re.length;X++)se+="#define KERNEL_DEP_OFFSET"+te+" "+this._glslFloat(Re[X])+`\r
`,se+="#define KERNEL_DEP_WEIGHT"+te+" "+this._glslFloat(Ie[X])+`\r
`,te++;this.packedFloat&&(se+="#define PACKEDFLOAT 1"),this.blockCompilation=!1,Q.prototype.updateEffect.call(this,se,null,null,{varyingCount:Ae,depCount:te},K,fe)},G.prototype._nearestBestKernel=function(K){for(var fe=Math.round(K),ce=0,re=[fe,fe-1,fe+1,fe-2,fe+2];ce<re.length;ce++){var Re=re[ce];if(Re%2!=0&&Math.floor(Re/2)%2==0&&Re>0)return Math.max(Re,3)}return Math.max(fe,3)},G.prototype._gaussianWeight=function(K){var fe=1/3,ce=Math.sqrt(2*Math.PI)*fe,re=-(K*K/(2*fe*fe)),Re=1/ce*Math.exp(re);return Re},G.prototype._glslFloat=function(K,fe){return fe===void 0&&(fe=8),K.toFixed(fe).replace(/0+$/,"")},G._Parse=function(K,fe,ce,re){return Y.a.Parse(function(){return new G(K.name,K.direction,K.kernel,K.options,fe,K.renderTargetSamplingMode,ce.getEngine(),K.reusable,K.textureType,void 0,!1)},K,ce,re)},Object(T.c)([Object(Y.c)("kernel")],G.prototype,"_kernel",void 0),Object(T.c)([Object(Y.c)("packedFloat")],G.prototype,"_packedFloat",void 0),Object(T.c)([Object(Y.n)()],G.prototype,"direction",void 0),G}(S.a);Z.a.RegisteredTypes["BABYLON.BlurPostProcess"]=U},478:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(434),S=u(439),j=u(436),O=u(445),M=u(528),H=u(531),A=u(443),p=function(f){Object(T.d)(h,f);function h(m,d,g,v){v===void 0&&(v=!0);var l=f.call(this,m,d,g,v)||this;return l.ellipsoid=new j.e(.5,1,.5),l.ellipsoidOffset=new j.e(0,0,0),l.checkCollisions=!1,l.applyGravity=!1,l._needMoveForGravity=!1,l._oldPosition=j.e.Zero(),l._diffPosition=j.e.Zero(),l._newPosition=j.e.Zero(),l._collisionMask=-1,l._onCollisionPositionChange=function(y,E,R){R===void 0&&(R=null);var F=function(B){l._newPosition.copyFrom(B),l._newPosition.subtractToRef(l._oldPosition,l._diffPosition),l._diffPosition.length()>O.a.CollisionsEpsilon&&(l.position.addInPlace(l._diffPosition),l.onCollide&&R&&l.onCollide(R))};F(E)},l.inputs=new H.a(l),l.inputs.addKeyboard().addMouse(),l}return Object.defineProperty(h.prototype,"angularSensibility",{get:function(){var m=this.inputs.attached.mouse;return m?m.angularSensibility:0},set:function(m){var d=this.inputs.attached.mouse;d&&(d.angularSensibility=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"keysUp",{get:function(){var m=this.inputs.attached.keyboard;return m?m.keysUp:[]},set:function(m){var d=this.inputs.attached.keyboard;d&&(d.keysUp=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"keysUpward",{get:function(){var m=this.inputs.attached.keyboard;return m?m.keysUpward:[]},set:function(m){var d=this.inputs.attached.keyboard;d&&(d.keysUpward=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"keysDown",{get:function(){var m=this.inputs.attached.keyboard;return m?m.keysDown:[]},set:function(m){var d=this.inputs.attached.keyboard;d&&(d.keysDown=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"keysDownward",{get:function(){var m=this.inputs.attached.keyboard;return m?m.keysDownward:[]},set:function(m){var d=this.inputs.attached.keyboard;d&&(d.keysDownward=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"keysLeft",{get:function(){var m=this.inputs.attached.keyboard;return m?m.keysLeft:[]},set:function(m){var d=this.inputs.attached.keyboard;d&&(d.keysLeft=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"keysRight",{get:function(){var m=this.inputs.attached.keyboard;return m?m.keysRight:[]},set:function(m){var d=this.inputs.attached.keyboard;d&&(d.keysRight=m)},enumerable:!1,configurable:!0}),h.prototype.attachControl=function(m,d){d=A.b.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(d)},h.prototype.detachControl=function(m){this.inputs.detachElement(),this.cameraDirection=new j.e(0,0,0),this.cameraRotation=new j.d(0,0)},Object.defineProperty(h.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(m){this._collisionMask=isNaN(m)?-1:m},enumerable:!1,configurable:!0}),h.prototype._collideWithWorld=function(m){var d;this.parent?d=j.e.TransformCoordinates(this.position,this.parent.getWorldMatrix()):d=this.position,d.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);var g=this.getScene().collisionCoordinator;this._collider||(this._collider=g.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var v=m;this.applyGravity&&(v=m.add(this.getScene().gravity)),g.getNewPosition(this._oldPosition,v,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},h.prototype._checkInputs=function(){this._localDirection||(this._localDirection=j.e.Zero(),this._transformedDirection=j.e.Zero()),this.inputs.checkInputs(),f.prototype._checkInputs.call(this)},h.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},h.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):f.prototype._updatePosition.call(this)},h.prototype.dispose=function(){this.inputs.clear(),f.prototype.dispose.call(this)},h.prototype.getClassName=function(){return"FreeCamera"},Object(T.c)([Object(S.o)()],h.prototype,"ellipsoid",void 0),Object(T.c)([Object(S.o)()],h.prototype,"ellipsoidOffset",void 0),Object(T.c)([Object(S.c)()],h.prototype,"checkCollisions",void 0),Object(T.c)([Object(S.c)()],h.prototype,"applyGravity",void 0),h}(M.a)},479:function(Ue,P,u){"use strict";u.d(P,"a",function(){return H});var T=u(434),S=u(440),j=u(442),O=u(532),M=u(596),H=function(A){Object(T.d)(p,A);function p(f,h,m,d,g,v,l){m===void 0&&(m=null),d===void 0&&(d=!1),g===void 0&&(g=3),v===void 0&&(v=5);var y=A.call(this,null,m,!d,l,g,void 0,void 0,void 0,void 0,v)||this;y.name=f,y.wrapU=j.a.CLAMP_ADDRESSMODE,y.wrapV=j.a.CLAMP_ADDRESSMODE,y._generateMipMaps=d;var E=y._getEngine();if(!E)return y;h.getContext?(y._canvas=h,y._texture=E.createDynamicTexture(h.width,h.height,d,g)):(y._canvas=M.a.CreateCanvas(1,1),h.width||h.width===0?y._texture=E.createDynamicTexture(h.width,h.height,d,g):y._texture=E.createDynamicTexture(h,h,d,g));var R=y.getSize();return y._canvas.width=R.width,y._canvas.height=R.height,y._context=y._canvas.getContext("2d"),y}return p.prototype.getClassName=function(){return"DynamicTexture"},Object.defineProperty(p.prototype,"canRescale",{get:function(){return!0},enumerable:!1,configurable:!0}),p.prototype._recreate=function(f){this._canvas.width=f.width,this._canvas.height=f.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(f.width,f.height,this._generateMipMaps,this.samplingMode)},p.prototype.scale=function(f){var h=this.getSize();h.width*=f,h.height*=f,this._recreate(h)},p.prototype.scaleTo=function(f,h){var m=this.getSize();m.width=f,m.height=h,this._recreate(m)},p.prototype.getContext=function(){return this._context},p.prototype.clear=function(){var f=this.getSize();this._context.fillRect(0,0,f.width,f.height)},p.prototype.update=function(f,h){h===void 0&&(h=!1),this._getEngine().updateDynamicTexture(this._texture,this._canvas,f===void 0?!0:f,h,this._format||void 0)},p.prototype.drawText=function(f,h,m,d,g,v,l,y){y===void 0&&(y=!0);var E=this.getSize();if(v&&(this._context.fillStyle=v,this._context.fillRect(0,0,E.width,E.height)),this._context.font=d,h==null){var R=this._context.measureText(f);h=(E.width-R.width)/2}if(m==null){var F=parseInt(d.replace(/\D/g,""));m=E.height/2+F/3.65}this._context.fillStyle=g||"",this._context.fillText(f,h,m),y&&this.update(l)},p.prototype.clone=function(){var f=this.getScene();if(!f)return this;var h=this.getSize(),m=new p(this.name,h,f,this._generateMipMaps);return m.hasAlpha=this.hasAlpha,m.level=this.level,m.wrapU=this.wrapU,m.wrapV=this.wrapV,m},p.prototype.serialize=function(){var f=this.getScene();f&&!f.isReady()&&S.a.Warn("The scene must be ready before serializing the dynamic texture");var h=A.prototype.serialize.call(this);return this._IsCanvasElement(this._canvas)&&(h.base64String=this._canvas.toDataURL()),h.invertY=this._invertY,h.samplingMode=this.samplingMode,h},p.prototype._IsCanvasElement=function(f){return f.toDataURL!==void 0},p.prototype._rebuild=function(){this.update()},p}(j.a)},481:function(Ue,P,u){"use strict";u.d(P,"a",function(){return O});var T=u(434),S=u(443),j=u(439),O=function(){function M(H,A){this.engine=H,this._name=A,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}return Object.defineProperty(M.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(M.prototype,"cameras",{get:function(){return this._cameras},enumerable:!1,configurable:!0}),M.prototype.getClassName=function(){return"PostProcessRenderPipeline"},Object.defineProperty(M.prototype,"isSupported",{get:function(){for(var H in this._renderEffects)if(this._renderEffects.hasOwnProperty(H)&&!this._renderEffects[H].isSupported)return!1;return!0},enumerable:!1,configurable:!0}),M.prototype.addEffect=function(H){this._renderEffects[H._name]=H},M.prototype._rebuild=function(){},M.prototype._enableEffect=function(H,A){var p=this._renderEffects[H];!p||p._enable(S.b.MakeArray(A||this._cameras))},M.prototype._disableEffect=function(H,A){var p=this._renderEffects[H];!p||p._disable(S.b.MakeArray(A||this._cameras))},M.prototype._attachCameras=function(H,A){var p=S.b.MakeArray(H||this._cameras);if(!!p){var f=[],h;for(h=0;h<p.length;h++){var m=p[h];if(!!m){var d=m.name;this._cameras.indexOf(m)===-1?this._cameras[d]=m:A&&f.push(h)}}for(h=0;h<f.length;h++)p.splice(f[h],1);for(var g in this._renderEffects)this._renderEffects.hasOwnProperty(g)&&this._renderEffects[g]._attachCameras(p)}},M.prototype._detachCameras=function(H){var A=S.b.MakeArray(H||this._cameras);if(!!A){for(var p in this._renderEffects)this._renderEffects.hasOwnProperty(p)&&this._renderEffects[p]._detachCameras(A);for(var f=0;f<A.length;f++)this._cameras.splice(this._cameras.indexOf(A[f]),1)}},M.prototype._update=function(){for(var H in this._renderEffects)this._renderEffects.hasOwnProperty(H)&&this._renderEffects[H]._update();for(var A=0;A<this._cameras.length;A++)if(!!this._cameras[A]){var p=this._cameras[A].name;this._renderEffectsForIsolatedPass[p]&&this._renderEffectsForIsolatedPass[p]._update()}},M.prototype._reset=function(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array},M.prototype._enableMSAAOnFirstPostProcess=function(H){if(!this.engine._features.supportMSAA)return!1;var A=Object.keys(this._renderEffects);if(A.length>0){var p=this._renderEffects[A[0]].getPostProcesses();p&&(p[0].samples=H)}return!0},M.prototype.setPrePassRenderer=function(H){return!1},M.prototype.dispose=function(){},Object(T.c)([Object(j.c)()],M.prototype,"_name",void 0),M}()},482:function(Ue,P,u){"use strict";u.d(P,"a",function(){return O});var T=u(452),S=u(548),j=u(449);Object.defineProperty(j.a.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){var M=this._getComponent(T.a.NAME_POSTPROCESSRENDERPIPELINEMANAGER);M||(M=new O(this),this._addComponent(M)),this._postProcessRenderPipelineManager=new S.a}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});var O=function(){function M(H){this.name=T.a.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=H}return M.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(T.a.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)},M.prototype.rebuild=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()},M.prototype.dispose=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()},M.prototype._gatherRenderTargets=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()},M}()},486:function(Ue,P,u){"use strict";u.d(P,"b",function(){return g}),u.d(P,"a",function(){return v});var T=u(434),S=u(444),j=u(445),O=u(435),M="passPixelShader",H=`
varying vec2 vUV;
uniform sampler2D textureSampler;
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
}`;O.a.ShadersStore[M]=H;var A={name:M,shader:H},p="passCubePixelShader",f=`
varying vec2 vUV;
uniform samplerCube textureSampler;
void main(void)
{
vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;O.a.ShadersStore[p]=f;var h={name:p,shader:f},m=u(437),d=u(439),g=function(l){Object(T.d)(y,l);function y(E,R,F,B,L,I,k,Z){return F===void 0&&(F=null),k===void 0&&(k=0),Z===void 0&&(Z=!1),l.call(this,E,"pass",null,null,R,F,B,L,I,void 0,k,void 0,null,Z)||this}return y.prototype.getClassName=function(){return"PassPostProcess"},y._Parse=function(E,R,F,B){return d.a.Parse(function(){return new y(E.name,E.options,R,E.renderTargetSamplingMode,E._engine,E.reusable)},E,F,B)},y}(S.a);m.a.RegisteredTypes["BABYLON.PassPostProcess"]=g;var v=function(l){Object(T.d)(y,l);function y(E,R,F,B,L,I,k,Z){F===void 0&&(F=null),k===void 0&&(k=0),Z===void 0&&(Z=!1);var Y=l.call(this,E,"passCube",null,null,R,F,B,L,I,"#define POSITIVEX",k,void 0,null,Z)||this;return Y._face=0,Y}return Object.defineProperty(y.prototype,"face",{get:function(){return this._face},set:function(E){if(!(E<0||E>5))switch(this._face=E,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");break}},enumerable:!1,configurable:!0}),y.prototype.getClassName=function(){return"PassCubePostProcess"},y._Parse=function(E,R,F,B){return d.a.Parse(function(){return new y(E.name,E.options,R,E.renderTargetSamplingMode,E._engine,E.reusable)},E,F,B)},y}(S.a);j.a._RescalePostProcessFactory=function(l){return new g("rescale",1,null,2,l,!1,0)}},492:function(Ue,P,u){"use strict";var T=u(456),S=u(440),j=u(443),O=u(467);O.a.prototype.updateRawTexture=function(p,f,h,m,d,g){if(d===void 0&&(d=null),g===void 0&&(g=0),!!p){var v=this._getRGBABufferInternalSizedFormat(g,h),l=this._getInternalFormat(h),y=this._getWebGLTextureType(g);this._bindTextureDirectly(this._gl.TEXTURE_2D,p,!0),this._unpackFlipY(m===void 0?!0:!!m),this._doNotHandleContextLost||(p._bufferView=f,p.format=h,p.type=g,p.invertY=m,p._compression=d),p.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),d&&f?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[d],p.width,p.height,0,f):this._gl.texImage2D(this._gl.TEXTURE_2D,0,v,p.width,p.height,0,l,y,f),p.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),p.isReady=!0}},O.a.prototype.createRawTexture=function(p,f,h,m,d,g,v,l,y){l===void 0&&(l=null),y===void 0&&(y=0);var E=new T.a(this,T.b.Raw);E.baseWidth=f,E.baseHeight=h,E.width=f,E.height=h,E.format=m,E.generateMipMaps=d,E.samplingMode=v,E.invertY=g,E._compression=l,E.type=y,this._doNotHandleContextLost||(E._bufferView=p),this.updateRawTexture(E,p,m,g,l,y),this._bindTextureDirectly(this._gl.TEXTURE_2D,E,!0);var R=this._getSamplingParameters(v,d);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,R.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,R.min),d&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(E),E},O.a.prototype.createRawCubeTexture=function(p,f,h,m,d,g,v,l){l===void 0&&(l=null);var y=this._gl,E=new T.a(this,T.b.CubeRaw);E.isCube=!0,E.format=h,E.type=m,this._doNotHandleContextLost||(E._bufferViewArray=p);var R=this._getWebGLTextureType(m),F=this._getInternalFormat(h);F===y.RGB&&(F=y.RGBA),R===y.FLOAT&&!this._caps.textureFloatLinearFiltering?(d=!1,v=1,S.a.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):R===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(d=!1,v=1,S.a.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):R===y.FLOAT&&!this._caps.textureFloatRender?(d=!1,S.a.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):R===y.HALF_FLOAT&&!this._caps.colorBufferFloat&&(d=!1,S.a.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));var B=f,L=B;E.width=B,E.height=L;var I=!this.needPOTTextures||j.b.IsExponentOfTwo(E.width)&&j.b.IsExponentOfTwo(E.height);I||(d=!1),p&&this.updateRawCubeTexture(E,p,h,m,g,l),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,E,!0),p&&d&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);var k=this._getSamplingParameters(v,d);return y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_MAG_FILTER,k.mag),y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_MIN_FILTER,k.min),y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),this._bindTextureDirectly(y.TEXTURE_CUBE_MAP,null),E.generateMipMaps=d,E.samplingMode=v,E},O.a.prototype.updateRawCubeTexture=function(p,f,h,m,d,g,v){g===void 0&&(g=null),v===void 0&&(v=0),p._bufferViewArray=f,p.format=h,p.type=m,p.invertY=d,p._compression=g;var l=this._gl,y=this._getWebGLTextureType(m),E=this._getInternalFormat(h),R=this._getRGBABufferInternalSizedFormat(m),F=!1;E===l.RGB&&(E=l.RGBA,F=!0),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,p,!0),this._unpackFlipY(d===void 0?!0:!!d),p.width%4!=0&&l.pixelStorei(l.UNPACK_ALIGNMENT,1);for(var B=0;B<6;B++){var L=f[B];g?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+B,v,this.getCaps().s3tc[g],p.width,p.height,0,L):(F&&(L=M(L,p.width,p.height,m)),l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+B,v,R,p.width,p.height,0,E,y,L))}var I=!this.needPOTTextures||j.b.IsExponentOfTwo(p.width)&&j.b.IsExponentOfTwo(p.height);I&&p.generateMipMaps&&v===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),p.isReady=!0},O.a.prototype.createRawCubeTextureFromUrl=function(p,f,h,m,d,g,v,l,y,E,R,F){var B=this;y===void 0&&(y=null),E===void 0&&(E=null),R===void 0&&(R=3),F===void 0&&(F=!1);var L=this._gl,I=this.createRawCubeTexture(null,h,m,d,!g,F,R,null);f==null||f._addPendingData(I),I.url=p,this._internalTexturesCache.push(I);var k=function(Y,U){f==null||f._removePendingData(I),E&&Y&&E(Y.status+" "+Y.statusText,U)},Z=function(Y){var U=I.width,Q=v(Y);if(!!Q){if(l){var G=B._getWebGLTextureType(d),K=B._getInternalFormat(m),fe=B._getRGBABufferInternalSizedFormat(d),ce=!1;K===L.RGB&&(K=L.RGBA,ce=!0),B._bindTextureDirectly(L.TEXTURE_CUBE_MAP,I,!0),B._unpackFlipY(!1);for(var re=l(Q),Re=0;Re<re.length;Re++)for(var Ie=U>>Re,Ce=0;Ce<6;Ce++){var X=re[Re][Ce];ce&&(X=M(X,Ie,Ie,d)),L.texImage2D(Ce,Re,fe,Ie,Ie,0,K,G,X)}B._bindTextureDirectly(L.TEXTURE_CUBE_MAP,null)}else B.updateRawCubeTexture(I,Q,m,d,F);I.isReady=!0,f==null||f._removePendingData(I),y&&y()}};return this._loadFile(p,function(Y){Z(Y)},void 0,f==null?void 0:f.offlineProvider,!0,k),I};function M(p,f,h,m){var d;m===1?d=new Float32Array(f*h*4):d=new Uint32Array(f*h*4);for(var g=0;g<f;g++)for(var v=0;v<h;v++){var l=(v*f+g)*3,y=(v*f+g)*4;d[y+0]=p[l+0],d[y+1]=p[l+1],d[y+2]=p[l+2],d[y+3]=1}return d}function H(p){return function(f,h,m,d,g,v,l,y,E,R){E===void 0&&(E=null),R===void 0&&(R=0);var F=p?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,B=p?T.b.Raw3D:T.b.Raw2DArray,L=new T.a(this,B);L.baseWidth=h,L.baseHeight=m,L.baseDepth=d,L.width=h,L.height=m,L.depth=d,L.format=g,L.type=R,L.generateMipMaps=v,L.samplingMode=y,p?L.is3D=!0:L.is2DArray=!0,this._doNotHandleContextLost||(L._bufferView=f),p?this.updateRawTexture3D(L,f,g,l,E,R):this.updateRawTexture2DArray(L,f,g,l,E,R),this._bindTextureDirectly(F,L,!0);var I=this._getSamplingParameters(y,v);return this._gl.texParameteri(F,this._gl.TEXTURE_MAG_FILTER,I.mag),this._gl.texParameteri(F,this._gl.TEXTURE_MIN_FILTER,I.min),v&&this._gl.generateMipmap(F),this._bindTextureDirectly(F,null),this._internalTexturesCache.push(L),L}}O.a.prototype.createRawTexture2DArray=H(!1),O.a.prototype.createRawTexture3D=H(!0);function A(p){return function(f,h,m,d,g,v){g===void 0&&(g=null),v===void 0&&(v=0);var l=p?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,y=this._getWebGLTextureType(v),E=this._getInternalFormat(m),R=this._getRGBABufferInternalSizedFormat(v,m);this._bindTextureDirectly(l,f,!0),this._unpackFlipY(d===void 0?!0:!!d),this._doNotHandleContextLost||(f._bufferView=h,f.format=m,f.invertY=d,f._compression=g),f.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),g&&h?this._gl.compressedTexImage3D(l,0,this.getCaps().s3tc[g],f.width,f.height,f.depth,0,h):this._gl.texImage3D(l,0,R,f.width,f.height,f.depth,0,E,y,h),f.generateMipMaps&&this._gl.generateMipmap(l),this._bindTextureDirectly(l,null),f.isReady=!0}}O.a.prototype.updateRawTexture2DArray=A(!1),O.a.prototype.updateRawTexture3D=A(!0)},498:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(439),j=u(436),O=u(441),M=u(453),H=u(484);M.a.AddNodeConstructor("Light_Type_3",function(p,f){return function(){return new A(p,j.e.Zero(),f)}});var A=function(p){Object(T.d)(f,p);function f(h,m,d){var g=p.call(this,h,d)||this;return g.groundColor=new O.a(0,0,0),g.direction=m||j.e.Up(),g}return f.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},f.prototype.getClassName=function(){return"HemisphericLight"},f.prototype.setDirectionToTarget=function(h){return this.direction=j.e.Normalize(h.subtract(j.e.Zero())),this.direction},f.prototype.getShadowGenerator=function(){return null},f.prototype.transferToEffect=function(h,m){var d=j.e.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",d.x,d.y,d.z,0,m),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),m),this},f.prototype.transferToNodeMaterialEffect=function(h,m){var d=j.e.Normalize(this.direction);return h.setFloat3(m,d.x,d.y,d.z),this},f.prototype.computeWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=j.a.Identity()),this._worldMatrix},f.prototype.getTypeID=function(){return H.a.LIGHTTYPEID_HEMISPHERICLIGHT},f.prototype.prepareLightSpecificDefines=function(h,m){h["HEMILIGHT"+m]=!0},Object(T.c)([Object(S.e)()],f.prototype,"groundColor",void 0),Object(T.c)([Object(S.o)()],f.prototype,"direction",void 0),f}(H.a)},500:function(Ue,P,u){"use strict";var T=u(434),S=u(456),j=u(440),O=u(595),M=u(467);M.a.prototype.createRenderTargetTexture=function(H,A){var p=new O.a;A!==void 0&&typeof A=="object"?(p.generateMipMaps=A.generateMipMaps,p.generateDepthBuffer=!!A.generateDepthBuffer,p.generateStencilBuffer=!!A.generateStencilBuffer,p.type=A.type===void 0?0:A.type,p.samplingMode=A.samplingMode===void 0?3:A.samplingMode,p.format=A.format===void 0?5:A.format):(p.generateMipMaps=A,p.generateDepthBuffer=!0,p.generateStencilBuffer=!1,p.type=0,p.samplingMode=3,p.format=5),(p.type===1&&!this._caps.textureFloatLinearFiltering||p.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(p.samplingMode=1),p.type===1&&!this._caps.textureFloat&&(p.type=0,j.a.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var f=this._gl,h=new S.a(this,S.b.RenderTarget),m=H.width||H,d=H.height||H,g=H.layers||0,v=this._getSamplingParameters(p.samplingMode,!!p.generateMipMaps),l=g!==0?f.TEXTURE_2D_ARRAY:f.TEXTURE_2D,y=this._getRGBABufferInternalSizedFormat(p.type,p.format),E=this._getInternalFormat(p.format),R=this._getWebGLTextureType(p.type);this._bindTextureDirectly(l,h),g!==0?(h.is2DArray=!0,f.texImage3D(l,0,y,m,d,g,0,E,R,null)):f.texImage2D(l,0,y,m,d,0,E,R,null),f.texParameteri(l,f.TEXTURE_MAG_FILTER,v.mag),f.texParameteri(l,f.TEXTURE_MIN_FILTER,v.min),f.texParameteri(l,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(l,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),p.generateMipMaps&&this._gl.generateMipmap(l),this._bindTextureDirectly(l,null);var F=this._currentFramebuffer,B=f.createFramebuffer();return this._bindUnboundFramebuffer(B),h._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!p.generateStencilBuffer,p.generateDepthBuffer,m,d),h.is2DArray||f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,h._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(F),h._framebuffer=B,h.baseWidth=m,h.baseHeight=d,h.width=m,h.height=d,h.depth=g,h.isReady=!0,h.samples=1,h.generateMipMaps=!!p.generateMipMaps,h.samplingMode=p.samplingMode,h.type=p.type,h.format=p.format,h._generateDepthBuffer=p.generateDepthBuffer,h._generateStencilBuffer=!!p.generateStencilBuffer,this._internalTexturesCache.push(h),h},M.a.prototype.createDepthStencilTexture=function(H,A){if(A.isCube){var p=H.width||H;return this._createDepthStencilCubeTexture(p,A)}else return this._createDepthStencilTexture(H,A)},M.a.prototype._createDepthStencilTexture=function(H,A){var p=this._gl,f=H.layers||0,h=f!==0?p.TEXTURE_2D_ARRAY:p.TEXTURE_2D,m=new S.a(this,S.b.Depth);if(!this._caps.depthTextureExtension)return j.a.Error("Depth texture is not supported by your browser or hardware."),m;var d=Object(T.a)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},A);this._bindTextureDirectly(h,m,!0),this._setupDepthStencilTexture(m,H,d.generateStencil,d.bilinearFiltering,d.comparisonFunction);var g=d.generateStencil?p.UNSIGNED_INT_24_8:p.UNSIGNED_INT,v=d.generateStencil?p.DEPTH_STENCIL:p.DEPTH_COMPONENT,l=v;return this.webGLVersion>1&&(l=d.generateStencil?p.DEPTH24_STENCIL8:p.DEPTH_COMPONENT24),m.is2DArray?p.texImage3D(h,0,l,m.width,m.height,f,0,v,g,null):p.texImage2D(h,0,l,m.width,m.height,0,v,g,null),this._bindTextureDirectly(h,null),m}},502:function(Ue,P,u){"use strict";u.d(P,"a",function(){return N});var T=u(436),S=u(447),j=u(442),O=u(538),M=u(454),H=u(441),A=u(455),p=u(533),f=u(476),h=u(459),m=u(435),d="mrtFragmentDeclaration",g=`#if defined(WEBGL2) || defined(WEBGPU)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;m.a.IncludesShadersStore[d]=g;var v={name:d,shader:g},l=u(614),y=u(615),E=u(616),R="geometryPixelShader",F=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY) && (defined(HAS_SPECULAR) || defined(HAS_REFLECTIVITY))
varying vec2 vReflectivityUV;
uniform sampler2D reflectivitySampler;
#endif
#ifdef ALPHATEST
uniform sampler2D diffuseSampler;
#endif
#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
void main() {
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#else
normalOutput=normalize(vNormalV);
#endif
#ifdef PREPASS
#ifdef PREPASS_DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef PREPASS_NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#else
gl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
gl_FragData[1]=vec4(normalOutput,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
#ifdef HAS_SPECULAR

vec4 reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#elif HAS_REFLECTIVITY

vec4 reflectivity=vec4(texture2D(reflectivitySampler,vReflectivityUV).rgb,1.0);
#else
vec4 reflectivity=vec4(0.0,0.0,0.0,1.0);
#endif
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;m.a.ShadersStore[R]=F;var B={name:R,shader:F},L=u(487),I=u(496),k=u(497),Z=u(501),Y="geometryVertexDeclaration",U=`
uniform mat4 viewProjection;
uniform mat4 view;`;m.a.IncludesShadersStore[Y]=U;var Q={name:Y,shader:U},G=u(674),K="geometryUboDeclaration",fe="#include<sceneUboDeclaration>";m.a.IncludesShadersStore[K]=fe;var ce={name:K,shader:fe},re=u(507),Re=u(508),Ie=u(488),Ce=u(489),X=u(675),ae="geometryVertexShader",ee=`precision highp float;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
attribute vec3 position;
attribute vec3 normal;
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;
varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;
varying vec2 vReflectivityUV;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
uniform mat4 previousWorld;
uniform mat4 previousViewProjection;
#ifdef BONES_VELOCITY_ENABLED
#if NUM_BONE_INFLUENCERS>0
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
void main(void)
{
vec3 positionUpdated=position;
vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)

vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*previousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
vec4 pos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;
vNormalW=normalUpdated;
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
vViewPos=view*pos;
#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*previousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*previousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=pos.xyz/pos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uv;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#else
vUV=uv2;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;m.a.ShadersStore[ae]=ee;var w={name:ae,shader:ee},N=function(){function W($,J){J===void 0&&(J=1),this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this._scene=$,this._ratio=J,this._useUbo=$.getEngine().supportsUniformBuffers,W._SceneComponentInitialization(this._scene),this._createRenderTargets()}return W.prototype._linkPrePassRenderer=function($){this._linkedWithPrePass=!0,this._prePassRenderer=$,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(function(J){}))},W.prototype._unlinkPrePassRenderer=function(){this._linkedWithPrePass=!1,this._createRenderTargets()},W.prototype._resetLayout=function(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachments=[]},W.prototype._forceTextureType=function($,J){$===W.POSITION_TEXTURE_TYPE?(this._positionIndex=J,this._enablePosition=!0):$===W.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=J,this._enableVelocity=!0):$===W.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=J,this._enableReflectivity=!0):$===W.DEPTH_TEXTURE_TYPE?this._depthIndex=J:$===W.NORMAL_TEXTURE_TYPE&&(this._normalIndex=J)},W.prototype._setAttachments=function($){this._attachments=$},W.prototype._linkInternalTexture=function($){this._multiRenderTarget._texture=$},Object.defineProperty(W.prototype,"renderList",{get:function(){return this._multiRenderTarget.renderList},set:function($){this._multiRenderTarget.renderList=$},enumerable:!1,configurable:!0}),Object.defineProperty(W.prototype,"isSupported",{get:function(){return this._multiRenderTarget.isSupported},enumerable:!1,configurable:!0}),W.prototype.getTextureIndex=function($){switch($){case W.POSITION_TEXTURE_TYPE:return this._positionIndex;case W.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case W.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;default:return-1}},Object.defineProperty(W.prototype,"enablePosition",{get:function(){return this._enablePosition},set:function($){this._enablePosition=$,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())},enumerable:!1,configurable:!0}),Object.defineProperty(W.prototype,"enableVelocity",{get:function(){return this._enableVelocity},set:function($){this._enableVelocity=$,$||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())},enumerable:!1,configurable:!0}),Object.defineProperty(W.prototype,"enableReflectivity",{get:function(){return this._enableReflectivity},set:function($){this._enableReflectivity=$,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())},enumerable:!1,configurable:!0}),Object.defineProperty(W.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(W.prototype,"ratio",{get:function(){return this._ratio},enumerable:!1,configurable:!0}),W.prototype.isReady=function($,J){var le=$.getMaterial();if(le&&le.disableDepthWrite)return!1;var ne=[],be=[S.b.PositionKind,S.b.NormalKind],Me=$.getMesh();if(le){var Te=!1;le.needAlphaTesting()&&le.getAlphaTestTexture()&&(ne.push("#define ALPHATEST"),ne.push("#define ALPHATEST_UV"+(le.getAlphaTestTexture().coordinatesIndex+1)),Te=!0),le.bumpTexture&&A.a.BumpTextureEnabled&&(ne.push("#define BUMP"),ne.push("#define BUMP_UV"+(le.bumpTexture.coordinatesIndex+1)),Te=!0),this._enableReflectivity&&(le instanceof A.a&&le.specularTexture?(ne.push("#define HAS_SPECULAR"),ne.push("#define REFLECTIVITY_UV"+(le.specularTexture.coordinatesIndex+1)),Te=!0):le instanceof p.a&&le.reflectivityTexture&&(ne.push("#define HAS_REFLECTIVITY"),ne.push("#define REFLECTIVITY_UV"+(le.reflectivityTexture.coordinatesIndex+1)),Te=!0)),Te&&(ne.push("#define NEED_UV"),Me.isVerticesDataPresent(S.b.UVKind)&&(be.push(S.b.UVKind),ne.push("#define UV1")),Me.isVerticesDataPresent(S.b.UV2Kind)&&(be.push(S.b.UV2Kind),ne.push("#define UV2")))}this._linkedWithPrePass&&(ne.push("#define PREPASS"),this._depthIndex!==-1&&(ne.push("#define DEPTH_INDEX "+this._depthIndex),ne.push("#define PREPASS_DEPTH")),this._normalIndex!==-1&&(ne.push("#define NORMAL_INDEX "+this._normalIndex),ne.push("#define PREPASS_NORMAL"))),this._enablePosition&&(ne.push("#define POSITION"),ne.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(ne.push("#define VELOCITY"),ne.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(Me)===-1&&ne.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(ne.push("#define REFLECTIVITY"),ne.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),Me.useBones&&Me.computeBonesUsingShaders?(be.push(S.b.MatricesIndicesKind),be.push(S.b.MatricesWeightsKind),Me.numBoneInfluencers>4&&(be.push(S.b.MatricesIndicesExtraKind),be.push(S.b.MatricesWeightsExtraKind)),ne.push("#define NUM_BONE_INFLUENCERS "+Me.numBoneInfluencers),ne.push("#define BonesPerMesh "+(Me.skeleton?Me.skeleton.bones.length+1:0))):ne.push("#define NUM_BONE_INFLUENCERS 0");var Ae=Me.morphTargetManager,se=0;Ae&&Ae.numInfluencers>0&&(se=Ae.numInfluencers,ne.push("#define MORPHTARGETS"),ne.push("#define NUM_MORPH_INFLUENCERS "+se),Ae.isUsingTextureForTargets&&ne.push("#define MORPHTARGETS_TEXTURE"),M.a.PrepareAttributesForMorphTargetsInfluencers(be,Me,se)),J&&(ne.push("#define INSTANCES"),M.a.PushAttributesForInstances(be),$.getRenderingMesh().hasThinInstances&&ne.push("#define THIN_INSTANCES")),this._linkedWithPrePass?ne.push("#define RENDER_TARGET_COUNT "+this._attachments.length):ne.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length);var te=ne.join(`
`);return this._cachedDefines!==te&&(this._cachedDefines=te,this._effect=this._scene.getEngine().createEffect("geometry",{attributes:be,uniformsNames:["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],samplers:["diffuseSampler","bumpSampler","reflectivitySampler","morphTargets"],defines:te,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:se}},this._scene.getEngine())),this._effect.isReady()},W.prototype.getGBuffer=function(){return this._multiRenderTarget},Object.defineProperty(W.prototype,"samples",{get:function(){return this._multiRenderTarget.samples},set:function($){this._multiRenderTarget.samples=$},enumerable:!1,configurable:!0}),W.prototype.dispose=function(){if(this._resizeObserver){var $=this._scene.getEngine();$.onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null}this.getGBuffer().dispose()},W.prototype._assignRenderTargetIndices=function(){var $=2;return this._enablePosition&&(this._positionIndex=$,$++),this._enableVelocity&&(this._velocityIndex=$,$++),this._enableReflectivity&&(this._reflectivityIndex=$,$++),$},W.prototype._createRenderTargets=function(){var $=this,J=this._scene.getEngine(),le=this._assignRenderTargetIndices();if(this._multiRenderTarget=new O.a("gBuffer",{width:J.getRenderWidth()*this._ratio,height:J.getRenderHeight()*this._ratio},le,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:1}),!!this.isSupported){this._multiRenderTarget.wrapU=j.a.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=j.a.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null,this._multiRenderTarget.onClearObservable.add(function(be){be.clear(new H.b(0,0,0,1),!0,!0,!0)}),this._resizeObserver=J.onResizeObservable.add(function(){$._multiRenderTarget&&$._multiRenderTarget.resize({width:J.getRenderWidth()*$._ratio,height:J.getRenderHeight()*$._ratio})});var ne=function(be){var Me=be.getRenderingMesh(),Te=be.getEffectiveMesh(),Ae=$._scene,se=Ae.getEngine(),te=be.getMaterial();if(!!te){if(Te._internalAbstractMeshDataInfo._isActiveIntermediate=!1,$._enableVelocity&&!$._previousTransformationMatrices[Te.uniqueId]&&($._previousTransformationMatrices[Te.uniqueId]={world:T.a.Identity(),viewProjection:Ae.getTransformMatrix()},Me.skeleton)){var he=Me.skeleton.getTransformMatrices(Me);$._previousBonesTransformationMatrices[Me.uniqueId]=$._copyBonesTransformationMatrices(he,new Float32Array(he.length))}var de=Me._getInstancesRenderList(be._id,!!be.getReplacementMesh());if(!de.mustReturn){var Ne=se.getCaps().instancedArrays&&(de.visibleInstances[be._id]!==null||Me.hasThinInstances),Le=Te.getWorldMatrix();if($.isReady(be,Ne)){if(se.enableEffect($._effect),Me._bind(be,$._effect,te.fillMode),$._useUbo?(M.a.FinalizeSceneUbo($._scene),M.a.BindSceneUniformBuffer($._effect,$._scene.getSceneUniformBuffer())):($._effect.setMatrix("viewProjection",Ae.getTransformMatrix()),$._effect.setMatrix("view",Ae.getViewMatrix())),te){var pe,He=Me._instanceDataStorage;if(!He.isFrozen&&(te.backFaceCulling||te.overrideMaterialSideOrientation!==null)){var rt=Te._getWorldMatrixDeterminant();pe=te.overrideMaterialSideOrientation,pe==null&&(pe=te.sideOrientation),rt<0&&(pe=pe===h.a.ClockWiseSideOrientation?h.a.CounterClockWiseSideOrientation:h.a.ClockWiseSideOrientation)}else pe=He.sideOrientation;if(te._preBind($._effect,pe),te.needAlphaTesting()){var ot=te.getAlphaTestTexture();ot&&($._effect.setTexture("diffuseSampler",ot),$._effect.setMatrix("diffuseMatrix",ot.getTextureMatrix()))}te.bumpTexture&&Ae.getEngine().getCaps().standardDerivatives&&A.a.BumpTextureEnabled&&($._effect.setFloat3("vBumpInfos",te.bumpTexture.coordinatesIndex,1/te.bumpTexture.level,te.parallaxScaleBias),$._effect.setMatrix("bumpMatrix",te.bumpTexture.getTextureMatrix()),$._effect.setTexture("bumpSampler",te.bumpTexture),$._effect.setFloat2("vTangentSpaceParams",te.invertNormalMapX?-1:1,te.invertNormalMapY?-1:1)),$._enableReflectivity&&(te instanceof A.a&&te.specularTexture?($._effect.setMatrix("reflectivityMatrix",te.specularTexture.getTextureMatrix()),$._effect.setTexture("reflectivitySampler",te.specularTexture)):te instanceof p.a&&te.reflectivityTexture&&($._effect.setMatrix("reflectivityMatrix",te.reflectivityTexture.getTextureMatrix()),$._effect.setTexture("reflectivitySampler",te.reflectivityTexture)))}Me.useBones&&Me.computeBonesUsingShaders&&Me.skeleton&&($._effect.setMatrices("mBones",Me.skeleton.getTransformMatrices(Me)),$._enableVelocity&&$._effect.setMatrices("mPreviousBones",$._previousBonesTransformationMatrices[Me.uniqueId])),M.a.BindMorphTargetParameters(Me,$._effect),Me.morphTargetManager&&Me.morphTargetManager.isUsingTextureForTargets&&Me.morphTargetManager._bind($._effect),$._enableVelocity&&($._effect.setMatrix("previousWorld",$._previousTransformationMatrices[Te.uniqueId].world),$._effect.setMatrix("previousViewProjection",$._previousTransformationMatrices[Te.uniqueId].viewProjection)),Me._processRendering(Te,be,$._effect,te.fillMode,de,Ne,function(et,ht){return $._effect.setMatrix("world",ht)})}$._enableVelocity&&($._previousTransformationMatrices[Te.uniqueId].world=Le.clone(),$._previousTransformationMatrices[Te.uniqueId].viewProjection=$._scene.getTransformMatrix().clone(),Me.skeleton&&$._copyBonesTransformationMatrices(Me.skeleton.getTransformMatrices(Me),$._previousBonesTransformationMatrices[Te.uniqueId]))}}};this._multiRenderTarget.customRenderFunction=function(be,Me,Te,Ae){var se;if($._linkedWithPrePass){if(!$._prePassRenderer.enabled)return;$._scene.getEngine().bindAttachments($._attachments)}if(Ae.length){for(J.setColorWrite(!1),se=0;se<Ae.length;se++)ne(Ae.data[se]);J.setColorWrite(!0)}for(se=0;se<be.length;se++)ne(be.data[se]);for(J.setDepthWrite(!1),se=0;se<Me.length;se++)ne(Me.data[se]);if($.renderTransparentMeshes)for(se=0;se<Te.length;se++)ne(Te.data[se]);J.setDepthWrite(!0)}}},W.prototype._copyBonesTransformationMatrices=function($,J){for(var le=0;le<$.length;le++)J[le]=$[le];return J},W.DEPTH_TEXTURE_TYPE=0,W.NORMAL_TEXTURE_TYPE=1,W.POSITION_TEXTURE_TYPE=2,W.VELOCITY_TEXTURE_TYPE=3,W.REFLECTIVITY_TEXTURE_TYPE=4,W._SceneComponentInitialization=function($){throw f.a.WarnImport("GeometryBufferRendererSceneComponent")},W}()},503:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(440),S=u(588),j=u(436),O=u(462),M=u(446),H=u(510),A=u(465);M.a._PhysicsImpostorParser=function(f,h,m){return new p(h,m.physicsImpostor,{mass:m.physicsMass,friction:m.physicsFriction,restitution:m.physicsRestitution},f)};var p=function(){function f(h,m,d,g){var v=this;if(d===void 0&&(d={mass:0}),this.object=h,this.type=m,this._options=d,this._scene=g,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=j.e.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new j.b,this._tmpQuat2=new j.b,this.beforeStep=function(){!v._physicsEngine||(v.object.translate(v._deltaPosition,-1),v._deltaRotationConjugated&&v.object.rotationQuaternion&&v.object.rotationQuaternion.multiplyToRef(v._deltaRotationConjugated,v.object.rotationQuaternion),v.object.computeWorldMatrix(!1),v.object.parent&&v.object.rotationQuaternion?(v.getParentsRotation(),v._tmpQuat.multiplyToRef(v.object.rotationQuaternion,v._tmpQuat)):v._tmpQuat.copyFrom(v.object.rotationQuaternion||new j.b),v._options.disableBidirectionalTransformation||v.object.rotationQuaternion&&v._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(v,v.object.getAbsolutePosition(),v._tmpQuat),v._onBeforePhysicsStepCallbacks.forEach(function(l){l(v)}))},this.afterStep=function(){!v._physicsEngine||(v._onAfterPhysicsStepCallbacks.forEach(function(l){l(v)}),v._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(v),v.object.parent&&v.object.rotationQuaternion&&(v.getParentsRotation(),v._tmpQuat.conjugateInPlace(),v._tmpQuat.multiplyToRef(v.object.rotationQuaternion,v.object.rotationQuaternion)),v.object.setAbsolutePosition(v.object.position),v._deltaRotation&&v.object.rotationQuaternion&&v.object.rotationQuaternion.multiplyToRef(v._deltaRotation,v.object.rotationQuaternion),v.object.translate(v._deltaPosition,1))},this.onCollideEvent=null,this.onCollide=function(l){if(!(!v._onPhysicsCollideCallbacks.length&&!v.onCollideEvent)&&!!v._physicsEngine){var y=v._physicsEngine.getImpostorWithPhysicsBody(l.body);y&&(v.onCollideEvent&&v.onCollideEvent(v,y),v._onPhysicsCollideCallbacks.filter(function(E){return E.otherImpostors.indexOf(y)!==-1}).forEach(function(E){E.callback(v,y,l.point)}))}},!this.object){T.a.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&d.mass!==0&&T.a.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&h.getScene&&(this._scene=h.getScene()),!!this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=j.b.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new j.b),this._options.mass=d.mass===void 0?0:d.mass,this._options.friction=d.friction===void 0?.2:d.friction,this._options.restitution=d.restitution===void 0?.2:d.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=d.pressure===void 0?200:d.pressure,this._options.stiffness=d.stiffness===void 0?1:d.stiffness,this._options.velocityIterations=d.velocityIterations===void 0?20:d.velocityIterations,this._options.positionIterations=d.positionIterations===void 0?20:d.positionIterations,this._options.fixedPoints=d.fixedPoints===void 0?0:d.fixedPoints,this._options.margin=d.margin===void 0?0:d.margin,this._options.damping=d.damping===void 0?0:d.damping,this._options.path=d.path===void 0?null:d.path,this._options.shape=d.shape===void 0?null:d.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&T.a.Warn("You must affect impostors to children before affecting impostor to parent.")):T.a.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}return Object.defineProperty(f.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"mass",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0},set:function(h){this.setMass(h)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"friction",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0},set:function(h){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,h)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"restitution",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0},set:function(h){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,h)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"pressure",{get:function(){if(!this._physicsEngine)return 0;var h=this._physicsEngine.getPhysicsPlugin();return h.setBodyPressure?h.getBodyPressure(this):0},set:function(h){if(!!this._physicsEngine){var m=this._physicsEngine.getPhysicsPlugin();!m.setBodyPressure||m.setBodyPressure(this,h)}},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"stiffness",{get:function(){if(!this._physicsEngine)return 0;var h=this._physicsEngine.getPhysicsPlugin();return h.getBodyStiffness?h.getBodyStiffness(this):0},set:function(h){if(!!this._physicsEngine){var m=this._physicsEngine.getPhysicsPlugin();!m.setBodyStiffness||m.setBodyStiffness(this,h)}},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"velocityIterations",{get:function(){if(!this._physicsEngine)return 0;var h=this._physicsEngine.getPhysicsPlugin();return h.getBodyVelocityIterations?h.getBodyVelocityIterations(this):0},set:function(h){if(!!this._physicsEngine){var m=this._physicsEngine.getPhysicsPlugin();!m.setBodyVelocityIterations||m.setBodyVelocityIterations(this,h)}},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"positionIterations",{get:function(){if(!this._physicsEngine)return 0;var h=this._physicsEngine.getPhysicsPlugin();return h.getBodyPositionIterations?h.getBodyPositionIterations(this):0},set:function(h){if(!!this._physicsEngine){var m=this._physicsEngine.getPhysicsPlugin();!m.setBodyPositionIterations||m.setBodyPositionIterations(this,h)}},enumerable:!1,configurable:!0}),f.prototype._init=function(){!this._physicsEngine||(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))},f.prototype._getPhysicsParent=function(){if(this.object.parent instanceof O.a){var h=this.object.parent;return h.physicsImpostor}return null},f.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&!this._parent},f.prototype.setScalingUpdated=function(){this.forceUpdate()},f.prototype.forceUpdate=function(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()},Object.defineProperty(f.prototype,"physicsBody",{get:function(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody},set:function(h){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=h,this.resetUpdateFlags()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"parent",{get:function(){return!this._options.ignoreParent&&this._parent?this._parent:null},set:function(h){this._parent=h},enumerable:!1,configurable:!0}),f.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=!1},f.prototype.getObjectExtendSize=function(){if(this.object.getBoundingInfo){var h=this.object.rotationQuaternion,m=this.object.scaling.clone();this.object.rotationQuaternion=f.IDENTITY_QUATERNION;var d=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);d&&d.decompose(m,void 0,void 0);var g=this.object.getBoundingInfo(),v=g.boundingBox.extendSize.scale(2).multiplyInPlace(m);return this.object.rotationQuaternion=h,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),v}else return f.DEFAULT_OBJECT_SIZE},f.prototype.getObjectCenter=function(){if(this.object.getBoundingInfo){var h=this.object.getBoundingInfo();return h.boundingBox.centerWorld}else return this.object.position},f.prototype.getParam=function(h){return this._options[h]},f.prototype.setParam=function(h,m){this._options[h]=m,this._bodyUpdateRequired=!0},f.prototype.setMass=function(h){this.getParam("mass")!==h&&this.setParam("mass",h),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,h)},f.prototype.getLinearVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):j.e.Zero()},f.prototype.setLinearVelocity=function(h){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,h)},f.prototype.getAngularVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):j.e.Zero()},f.prototype.setAngularVelocity=function(h){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,h)},f.prototype.executeNativeFunction=function(h){this._physicsEngine&&h(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)},f.prototype.registerBeforePhysicsStep=function(h){this._onBeforePhysicsStepCallbacks.push(h)},f.prototype.unregisterBeforePhysicsStep=function(h){var m=this._onBeforePhysicsStepCallbacks.indexOf(h);m>-1?this._onBeforePhysicsStepCallbacks.splice(m,1):T.a.Warn("Function to remove was not found")},f.prototype.registerAfterPhysicsStep=function(h){this._onAfterPhysicsStepCallbacks.push(h)},f.prototype.unregisterAfterPhysicsStep=function(h){var m=this._onAfterPhysicsStepCallbacks.indexOf(h);m>-1?this._onAfterPhysicsStepCallbacks.splice(m,1):T.a.Warn("Function to remove was not found")},f.prototype.registerOnPhysicsCollide=function(h,m){var d=h instanceof Array?h:[h];this._onPhysicsCollideCallbacks.push({callback:m,otherImpostors:d})},f.prototype.unregisterOnPhysicsCollide=function(h,m){var d=h instanceof Array?h:[h],g=-1,v=this._onPhysicsCollideCallbacks.some(function(l,y){if(l.callback===m&&l.otherImpostors.length===d.length){var E=l.otherImpostors.every(function(R){return d.indexOf(R)>-1});return E&&(g=y),E}return!1});v?this._onPhysicsCollideCallbacks.splice(g,1):T.a.Warn("Function to remove was not found")},f.prototype.getParentsRotation=function(){var h=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);h;)h.rotationQuaternion?this._tmpQuat2.copyFrom(h.rotationQuaternion):j.b.RotationYawPitchRollToRef(h.rotation.y,h.rotation.x,h.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),h=h.parent;return this._tmpQuat},f.prototype.applyForce=function(h,m){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,h,m),this},f.prototype.applyImpulse=function(h,m){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,h,m),this},f.prototype.createJoint=function(h,m,d){var g=new H.e(m,d);return this.addJoint(h,g),this},f.prototype.addJoint=function(h,m){return this._joints.push({otherImpostor:h,joint:m}),this._physicsEngine&&this._physicsEngine.addJoint(this,h,m),this},f.prototype.addAnchor=function(h,m,d,g,v){if(!this._physicsEngine)return this;var l=this._physicsEngine.getPhysicsPlugin();return l.appendAnchor?(this._physicsEngine&&l.appendAnchor(this,h,m,d,g,v),this):this},f.prototype.addHook=function(h,m,d,g){if(!this._physicsEngine)return this;var v=this._physicsEngine.getPhysicsPlugin();return v.appendAnchor?(this._physicsEngine&&v.appendHook(this,h,m,d,g),this):this},f.prototype.sleep=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this},f.prototype.wakeUp=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this},f.prototype.clone=function(h){return h?new f(h,this.type,this._options,this._scene):null},f.prototype.dispose=function(){var h=this;!this._physicsEngine||(this._joints.forEach(function(m){h._physicsEngine&&h._physicsEngine.removeJoint(h,m.otherImpostor,m.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)},f.prototype.setDeltaPosition=function(h){this._deltaPosition.copyFrom(h)},f.prototype.setDeltaRotation=function(h){this._deltaRotation||(this._deltaRotation=new j.b),this._deltaRotation.copyFrom(h),this._deltaRotationConjugated=this._deltaRotation.conjugate()},f.prototype.getBoxSizeToRef=function(h){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,h),this},f.prototype.getRadius=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0},f.prototype.syncBoneWithImpostor=function(h,m,d,g,v){var l=f._tmpVecs[0],y=this.object;if(y.rotationQuaternion)if(v){var E=f._tmpQuat;y.rotationQuaternion.multiplyToRef(v,E),h.setRotationQuaternion(E,A.c.WORLD,m)}else h.setRotationQuaternion(y.rotationQuaternion,A.c.WORLD,m);l.x=0,l.y=0,l.z=0,d&&(l.x=d.x,l.y=d.y,l.z=d.z,h.getDirectionToRef(l,m,l),g==null&&(g=d.length()),l.x*=g,l.y*=g,l.z*=g),h.getParent()?(l.addInPlace(y.getAbsolutePosition()),h.setAbsolutePosition(l,m)):(m.setAbsolutePosition(y.getAbsolutePosition()),m.position.x-=l.x,m.position.y-=l.y,m.position.z-=l.z)},f.prototype.syncImpostorWithBone=function(h,m,d,g,v,l){var y=this.object;if(y.rotationQuaternion)if(v){var E=f._tmpQuat;h.getRotationQuaternionToRef(A.c.WORLD,m,E),E.multiplyToRef(v,y.rotationQuaternion)}else h.getRotationQuaternionToRef(A.c.WORLD,m,y.rotationQuaternion);var R=f._tmpVecs[0],F=f._tmpVecs[1];l||(l=f._tmpVecs[2],l.x=0,l.y=1,l.z=0),h.getDirectionToRef(l,m,F),h.getAbsolutePositionToRef(m,R),g==null&&d&&(g=d.length()),g!=null&&(R.x+=F.x*g,R.y+=F.y*g,R.z+=F.z*g),y.setAbsolutePosition(R)},f.DEFAULT_OBJECT_SIZE=new j.e(1,1,1),f.IDENTITY_QUATERNION=j.b.Identity(),f._tmpVecs=S.a.BuildArray(3,j.e.Zero),f._tmpQuat=j.b.Identity(),f.NoImpostor=0,f.SphereImpostor=1,f.BoxImpostor=2,f.PlaneImpostor=3,f.MeshImpostor=4,f.CapsuleImpostor=6,f.CylinderImpostor=7,f.ParticleImpostor=8,f.HeightmapImpostor=9,f.ConvexHullImpostor=10,f.CustomImpostor=100,f.RopeImpostor=101,f.ClothImpostor=102,f.SoftbodyImpostor=103,f}()},504:function(Ue,P,u){"use strict";u.d(P,"a",function(){return m});var T=u(434),S=u(439),j=u(443),O=u(436),M=u(477),H=u(442),A=u(437),p=u(565),f=u(473),h=u(438),m=function(d){Object(T.d)(g,d);function g(v,l,y,E,R,F,B,L,I,k,Z,Y,U,Q){y===void 0&&(y=null),E===void 0&&(E=!1),R===void 0&&(R=null),F===void 0&&(F=null),B===void 0&&(B=null),L===void 0&&(L=5),I===void 0&&(I=!1),k===void 0&&(k=null),Z===void 0&&(Z=!1),Y===void 0&&(Y=.8),U===void 0&&(U=0);var G,K=d.call(this,l)||this;if(K.onLoadObservable=new h.c,K.boundingBoxPosition=O.e.Zero(),K._rotationY=0,K._files=null,K._forcedExtension=null,K._extensions=null,K.name=v,K.url=v,K._noMipmap=E,K.hasAlpha=!1,K._format=L,K.isCube=!0,K._textureMatrix=O.a.Identity(),K._createPolynomials=Z,K.coordinatesMode=H.a.CUBIC_MODE,K._extensions=y,K._files=R,K._forcedExtension=k,K._loaderOptions=Q,!v&&!R)return K;var fe=v.lastIndexOf("."),ce=k||(fe>-1?v.substring(fe).toLowerCase():""),re=ce.indexOf(".dds")===0,Re=ce.indexOf(".env")===0;if(Re?(K.gammaSpace=!1,K._prefiltered=!1,K.anisotropicFilteringLevel=1):(K._prefiltered=I,I&&(K.gammaSpace=!1,K.anisotropicFilteringLevel=1)),K._texture=K._getFromCache(v,E),!R&&(!Re&&!re&&!y&&(y=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),R=[],y))for(var Ie=0;Ie<y.length;Ie++)R.push(v+y[Ie]);K._files=R;var Ce=function(){K.onLoadObservable.notifyObservers(K),F&&F()};if(K._texture)K._texture.isReady?j.b.SetImmediate(function(){return Ce()}):K._texture.onLoadedObservable.add(function(){return Ce()});else{var X=K.getScene();(X==null?void 0:X.useDelayedTextureLoading)?K.delayLoadState=4:(I?K._texture=K._getEngine().createPrefilteredCubeTexture(v,X,Y,U,F,B,L,k,K._createPolynomials):K._texture=K._getEngine().createCubeTexture(v,X,R,E,F,B,K._format,k,!1,Y,U,null,Q),(G=K._texture)===null||G===void 0||G.onLoadedObservable.add(function(){return K.onLoadObservable.notifyObservers(K)}))}return K}return Object.defineProperty(g.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(v){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(v))){this._boundingBoxSize=v;var l=this.getScene();l&&l.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"rotationY",{get:function(){return this._rotationY},set:function(v){this._rotationY=v,this.setReflectionTextureMatrix(O.a.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"forcedExtension",{get:function(){return this._forcedExtension},enumerable:!1,configurable:!0}),g.CreateFromImages=function(v,l,y){var E="";return v.forEach(function(R){return E+=R}),new g(E,l,null,y,v)},g.CreateFromPrefilteredData=function(v,l,y,E){y===void 0&&(y=null),E===void 0&&(E=!0);var R=l.useDelayedTextureLoading;l.useDelayedTextureLoading=!1;var F=new g(v,l,null,!1,null,null,null,void 0,!0,y,E);return l.useDelayedTextureLoading=R,F},g.prototype.getClassName=function(){return"CubeTexture"},g.prototype.updateURL=function(v,l,y,E){var R;E===void 0&&(E=!1),this.url&&(this.releaseInternalTexture(),(R=this.getScene())===null||R===void 0||R.markAllMaterialsAsDirty(1)),(!this.name||f.a.StartsWith(this.name,"data:"))&&(this.name=v),this.url=v,this.delayLoadState=4,this._prefiltered=E,this._prefiltered&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1),this._forcedExtension=l||null,y&&(this._delayedOnLoad=y),this.delayLoad(l)},g.prototype.delayLoad=function(v){var l=this,y;if(this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),!this._texture)){var E=this.getScene();this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,E,.8,0,this._delayedOnLoad,void 0,this._format,v,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,E,this._files,this._noMipmap,this._delayedOnLoad,null,this._format,v,!1,0,0,null,this._loaderOptions),(y=this._texture)===null||y===void 0||y.onLoadedObservable.add(function(){return l.onLoadObservable.notifyObservers(l)})}},g.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},g.prototype.setReflectionTextureMatrix=function(v){var l=this,y;v.updateFlag!==this._textureMatrix.updateFlag&&(v.isIdentity()!==this._textureMatrix.isIdentity()&&((y=this.getScene())===null||y===void 0||y.markAllMaterialsAsDirty(1,function(E){return E.getActiveTextures().indexOf(l)!==-1})),this._textureMatrix=v)},g.Parse=function(v,l,y){var E=S.a.Parse(function(){var L=!1;return v.prefiltered&&(L=v.prefiltered),new g(y+v.name,l,v.extensions,!1,v.files||null,null,null,void 0,L,v.forcedExtension)},v,l);if(v.boundingBoxPosition&&(E.boundingBoxPosition=O.e.FromArray(v.boundingBoxPosition)),v.boundingBoxSize&&(E.boundingBoxSize=O.e.FromArray(v.boundingBoxSize)),v.animations)for(var R=0;R<v.animations.length;R++){var F=v.animations[R],B=A.a.GetClass("BABYLON.Animation");B&&E.animations.push(B.Parse(F))}return E},g.prototype.clone=function(){var v=this,l=0,y=S.a.Clone(function(){var E=new g(v.url,v.getScene()||v._getEngine(),v._extensions,v._noMipmap,v._files);return l=E.uniqueId,E},this);return y.uniqueId=l,y},Object(T.c)([Object(S.c)()],g.prototype,"url",void 0),Object(T.c)([Object(S.c)("rotationY")],g.prototype,"rotationY",null),Object(T.c)([Object(S.c)("files")],g.prototype,"_files",void 0),Object(T.c)([Object(S.c)("forcedExtension")],g.prototype,"_forcedExtension",void 0),Object(T.c)([Object(S.c)("extensions")],g.prototype,"_extensions",void 0),Object(T.c)([Object(S.j)("textureMatrix")],g.prototype,"_textureMatrix",void 0),g}(M.a);H.a._CubeTextureParser=m.Parse,A.a.RegisteredTypes["BABYLON.CubeTexture"]=m},505:function(Ue,P,u){"use strict";u.d(P,"a",function(){return f});var T=u(446),S=u(449),j=u(438),O=u(436),M=u(464),H=u(469),A=u(546),p=u(526),f=function(){function h(m){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this.maxDragAngle=0,this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerID=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new j.c,this.onDragStartObservable=new j.c,this.onDragEndObservable=new j.c,this.moveAttached=!0,this.enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=function(g){return!0},this._tmpVector=new O.e(0,0,0),this._alternatePickedPoint=new O.e(0,0,0),this._worldDragAxis=new O.e(0,0,0),this._targetPosition=new O.e(0,0,0),this._attachedToElement=!1,this._startDragRay=new H.a(new O.e,new O.e),this._lastPointerRay={},this._dragDelta=new O.e,this._pointA=new O.e(0,0,0),this._pointC=new O.e(0,0,0),this._localAxis=new O.e(0,0,0),this._lookAt=new O.e(0,0,0),this._options=m||{};var d=0;if(this._options.dragAxis&&d++,this._options.dragPlaneNormal&&d++,d>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}return Object.defineProperty(h.prototype,"options",{get:function(){return this._options},set:function(m){this._options=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"name",{get:function(){return"PointerDrag"},enumerable:!1,configurable:!0}),h.prototype.init=function(){},h.prototype.attach=function(m,d){var g=this;this._scene=m.getScene(),this.attachedNode=m,h._planeScene||(this._debugMode?h._planeScene=this._scene:(h._planeScene=new S.a(this._scene.getEngine(),{virtual:!0}),h._planeScene.detachControl(),this._scene.onDisposeObservable.addOnce(function(){h._planeScene.dispose(),h._planeScene=null}))),this._dragPlane=T.a.CreatePlane("pointerDragPlane",this._debugMode?1:1e4,h._planeScene,!1,T.a.DOUBLESIDE),this.lastDragPosition=new O.e(0,0,0);var v=d||function(l){return g.attachedNode==l||l.isDescendantOf(g.attachedNode)};this._pointerObserver=this._scene.onPointerObservable.add(function(l,y){if(!g.enabled){g._attachedToElement&&g.releaseDrag();return}if(l.type==M.a.POINTERDOWN)g.startAndReleaseDragOnPointerEvents&&!g.dragging&&l.pickInfo&&l.pickInfo.hit&&l.pickInfo.pickedMesh&&l.pickInfo.pickedPoint&&l.pickInfo.ray&&v(l.pickInfo.pickedMesh)&&g._startDrag(l.event.pointerId,l.pickInfo.ray,l.pickInfo.pickedPoint);else if(l.type==M.a.POINTERUP)g.startAndReleaseDragOnPointerEvents&&g.currentDraggingPointerID==l.event.pointerId&&g.releaseDrag();else if(l.type==M.a.POINTERMOVE){var E=l.event.pointerId;if(g.currentDraggingPointerID===h._AnyMouseID&&E!==h._AnyMouseID){var R=l.event,F=R.pointerType==="mouse"||!g._scene.getEngine().hostInformation.isMobile&&R instanceof MouseEvent;F&&(g._lastPointerRay[g.currentDraggingPointerID]&&(g._lastPointerRay[E]=g._lastPointerRay[g.currentDraggingPointerID],delete g._lastPointerRay[g.currentDraggingPointerID]),g.currentDraggingPointerID=E)}g._lastPointerRay[E]||(g._lastPointerRay[E]=new H.a(new O.e,new O.e)),l.pickInfo&&l.pickInfo.ray&&(g._lastPointerRay[E].origin.copyFrom(l.pickInfo.ray.origin),g._lastPointerRay[E].direction.copyFrom(l.pickInfo.ray.direction),g.currentDraggingPointerID==E&&g.dragging&&g._moveDrag(l.pickInfo.ray))}}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(function(){g._moving&&g.moveAttached&&(A.a._RemoveAndStorePivotPoint(g.attachedNode),g._targetPosition.subtractToRef(g.attachedNode.absolutePosition,g._tmpVector),g._tmpVector.scaleInPlace(g.dragDeltaRatio),g.attachedNode.getAbsolutePosition().addToRef(g._tmpVector,g._tmpVector),g.validateDrag(g._tmpVector)&&g.attachedNode.setAbsolutePosition(g._tmpVector),A.a._RestorePivotPoint(g.attachedNode))})},h.prototype.releaseDrag=function(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerID})),this.currentDraggingPointerID=-1,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if(this._scene.activeCamera.getClassName()==="ArcRotateCamera"){var m=this._scene.activeCamera;m.attachControl(m.inputs?m.inputs.noPreventDefault:!0,m._useCtrlForPanning,m._panningMouseButton)}else this._scene.activeCamera.attachControl(this._scene.activeCamera.inputs?this._scene.activeCamera.inputs.noPreventDefault:!0);this._attachedToElement=!1}},h.prototype.startDrag=function(m,d,g){m===void 0&&(m=h._AnyMouseID),this._startDrag(m,d,g);var v=this._lastPointerRay[m];m===h._AnyMouseID&&(v=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),v&&this._moveDrag(v)},h.prototype._startDrag=function(m,d,g){if(!(!this._scene.activeCamera||this.dragging||!this.attachedNode)){A.a._RemoveAndStorePivotPoint(this.attachedNode),d?(this._startDragRay.direction.copyFrom(d.direction),this._startDragRay.origin.copyFrom(d.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,g||this._tmpVector);var v=this._pickWithRayOnDragPlane(this._startDragRay);v&&(this.dragging=!0,this.currentDraggingPointerID=m,this.lastDragPosition.copyFrom(v),this.onDragStartObservable.notifyObservers({dragPlanePoint:v,pointerId:this.currentDraggingPointerID}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)),A.a._RestorePivotPoint(this.attachedNode)}},h.prototype._moveDrag=function(m){this._moving=!0;var d=this._pickWithRayOnDragPlane(m);if(d){this.updateDragPlane&&this._updateDragPlanePosition(m,d);var g=0;this._options.dragAxis?(this.useObjectOrientationForDragging?O.e.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),d.subtractToRef(this.lastDragPosition,this._tmpVector),g=O.e.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(g,this._dragDelta)):(g=this._dragDelta.length(),d.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:g,delta:this._dragDelta,dragPlanePoint:d,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerID}),this.lastDragPosition.copyFrom(d)}},h.prototype._pickWithRayOnDragPlane=function(m){var d=this;if(!m)return null;var g=Math.acos(O.e.Dot(this._dragPlane.forward,m.direction));if(g>Math.PI/2&&(g=Math.PI-g),this.maxDragAngle>0&&g>this.maxDragAngle)if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(m.direction),this.attachedNode.absolutePosition.subtractToRef(m.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*O.e.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);var v=O.e.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-v,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}else return null;var l=h._planeScene.pickWithRay(m,function(y){return y==d._dragPlane});return l&&l.hit&&l.pickedMesh&&l.pickedPoint?l.pickedPoint:null},h.prototype._updateDragPlanePosition=function(m,d){this._pointA.copyFrom(d),this._options.dragAxis?(this.useObjectOrientationForDragging?O.e.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),m.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(O.e.Dot(this._localAxis,this._pointC))>.999?Math.abs(O.e.Dot(O.e.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(O.e.Right()):this._lookAt.copyFrom(O.e.UpReadOnly):(O.e.CrossToRef(this._localAxis,this._pointC,this._lookAt),O.e.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?O.e.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(m.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)},h.prototype.detach=function(){this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this.releaseDrag()},h._AnyMouseID=-2,h}()},510:function(Ue,P,u){"use strict";u.d(P,"e",function(){return S}),u.d(P,"a",function(){return j}),u.d(P,"d",function(){return O}),u.d(P,"c",function(){return M}),u.d(P,"b",function(){return H});var T=u(434),S=function(){function A(p,f){this.type=p,this.jointData=f,f.nativeParams=f.nativeParams||{}}return Object.defineProperty(A.prototype,"physicsJoint",{get:function(){return this._physicsJoint},set:function(p){this._physicsJoint,this._physicsJoint=p},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"physicsPlugin",{set:function(p){this._physicsPlugin=p},enumerable:!1,configurable:!0}),A.prototype.executeNativeFunction=function(p){p(this._physicsPlugin.world,this._physicsJoint)},A.DistanceJoint=0,A.HingeJoint=1,A.BallAndSocketJoint=2,A.WheelJoint=3,A.SliderJoint=4,A.PrismaticJoint=5,A.UniversalJoint=6,A.Hinge2Joint=A.WheelJoint,A.PointToPointJoint=8,A.SpringJoint=9,A.LockJoint=10,A}(),j=function(A){Object(T.d)(p,A);function p(f){return A.call(this,S.DistanceJoint,f)||this}return p.prototype.updateDistance=function(f,h){this._physicsPlugin.updateDistanceJoint(this,f,h)},p}(S),O=function(A){Object(T.d)(p,A);function p(f,h){return A.call(this,f,h)||this}return p.prototype.setMotor=function(f,h){this._physicsPlugin.setMotor(this,f||0,h)},p.prototype.setLimit=function(f,h){this._physicsPlugin.setLimit(this,f,h)},p}(S),M=function(A){Object(T.d)(p,A);function p(f){return A.call(this,S.HingeJoint,f)||this}return p.prototype.setMotor=function(f,h){this._physicsPlugin.setMotor(this,f||0,h)},p.prototype.setLimit=function(f,h){this._physicsPlugin.setLimit(this,f,h)},p}(O),H=function(A){Object(T.d)(p,A);function p(f){return A.call(this,S.Hinge2Joint,f)||this}return p.prototype.setMotor=function(f,h,m){m===void 0&&(m=0),this._physicsPlugin.setMotor(this,f||0,h,m)},p.prototype.setLimit=function(f,h,m){m===void 0&&(m=0),this._physicsPlugin.setLimit(this,f,h,m)},p}(O)},511:function(Ue,P,u){"use strict";u.d(P,"a",function(){return M});var T=u(438),S=u(436),j=u(441),O=u(437),M=function(){function H(A,p){this.triggerOptions=A,this.onBeforeExecuteObservable=new T.c,A.parameter?(this.trigger=A.trigger,this._triggerParameter=A.parameter):A.trigger?this.trigger=A.trigger:this.trigger=A,this._nextActiveAction=this,this._condition=p}return H.prototype._prepare=function(){},H.prototype.getTriggerParameter=function(){return this._triggerParameter},H.prototype.setTriggerParameter=function(A){this._triggerParameter=A},H.prototype._executeCurrent=function(A){if(this._nextActiveAction._condition){var p=this._nextActiveAction._condition,f=this._actionManager.getScene().getRenderId();if(p._evaluationId===f){if(!p._currentResult)return}else{if(p._evaluationId=f,!p.isValid()){p._currentResult=!1;return}p._currentResult=!0}}this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(A),this.skipToNextActiveAction()},H.prototype.execute=function(A){},H.prototype.skipToNextActiveAction=function(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this},H.prototype.then=function(A){return this._child=A,A._actionManager=this._actionManager,A._prepare(),A},H.prototype._getProperty=function(A){return this._actionManager._getProperty(A)},H.prototype._getEffectiveTarget=function(A,p){return this._actionManager._getEffectiveTarget(A,p)},H.prototype.serialize=function(A){},H.prototype._serialize=function(A,p){var f={type:1,children:[],name:A.name,properties:A.properties||[]};if(this._child&&this._child.serialize(f),this._condition){var h=this._condition.serialize();return h.children.push(f),p&&p.children.push(h),h}return p&&p.children.push(f),f},H._SerializeValueAsString=function(A){return typeof A=="number"?A.toString():typeof A=="boolean"?A?"true":"false":A instanceof S.d?A.x+", "+A.y:A instanceof S.e?A.x+", "+A.y+", "+A.z:A instanceof j.a?A.r+", "+A.g+", "+A.b:A instanceof j.b?A.r+", "+A.g+", "+A.b+", "+A.a:A},H._GetTargetProperty=function(A){return{name:"target",targetType:A._isMesh?"MeshProperties":A._isLight?"LightProperties":A._isCamera?"CameraProperties":"SceneProperties",value:A._isScene?"Scene":A.name}},H}();O.a.RegisteredTypes["BABYLON.Action"]=M},513:function(Ue,P,u){"use strict";u.d(P,"a",function(){return H}),u.d(P,"b",function(){return A});var T=u(436),S=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],j=[function(p){return 1},function(p){return p.y},function(p){return p.z},function(p){return p.x},function(p){return p.x*p.y},function(p){return p.y*p.z},function(p){return 3*p.z*p.z-1},function(p){return p.x*p.z},function(p){return p.x*p.x-p.y*p.y}],O=function(p,f){return S[p]*j[p](f)},M=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4],H=function(){function p(){this.preScaled=!1,this.l00=T.e.Zero(),this.l1_1=T.e.Zero(),this.l10=T.e.Zero(),this.l11=T.e.Zero(),this.l2_2=T.e.Zero(),this.l2_1=T.e.Zero(),this.l20=T.e.Zero(),this.l21=T.e.Zero(),this.l22=T.e.Zero()}return p.prototype.addLight=function(f,h,m){var d=new T.e(h.r,h.g,h.b),g=d.scale(m);this.l00=this.l00.add(g.scale(O(0,f))),this.l1_1=this.l1_1.add(g.scale(O(1,f))),this.l10=this.l10.add(g.scale(O(2,f))),this.l11=this.l11.add(g.scale(O(3,f))),this.l2_2=this.l2_2.add(g.scale(O(4,f))),this.l2_1=this.l2_1.add(g.scale(O(5,f))),this.l20=this.l20.add(g.scale(O(6,f))),this.l21=this.l21.add(g.scale(O(7,f))),this.l22=this.l22.add(g.scale(O(8,f)))},p.prototype.scaleInPlace=function(f){this.l00.scaleInPlace(f),this.l1_1.scaleInPlace(f),this.l10.scaleInPlace(f),this.l11.scaleInPlace(f),this.l2_2.scaleInPlace(f),this.l2_1.scaleInPlace(f),this.l20.scaleInPlace(f),this.l21.scaleInPlace(f),this.l22.scaleInPlace(f)},p.prototype.convertIncidentRadianceToIrradiance=function(){this.l00.scaleInPlace(M[0]),this.l1_1.scaleInPlace(M[1]),this.l10.scaleInPlace(M[2]),this.l11.scaleInPlace(M[3]),this.l2_2.scaleInPlace(M[4]),this.l2_1.scaleInPlace(M[5]),this.l20.scaleInPlace(M[6]),this.l21.scaleInPlace(M[7]),this.l22.scaleInPlace(M[8])},p.prototype.convertIrradianceToLambertianRadiance=function(){this.scaleInPlace(1/Math.PI)},p.prototype.preScaleForRendering=function(){this.preScaled=!0,this.l00.scaleInPlace(S[0]),this.l1_1.scaleInPlace(S[1]),this.l10.scaleInPlace(S[2]),this.l11.scaleInPlace(S[3]),this.l2_2.scaleInPlace(S[4]),this.l2_1.scaleInPlace(S[5]),this.l20.scaleInPlace(S[6]),this.l21.scaleInPlace(S[7]),this.l22.scaleInPlace(S[8])},p.FromArray=function(f){var h=new p;return T.e.FromArrayToRef(f[0],0,h.l00),T.e.FromArrayToRef(f[1],0,h.l1_1),T.e.FromArrayToRef(f[2],0,h.l10),T.e.FromArrayToRef(f[3],0,h.l11),T.e.FromArrayToRef(f[4],0,h.l2_2),T.e.FromArrayToRef(f[5],0,h.l2_1),T.e.FromArrayToRef(f[6],0,h.l20),T.e.FromArrayToRef(f[7],0,h.l21),T.e.FromArrayToRef(f[8],0,h.l22),h},p.FromPolynomial=function(f){var h=new p;return h.l00=f.xx.scale(.376127).add(f.yy.scale(.376127)).add(f.zz.scale(.376126)),h.l1_1=f.y.scale(.977204),h.l10=f.z.scale(.977204),h.l11=f.x.scale(.977204),h.l2_2=f.xy.scale(1.16538),h.l2_1=f.yz.scale(1.16538),h.l20=f.zz.scale(1.34567).subtract(f.xx.scale(.672834)).subtract(f.yy.scale(.672834)),h.l21=f.zx.scale(1.16538),h.l22=f.xx.scale(1.16538).subtract(f.yy.scale(1.16538)),h.l1_1.scaleInPlace(-1),h.l11.scaleInPlace(-1),h.l2_1.scaleInPlace(-1),h.l21.scaleInPlace(-1),h.scaleInPlace(Math.PI),h},p}(),A=function(){function p(){this.x=T.e.Zero(),this.y=T.e.Zero(),this.z=T.e.Zero(),this.xx=T.e.Zero(),this.yy=T.e.Zero(),this.zz=T.e.Zero(),this.xy=T.e.Zero(),this.yz=T.e.Zero(),this.zx=T.e.Zero()}return Object.defineProperty(p.prototype,"preScaledHarmonics",{get:function(){return this._harmonics||(this._harmonics=H.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics},enumerable:!1,configurable:!0}),p.prototype.addAmbient=function(f){var h=new T.e(f.r,f.g,f.b);this.xx=this.xx.add(h),this.yy=this.yy.add(h),this.zz=this.zz.add(h)},p.prototype.scaleInPlace=function(f){this.x.scaleInPlace(f),this.y.scaleInPlace(f),this.z.scaleInPlace(f),this.xx.scaleInPlace(f),this.yy.scaleInPlace(f),this.zz.scaleInPlace(f),this.yz.scaleInPlace(f),this.zx.scaleInPlace(f),this.xy.scaleInPlace(f)},p.FromHarmonics=function(f){var h=new p;return h._harmonics=f,h.x=f.l11.scale(1.02333).scale(-1),h.y=f.l1_1.scale(1.02333).scale(-1),h.z=f.l10.scale(1.02333),h.xx=f.l00.scale(.886277).subtract(f.l20.scale(.247708)).add(f.l22.scale(.429043)),h.yy=f.l00.scale(.886277).subtract(f.l20.scale(.247708)).subtract(f.l22.scale(.429043)),h.zz=f.l00.scale(.886277).add(f.l20.scale(.495417)),h.yz=f.l2_1.scale(.858086).scale(-1),h.zx=f.l21.scale(.858086).scale(-1),h.xy=f.l2_2.scale(.858086),h.scaleInPlace(1/Math.PI),h},p.FromArray=function(f){var h=new p;return T.e.FromArrayToRef(f[0],0,h.x),T.e.FromArrayToRef(f[1],0,h.y),T.e.FromArrayToRef(f[2],0,h.z),T.e.FromArrayToRef(f[3],0,h.xx),T.e.FromArrayToRef(f[4],0,h.yy),T.e.FromArrayToRef(f[5],0,h.zz),T.e.FromArrayToRef(f[6],0,h.yz),T.e.FromArrayToRef(f[7],0,h.zx),T.e.FromArrayToRef(f[8],0,h.xy),h},p}()},514:function(Ue,P,u){"use strict";u.d(P,"a",function(){return j});var T=u(442),S=u(545),j=function(){function O(){}return O.GetEnvironmentBRDFTexture=function(M){if(!M.environmentBRDFTexture){var H=M.useDelayedTextureLoading;M.useDelayedTextureLoading=!1;var A=M._blockEntityCollection;M._blockEntityCollection=!1;var p=T.a.CreateFromBase64String(this._environmentBRDFBase64Texture,"EnvironmentBRDFTexture"+this._instanceNumber++,M,!0,!1,T.a.BILINEAR_SAMPLINGMODE);M._blockEntityCollection=A;var f=M.getEngine().getLoadedTexturesCache(),h=f.indexOf(p.getInternalTexture());h!==-1&&f.splice(h,1),p.isRGBD=!0,p.wrapU=T.a.CLAMP_ADDRESSMODE,p.wrapV=T.a.CLAMP_ADDRESSMODE,M.environmentBRDFTexture=p,M.useDelayedTextureLoading=H,S.a.ExpandRGBDTexture(p)}return M.environmentBRDFTexture},O._instanceNumber=0,O._environmentBRDFBase64Texture="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==",O}()},516:function(Ue,P,u){"use strict";u.d(P,"a",function(){return fe});var T=u(434),S=u(439),j=u(443),O=u(438),M=u(441),H=u(445),A=u(448),p=u(447),f=u(442),h=u(458),m=u(459),d=u(454),g=u(435),v="glowMapGenerationPixelShader",l=`#ifdef DIFFUSE
varying vec2 vUVDiffuse;
uniform sampler2D diffuseSampler;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;
uniform sampler2D opacitySampler;
uniform float opacityIntensity;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;
uniform sampler2D emissiveSampler;
#endif
#ifdef VERTEXALPHA
varying vec4 vColor;
#endif
uniform vec4 glowColor;
void main(void)
{
vec4 finalColor=glowColor;

#ifdef DIFFUSE
vec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);
#ifdef GLOW

finalColor.a*=albedoTexture.a;
#endif
#ifdef HIGHLIGHT

finalColor.a=albedoTexture.a;
#endif
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vUVOpacity);
#ifdef OPACITYRGB
finalColor.a*=getLuminance(opacityMap.rgb);
#else
finalColor.a*=opacityMap.a;
#endif
finalColor.a*=opacityIntensity;
#endif
#ifdef VERTEXALPHA
finalColor.a*=vColor.a;
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
gl_FragColor=texture2D(emissiveSampler,vUVEmissive)*finalColor;
#else
gl_FragColor=finalColor;
#endif
#ifdef HIGHLIGHT

gl_FragColor.a=glowColor.a;
#endif
}`;g.a.ShadersStore[v]=l;var y={name:v,shader:l},E=u(487),R=u(496),F=u(497),B=u(501),L=u(507),I=u(508),k=u(488),Z=u(489),Y="glowMapGenerationVertexShader",U=`
attribute vec3 position;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

#include<instancesDeclaration>
uniform mat4 viewProjection;
varying vec4 vPosition;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;
uniform mat4 diffuseMatrix;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;
uniform mat4 opacityMatrix;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;
uniform mat4 emissiveMatrix;
#endif
#ifdef VERTEXALPHA
attribute vec4 color;
varying vec4 vColor;
#endif
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#ifdef CUBEMAP
vPosition=finalWorld*vec4(positionUpdated,1.0);
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#else
vPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
gl_Position=vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef DIFFUSEUV2
vUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef OPACITYUV2
vUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef EMISSIVEUV2
vUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef VERTEXALPHA
vColor=color;
#endif
}`;g.a.ShadersStore[Y]=U;var Q={name:Y,shader:U},G=u(476),K=u(512),fe=function(){function ce(re,Re){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new M.b},this.neutralColor=new M.b,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new O.c,this.onBeforeRenderMainTextureObservable=new O.c,this.onBeforeComposeObservable=new O.c,this.onBeforeRenderMeshToEffect=new O.c,this.onAfterRenderMeshToEffect=new O.c,this.onAfterComposeObservable=new O.c,this.onSizeChangedObservable=new O.c,this.name=re,this._scene=Re||A.a.LastCreatedScene,ce._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._generateIndexBuffer(),this._generateVertexBuffer()}return Object.defineProperty(ce.prototype,"camera",{get:function(){return this._effectLayerOptions.camera},enumerable:!1,configurable:!0}),Object.defineProperty(ce.prototype,"renderingGroupId",{get:function(){return this._effectLayerOptions.renderingGroupId},set:function(re){this._effectLayerOptions.renderingGroupId=re},enumerable:!1,configurable:!0}),ce.prototype._init=function(re){this._effectLayerOptions=Object(T.a)({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1},re),this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses(),this._mergeEffect=this._createMergeEffect()},ce.prototype._generateIndexBuffer=function(){var re=[];re.push(0),re.push(1),re.push(2),re.push(0),re.push(2),re.push(3),this._indexBuffer=this._engine.createIndexBuffer(re)},ce.prototype._generateVertexBuffer=function(){var re=[];re.push(1,1),re.push(-1,1),re.push(-1,-1),re.push(1,-1);var Re=new p.b(this._engine,re,p.b.PositionKind,!1,!1,2);this._vertexBuffers[p.b.PositionKind]=Re},ce.prototype._setMainTextureSize=function(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?H.a.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?H.a.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)},ce.prototype._createMainTexture=function(){var re=this;if(this._mainTexture=new h.a("HighlightLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,0),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=f.a.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=f.a.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(f.a.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0,this._mainTexture.customRenderFunction=function(Ie,Ce,X,ae){re.onBeforeRenderMainTextureObservable.notifyObservers(re);var ee,w=re._scene.getEngine();if(ae.length){for(w.setColorWrite(!1),ee=0;ee<ae.length;ee++)re._renderSubMesh(ae.data[ee]);w.setColorWrite(!0)}for(ee=0;ee<Ie.length;ee++)re._renderSubMesh(Ie.data[ee]);for(ee=0;ee<Ce.length;ee++)re._renderSubMesh(Ce.data[ee]);var N=w.getAlphaMode();for(ee=0;ee<X.length;ee++)re._renderSubMesh(X.data[ee],!0);w.setAlphaMode(N)},this._mainTexture.onClearObservable.add(function(Ie){Ie.clear(re.neutralColor,!0,!0,!0)}),this._scene.getBoundingBoxRenderer){var Re=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(function(){re._scene.getBoundingBoxRenderer().enabled=!re.disableBoundingBoxesFromEffectLayer&&Re}),this._mainTexture.onAfterUnbindObservable.add(function(){re._scene.getBoundingBoxRenderer().enabled=Re})}},ce.prototype._addCustomEffectDefines=function(re){},ce.prototype._isReady=function(re,Re,Ie){var Ce=re.getMaterial();if(!Ce||!Ce.isReadyForSubMesh(re.getMesh(),re,Re))return!1;var X=[],ae=[p.b.PositionKind],ee=re.getMesh(),w=!1,N=!1;if(Ce){var W=Ce.needAlphaTesting(),$=Ce.getAlphaTestTexture(),J=$&&$.hasAlpha&&(Ce.useAlphaFromDiffuseTexture||Ce._useAlphaFromAlbedoTexture);$&&(W||J)&&(X.push("#define DIFFUSE"),ee.isVerticesDataPresent(p.b.UV2Kind)&&$.coordinatesIndex===1?(X.push("#define DIFFUSEUV2"),N=!0):ee.isVerticesDataPresent(p.b.UVKind)&&(X.push("#define DIFFUSEUV1"),w=!0),W&&(X.push("#define ALPHATEST"),X.push("#define ALPHATESTVALUE 0.4")));var le=Ce.opacityTexture;le&&(X.push("#define OPACITY"),ee.isVerticesDataPresent(p.b.UV2Kind)&&le.coordinatesIndex===1?(X.push("#define OPACITYUV2"),N=!0):ee.isVerticesDataPresent(p.b.UVKind)&&(X.push("#define OPACITYUV1"),w=!0))}Ie&&(X.push("#define EMISSIVE"),ee.isVerticesDataPresent(p.b.UV2Kind)&&Ie.coordinatesIndex===1?(X.push("#define EMISSIVEUV2"),N=!0):ee.isVerticesDataPresent(p.b.UVKind)&&(X.push("#define EMISSIVEUV1"),w=!0)),ee.isVerticesDataPresent(p.b.ColorKind)&&ee.hasVertexAlpha&&(ae.push(p.b.ColorKind),X.push("#define VERTEXALPHA")),w&&(ae.push(p.b.UVKind),X.push("#define UV1")),N&&(ae.push(p.b.UV2Kind),X.push("#define UV2"));var ne=new K.a;if(ee.useBones&&ee.computeBonesUsingShaders){ae.push(p.b.MatricesIndicesKind),ae.push(p.b.MatricesWeightsKind),ee.numBoneInfluencers>4&&(ae.push(p.b.MatricesIndicesExtraKind),ae.push(p.b.MatricesWeightsExtraKind)),X.push("#define NUM_BONE_INFLUENCERS "+ee.numBoneInfluencers);var be=ee.skeleton;be&&be.isUsingTextureForMatrices?X.push("#define BONETEXTURE"):X.push("#define BonesPerMesh "+(be?be.bones.length+1:0)),ee.numBoneInfluencers>0&&ne.addCPUSkinningFallback(0,ee)}else X.push("#define NUM_BONE_INFLUENCERS 0");var Me=ee.morphTargetManager,Te=0;Me&&Me.numInfluencers>0&&(X.push("#define MORPHTARGETS"),Te=Me.numInfluencers,X.push("#define NUM_MORPH_INFLUENCERS "+Te),Me.isUsingTextureForTargets&&X.push("#define MORPHTARGETS_TEXTURE"),d.a.PrepareAttributesForMorphTargetsInfluencers(ae,ee,Te)),Re&&(X.push("#define INSTANCES"),d.a.PushAttributesForInstances(ae),re.getRenderingMesh().hasThinInstances&&X.push("#define THIN_INSTANCES")),this._addCustomEffectDefines(X);var Ae=X.join(`
`);return this._cachedDefines!==Ae&&(this._cachedDefines=Ae,this._effectLayerMapGenerationEffect=this._scene.getEngine().createEffect("glowMapGeneration",ae,["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices"],["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],Ae,ne,void 0,void 0,{maxSimultaneousMorphTargets:Te})),this._effectLayerMapGenerationEffect.isReady()},ce.prototype.render=function(){var re=this._mergeEffect;if(!!re.isReady()){for(var Re=0;Re<this._postProcesses.length;Re++)if(!this._postProcesses[Re].isReady())return;var Ie=this._scene.getEngine();this.onBeforeComposeObservable.notifyObservers(this),Ie.enableEffect(re),Ie.setState(!1),Ie.bindBuffers(this._vertexBuffers,this._indexBuffer,re);var Ce=Ie.getAlphaMode();Ie.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(re),Ie.setAlphaMode(Ce),this.onAfterComposeObservable.notifyObservers(this);var X=this._mainTexture.getSize();this._setMainTextureSize(),(X.width!==this._mainTextureDesiredSize.width||X.height!==this._mainTextureDesiredSize.height)&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}},ce.prototype.hasMesh=function(re){return this.renderingGroupId===-1||re.renderingGroupId===this.renderingGroupId},ce.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender},ce.prototype._shouldRenderMesh=function(re){return!0},ce.prototype._canRenderMesh=function(re,Re){return!Re.needAlphaBlendingForMesh(re)},ce.prototype._shouldRenderEmissiveTextureForMesh=function(){return!0},ce.prototype._renderSubMesh=function(re,Re){var Ie=this,Ce;if(Re===void 0&&(Re=!1),!!this.shouldRender()){var X=re.getMaterial(),ae=re.getMesh(),ee=re.getReplacementMesh(),w=re.getRenderingMesh(),N=re.getEffectiveMesh(),W=this._scene,$=W.getEngine();if(N._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!!X&&!!this._canRenderMesh(w,X)){var J=(Ce=w.overrideMaterialSideOrientation)!==null&&Ce!==void 0?Ce:X.sideOrientation,le=w._getWorldMatrixDeterminant();le<0&&(J=J===m.a.ClockWiseSideOrientation?m.a.CounterClockWiseSideOrientation:m.a.ClockWiseSideOrientation);var ne=J===m.a.ClockWiseSideOrientation;$.setState(X.backFaceCulling,X.zOffset,void 0,ne);var be=w._getInstancesRenderList(re._id,!!ee);if(!be.mustReturn&&!!this._shouldRenderMesh(w)){var Me=be.hardwareInstancedRendering[re._id]||w.hasThinInstances;if(this._setEmissiveTextureAndColor(w,re,X),this.onBeforeRenderMeshToEffect.notifyObservers(ae),this._useMeshMaterial(w))w.render(re,Me,ee||void 0);else if(this._isReady(re,Me,this._emissiveTextureAndColor.texture)){$.enableEffect(this._effectLayerMapGenerationEffect),w._bind(re,this._effectLayerMapGenerationEffect,m.a.TriangleFillMode),this._effectLayerMapGenerationEffect.setMatrix("viewProjection",W.getTransformMatrix()),this._effectLayerMapGenerationEffect.setMatrix("world",N.getWorldMatrix()),this._effectLayerMapGenerationEffect.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a);var Te=X.needAlphaTesting(),Ae=X.getAlphaTestTexture(),se=Ae&&Ae.hasAlpha&&(X.useAlphaFromDiffuseTexture||X._useAlphaFromAlbedoTexture);if(Ae&&(Te||se)){this._effectLayerMapGenerationEffect.setTexture("diffuseSampler",Ae);var te=Ae.getTextureMatrix();te&&this._effectLayerMapGenerationEffect.setMatrix("diffuseMatrix",te)}var he=X.opacityTexture;if(he){this._effectLayerMapGenerationEffect.setTexture("opacitySampler",he),this._effectLayerMapGenerationEffect.setFloat("opacityIntensity",he.level);var te=he.getTextureMatrix();te&&this._effectLayerMapGenerationEffect.setMatrix("opacityMatrix",te)}if(this._emissiveTextureAndColor.texture&&(this._effectLayerMapGenerationEffect.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),this._effectLayerMapGenerationEffect.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),w.useBones&&w.computeBonesUsingShaders&&w.skeleton){var de=w.skeleton;if(de.isUsingTextureForMatrices){var Ne=de.getTransformMatrixTexture(w);if(!Ne)return;this._effectLayerMapGenerationEffect.setTexture("boneSampler",Ne),this._effectLayerMapGenerationEffect.setFloat("boneTextureWidth",4*(de.bones.length+1))}else this._effectLayerMapGenerationEffect.setMatrices("mBones",de.getTransformMatrices(w))}d.a.BindMorphTargetParameters(w,this._effectLayerMapGenerationEffect),w.morphTargetManager&&w.morphTargetManager.isUsingTextureForTargets&&w.morphTargetManager._bind(this._effectLayerMapGenerationEffect),Re&&$.setAlphaMode(X.alphaMode),w._processRendering(N,re,this._effectLayerMapGenerationEffect,X.fillMode,be,Me,function(Le,pe){return Ie._effectLayerMapGenerationEffect.setMatrix("world",pe)})}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(ae)}}}},ce.prototype._useMeshMaterial=function(re){return!1},ce.prototype._rebuild=function(){var re=this._vertexBuffers[p.b.PositionKind];re&&re._rebuild(),this._generateIndexBuffer()},ce.prototype._disposeTextureAndPostProcesses=function(){this._mainTexture.dispose();for(var re=0;re<this._postProcesses.length;re++)this._postProcesses[re]&&this._postProcesses[re].dispose();this._postProcesses=[];for(var re=0;re<this._textures.length;re++)this._textures[re]&&this._textures[re].dispose();this._textures=[]},ce.prototype.dispose=function(){var re=this._vertexBuffers[p.b.PositionKind];re&&(re.dispose(),this._vertexBuffers[p.b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._disposeTextureAndPostProcesses();var Re=this._scene.effectLayers.indexOf(this,0);Re>-1&&this._scene.effectLayers.splice(Re,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()},ce.prototype.getClassName=function(){return"EffectLayer"},ce.Parse=function(re,Re,Ie){var Ce=j.b.Instantiate(re.customType);return Ce.Parse(re,Re,Ie)},ce._SceneComponentInitialization=function(re){throw G.a.WarnImport("EffectLayerSceneComponent")},Object(T.c)([Object(S.c)()],ce.prototype,"name",void 0),Object(T.c)([Object(S.f)()],ce.prototype,"neutralColor",void 0),Object(T.c)([Object(S.c)()],ce.prototype,"isEnabled",void 0),Object(T.c)([Object(S.d)()],ce.prototype,"camera",null),Object(T.c)([Object(S.c)()],ce.prototype,"renderingGroupId",null),Object(T.c)([Object(S.c)()],ce.prototype,"disableBoundingBoxesFromEffectLayer",void 0),ce}()},517:function(Ue,P,u){"use strict";u.d(P,"a",function(){return g});var T=u(434),S=u(442),j=u(444),O=u(435),M="fxaaPixelShader",H=`uniform sampler2D textureSampler;
uniform vec2 texelSize;
varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const float fxaaQualitySubpix=1.0;
const float fxaaQualityEdgeThreshold=0.166;
const float fxaaQualityEdgeThresholdMin=0.0833;
const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);
#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)
void main(){
vec2 posM;
posM.x=vUV.x;
posM.y=vUV.y;
vec4 rgbyM=texture2D(textureSampler,vUV,0.0);
float lumaM=FxaaLuma(rgbyM);
float lumaS=FxaaLuma(texture2D(textureSampler,sampleCoordS,0.0));
float lumaE=FxaaLuma(texture2D(textureSampler,sampleCoordE,0.0));
float lumaN=FxaaLuma(texture2D(textureSampler,sampleCoordN,0.0));
float lumaW=FxaaLuma(texture2D(textureSampler,sampleCoordW,0.0));
float maxSM=max(lumaS,lumaM);
float minSM=min(lumaS,lumaM);
float maxESM=max(lumaE,maxSM);
float minESM=min(lumaE,minSM);
float maxWN=max(lumaN,lumaW);
float minWN=min(lumaN,lumaW);
float rangeMax=max(maxWN,maxESM);
float rangeMin=min(minWN,minESM);
float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;
float range=rangeMax-rangeMin;
float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped)
{
gl_FragColor=rgbyM;
return;
}
#endif
float lumaNW=FxaaLuma(texture2D(textureSampler,sampleCoordNW,0.0));
float lumaSE=FxaaLuma(texture2D(textureSampler,sampleCoordSE,0.0));
float lumaNE=FxaaLuma(texture2D(textureSampler,sampleCoordNE,0.0));
float lumaSW=FxaaLuma(texture2D(textureSampler,sampleCoordSW,0.0));
float lumaNS=lumaN+lumaS;
float lumaWE=lumaW+lumaE;
float subpixRcpRange=1.0/range;
float subpixNSWE=lumaNS+lumaWE;
float edgeHorz1=(-2.0*lumaM)+lumaNS;
float edgeVert1=(-2.0*lumaM)+lumaWE;
float lumaNESE=lumaNE+lumaSE;
float lumaNWNE=lumaNW+lumaNE;
float edgeHorz2=(-2.0*lumaE)+lumaNESE;
float edgeVert2=(-2.0*lumaN)+lumaNWNE;
float lumaNWSW=lumaNW+lumaSW;
float lumaSWSE=lumaSW+lumaSE;
float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);
float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);
float edgeHorz3=(-2.0*lumaW)+lumaNWSW;
float edgeVert3=(-2.0*lumaS)+lumaSWSE;
float edgeHorz=abs(edgeHorz3)+edgeHorz4;
float edgeVert=abs(edgeVert3)+edgeVert4;
float subpixNWSWNESE=lumaNWSW+lumaNESE;
float lengthSign=texelSize.x;
bool horzSpan=edgeHorz>=edgeVert;
float subpixA=subpixNSWE*2.0+subpixNWSWNESE;
if (!horzSpan)
{
lumaN=lumaW;
}
if (!horzSpan)
{
lumaS=lumaE;
}
if (horzSpan)
{
lengthSign=texelSize.y;
}
float subpixB=(subpixA*(1.0/12.0))-lumaM;
float gradientN=lumaN-lumaM;
float gradientS=lumaS-lumaM;
float lumaNN=lumaN+lumaM;
float lumaSS=lumaS+lumaM;
bool pairN=abs(gradientN)>=abs(gradientS);
float gradient=max(abs(gradientN),abs(gradientS));
if (pairN)
{
lengthSign=-lengthSign;
}
float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);
vec2 posB;
posB.x=posM.x;
posB.y=posM.y;
vec2 offNP;
offNP.x=(!horzSpan) ? 0.0 : texelSize.x;
offNP.y=(horzSpan) ? 0.0 : texelSize.y;
if (!horzSpan)
{
posB.x+=lengthSign*0.5;
}
if (horzSpan)
{
posB.y+=lengthSign*0.5;
}
vec2 posN;
posN.x=posB.x-offNP.x*1.5;
posN.y=posB.y-offNP.y*1.5;
vec2 posP;
posP.x=posB.x+offNP.x*1.5;
posP.y=posB.y+offNP.y*1.5;
float subpixD=((-2.0)*subpixC)+3.0;
float lumaEndN=FxaaLuma(texture2D(textureSampler,posN,0.0));
float subpixE=subpixC*subpixC;
float lumaEndP=FxaaLuma(texture2D(textureSampler,posP,0.0));
if (!pairN)
{
lumaNN=lumaSS;
}
float gradientScaled=gradient*1.0/4.0;
float lumaMM=lumaM-lumaNN*0.5;
float subpixF=subpixD*subpixE;
bool lumaMLTZero=lumaMM<0.0;
lumaEndN-=lumaNN*0.5;
lumaEndP-=lumaNN*0.5;
bool doneN=abs(lumaEndN)>=gradientScaled;
bool doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN)
{
posN.x-=offNP.x*3.0;
}
if (!doneN)
{
posN.y-=offNP.y*3.0;
}
bool doneNP=(!doneN) || (!doneP);
if (!doneP)
{
posP.x+=offNP.x*3.0;
}
if (!doneP)
{
posP.y+=offNP.y*3.0;
}
if (doneNP)
{
if (!doneN) lumaEndN=FxaaLuma(texture2D(textureSampler,posN.xy,0.0));
if (!doneP) lumaEndP=FxaaLuma(texture2D(textureSampler,posP.xy,0.0));
if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;
if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;
doneN=abs(lumaEndN)>=gradientScaled;
doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN) posN.x-=offNP.x*12.0;
if (!doneN) posN.y-=offNP.y*12.0;
doneNP=(!doneN) || (!doneP);
if (!doneP) posP.x+=offNP.x*12.0;
if (!doneP) posP.y+=offNP.y*12.0;
}
float dstN=posM.x-posN.x;
float dstP=posP.x-posM.x;
if (!horzSpan)
{
dstN=posM.y-posN.y;
}
if (!horzSpan)
{
dstP=posP.y-posM.y;
}
bool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;
float spanLength=(dstP+dstN);
bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;
float spanLengthRcp=1.0/spanLength;
bool directionN=dstN<dstP;
float dst=min(dstN,dstP);
bool goodSpan=directionN ? goodSpanN : goodSpanP;
float subpixG=subpixF*subpixF;
float pixelOffset=(dst*(-spanLengthRcp))+0.5;
float subpixH=subpixG*fxaaQualitySubpix;
float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;
float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);
if (!horzSpan)
{
posM.x+=pixelOffsetSubpix*lengthSign;
}
if (horzSpan)
{
posM.y+=pixelOffsetSubpix*lengthSign;
}
#ifdef MALI
if(range<rangeMaxClamped)
{
gl_FragColor=rgbyM;
}
else
{
gl_FragColor=texture2D(textureSampler,posM,0.0);
}
#else
gl_FragColor=texture2D(textureSampler,posM,0.0);
#endif
}`;O.a.ShadersStore[M]=H;var A={name:M,shader:H},p="fxaaVertexShader",f=`
attribute vec2 position;
uniform vec2 texelSize;

varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vUV=(position*madd+madd);
sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;
sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;
sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;
sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;
sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;
sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;
sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;
sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;
gl_Position=vec4(position,0.0,1.0);
}`;O.a.ShadersStore[p]=f;var h={name:p,shader:f},m=u(437),d=u(439),g=function(v){Object(T.d)(l,v);function l(y,E,R,F,B,L,I){R===void 0&&(R=null),I===void 0&&(I=0);var k=v.call(this,y,"fxaa",["texelSize"],null,E,R,F||S.a.BILINEAR_SAMPLINGMODE,B,L,null,I,"fxaa",void 0,!0)||this,Z=k._getDefines();return k.updateEffect(Z),k.onApplyObservable.add(function(Y){var U=k.texelSize;Y.setFloat2("texelSize",U.x,U.y)}),k}return l.prototype.getClassName=function(){return"FxaaPostProcess"},l.prototype._getDefines=function(){var y=this.getEngine();if(!y)return null;var E=y.getGlInfo();return E&&E.renderer&&E.renderer.toLowerCase().indexOf("mali")>-1?`#define MALI 1
`:null},l._Parse=function(y,E,R,F){return d.a.Parse(function(){return new l(y.name,y.options,E,y.renderTargetSamplingMode,R.getEngine(),y.reusable)},y,R,F)},l}(j.a);m.a.RegisteredTypes["BABYLON.FxaaPostProcess"]=g},518:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(434),S=u(439),j=u(491),O=u(444),M=u(448),H=u(644),A=u(534),p=function(f){Object(T.d)(h,f);function h(m,d,g,v,l,y,E,R){g===void 0&&(g=null),E===void 0&&(E=0);var F=f.call(this,m,"imageProcessing",[],[],d,g,v,l,y,null,E,"postprocess",null,!0)||this;return F._fromLinearSpace=!0,F._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1},R?(R.applyByPostProcess=!0,F._attachImageProcessingConfiguration(R,!0),F.fromLinearSpace=!1):(F._attachImageProcessingConfiguration(null,!0),F.imageProcessingConfiguration.applyByPostProcess=!0),F.onApply=function(B){F.imageProcessingConfiguration.bind(B,F.aspectRatio)},F}return Object.defineProperty(h.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(m){m.applyByPostProcess=!0,this._attachImageProcessingConfiguration(m)},enumerable:!1,configurable:!0}),h.prototype._attachImageProcessingConfiguration=function(m,d){var g=this;if(d===void 0&&(d=!1),m!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),m)this._imageProcessingConfiguration=m;else{var v=null,l=this.getEngine(),y=this.getCamera();if(y)v=y.getScene();else if(l&&l.scenes){var E=l.scenes;v=E[E.length-1]}else v=M.a.LastCreatedScene;v?this._imageProcessingConfiguration=v.imageProcessingConfiguration:this._imageProcessingConfiguration=new j.a}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){g._updateParameters()})),d||this._updateParameters()}},Object.defineProperty(h.prototype,"isSupported",{get:function(){var m=this.getEffect();return!m||m.isSupported},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"colorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(m){this.imageProcessingConfiguration.colorCurves=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"colorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(m){this.imageProcessingConfiguration.colorCurvesEnabled=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"colorGradingTexture",{get:function(){return this.imageProcessingConfiguration.colorGradingTexture},set:function(m){this.imageProcessingConfiguration.colorGradingTexture=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"colorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(m){this.imageProcessingConfiguration.colorGradingEnabled=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"exposure",{get:function(){return this.imageProcessingConfiguration.exposure},set:function(m){this.imageProcessingConfiguration.exposure=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"toneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(m){this._imageProcessingConfiguration.toneMappingEnabled=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"toneMappingType",{get:function(){return this._imageProcessingConfiguration.toneMappingType},set:function(m){this._imageProcessingConfiguration.toneMappingType=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"contrast",{get:function(){return this.imageProcessingConfiguration.contrast},set:function(m){this.imageProcessingConfiguration.contrast=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"vignetteStretch",{get:function(){return this.imageProcessingConfiguration.vignetteStretch},set:function(m){this.imageProcessingConfiguration.vignetteStretch=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"vignetteCentreX",{get:function(){return this.imageProcessingConfiguration.vignetteCentreX},set:function(m){this.imageProcessingConfiguration.vignetteCentreX=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"vignetteCentreY",{get:function(){return this.imageProcessingConfiguration.vignetteCentreY},set:function(m){this.imageProcessingConfiguration.vignetteCentreY=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"vignetteWeight",{get:function(){return this.imageProcessingConfiguration.vignetteWeight},set:function(m){this.imageProcessingConfiguration.vignetteWeight=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"vignetteColor",{get:function(){return this.imageProcessingConfiguration.vignetteColor},set:function(m){this.imageProcessingConfiguration.vignetteColor=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"vignetteCameraFov",{get:function(){return this.imageProcessingConfiguration.vignetteCameraFov},set:function(m){this.imageProcessingConfiguration.vignetteCameraFov=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"vignetteBlendMode",{get:function(){return this.imageProcessingConfiguration.vignetteBlendMode},set:function(m){this.imageProcessingConfiguration.vignetteBlendMode=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"vignetteEnabled",{get:function(){return this.imageProcessingConfiguration.vignetteEnabled},set:function(m){this.imageProcessingConfiguration.vignetteEnabled=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"fromLinearSpace",{get:function(){return this._fromLinearSpace},set:function(m){this._fromLinearSpace!==m&&(this._fromLinearSpace=m,this._updateParameters())},enumerable:!1,configurable:!0}),h.prototype.getClassName=function(){return"ImageProcessingPostProcess"},h.prototype._updateParameters=function(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);var m="";for(var d in this._defines)this._defines[d]&&(m+="#define "+d+`;\r
`);var g=["textureSampler"],v=["scale"];j.a&&(j.a.PrepareSamplers(g,this._defines),j.a.PrepareUniforms(v,this._defines)),this.updateEffect(m,v,g)},h.prototype.dispose=function(m){f.prototype.dispose.call(this,m),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)},Object(T.c)([Object(S.c)()],h.prototype,"_fromLinearSpace",void 0),h}(O.a)},521:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(436),S=u(450),j=u(513),O=u(515),M=u(441),H=function(){function p(f,h,m,d){this.name=f,this.worldAxisForNormal=h,this.worldAxisForFileX=m,this.worldAxisForFileY=d}return p}(),A=function(){function p(){}return p.ConvertCubeMapTextureToSphericalPolynomial=function(f){var h=this,m;if(!f.isCube)return null;(m=f.getScene())===null||m===void 0||m.getEngine().flushFramebuffer();var d=f.getSize().width,g=f.readPixels(0,void 0,void 0,!1),v=f.readPixels(1,void 0,void 0,!1),l,y;f.isRenderTarget?(l=f.readPixels(3,void 0,void 0,!1),y=f.readPixels(2,void 0,void 0,!1)):(l=f.readPixels(2,void 0,void 0,!1),y=f.readPixels(3,void 0,void 0,!1));var E=f.readPixels(4,void 0,void 0,!1),R=f.readPixels(5,void 0,void 0,!1),F=f.gammaSpace,B=5,L=0;return(f.textureType==1||f.textureType==2)&&(L=1),new Promise(function(I,k){Promise.all([v,g,l,y,E,R]).then(function(Z){var Y=Z[0],U=Z[1],Q=Z[2],G=Z[3],K=Z[4],fe=Z[5],ce={size:d,right:U,left:Y,up:Q,down:G,front:K,back:fe,format:B,type:L,gammaSpace:F};I(h.ConvertCubeMapToSphericalPolynomial(ce))})})},p.ConvertCubeMapToSphericalPolynomial=function(f){for(var h=new j.a,m=0,d=2/f.size,g=d,v=d*.5-1,l=0;l<6;l++)for(var y=this.FileFaces[l],E=f[y.name],R=v,F=f.format===5?4:3,B=0;B<f.size;B++){for(var L=v,I=0;I<f.size;I++){var k=y.worldAxisForFileX.scale(L).add(y.worldAxisForFileY.scale(R)).add(y.worldAxisForNormal);k.normalize();var Z=Math.pow(1+L*L+R*R,-3/2),Y=E[B*f.size*F+I*F+0],U=E[B*f.size*F+I*F+1],Q=E[B*f.size*F+I*F+2];isNaN(Y)&&(Y=0),isNaN(U)&&(U=0),isNaN(Q)&&(Q=0),f.type===0&&(Y/=255,U/=255,Q/=255),f.gammaSpace&&(Y=Math.pow(S.a.Clamp(Y),O.c),U=Math.pow(S.a.Clamp(U),O.c),Q=Math.pow(S.a.Clamp(Q),O.c));var G=4096;Y=S.a.Clamp(Y,0,G),U=S.a.Clamp(U,0,G),Q=S.a.Clamp(Q,0,G);var K=new M.a(Y,U,Q);h.addLight(k,K,Z),m+=Z,L+=d}R+=g}var fe=4*Math.PI,ce=6,re=fe*ce/6,Re=re/m;return h.scaleInPlace(Re),h.convertIncidentRadianceToIrradiance(),h.convertIrradianceToLambertianRadiance(),j.b.FromHarmonics(h)},p.FileFaces=[new H("right",new T.e(1,0,0),new T.e(0,0,-1),new T.e(0,-1,0)),new H("left",new T.e(-1,0,0),new T.e(0,0,1),new T.e(0,-1,0)),new H("up",new T.e(0,1,0),new T.e(1,0,0),new T.e(0,0,1)),new H("down",new T.e(0,-1,0),new T.e(1,0,0),new T.e(0,0,-1)),new H("front",new T.e(0,0,1),new T.e(1,0,0),new T.e(0,-1,0)),new H("back",new T.e(0,0,-1),new T.e(-1,0,0),new T.e(0,-1,0))],p}()},522:function(Ue,P,u){"use strict";var T=u(434),S=u(456),j=u(440),O=u(467);O.a.prototype.createRenderTargetCubeTexture=function(M,H){var A=Object(T.a)({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},H);A.generateStencilBuffer=A.generateDepthBuffer&&A.generateStencilBuffer,(A.type===1&&!this._caps.textureFloatLinearFiltering||A.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(A.samplingMode=1);var p=this._gl,f=new S.a(this,S.b.RenderTarget);this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,f,!0);var h=this._getSamplingParameters(A.samplingMode,A.generateMipMaps);A.type===1&&!this._caps.textureFloat&&(A.type=0,j.a.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MAG_FILTER,h.mag),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MIN_FILTER,h.min),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);for(var m=0;m<6;m++)p.texImage2D(p.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,this._getRGBABufferInternalSizedFormat(A.type,A.format),M,M,0,this._getInternalFormat(A.format),this._getWebGLTextureType(A.type),null);var d=p.createFramebuffer();return this._bindUnboundFramebuffer(d),f._depthStencilBuffer=this._setupFramebufferDepthAttachments(A.generateStencilBuffer,A.generateDepthBuffer,M,M),A.generateMipMaps&&p.generateMipmap(p.TEXTURE_CUBE_MAP),this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),f._framebuffer=d,f.width=M,f.height=M,f.isReady=!0,f.isCube=!0,f.samples=1,f.generateMipMaps=A.generateMipMaps,f.samplingMode=A.samplingMode,f.type=A.type,f.format=A.format,f._generateDepthBuffer=A.generateDepthBuffer,f._generateStencilBuffer=A.generateStencilBuffer,this._internalTexturesCache.push(f),f}},523:function(Ue,P,u){"use strict";var T=u(521),S=u(477);Object.defineProperty(S.a.prototype,"sphericalPolynomial",{get:function(){var j=this;if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=T.a.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(function(O){j._texture._sphericalPolynomial=O,j._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(j){this._texture&&(this._texture._sphericalPolynomial=j)},enumerable:!0,configurable:!0})},527:function(Ue,P,u){"use strict";u.d(P,"a",function(){return O});var T=u(434),S=u(442),j=u(492),O=function(M){Object(T.d)(H,M);function H(A,p,f,h,m,d,g,v,l){d===void 0&&(d=!0),g===void 0&&(g=!1),v===void 0&&(v=3),l===void 0&&(l=0);var y=M.call(this,null,m,!d,g)||this;return y.format=h,y._engine&&(y._texture=y._engine.createRawTexture(A,p,f,h,d,g,v,null,l),y.wrapU=S.a.CLAMP_ADDRESSMODE,y.wrapV=S.a.CLAMP_ADDRESSMODE),y}return H.prototype.update=function(A){this._getEngine().updateRawTexture(this._texture,A,this._texture.format,this._texture.invertY,null,this._texture.type)},H.CreateLuminanceTexture=function(A,p,f,h,m,d,g){return m===void 0&&(m=!0),d===void 0&&(d=!1),g===void 0&&(g=3),new H(A,p,f,1,h,m,d,g)},H.CreateLuminanceAlphaTexture=function(A,p,f,h,m,d,g){return m===void 0&&(m=!0),d===void 0&&(d=!1),g===void 0&&(g=3),new H(A,p,f,2,h,m,d,g)},H.CreateAlphaTexture=function(A,p,f,h,m,d,g){return m===void 0&&(m=!0),d===void 0&&(d=!1),g===void 0&&(g=3),new H(A,p,f,0,h,m,d,g)},H.CreateRGBTexture=function(A,p,f,h,m,d,g,v){return m===void 0&&(m=!0),d===void 0&&(d=!1),g===void 0&&(g=3),v===void 0&&(v=0),new H(A,p,f,4,h,m,d,g,v)},H.CreateRGBATexture=function(A,p,f,h,m,d,g,v){return m===void 0&&(m=!0),d===void 0&&(d=!1),g===void 0&&(g=3),v===void 0&&(v=0),new H(A,p,f,5,h,m,d,g,v)},H.CreateRTexture=function(A,p,f,h,m,d,g,v){return m===void 0&&(m=!0),d===void 0&&(d=!1),g===void 0&&(g=S.a.TRILINEAR_SAMPLINGMODE),v===void 0&&(v=1),new H(A,p,f,6,h,m,d,g,v)},H}(S.a)},529:function(Ue,P,u){"use strict";u.d(P,"b",function(){return En}),u.d(P,"a",function(){return Ka});var T=u(434),S=u(439),j=u(440),O=u(490),M=u(514),H=u(449),A=u(436),p=u(447),f=u(626),h=u(480),m=u(454),d=function(){function We(ye){this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new A.d(1,0),this._texture=null,this.texture=null,this._internalMarkAllSubMeshesAsTexturesDirty=ye}return We.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},We.prototype.isReadyForSubMesh=function(ye,oe){return!(ye._areTexturesDirty&&oe.texturesEnabled&&this._texture&&h.a.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())},We.prototype.prepareDefines=function(ye,oe,_e){this._isEnabled?(ye.ANISOTROPIC=this._isEnabled,this._isEnabled&&!oe.isVerticesDataPresent(p.b.TangentKind)&&(ye._needUVs=!0,ye.MAINUV1=!0),ye._areTexturesDirty&&_e.texturesEnabled&&(this._texture&&h.a.AnisotropicTextureEnabled?m.a.PrepareDefinesForMergedUV(this._texture,ye,"ANISOTROPIC_TEXTURE"):ye.ANISOTROPIC_TEXTURE=!1)):(ye.ANISOTROPIC=!1,ye.ANISOTROPIC_TEXTURE=!1)},We.prototype.bindForSubMesh=function(ye,oe,_e){(!ye.useUbo||!_e||!ye.isSync)&&(this._texture&&h.a.AnisotropicTextureEnabled&&(ye.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),m.a.BindTextureMatrix(this._texture,ye,"anisotropy")),ye.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),oe.texturesEnabled&&this._texture&&h.a.AnisotropicTextureEnabled&&ye.setTexture("anisotropySampler",this._texture)},We.prototype.hasTexture=function(ye){return this._texture===ye},We.prototype.getActiveTextures=function(ye){this._texture&&ye.push(this._texture)},We.prototype.getAnimatables=function(ye){this._texture&&this._texture.animations&&this._texture.animations.length>0&&ye.push(this._texture)},We.prototype.dispose=function(ye){ye&&this._texture&&this._texture.dispose()},We.prototype.getClassName=function(){return"PBRAnisotropicConfiguration"},We.AddFallbacks=function(ye,oe,_e){return ye.ANISOTROPIC&&oe.addFallback(_e++,"ANISOTROPIC"),_e},We.AddUniforms=function(ye){ye.push("vAnisotropy","vAnisotropyInfos","anisotropyMatrix")},We.PrepareUniformBuffer=function(ye){ye.addUniform("vAnisotropy",3),ye.addUniform("vAnisotropyInfos",2),ye.addUniform("anisotropyMatrix",16)},We.AddSamplers=function(ye){ye.push("anisotropySampler")},We.prototype.copyTo=function(ye){S.a.Clone(function(){return ye},this)},We.prototype.serialize=function(){return S.a.Serialize(this)},We.prototype.parse=function(ye,oe,_e){var Ve=this;S.a.Parse(function(){return Ve},ye,oe,_e)},Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"isEnabled",void 0),Object(T.c)([Object(S.c)()],We.prototype,"intensity",void 0),Object(T.c)([Object(S.n)()],We.prototype,"direction",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"texture",void 0),We}(),g=function(){function We(ye){this._useEnergyConservation=We.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=We.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=We.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=We.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=We.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=We.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=We.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=We.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=ye}return We.prototype._markAllSubMeshesAsMiscDirty=function(){this._internalMarkAllSubMeshesAsMiscDirty()},We.prototype.prepareDefines=function(ye){ye.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,ye.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,ye.SPHERICAL_HARMONICS=this._useSphericalHarmonics,ye.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation},We.prototype.getClassName=function(){return"PBRBRDFConfiguration"},We.prototype.copyTo=function(ye){S.a.Clone(function(){return ye},this)},We.prototype.serialize=function(){return S.a.Serialize(this)},We.prototype.parse=function(ye,oe,_e){var Ve=this;S.a.Parse(function(){return Ve},ye,oe,_e)},We.DEFAULT_USE_ENERGY_CONSERVATION=!0,We.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,We.DEFAULT_USE_SPHERICAL_HARMONICS=!0,We.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsMiscDirty")],We.prototype,"useEnergyConservation",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsMiscDirty")],We.prototype,"useSmithVisibilityHeightCorrelated",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsMiscDirty")],We.prototype,"useSphericalHarmonics",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsMiscDirty")],We.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),We}(),v=u(441),l=function(){function We(ye){this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=v.a.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=ye}return We.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},We.prototype.isReadyForSubMesh=function(ye,oe){return!(ye._areTexturesDirty&&oe.texturesEnabled&&(this._texture&&h.a.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&h.a.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()))},We.prototype.prepareDefines=function(ye,oe){var _e;this._isEnabled?(ye.SHEEN=this._isEnabled,ye.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,ye.SHEEN_ROUGHNESS=this._roughness!==null,ye.SHEEN_ALBEDOSCALING=this._albedoScaling,ye.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,ye.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((_e=this._textureRoughness)===null||_e===void 0?void 0:_e._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),ye._areTexturesDirty&&oe.texturesEnabled&&(this._texture&&h.a.SheenTextureEnabled?m.a.PrepareDefinesForMergedUV(this._texture,ye,"SHEEN_TEXTURE"):ye.SHEEN_TEXTURE=!1,this._textureRoughness&&h.a.SheenTextureEnabled?m.a.PrepareDefinesForMergedUV(this._textureRoughness,ye,"SHEEN_TEXTURE_ROUGHNESS"):ye.SHEEN_TEXTURE_ROUGHNESS=!1)):(ye.SHEEN=!1,ye.SHEEN_TEXTURE=!1,ye.SHEEN_TEXTURE_ROUGHNESS=!1,ye.SHEEN_LINKWITHALBEDO=!1,ye.SHEEN_ROUGHNESS=!1,ye.SHEEN_ALBEDOSCALING=!1,ye.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,ye.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1)},We.prototype.bindForSubMesh=function(ye,oe,_e,Ve){var dt,vt,ut,Yt,pt,Ye,Pt,Ct,ri=Ve._materialDefines,_t=ri.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!ye.useUbo||!_e||!ye.isSync)&&(_t&&h.a.SheenTextureEnabled?(ye.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),m.a.BindTextureMatrix(this._texture,ye,"sheen")):(this._texture||this._textureRoughness)&&h.a.SheenTextureEnabled&&(ye.updateFloat4("vSheenInfos",(vt=(dt=this._texture)===null||dt===void 0?void 0:dt.coordinatesIndex)!==null&&vt!==void 0?vt:0,(Yt=(ut=this._texture)===null||ut===void 0?void 0:ut.level)!==null&&Yt!==void 0?Yt:0,(Ye=(pt=this._textureRoughness)===null||pt===void 0?void 0:pt.coordinatesIndex)!==null&&Ye!==void 0?Ye:0,(Ct=(Pt=this._textureRoughness)===null||Pt===void 0?void 0:Pt.level)!==null&&Ct!==void 0?Ct:0),this._texture&&m.a.BindTextureMatrix(this._texture,ye,"sheen"),this._textureRoughness&&!_t&&!ri.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&m.a.BindTextureMatrix(this._textureRoughness,ye,"sheenRoughness")),ye.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&ye.updateFloat("vSheenRoughness",this._roughness)),oe.texturesEnabled&&(this._texture&&h.a.SheenTextureEnabled&&ye.setTexture("sheenSampler",this._texture),this._textureRoughness&&!_t&&!ri.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&h.a.SheenTextureEnabled&&ye.setTexture("sheenRoughnessSampler",this._textureRoughness))},We.prototype.hasTexture=function(ye){return this._texture===ye||this._textureRoughness===ye},We.prototype.getActiveTextures=function(ye){this._texture&&ye.push(this._texture),this._textureRoughness&&ye.push(this._textureRoughness)},We.prototype.getAnimatables=function(ye){this._texture&&this._texture.animations&&this._texture.animations.length>0&&ye.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&ye.push(this._textureRoughness)},We.prototype.dispose=function(ye){var oe,_e;ye&&((oe=this._texture)===null||oe===void 0||oe.dispose(),(_e=this._textureRoughness)===null||_e===void 0||_e.dispose())},We.prototype.getClassName=function(){return"PBRSheenConfiguration"},We.AddFallbacks=function(ye,oe,_e){return ye.SHEEN&&oe.addFallback(_e++,"SHEEN"),_e},We.AddUniforms=function(ye){ye.push("vSheenColor","vSheenRoughness","vSheenInfos","sheenMatrix","sheenRoughnessMatrix")},We.PrepareUniformBuffer=function(ye){ye.addUniform("vSheenColor",4),ye.addUniform("vSheenRoughness",1),ye.addUniform("vSheenInfos",4),ye.addUniform("sheenMatrix",16),ye.addUniform("sheenRoughnessMatrix",16)},We.AddSamplers=function(ye){ye.push("sheenSampler"),ye.push("sheenRoughnessSampler")},We.prototype.copyTo=function(ye){S.a.Clone(function(){return ye},this)},We.prototype.serialize=function(){return S.a.Serialize(this)},We.prototype.parse=function(ye,oe,_e){var Ve=this;S.a.Parse(function(){return Ve},ye,oe,_e)},Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"isEnabled",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"linkSheenWithAlbedo",void 0),Object(T.c)([Object(S.c)()],We.prototype,"intensity",void 0),Object(T.c)([Object(S.e)()],We.prototype,"color",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"texture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"useRoughnessFromMainTexture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"roughness",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"textureRoughness",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"albedoScaling",void 0),We}(),y=u(450),E=function(){function We(ye,oe,_e){this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.tintColor=v.a.White(),this.tintColorAtDistance=1,this.diffusionDistance=v.a.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._useMaskFromThicknessTextureGltf=!1,this.useMaskFromThicknessTextureGltf=!1,this._internalMarkAllSubMeshesAsTexturesDirty=ye,this._internalMarkScenePrePassDirty=oe,this._scene=_e}return Object.defineProperty(We.prototype,"scatteringDiffusionProfile",{get:function(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null},set:function(ye){!this._scene.enableSubSurfaceForPrePass()||ye&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(ye))},enumerable:!1,configurable:!0}),Object.defineProperty(We.prototype,"volumeIndexOfRefraction",{get:function(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction},set:function(ye){ye>=1?this._volumeIndexOfRefraction=ye:this._volumeIndexOfRefraction=-1},enumerable:!1,configurable:!0}),We.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},We.prototype._markScenePrePassDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()},We.prototype.isReadyForSubMesh=function(ye,oe){if(ye._areTexturesDirty&&oe.texturesEnabled){if(this._thicknessTexture&&h.a.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;var _e=this._getRefractionTexture(oe);if(_e&&h.a.RefractionTextureEnabled&&!_e.isReadyOrNotBlocking())return!1}return!0},We.prototype.prepareDefines=function(ye,oe){if(ye._areTexturesDirty&&(ye.SUBSURFACE=!1,ye.SS_TRANSLUCENCY=this._isTranslucencyEnabled,ye.SS_SCATTERING=this._isScatteringEnabled,ye.SS_THICKNESSANDMASK_TEXTURE=!1,ye.SS_MASK_FROM_THICKNESS_TEXTURE=!1,ye.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=!1,ye.SS_REFRACTION=!1,ye.SS_REFRACTIONMAP_3D=!1,ye.SS_GAMMAREFRACTION=!1,ye.SS_RGBDREFRACTION=!1,ye.SS_LINEARSPECULARREFRACTION=!1,ye.SS_REFRACTIONMAP_OPPOSITEZ=!1,ye.SS_LODINREFRACTIONALPHA=!1,ye.SS_LINKREFRACTIONTOTRANSPARENCY=!1,ye.SS_ALBEDOFORREFRACTIONTINT=!1,(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled)&&(ye.SUBSURFACE=!0,ye._areTexturesDirty&&oe.texturesEnabled&&this._thicknessTexture&&h.a.ThicknessTextureEnabled&&m.a.PrepareDefinesForMergedUV(this._thicknessTexture,ye,"SS_THICKNESSANDMASK_TEXTURE"),ye.SS_MASK_FROM_THICKNESS_TEXTURE=this._useMaskFromThicknessTexture,ye.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=this._useMaskFromThicknessTextureGltf),this._isRefractionEnabled&&oe.texturesEnabled)){var _e=this._getRefractionTexture(oe);_e&&h.a.RefractionTextureEnabled&&(ye.SS_REFRACTION=!0,ye.SS_REFRACTIONMAP_3D=_e.isCube,ye.SS_GAMMAREFRACTION=_e.gammaSpace,ye.SS_RGBDREFRACTION=_e.isRGBD,ye.SS_LINEARSPECULARREFRACTION=_e.linearSpecularLOD,ye.SS_REFRACTIONMAP_OPPOSITEZ=_e.invertZ,ye.SS_LODINREFRACTIONALPHA=_e.lodLevelInAlpha,ye.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,ye.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction)}},We.prototype.bindForSubMesh=function(ye,oe,_e,Ve,dt,vt){var ut=this._getRefractionTexture(oe);if(!ye.useUbo||!Ve||!ye.isSync){if(this._thicknessTexture&&h.a.ThicknessTextureEnabled&&(ye.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),m.a.BindTextureMatrix(this._thicknessTexture,ye,"thickness")),ye.updateFloat2("vThicknessParam",this.minimumThickness,this.maximumThickness-this.minimumThickness),ut&&h.a.RefractionTextureEnabled){ye.updateMatrix("refractionMatrix",ut.getReflectionTextureMatrix());var Yt=1;ut.isCube||ut.depth&&(Yt=ut.depth);var pt=ut.getSize().width,Ye=this.volumeIndexOfRefraction;ye.updateFloat4("vRefractionInfos",ut.level,1/Ye,Yt,this._invertRefractionY?-1:1),ye.updateFloat3("vRefractionMicrosurfaceInfos",pt,ut.lodGenerationScale,ut.lodGenerationOffset),vt&&ye.updateFloat2("vRefractionFilteringInfo",pt,y.a.Log2(pt))}this.isScatteringEnabled&&ye.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),ye.updateColor3("vDiffusionDistance",this.diffusionDistance),ye.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,this.tintColorAtDistance),ye.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}oe.texturesEnabled&&(this._thicknessTexture&&h.a.ThicknessTextureEnabled&&ye.setTexture("thicknessSampler",this._thicknessTexture),ut&&h.a.RefractionTextureEnabled&&(dt?ye.setTexture("refractionSampler",ut):(ye.setTexture("refractionSampler",ut._lodTextureMid||ut),ye.setTexture("refractionSamplerLow",ut._lodTextureLow||ut),ye.setTexture("refractionSamplerHigh",ut._lodTextureHigh||ut))))},We.prototype.unbind=function(ye){return this._refractionTexture&&this._refractionTexture.isRenderTarget?(ye.setTexture("refractionSampler",null),!0):!1},We.prototype._getRefractionTexture=function(ye){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?ye.environmentTexture:null},Object.defineProperty(We.prototype,"disableAlphaBlending",{get:function(){return this.isRefractionEnabled&&this._linkRefractionWithTransparency},enumerable:!1,configurable:!0}),We.prototype.fillRenderTargetTextures=function(ye){h.a.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&ye.push(this._refractionTexture)},We.prototype.hasTexture=function(ye){return this._thicknessTexture===ye||this._refractionTexture===ye},We.prototype.hasRenderTargetTextures=function(){return!!(h.a.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)},We.prototype.getActiveTextures=function(ye){this._thicknessTexture&&ye.push(this._thicknessTexture),this._refractionTexture&&ye.push(this._refractionTexture)},We.prototype.getAnimatables=function(ye){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&ye.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&ye.push(this._refractionTexture)},We.prototype.dispose=function(ye){ye&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())},We.prototype.getClassName=function(){return"PBRSubSurfaceConfiguration"},We.AddFallbacks=function(ye,oe,_e){return ye.SS_SCATTERING&&oe.addFallback(_e++,"SS_SCATTERING"),ye.SS_TRANSLUCENCY&&oe.addFallback(_e++,"SS_TRANSLUCENCY"),_e},We.AddUniforms=function(ye){ye.push("vDiffusionDistance","vTintColor","vSubSurfaceIntensity","vRefractionMicrosurfaceInfos","vRefractionFilteringInfo","vRefractionInfos","vThicknessInfos","vThicknessParam","refractionMatrix","thicknessMatrix","scatteringDiffusionProfile")},We.AddSamplers=function(ye){ye.push("thicknessSampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")},We.PrepareUniformBuffer=function(ye){ye.addUniform("vRefractionMicrosurfaceInfos",3),ye.addUniform("vRefractionFilteringInfo",2),ye.addUniform("vRefractionInfos",4),ye.addUniform("refractionMatrix",16),ye.addUniform("vThicknessInfos",2),ye.addUniform("thicknessMatrix",16),ye.addUniform("vThicknessParam",2),ye.addUniform("vDiffusionDistance",3),ye.addUniform("vTintColor",4),ye.addUniform("vSubSurfaceIntensity",3),ye.addUniform("scatteringDiffusionProfile",1)},We.prototype.copyTo=function(ye){S.a.Clone(function(){return ye},this)},We.prototype.serialize=function(){return S.a.Serialize(this)},We.prototype.parse=function(ye,oe,_e){var Ve=this;S.a.Parse(function(){return Ve},ye,oe,_e)},Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"isRefractionEnabled",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"isTranslucencyEnabled",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markScenePrePassDirty")],We.prototype,"isScatteringEnabled",void 0),Object(T.c)([Object(S.c)()],We.prototype,"_scatteringDiffusionProfileIndex",void 0),Object(T.c)([Object(S.c)()],We.prototype,"refractionIntensity",void 0),Object(T.c)([Object(S.c)()],We.prototype,"translucencyIntensity",void 0),Object(T.c)([Object(S.c)()],We.prototype,"useAlbedoToTintRefraction",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"thicknessTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"refractionTexture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"indexOfRefraction",void 0),Object(T.c)([Object(S.c)()],We.prototype,"_volumeIndexOfRefraction",void 0),Object(T.c)([Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"volumeIndexOfRefraction",null),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"invertRefractionY",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"linkRefractionWithTransparency",void 0),Object(T.c)([Object(S.c)()],We.prototype,"minimumThickness",void 0),Object(T.c)([Object(S.c)()],We.prototype,"maximumThickness",void 0),Object(T.c)([Object(S.e)()],We.prototype,"tintColor",void 0),Object(T.c)([Object(S.c)()],We.prototype,"tintColorAtDistance",void 0),Object(T.c)([Object(S.e)()],We.prototype,"diffusionDistance",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"useMaskFromThicknessTexture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"useMaskFromThicknessTextureGltf",void 0),We}(),R=u(744),F=u(491),B=u(459),L=u(552),I=u(553),k=u(442),Z=u(523),Y=u(435),U=u(746),Q="pbrFragmentDeclaration",G=`uniform vec4 vEyePosition;
uniform vec3 vReflectionColor;
uniform vec4 vAlbedoColor;

uniform vec4 vLightingIntensity;
uniform vec4 vReflectivityColor;
uniform vec4 vMetallicReflectanceFactors;
uniform vec3 vEmissiveColor;
uniform float visibility;
uniform vec3 vAmbientColor;

#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif

#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif

#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize;
#endif
#endif

#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;
uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform vec2 vClearCoatTangentSpaceParams;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;
uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif

#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif

#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif

#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec3 vRefractionMicrosurfaceInfos;
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
uniform vec2 vThicknessParam;
uniform vec3 vDiffusionDistance;
uniform vec4 vTintColor;
uniform vec3 vSubSurfaceIntensity;
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
`;Y.a.IncludesShadersStore[Q]=G;var K={name:Q,shader:G},fe=u(674),ce=u(745),re="pbrUboDeclaration",Re=`layout(std140,column_major) uniform;





















uniform Material {
vec2 vAlbedoInfos;
vec4 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec3 vReflectivityInfos;
vec2 vMicroSurfaceSamplerInfos;
vec2 vReflectionInfos;
vec2 vReflectionFilteringInfo;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec3 vBumpInfos;
mat4 albedoMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 reflectivityMatrix;
mat4 microSurfaceSamplerMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
mat4 reflectionMatrix;
vec3 vReflectionColor;
vec4 vAlbedoColor;
vec4 vLightingIntensity;
vec3 vReflectionMicrosurfaceInfos;
float pointSize;
vec4 vReflectivityColor;
vec3 vEmissiveColor;
vec3 vAmbientColor;
vec2 vDebugMode;
vec4 vMetallicReflectanceFactors;
vec2 vMetallicReflectanceInfos;
mat4 metallicReflectanceMatrix;
vec2 vClearCoatParams;
vec4 vClearCoatRefractionParams;
vec4 vClearCoatInfos;
mat4 clearCoatMatrix;
mat4 clearCoatRoughnessMatrix;
vec2 vClearCoatBumpInfos;
vec2 vClearCoatTangentSpaceParams;
mat4 clearCoatBumpMatrix;
vec4 vClearCoatTintParams;
float clearCoatColorAtDistance;
vec2 vClearCoatTintInfos;
mat4 clearCoatTintMatrix;
vec3 vAnisotropy;
vec2 vAnisotropyInfos;
mat4 anisotropyMatrix;
vec4 vSheenColor;
float vSheenRoughness;
vec4 vSheenInfos;
mat4 sheenMatrix;
mat4 sheenRoughnessMatrix;
vec3 vRefractionMicrosurfaceInfos;
vec2 vRefractionFilteringInfo;
vec4 vRefractionInfos;
mat4 refractionMatrix;
vec2 vThicknessInfos;
mat4 thicknessMatrix;
vec2 vThicknessParam;
vec3 vDiffusionDistance;
vec4 vTintColor;
vec3 vSubSurfaceIntensity;
float scatteringDiffusionProfile;
vec4 vDetailInfos;
mat4 detailMatrix;
vec3 vSphericalL00;
vec3 vSphericalL1_1;
vec3 vSphericalL10;
vec3 vSphericalL11;
vec3 vSphericalL2_2;
vec3 vSphericalL2_1;
vec3 vSphericalL20;
vec3 vSphericalL21;
vec3 vSphericalL22;
vec3 vSphericalX;
vec3 vSphericalY;
vec3 vSphericalZ;
vec3 vSphericalXX_ZZ;
vec3 vSphericalYY_ZZ;
vec3 vSphericalZZ;
vec3 vSphericalXY;
vec3 vSphericalYZ;
vec3 vSphericalZX;
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;Y.a.IncludesShadersStore[re]=Re;var Ie={name:re,shader:Re},Ce="pbrFragmentExtraDeclaration",X=`
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#ifdef VERTEXCOLOR
varying vec4 vColor;
#endif`;Y.a.IncludesShadersStore[Ce]=X;var ae={name:Ce,shader:X},ee=u(650),w=u(651),N="pbrFragmentSamplersDeclaration",W=`#ifdef ALBEDO
#if ALBEDODIRECTUV == 1
#define vAlbedoUV vMainUV1
#elif ALBEDODIRECTUV == 2
#define vAlbedoUV vMainUV2
#else
varying vec2 vAlbedoUV;
#endif
uniform sampler2D albedoSampler;
#endif
#ifdef AMBIENT
#if AMBIENTDIRECTUV == 1
#define vAmbientUV vMainUV1
#elif AMBIENTDIRECTUV == 2
#define vAmbientUV vMainUV2
#else
varying vec2 vAmbientUV;
#endif
uniform sampler2D ambientSampler;
#endif
#ifdef OPACITY
#if OPACITYDIRECTUV == 1
#define vOpacityUV vMainUV1
#elif OPACITYDIRECTUV == 2
#define vOpacityUV vMainUV2
#else
varying vec2 vOpacityUV;
#endif
uniform sampler2D opacitySampler;
#endif
#ifdef EMISSIVE
#if EMISSIVEDIRECTUV == 1
#define vEmissiveUV vMainUV1
#elif EMISSIVEDIRECTUV == 2
#define vEmissiveUV vMainUV2
#else
varying vec2 vEmissiveUV;
#endif
uniform sampler2D emissiveSampler;
#endif
#ifdef LIGHTMAP
#if LIGHTMAPDIRECTUV == 1
#define vLightmapUV vMainUV1
#elif LIGHTMAPDIRECTUV == 2
#define vLightmapUV vMainUV2
#else
varying vec2 vLightmapUV;
#endif
uniform sampler2D lightmapSampler;
#endif
#ifdef REFLECTIVITY
#if REFLECTIVITYDIRECTUV == 1
#define vReflectivityUV vMainUV1
#elif REFLECTIVITYDIRECTUV == 2
#define vReflectivityUV vMainUV2
#else
varying vec2 vReflectivityUV;
#endif
uniform sampler2D reflectivitySampler;
#endif
#ifdef MICROSURFACEMAP
#if MICROSURFACEMAPDIRECTUV == 1
#define vMicroSurfaceSamplerUV vMainUV1
#elif MICROSURFACEMAPDIRECTUV == 2
#define vMicroSurfaceSamplerUV vMainUV2
#else
varying vec2 vMicroSurfaceSamplerUV;
#endif
uniform sampler2D microSurfaceSampler;
#endif
#ifdef METALLIC_REFLECTANCE
#if METALLIC_REFLECTANCEDIRECTUV == 1
#define vMetallicReflectanceUV vMainUV1
#elif METALLIC_REFLECTANCEDIRECTUV == 2
#define vMetallicReflectanceUV vMainUV2
#else
varying vec2 vMetallicReflectanceUV;
#endif
uniform sampler2D metallicReflectanceSampler;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE)
#if CLEARCOAT_TEXTUREDIRECTUV == 1
#define vClearCoatUV vMainUV1
#elif CLEARCOAT_TEXTUREDIRECTUV == 2
#define vClearCoatUV vMainUV2
#else
varying vec2 vClearCoatUV;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
#if CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 1
#define vClearCoatRoughnessUV vMainUV1
#elif CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 2
#define vClearCoatRoughnessUV vMainUV2
#else
varying vec2 vClearCoatRoughnessUV;
#endif
#endif
#ifdef CLEARCOAT_TEXTURE
uniform sampler2D clearCoatSampler;
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#ifdef CLEARCOAT_BUMP
#if CLEARCOAT_BUMPDIRECTUV == 1
#define vClearCoatBumpUV vMainUV1
#elif CLEARCOAT_BUMPDIRECTUV == 2
#define vClearCoatBumpUV vMainUV2
#else
varying vec2 vClearCoatBumpUV;
#endif
uniform sampler2D clearCoatBumpSampler;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
#if CLEARCOAT_TINT_TEXTUREDIRECTUV == 1
#define vClearCoatTintUV vMainUV1
#elif CLEARCOAT_TINT_TEXTUREDIRECTUV == 2
#define vClearCoatTintUV vMainUV2
#else
varying vec2 vClearCoatTintUV;
#endif
uniform sampler2D clearCoatTintSampler;
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_TEXTURE
#if SHEEN_TEXTUREDIRECTUV == 1
#define vSheenUV vMainUV1
#elif SHEEN_TEXTUREDIRECTUV == 2
#define vSheenUV vMainUV2
#else
varying vec2 vSheenUV;
#endif
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
#if SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 1
#define vSheenRoughnessUV vMainUV1
#elif SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 2
#define vSheenRoughnessUV vMainUV2
#else
varying vec2 vSheenRoughnessUV;
#endif
#endif
#ifdef SHEEN_TEXTURE
uniform sampler2D sheenSampler;
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
#if ANISOTROPIC_TEXTUREDIRECTUV == 1
#define vAnisotropyUV vMainUV1
#elif ANISOTROPIC_TEXTUREDIRECTUV == 2
#define vAnisotropyUV vMainUV2
#else
varying vec2 vAnisotropyUV;
#endif
uniform sampler2D anisotropySampler;
#endif
#endif

#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;
uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif

#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;
uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;
uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#if SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 1
#define vThicknessUV vMainUV1
#elif SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 2
#define vThicknessUV vMainUV2
#else
varying vec2 vThicknessUV;
#endif
uniform sampler2D thicknessSampler;
#endif
#endif`;Y.a.IncludesShadersStore[N]=W;var $={name:N,shader:W},J=u(524),le=u(592),ne=u(558),be=u(597),Me=u(457),Te=u(627),Ae=u(605),se="pbrHelperFunctions",te=`
#define RECIPROCAL_PI2 0.15915494
#define RECIPROCAL_PI 0.31830988618

#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{

return square(roughness)+MINIMUMVARIANCE;
}
float fresnelGrazingReflectance(float reflectance0) {


float reflectance90=saturate(reflectance0*25.0);
return reflectance90;
}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);
vec3 nDfdy=dFdy(normalVector.xyz);
float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));

float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);

float geometricAlphaGFactor=sqrt(slopeSquare);

geometricAlphaGFactor*=0.75;
return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC


vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {
float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);
float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);
return vec2(alphaT,alphaB);
}


vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {
vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);
vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);
vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));
return anisotropicNormal;

}
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)



vec3 cocaLambert(vec3 alpha,float distance) {
return exp(-alpha*distance);
}

vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {
return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));
}

vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {
return -log(color)/distance;
}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);
return clearCoatAbsorption;
}
#endif




#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{
const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;
float reflectivityLuminance=getLuminance(reflectivityColor);
float reflectivityLuma=sqrt(reflectivityLuminance);
microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;
return microSurface;
}
#endif`;Y.a.IncludesShadersStore[se]=te;var he={name:se,shader:te},de=u(525),Ne=u(652),Le="harmonicsFunctions",pe=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS







vec3 computeEnvironmentIrradiance(vec3 normal) {
return vSphericalL00
+vSphericalL1_1*(normal.y)
+vSphericalL10*(normal.z)
+vSphericalL11*(normal.x)
+vSphericalL2_2*(normal.y*normal.x)
+vSphericalL2_1*(normal.y*normal.z)
+vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+vSphericalL21*(normal.z*normal.x)
+vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));
}
#else

vec3 computeEnvironmentIrradiance(vec3 normal) {









float Nx=normal.x;
float Ny=normal.y;
float Nz=normal.z;
vec3 C1=vSphericalZZ.rgb;
vec3 Cx=vSphericalX.rgb;
vec3 Cy=vSphericalY.rgb;
vec3 Cz=vSphericalZ.rgb;
vec3 Cxx_zz=vSphericalXX_ZZ.rgb;
vec3 Cyy_zz=vSphericalYY_ZZ.rgb;
vec3 Cxy=vSphericalXY.rgb;
vec3 Cyz=vSphericalYZ.rgb;
vec3 Czx=vSphericalZX.rgb;
vec3 a1=Cyy_zz*Ny+Cy;
vec3 a2=Cyz*Nz+a1;
vec3 b1=Czx*Nz+Cx;
vec3 b2=Cxy*Ny+b1;
vec3 b3=Cxx_zz*Nx+b2;
vec3 t1=Cz*Nz+C1;
vec3 t2=a2*Ny+t1;
vec3 t3=b3*Nx+t2;
return t3;
}
#endif
#endif`;Y.a.IncludesShadersStore[Le]=pe;var He={name:Le,shader:pe},rt="pbrDirectLightingSetupFunctions",ot=`
struct preLightingInfo
{

vec3 lightOffset;
float lightDistanceSquared;
float lightDistance;

float attenuation;

vec3 L;
vec3 H;
float NdotV;
float NdotLUnclamped;
float NdotL;
float VdotH;
float roughness;
};
preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;

result.lightOffset=lightData.xyz-vPositionW;
result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);

result.lightDistance=sqrt(result.lightDistanceSquared);

result.L=normalize(result.lightOffset);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;

result.lightDistance=length(-lightData.xyz);

result.L=normalize(-lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;


result.NdotL=dot(N,lightData.xyz)*0.5+0.5;
result.NdotL=saturateEps(result.NdotL);
result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
#endif
return result;
}`;Y.a.IncludesShadersStore[rt]=ot;var et={name:rt,shader:ot},ht="pbrDirectLightingFalloffFunctions",Ee=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{
return max(0.,1.0-length(lightOffset)/range);
}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{
return 1.0/maxEps(lightDistanceSquared);
}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{
float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);
float factor=lightDistanceSquared*inverseSquaredRange;
float attenuation=saturate(1.0-factor*factor);
attenuation*=attenuation;

lightDistanceFalloff*=attenuation;
return lightDistanceFalloff;
}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{
float falloff=0.0;
float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));
if (cosAngle>=cosHalfAngle)
{
falloff=max(0.,pow(cosAngle,exponent));
}
return falloff;
}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{
const float kMinusLog2ConeAngleIntensityRatio=6.64385618977;





float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);


vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);
float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));
return falloff;
}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{



float cd=dot(-lightDirection,directionToLightCenterW);
float falloff=saturate(cd*lightAngleScale+lightAngleOffset);

falloff*=falloff;
return falloff;
}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;Y.a.IncludesShadersStore[ht]=Ee;var At={name:ht,shader:Ee},Ht=u(606),Ot=u(607),Ut="pbrDirectLightingFunctions",Qt=`#define CLEARCOATREFLECTANCE90 1.0

struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT


vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};

float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)

float lightRoughness=lightRadius/lightDistance;

float totalRoughness=saturate(lightRoughness+roughness);
return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {
return mix(groundColor,lightColor,info.NdotL);
}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {
float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*info.attenuation*info.NdotL*lightColor;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return toLinearSpace(textureColor);
}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {
float NdotL=absEps(info.NdotLUnclamped);

float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);

float trAdapt=step(0.,info.NdotLUnclamped);
vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float TdotH=dot(T,info.H);
float BdotH=dot(B,info.H);
float TdotV=dot(T,V);
float BdotV=dot(B,V);
float TdotL=dot(T,info.L);
float BdotL=dot(B,info.L);
float alphaG=convertRoughnessToAverageSlope(info.roughness);
vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);
alphaTB=max(alphaTB,square(geometricRoughnessFactor));
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);
float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {
float NccdotL=saturateEps(dot(Ncc,info.L));
float NccdotH=saturateEps(dot(Ncc,info.H));
float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnel*=clearCoatIntensity;
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);
float kelemenVisibility=visibility_Kelemen(info.VdotH);
float clearCoatTerm=fresnel*distribution*kelemenVisibility;
return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);
}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);
float NdotLRefract=saturateEps(dot(Ncc,LRefract));
vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);
return absorption;
}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);


float fresnel=1.;
float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);

float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);

float sheenTerm=fresnel*distribution*visibility;
return sheenTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
`;Y.a.IncludesShadersStore[Ut]=Qt;var Zi={name:Ut,shader:Qt},zi="pbrIBLFunctions",li=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {
float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;
float lod=log2(microsurfaceAverageSlopeTexels);
return lod;
}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {
float lod=log2(cubeMapDimensionPixels)*roughness;
return lod;
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {


float temp=NdotVUnclamped+ambientOcclusion;
return saturate(square(temp)-1.0+ambientOcclusion);
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {

vec3 reflection=reflect(view,normal);
float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));
return square(temp);
}
#endif




#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)


#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {
float microsurfaceAverageSlope=alphaG;






microsurfaceAverageSlope*=sqrt(abs(NdotV));
return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);
}
#endif`;Y.a.IncludesShadersStore[zi]=li;var Di={name:zi,shader:li},Zt=u(614),_i=u(615),ji=u(653),yi="pbrBlockAlbedoOpacity",ai=`struct albedoOpacityOutParams
{
vec3 surfaceAlbedo;
float alpha;
};
#define pbr_inline
void albedoOpacityBlock(
const in vec4 vAlbedoColor,
#ifdef ALBEDO
const in vec4 albedoTexture,
const in vec2 albedoInfos,
#endif
#ifdef OPACITY
const in vec4 opacityMap,
const in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
const in vec4 detailColor,
const in vec4 vDetailInfos,
#endif
out albedoOpacityOutParams outParams
)
{

vec3 surfaceAlbedo=vAlbedoColor.rgb;
float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifdef VERTEXCOLOR
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);
surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO

#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#ifdef VERTEXALPHA
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
if (alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND

alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;
outParams.alpha=alpha;
}
`;Y.a.IncludesShadersStore[yi]=ai;var Ei={name:yi,shader:ai},Gt="pbrBlockReflectivity",wi=`struct reflectivityOutParams
{
float microSurface;
float roughness;
vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
vec4 surfaceMetallicColorMap;
vec4 surfaceReflectivityColorMap;
vec2 metallicRoughness;
vec3 metallicF0;
#endif
};
#define pbr_inline
void reflectivityBlock(
const in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
const in vec3 surfaceAlbedo,
const in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
const in vec3 reflectivityInfos,
const in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
const in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
const in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
const in vec4 detailColor,
const in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{
float microSurface=vReflectivityColor.a;
vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);
outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);
float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);
float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);
metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS

microSurface=1.0-metallicRoughness.g;

vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE






outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);

surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif

outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);

surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;
microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif

microSurface=saturate(microSurface);

float roughness=1.-microSurface;
outParams.microSurface=microSurface;
outParams.roughness=roughness;
outParams.surfaceReflectivityColor=surfaceReflectivityColor;
}
`;Y.a.IncludesShadersStore[Gt]=wi;var ui={name:Gt,shader:wi},Wi="pbrBlockAmbientOcclusion",Hi=`struct ambientOcclusionOutParams
{
vec3 ambientOcclusionColor;
#if DEBUGMODE>0
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
const in vec3 ambientOcclusionColorMap_,
const in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{
vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;
}
`;Y.a.IncludesShadersStore[Wi]=Hi;var Pi={name:Wi,shader:Hi},It="pbrBlockAlphaFresnel",Ji=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{
float alpha;
};
#define pbr_inline
void alphaFresnelBlock(
const in vec3 normalW,
const in vec3 viewDirectionW,
const in float alpha,
const in float microSurface,
out alphaFresnelOutParams outParams
)
{



float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);
vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);

outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND

outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;Y.a.IncludesShadersStore[It]=Ji;var Dr={name:It,shader:Ji},Vt="pbrBlockAnisotropic",Ci=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{
float anisotropy;
vec3 anisotropicTangent;
vec3 anisotropicBitangent;
vec3 anisotropicNormal;
#if DEBUGMODE>0
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
const in vec3 vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
const in vec3 anisotropyMapData,
#endif
const in mat3 TBN,
const in vec3 normalW,
const in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{
float anisotropy=vAnisotropy.b;
vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
anisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));
vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);
vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));
outParams.anisotropy=anisotropy;
outParams.anisotropicTangent=anisotropicTangent;
outParams.anisotropicBitangent=anisotropicBitangent;
outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);
}
#endif
`;Y.a.IncludesShadersStore[Vt]=Ci;var dr={name:Vt,shader:Ci},Ii="pbrBlockReflection",kt=`#ifdef REFLECTION
struct reflectionOutParams
{
vec4 environmentRadiance;
vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
const in vec3 vPositionW,
const in vec3 normalW,
#ifdef ANISOTROPIC
const in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif

#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
const in float alphaG,
const in vec3 vReflectionMicrosurfaceInfos,
const in vec2 vReflectionInfos,
const in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
const in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
const in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
const in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSamplerLow,
const in samplerCube reflectionSamplerHigh,
#else
const in sampler2D reflectionSamplerLow,
const in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
const in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{

#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE

reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA









float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);
float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);
if (lodReflectionNormalizedDoubled<1.0){
environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);
} else {
environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif

environmentRadiance.rgb*=vReflectionInfos.x;
environmentRadiance.rgb*=vReflectionColor.rgb;
}
#define pbr_inline
#define inline
void reflectionBlock(
const in vec3 vPositionW,
const in vec3 normalW,
const in float alphaG,
const in vec3 vReflectionMicrosurfaceInfos,
const in vec2 vReflectionInfos,
const in vec3 vReflectionColor,
#ifdef ANISOTROPIC
const in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
const in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
const in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSampler,
#else
const in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
const in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
const in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
const in samplerCube irradianceSampler,
#else
const in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSamplerLow,
const in samplerCube reflectionSamplerHigh,
#else
const in sampler2D reflectionSamplerLow,
const in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
const in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{

vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);
sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);

vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;
outParams.environmentRadiance=environmentRadiance;
outParams.environmentIrradiance=environmentIrradiance;
outParams.reflectionCoords=reflectionCoords;
}
#endif
`;Y.a.IncludesShadersStore[Ii]=kt;var Nt={name:Ii,shader:kt},sr="pbrBlockSheen",Ai=`#ifdef SHEEN
struct sheenOutParams
{
float sheenIntensity;
vec3 sheenColor;
float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
vec4 sheenMapData;
vec3 sheenEnvironmentReflectance;
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
const in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
const in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
const in vec4 sheenMapRoughnessData,
#endif
#endif
const in float roughness,
#ifdef SHEEN_TEXTURE
const in vec4 sheenMapData,
#endif
const in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
const in vec3 baseColor,
const in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
const in float NdotV,
const in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
const in vec2 AARoughnessFactors,
const in vec3 vReflectionMicrosurfaceInfos,
const in vec2 vReflectionInfos,
const in vec3 vReflectionColor,
const in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSampler,
const in vec3 reflectionCoords,
#else
const in sampler2D reflectionSampler,
const in vec2 reflectionCoords,
#endif
const in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSamplerLow,
const in samplerCube reflectionSamplerHigh,
#else
const in sampler2D reflectionSamplerLow,
const in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
const in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
const in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
const in float eho,
#endif
#endif
out sheenOutParams outParams
)
{
float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);
vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);
float sheenRoughness=sheenIntensity;
outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
sheenColor.rgb*=sheenMapData.rgb;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL
sheenRoughness*=sheenMapData.a;
#else
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif

#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif

sheenColor*=sheenIntensity;
#endif

#ifdef ENVIRONMENTBRDF

#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif

#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA

sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);
sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);
vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;





#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)



outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif

outParams.sheenIntensity=sheenIntensity;
outParams.sheenColor=sheenColor;
outParams.sheenRoughness=sheenRoughness;
}
#endif
`;Y.a.IncludesShadersStore[sr]=Ai;var pr={name:sr,shader:Ai},Er="pbrBlockClearcoat",Vi=`struct clearcoatOutParams
{
vec3 specularEnvironmentR0;
float conservationFactor;
vec3 clearCoatNormalW;
vec2 clearCoatAARoughnessFactors;
float clearCoatIntensity;
float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;
float clearCoatNdotVRefract;
vec3 clearCoatColor;
float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
mat3 TBNClearCoat;
vec2 clearCoatMapData;
vec4 clearCoatTintMapData;
vec4 environmentClearCoatRadiance;
float clearCoatNdotV;
vec3 clearCoatEnvironmentReflectance;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
const in vec3 vPositionW,
const in vec3 geometricNormalW,
const in vec3 viewDirectionW,
const in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
const in vec4 clearCoatMapRoughnessData,
#endif
const in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
const in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
const in vec4 vClearCoatTintParams,
const in float clearCoatColorAtDistance,
const in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
const in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
const in vec2 vClearCoatBumpInfos,
const in vec4 clearCoatBumpMapData,
const in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
const in mat3 vTBN,
#else
const in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
const in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
const in vec3 faceNormal,
#endif
#ifdef REFLECTION
const in vec3 vReflectionMicrosurfaceInfos,
const in vec2 vReflectionInfos,
const in vec3 vReflectionColor,
const in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSampler,
#else
const in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
const in samplerCube reflectionSamplerLow,
const in samplerCube reflectionSamplerHigh,
#else
const in sampler2D reflectionSamplerLow,
const in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
const in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
const in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
const in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{

float clearCoatIntensity=vClearCoatParams.x;
float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL
clearCoatRoughness*=clearCoatMapData.y;
#else
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
#endif
outParams.clearCoatIntensity=clearCoatIntensity;
outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;
float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatColor*=clearCoatTintMapData.rgb;
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);
outParams.clearCoatThickness=clearCoatThickness;
#endif




#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);

vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else

vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;
mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz*2.0-1.0);
clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;

outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);

float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);

float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT

vec3 clearCoatVRefract=-refract(vPositionW,clearCoatNormalW,vClearCoatRefractionParams.y);

outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))

vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif

#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA

clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);
vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif

#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif

#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef RADIANCEOCCLUSION
float clearCoatSeo=environmentRadianceOcclusion(ambientMonochrome,clearCoatNdotVUnclamped);
clearCoatEnvironmentReflectance*=clearCoatSeo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);
clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else

vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)

outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif

float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnelIBLClearCoat*=clearCoatIntensity;
outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;Y.a.IncludesShadersStore[Er]=Vi;var $i={name:Er,shader:Vi},Pr="pbrBlockSubSurface",mr=`struct subSurfaceOutParams
{
vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;
vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;
float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
vec4 thicknessMap;
vec4 environmentRefraction;
vec3 refractionTransmittance;
#endif
};
#ifdef SUBSURFACE
#define pbr_inline
#define inline
void subSurfaceBlock(
const in vec3 vSubSurfaceIntensity,
const in vec2 vThicknessParam,
const in vec4 vTintColor,
const in vec3 normalW,
const in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
const in vec4 thicknessMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
const in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
const in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
const in samplerCube reflectionSampler,
const in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
const in samplerCube irradianceSampler,
#else
const in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#ifdef SS_REFRACTION
const in vec3 vPositionW,
const in vec3 viewDirectionW,
const in mat4 view,
const in vec3 surfaceAlbedo,
const in vec4 vRefractionInfos,
const in mat4 refractionMatrix,
const in vec3 vRefractionMicrosurfaceInfos,
const in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
const in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
const in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
const in float roughness,
#else
const in float alphaG,
#endif
#ifdef SS_REFRACTIONMAP_3D
const in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
const in samplerCube refractionSamplerLow,
const in samplerCube refractionSamplerHigh,
#endif
#else
const in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
const in sampler2D refractionSamplerLow,
const in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
const in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
const in vec2 vRefractionFilteringInfo,
#endif
#endif
#ifdef SS_TRANSLUCENCY
const in vec3 vDiffusionDistance,
#endif
out subSurfaceOutParams outParams
)
{
outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;



#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);

outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#ifdef SS_MASK_FROM_THICKNESS_TEXTURE
#ifdef SS_REFRACTION
refractionIntensity*=thicknessMap.g;
#endif
#ifdef SS_TRANSLUCENCY
translucencyIntensity*=thicknessMap.b;
#endif
#elif defined(SS_MASK_FROM_THICKNESS_TEXTURE_GLTF)
#ifdef SS_REFRACTION
refractionIntensity*=thicknessMap.r;
#elif defined(SS_TRANSLUCENCY)
translucencyIntensity*=thicknessMap.r;
#endif
thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#endif
#else
float thickness=vThicknessParam.y;
#endif



#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);
vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);
transmittance*=translucencyIntensity;
outParams.transmittance=transmittance;
outParams.translucencyIntensity=translucencyIntensity;
#endif



#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif

#ifdef SS_REFRACTIONMAP_3D
refractionVector.y=refractionVector.y*vRefractionInfos.w;
vec3 refractionCoords=refractionVector;
refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,roughness);
#else
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE

refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA









float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);
float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));
float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;
vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);
if (lodRefractionNormalizedDoubled<1.0){
environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);
} else {
environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);
}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif

environmentRefraction.rgb*=vRefractionInfos.x;
#endif



#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);





refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)

float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);
vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);

environmentRefraction.rgb*=volumeAlbedo;
#else

vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT

environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif

outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION

outParams.refractionFactorForIrradiance=(1.-refractionIntensity);

#endif

vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);
outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);

refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif



#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;Y.a.IncludesShadersStore[Pr]=mr;var Jt={name:Pr,shader:mr},Kt=u(550),Li="pbrBlockNormalGeometric",Ui=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;Y.a.IncludesShadersStore[Li]=Ui;var qi={name:Li,shader:Ui},Xt=u(616),er="pbrBlockNormalFinal",Vn=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;Y.a.IncludesShadersStore[er]=Vn;var tr={name:er,shader:Vn},Jr=u(747),Un="pbrBlockLightmapInit",Gn=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;Y.a.IncludesShadersStore[Un]=Gn;var Da={name:Un,shader:Gn},Ir="pbrBlockGeometryInfo",ln=`float NdotVUnclamped=dot(normalW,viewDirectionW);

float NdotV=absEps(NdotVUnclamped);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA

alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)

vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;Y.a.IncludesShadersStore[Ir]=ln;var yn={name:Ir,shader:ln},ii="pbrBlockReflectance0",qe=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);
vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif

#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);
specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;Y.a.IncludesShadersStore[ii]=qe;var Ia={name:ii,shader:qe},zn="pbrBlockReflectance",La=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else

vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;Y.a.IncludesShadersStore[zn]=La;var Fo={name:zn,shader:La},jn="pbrBlockDirectLighting",Wn=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif

preLightingInfo preInfo;
lightingInfo info;
float shadow=1.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;Y.a.IncludesShadersStore[jn]=Wn;var Fa={name:jn,shader:Wn},Ba=u(654),lr="pbrBlockFinalLitComponents",Hn=`



#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif

#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);
finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;
finalIrradiance*=vLightingIntensity.z;
finalIrradiance*=aoOut.ambientOcclusionColor;
#endif

#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;
finalSpecular=max(finalSpecular,0.0);
vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif

#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;
finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;
vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif

#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;
finalSheen=max(finalSheen,0.0);
vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif

#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;
finalClearCoat=max(finalClearCoat,0.0);
vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif

#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;Y.a.IncludesShadersStore[lr]=Hn;var Na={name:lr,shader:Hn},wa="pbrBlockFinalUnlitComponents",kn=`
vec3 finalDiffuse=diffuseBase;
finalDiffuse*=surfaceAlbedo.rgb;
finalDiffuse=max(finalDiffuse,0.0);
finalDiffuse*=vLightingIntensity.x;

vec3 finalAmbient=vAmbientColor;
finalAmbient*=surfaceAlbedo.rgb;

vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
finalEmissive*=vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;

#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;
finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;Y.a.IncludesShadersStore[wa]=kn;var Dl={name:wa,shader:kn},Xn="pbrBlockFinalColorComposition",Yn=`vec4 finalColor=vec4(
finalAmbient +
finalDiffuse +
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalEmissive,
alpha);

#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG

finalColor=max(finalColor,0.0);
`;Y.a.IncludesShadersStore[Xn]=Yn;var Va={name:Xn,shader:Yn},Ua=u(701),Ga=u(655),Lr="pbrBlockImageProcessing",Ze=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)




finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#else

finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA

finalColor.rgb*=finalColor.a;
#endif
`;Y.a.IncludesShadersStore[Lr]=Ze;var za={name:Lr,shader:Ze},Kn="pbrDebug",ja=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {

#if DEBUGMODE == 1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 3 && defined(BUMP) || DEBUGMODE == 3 && defined(PARALLAX) || DEBUGMODE == 3 && defined(ANISOTROPIC)

gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 4 && defined(BUMP) || DEBUGMODE == 4 && defined(PARALLAX) || DEBUGMODE == 4 && defined(ANISOTROPIC)

gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 5

gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE == 7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE == 8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)

gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)

gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 10 && defined(CLEARCOAT)

gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE == 13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE

#elif DEBUGMODE == 20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#elif DEBUGMODE == 21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE == 22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE == 23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE == 26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE == 28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE == 29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE == 30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE == 31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;

#elif DEBUGMODE == 40 && defined(SS_REFRACTION)

gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA

#elif DEBUGMODE == 50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#define DEBUGMODE_GAMMA

#elif DEBUGMODE == 60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE == 71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE == 63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE == 64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE == 65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE == 66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE == 68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE == 69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE == 70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;

#elif DEBUGMODE == 80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE == 81 && defined(HORIZONOCCLUSION)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE == 82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE == 83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE == 86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE == 87
gl_FragColor.rgb=vec3(alpha);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor);
gl_FragData[1]=vec4(0.,0.,0.,0.);
#endif
return;
}
#endif`;Y.a.IncludesShadersStore[Kn]=ja;var Bo={name:Kn,shader:ja},Qn="pbrPixelShader",Zn=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;

#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif

#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>

#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockSubSurface>

void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>

#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>

albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
albedoOpacityOut
);
vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;
float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS

ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else

vec3 baseColor=surfaceAlbedo;
reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);
vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
metallicReflectanceFactors*=metallicReflectanceFactorsMap;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);
float microSurface=reflectivityOut.microSurface;
float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif

#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;
alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);
alpha=alphaFresnelOut.alpha;
#endif
#endif

#include<pbrBlockGeometryInfo>

#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif

#ifdef REFLECTION
reflectionOutParams reflectionOut;
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#endif

#include<pbrBlockReflectance0>

#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=toLinearSpace(texture2D(sheenSampler,vSheenUV+uvOffset))*vSheenInfos.y;
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif

clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=toLinearSpace(texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset));
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif

#include<pbrBlockReflectance>

subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
surfaceAlbedo,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#else
alphaG,
#endif
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif

#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]

#include<pbrBlockFinalLitComponents>
#endif
#include<pbrBlockFinalUnlitComponents>
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
vec3 sqAlbedo=sqrt(surfaceAlbedo);
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a);
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor;
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),scatteringDiffusionProfile/255.);
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(sqAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(REFLECTIVITY)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(baseReflectivity.rgb,writeGeometryInfo);
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo);
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<pbrDebug>
}
`;Y.a.ShadersStore[Qn]=Zn;var pp={name:Qn,shader:Zn},gt="pbrVertexDeclaration",Fr=`uniform mat4 view;
uniform mat4 viewProjection;
uniform mat4 world;
#ifdef ALBEDO
uniform mat4 albedoMatrix;
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;
uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif

#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
#endif

#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif

#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif

#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif

#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif`;Y.a.IncludesShadersStore[gt]=Fr;var Cr={name:gt,shader:Fr},Wa=u(487),Il=u(748),No=u(749),Ha=u(593),Jn=u(656),ka=u(657),$n=u(658),Ll=u(496),qn=u(497),Br=u(507),st=u(508),gr=u(488),zt=u(489),un=u(750),Xa=u(675),Ya=u(551),eo=u(702),Tr=u(659),wo=u(703),to="pbrVertexShader",bn=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN

attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>

#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#endif
#include<prePassVertexDeclaration>
#if defined(ALBEDO) && ALBEDODIRECTUV == 0
varying vec2 vAlbedoUV;
#endif
#if defined(DETAIL) && DETAILDIRECTUV == 0
varying vec2 vDetailUV;
#endif
#if defined(AMBIENT) && AMBIENTDIRECTUV == 0
varying vec2 vAmbientUV;
#endif
#if defined(OPACITY) && OPACITYDIRECTUV == 0
varying vec2 vOpacityUV;
#endif
#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0
varying vec2 vEmissiveUV;
#endif
#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0
varying vec2 vLightmapUV;
#endif
#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0
varying vec2 vReflectivityUV;
#endif
#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0
varying vec2 vMicroSurfaceSamplerUV;
#endif
#if defined(METALLIC_REFLECTANCE) && METALLIC_REFLECTANCEDIRECTUV == 0
varying vec2 vMetallicReflectanceUV;
#endif
#if defined(BUMP) && BUMPDIRECTUV == 0
varying vec2 vBumpUV;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) && CLEARCOAT_TEXTUREDIRECTUV == 0
varying vec2 vClearCoatUV;
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 0
varying vec2 vClearCoatRoughnessUV;
#endif
#if defined(CLEARCOAT_BUMP) && CLEARCOAT_BUMPDIRECTUV == 0
varying vec2 vClearCoatBumpUV;
#endif
#if defined(CLEARCOAT_TINT_TEXTURE) && CLEARCOAT_TINT_TEXTUREDIRECTUV == 0
varying vec2 vClearCoatTintUV;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) && SHEEN_TEXTUREDIRECTUV == 0
varying vec2 vSheenUV;
#endif
#if defined(SHEEN_TEXTURE_ROUGHNESS) && SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 0
varying vec2 vSheenRoughnessUV;
#endif
#endif
#ifdef ANISOTROPIC
#if defined(ANISOTROPIC_TEXTURE) && ANISOTROPIC_TEXTUREDIRECTUV == 0
varying vec2 vAnisotropyUV;
#endif
#endif
#ifdef SUBSURFACE
#if defined(SS_THICKNESSANDMASK_TEXTURE) && SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 0
varying vec2 vThicknessUV;
#endif
#endif

varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#ifdef VERTEXCOLOR
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)

vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*previousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR == 0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif

#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(ALBEDO) && ALBEDODIRECTUV == 0
if (vAlbedoInfos.x == 0.)
{
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(DETAIL) && DETAILDIRECTUV == 0
if (vDetailInfos.x == 0.)
{
vDetailUV=vec2(detailMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vDetailUV=vec2(detailMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(AMBIENT) && AMBIENTDIRECTUV == 0
if (vAmbientInfos.x == 0.)
{
vAmbientUV=vec2(ambientMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(OPACITY) && OPACITYDIRECTUV == 0
if (vOpacityInfos.x == 0.)
{
vOpacityUV=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0
if (vEmissiveInfos.x == 0.)
{
vEmissiveUV=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0
if (vLightmapInfos.x == 0.)
{
vLightmapUV=vec2(lightmapMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0
if (vReflectivityInfos.x == 0.)
{
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0
if (vMicroSurfaceSamplerInfos.x == 0.)
{
vMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(METALLIC_REFLECTANCE) && METALLIC_REFLECTANCEDIRECTUV == 0
if (vMetallicReflectanceInfos.x == 0.)
{
vMetallicReflectanceUV=vec2(metallicReflectanceMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vMetallicReflectanceUV=vec2(metallicReflectanceMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(BUMP) && BUMPDIRECTUV == 0
if (vBumpInfos.x == 0.)
{
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) && CLEARCOAT_TEXTUREDIRECTUV == 0
if (vClearCoatInfos.x == 0.)
{
vClearCoatUV=vec2(clearCoatMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vClearCoatUV=vec2(clearCoatMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 0
if (vClearCoatInfos.z == 0.)
{
vClearCoatRoughnessUV=vec2(clearCoatRoughnessMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vClearCoatRoughnessUV=vec2(clearCoatRoughnessMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(CLEARCOAT_BUMP) && CLEARCOAT_BUMPDIRECTUV == 0
if (vClearCoatBumpInfos.x == 0.)
{
vClearCoatBumpUV=vec2(clearCoatBumpMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vClearCoatBumpUV=vec2(clearCoatBumpMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(CLEARCOAT_TINT_TEXTURE) && CLEARCOAT_TINT_TEXTUREDIRECTUV == 0
if (vClearCoatTintInfos.x == 0.)
{
vClearCoatTintUV=vec2(clearCoatTintMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vClearCoatTintUV=vec2(clearCoatTintMatrix*vec4(uv2,1.0,0.0));
}
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) && SHEEN_TEXTUREDIRECTUV == 0
if (vSheenInfos.x == 0.)
{
vSheenUV=vec2(sheenMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vSheenUV=vec2(sheenMatrix*vec4(uv2,1.0,0.0));
}
#endif
#if defined(SHEEN_TEXTURE_ROUGHNESS) && SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 0
if (vSheenInfos.z == 0.)
{
vSheenRoughnessUV=vec2(sheenRoughnessMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vSheenRoughnessUV=vec2(sheenRoughnessMatrix*vec4(uv2,1.0,0.0));
}
#endif
#endif
#ifdef ANISOTROPIC
#if defined(ANISOTROPIC_TEXTURE) && ANISOTROPIC_TEXTUREDIRECTUV == 0
if (vAnisotropyInfos.x == 0.)
{
vAnisotropyUV=vec2(anisotropyMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vAnisotropyUV=vec2(anisotropyMatrix*vec4(uv2,1.0,0.0));
}
#endif
#endif
#ifdef SUBSURFACE
#if defined(SS_THICKNESSANDMASK_TEXTURE) && SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 0
if (vThicknessInfos.x == 0.)
{
vThicknessUV=vec2(thicknessMatrix*vec4(uvUpdated,1.0,0.0));
}
else
{
vThicknessUV=vec2(thicknessMatrix*vec4(uv2,1.0,0.0));
}
#endif
#endif

#include<bumpVertex>

#include<clipPlaneVertex>

#include<fogVertex>

#include<shadowsVertex>[0..maxSimultaneousLights]

#ifdef VERTEXCOLOR
vColor=color;
#endif

#ifdef POINTSIZE
gl_PointSize=pointSize;
#endif

#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;Y.a.ShadersStore[to]=bn;var pi={name:to,shader:bn},Nr=u(512),cn=u(751),$r={effect:null,subMesh:null},En=function(We){Object(T.d)(ye,We);function ye(){var oe=We.call(this)||this;return oe.PBR=!0,oe.NUM_SAMPLES="0",oe.REALTIME_FILTERING=!1,oe.MAINUV1=!1,oe.MAINUV2=!1,oe.UV1=!1,oe.UV2=!1,oe.ALBEDO=!1,oe.GAMMAALBEDO=!1,oe.ALBEDODIRECTUV=0,oe.VERTEXCOLOR=!1,oe.DETAIL=!1,oe.DETAILDIRECTUV=0,oe.DETAIL_NORMALBLENDMETHOD=0,oe.AMBIENT=!1,oe.AMBIENTDIRECTUV=0,oe.AMBIENTINGRAYSCALE=!1,oe.OPACITY=!1,oe.VERTEXALPHA=!1,oe.OPACITYDIRECTUV=0,oe.OPACITYRGB=!1,oe.ALPHATEST=!1,oe.DEPTHPREPASS=!1,oe.ALPHABLEND=!1,oe.ALPHAFROMALBEDO=!1,oe.ALPHATESTVALUE="0.5",oe.SPECULAROVERALPHA=!1,oe.RADIANCEOVERALPHA=!1,oe.ALPHAFRESNEL=!1,oe.LINEARALPHAFRESNEL=!1,oe.PREMULTIPLYALPHA=!1,oe.EMISSIVE=!1,oe.EMISSIVEDIRECTUV=0,oe.REFLECTIVITY=!1,oe.REFLECTIVITYDIRECTUV=0,oe.SPECULARTERM=!1,oe.MICROSURFACEFROMREFLECTIVITYMAP=!1,oe.MICROSURFACEAUTOMATIC=!1,oe.LODBASEDMICROSFURACE=!1,oe.MICROSURFACEMAP=!1,oe.MICROSURFACEMAPDIRECTUV=0,oe.METALLICWORKFLOW=!1,oe.ROUGHNESSSTOREINMETALMAPALPHA=!1,oe.ROUGHNESSSTOREINMETALMAPGREEN=!1,oe.METALLNESSSTOREINMETALMAPBLUE=!1,oe.AOSTOREINMETALMAPRED=!1,oe.METALLIC_REFLECTANCE=!1,oe.METALLIC_REFLECTANCEDIRECTUV=0,oe.ENVIRONMENTBRDF=!1,oe.ENVIRONMENTBRDF_RGBD=!1,oe.NORMAL=!1,oe.TANGENT=!1,oe.BUMP=!1,oe.BUMPDIRECTUV=0,oe.OBJECTSPACE_NORMALMAP=!1,oe.PARALLAX=!1,oe.PARALLAXOCCLUSION=!1,oe.NORMALXYSCALE=!0,oe.LIGHTMAP=!1,oe.LIGHTMAPDIRECTUV=0,oe.USELIGHTMAPASSHADOWMAP=!1,oe.GAMMALIGHTMAP=!1,oe.RGBDLIGHTMAP=!1,oe.REFLECTION=!1,oe.REFLECTIONMAP_3D=!1,oe.REFLECTIONMAP_SPHERICAL=!1,oe.REFLECTIONMAP_PLANAR=!1,oe.REFLECTIONMAP_CUBIC=!1,oe.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,oe.REFLECTIONMAP_PROJECTION=!1,oe.REFLECTIONMAP_SKYBOX=!1,oe.REFLECTIONMAP_EXPLICIT=!1,oe.REFLECTIONMAP_EQUIRECTANGULAR=!1,oe.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,oe.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,oe.INVERTCUBICMAP=!1,oe.USESPHERICALFROMREFLECTIONMAP=!1,oe.USEIRRADIANCEMAP=!1,oe.SPHERICAL_HARMONICS=!1,oe.USESPHERICALINVERTEX=!1,oe.REFLECTIONMAP_OPPOSITEZ=!1,oe.LODINREFLECTIONALPHA=!1,oe.GAMMAREFLECTION=!1,oe.RGBDREFLECTION=!1,oe.LINEARSPECULARREFLECTION=!1,oe.RADIANCEOCCLUSION=!1,oe.HORIZONOCCLUSION=!1,oe.INSTANCES=!1,oe.THIN_INSTANCES=!1,oe.PREPASS=!1,oe.PREPASS_IRRADIANCE=!1,oe.PREPASS_IRRADIANCE_INDEX=-1,oe.PREPASS_ALBEDO=!1,oe.PREPASS_ALBEDO_INDEX=-1,oe.PREPASS_DEPTH=!1,oe.PREPASS_DEPTH_INDEX=-1,oe.PREPASS_NORMAL=!1,oe.PREPASS_NORMAL_INDEX=-1,oe.PREPASS_POSITION=!1,oe.PREPASS_POSITION_INDEX=-1,oe.PREPASS_VELOCITY=!1,oe.PREPASS_VELOCITY_INDEX=-1,oe.PREPASS_REFLECTIVITY=!1,oe.PREPASS_REFLECTIVITY_INDEX=-1,oe.SCENE_MRT_COUNT=0,oe.NUM_BONE_INFLUENCERS=0,oe.BonesPerMesh=0,oe.BONETEXTURE=!1,oe.BONES_VELOCITY_ENABLED=!1,oe.NONUNIFORMSCALING=!1,oe.MORPHTARGETS=!1,oe.MORPHTARGETS_NORMAL=!1,oe.MORPHTARGETS_TANGENT=!1,oe.MORPHTARGETS_UV=!1,oe.NUM_MORPH_INFLUENCERS=0,oe.MORPHTARGETS_TEXTURE=!1,oe.IMAGEPROCESSING=!1,oe.VIGNETTE=!1,oe.VIGNETTEBLENDMODEMULTIPLY=!1,oe.VIGNETTEBLENDMODEOPAQUE=!1,oe.TONEMAPPING=!1,oe.TONEMAPPING_ACES=!1,oe.CONTRAST=!1,oe.COLORCURVES=!1,oe.COLORGRADING=!1,oe.COLORGRADING3D=!1,oe.SAMPLER3DGREENDEPTH=!1,oe.SAMPLER3DBGRMAP=!1,oe.IMAGEPROCESSINGPOSTPROCESS=!1,oe.EXPOSURE=!1,oe.MULTIVIEW=!1,oe.USEPHYSICALLIGHTFALLOFF=!1,oe.USEGLTFLIGHTFALLOFF=!1,oe.TWOSIDEDLIGHTING=!1,oe.SHADOWFLOAT=!1,oe.CLIPPLANE=!1,oe.CLIPPLANE2=!1,oe.CLIPPLANE3=!1,oe.CLIPPLANE4=!1,oe.CLIPPLANE5=!1,oe.CLIPPLANE6=!1,oe.POINTSIZE=!1,oe.FOG=!1,oe.LOGARITHMICDEPTH=!1,oe.FORCENORMALFORWARD=!1,oe.SPECULARAA=!1,oe.CLEARCOAT=!1,oe.CLEARCOAT_DEFAULTIOR=!1,oe.CLEARCOAT_TEXTURE=!1,oe.CLEARCOAT_TEXTURE_ROUGHNESS=!1,oe.CLEARCOAT_TEXTUREDIRECTUV=0,oe.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,oe.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,oe.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,oe.CLEARCOAT_BUMP=!1,oe.CLEARCOAT_BUMPDIRECTUV=0,oe.CLEARCOAT_REMAP_F0=!0,oe.CLEARCOAT_TINT=!1,oe.CLEARCOAT_TINT_TEXTURE=!1,oe.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,oe.ANISOTROPIC=!1,oe.ANISOTROPIC_TEXTURE=!1,oe.ANISOTROPIC_TEXTUREDIRECTUV=0,oe.BRDF_V_HEIGHT_CORRELATED=!1,oe.MS_BRDF_ENERGY_CONSERVATION=!1,oe.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,oe.SHEEN=!1,oe.SHEEN_TEXTURE=!1,oe.SHEEN_TEXTURE_ROUGHNESS=!1,oe.SHEEN_TEXTUREDIRECTUV=0,oe.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,oe.SHEEN_LINKWITHALBEDO=!1,oe.SHEEN_ROUGHNESS=!1,oe.SHEEN_ALBEDOSCALING=!1,oe.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,oe.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,oe.SUBSURFACE=!1,oe.SS_REFRACTION=!1,oe.SS_TRANSLUCENCY=!1,oe.SS_SCATTERING=!1,oe.SS_THICKNESSANDMASK_TEXTURE=!1,oe.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,oe.SS_REFRACTIONMAP_3D=!1,oe.SS_REFRACTIONMAP_OPPOSITEZ=!1,oe.SS_LODINREFRACTIONALPHA=!1,oe.SS_GAMMAREFRACTION=!1,oe.SS_RGBDREFRACTION=!1,oe.SS_LINEARSPECULARREFRACTION=!1,oe.SS_LINKREFRACTIONTOTRANSPARENCY=!1,oe.SS_ALBEDOFORREFRACTIONTINT=!1,oe.SS_MASK_FROM_THICKNESS_TEXTURE=!1,oe.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=!1,oe.UNLIT=!1,oe.DEBUGMODE=0,oe.rebuild(),oe}return ye.prototype.reset=function(){We.prototype.reset.call(this),this.ALPHATESTVALUE="0.5",this.PBR=!0},ye}(L.a),Ka=function(We){Object(T.d)(ye,We);function ye(oe,_e){var Ve=We.call(this,oe,_e)||this;return Ve._directIntensity=1,Ve._emissiveIntensity=1,Ve._environmentIntensity=1,Ve._specularIntensity=1,Ve._lightingInfos=new A.f(Ve._directIntensity,Ve._emissiveIntensity,Ve._environmentIntensity,Ve._specularIntensity),Ve._disableBumpMap=!1,Ve._albedoTexture=null,Ve._ambientTexture=null,Ve._ambientTextureStrength=1,Ve._ambientTextureImpactOnAnalyticalLights=ye.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,Ve._opacityTexture=null,Ve._reflectionTexture=null,Ve._emissiveTexture=null,Ve._reflectivityTexture=null,Ve._metallicTexture=null,Ve._metallic=null,Ve._roughness=null,Ve._metallicF0Factor=1,Ve._metallicReflectanceColor=v.a.White(),Ve._metallicReflectanceTexture=null,Ve._microSurfaceTexture=null,Ve._bumpTexture=null,Ve._lightmapTexture=null,Ve._ambientColor=new v.a(0,0,0),Ve._albedoColor=new v.a(1,1,1),Ve._reflectivityColor=new v.a(1,1,1),Ve._reflectionColor=new v.a(1,1,1),Ve._emissiveColor=new v.a(0,0,0),Ve._microSurface=.9,Ve._useLightmapAsShadowmap=!1,Ve._useHorizonOcclusion=!0,Ve._useRadianceOcclusion=!0,Ve._useAlphaFromAlbedoTexture=!1,Ve._useSpecularOverAlpha=!0,Ve._useMicroSurfaceFromReflectivityMapAlpha=!1,Ve._useRoughnessFromMetallicTextureAlpha=!0,Ve._useRoughnessFromMetallicTextureGreen=!1,Ve._useMetallnessFromMetallicTextureBlue=!1,Ve._useAmbientOcclusionFromMetallicTextureRed=!1,Ve._useAmbientInGrayScale=!1,Ve._useAutoMicroSurfaceFromReflectivityMap=!1,Ve._lightFalloff=ye.LIGHTFALLOFF_PHYSICAL,Ve._useRadianceOverAlpha=!0,Ve._useObjectSpaceNormalMap=!1,Ve._useParallax=!1,Ve._useParallaxOcclusion=!1,Ve._parallaxScaleBias=.05,Ve._disableLighting=!1,Ve._maxSimultaneousLights=4,Ve._invertNormalMapX=!1,Ve._invertNormalMapY=!1,Ve._twoSidedLighting=!1,Ve._alphaCutOff=.4,Ve._forceAlphaTest=!1,Ve._useAlphaFresnel=!1,Ve._useLinearAlphaFresnel=!1,Ve._environmentBRDFTexture=null,Ve._forceIrradianceInFragment=!1,Ve._realTimeFiltering=!1,Ve._realTimeFilteringQuality=8,Ve._forceNormalForward=!1,Ve._enableSpecularAntiAliasing=!1,Ve._imageProcessingObserver=null,Ve._renderTargets=new O.a(16),Ve._globalAmbientColor=new v.a(0,0,0),Ve._useLogarithmicDepth=!1,Ve._unlit=!1,Ve._debugMode=0,Ve.debugMode=0,Ve.debugLimit=-1,Ve.debugFactor=1,Ve.clearCoat=new f.a(Ve._markAllSubMeshesAsTexturesDirty.bind(Ve)),Ve.anisotropy=new d(Ve._markAllSubMeshesAsTexturesDirty.bind(Ve)),Ve.brdf=new g(Ve._markAllSubMeshesAsMiscDirty.bind(Ve)),Ve.sheen=new l(Ve._markAllSubMeshesAsTexturesDirty.bind(Ve)),Ve.detailMap=new cn.a(Ve._markAllSubMeshesAsTexturesDirty.bind(Ve)),Ve._rebuildInParallel=!1,Ve._attachImageProcessingConfiguration(null),Ve.getRenderTargetTextures=function(){return Ve._renderTargets.reset(),h.a.ReflectionTextureEnabled&&Ve._reflectionTexture&&Ve._reflectionTexture.isRenderTarget&&Ve._renderTargets.push(Ve._reflectionTexture),Ve.subSurface.fillRenderTargetTextures(Ve._renderTargets),Ve._renderTargets},Ve._environmentBRDFTexture=M.a.GetEnvironmentBRDFTexture(_e),Ve.subSurface=new E(Ve._markAllSubMeshesAsTexturesDirty.bind(Ve),Ve._markScenePrePassDirty.bind(Ve),_e),Ve.prePassConfiguration=new R.a,Ve}return Object.defineProperty(ye.prototype,"realTimeFiltering",{get:function(){return this._realTimeFiltering},set:function(oe){this._realTimeFiltering=oe,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(ye.prototype,"realTimeFilteringQuality",{get:function(){return this._realTimeFilteringQuality},set:function(oe){this._realTimeFilteringQuality=oe,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(ye.prototype,"canRenderToMRT",{get:function(){return!0},enumerable:!1,configurable:!0}),ye.prototype._attachImageProcessingConfiguration=function(oe){var _e=this;oe!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),oe?this._imageProcessingConfiguration=oe:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){_e._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(ye.prototype,"hasRenderTargetTextures",{get:function(){return h.a.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this.subSurface.hasRenderTargetTextures()},enumerable:!1,configurable:!0}),Object.defineProperty(ye.prototype,"isPrePassCapable",{get:function(){return!0},enumerable:!1,configurable:!0}),ye.prototype.getClassName=function(){return"PBRBaseMaterial"},Object.defineProperty(ye.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(oe){this._useLogarithmicDepth=oe&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!1,configurable:!0}),Object.defineProperty(ye.prototype,"_disableAlphaBlending",{get:function(){return this.subSurface.disableAlphaBlending||this._transparencyMode===ye.PBRMATERIAL_OPAQUE||this._transparencyMode===ye.PBRMATERIAL_ALPHATEST},enumerable:!1,configurable:!0}),ye.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()},ye.prototype.needAlphaTesting=function(){return this._forceAlphaTest?!0:this.subSurface.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===ye.PBRMATERIAL_ALPHATEST)},ye.prototype._shouldUseAlphaFromAlbedoTexture=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==ye.PBRMATERIAL_OPAQUE},ye.prototype._hasAlphaChannel=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null},ye.prototype.getAlphaTestTexture=function(){return this._albedoTexture},ye.prototype.isReadyForSubMesh=function(oe,_e,Ve){if(_e.effect&&this.isFrozen&&_e.effect._wasPreviouslyReady)return!0;_e._materialDefines||(_e._materialDefines=new En);var dt=_e._materialDefines;if(this._isReadyForSubMesh(_e))return!0;var vt=this.getScene(),ut=vt.getEngine();if(dt._areTexturesDirty&&vt.texturesEnabled){if(this._albedoTexture&&h.a.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&h.a.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&h.a.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;var Yt=this._getReflectionTexture();if(Yt&&h.a.ReflectionTextureEnabled&&(!Yt.isReadyOrNotBlocking()||Yt.irradianceTexture&&!Yt.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&h.a.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&h.a.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(h.a.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(ut.getCaps().standardDerivatives&&this._bumpTexture&&h.a.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&h.a.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(!this.subSurface.isReadyForSubMesh(dt,vt)||!this.clearCoat.isReadyForSubMesh(dt,vt,ut,this._disableBumpMap)||!this.sheen.isReadyForSubMesh(dt,vt)||!this.anisotropy.isReadyForSubMesh(dt,vt)||!this.detailMap.isReadyForSubMesh(dt,vt)||dt._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!ut.getCaps().standardDerivatives&&!oe.isVerticesDataPresent(p.b.NormalKind)&&(oe.createNormals(!0),j.a.Warn("PBRMaterial: Normals have been created for the mesh: "+oe.name));var pt=_e.effect,Ye=dt._areLightsDisposed,Pt=this._prepareEffect(oe,dt,this.onCompiled,this.onError,Ve,null,_e.getRenderingMesh().hasThinInstances);if(Pt)if(this._onEffectCreatedObservable&&($r.effect=Pt,$r.subMesh=_e,this._onEffectCreatedObservable.notifyObservers($r)),this.allowShaderHotSwapping&&pt&&!Pt.isReady()){if(Pt=pt,this._rebuildInParallel=!0,dt.markAsUnprocessed(),Ye)return dt._areLightsDisposed=!0,!1}else this._rebuildInParallel=!1,vt.resetCachedMaterial(),_e.setEffect(Pt,dt),this.buildUniformLayout();return!_e.effect||!_e.effect.isReady()?!1:(dt._renderId=vt.getRenderId(),_e.effect._wasPreviouslyReady=!0,!0)},ye.prototype.isMetallicWorkflow=function(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)},ye.prototype._prepareEffect=function(oe,_e,Ve,dt,vt,ut,Yt){if(Ve===void 0&&(Ve=null),dt===void 0&&(dt=null),vt===void 0&&(vt=null),ut===void 0&&(ut=null),this._prepareDefines(oe,_e,vt,ut,Yt),!_e.isDirty)return null;_e.markAsProcessed();var pt=this.getScene(),Ye=pt.getEngine(),Pt=new Nr.a,Ct=0;_e.USESPHERICALINVERTEX&&Pt.addFallback(Ct++,"USESPHERICALINVERTEX"),_e.FOG&&Pt.addFallback(Ct,"FOG"),_e.SPECULARAA&&Pt.addFallback(Ct,"SPECULARAA"),_e.POINTSIZE&&Pt.addFallback(Ct,"POINTSIZE"),_e.LOGARITHMICDEPTH&&Pt.addFallback(Ct,"LOGARITHMICDEPTH"),_e.PARALLAX&&Pt.addFallback(Ct,"PARALLAX"),_e.PARALLAXOCCLUSION&&Pt.addFallback(Ct++,"PARALLAXOCCLUSION"),Ct=d.AddFallbacks(_e,Pt,Ct),Ct=d.AddFallbacks(_e,Pt,Ct),Ct=E.AddFallbacks(_e,Pt,Ct),Ct=l.AddFallbacks(_e,Pt,Ct),_e.ENVIRONMENTBRDF&&Pt.addFallback(Ct++,"ENVIRONMENTBRDF"),_e.TANGENT&&Pt.addFallback(Ct++,"TANGENT"),_e.BUMP&&Pt.addFallback(Ct++,"BUMP"),Ct=m.a.HandleFallbacksForShadows(_e,Pt,this._maxSimultaneousLights,Ct++),_e.SPECULARTERM&&Pt.addFallback(Ct++,"SPECULARTERM"),_e.USESPHERICALFROMREFLECTIONMAP&&Pt.addFallback(Ct++,"USESPHERICALFROMREFLECTIONMAP"),_e.USEIRRADIANCEMAP&&Pt.addFallback(Ct++,"USEIRRADIANCEMAP"),_e.LIGHTMAP&&Pt.addFallback(Ct++,"LIGHTMAP"),_e.NORMAL&&Pt.addFallback(Ct++,"NORMAL"),_e.AMBIENT&&Pt.addFallback(Ct++,"AMBIENT"),_e.EMISSIVE&&Pt.addFallback(Ct++,"EMISSIVE"),_e.VERTEXCOLOR&&Pt.addFallback(Ct++,"VERTEXCOLOR"),_e.MORPHTARGETS&&Pt.addFallback(Ct++,"MORPHTARGETS"),_e.MULTIVIEW&&Pt.addFallback(0,"MULTIVIEW");var ri=[p.b.PositionKind];_e.NORMAL&&ri.push(p.b.NormalKind),_e.TANGENT&&ri.push(p.b.TangentKind),_e.UV1&&ri.push(p.b.UVKind),_e.UV2&&ri.push(p.b.UV2Kind),_e.VERTEXCOLOR&&ri.push(p.b.ColorKind),m.a.PrepareAttributesForBones(ri,oe,_e,Pt),m.a.PrepareAttributesForInstances(ri,_e),m.a.PrepareAttributesForMorphTargets(ri,oe,_e);var _t="pbr",qt=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],mi=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","morphTargets"],wr=["Material","Scene","Mesh"];cn.a.AddUniforms(qt),cn.a.AddSamplers(mi),E.AddUniforms(qt),E.AddSamplers(mi),f.a.AddUniforms(qt),f.a.AddSamplers(mi),d.AddUniforms(qt),d.AddSamplers(mi),l.AddUniforms(qt),l.AddSamplers(mi),R.a.AddUniforms(qt),R.a.AddSamplers(qt),F.a&&(F.a.PrepareUniforms(qt,_e),F.a.PrepareSamplers(mi,_e)),m.a.PrepareUniformsAndSamplersList({uniformsNames:qt,uniformBuffersNames:wr,samplers:mi,defines:_e,maxSimultaneousLights:this._maxSimultaneousLights});var Ri={};this.customShaderNameResolve&&(_t=this.customShaderNameResolve(_t,qt,wr,mi,_e,ri,Ri));var Pn=_e.toString();return Ye.createEffect(_t,{attributes:ri,uniformsNames:qt,uniformBuffersNames:wr,samplers:mi,defines:Pn,fallbacks:Pt,onCompiled:Ve,onError:dt,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:_e.NUM_MORPH_INFLUENCERS},processFinalCode:Ri.processFinalCode,multiTarget:_e.PREPASS},Ye)},ye.prototype._prepareDefines=function(oe,_e,Ve,dt,vt){Ve===void 0&&(Ve=null),dt===void 0&&(dt=null),vt===void 0&&(vt=!1);var ut=this.getScene(),Yt=ut.getEngine();if(m.a.PrepareDefinesForLights(ut,oe,_e,!0,this._maxSimultaneousLights,this._disableLighting),_e._needNormals=!0,m.a.PrepareDefinesForMultiview(ut,_e),m.a.PrepareDefinesForPrePass(ut,_e,this.canRenderToMRT),_e.METALLICWORKFLOW=this.isMetallicWorkflow(),_e._areTexturesDirty){if(_e._needUVs=!1,ut.texturesEnabled){ut.getEngine().getCaps().textureLOD&&(_e.LODBASEDMICROSFURACE=!0),this._albedoTexture&&h.a.DiffuseTextureEnabled?(m.a.PrepareDefinesForMergedUV(this._albedoTexture,_e,"ALBEDO"),_e.GAMMAALBEDO=this._albedoTexture.gammaSpace):_e.ALBEDO=!1,this._ambientTexture&&h.a.AmbientTextureEnabled?(m.a.PrepareDefinesForMergedUV(this._ambientTexture,_e,"AMBIENT"),_e.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):_e.AMBIENT=!1,this._opacityTexture&&h.a.OpacityTextureEnabled?(m.a.PrepareDefinesForMergedUV(this._opacityTexture,_e,"OPACITY"),_e.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):_e.OPACITY=!1;var pt=this._getReflectionTexture();if(pt&&h.a.ReflectionTextureEnabled){switch(_e.REFLECTION=!0,_e.GAMMAREFLECTION=pt.gammaSpace,_e.RGBDREFLECTION=pt.isRGBD,_e.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!pt.invertZ:pt.invertZ,_e.LODINREFLECTIONALPHA=pt.lodLevelInAlpha,_e.LINEARSPECULARREFLECTION=pt.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(_e.NUM_SAMPLES=""+this.realTimeFilteringQuality,Yt._features.needTypeSuffixInShaderConstants&&(_e.NUM_SAMPLES=_e.NUM_SAMPLES+"u"),_e.REALTIME_FILTERING=!0):_e.REALTIME_FILTERING=!1,pt.coordinatesMode===k.a.INVCUBIC_MODE&&(_e.INVERTCUBICMAP=!0),_e.REFLECTIONMAP_3D=pt.isCube,_e.REFLECTIONMAP_CUBIC=!1,_e.REFLECTIONMAP_EXPLICIT=!1,_e.REFLECTIONMAP_PLANAR=!1,_e.REFLECTIONMAP_PROJECTION=!1,_e.REFLECTIONMAP_SKYBOX=!1,_e.REFLECTIONMAP_SPHERICAL=!1,_e.REFLECTIONMAP_EQUIRECTANGULAR=!1,_e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,_e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,pt.coordinatesMode){case k.a.EXPLICIT_MODE:_e.REFLECTIONMAP_EXPLICIT=!0;break;case k.a.PLANAR_MODE:_e.REFLECTIONMAP_PLANAR=!0;break;case k.a.PROJECTION_MODE:_e.REFLECTIONMAP_PROJECTION=!0;break;case k.a.SKYBOX_MODE:_e.REFLECTIONMAP_SKYBOX=!0;break;case k.a.SPHERICAL_MODE:_e.REFLECTIONMAP_SPHERICAL=!0;break;case k.a.EQUIRECTANGULAR_MODE:_e.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case k.a.FIXED_EQUIRECTANGULAR_MODE:_e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case k.a.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:_e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case k.a.CUBIC_MODE:case k.a.INVCUBIC_MODE:default:_e.REFLECTIONMAP_CUBIC=!0,_e.USE_LOCAL_REFLECTIONMAP_CUBIC=!!pt.boundingBoxSize;break}pt.coordinatesMode!==k.a.SKYBOX_MODE&&(pt.irradianceTexture?(_e.USEIRRADIANCEMAP=!0,_e.USESPHERICALFROMREFLECTIONMAP=!1):pt.isCube&&(_e.USESPHERICALFROMREFLECTIONMAP=!0,_e.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||ut.getEngine().getCaps().maxVaryingVectors<=8?_e.USESPHERICALINVERTEX=!1:_e.USESPHERICALINVERTEX=!0))}else _e.REFLECTION=!1,_e.REFLECTIONMAP_3D=!1,_e.REFLECTIONMAP_SPHERICAL=!1,_e.REFLECTIONMAP_PLANAR=!1,_e.REFLECTIONMAP_CUBIC=!1,_e.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,_e.REFLECTIONMAP_PROJECTION=!1,_e.REFLECTIONMAP_SKYBOX=!1,_e.REFLECTIONMAP_EXPLICIT=!1,_e.REFLECTIONMAP_EQUIRECTANGULAR=!1,_e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,_e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,_e.INVERTCUBICMAP=!1,_e.USESPHERICALFROMREFLECTIONMAP=!1,_e.USEIRRADIANCEMAP=!1,_e.USESPHERICALINVERTEX=!1,_e.REFLECTIONMAP_OPPOSITEZ=!1,_e.LODINREFLECTIONALPHA=!1,_e.GAMMAREFLECTION=!1,_e.RGBDREFLECTION=!1,_e.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&h.a.LightmapTextureEnabled?(m.a.PrepareDefinesForMergedUV(this._lightmapTexture,_e,"LIGHTMAP"),_e.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,_e.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,_e.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):_e.LIGHTMAP=!1,this._emissiveTexture&&h.a.EmissiveTextureEnabled?m.a.PrepareDefinesForMergedUV(this._emissiveTexture,_e,"EMISSIVE"):_e.EMISSIVE=!1,h.a.SpecularTextureEnabled?(this._metallicTexture?(m.a.PrepareDefinesForMergedUV(this._metallicTexture,_e,"REFLECTIVITY"),_e.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,_e.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,_e.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,_e.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed):this._reflectivityTexture?(m.a.PrepareDefinesForMergedUV(this._reflectivityTexture,_e,"REFLECTIVITY"),_e.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,_e.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap):_e.REFLECTIVITY=!1,this._metallicReflectanceTexture?m.a.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,_e,"METALLIC_REFLECTANCE"):_e.METALLIC_REFLECTANCE=!1,this._microSurfaceTexture?m.a.PrepareDefinesForMergedUV(this._microSurfaceTexture,_e,"MICROSURFACEMAP"):_e.MICROSURFACEMAP=!1):(_e.REFLECTIVITY=!1,_e.MICROSURFACEMAP=!1),ut.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&h.a.BumpTextureEnabled&&!this._disableBumpMap?(m.a.PrepareDefinesForMergedUV(this._bumpTexture,_e,"BUMP"),this._useParallax&&this._albedoTexture&&h.a.DiffuseTextureEnabled?(_e.PARALLAX=!0,_e.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):_e.PARALLAX=!1,_e.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):_e.BUMP=!1,this._environmentBRDFTexture&&h.a.ReflectionTextureEnabled?(_e.ENVIRONMENTBRDF=!0,_e.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(_e.ENVIRONMENTBRDF=!1,_e.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?_e.ALPHAFROMALBEDO=!0:_e.ALPHAFROMALBEDO=!1}_e.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===ye.LIGHTFALLOFF_STANDARD?(_e.USEPHYSICALLIGHTFALLOFF=!1,_e.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===ye.LIGHTFALLOFF_GLTF?(_e.USEPHYSICALLIGHTFALLOFF=!1,_e.USEGLTFLIGHTFALLOFF=!0):(_e.USEPHYSICALLIGHTFALLOFF=!0,_e.USEGLTFLIGHTFALLOFF=!1),_e.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?_e.TWOSIDEDLIGHTING=!0:_e.TWOSIDEDLIGHTING=!1,_e.SPECULARAA=ut.getEngine().getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(_e._areTexturesDirty||_e._areMiscDirty)&&(_e.ALPHATESTVALUE=""+this._alphaCutOff+(this._alphaCutOff%1==0?".":""),_e.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,_e.ALPHABLEND=this.needAlphaBlendingForMesh(oe),_e.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,_e.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),_e._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(_e),_e.FORCENORMALFORWARD=this._forceNormalForward,_e.RADIANCEOCCLUSION=this._useRadianceOcclusion,_e.HORIZONOCCLUSION=this._useHorizonOcclusion,_e._areMiscDirty&&(m.a.PrepareDefinesForMisc(oe,ut,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(oe)||this._forceAlphaTest,_e),_e.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!oe.isVerticesDataPresent(p.b.NormalKind),_e.DEBUGMODE=this._debugMode),this.detailMap.prepareDefines(_e,ut),this.subSurface.prepareDefines(_e,ut),this.clearCoat.prepareDefines(_e,ut),this.anisotropy.prepareDefines(_e,oe,ut),this.brdf.prepareDefines(_e),this.sheen.prepareDefines(_e,ut),m.a.PrepareDefinesForFrameBoundValues(ut,Yt,_e,!!Ve,dt,vt),m.a.PrepareDefinesForAttributes(oe,_e,!0,!0,!0,this._transparencyMode!==ye.PBRMATERIAL_OPAQUE)},ye.prototype.forceCompilation=function(oe,_e,Ve){var dt=this,vt=Object(T.a)({clipPlane:!1,useInstances:!1},Ve),ut=new En,Yt=this._prepareEffect(oe,ut,void 0,void 0,vt.useInstances,vt.clipPlane,oe.hasThinInstances);this._onEffectCreatedObservable&&($r.effect=Yt,$r.subMesh=null,this._onEffectCreatedObservable.notifyObservers($r)),Yt.isReady()?_e&&_e(this):Yt.onCompileObservable.add(function(){_e&&_e(dt)})},ye.prototype.buildUniformLayout=function(){var oe=this._uniformBuffer;oe.addUniform("vAlbedoInfos",2),oe.addUniform("vAmbientInfos",4),oe.addUniform("vOpacityInfos",2),oe.addUniform("vEmissiveInfos",2),oe.addUniform("vLightmapInfos",2),oe.addUniform("vReflectivityInfos",3),oe.addUniform("vMicroSurfaceSamplerInfos",2),oe.addUniform("vReflectionInfos",2),oe.addUniform("vReflectionFilteringInfo",2),oe.addUniform("vReflectionPosition",3),oe.addUniform("vReflectionSize",3),oe.addUniform("vBumpInfos",3),oe.addUniform("albedoMatrix",16),oe.addUniform("ambientMatrix",16),oe.addUniform("opacityMatrix",16),oe.addUniform("emissiveMatrix",16),oe.addUniform("lightmapMatrix",16),oe.addUniform("reflectivityMatrix",16),oe.addUniform("microSurfaceSamplerMatrix",16),oe.addUniform("bumpMatrix",16),oe.addUniform("vTangentSpaceParams",2),oe.addUniform("reflectionMatrix",16),oe.addUniform("vReflectionColor",3),oe.addUniform("vAlbedoColor",4),oe.addUniform("vLightingIntensity",4),oe.addUniform("vReflectionMicrosurfaceInfos",3),oe.addUniform("pointSize",1),oe.addUniform("vReflectivityColor",4),oe.addUniform("vEmissiveColor",3),oe.addUniform("vAmbientColor",3),oe.addUniform("vDebugMode",2),oe.addUniform("vMetallicReflectanceFactors",4),oe.addUniform("vMetallicReflectanceInfos",2),oe.addUniform("metallicReflectanceMatrix",16),f.a.PrepareUniformBuffer(oe),d.PrepareUniformBuffer(oe),l.PrepareUniformBuffer(oe),E.PrepareUniformBuffer(oe),cn.a.PrepareUniformBuffer(oe),oe.addUniform("vSphericalL00",3),oe.addUniform("vSphericalL1_1",3),oe.addUniform("vSphericalL10",3),oe.addUniform("vSphericalL11",3),oe.addUniform("vSphericalL2_2",3),oe.addUniform("vSphericalL2_1",3),oe.addUniform("vSphericalL20",3),oe.addUniform("vSphericalL21",3),oe.addUniform("vSphericalL22",3),oe.addUniform("vSphericalX",3),oe.addUniform("vSphericalY",3),oe.addUniform("vSphericalZ",3),oe.addUniform("vSphericalXX_ZZ",3),oe.addUniform("vSphericalYY_ZZ",3),oe.addUniform("vSphericalZZ",3),oe.addUniform("vSphericalXY",3),oe.addUniform("vSphericalYZ",3),oe.addUniform("vSphericalZX",3),oe.create()},ye.prototype.unbind=function(){if(this._activeEffect){var oe=!1;this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&(this._activeEffect.setTexture("reflection2DSampler",null),oe=!0),this.subSurface.unbind(this._activeEffect)&&(oe=!0),oe&&this._markAllSubMeshesAsTexturesDirty()}We.prototype.unbind.call(this)},ye.prototype.bindForSubMesh=function(oe,_e,Ve){var dt=this.getScene(),vt=Ve._materialDefines;if(!!vt){var ut=Ve.effect;if(!!ut){this._activeEffect=ut,_e.getMeshUniformBuffer().bindToEffect(ut,"Mesh"),_e.transferToEffect(oe),this.prePassConfiguration.bindForSubMesh(this._activeEffect,dt,_e,oe,this.isFrozen),vt.OBJECTSPACE_NORMALMAP&&(oe.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var Yt=this._mustRebind(dt,ut,_e.visibility);m.a.BindBonesParameters(_e,this._activeEffect,this.prePassConfiguration);var pt=null,Ye=this._uniformBuffer;if(Yt){var Pt=dt.getEngine();if(Ye.bindToEffect(ut,"Material"),this.bindViewProjection(ut),pt=this._getReflectionTexture(),!Ye.useUbo||!this.isFrozen||!Ye.isSync){if(dt.texturesEnabled){if(this._albedoTexture&&h.a.DiffuseTextureEnabled&&(Ye.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),m.a.BindTextureMatrix(this._albedoTexture,Ye,"albedo")),this._ambientTexture&&h.a.AmbientTextureEnabled&&(Ye.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),m.a.BindTextureMatrix(this._ambientTexture,Ye,"ambient")),this._opacityTexture&&h.a.OpacityTextureEnabled&&(Ye.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),m.a.BindTextureMatrix(this._opacityTexture,Ye,"opacity")),pt&&h.a.ReflectionTextureEnabled){if(Ye.updateMatrix("reflectionMatrix",pt.getReflectionTextureMatrix()),Ye.updateFloat2("vReflectionInfos",pt.level,0),pt.boundingBoxSize){var Ct=pt;Ye.updateVector3("vReflectionPosition",Ct.boundingBoxPosition),Ye.updateVector3("vReflectionSize",Ct.boundingBoxSize)}if(this.realTimeFiltering){var ri=pt.getSize().width;Ye.updateFloat2("vReflectionFilteringInfo",ri,y.a.Log2(ri))}if(!vt.USEIRRADIANCEMAP){var _t=pt.sphericalPolynomial;if(vt.USESPHERICALFROMREFLECTIONMAP&&_t)if(vt.SPHERICAL_HARMONICS){var qt=_t.preScaledHarmonics;Ye.updateVector3("vSphericalL00",qt.l00),Ye.updateVector3("vSphericalL1_1",qt.l1_1),Ye.updateVector3("vSphericalL10",qt.l10),Ye.updateVector3("vSphericalL11",qt.l11),Ye.updateVector3("vSphericalL2_2",qt.l2_2),Ye.updateVector3("vSphericalL2_1",qt.l2_1),Ye.updateVector3("vSphericalL20",qt.l20),Ye.updateVector3("vSphericalL21",qt.l21),Ye.updateVector3("vSphericalL22",qt.l22)}else Ye.updateFloat3("vSphericalX",_t.x.x,_t.x.y,_t.x.z),Ye.updateFloat3("vSphericalY",_t.y.x,_t.y.y,_t.y.z),Ye.updateFloat3("vSphericalZ",_t.z.x,_t.z.y,_t.z.z),Ye.updateFloat3("vSphericalXX_ZZ",_t.xx.x-_t.zz.x,_t.xx.y-_t.zz.y,_t.xx.z-_t.zz.z),Ye.updateFloat3("vSphericalYY_ZZ",_t.yy.x-_t.zz.x,_t.yy.y-_t.zz.y,_t.yy.z-_t.zz.z),Ye.updateFloat3("vSphericalZZ",_t.zz.x,_t.zz.y,_t.zz.z),Ye.updateFloat3("vSphericalXY",_t.xy.x,_t.xy.y,_t.xy.z),Ye.updateFloat3("vSphericalYZ",_t.yz.x,_t.yz.y,_t.yz.z),Ye.updateFloat3("vSphericalZX",_t.zx.x,_t.zx.y,_t.zx.z)}Ye.updateFloat3("vReflectionMicrosurfaceInfos",pt.getSize().width,pt.lodGenerationScale,pt.lodGenerationOffset)}this._emissiveTexture&&h.a.EmissiveTextureEnabled&&(Ye.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),m.a.BindTextureMatrix(this._emissiveTexture,Ye,"emissive")),this._lightmapTexture&&h.a.LightmapTextureEnabled&&(Ye.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),m.a.BindTextureMatrix(this._lightmapTexture,Ye,"lightmap")),h.a.SpecularTextureEnabled&&(this._metallicTexture?(Ye.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),m.a.BindTextureMatrix(this._metallicTexture,Ye,"reflectivity")):this._reflectivityTexture&&(Ye.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),m.a.BindTextureMatrix(this._reflectivityTexture,Ye,"reflectivity")),this._metallicReflectanceTexture&&(Ye.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),m.a.BindTextureMatrix(this._metallicReflectanceTexture,Ye,"metallicReflectance")),this._microSurfaceTexture&&(Ye.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),m.a.BindTextureMatrix(this._microSurfaceTexture,Ye,"microSurfaceSampler"))),this._bumpTexture&&Pt.getCaps().standardDerivatives&&h.a.BumpTextureEnabled&&!this._disableBumpMap&&(Ye.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),m.a.BindTextureMatrix(this._bumpTexture,Ye,"bump"),dt._mirroredCameraPosition?Ye.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):Ye.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&Ye.updateFloat("pointSize",this.pointSize),vt.METALLICWORKFLOW){v.c.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,v.c.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,Ye.updateColor4("vReflectivityColor",v.c.Color3[0],1);var mi=this.subSurface.indexOfRefraction,wr=1,Ri=Math.pow((mi-wr)/(mi+wr),2);this._metallicReflectanceColor.scaleToRef(Ri*this._metallicF0Factor,v.c.Color3[0]);var Pn=this._metallicF0Factor;Ye.updateColor4("vMetallicReflectanceFactors",v.c.Color3[0],Pn)}else Ye.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);Ye.updateColor3("vEmissiveColor",h.a.EmissiveTextureEnabled?this._emissiveColor:v.a.BlackReadOnly),Ye.updateColor3("vReflectionColor",this._reflectionColor),!vt.SS_REFRACTION&&this.subSurface.linkRefractionWithTransparency?Ye.updateColor4("vAlbedoColor",this._albedoColor,1):Ye.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*dt.environmentIntensity,this._lightingInfos.w=this._specularIntensity,Ye.updateVector4("vLightingIntensity",this._lightingInfos),dt.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),Ye.updateColor3("vAmbientColor",this._globalAmbientColor),Ye.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}dt.texturesEnabled&&(this._albedoTexture&&h.a.DiffuseTextureEnabled&&Ye.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&h.a.AmbientTextureEnabled&&Ye.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&h.a.OpacityTextureEnabled&&Ye.setTexture("opacitySampler",this._opacityTexture),pt&&h.a.ReflectionTextureEnabled&&(vt.LODBASEDMICROSFURACE?Ye.setTexture("reflectionSampler",pt):(Ye.setTexture("reflectionSampler",pt._lodTextureMid||pt),Ye.setTexture("reflectionSamplerLow",pt._lodTextureLow||pt),Ye.setTexture("reflectionSamplerHigh",pt._lodTextureHigh||pt)),vt.USEIRRADIANCEMAP&&Ye.setTexture("irradianceSampler",pt.irradianceTexture)),vt.ENVIRONMENTBRDF&&Ye.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&h.a.EmissiveTextureEnabled&&Ye.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&h.a.LightmapTextureEnabled&&Ye.setTexture("lightmapSampler",this._lightmapTexture),h.a.SpecularTextureEnabled&&(this._metallicTexture?Ye.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&Ye.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&Ye.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._microSurfaceTexture&&Ye.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&Pt.getCaps().standardDerivatives&&h.a.BumpTextureEnabled&&!this._disableBumpMap&&Ye.setTexture("bumpSampler",this._bumpTexture)),this.detailMap.bindForSubMesh(Ye,dt,this.isFrozen),this.subSurface.bindForSubMesh(Ye,dt,Pt,this.isFrozen,vt.LODBASEDMICROSFURACE,this.realTimeFiltering),this.clearCoat.bindForSubMesh(Ye,dt,Pt,this._disableBumpMap,this.isFrozen,this._invertNormalMapX,this._invertNormalMapY,Ve),this.anisotropy.bindForSubMesh(Ye,dt,this.isFrozen),this.sheen.bindForSubMesh(Ye,dt,this.isFrozen,Ve),m.a.BindClipPlane(this._activeEffect,dt),this.bindEyePosition(ut)}(Yt||!this.isFrozen)&&(dt.lightsEnabled&&!this._disableLighting&&m.a.BindLights(dt,_e,this._activeEffect,vt,this._maxSimultaneousLights,this._rebuildInParallel),(dt.fogEnabled&&_e.applyFog&&dt.fogMode!==H.a.FOGMODE_NONE||pt)&&this.bindView(ut),m.a.BindFogParameters(dt,_e,this._activeEffect,!0),vt.NUM_MORPH_INFLUENCERS&&m.a.BindMorphTargetParameters(_e,this._activeEffect),this._imageProcessingConfiguration.bind(this._activeEffect),m.a.BindLogDepth(vt,this._activeEffect,dt)),this._afterBind(_e,this._activeEffect),Ye.update()}}},ye.prototype.getAnimatables=function(){var oe=[];return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&oe.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&oe.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&oe.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&oe.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&oe.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?oe.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&oe.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&oe.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&oe.push(this._lightmapTexture),this.detailMap.getAnimatables(oe),this.subSurface.getAnimatables(oe),this.clearCoat.getAnimatables(oe),this.sheen.getAnimatables(oe),this.anisotropy.getAnimatables(oe),oe},ye.prototype._getReflectionTexture=function(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture},ye.prototype.getActiveTextures=function(){var oe=We.prototype.getActiveTextures.call(this);return this._albedoTexture&&oe.push(this._albedoTexture),this._ambientTexture&&oe.push(this._ambientTexture),this._opacityTexture&&oe.push(this._opacityTexture),this._reflectionTexture&&oe.push(this._reflectionTexture),this._emissiveTexture&&oe.push(this._emissiveTexture),this._reflectivityTexture&&oe.push(this._reflectivityTexture),this._metallicTexture&&oe.push(this._metallicTexture),this._metallicReflectanceTexture&&oe.push(this._metallicReflectanceTexture),this._microSurfaceTexture&&oe.push(this._microSurfaceTexture),this._bumpTexture&&oe.push(this._bumpTexture),this._lightmapTexture&&oe.push(this._lightmapTexture),this.detailMap.getActiveTextures(oe),this.subSurface.getActiveTextures(oe),this.clearCoat.getActiveTextures(oe),this.sheen.getActiveTextures(oe),this.anisotropy.getActiveTextures(oe),oe},ye.prototype.hasTexture=function(oe){return We.prototype.hasTexture.call(this,oe)||this._albedoTexture===oe||this._ambientTexture===oe||this._opacityTexture===oe||this._reflectionTexture===oe||this._reflectivityTexture===oe||this._metallicTexture===oe||this._metallicReflectanceTexture===oe||this._microSurfaceTexture===oe||this._bumpTexture===oe||this._lightmapTexture===oe?!0:this.detailMap.hasTexture(oe)||this.subSurface.hasTexture(oe)||this.clearCoat.hasTexture(oe)||this.sheen.hasTexture(oe)||this.anisotropy.hasTexture(oe)},ye.prototype.setPrePassRenderer=function(oe){if(this.subSurface.isScatteringEnabled){var _e=this.getScene().enableSubSurfaceForPrePass();return _e&&(_e.enabled=!0),!0}return!1},ye.prototype.dispose=function(oe,_e){var Ve,dt,vt,ut,Yt,pt,Ye,Pt,Ct,ri,_t;_e&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(Ve=this._albedoTexture)===null||Ve===void 0||Ve.dispose(),(dt=this._ambientTexture)===null||dt===void 0||dt.dispose(),(vt=this._opacityTexture)===null||vt===void 0||vt.dispose(),(ut=this._reflectionTexture)===null||ut===void 0||ut.dispose(),(Yt=this._emissiveTexture)===null||Yt===void 0||Yt.dispose(),(pt=this._metallicTexture)===null||pt===void 0||pt.dispose(),(Ye=this._reflectivityTexture)===null||Ye===void 0||Ye.dispose(),(Pt=this._bumpTexture)===null||Pt===void 0||Pt.dispose(),(Ct=this._lightmapTexture)===null||Ct===void 0||Ct.dispose(),(ri=this._metallicReflectanceTexture)===null||ri===void 0||ri.dispose(),(_t=this._microSurfaceTexture)===null||_t===void 0||_t.dispose()),this.detailMap.dispose(_e),this.subSurface.dispose(_e),this.clearCoat.dispose(_e),this.sheen.dispose(_e),this.anisotropy.dispose(_e),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),We.prototype.dispose.call(this,oe,_e)},ye.PBRMATERIAL_OPAQUE=B.a.MATERIAL_OPAQUE,ye.PBRMATERIAL_ALPHATEST=B.a.MATERIAL_ALPHATEST,ye.PBRMATERIAL_ALPHABLEND=B.a.MATERIAL_ALPHABLEND,ye.PBRMATERIAL_ALPHATESTANDBLEND=B.a.MATERIAL_ALPHATESTANDBLEND,ye.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,ye.LIGHTFALLOFF_PHYSICAL=0,ye.LIGHTFALLOFF_GLTF=1,ye.LIGHTFALLOFF_STANDARD=2,Object(T.c)([Object(S.i)()],ye.prototype,"_imageProcessingConfiguration",void 0),Object(T.c)([Object(S.b)("_markAllSubMeshesAsMiscDirty")],ye.prototype,"debugMode",void 0),Object(T.c)([Object(S.c)()],ye.prototype,"useLogarithmicDepth",null),ye}(I.a)},530:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(483),S=u(572),j=u(438),O=u(449),M=u(436),H=u(589),A=u(542),p=function(){function f(h,m,d,g,v,l,y,E,R,F){d===void 0&&(d=0),g===void 0&&(g=100),v===void 0&&(v=!1),l===void 0&&(l=1),F===void 0&&(F=!1),this.target=m,this.fromFrame=d,this.toFrame=g,this.loopAnimation=v,this.onAnimationEnd=y,this.onAnimationLoop=R,this.isAdditive=F,this._localDelayOffset=null,this._pausedDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new j.c,this.onAnimationLoopObservable=new j.c,this._scene=h,E&&this.appendAnimations(m,E),this._speedRatio=l,h._activeAnimatables.push(this)}return Object.defineProperty(f.prototype,"syncRoot",{get:function(){return this._syncRoot},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"masterFrame",{get:function(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"weight",{get:function(){return this._weight},set:function(h){if(h===-1){this._weight=-1;return}this._weight=Math.min(Math.max(h,0),1)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(h){for(var m=0;m<this._runtimeAnimations.length;m++){var d=this._runtimeAnimations[m];d._prepareForSpeedRatioChange(h)}this._speedRatio=h},enumerable:!1,configurable:!0}),f.prototype.syncWith=function(h){if(this._syncRoot=h,h){var m=this._scene._activeAnimatables.indexOf(this);m>-1&&(this._scene._activeAnimatables.splice(m,1),this._scene._activeAnimatables.push(this))}return this},f.prototype.getAnimations=function(){return this._runtimeAnimations},f.prototype.appendAnimations=function(h,m){for(var d=this,g=0;g<m.length;g++){var v=m[g],l=new S.a(h,v,this._scene,this);l._onLoop=function(){d.onAnimationLoopObservable.notifyObservers(d),d.onAnimationLoop&&d.onAnimationLoop()},this._runtimeAnimations.push(l)}},f.prototype.getAnimationByTargetProperty=function(h){for(var m=this._runtimeAnimations,d=0;d<m.length;d++)if(m[d].animation.targetProperty===h)return m[d].animation;return null},f.prototype.getRuntimeAnimationByTargetProperty=function(h){for(var m=this._runtimeAnimations,d=0;d<m.length;d++)if(m[d].animation.targetProperty===h)return m[d];return null},f.prototype.reset=function(){for(var h=this._runtimeAnimations,m=0;m<h.length;m++)h[m].reset(!0);this._localDelayOffset=null,this._pausedDelay=null},f.prototype.enableBlending=function(h){for(var m=this._runtimeAnimations,d=0;d<m.length;d++)m[d].animation.enableBlending=!0,m[d].animation.blendingSpeed=h},f.prototype.disableBlending=function(){for(var h=this._runtimeAnimations,m=0;m<h.length;m++)h[m].animation.enableBlending=!1},f.prototype.goToFrame=function(h){var m=this._runtimeAnimations;if(m[0]){var d=m[0].animation.framePerSecond,g=m[0].currentFrame,v=this.speedRatio===0?0:(h-g)/d*1e3/this.speedRatio;this._localDelayOffset===null&&(this._localDelayOffset=0),this._localDelayOffset-=v}for(var l=0;l<m.length;l++)m[l].goToFrame(h)},f.prototype.pause=function(){this._paused||(this._paused=!0)},f.prototype.restart=function(){this._paused=!1},f.prototype._raiseOnAnimationEnd=function(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)},f.prototype.stop=function(h,m){if(h||m){var d=this._scene._activeAnimatables.indexOf(this);if(d>-1){for(var g=this._runtimeAnimations,v=g.length-1;v>=0;v--){var l=g[v];h&&l.animation.name!=h||m&&!m(l.target)||(l.dispose(),g.splice(v,1))}g.length==0&&(this._scene._activeAnimatables.splice(d,1),this._raiseOnAnimationEnd())}}else{var v=this._scene._activeAnimatables.indexOf(this);if(v>-1){this._scene._activeAnimatables.splice(v,1);for(var g=this._runtimeAnimations,v=0;v<g.length;v++)g[v].dispose();this._raiseOnAnimationEnd()}}},f.prototype.waitAsync=function(){var h=this;return new Promise(function(m,d){h.onAnimationEndObservable.add(function(){m(h)},void 0,void 0,h,!0)})},f.prototype._animate=function(h){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=h),!0;if(this._localDelayOffset===null?(this._localDelayOffset=h,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=h-this._pausedDelay,this._pausedDelay=null),this._weight===0)return!0;var m=!1,d=this._runtimeAnimations,g;for(g=0;g<d.length;g++){var v=d[g],l=v.animate(h-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);m=m||l}if(this.animationStarted=m,!m){if(this.disposeOnEnd)for(g=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(g,1),g=0;g<d.length;g++)d[g].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return m},f}();O.a.prototype._animate=function(){if(!!this.animationsEnabled){var f=H.a.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=f}this.deltaTime=this.useConstantAnimationDeltaTime?16:(f-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=f;var h=this._activeAnimatables;if(h.length!==0){this._animationTime+=this.deltaTime;for(var m=this._animationTime,d=0;d<h.length;d++){var g=h[d];!g._animate(m)&&g.disposeOnEnd&&d--}this._processLateAnimationBindings()}}},O.a.prototype.beginWeightedAnimation=function(f,h,m,d,g,v,l,y,E,R,F){d===void 0&&(d=1),v===void 0&&(v=1),F===void 0&&(F=!1);var B=this.beginAnimation(f,h,m,g,v,l,y,!1,E,R,F);return B.weight=d,B},O.a.prototype.beginAnimation=function(f,h,m,d,g,v,l,y,E,R,F){g===void 0&&(g=1),y===void 0&&(y=!0),F===void 0&&(F=!1),h>m&&g>0&&(g*=-1),y&&this.stopAnimation(f,void 0,E),l||(l=new p(this,f,h,m,d,g,v,void 0,R,F));var B=E?E(f):!0;if(f.animations&&B&&l.appendAnimations(f,f.animations),f.getAnimatables)for(var L=f.getAnimatables(),I=0;I<L.length;I++)this.beginAnimation(L[I],h,m,d,g,v,l,y,E,R);return l.reset(),l},O.a.prototype.beginHierarchyAnimation=function(f,h,m,d,g,v,l,y,E,R,F,B){v===void 0&&(v=1),E===void 0&&(E=!0),B===void 0&&(B=!1);var L=f.getDescendants(h),I=[];I.push(this.beginAnimation(f,m,d,g,v,l,y,E,R,void 0,B));for(var k=0,Z=L;k<Z.length;k++){var Y=Z[k];I.push(this.beginAnimation(Y,m,d,g,v,l,y,E,R,void 0,B))}return I},O.a.prototype.beginDirectAnimation=function(f,h,m,d,g,v,l,y,E){E===void 0&&(E=!1),v===void 0&&(v=1),m>d&&v>0&&(v*=-1);var R=new p(this,f,m,d,g,v,l,h,y,E);return R},O.a.prototype.beginDirectHierarchyAnimation=function(f,h,m,d,g,v,l,y,E,R){R===void 0&&(R=!1);var F=f.getDescendants(h),B=[];B.push(this.beginDirectAnimation(f,m,d,g,v,l,y,E,R));for(var L=0,I=F;L<I.length;L++){var k=I[L];B.push(this.beginDirectAnimation(k,m,d,g,v,l,y,E,R))}return B},O.a.prototype.getAnimatableByTarget=function(f){for(var h=0;h<this._activeAnimatables.length;h++)if(this._activeAnimatables[h].target===f)return this._activeAnimatables[h];return null},O.a.prototype.getAllAnimatablesByTarget=function(f){for(var h=[],m=0;m<this._activeAnimatables.length;m++)this._activeAnimatables[m].target===f&&h.push(this._activeAnimatables[m]);return h},O.a.prototype.stopAnimation=function(f,h,m){for(var d=this.getAllAnimatablesByTarget(f),g=0,v=d;g<v.length;g++){var l=v[g];l.stop(h,m)}},O.a.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(var f=0;f<this._activeAnimatables.length;f++)this._activeAnimatables[f].stop();this._activeAnimatables=[]}for(var h=0,m=this.animationGroups;h<m.length;h++){var d=m[h];d.stop()}},O.a.prototype._registerTargetForLateAnimationBinding=function(f,h){var m=f.target;this._registeredForLateAnimationBindings.pushNoDuplicate(m),m._lateAnimationHolders||(m._lateAnimationHolders={}),m._lateAnimationHolders[f.targetPath]||(m._lateAnimationHolders[f.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:h}),f.isAdditive?(m._lateAnimationHolders[f.targetPath].additiveAnimations.push(f),m._lateAnimationHolders[f.targetPath].totalAdditiveWeight+=f.weight):(m._lateAnimationHolders[f.targetPath].animations.push(f),m._lateAnimationHolders[f.targetPath].totalWeight+=f.weight)},O.a.prototype._processLateAnimationBindingsForMatrices=function(f){if(f.totalWeight===0&&f.totalAdditiveWeight===0)return f.originalValue;var h=1,m=M.c.Vector3[0],d=M.c.Vector3[1],g=M.c.Quaternion[0],v=0,l=f.animations[0],y=f.originalValue,E=1,R=!1;if(f.totalWeight<1)E=1-f.totalWeight,y.decompose(d,g,m);else{if(v=1,h=f.totalWeight,E=l.weight/h,E==1)if(f.totalAdditiveWeight)R=!0;else return l.currentValue;l.currentValue.decompose(d,g,m)}if(!R){d.scaleInPlace(E),m.scaleInPlace(E),g.scaleInPlace(E);for(var F=v;F<f.animations.length;F++){var B=f.animations[F];if(B.weight!==0){var E=B.weight/h,L=M.c.Vector3[2],I=M.c.Vector3[3],k=M.c.Quaternion[1];B.currentValue.decompose(I,k,L),I.scaleAndAddToRef(E,d),k.scaleAndAddToRef(E,g),L.scaleAndAddToRef(E,m)}}}for(var Z=0;Z<f.additiveAnimations.length;Z++){var B=f.additiveAnimations[Z];if(B.weight!==0){var L=M.c.Vector3[2],I=M.c.Vector3[3],k=M.c.Quaternion[1];B.currentValue.decompose(I,k,L),I.multiplyToRef(d,I),M.e.LerpToRef(d,I,B.weight,d),g.multiplyToRef(k,k),M.b.SlerpToRef(g,k,B.weight,g),L.scaleAndAddToRef(B.weight,m)}}var Y=l?l._animationState.workValue:M.c.Matrix[0].clone();return M.a.ComposeToRef(d,g,m,Y),Y},O.a.prototype._processLateAnimationBindingsForQuaternions=function(f,h){if(f.totalWeight===0&&f.totalAdditiveWeight===0)return h;var m=f.animations[0],d=f.originalValue,g=h;if(f.totalWeight===0&&f.totalAdditiveWeight>0)g.copyFrom(d);else if(f.animations.length===1){if(M.b.SlerpToRef(d,m.currentValue,Math.min(1,f.totalWeight),g),f.totalAdditiveWeight===0)return g}else if(f.animations.length>1){var v=1,l=void 0,y=void 0;if(f.totalWeight<1){var E=1-f.totalWeight;l=[],y=[],l.push(d),y.push(E)}else{if(f.animations.length===2&&(M.b.SlerpToRef(f.animations[0].currentValue,f.animations[1].currentValue,f.animations[1].weight/f.totalWeight,h),f.totalAdditiveWeight===0))return h;l=[],y=[],v=f.totalWeight}for(var R=0;R<f.animations.length;R++){var F=f.animations[R];l.push(F.currentValue),y.push(F.weight/v)}for(var B=0,L=0;L<l.length;){if(!L){M.b.SlerpToRef(l[L],l[L+1],y[L+1]/(y[L]+y[L+1]),h),g=h,B=y[L]+y[L+1],L+=2;continue}B+=y[L],M.b.SlerpToRef(g,l[L],y[L]/B,g),L++}}for(var I=0;I<f.additiveAnimations.length;I++){var F=f.additiveAnimations[I];F.weight!==0&&(g.multiplyToRef(F.currentValue,M.c.Quaternion[0]),M.b.SlerpToRef(g,M.c.Quaternion[0],F.weight,g))}return g},O.a.prototype._processLateAnimationBindings=function(){if(!!this._registeredForLateAnimationBindings.length){for(var f=0;f<this._registeredForLateAnimationBindings.length;f++){var h=this._registeredForLateAnimationBindings.data[f];for(var m in h._lateAnimationHolders){var d=h._lateAnimationHolders[m],g=d.animations[0],v=d.originalValue,l=T.a.AllowMatrixDecomposeForInterpolation&&v.m,y=h[m];if(l)y=this._processLateAnimationBindingsForMatrices(d);else{var E=v.w!==void 0;if(E)y=this._processLateAnimationBindingsForQuaternions(d,y||M.b.Identity());else{var R=0,F=1;if(d.totalWeight<1)g&&v.scale?y=v.scale(1-d.totalWeight):g?y=v*(1-d.totalWeight):v.clone?y=v.clone():y=v;else if(g){F=d.totalWeight;var B=g.weight/F;B!==1?g.currentValue.scale?y=g.currentValue.scale(B):y=g.currentValue*B:y=g.currentValue,R=1}for(var L=R;L<d.animations.length;L++){var I=d.animations[L],k=I.weight/F;if(k)I.currentValue.scaleAndAddToRef?I.currentValue.scaleAndAddToRef(k,y):y+=I.currentValue*k;else continue}for(var Z=0;Z<d.additiveAnimations.length;Z++){var I=d.additiveAnimations[Z],k=I.weight;if(k)I.currentValue.scaleAndAddToRef?I.currentValue.scaleAndAddToRef(k,y):y+=I.currentValue*k;else continue}}}h[m]=y}h._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},A.a.prototype.copyAnimationRange=function(f,h,m,d,g){d===void 0&&(d=!1),g===void 0&&(g=null),this.animations.length===0&&(this.animations.push(new T.a(this.name,"_matrix",f.animations[0].framePerSecond,T.a.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));var v=f.animations[0].getRange(h);if(!v)return!1;for(var l=v.from,y=v.to,E=f.animations[0].getKeys(),R=f.length,F=f.getParent(),B=this.getParent(),L=d&&F&&R&&this.length&&R!==this.length,I=L&&B&&F?B.length/F.length:1,k=d&&!B&&g&&(g.x!==1||g.y!==1||g.z!==1),Z=this.animations[0].getKeys(),Y,U,Q,G=0,K=E.length;G<K;G++)Y=E[G],Y.frame>=l&&Y.frame<=y&&(d?(Q=Y.value.clone(),L?(U=Q.getTranslation(),Q.setTranslation(U.scaleInPlace(I))):k&&g?(U=Q.getTranslation(),Q.setTranslation(U.multiplyInPlace(g))):Q=Y.value):Q=Y.value,Z.push({frame:Y.frame+m,value:Q}));return this.animations[0].createRange(h,l+m,y+m),!0}},531:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(460),j=u(640),O=u(641),M=u(642),H=u(643),A=function(p){Object(T.d)(f,p);function f(h){var m=p.call(this,h)||this;return m._mouseInput=null,m._mouseWheelInput=null,m}return f.prototype.addKeyboard=function(){return this.add(new j.a),this},f.prototype.addMouse=function(h){return h===void 0&&(h=!0),this._mouseInput||(this._mouseInput=new O.a(h),this.add(this._mouseInput)),this},f.prototype.removeMouse=function(){return this._mouseInput&&this.remove(this._mouseInput),this},f.prototype.addMouseWheel=function(){return this._mouseWheelInput||(this._mouseWheelInput=new M.a,this.add(this._mouseWheelInput)),this},f.prototype.removeMouseWheel=function(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this},f.prototype.addTouch=function(){return this.add(new H.a),this},f.prototype.clear=function(){p.prototype.clear.call(this),this._mouseInput=null},f}(S.b)},532:function(Ue,P,u){"use strict";var T=u(467),S=u(456);T.a.prototype.createDynamicTexture=function(j,O,M,H){var A=new S.a(this,S.b.Dynamic);return A.baseWidth=j,A.baseHeight=O,M&&(j=this.needPOTTextures?T.a.GetExponentOfTwo(j,this._caps.maxTextureSize):j,O=this.needPOTTextures?T.a.GetExponentOfTwo(O,this._caps.maxTextureSize):O),A.width=j,A.height=O,A.isReady=!1,A.generateMipMaps=M,A.samplingMode=H,this.updateTextureSamplingMode(H,A),this._internalTexturesCache.push(A),A},T.a.prototype.updateDynamicTexture=function(j,O,M,H,A,p){if(H===void 0&&(H=!1),p===void 0&&(p=!1),!!j){var f=this._gl,h=f.TEXTURE_2D,m=this._bindTextureDirectly(h,j,!0,p);this._unpackFlipY(M===void 0?j.invertY:M),H&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);var d=this._getWebGLTextureType(j.type),g=this._getInternalFormat(A||j.format),v=this._getRGBABufferInternalSizedFormat(j.type,g);f.texImage2D(h,0,v,g,d,O),j.generateMipMaps&&f.generateMipmap(h),m||this._bindTextureDirectly(h,null),H&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),j.isReady=!0}}},533:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(439),j=u(514),O=u(441),M=u(529),H=u(437),A=function(p){Object(T.d)(f,p);function f(h,m){var d=p.call(this,h,m)||this;return d.directIntensity=1,d.emissiveIntensity=1,d.environmentIntensity=1,d.specularIntensity=1,d.disableBumpMap=!1,d.ambientTextureStrength=1,d.ambientTextureImpactOnAnalyticalLights=f.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,d.metallicF0Factor=1,d.metallicReflectanceColor=O.a.White(),d.ambientColor=new O.a(0,0,0),d.albedoColor=new O.a(1,1,1),d.reflectivityColor=new O.a(1,1,1),d.reflectionColor=new O.a(1,1,1),d.emissiveColor=new O.a(0,0,0),d.microSurface=1,d.useLightmapAsShadowmap=!1,d.useAlphaFromAlbedoTexture=!1,d.forceAlphaTest=!1,d.alphaCutOff=.4,d.useSpecularOverAlpha=!0,d.useMicroSurfaceFromReflectivityMapAlpha=!1,d.useRoughnessFromMetallicTextureAlpha=!0,d.useRoughnessFromMetallicTextureGreen=!1,d.useMetallnessFromMetallicTextureBlue=!1,d.useAmbientOcclusionFromMetallicTextureRed=!1,d.useAmbientInGrayScale=!1,d.useAutoMicroSurfaceFromReflectivityMap=!1,d.useRadianceOverAlpha=!0,d.useObjectSpaceNormalMap=!1,d.useParallax=!1,d.useParallaxOcclusion=!1,d.parallaxScaleBias=.05,d.disableLighting=!1,d.forceIrradianceInFragment=!1,d.maxSimultaneousLights=4,d.invertNormalMapX=!1,d.invertNormalMapY=!1,d.twoSidedLighting=!1,d.useAlphaFresnel=!1,d.useLinearAlphaFresnel=!1,d.environmentBRDFTexture=null,d.forceNormalForward=!1,d.enableSpecularAntiAliasing=!1,d.useHorizonOcclusion=!0,d.useRadianceOcclusion=!0,d.unlit=!1,d._environmentBRDFTexture=j.a.GetEnvironmentBRDFTexture(m),d}return Object.defineProperty(f.prototype,"refractionTexture",{get:function(){return this.subSurface.refractionTexture},set:function(h){this.subSurface.refractionTexture=h,h?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"indexOfRefraction",{get:function(){return this.subSurface.indexOfRefraction},set:function(h){this.subSurface.indexOfRefraction=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"invertRefractionY",{get:function(){return this.subSurface.invertRefractionY},set:function(h){this.subSurface.invertRefractionY=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"linkRefractionWithTransparency",{get:function(){return this.subSurface.linkRefractionWithTransparency},set:function(h){this.subSurface.linkRefractionWithTransparency=h,h&&(this.subSurface.isRefractionEnabled=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"usePhysicalLightFalloff",{get:function(){return this._lightFalloff===M.a.LIGHTFALLOFF_PHYSICAL},set:function(h){h!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),h?this._lightFalloff=M.a.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=M.a.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"useGLTFLightFalloff",{get:function(){return this._lightFalloff===M.a.LIGHTFALLOFF_GLTF},set:function(h){h!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),h?this._lightFalloff=M.a.LIGHTFALLOFF_GLTF:this._lightFalloff=M.a.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(h){this._attachImageProcessingConfiguration(h),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(h){this.imageProcessingConfiguration.colorCurvesEnabled=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(h){this.imageProcessingConfiguration.colorGradingEnabled=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(h){this._imageProcessingConfiguration.toneMappingEnabled=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(h){this._imageProcessingConfiguration.exposure=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(h){this._imageProcessingConfiguration.contrast=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(h){this._imageProcessingConfiguration.colorGradingTexture=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(h){this._imageProcessingConfiguration.colorCurves=h},enumerable:!1,configurable:!0}),f.prototype.getClassName=function(){return"PBRMaterial"},f.prototype.clone=function(h){var m=this,d=S.a.Clone(function(){return new f(h,m.getScene())},this);return d.id=h,d.name=h,this.clearCoat.copyTo(d.clearCoat),this.anisotropy.copyTo(d.anisotropy),this.brdf.copyTo(d.brdf),this.sheen.copyTo(d.sheen),this.subSurface.copyTo(d.subSurface),d},f.prototype.serialize=function(){var h=S.a.Serialize(this);return h.customType="BABYLON.PBRMaterial",h.clearCoat=this.clearCoat.serialize(),h.anisotropy=this.anisotropy.serialize(),h.brdf=this.brdf.serialize(),h.sheen=this.sheen.serialize(),h.subSurface=this.subSurface.serialize(),h},f.Parse=function(h,m,d){var g=S.a.Parse(function(){return new f(h.name,m)},h,m,d);return h.clearCoat&&g.clearCoat.parse(h.clearCoat,m,d),h.anisotropy&&g.anisotropy.parse(h.anisotropy,m,d),h.brdf&&g.brdf.parse(h.brdf,m,d),h.sheen&&g.sheen.parse(h.sheen,m,d),h.subSurface&&g.subSurface.parse(h.subSurface,m,d),g},f.PBRMATERIAL_OPAQUE=M.a.PBRMATERIAL_OPAQUE,f.PBRMATERIAL_ALPHATEST=M.a.PBRMATERIAL_ALPHATEST,f.PBRMATERIAL_ALPHABLEND=M.a.PBRMATERIAL_ALPHABLEND,f.PBRMATERIAL_ALPHATESTANDBLEND=M.a.PBRMATERIAL_ALPHATESTANDBLEND,f.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=M.a.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"directIntensity",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"emissiveIntensity",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"environmentIntensity",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"specularIntensity",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"disableBumpMap",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"albedoTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"ambientTexture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"ambientTextureStrength",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesAndMiscDirty")],f.prototype,"opacityTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"reflectionTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"emissiveTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"reflectivityTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallicTexture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallic",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"roughness",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallicF0Factor",void 0),Object(T.c)([Object(S.e)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallicReflectanceColor",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"metallicReflectanceTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"microSurfaceTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"bumpTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty",null)],f.prototype,"lightmapTexture",void 0),Object(T.c)([Object(S.e)("ambient"),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"ambientColor",void 0),Object(T.c)([Object(S.e)("albedo"),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"albedoColor",void 0),Object(T.c)([Object(S.e)("reflectivity"),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"reflectivityColor",void 0),Object(T.c)([Object(S.e)("reflection"),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"reflectionColor",void 0),Object(T.c)([Object(S.e)("emissive"),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"emissiveColor",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"microSurface",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useLightmapAsShadowmap",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesAndMiscDirty")],f.prototype,"useAlphaFromAlbedoTexture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesAndMiscDirty")],f.prototype,"forceAlphaTest",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesAndMiscDirty")],f.prototype,"alphaCutOff",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useSpecularOverAlpha",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useRoughnessFromMetallicTextureGreen",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useMetallnessFromMetallicTextureBlue",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useAmbientInGrayScale",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),Object(T.c)([Object(S.c)()],f.prototype,"usePhysicalLightFalloff",null),Object(T.c)([Object(S.c)()],f.prototype,"useGLTFLightFalloff",null),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useRadianceOverAlpha",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useObjectSpaceNormalMap",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useParallax",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useParallaxOcclusion",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"parallaxScaleBias",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsLightsDirty")],f.prototype,"disableLighting",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"forceIrradianceInFragment",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsLightsDirty")],f.prototype,"maxSimultaneousLights",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"invertNormalMapX",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"invertNormalMapY",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"twoSidedLighting",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useAlphaFresnel",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useLinearAlphaFresnel",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"environmentBRDFTexture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"forceNormalForward",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"enableSpecularAntiAliasing",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useHorizonOcclusion",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],f.prototype,"useRadianceOcclusion",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsMiscDirty")],f.prototype,"unlit",void 0),f}(M.a);H.a.RegisteredTypes["BABYLON.PBRMaterial"]=A},534:function(Ue,P,u){"use strict";var T=u(435),S="postprocessVertexShader",j=`
attribute vec2 position;
uniform vec2 scale;

varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vUV=(position*madd+madd)*scale;
gl_Position=vec4(position,0.0,1.0);
}`;T.a.ShadersStore[S]=j;var O={name:S,shader:j}},535:function(Ue,P,u){"use strict";var T=u(435),S="packingFunctions",j=`vec4 pack(float depth)
{
const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);
const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);
vec4 res=fract(depth*bit_shift);
res-=res.xxyz*bit_mask;
return res;
}
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}`;T.a.IncludesShadersStore[S]=j;var O={name:S,shader:j}},537:function(Ue,P,u){"use strict";u.d(P,"a",function(){return H});var T=u(434),S=u(439),j=u(436),O=u(484),M=u(465),H=function(A){Object(T.d)(p,A);function p(){var f=A!==null&&A.apply(this,arguments)||this;return f._needProjectionMatrixCompute=!0,f}return p.prototype._setPosition=function(f){this._position=f},Object.defineProperty(p.prototype,"position",{get:function(){return this._position},set:function(f){this._setPosition(f)},enumerable:!1,configurable:!0}),p.prototype._setDirection=function(f){this._direction=f},Object.defineProperty(p.prototype,"direction",{get:function(){return this._direction},set:function(f){this._setDirection(f)},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"shadowMinZ",{get:function(){return this._shadowMinZ},set:function(f){this._shadowMinZ=f,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"shadowMaxZ",{get:function(){return this._shadowMaxZ},set:function(f){this._shadowMaxZ=f,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),p.prototype.computeTransformedInformation=function(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=j.e.Zero()),j.e.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=j.e.Zero()),j.e.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1},p.prototype.getDepthScale=function(){return 50},p.prototype.getShadowDirection=function(f){return this.transformedDirection?this.transformedDirection:this.direction},p.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},p.prototype.setDirectionToTarget=function(f){return this.direction=j.e.Normalize(f.subtract(this.position)),this.direction},p.prototype.getRotation=function(){this.direction.normalize();var f=j.e.Cross(this.direction,M.a.Y),h=j.e.Cross(f,this.direction);return j.e.RotationFromAxis(f,h,this.direction)},p.prototype.needCube=function(){return!1},p.prototype.needProjectionMatrixCompute=function(){return this._needProjectionMatrixCompute},p.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=!0},p.prototype._initCache=function(){A.prototype._initCache.call(this),this._cache.position=j.e.Zero()},p.prototype._isSynchronized=function(){return!!this._cache.position.equals(this.position)},p.prototype.computeWorldMatrix=function(f){return!f&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=j.a.Identity()),j.a.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)},p.prototype.getDepthMinZ=function(f){return this.shadowMinZ!==void 0?this.shadowMinZ:f.minZ},p.prototype.getDepthMaxZ=function(f){return this.shadowMaxZ!==void 0?this.shadowMaxZ:f.maxZ},p.prototype.setShadowProjectionMatrix=function(f,h,m){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(h,m,f):this._setDefaultShadowProjectionMatrix(f,h,m),this},Object(T.c)([Object(S.o)()],p.prototype,"position",null),Object(T.c)([Object(S.o)()],p.prototype,"direction",null),Object(T.c)([Object(S.c)()],p.prototype,"shadowMinZ",null),Object(T.c)([Object(S.c)()],p.prototype,"shadowMaxZ",null),p}(O.a)},538:function(Ue,P,u){"use strict";u.d(P,"a",function(){return M});var T=u(434),S=u(442),j=u(458),O=u(574),M=function(H){Object(T.d)(A,H);function A(p,f,h,m,d){var g=this,v=d&&d.generateMipMaps?d.generateMipMaps:!1,l=d&&d.generateDepthTexture?d.generateDepthTexture:!1,y=!d||d.doNotChangeAspectRatio===void 0?!0:d.doNotChangeAspectRatio,E=d&&d.drawOnlyOnFirstAttachmentByDefault?d.drawOnlyOnFirstAttachmentByDefault:!1;if(g=H.call(this,p,f,m,v,y,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0)||this,!g.isSupported){g.dispose();return}var R=[],F=[];g._initTypes(h,R,F,d);var B=!d||d.generateDepthBuffer===void 0?!0:d.generateDepthBuffer,L=!d||d.generateStencilBuffer===void 0?!1:d.generateStencilBuffer;return g._size=f,g._multiRenderTargetOptions={samplingModes:F,generateMipMaps:v,generateDepthBuffer:B,generateStencilBuffer:L,generateDepthTexture:l,types:R,textureCount:h},g._count=h,g._drawOnlyOnFirstAttachmentByDefault=E,h>0&&(g._createInternalTextures(),g._createTextures()),g}return Object.defineProperty(A.prototype,"isSupported",{get:function(){var p,f;return(f=(p=this._engine)===null||p===void 0?void 0:p.getCaps().drawBuffersExtension)!==null&&f!==void 0?f:!1},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"textures",{get:function(){return this._textures},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"depthTexture",{get:function(){return this._textures[this._textures.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"wrapU",{set:function(p){if(this._textures)for(var f=0;f<this._textures.length;f++)this._textures[f].wrapU=p},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"wrapV",{set:function(p){if(this._textures)for(var f=0;f<this._textures.length;f++)this._textures[f].wrapV=p},enumerable:!1,configurable:!0}),A.prototype._initTypes=function(p,f,h,m){for(var d=0;d<p;d++)m&&m.types&&m.types[d]!==void 0?f.push(m.types[d]):f.push(m&&m.defaultType?m.defaultType:0),m&&m.samplingModes&&m.samplingModes[d]!==void 0?h.push(m.samplingModes[d]):h.push(S.a.BILINEAR_SAMPLINGMODE)},A.prototype._rebuild=function(p){if(p===void 0&&(p=!1),!(this._count<1)){this.releaseInternalTextures(),this._createInternalTextures(),p&&this._createTextures();for(var f=0;f<this._internalTextures.length;f++){var h=this._textures[f];h._texture=this._internalTextures[f]}this.samples!==1&&this._getEngine().updateMultipleRenderTargetTextureSampleCount(this._internalTextures,this.samples,!this._drawOnlyOnFirstAttachmentByDefault)}},A.prototype._createInternalTextures=function(){this._internalTextures=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._internalTextures[0]},A.prototype._createTextures=function(){this._textures=[];for(var p=0;p<this._internalTextures.length;p++){var f=new S.a(null,this.getScene());f._texture=this._internalTextures[p],this._textures.push(f)}},A.prototype.replaceTexture=function(p,f){p._texture&&(this._textures[f]=p,this._internalTextures[f]=p._texture,f===0&&(this._texture=this._internalTextures[f]))},Object.defineProperty(A.prototype,"samples",{get:function(){return this._samples},set:function(p){this._samples!==p&&(this._internalTextures?this._samples=this._getEngine().updateMultipleRenderTargetTextureSampleCount(this._internalTextures,p):this._samples=p)},enumerable:!1,configurable:!0}),A.prototype.resize=function(p){this._size=p,this._rebuild()},A.prototype.updateCount=function(p,f){this._multiRenderTargetOptions.textureCount=p,this._count=p;var h=[],m=[];this._initTypes(p,h,m,f),this._multiRenderTargetOptions.types=h,this._multiRenderTargetOptions.samplingModes=m,this._rebuild(!0)},A.prototype.unbindFrameBuffer=function(p,f){var h=this;p.unBindMultiColorAttachmentFramebuffer(this._internalTextures,this.isCube,function(){h.onAfterRenderObservable.notifyObservers(f)})},A.prototype.dispose=function(){this.releaseInternalTextures(),H.prototype.dispose.call(this)},A.prototype.releaseInternalTextures=function(){if(!!this._internalTextures)for(var p=this._internalTextures.length-1;p>=0;p--)this._internalTextures[p]!==void 0&&(this._internalTextures[p].dispose(),this._internalTextures.splice(p,1))},A}(j.a)},540:function(Ue,P,u){"use strict";u.d(P,"b",function(){return M}),u.d(P,"a",function(){return H});var T=u(483),S=u(438),j=u(448),O=u(530),M=function(){function A(){}return A.prototype.getClassName=function(){return"TargetedAnimation"},A.prototype.serialize=function(){var p={};return p.animation=this.animation.serialize(),p.targetId=this.target.id,p},A}(),H=function(){function A(p,f){f===void 0&&(f=null),this.name=p,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this.onAnimationEndObservable=new S.c,this.onAnimationLoopObservable=new S.c,this.onAnimationGroupLoopObservable=new S.c,this.onAnimationGroupEndObservable=new S.c,this.onAnimationGroupPauseObservable=new S.c,this.onAnimationGroupPlayObservable=new S.c,this._scene=f||j.a.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}return Object.defineProperty(A.prototype,"from",{get:function(){return this._from},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"to",{get:function(){return this._to},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"isStarted",{get:function(){return this._isStarted},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"isPlaying",{get:function(){return this._isStarted&&!this._isPaused},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(p){if(this._speedRatio!==p){this._speedRatio=p;for(var f=0;f<this._animatables.length;f++){var h=this._animatables[f];h.speedRatio=this._speedRatio}}},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"loopAnimation",{get:function(){return this._loopAnimation},set:function(p){if(this._loopAnimation!==p){this._loopAnimation=p;for(var f=0;f<this._animatables.length;f++){var h=this._animatables[f];h.loopAnimation=this._loopAnimation}}},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"isAdditive",{get:function(){return this._isAdditive},set:function(p){if(this._isAdditive!==p){this._isAdditive=p;for(var f=0;f<this._animatables.length;f++){var h=this._animatables[f];h.isAdditive=this._isAdditive}}},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"targetedAnimations",{get:function(){return this._targetedAnimations},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"animatables",{get:function(){return this._animatables},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"children",{get:function(){return this._targetedAnimations},enumerable:!1,configurable:!0}),A.prototype.addTargetedAnimation=function(p,f){var h=new M;h.animation=p,h.target=f;var m=p.getKeys();return this._from>m[0].frame&&(this._from=m[0].frame),this._to<m[m.length-1].frame&&(this._to=m[m.length-1].frame),this._targetedAnimations.push(h),h},A.prototype.normalize=function(p,f){p===void 0&&(p=null),f===void 0&&(f=null),p==null&&(p=this._from),f==null&&(f=this._to);for(var h=0;h<this._targetedAnimations.length;h++){var m=this._targetedAnimations[h],d=m.animation.getKeys(),g=d[0],v=d[d.length-1];if(g.frame>p){var l={frame:p,value:g.value,inTangent:g.inTangent,outTangent:g.outTangent,interpolation:g.interpolation};d.splice(0,0,l)}if(v.frame<f){var l={frame:f,value:v.value,inTangent:v.inTangent,outTangent:v.outTangent,interpolation:v.interpolation};d.push(l)}}return this._from=p,this._to=f,this},A.prototype._processLoop=function(p,f,h){var m=this;p.onAnimationLoop=function(){m.onAnimationLoopObservable.notifyObservers(f),!m._animationLoopFlags[h]&&(m._animationLoopFlags[h]=!0,m._animationLoopCount++,m._animationLoopCount===m._targetedAnimations.length&&(m.onAnimationGroupLoopObservable.notifyObservers(m),m._animationLoopCount=0,m._animationLoopFlags=[]))}},A.prototype.start=function(p,f,h,m,d){var g=this;if(p===void 0&&(p=!1),f===void 0&&(f=1),this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=p,this._animationLoopCount=0,this._animationLoopFlags=[];for(var v=function(){var R=l._targetedAnimations[y],F=l._scene.beginDirectAnimation(R.target,[R.animation],h!==void 0?h:l._from,m!==void 0?m:l._to,p,f,void 0,void 0,d!==void 0?d:l._isAdditive);F.onAnimationEnd=function(){g.onAnimationEndObservable.notifyObservers(R),g._checkAnimationGroupEnded(F)},l._processLoop(F,R,y),l._animatables.push(F)},l=this,y=0;y<this._targetedAnimations.length;y++)v();if(this._speedRatio=f,h!==void 0&&m!==void 0)if(h<m&&this._speedRatio<0){var E=m;m=h,h=E}else h>m&&this._speedRatio>0&&(this._speedRatio=-f);return this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this},A.prototype.pause=function(){if(!this._isStarted)return this;this._isPaused=!0;for(var p=0;p<this._animatables.length;p++){var f=this._animatables[p];f.pause()}return this.onAnimationGroupPauseObservable.notifyObservers(this),this},A.prototype.play=function(p){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(p!==void 0&&(this.loopAnimation=p),this.restart()):(this.stop(),this.start(p,this._speedRatio)),this._isPaused=!1,this},A.prototype.reset=function(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(var p=0;p<this._animatables.length;p++){var f=this._animatables[p];f.reset()}return this},A.prototype.restart=function(){if(!this._isStarted)return this;for(var p=0;p<this._animatables.length;p++){var f=this._animatables[p];f.restart()}return this.onAnimationGroupPlayObservable.notifyObservers(this),this},A.prototype.stop=function(){if(!this._isStarted)return this;for(var p=this._animatables.slice(),f=0;f<p.length;f++)p[f].stop();return this._isStarted=!1,this},A.prototype.setWeightForAllAnimatables=function(p){for(var f=0;f<this._animatables.length;f++){var h=this._animatables[f];h.weight=p}return this},A.prototype.syncAllAnimationsWith=function(p){for(var f=0;f<this._animatables.length;f++){var h=this._animatables[f];h.syncWith(p)}return this},A.prototype.goToFrame=function(p){if(!this._isStarted)return this;for(var f=0;f<this._animatables.length;f++){var h=this._animatables[f];h.goToFrame(p)}return this},A.prototype.dispose=function(){this._targetedAnimations=[],this._animatables=[];var p=this._scene.animationGroups.indexOf(this);p>-1&&this._scene.animationGroups.splice(p,1),this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()},A.prototype._checkAnimationGroupEnded=function(p){var f=this._animatables.indexOf(p);f>-1&&this._animatables.splice(f,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))},A.prototype.clone=function(p,f){for(var h=new A(p||this.name,this._scene),m=0,d=this._targetedAnimations;m<d.length;m++){var g=d[m];h.addTargetedAnimation(g.animation.clone(),f?f(g.target):g.target)}return h},A.prototype.serialize=function(){var p={};p.name=this.name,p.from=this.from,p.to=this.to,p.targetedAnimations=[];for(var f=0;f<this.targetedAnimations.length;f++){var h=this.targetedAnimations[f];p.targetedAnimations[f]=h.serialize()}return p},A.Parse=function(p,f){for(var h=new A(p.name,f),m=0;m<p.targetedAnimations.length;m++){var d=p.targetedAnimations[m],g=T.a.Parse(d.animation),v=d.targetId;if(d.animation.property==="influence"){var l=f.getMorphTargetById(v);l&&h.addTargetedAnimation(g,l)}else{var y=f.getNodeByID(v);y!=null&&h.addTargetedAnimation(g,y)}}return p.from!==null&&p.to!==null&&h.normalize(p.from,p.to),h},A.MakeAnimationAdditive=function(p,f,h,m,d){f===void 0&&(f=0),m===void 0&&(m=!1);var g=p;m&&(g=p.clone(d||g.name));for(var v=g.targetedAnimations,l=0;l<v.length;l++){var y=v[l];T.a.MakeAnimationAdditive(y.animation,f,h)}return g.isAdditive=!0,g},A.prototype.getClassName=function(){return"AnimationGroup"},A.prototype.toString=function(p){var f="Name: "+this.name;return f+=", type: "+this.getClassName(),p&&(f+=", from: "+this._from,f+=", to: "+this._to,f+=", isStarted: "+this._isStarted,f+=", speedRatio: "+this._speedRatio,f+=", targetedAnimations length: "+this._targetedAnimations.length,f+=", animatables length: "+this._animatables),f},A}()},541:function(Ue,P,u){"use strict";u.d(P,"a",function(){return Z});var T=u(434),S=u(436),j=u(441),O=u(447),M=u(484),H=u(454),A=u(442),p=u(458),f=u(444),h=u(472),m=u(679),d=u(680),g=u(676),v=u(435),l="shadowMapFragmentSoftTransparentShadow",y=`#if SM_SOFTTRANSPARENTSHADOW == 1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;v.a.IncludesShadersStore[l]=y;var E={name:l,shader:y},R=u(438),F=u(476),B=u(512),L=u(591),I=new S.a,k=new S.a,Z=function(){function Y(U,Q,G){this.onBeforeShadowMapRenderObservable=new R.c,this.onAfterShadowMapRenderObservable=new R.c,this.onBeforeShadowMapRenderMeshObservable=new R.c,this.onAfterShadowMapRenderMeshObservable=new R.c,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=Y.FILTER_NONE,this._filteringQuality=Y.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=S.e.Zero(),this._viewMatrix=S.a.Zero(),this._projectionMatrix=S.a.Zero(),this._transformMatrix=S.a.Zero(),this._cachedPosition=new S.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new S.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=S.a.Identity(),this._mapSize=U,this._light=Q,this._scene=Q.getScene(),Q._shadowGenerator=this,this.id=Q.id,this._nameForCustomEffect="bjs_shadowgenerator_"+Y._Counter++,Y._SceneComponentInitialization(this._scene);var K=this._scene.getEngine().getCaps();G?K.textureFloatRender&&K.textureFloatLinearFiltering?this._textureType=1:K.textureHalfFloatRender&&K.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:K.textureHalfFloatRender&&K.textureHalfFloatLinearFiltering?this._textureType=2:K.textureFloatRender&&K.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}return Object.defineProperty(Y.prototype,"bias",{get:function(){return this._bias},set:function(U){this._bias=U},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"normalBias",{get:function(){return this._normalBias},set:function(U){this._normalBias=U},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(U){this._blurBoxOffset!==U&&(this._blurBoxOffset=U,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"blurScale",{get:function(){return this._blurScale},set:function(U){this._blurScale!==U&&(this._blurScale=U,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"blurKernel",{get:function(){return this._blurKernel},set:function(U){this._blurKernel!==U&&(this._blurKernel=U,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"useKernelBlur",{get:function(){return this._useKernelBlur},set:function(U){this._useKernelBlur!==U&&(this._useKernelBlur=U,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"depthScale",{get:function(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()},set:function(U){this._depthScale=U},enumerable:!1,configurable:!0}),Y.prototype._validateFilter=function(U){return U},Object.defineProperty(Y.prototype,"filter",{get:function(){return this._filter},set:function(U){if(U=this._validateFilter(U),this._light.needCube()){if(U===Y.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(U===Y.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(U===Y.FILTER_PCF||U===Y.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((U===Y.FILTER_PCF||U===Y.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==U&&(this._filter=U,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"usePoissonSampling",{get:function(){return this.filter===Y.FILTER_POISSONSAMPLING},set:function(U){var Q=this._validateFilter(Y.FILTER_POISSONSAMPLING);!U&&this.filter!==Y.FILTER_POISSONSAMPLING||(this.filter=U?Q:Y.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"useExponentialShadowMap",{get:function(){return this.filter===Y.FILTER_EXPONENTIALSHADOWMAP},set:function(U){var Q=this._validateFilter(Y.FILTER_EXPONENTIALSHADOWMAP);!U&&this.filter!==Y.FILTER_EXPONENTIALSHADOWMAP||(this.filter=U?Q:Y.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"useBlurExponentialShadowMap",{get:function(){return this.filter===Y.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(U){var Q=this._validateFilter(Y.FILTER_BLUREXPONENTIALSHADOWMAP);!U&&this.filter!==Y.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=U?Q:Y.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"useCloseExponentialShadowMap",{get:function(){return this.filter===Y.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(U){var Q=this._validateFilter(Y.FILTER_CLOSEEXPONENTIALSHADOWMAP);!U&&this.filter!==Y.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=U?Q:Y.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"useBlurCloseExponentialShadowMap",{get:function(){return this.filter===Y.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(U){var Q=this._validateFilter(Y.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!U&&this.filter!==Y.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=U?Q:Y.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"usePercentageCloserFiltering",{get:function(){return this.filter===Y.FILTER_PCF},set:function(U){var Q=this._validateFilter(Y.FILTER_PCF);!U&&this.filter!==Y.FILTER_PCF||(this.filter=U?Q:Y.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"filteringQuality",{get:function(){return this._filteringQuality},set:function(U){this._filteringQuality!==U&&(this._filteringQuality=U,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"useContactHardeningShadow",{get:function(){return this.filter===Y.FILTER_PCSS},set:function(U){var Q=this._validateFilter(Y.FILTER_PCSS);!U&&this.filter!==Y.FILTER_PCSS||(this.filter=U?Q:Y.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"contactHardeningLightSizeUVRatio",{get:function(){return this._contactHardeningLightSizeUVRatio},set:function(U){this._contactHardeningLightSizeUVRatio=U},enumerable:!1,configurable:!0}),Object.defineProperty(Y.prototype,"darkness",{get:function(){return this._darkness},set:function(U){this.setDarkness(U)},enumerable:!1,configurable:!0}),Y.prototype.getDarkness=function(){return this._darkness},Y.prototype.setDarkness=function(U){return U>=1?this._darkness=1:U<=0?this._darkness=0:this._darkness=U,this},Object.defineProperty(Y.prototype,"transparencyShadow",{get:function(){return this._transparencyShadow},set:function(U){this.setTransparencyShadow(U)},enumerable:!1,configurable:!0}),Y.prototype.setTransparencyShadow=function(U){return this._transparencyShadow=U,this},Y.prototype.getShadowMap=function(){return this._shadowMap},Y.prototype.getShadowMapForRendering=function(){return this._shadowMap2?this._shadowMap2:this._shadowMap},Y.prototype.getClassName=function(){return Y.CLASSNAME},Y.prototype.addShadowCaster=function(U,Q){var G;return Q===void 0&&(Q=!0),this._shadowMap?(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.push(U),Q&&(G=this._shadowMap.renderList).push.apply(G,U.getChildMeshes()),this):this},Y.prototype.removeShadowCaster=function(U,Q){if(Q===void 0&&(Q=!0),!this._shadowMap||!this._shadowMap.renderList)return this;var G=this._shadowMap.renderList.indexOf(U);if(G!==-1&&this._shadowMap.renderList.splice(G,1),Q)for(var K=0,fe=U.getChildren();K<fe.length;K++){var ce=fe[K];this.removeShadowCaster(ce)}return this},Y.prototype.getLight=function(){return this._light},Object.defineProperty(Y.prototype,"mapSize",{get:function(){return this._mapSize},set:function(U){this._mapSize=U,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()},enumerable:!1,configurable:!0}),Y.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()},Y.prototype._createTargetRenderTexture=function(){this._scene.getEngine()._features.supportDepthStencilTexture?(this._shadowMap=new p.a(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(513,!0)):this._shadowMap=new p.a(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())},Y.prototype._initializeShadowMap=function(){var U=this;if(this._createTargetRenderTexture(),this._shadowMap!==null){this._shadowMap.wrapU=A.a.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=A.a.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(A.a.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=function(ce,re){return!0};var Q=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(function(){Q._debugPushGroup("shadow map generation for "+U._nameForCustomEffect,1)}),this._shadowMap.onBeforeRenderObservable.add(function(ce){U._currentFaceIndex=ce,U._filter===Y.FILTER_PCF&&Q.setColorWrite(!1),U.getTransformMatrix(),U._scene.setTransformMatrix(U._viewMatrix,U._projectionMatrix)}),this._shadowMap.onAfterUnbindObservable.add(function(){if(U._scene.updateTransformMatrix(),U._filter===Y.FILTER_PCF&&Q.setColorWrite(!0),!U.useBlurExponentialShadowMap&&!U.useBlurCloseExponentialShadowMap){Q._debugPopGroup(1);return}var ce=U.getShadowMapForRendering();if(ce){var re=ce.getInternalTexture();U._scene.postProcessManager.directRender(U._blurPostProcesses,re,!0),Q.unBindFramebuffer(re,!0),Q._debugPopGroup(1)}});var G=new j.b(0,0,0,0),K=new j.b(1,1,1,1);this._shadowMap.onClearObservable.add(function(ce){U._filter===Y.FILTER_PCF?ce.clear(K,!1,!0,!1):U.useExponentialShadowMap||U.useBlurExponentialShadowMap?ce.clear(G,!0,!0,!1):ce.clear(K,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(function(ce){U._storedUniqueId=U._shadowMap.uniqueId,U._mapSize=ce.getRenderSize(),U._light._markMeshesAsLightDirty(),U.recreateShadowMap()});for(var fe=L.b.MIN_RENDERINGGROUPS;fe<L.b.MAX_RENDERINGGROUPS;fe++)this._shadowMap.setRenderingAutoClearDepthStencil(fe,!1)}},Y.prototype._initializeBlurRTTAndPostProcesses=function(){var U=this,Q=this._scene.getEngine(),G=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new p.a(this._light.name+"_shadowMap2",G,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=A.a.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=A.a.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(A.a.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new h.a(this._light.name+"KernelBlurX",new S.d(1,0),this.blurKernel,1,null,A.a.BILINEAR_SAMPLINGMODE,Q,!1,this._textureType),this._kernelBlurXPostprocess.width=G,this._kernelBlurXPostprocess.height=G,this._kernelBlurXPostprocess.onApplyObservable.add(function(K){K.setTexture("textureSampler",U._shadowMap)}),this._kernelBlurYPostprocess=new h.a(this._light.name+"KernelBlurY",new S.d(0,1),this.blurKernel,1,null,A.a.BILINEAR_SAMPLINGMODE,Q,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new f.a(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,A.a.BILINEAR_SAMPLINGMODE,Q,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.onApplyObservable.add(function(K){K.setFloat2("screenSize",G,G),K.setTexture("textureSampler",U._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])},Y.prototype._renderForShadowMap=function(U,Q,G,K){var fe,ce=this._scene.getEngine(),re=ce.getColorWrite();if(K.length){for(ce.setColorWrite(!1),fe=0;fe<K.length;fe++)this._renderSubMeshForShadowMap(K.data[fe]);ce.setColorWrite(re)}for(fe=0;fe<U.length;fe++)this._renderSubMeshForShadowMap(U.data[fe]);for(fe=0;fe<Q.length;fe++)this._renderSubMeshForShadowMap(Q.data[fe]);if(this._transparencyShadow)for(fe=0;fe<G.length;fe++)this._renderSubMeshForShadowMap(G.data[fe],!0);else for(fe=0;fe<G.length;fe++)G.data[fe].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1},Y.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(U,Q,G,K){var fe,ce,re,Re,Ie,Ce;Q.setMatrix((fe=G==null?void 0:G.viewProjection)!==null&&fe!==void 0?fe:"viewProjection",this.getTransformMatrix()),Q.setMatrix((ce=G==null?void 0:G.view)!==null&&ce!==void 0?ce:"view",this._viewMatrix),Q.setMatrix((re=G==null?void 0:G.projection)!==null&&re!==void 0?re:"projection",this._projectionMatrix);var X=K.getWorldMatrix();Q.setMatrix((Re=G==null?void 0:G.world)!==null&&Re!==void 0?Re:"world",X),X.multiplyToRef(this.getTransformMatrix(),I),Q.setMatrix((Ie=G==null?void 0:G.worldViewProjection)!==null&&Ie!==void 0?Ie:"worldViewProjection",I),X.multiplyToRef(this._viewMatrix,k),Q.setMatrix((Ce=G==null?void 0:G.worldView)!==null&&Ce!==void 0?Ce:"worldView",k)},Y.prototype._renderSubMeshForShadowMap=function(U,Q){var G;Q===void 0&&(Q=!1);var K=U.getRenderingMesh(),fe=U.getEffectiveMesh(),ce=this._scene,re=ce.getEngine(),Re=U.getMaterial();if(fe._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!Re||U.verticesCount===0||U._renderId===ce.getRenderId())){re.setState(Re.backFaceCulling);var Ie=K._getInstancesRenderList(U._id,!!U.getReplacementMesh());if(!Ie.mustReturn){var Ce=re.getCaps().instancedArrays&&(Ie.visibleInstances[U._id]!==null&&Ie.visibleInstances[U._id]!==void 0||K.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(U)))if(this.isReady(U,Ce,Q)){U._renderId=ce.getRenderId();var X=Re.shadowDepthWrapper,ae=(G=X==null?void 0:X.getEffect(U,this))!==null&&G!==void 0?G:U._getCustomEffect(this._nameForCustomEffect,!1).effect;if(re.enableEffect(ae),K._bind(U,ae,Re.fillMode),this.getTransformMatrix(),ae.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===M.a.LIGHTTYPEID_DIRECTIONALLIGHT?ae.setVector3("lightDataSM",this._cachedDirection):ae.setVector3("lightDataSM",this._cachedPosition),ce.activeCamera&&ae.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(ce.activeCamera),this.getLight().getDepthMinZ(ce.activeCamera)+this.getLight().getDepthMaxZ(ce.activeCamera)),Q&&this.enableSoftTransparentShadow&&ae.setFloat("softTransparentShadowSM",fe.visibility*Re.alpha),X)U._effectOverride=ae,X.standalone?X.baseMaterial.bindForSubMesh(fe.getWorldMatrix(),K,U):Re.bindForSubMesh(fe.getWorldMatrix(),K,U),U._effectOverride=null;else{if(ae.setMatrix("viewProjection",this.getTransformMatrix()),Re&&Re.needAlphaTesting()){var ee=Re.getAlphaTestTexture();ee&&(ae.setTexture("diffuseSampler",ee),ae.setMatrix("diffuseMatrix",ee.getTextureMatrix()||this._defaultTextureMatrix))}if(K.useBones&&K.computeBonesUsingShaders&&K.skeleton){var w=K.skeleton;if(w.isUsingTextureForMatrices){var N=w.getTransformMatrixTexture(K);if(!N)return;ae.setTexture("boneSampler",N),ae.setFloat("boneTextureWidth",4*(w.bones.length+1))}else ae.setMatrices("mBones",w.getTransformMatrices(K))}H.a.BindMorphTargetParameters(K,ae),K.morphTargetManager&&K.morphTargetManager.isUsingTextureForTargets&&K.morphTargetManager._bind(ae),H.a.BindClipPlane(ae,ce)}this._bindCustomEffectForRenderSubMeshForShadowMap(U,ae,X==null?void 0:X._matriceNames,fe),this.forceBackFacesOnly&&re.setState(!0,0,!1,!0),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(K),this.onBeforeShadowMapRenderObservable.notifyObservers(ae),K._processRendering(fe,U,ae,Re.fillMode,Ie,Ce,function(W,$){return ae.setMatrix("world",$)}),this.forceBackFacesOnly&&re.setState(!0,0,!1,!1),this.onAfterShadowMapRenderObservable.notifyObservers(ae),this.onAfterShadowMapRenderMeshObservable.notifyObservers(K)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}},Y.prototype._applyFilterValues=function(){!this._shadowMap||(this.filter===Y.FILTER_NONE||this.filter===Y.FILTER_PCSS?this._shadowMap.updateSamplingMode(A.a.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(A.a.BILINEAR_SAMPLINGMODE))},Y.prototype.forceCompilation=function(U,Q){var G=this,K=Object(T.a)({useInstances:!1},Q),fe=this.getShadowMap();if(!fe){U&&U(this);return}var ce=fe.renderList;if(!ce){U&&U(this);return}for(var re=new Array,Re=0,Ie=ce;Re<Ie.length;Re++){var Ce=Ie[Re];re.push.apply(re,Ce.subMeshes)}if(re.length===0){U&&U(this);return}var X=0,ae=function(){var ee,w;if(!(!G._scene||!G._scene.getEngine())){for(;G.isReady(re[X],K.useInstances,(w=(ee=re[X].getMaterial())===null||ee===void 0?void 0:ee.needAlphaBlendingForMesh(re[X].getMesh()))!==null&&w!==void 0?w:!1);)if(X++,X>=re.length){U&&U(G);return}setTimeout(ae,16)}};ae()},Y.prototype.forceCompilationAsync=function(U){var Q=this;return new Promise(function(G){Q.forceCompilation(function(){G()},U)})},Y.prototype._isReadyCustomDefines=function(U,Q,G){},Y.prototype._prepareShadowDefines=function(U,Q,G,K){G.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),G.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),G.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));var fe=U.getMesh();return G.push("#define SM_NORMALBIAS "+(this.normalBias&&fe.isVerticesDataPresent(O.b.NormalKind)?"1":"0")),G.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===M.a.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),G.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),G.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&K?"1":"0")),this._isReadyCustomDefines(G,U,Q),G},Y.prototype.isReady=function(U,Q,G){var K=U.getMaterial(),fe=K==null?void 0:K.shadowDepthWrapper,ce=[];this._prepareShadowDefines(U,Q,ce,G);var re=U._getCustomEffect(this._nameForCustomEffect),Re=re.effect,Ie=re.defines;if(fe){if(!fe.isReadyForSubMesh(U,ce,this,Q))return!1}else{var Ce=[O.b.PositionKind],X=U.getMesh();if(this.normalBias&&X.isVerticesDataPresent(O.b.NormalKind)&&(Ce.push(O.b.NormalKind),ce.push("#define NORMAL"),X.nonUniformScaling&&ce.push("#define NONUNIFORMSCALING")),K&&K.needAlphaTesting()){var ae=K.getAlphaTestTexture();if(ae){if(!ae.isReady())return!1;ce.push("#define ALPHATEST"),X.isVerticesDataPresent(O.b.UVKind)&&(Ce.push(O.b.UVKind),ce.push("#define UV1")),X.isVerticesDataPresent(O.b.UV2Kind)&&ae.coordinatesIndex===1&&(Ce.push(O.b.UV2Kind),ce.push("#define UV2"))}}var ee=new B.a;if(X.useBones&&X.computeBonesUsingShaders&&X.skeleton){Ce.push(O.b.MatricesIndicesKind),Ce.push(O.b.MatricesWeightsKind),X.numBoneInfluencers>4&&(Ce.push(O.b.MatricesIndicesExtraKind),Ce.push(O.b.MatricesWeightsExtraKind));var w=X.skeleton;ce.push("#define NUM_BONE_INFLUENCERS "+X.numBoneInfluencers),X.numBoneInfluencers>0&&ee.addCPUSkinningFallback(0,X),w.isUsingTextureForMatrices?ce.push("#define BONETEXTURE"):ce.push("#define BonesPerMesh "+(w.bones.length+1))}else ce.push("#define NUM_BONE_INFLUENCERS 0");var N=X.morphTargetManager,W=0;N&&N.numInfluencers>0&&(ce.push("#define MORPHTARGETS"),W=N.numInfluencers,ce.push("#define NUM_MORPH_INFLUENCERS "+W),N.isUsingTextureForTargets&&ce.push("#define MORPHTARGETS_TEXTURE"),H.a.PrepareAttributesForMorphTargetsInfluencers(Ce,X,W));var $=this._scene;if($.clipPlane&&ce.push("#define CLIPPLANE"),$.clipPlane2&&ce.push("#define CLIPPLANE2"),$.clipPlane3&&ce.push("#define CLIPPLANE3"),$.clipPlane4&&ce.push("#define CLIPPLANE4"),$.clipPlane5&&ce.push("#define CLIPPLANE5"),$.clipPlane6&&ce.push("#define CLIPPLANE6"),Q&&(ce.push("#define INSTANCES"),H.a.PushAttributesForInstances(Ce),U.getRenderingMesh().hasThinInstances&&ce.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(var J=0,le=this.customShaderOptions.defines;J<le.length;J++){var ne=le[J];ce.indexOf(ne)===-1&&ce.push(ne)}var be=ce.join(`
`);if(Ie!==be){Ie=be;var Me="shadowMap",Te=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],Ae=["diffuseSampler","boneSampler","morphTargets"];if(this.customShaderOptions){if(Me=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(var se=0,te=this.customShaderOptions.attributes;se<te.length;se++){var he=te[se];Ce.indexOf(he)===-1&&Ce.push(he)}if(this.customShaderOptions.uniforms)for(var de=0,Ne=this.customShaderOptions.uniforms;de<Ne.length;de++){var Le=Ne[de];Te.indexOf(Le)===-1&&Te.push(Le)}if(this.customShaderOptions.samplers)for(var pe=0,He=this.customShaderOptions.samplers;pe<He.length;pe++){var rt=He[pe];Ae.indexOf(rt)===-1&&Ae.push(rt)}}var ot=this._scene.getEngine();Re=ot.createEffect(Me,{attributes:Ce,uniformsNames:Te,uniformBuffersNames:[],samplers:Ae,defines:be,fallbacks:ee,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:W}},ot)}if(re.effect=Re,re.defines=Ie,!Re.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())},Y.prototype.prepareDefines=function(U,Q){var G=this._scene,K=this._light;!G.shadowsEnabled||!K.shadowEnabled||(U["SHADOW"+Q]=!0,this.useContactHardeningShadow?(U["SHADOWPCSS"+Q]=!0,this._filteringQuality===Y.QUALITY_LOW?U["SHADOWLOWQUALITY"+Q]=!0:this._filteringQuality===Y.QUALITY_MEDIUM&&(U["SHADOWMEDIUMQUALITY"+Q]=!0)):this.usePercentageCloserFiltering?(U["SHADOWPCF"+Q]=!0,this._filteringQuality===Y.QUALITY_LOW?U["SHADOWLOWQUALITY"+Q]=!0:this._filteringQuality===Y.QUALITY_MEDIUM&&(U["SHADOWMEDIUMQUALITY"+Q]=!0)):this.usePoissonSampling?U["SHADOWPOISSON"+Q]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?U["SHADOWESM"+Q]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(U["SHADOWCLOSEESM"+Q]=!0),K.needCube()&&(U["SHADOWCUBE"+Q]=!0))},Y.prototype.bindShadowLight=function(U,Q){var G=this._light,K=this._scene;if(!(!K.shadowsEnabled||!G.shadowEnabled)){var fe=K.activeCamera;if(!!fe){var ce=this.getShadowMap();!ce||(G.needCube()||Q.setMatrix("lightMatrix"+U,this.getTransformMatrix()),this._filter===Y.FILTER_PCF?(Q.setDepthStencilTexture("shadowSampler"+U,this.getShadowMapForRendering()),G._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),ce.getSize().width,1/ce.getSize().width,this.frustumEdgeFalloff,U)):this._filter===Y.FILTER_PCSS?(Q.setDepthStencilTexture("shadowSampler"+U,this.getShadowMapForRendering()),Q.setTexture("depthSampler"+U,this.getShadowMapForRendering()),G._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/ce.getSize().width,this._contactHardeningLightSizeUVRatio*ce.getSize().width,this.frustumEdgeFalloff,U)):(Q.setTexture("shadowSampler"+U,this.getShadowMapForRendering()),G._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/ce.getSize().width,this.depthScale,this.frustumEdgeFalloff,U)),G._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(fe),this.getLight().getDepthMinZ(fe)+this.getLight().getDepthMaxZ(fe),U))}}},Y.prototype.getTransformMatrix=function(){var U=this._scene;if(this._currentRenderID===U.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderID=U.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;var Q=this._light.position;if(this._light.computeTransformedInformation()&&(Q=this._light.transformedPosition),S.e.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(S.e.Dot(this._lightDirection,S.e.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!Q.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(Q),this._cachedDirection.copyFrom(this._lightDirection),S.a.LookAtLHToRef(Q,Q.add(this._lightDirection),S.e.Up(),this._viewMatrix);var G=this.getShadowMap();if(G){var K=G.renderList;K&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,K)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},Y.prototype.recreateShadowMap=function(){var U=this._shadowMap;if(!!U){var Q=U.renderList;this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this.filter,this._applyFilterValues(),this._shadowMap.renderList=Q}},Y.prototype._disposeBlurPostProcesses=function(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]},Y.prototype._disposeRTTandPostProcesses=function(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()},Y.prototype.dispose=function(){this._disposeRTTandPostProcesses(),this._light&&(this._light._shadowGenerator=null,this._light._markMeshesAsLightDirty()),this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()},Y.prototype.serialize=function(){var U={},Q=this.getShadowMap();if(!Q)return U;if(U.className=this.getClassName(),U.lightId=this._light.id,U.id=this.id,U.mapSize=Q.getRenderSize(),U.forceBackFacesOnly=this.forceBackFacesOnly,U.darkness=this.getDarkness(),U.transparencyShadow=this._transparencyShadow,U.frustumEdgeFalloff=this.frustumEdgeFalloff,U.bias=this.bias,U.normalBias=this.normalBias,U.usePercentageCloserFiltering=this.usePercentageCloserFiltering,U.useContactHardeningShadow=this.useContactHardeningShadow,U.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,U.filteringQuality=this.filteringQuality,U.useExponentialShadowMap=this.useExponentialShadowMap,U.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,U.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,U.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,U.usePoissonSampling=this.usePoissonSampling,U.depthScale=this.depthScale,U.blurBoxOffset=this.blurBoxOffset,U.blurKernel=this.blurKernel,U.blurScale=this.blurScale,U.useKernelBlur=this.useKernelBlur,U.renderList=[],Q.renderList)for(var G=0;G<Q.renderList.length;G++){var K=Q.renderList[G];U.renderList.push(K.id)}return U},Y.Parse=function(U,Q,G){for(var K=Q.getLightByID(U.lightId),fe=G?G(U.mapSize,K):new Y(U.mapSize,K),ce=fe.getShadowMap(),re=0;re<U.renderList.length;re++){var Re=Q.getMeshesByID(U.renderList[re]);Re.forEach(function(Ie){!ce||(ce.renderList||(ce.renderList=[]),ce.renderList.push(Ie))})}return U.id!==void 0&&(fe.id=U.id),fe.forceBackFacesOnly=!!U.forceBackFacesOnly,U.darkness!==void 0&&fe.setDarkness(U.darkness),U.transparencyShadow&&fe.setTransparencyShadow(!0),U.frustumEdgeFalloff!==void 0&&(fe.frustumEdgeFalloff=U.frustumEdgeFalloff),U.bias!==void 0&&(fe.bias=U.bias),U.normalBias!==void 0&&(fe.normalBias=U.normalBias),U.usePercentageCloserFiltering?fe.usePercentageCloserFiltering=!0:U.useContactHardeningShadow?fe.useContactHardeningShadow=!0:U.usePoissonSampling?fe.usePoissonSampling=!0:U.useExponentialShadowMap?fe.useExponentialShadowMap=!0:U.useBlurExponentialShadowMap?fe.useBlurExponentialShadowMap=!0:U.useCloseExponentialShadowMap?fe.useCloseExponentialShadowMap=!0:U.useBlurCloseExponentialShadowMap?fe.useBlurCloseExponentialShadowMap=!0:U.useVarianceShadowMap?fe.useExponentialShadowMap=!0:U.useBlurVarianceShadowMap&&(fe.useBlurExponentialShadowMap=!0),U.contactHardeningLightSizeUVRatio!==void 0&&(fe.contactHardeningLightSizeUVRatio=U.contactHardeningLightSizeUVRatio),U.filteringQuality!==void 0&&(fe.filteringQuality=U.filteringQuality),U.depthScale&&(fe.depthScale=U.depthScale),U.blurScale&&(fe.blurScale=U.blurScale),U.blurBoxOffset&&(fe.blurBoxOffset=U.blurBoxOffset),U.useKernelBlur&&(fe.useKernelBlur=U.useKernelBlur),U.blurKernel&&(fe.blurKernel=U.blurKernel),fe},Y._Counter=0,Y.CLASSNAME="ShadowGenerator",Y.FILTER_NONE=0,Y.FILTER_EXPONENTIALSHADOWMAP=1,Y.FILTER_POISSONSAMPLING=2,Y.FILTER_BLUREXPONENTIALSHADOWMAP=3,Y.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,Y.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,Y.FILTER_PCF=6,Y.FILTER_PCSS=7,Y.QUALITY_HIGH=0,Y.QUALITY_MEDIUM=1,Y.QUALITY_LOW=2,Y._SceneComponentInitialization=function(U){throw F.a.WarnImport("ShadowGeneratorSceneComponent")},Y}()},542:function(Ue,P,u){"use strict";u.d(P,"a",function(){return H});var T=u(434),S=u(436),j=u(588),O=u(453),M=u(465),H=function(A){Object(T.d)(p,A);function p(f,h,m,d,g,v,l){m===void 0&&(m=null),d===void 0&&(d=null),g===void 0&&(g=null),v===void 0&&(v=null),l===void 0&&(l=null);var y=A.call(this,f,h.getScene())||this;return y.name=f,y.children=new Array,y.animations=new Array,y._index=null,y._absoluteTransform=new S.a,y._invertedAbsoluteTransform=new S.a,y._scalingDeterminant=1,y._worldTransform=new S.a,y._needToDecompose=!0,y._needToCompose=!1,y._linkedTransformNode=null,y._waitingTransformNodeId=null,y._skeleton=h,y._localMatrix=d?d.clone():S.a.Identity(),y._restPose=g||y._localMatrix.clone(),y._bindPose=y._localMatrix.clone(),y._baseMatrix=v||y._localMatrix.clone(),y._index=l,h.bones.push(y),y.setParent(m,!1),(v||d)&&y._updateDifferenceMatrix(),y}return Object.defineProperty(p.prototype,"_matrix",{get:function(){return this._compose(),this._localMatrix},set:function(f){this._localMatrix.copyFrom(f),this._needToDecompose=!0},enumerable:!1,configurable:!0}),p.prototype.getClassName=function(){return"Bone"},p.prototype.getSkeleton=function(){return this._skeleton},p.prototype.getParent=function(){return this._parent},p.prototype.getChildren=function(){return this.children},p.prototype.getIndex=function(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index},p.prototype.setParent=function(f,h){if(h===void 0&&(h=!0),this._parent!==f){if(this._parent){var m=this._parent.children.indexOf(this);m!==-1&&this._parent.children.splice(m,1)}this._parent=f,this._parent&&this._parent.children.push(this),h&&this._updateDifferenceMatrix(),this.markAsDirty()}},p.prototype.getLocalMatrix=function(){return this._compose(),this._localMatrix},p.prototype.getBaseMatrix=function(){return this._baseMatrix},p.prototype.getRestPose=function(){return this._restPose},p.prototype.setRestPose=function(f){this._restPose.copyFrom(f)},p.prototype.getBindPose=function(){return this._bindPose},p.prototype.setBindPose=function(f){this._bindPose.copyFrom(f)},p.prototype.getWorldMatrix=function(){return this._worldTransform},p.prototype.returnToRest=function(){this._skeleton._numBonesWithLinkedTransformNode>0?this.updateMatrix(this._restPose,!1,!1):this.updateMatrix(this._restPose,!1,!0)},p.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},p.prototype.getAbsoluteTransform=function(){return this._absoluteTransform},p.prototype.linkTransformNode=function(f){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=f,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++},p.prototype.getTransformNode=function(){return this._linkedTransformNode},Object.defineProperty(p.prototype,"position",{get:function(){return this._decompose(),this._localPosition},set:function(f){this._decompose(),this._localPosition.copyFrom(f),this._markAsDirtyAndCompose()},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"rotation",{get:function(){return this.getRotation()},set:function(f){this.setRotation(f)},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"rotationQuaternion",{get:function(){return this._decompose(),this._localRotation},set:function(f){this.setRotationQuaternion(f)},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"scaling",{get:function(){return this.getScale()},set:function(f){this.setScale(f)},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"animationPropertiesOverride",{get:function(){return this._skeleton.animationPropertiesOverride},enumerable:!1,configurable:!0}),p.prototype._decompose=function(){!this._needToDecompose||(this._needToDecompose=!1,this._localScaling||(this._localScaling=S.e.Zero(),this._localRotation=S.b.Zero(),this._localPosition=S.e.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))},p.prototype._compose=function(){if(!!this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,S.a.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}},p.prototype.updateMatrix=function(f,h,m){h===void 0&&(h=!0),m===void 0&&(m=!0),this._baseMatrix.copyFrom(f),h&&this._updateDifferenceMatrix(),m?(this._needToCompose=!1,this._localMatrix.copyFrom(f),this._markAsDirtyAndDecompose()):this.markAsDirty()},p.prototype._updateDifferenceMatrix=function(f,h){if(h===void 0&&(h=!0),f||(f=this._baseMatrix),this._parent?f.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(f),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),h)for(var m=0;m<this.children.length;m++)this.children[m]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1},p.prototype.markAsDirty=function(){this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty()},p.prototype._markAsDirtyAndCompose=function(){this.markAsDirty(),this._needToCompose=!0},p.prototype._markAsDirtyAndDecompose=function(){this.markAsDirty(),this._needToDecompose=!0},p.prototype.translate=function(f,h,m){h===void 0&&(h=M.c.LOCAL);var d=this.getLocalMatrix();if(h==M.c.LOCAL)d.addAtIndex(12,f.x),d.addAtIndex(13,f.y),d.addAtIndex(14,f.z);else{var g=null;m&&(g=m.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var v=p._tmpMats[0],l=p._tmpVecs[0];this._parent?m&&g?(v.copyFrom(this._parent.getAbsoluteTransform()),v.multiplyToRef(g,v)):v.copyFrom(this._parent.getAbsoluteTransform()):S.a.IdentityToRef(v),v.setTranslationFromFloats(0,0,0),v.invert(),S.e.TransformCoordinatesToRef(f,v,l),d.addAtIndex(12,l.x),d.addAtIndex(13,l.y),d.addAtIndex(14,l.z)}this._markAsDirtyAndDecompose()},p.prototype.setPosition=function(f,h,m){h===void 0&&(h=M.c.LOCAL);var d=this.getLocalMatrix();if(h==M.c.LOCAL)d.setTranslationFromFloats(f.x,f.y,f.z);else{var g=null;m&&(g=m.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var v=p._tmpMats[0],l=p._tmpVecs[0];this._parent?(m&&g?(v.copyFrom(this._parent.getAbsoluteTransform()),v.multiplyToRef(g,v)):v.copyFrom(this._parent.getAbsoluteTransform()),v.invert()):S.a.IdentityToRef(v),S.e.TransformCoordinatesToRef(f,v,l),d.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()},p.prototype.setAbsolutePosition=function(f,h){this.setPosition(f,M.c.WORLD,h)},p.prototype.scale=function(f,h,m,d){d===void 0&&(d=!1);var g=this.getLocalMatrix(),v=p._tmpMats[0];S.a.ScalingToRef(f,h,m,v),v.multiplyToRef(g,g),v.invert();for(var l=0,y=this.children;l<y.length;l++){var E=y[l],R=E.getLocalMatrix();R.multiplyToRef(v,R),R.multiplyAtIndex(12,f),R.multiplyAtIndex(13,h),R.multiplyAtIndex(14,m),E._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),d)for(var F=0,B=this.children;F<B.length;F++){var E=B[F];E.scale(f,h,m,d)}},p.prototype.setScale=function(f){this._decompose(),this._localScaling.copyFrom(f),this._markAsDirtyAndCompose()},p.prototype.getScale=function(){return this._decompose(),this._localScaling},p.prototype.getScaleToRef=function(f){this._decompose(),f.copyFrom(this._localScaling)},p.prototype.setYawPitchRoll=function(f,h,m,d,g){if(d===void 0&&(d=M.c.LOCAL),d===M.c.LOCAL){var v=p._tmpQuat;S.b.RotationYawPitchRollToRef(f,h,m,v),this.setRotationQuaternion(v,d,g);return}var l=p._tmpMats[0];if(!!this._getNegativeRotationToRef(l,g)){var y=p._tmpMats[1];S.a.RotationYawPitchRollToRef(f,h,m,y),l.multiplyToRef(y,y),this._rotateWithMatrix(y,d,g)}},p.prototype.rotate=function(f,h,m,d){m===void 0&&(m=M.c.LOCAL);var g=p._tmpMats[0];g.setTranslationFromFloats(0,0,0),S.a.RotationAxisToRef(f,h,g),this._rotateWithMatrix(g,m,d)},p.prototype.setAxisAngle=function(f,h,m,d){if(m===void 0&&(m=M.c.LOCAL),m===M.c.LOCAL){var g=p._tmpQuat;S.b.RotationAxisToRef(f,h,g),this.setRotationQuaternion(g,m,d);return}var v=p._tmpMats[0];if(!!this._getNegativeRotationToRef(v,d)){var l=p._tmpMats[1];S.a.RotationAxisToRef(f,h,l),v.multiplyToRef(l,l),this._rotateWithMatrix(l,m,d)}},p.prototype.setRotation=function(f,h,m){h===void 0&&(h=M.c.LOCAL),this.setYawPitchRoll(f.y,f.x,f.z,h,m)},p.prototype.setRotationQuaternion=function(f,h,m){if(h===void 0&&(h=M.c.LOCAL),h===M.c.LOCAL){this._decompose(),this._localRotation.copyFrom(f),this._markAsDirtyAndCompose();return}var d=p._tmpMats[0];if(!!this._getNegativeRotationToRef(d,m)){var g=p._tmpMats[1];S.a.FromQuaternionToRef(f,g),d.multiplyToRef(g,g),this._rotateWithMatrix(g,h,m)}},p.prototype.setRotationMatrix=function(f,h,m){if(h===void 0&&(h=M.c.LOCAL),h===M.c.LOCAL){var d=p._tmpQuat;S.b.FromRotationMatrixToRef(f,d),this.setRotationQuaternion(d,h,m);return}var g=p._tmpMats[0];if(!!this._getNegativeRotationToRef(g,m)){var v=p._tmpMats[1];v.copyFrom(f),g.multiplyToRef(f,v),this._rotateWithMatrix(v,h,m)}},p.prototype._rotateWithMatrix=function(f,h,m){h===void 0&&(h=M.c.LOCAL);var d=this.getLocalMatrix(),g=d.m[12],v=d.m[13],l=d.m[14],y=this.getParent(),E=p._tmpMats[3],R=p._tmpMats[4];y&&h==M.c.WORLD?(m?(E.copyFrom(m.getWorldMatrix()),y.getAbsoluteTransform().multiplyToRef(E,E)):E.copyFrom(y.getAbsoluteTransform()),R.copyFrom(E),R.invert(),d.multiplyToRef(E,d),d.multiplyToRef(f,d),d.multiplyToRef(R,d)):h==M.c.WORLD&&m?(E.copyFrom(m.getWorldMatrix()),R.copyFrom(E),R.invert(),d.multiplyToRef(E,d),d.multiplyToRef(f,d),d.multiplyToRef(R,d)):d.multiplyToRef(f,d),d.setTranslationFromFloats(g,v,l),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()},p.prototype._getNegativeRotationToRef=function(f,h){var m=p._tmpMats[2];return f.copyFrom(this.getAbsoluteTransform()),h&&(f.multiplyToRef(h.getWorldMatrix(),f),S.a.ScalingToRef(h.scaling.x,h.scaling.y,h.scaling.z,m)),f.invert(),isNaN(f.m[0])?!1:(m.multiplyAtIndex(0,this._scalingDeterminant),f.multiplyToRef(m,f),!0)},p.prototype.getPosition=function(f,h){f===void 0&&(f=M.c.LOCAL),h===void 0&&(h=null);var m=S.e.Zero();return this.getPositionToRef(f,h,m),m},p.prototype.getPositionToRef=function(f,h,m){if(f===void 0&&(f=M.c.LOCAL),f==M.c.LOCAL){var d=this.getLocalMatrix();m.x=d.m[12],m.y=d.m[13],m.z=d.m[14]}else{var g=null;h&&(g=h.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var v=p._tmpMats[0];h&&g?(v.copyFrom(this.getAbsoluteTransform()),v.multiplyToRef(g,v)):v=this.getAbsoluteTransform(),m.x=v.m[12],m.y=v.m[13],m.z=v.m[14]}},p.prototype.getAbsolutePosition=function(f){f===void 0&&(f=null);var h=S.e.Zero();return this.getPositionToRef(M.c.WORLD,f,h),h},p.prototype.getAbsolutePositionToRef=function(f,h){this.getPositionToRef(M.c.WORLD,f,h)},p.prototype.computeAbsoluteTransforms=function(){if(this._compose(),this._parent)this._localMatrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);var f=this._skeleton.getPoseMatrix();f&&this._absoluteTransform.multiplyToRef(f,this._absoluteTransform)}for(var h=this.children,m=h.length,d=0;d<m;d++)h[d].computeAbsoluteTransforms()},p.prototype.getDirection=function(f,h){h===void 0&&(h=null);var m=S.e.Zero();return this.getDirectionToRef(f,h,m),m},p.prototype.getDirectionToRef=function(f,h,m){h===void 0&&(h=null);var d=null;h&&(d=h.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var g=p._tmpMats[0];g.copyFrom(this.getAbsoluteTransform()),h&&d&&g.multiplyToRef(d,g),S.e.TransformNormalToRef(f,g,m),m.normalize()},p.prototype.getRotation=function(f,h){f===void 0&&(f=M.c.LOCAL),h===void 0&&(h=null);var m=S.e.Zero();return this.getRotationToRef(f,h,m),m},p.prototype.getRotationToRef=function(f,h,m){f===void 0&&(f=M.c.LOCAL),h===void 0&&(h=null);var d=p._tmpQuat;this.getRotationQuaternionToRef(f,h,d),d.toEulerAnglesToRef(m)},p.prototype.getRotationQuaternion=function(f,h){f===void 0&&(f=M.c.LOCAL),h===void 0&&(h=null);var m=S.b.Identity();return this.getRotationQuaternionToRef(f,h,m),m},p.prototype.getRotationQuaternionToRef=function(f,h,m){if(f===void 0&&(f=M.c.LOCAL),h===void 0&&(h=null),f==M.c.LOCAL)this._decompose(),m.copyFrom(this._localRotation);else{var d=p._tmpMats[0],g=this.getAbsoluteTransform();h?g.multiplyToRef(h.getWorldMatrix(),d):d.copyFrom(g),d.multiplyAtIndex(0,this._scalingDeterminant),d.multiplyAtIndex(1,this._scalingDeterminant),d.multiplyAtIndex(2,this._scalingDeterminant),d.decompose(void 0,m,void 0)}},p.prototype.getRotationMatrix=function(f,h){f===void 0&&(f=M.c.LOCAL);var m=S.a.Identity();return this.getRotationMatrixToRef(f,h,m),m},p.prototype.getRotationMatrixToRef=function(f,h,m){if(f===void 0&&(f=M.c.LOCAL),f==M.c.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(m);else{var d=p._tmpMats[0],g=this.getAbsoluteTransform();h?g.multiplyToRef(h.getWorldMatrix(),d):d.copyFrom(g),d.multiplyAtIndex(0,this._scalingDeterminant),d.multiplyAtIndex(1,this._scalingDeterminant),d.multiplyAtIndex(2,this._scalingDeterminant),d.getRotationMatrixToRef(m)}},p.prototype.getAbsolutePositionFromLocal=function(f,h){h===void 0&&(h=null);var m=S.e.Zero();return this.getAbsolutePositionFromLocalToRef(f,h,m),m},p.prototype.getAbsolutePositionFromLocalToRef=function(f,h,m){h===void 0&&(h=null);var d=null;h&&(d=h.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var g=p._tmpMats[0];h&&d?(g.copyFrom(this.getAbsoluteTransform()),g.multiplyToRef(d,g)):g=this.getAbsoluteTransform(),S.e.TransformCoordinatesToRef(f,g,m)},p.prototype.getLocalPositionFromAbsolute=function(f,h){h===void 0&&(h=null);var m=S.e.Zero();return this.getLocalPositionFromAbsoluteToRef(f,h,m),m},p.prototype.getLocalPositionFromAbsoluteToRef=function(f,h,m){h===void 0&&(h=null);var d=null;h&&(d=h.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var g=p._tmpMats[0];g.copyFrom(this.getAbsoluteTransform()),h&&d&&g.multiplyToRef(d,g),g.invert(),S.e.TransformCoordinatesToRef(f,g,m)},p.prototype.setCurrentPoseAsRest=function(){this.setRestPose(this.getLocalMatrix())},p._tmpVecs=j.a.BuildArray(2,S.e.Zero),p._tmpQuat=S.b.Identity(),p._tmpMats=j.a.BuildArray(5,S.a.Identity),p}(O.a)},544:function(Ue,P,u){"use strict";u.d(P,"a",function(){return j});var T=u(436),S=u(476),j=function(){function O(M,H){if(H===void 0&&(H=O.DefaultPluginFactory()),this._physicsPlugin=H,this._impostors=[],this._joints=[],this._subTimeStep=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");M=M||new T.e(0,-9.807,0),this.setGravity(M),this.setTimeStep()}return O.DefaultPluginFactory=function(){throw S.a.WarnImport("CannonJSPlugin")},O.prototype.setGravity=function(M){this.gravity=M,this._physicsPlugin.setGravity(this.gravity)},O.prototype.setTimeStep=function(M){M===void 0&&(M=1/60),this._physicsPlugin.setTimeStep(M)},O.prototype.getTimeStep=function(){return this._physicsPlugin.getTimeStep()},O.prototype.setSubTimeStep=function(M){M===void 0&&(M=0),this._subTimeStep=M},O.prototype.getSubTimeStep=function(){return this._subTimeStep},O.prototype.dispose=function(){this._impostors.forEach(function(M){M.dispose()}),this._physicsPlugin.dispose()},O.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name},O.prototype.addImpostor=function(M){M.uniqueId=this._impostors.push(M),M.parent||this._physicsPlugin.generatePhysicsBody(M)},O.prototype.removeImpostor=function(M){var H=this._impostors.indexOf(M);if(H>-1){var A=this._impostors.splice(H,1);A.length&&this.getPhysicsPlugin().removePhysicsBody(M)}},O.prototype.addJoint=function(M,H,A){var p={mainImpostor:M,connectedImpostor:H,joint:A};A.physicsPlugin=this._physicsPlugin,this._joints.push(p),this._physicsPlugin.generateJoint(p)},O.prototype.removeJoint=function(M,H,A){var p=this._joints.filter(function(f){return f.connectedImpostor===H&&f.joint===A&&f.mainImpostor===M});p.length&&this._physicsPlugin.removeJoint(p[0])},O.prototype._step=function(M){var H=this;this._impostors.forEach(function(A){A.isBodyInitRequired()&&H._physicsPlugin.generatePhysicsBody(A)}),M>.1?M=.1:M<=0&&(M=1/60),this._physicsPlugin.executeStep(M,this._impostors)},O.prototype.getPhysicsPlugin=function(){return this._physicsPlugin},O.prototype.getImpostors=function(){return this._impostors},O.prototype.getImpostorForPhysicsObject=function(M){for(var H=0;H<this._impostors.length;++H)if(this._impostors[H].object===M)return this._impostors[H];return null},O.prototype.getImpostorWithPhysicsBody=function(M){for(var H=0;H<this._impostors.length;++H)if(this._impostors[H].physicsBody===M)return this._impostors[H];return null},O.prototype.raycast=function(M,H){return this._physicsPlugin.raycast(M,H)},O.Epsilon=.001,O}()},545:function(Ue,P,u){"use strict";u.d(P,"a",function(){return M});var T=u(444),S=u(625),j=u(500),O=u(566),M=function(){function H(){}return H.ExpandRGBDTexture=function(A){var p=A._texture;if(!(!p||!A.isRGBD)){var f=p.getEngine(),h=f.getCaps(),m=!1;h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(m=!0,p.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(m=!0,p.type=1),m&&(p.isReady=!1,p._isRGBD=!1,p.invertY=!1),A.onLoadObservable.addOnce(function(){if(m){var d=new T.a("rgbdDecode","rgbdDecode",null,null,1,null,3,f,!1,void 0,p.type,void 0,null,!1),g=f.createRenderTargetTexture(p.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:p.samplingMode,type:p.type,format:5});d.getEffect().executeWhenCompiled(function(){d.onApply=function(v){v._bindTexture("textureSampler",p),v.setFloat2("scale",1,1)},A.getScene().postProcessManager.directRender([d],g,!0),f.restoreDefaultFramebuffer(),f._releaseTexture(p),f._releaseFramebufferObjects(g),d&&d.dispose(),g._swapAndDie(p),p.isReady=!0})}})}},H.EncodeTextureToRGBD=function(A,p,f){return f===void 0&&(f=0),O.a.ApplyPostProcess("rgbdEncode",A,p,f,1,5)},H}()},546:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});var T=u(436),S=function(){function j(){}return j._RemoveAndStorePivotPoint=function(O){O&&j._PivotCached===0&&(O.getPivotPointToRef(j._OldPivotPoint),j._PivotPostMultiplyPivotMatrix=O._postMultiplyPivotMatrix,j._OldPivotPoint.equalsToFloats(0,0,0)||(O.setPivotMatrix(T.a.IdentityReadOnly),j._OldPivotPoint.subtractToRef(O.getPivotPoint(),j._PivotTranslation),j._PivotTmpVector.copyFromFloats(1,1,1),j._PivotTmpVector.subtractInPlace(O.scaling),j._PivotTmpVector.multiplyInPlace(j._PivotTranslation),O.position.addInPlace(j._PivotTmpVector))),j._PivotCached++},j._RestorePivotPoint=function(O){O&&!j._OldPivotPoint.equalsToFloats(0,0,0)&&j._PivotCached===1&&(O.setPivotPoint(j._OldPivotPoint),O._postMultiplyPivotMatrix=j._PivotPostMultiplyPivotMatrix,j._PivotTmpVector.copyFromFloats(1,1,1),j._PivotTmpVector.subtractInPlace(O.scaling),j._PivotTmpVector.multiplyInPlace(j._PivotTranslation),O.position.subtractInPlace(j._PivotTmpVector)),this._PivotCached--},j._PivotCached=0,j._OldPivotPoint=new T.e,j._PivotTranslation=new T.e,j._PivotTmpVector=new T.e,j._PivotPostMultiplyPivotMatrix=!1,j}()},547:function(Ue,P,u){"use strict";u.d(P,"a",function(){return O});var T=u(449),S=u(452),j=u(502);Object.defineProperty(T.a.prototype,"geometryBufferRenderer",{get:function(){this._geometryBufferRenderer},set:function(M){M&&M.isSupported&&(this._geometryBufferRenderer=M)},enumerable:!0,configurable:!0}),T.a.prototype.enableGeometryBufferRenderer=function(M){return M===void 0&&(M=1),this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new j.a(this,M),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)},T.a.prototype.disableGeometryBufferRenderer=function(){!this._geometryBufferRenderer||(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};var O=function(){function M(H){this.name=S.a.NAME_GEOMETRYBUFFERRENDERER,this.scene=H}return M.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(S.a.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)},M.prototype.rebuild=function(){},M.prototype.dispose=function(){},M.prototype._gatherRenderTargets=function(H){this.scene._geometryBufferRenderer&&H.push(this.scene._geometryBufferRenderer.getGBuffer())},M}();j.a._SceneComponentInitialization=function(M){var H=M._getComponent(S.a.NAME_GEOMETRYBUFFERRENDERER);H||(H=new O(M),M._addComponent(H))}},548:function(Ue,P,u){"use strict";u.d(P,"a",function(){return T});var T=function(){function S(){this._renderPipelines={}}return Object.defineProperty(S.prototype,"supportedPipelines",{get:function(){var j=[];for(var O in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(O)){var M=this._renderPipelines[O];M.isSupported&&j.push(M)}return j},enumerable:!1,configurable:!0}),S.prototype.addPipeline=function(j){this._renderPipelines[j._name]=j},S.prototype.attachCamerasToRenderPipeline=function(j,O,M){M===void 0&&(M=!1);var H=this._renderPipelines[j];!H||H._attachCameras(O,M)},S.prototype.detachCamerasFromRenderPipeline=function(j,O){var M=this._renderPipelines[j];!M||M._detachCameras(O)},S.prototype.enableEffectInPipeline=function(j,O,M){var H=this._renderPipelines[j];!H||H._enableEffect(O,M)},S.prototype.disableEffectInPipeline=function(j,O,M){var H=this._renderPipelines[j];!H||H._disableEffect(O,M)},S.prototype.update=function(){for(var j in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(j)){var O=this._renderPipelines[j];O.isSupported?O._update():(O.dispose(),delete this._renderPipelines[j])}},S.prototype._rebuild=function(){for(var j in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(j)){var O=this._renderPipelines[j];O._rebuild()}},S.prototype.dispose=function(){for(var j in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(j)){var O=this._renderPipelines[j];O.dispose()}},S}()},549:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});const T=()=>!!document.createElement("canvas").getContext("webgl2"),S=()=>T()?"webgl2":"webgl"},554:function(Ue,P,u){"use strict";u.d(P,"a",function(){return T});var T=function(){function S(j,O){O===void 0&&(O=20),this.debug=!1,this._sourceCode=j,this._numMaxIterations=O,this._functionDescr=[],this.inlineToken="#define inline"}return Object.defineProperty(S.prototype,"code",{get:function(){return this._sourceCode},enumerable:!1,configurable:!0}),S.prototype.processCode=function(){this.debug&&console.log("Start inlining process (code size="+this._sourceCode.length+")..."),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&console.log("End of inlining process.")},S.prototype._collectFunctions=function(){for(var j=0;j<this._sourceCode.length;){var O=this._sourceCode.indexOf(this.inlineToken,j);if(O<0)break;var M=this._sourceCode.indexOf("(",O+this.inlineToken.length);if(M<0){this.debug&&console.warn("Could not find the opening parenthesis after the token. startIndex="+j),j=O+this.inlineToken.length;continue}var H=S._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(O+this.inlineToken.length,M));if(!H){this.debug&&console.warn("Could not extract the name/type of the function from: "+this._sourceCode.substring(O+this.inlineToken.length,M)),j=O+this.inlineToken.length;continue}var A=[H[3],H[4]],p=A[0],f=A[1],h=this._extractBetweenMarkers("(",")",this._sourceCode,M);if(h<0){this.debug&&console.warn("Could not extract the parameters the function '"+f+"' (type="+p+"). funcParamsStartIndex="+M),j=O+this.inlineToken.length;continue}var m=this._sourceCode.substring(M+1,h),d=this._skipWhitespaces(this._sourceCode,h+1);if(d===this._sourceCode.length){this.debug&&console.warn("Could not extract the body of the function '"+f+"' (type="+p+"). funcParamsEndIndex="+h),j=O+this.inlineToken.length;continue}var g=this._extractBetweenMarkers("{","}",this._sourceCode,d);if(g<0){this.debug&&console.warn("Could not extract the body of the function '"+f+"' (type="+p+"). funcBodyStartIndex="+d),j=O+this.inlineToken.length;continue}for(var v=this._sourceCode.substring(d,g+1),l=this._removeComments(m).split(","),y=[],E=0;E<l.length;++E){var R=l[E].trim(),F=R.lastIndexOf(" ");F>=0&&y.push(R.substring(F+1))}p!=="void"&&y.push("return"),this._functionDescr.push({name:f,type:p,parameters:y,body:v,callIndex:0}),j=g+1;var B=O>0?this._sourceCode.substring(0,O):"",L=g+1<this._sourceCode.length-1?this._sourceCode.substring(g+1):"";this._sourceCode=B+L,j-=g+1-O}this.debug&&console.log("Collect functions: "+this._functionDescr.length+" functions found. functionDescr=",this._functionDescr)},S.prototype._processInlining=function(j){for(j===void 0&&(j=20);j-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&console.log("numMaxIterations is "+j+" after inlining process"),j>=0},S.prototype._extractBetweenMarkers=function(j,O,M,H){for(var A=H,p=0,f="";A<M.length;){var h=M.charAt(A);if(f)h===f?f==='"'||f==="'"?M.charAt(A-1)!=="\\"&&(f=""):f="":f==="*/"&&h==="*"&&A+1<M.length&&(M.charAt(A+1)==="/"&&(f=""),f===""&&A++);else switch(h){case j:p++;break;case O:p--;break;case'"':case"'":case"`":f=h;break;case"/":if(A+1<M.length){var m=M.charAt(A+1);m==="/"?f=`
`:m==="*"&&(f="*/")}break}if(A++,p===0)break}return p===0?A-1:-1},S.prototype._skipWhitespaces=function(j,O){for(;O<j.length;){var M=j[O];if(M!==" "&&M!==`
`&&M!=="\r"&&M!=="	"&&M!==`
`&&M!=="\xA0")break;O++}return O},S.prototype._isIdentifierChar=function(j){var O=j.charCodeAt(0);return O>=48&&O<=57||O>=65&&O<=90||O>=97&&O<=122||O==95},S.prototype._removeComments=function(j){for(var O=0,M="",H=!1,A=[];O<j.length;){var p=j.charAt(O);if(M)p===M?M==='"'||M==="'"?(j.charAt(O-1)!=="\\"&&(M=""),A.push(p)):(M="",H=!1):M==="*/"&&p==="*"&&O+1<j.length?(j.charAt(O+1)==="/"&&(M=""),M===""&&(H=!1,O++)):H||A.push(p);else{switch(p){case'"':case"'":case"`":M=p;break;case"/":if(O+1<j.length){var f=j.charAt(O+1);f==="/"?(M=`
`,H=!0):f==="*"&&(M="*/",H=!0)}break}H||A.push(p)}O++}return A.join("")},S.prototype._replaceFunctionCallsByCode=function(){for(var j=this,O=!1,M=0,H=this._functionDescr;M<H.length;M++)for(var A=H[M],p=A.name,f=A.type,h=A.parameters,m=A.body,d=0;d<this._sourceCode.length;){var g=this._sourceCode.indexOf(p,d);if(g<0)break;if(g===0||this._isIdentifierChar(this._sourceCode.charAt(g-1))){d=g+p.length;continue}var v=this._skipWhitespaces(this._sourceCode,g+p.length);if(v===this._sourceCode.length||this._sourceCode.charAt(v)!=="("){d=g+p.length;continue}var l=this._extractBetweenMarkers("(",")",this._sourceCode,v);if(l<0){this.debug&&console.warn("Could not extract the parameters of the function call. Function '"+p+"' (type="+f+"). callParamsStartIndex="+v),d=g+p.length;continue}var y=this._sourceCode.substring(v+1,l),E=function(G){for(var K=[],fe=0,ce=0;fe<G.length;){if(G.charAt(fe)==="("){var re=j._extractBetweenMarkers("(",")",G,fe);if(re<0)return null;fe=re}else G.charAt(fe)===","&&(K.push(G.substring(ce,fe)),ce=fe+1);fe++}return ce<fe&&K.push(G.substring(ce,fe)),K},R=E(this._removeComments(y));if(R===null){this.debug&&console.warn("Invalid function call: can't extract the parameters of the function call. Function '"+p+"' (type="+f+"). callParamsStartIndex="+v+", callParams="+y),d=g+p.length;continue}for(var F=[],B=0;B<R.length;++B){var L=R[B].trim();F.push(L)}var I=f!=="void"?p+"_"+A.callIndex++:null;if(I&&F.push(I+" ="),F.length!==h.length){this.debug&&console.warn("Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '"+p+"' (type="+f+"). function parameters="+h+", call parameters="+F),d=g+p.length;continue}d=l+1;var k=this._replaceNames(m,h,F),Z=g>0?this._sourceCode.substring(0,g):"",Y=l+1<this._sourceCode.length-1?this._sourceCode.substring(l+1):"";if(I){var U=this._findBackward(this._sourceCode,g-1,`
`);Z=this._sourceCode.substring(0,U+1);var Q=this._sourceCode.substring(U+1,g);this._sourceCode=Z+f+" "+I+`;
`+k+`
`+Q+I+Y,this.debug&&console.log("Replace function call by code. Function '"+p+"' (type="+f+"). injectDeclarationIndex="+U+", call parameters="+F)}else this._sourceCode=Z+k+Y,d+=k.length-(l+1-g),this.debug&&console.log("Replace function call by code. Function '"+p+"' (type="+f+"). functionCallIndex="+g+", call parameters="+F);O=!0}return O},S.prototype._findBackward=function(j,O,M){for(;O>=0&&j.charAt(O)!==M;)O--;return O},S.prototype._escapeRegExp=function(j){return j.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},S.prototype._replaceNames=function(j,O,M){for(var H=this,A=function(h){var m=new RegExp(p._escapeRegExp(O[h]),"g"),d=O[h].length,g=M[h];j=j.replace(m,function(v){for(var l=[],y=1;y<arguments.length;y++)l[y-1]=arguments[y];var E=l[0];return H._isIdentifierChar(j.charAt(E-1))||H._isIdentifierChar(j.charAt(E+d))?O[h]:g})},p=this,f=0;f<O.length;++f)A(f);return j},S._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/,S}()},555:function(Ue,P,u){"use strict";var T=u(446),S=u(447),j=u(436);T.a.prototype.thinInstanceAdd=function(O,M){M===void 0&&(M=!0),this._thinInstanceUpdateBufferSize("matrix",Array.isArray(O)?O.length:1);var H=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(O))for(var A=0;A<O.length;++A)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,O[A],A===O.length-1&&M);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,O,M);return H},T.a.prototype.thinInstanceAddSelf=function(O){return O===void 0&&(O=!0),this.thinInstanceAdd(j.a.IdentityReadOnly,O)},T.a.prototype.thinInstanceRegisterAttribute=function(O,M){this.removeVerticesData(O),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[O]=M,this._userThinInstanceBuffersStorage.sizes[O]=M*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[O]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[O]),this._userThinInstanceBuffersStorage.vertexBuffers[O]=new S.b(this.getEngine(),this._userThinInstanceBuffersStorage.data[O],O,!0,!1,M,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[O])},T.a.prototype.thinInstanceSetMatrixAt=function(O,M,H){if(H===void 0&&(H=!0),!this._thinInstanceDataStorage.matrixData||O>=this._thinInstanceDataStorage.instancesCount)return!1;var A=this._thinInstanceDataStorage.matrixData;return M.copyToArray(A,O*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[O]=M),H&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},T.a.prototype.thinInstanceSetAttributeAt=function(O,M,H,A){return A===void 0&&(A=!0),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[O]||M>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(O,0),this._userThinInstanceBuffersStorage.data[O].set(H,M*this._userThinInstanceBuffersStorage.strides[O]),A&&this.thinInstanceBufferUpdated(O),!0)},Object.defineProperty(T.a.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(O){var M,H,A=((H=(M=this._thinInstanceDataStorage.matrixData)===null||M===void 0?void 0:M.length)!==null&&H!==void 0?H:0)/16;O<=A&&(this._thinInstanceDataStorage.instancesCount=O)},enumerable:!0,configurable:!0}),T.a.prototype.thinInstanceSetBuffer=function(O,M,H,A){var p,f;if(H===void 0&&(H=0),A===void 0&&(A=!1),H=H||16,O==="matrix")if((p=this._thinInstanceDataStorage.matrixBuffer)===null||p===void 0||p.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=M?M.length:32*H,this._thinInstanceDataStorage.matrixData=M,this._thinInstanceDataStorage.worldMatrices=null,M!==null){this._thinInstanceDataStorage.instancesCount=M.length/H;var h=new S.a(this.getEngine(),M,!A,H,!1,!0);this._thinInstanceDataStorage.matrixBuffer=h,this.setVerticesBuffer(h.createVertexBuffer("world0",0,4)),this.setVerticesBuffer(h.createVertexBuffer("world1",4,4)),this.setVerticesBuffer(h.createVertexBuffer("world2",8,4)),this.setVerticesBuffer(h.createVertexBuffer("world3",12,4)),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)}else this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo(!0);else M===null?((f=this._userThinInstanceBuffersStorage)===null||f===void 0?void 0:f.data[O])&&(this.removeVerticesData(O),delete this._userThinInstanceBuffersStorage.data[O],delete this._userThinInstanceBuffersStorage.strides[O],delete this._userThinInstanceBuffersStorage.sizes[O],delete this._userThinInstanceBuffersStorage.vertexBuffers[O]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[O]=M,this._userThinInstanceBuffersStorage.strides[O]=H,this._userThinInstanceBuffersStorage.sizes[O]=M.length,this._userThinInstanceBuffersStorage.vertexBuffers[O]=new S.b(this.getEngine(),M,O,!A,!1,H,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[O]))},T.a.prototype.thinInstanceBufferUpdated=function(O){var M;O==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):((M=this._userThinInstanceBuffersStorage)===null||M===void 0?void 0:M.vertexBuffers[O])&&this._userThinInstanceBuffersStorage.vertexBuffers[O].updateDirectly(this._userThinInstanceBuffersStorage.data[O],0)},T.a.prototype.thinInstancePartialBufferUpdate=function(O,M,H){var A;O==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(M,H):((A=this._userThinInstanceBuffersStorage)===null||A===void 0?void 0:A.vertexBuffers[O])&&this._userThinInstanceBuffersStorage.vertexBuffers[O].updateDirectly(M,H)},T.a.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];var O=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(var M=0;M<this._thinInstanceDataStorage.instancesCount;++M)this._thinInstanceDataStorage.worldMatrices[M]=j.a.FromArray(O,M*16)}return this._thinInstanceDataStorage.worldMatrices},T.a.prototype.thinInstanceRefreshBoundingInfo=function(O){if(O===void 0&&(O=!1),!(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)){var M=this._thinInstanceDataStorage.boundingVectors;O&&(M.length=0,this.refreshBoundingInfo(!0));var H=this.getBoundingInfo(),A=this._thinInstanceDataStorage.matrixData;if(M.length===0)for(var p=0;p<H.boundingBox.vectors.length;++p)M.push(H.boundingBox.vectors[p].clone());j.c.Vector3[0].setAll(Number.POSITIVE_INFINITY),j.c.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(var f=0;f<this._thinInstanceDataStorage.instancesCount;++f){j.a.FromArrayToRef(A,f*16,j.c.Matrix[0]);for(var p=0;p<M.length;++p)j.e.TransformCoordinatesToRef(M[p],j.c.Matrix[0],j.c.Vector3[2]),j.c.Vector3[0].minimizeInPlace(j.c.Vector3[2]),j.c.Vector3[1].maximizeInPlace(j.c.Vector3[2])}H.reConstruct(j.c.Vector3[0],j.c.Vector3[1]),this._updateBoundingInfo()}},T.a.prototype._thinInstanceUpdateBufferSize=function(O,M){var H,A;M===void 0&&(M=1);var p=O==="matrix";if(!(!p&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[O]))){for(var f=p?16:this._userThinInstanceBuffersStorage.strides[O],h=p?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[O],m=p?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[O],d=(this._thinInstanceDataStorage.instancesCount+M)*f,g=h;g<d;)g*=2;if(!m||h!=g){if(!m)m=new Float32Array(g);else{var v=new Float32Array(g);v.set(m,0),m=v}if(p){(H=this._thinInstanceDataStorage.matrixBuffer)===null||H===void 0||H.dispose();var l=new S.a(this.getEngine(),m,!0,f,!1,!0);this._thinInstanceDataStorage.matrixBuffer=l,this._thinInstanceDataStorage.matrixData=m,this._thinInstanceDataStorage.matrixBufferSize=g,this.setVerticesBuffer(l.createVertexBuffer("world0",0,4)),this.setVerticesBuffer(l.createVertexBuffer("world1",4,4)),this.setVerticesBuffer(l.createVertexBuffer("world2",8,4)),this.setVerticesBuffer(l.createVertexBuffer("world3",12,4))}else(A=this._userThinInstanceBuffersStorage.vertexBuffers[O])===null||A===void 0||A.dispose(),this._userThinInstanceBuffersStorage.data[O]=m,this._userThinInstanceBuffersStorage.sizes[O]=g,this._userThinInstanceBuffersStorage.vertexBuffers[O]=new S.b(this.getEngine(),m,O,!0,!1,f,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[O])}}},T.a.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},T.a.prototype._disposeThinInstanceSpecificData=function(){var O;((O=this._thinInstanceDataStorage)===null||O===void 0?void 0:O.matrixBuffer)&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)}},556:function(Ue,P,u){"use strict";u.d(P,"a",function(){return g});var T=u(441),S=u(447),j=u(442),O=u(458),M=u(454),H=u(435),A=u(535),p="depthPixelShader",f=`#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
void main(void)
{
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
}`;H.a.ShadersStore[p]=f;var h={name:p,shader:f},m=u(664),d=u(476),g=function(){function v(l,y,E,R){var F=this;y===void 0&&(y=1),E===void 0&&(E=null),R===void 0&&(R=!1),this.enabled=!0,this.useOnlyInActiveCamera=!1,this._scene=l,this._storeNonLinearDepth=R,this.isPacked=y===0,this.isPacked?this._clearColor=new T.b(1,1,1,1):this._clearColor=new T.b(1,0,0,1),v._SceneComponentInitialization(this._scene),this._camera=E;var B=l.getEngine(),L=this.isPacked||!B._features.supportExtendedTextureFormats?5:6;this._depthMap=new O.a("depthMap",{width:B.getRenderWidth(),height:B.getRenderHeight()},this._scene,!1,!0,y,!1,void 0,void 0,void 0,void 0,L),this._depthMap.wrapU=j.a.CLAMP_ADDRESSMODE,this._depthMap.wrapV=j.a.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(function(k){k.clear(F._clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(function(){B._debugPushGroup("depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(function(){B._debugPopGroup(1)});var I=function(k){var Z=k.getRenderingMesh(),Y=k.getEffectiveMesh(),U=F._scene,Q=U.getEngine(),G=k.getMaterial();if(Y._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!G||Y.infiniteDistance||G.disableDepthWrite||k.verticesCount===0||k._renderId===U.getRenderId())){Q.setState(G.backFaceCulling,0,!1,U.useRightHandedSystem);var K=Z._getInstancesRenderList(k._id,!!k.getReplacementMesh());if(!K.mustReturn){var fe=Q.getCaps().instancedArrays&&(K.visibleInstances[k._id]!==null&&K.visibleInstances[k._id]!==void 0||Z.hasThinInstances),ce=F._camera||U.activeCamera;if(F.isReady(k,fe)&&ce){if(k._renderId=U.getRenderId(),Q.enableEffect(F._effect),Z._bind(k,F._effect,G.fillMode),F._effect.setMatrix("viewProjection",U.getTransformMatrix()),F._effect.setMatrix("world",Y.getWorldMatrix()),F._effect.setFloat2("depthValues",ce.minZ,ce.minZ+ce.maxZ),G&&G.needAlphaTesting()){var re=G.getAlphaTestTexture();re&&(F._effect.setTexture("diffuseSampler",re),F._effect.setMatrix("diffuseMatrix",re.getTextureMatrix()))}if(Z.useBones&&Z.computeBonesUsingShaders&&Z.skeleton){var Re=Z.skeleton;if(Re.isUsingTextureForMatrices){var Ie=Re.getTransformMatrixTexture(Z);if(!Ie)return;F._effect.setTexture("boneSampler",Ie),F._effect.setFloat("boneTextureWidth",4*(Re.bones.length+1))}else F._effect.setMatrices("mBones",Re.getTransformMatrices(Z))}M.a.BindMorphTargetParameters(Z,F._effect),Z.morphTargetManager&&Z.morphTargetManager.isUsingTextureForTargets&&Z.morphTargetManager._bind(F._effect),Z._processRendering(Y,k,F._effect,G.fillMode,K,fe,function(Ce,X){return F._effect.setMatrix("world",X)})}}}};this._depthMap.customRenderFunction=function(k,Z,Y,U){var Q;if(U.length){for(B.setColorWrite(!1),Q=0;Q<U.length;Q++)I(U.data[Q]);B.setColorWrite(!0)}for(Q=0;Q<k.length;Q++)I(k.data[Q]);for(Q=0;Q<Z.length;Q++)I(Z.data[Q])}}return v.prototype.isReady=function(l,y){var E=l.getMaterial();if(E.disableDepthWrite)return!1;var R=[],F=[S.b.PositionKind],B=l.getMesh();E&&E.needAlphaTesting()&&E.getAlphaTestTexture()&&(R.push("#define ALPHATEST"),B.isVerticesDataPresent(S.b.UVKind)&&(F.push(S.b.UVKind),R.push("#define UV1")),B.isVerticesDataPresent(S.b.UV2Kind)&&(F.push(S.b.UV2Kind),R.push("#define UV2"))),B.useBones&&B.computeBonesUsingShaders?(F.push(S.b.MatricesIndicesKind),F.push(S.b.MatricesWeightsKind),B.numBoneInfluencers>4&&(F.push(S.b.MatricesIndicesExtraKind),F.push(S.b.MatricesWeightsExtraKind)),R.push("#define NUM_BONE_INFLUENCERS "+B.numBoneInfluencers),R.push("#define BonesPerMesh "+(B.skeleton?B.skeleton.bones.length+1:0))):R.push("#define NUM_BONE_INFLUENCERS 0");var L=B.morphTargetManager,I=0;L&&L.numInfluencers>0&&(I=L.numInfluencers,R.push("#define MORPHTARGETS"),R.push("#define NUM_MORPH_INFLUENCERS "+I),L.isUsingTextureForTargets&&R.push("#define MORPHTARGETS_TEXTURE"),M.a.PrepareAttributesForMorphTargetsInfluencers(F,B,I)),y&&(R.push("#define INSTANCES"),M.a.PushAttributesForInstances(F),l.getRenderingMesh().hasThinInstances&&R.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&R.push("#define NONLINEARDEPTH"),this.isPacked&&R.push("#define PACKED");var k=R.join(`
`);return this._cachedDefines!==k&&(this._cachedDefines=k,this._effect=this._scene.getEngine().createEffect("depth",F,["world","mBones","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],["diffuseSampler","morphTargets"],k,void 0,void 0,void 0,{maxSimultaneousMorphTargets:I})),this._effect.isReady()},v.prototype.getDepthMap=function(){return this._depthMap},v.prototype.dispose=function(){this._depthMap.dispose()},v._SceneComponentInitialization=function(l){throw d.a.WarnImport("DepthRendererSceneComponent")},v}()},560:function(Ue,P,u){"use strict";u.d(P,"a",function(){return h});var T=u(542),S=u(438),j=u(436),O=u(527),M=u(483),H=u(672),A=u(448),p=u(440),f=u(474),h=function(){function m(d,g,v){this.name=d,this.id=g,this.bones=new Array,this.needInitialSkinMatrix=!1,this.overrideMesh=null,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=j.a.Identity(),this._ranges={},this._lastAbsoluteTransformsUpdateId=-1,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._waitingOverrideMeshId=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new S.c,this.bones=[],this._scene=v||A.a.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;var l=this._scene.getEngine().getCaps();this._canUseTextureForBones=l.textureFloat&&l.maxVertexTextureImageUnits>0}return Object.defineProperty(m.prototype,"useTextureToStoreBoneMatrices",{get:function(){return this._useTextureToStoreBoneMatrices},set:function(d){this._useTextureToStoreBoneMatrices=d,this._markAsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(d){this._animationPropertiesOverride=d},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"isUsingTextureForMatrices",{get:function(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),m.prototype.getClassName=function(){return"Skeleton"},m.prototype.getChildren=function(){return this.bones.filter(function(d){return!d.getParent()})},m.prototype.getTransformMatrices=function(d){return this.needInitialSkinMatrix&&d._bonesTransformMatrices?d._bonesTransformMatrices:(this._transformMatrices||this.prepare(),this._transformMatrices)},m.prototype.getTransformMatrixTexture=function(d){return this.needInitialSkinMatrix&&d._transformMatrixTexture?d._transformMatrixTexture:this._transformMatrixTexture},m.prototype.getScene=function(){return this._scene},m.prototype.toString=function(d){var g="Name: "+this.name+", nBones: "+this.bones.length;if(g+=", nAnimationRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),d){g+=", Ranges: {";var v=!0;for(var l in this._ranges)v&&(g+=", ",v=!1),g+=l;g+="}"}return g},m.prototype.getBoneIndexByName=function(d){for(var g=0,v=this.bones.length;g<v;g++)if(this.bones[g].name===d)return g;return-1},m.prototype.createAnimationRange=function(d,g,v){if(!this._ranges[d]){this._ranges[d]=new H.a(d,g,v);for(var l=0,y=this.bones.length;l<y;l++)this.bones[l].animations[0]&&this.bones[l].animations[0].createRange(d,g,v)}},m.prototype.deleteAnimationRange=function(d,g){g===void 0&&(g=!0);for(var v=0,l=this.bones.length;v<l;v++)this.bones[v].animations[0]&&this.bones[v].animations[0].deleteRange(d,g);this._ranges[d]=null},m.prototype.getAnimationRange=function(d){return this._ranges[d]||null},m.prototype.getAnimationRanges=function(){var d=[],g;for(g in this._ranges)d.push(this._ranges[g]);return d},m.prototype.copyAnimationRange=function(d,g,v){if(v===void 0&&(v=!1),this._ranges[g]||!d.getAnimationRange(g))return!1;var l=!0,y=this._getHighestAnimationFrame()+1,E={},R=d.bones,F,B;for(B=0,F=R.length;B<F;B++)E[R[B].name]=R[B];this.bones.length!==R.length&&(p.a.Warn("copyAnimationRange: this rig has "+this.bones.length+" bones, while source as "+R.length),l=!1);var L=v&&this.dimensionsAtRest&&d.dimensionsAtRest?this.dimensionsAtRest.divide(d.dimensionsAtRest):null;for(B=0,F=this.bones.length;B<F;B++){var I=this.bones[B].name,k=E[I];k?l=l&&this.bones[B].copyAnimationRange(k,g,y,v,L):(p.a.Warn("copyAnimationRange: not same rig, missing source bone "+I),l=!1)}var Z=d.getAnimationRange(g);return Z&&(this._ranges[g]=new H.a(g,Z.from+y,Z.to+y)),l},m.prototype.returnToRest=function(){for(var d=j.c.Vector3[0],g=j.c.Quaternion[0],v=j.c.Vector3[1],l=0;l<this.bones.length;l++){var y=this.bones[l];y._index!==-1&&(y.returnToRest(),y._linkedTransformNode&&(y.getRestPose().decompose(d,g,v),y._linkedTransformNode.position=v.clone(),y._linkedTransformNode.rotationQuaternion=g.clone(),y._linkedTransformNode.scaling=d.clone()))}},m.prototype._getHighestAnimationFrame=function(){for(var d=0,g=0,v=this.bones.length;g<v;g++)if(this.bones[g].animations[0]){var l=this.bones[g].animations[0].getHighestFrame();d<l&&(d=l)}return d},m.prototype.beginAnimation=function(d,g,v,l){var y=this.getAnimationRange(d);return y?this._scene.beginAnimation(this,y.from,y.to,g,v,l):null},m.MakeAnimationAdditive=function(d,g,v){g===void 0&&(g=0);var l=d.getAnimationRange(v);if(!l)return null;for(var y=d._scene.getAllAnimatablesByTarget(d),E=null,R=0;R<y.length;R++){var F=y[R];if(F.fromFrame===(l==null?void 0:l.from)&&F.toFrame===(l==null?void 0:l.to)){E=F;break}}for(var B=d.getAnimatables(),R=0;R<B.length;R++){var L=B[R],I=L.animations;if(!!I)for(var k=0;k<I.length;k++)M.a.MakeAnimationAdditive(I[k],g,v)}return E&&(E.isAdditive=!0),d},m.prototype._markAsDirty=function(){this._isDirty=!0},m.prototype._registerMeshWithPoseMatrix=function(d){this._meshesWithPoseMatrix.push(d)},m.prototype._unregisterMeshWithPoseMatrix=function(d){var g=this._meshesWithPoseMatrix.indexOf(d);g>-1&&this._meshesWithPoseMatrix.splice(g,1)},m.prototype._computeTransformMatrices=function(d,g){this.onBeforeComputeObservable.notifyObservers(this);for(var v=0;v<this.bones.length;v++){var l=this.bones[v];l._childUpdateId++;var y=l.getParent();if(y?l.getLocalMatrix().multiplyToRef(y.getWorldMatrix(),l.getWorldMatrix()):g?l.getLocalMatrix().multiplyToRef(g,l.getWorldMatrix()):l.getWorldMatrix().copyFrom(l.getLocalMatrix()),l._index!==-1){var E=l._index===null?v:l._index;l.getInvertedAbsoluteTransform().multiplyToArray(l.getWorldMatrix(),d,E*16)}}this._identity.copyToArray(d,this.bones.length*16)},m.prototype.prepare=function(){if(this._numBonesWithLinkedTransformNode>0)for(var d=0,g=this.bones;d<g.length;d++){var v=g[d];v._linkedTransformNode&&(v._linkedTransformNode.computeWorldMatrix(),v._matrix=v._linkedTransformNode._localMatrix,v.markAsDirty())}if(!!this._isDirty){if(this.needInitialSkinMatrix)for(var l=0;l<this._meshesWithPoseMatrix.length;l++){var y=this._meshesWithPoseMatrix[l],E=y.getPoseMatrix();if((!y._bonesTransformMatrices||y._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(y._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1))),this._synchronizedWithMesh!==y){this._synchronizedWithMesh=y;for(var R=0;R<this.bones.length;R++){var F=this.bones[R];if(!F.getParent()){var B=F.getBaseMatrix();B.multiplyToRef(E,j.c.Matrix[1]),F._updateDifferenceMatrix(j.c.Matrix[1])}}if(this.isUsingTextureForMatrices){var L=(this.bones.length+1)*4;(!y._transformMatrixTexture||y._transformMatrixTexture.getSize().width!==L)&&(y._transformMatrixTexture&&y._transformMatrixTexture.dispose(),y._transformMatrixTexture=O.a.CreateRGBATexture(y._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(y._bonesTransformMatrices,E),this.isUsingTextureForMatrices&&y._transformMatrixTexture&&y._transformMatrixTexture.update(y._bonesTransformMatrices)}else(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=O.a.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices);this._isDirty=!1,this._scene._activeBones.addCount(this.bones.length,!1)}},m.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var d=0;d<this.bones.length;d++)this._animatables.push(this.bones[d])}return this._animatables},m.prototype.clone=function(d,g){var v=new m(d,g||d,this._scene);v.needInitialSkinMatrix=this.needInitialSkinMatrix,v.overrideMesh=this.overrideMesh;for(var l=0;l<this.bones.length;l++){var y=this.bones[l],E=null,R=y.getParent();if(R){var F=this.bones.indexOf(R);E=v.bones[F]}var B=new T.a(y.name,v,E,y.getBaseMatrix().clone(),y.getRestPose().clone());B._index=y._index,y._linkedTransformNode&&B.linkTransformNode(y._linkedTransformNode),f.a.DeepCopy(y.animations,B.animations)}if(this._ranges){v._ranges={};for(var L in this._ranges){var I=this._ranges[L];I&&(v._ranges[L]=I.clone())}}return this._isDirty=!0,v},m.prototype.enableBlending=function(d){d===void 0&&(d=.01),this.bones.forEach(function(g){g.animations.forEach(function(v){v.enableBlending=!0,v.blendingSpeed=d})})},m.prototype.dispose=function(){this._meshesWithPoseMatrix=[],this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)},m.prototype.serialize=function(){var d,g,v={};v.name=this.name,v.id=this.id,this.dimensionsAtRest&&(v.dimensionsAtRest=this.dimensionsAtRest.asArray()),v.bones=[],v.needInitialSkinMatrix=this.needInitialSkinMatrix,v.overrideMeshId=(d=this.overrideMesh)===null||d===void 0?void 0:d.id;for(var l=0;l<this.bones.length;l++){var y=this.bones[l],E=y.getParent(),R={parentBoneIndex:E?this.bones.indexOf(E):-1,index:y.getIndex(),name:y.name,id:y.id,matrix:y.getBaseMatrix().toArray(),rest:y.getRestPose().toArray(),linkedTransformNodeId:(g=y.getTransformNode())===null||g===void 0?void 0:g.id};v.bones.push(R),y.length&&(R.length=y.length),y.metadata&&(R.metadata=y.metadata),y.animations&&y.animations.length>0&&(R.animation=y.animations[0].serialize()),v.ranges=[];for(var F in this._ranges){var B=this._ranges[F];if(!!B){var L={};L.name=F,L.from=B.from,L.to=B.to,v.ranges.push(L)}}}return v},m.Parse=function(d,g){var v=new m(d.name,d.id,g);d.dimensionsAtRest&&(v.dimensionsAtRest=j.e.FromArray(d.dimensionsAtRest)),v.needInitialSkinMatrix=d.needInitialSkinMatrix,d.overrideMeshId&&(v._hasWaitingData=!0,v._waitingOverrideMeshId=d.overrideMeshId);var l;for(l=0;l<d.bones.length;l++){var y=d.bones[l],E=d.bones[l].index,R=null;y.parentBoneIndex>-1&&(R=v.bones[y.parentBoneIndex]);var F=y.rest?j.a.FromArray(y.rest):null,B=new T.a(y.name,v,R,j.a.FromArray(y.matrix),F,null,E);y.id!==void 0&&y.id!==null&&(B.id=y.id),y.length&&(B.length=y.length),y.metadata&&(B.metadata=y.metadata),y.animation&&B.animations.push(M.a.Parse(y.animation)),y.linkedTransformNodeId!==void 0&&y.linkedTransformNodeId!==null&&(v._hasWaitingData=!0,B._waitingTransformNodeId=y.linkedTransformNodeId)}if(d.ranges)for(l=0;l<d.ranges.length;l++){var L=d.ranges[l];v.createAnimationRange(L.name,L.from,L.to)}return v},m.prototype.computeAbsoluteTransforms=function(d){d===void 0&&(d=!1);var g=this._scene.getRenderId();(this._lastAbsoluteTransformsUpdateId!=g||d)&&(this.bones[0].computeAbsoluteTransforms(),this._lastAbsoluteTransformsUpdateId=g)},m.prototype.getPoseMatrix=function(){var d=null;return this._meshesWithPoseMatrix.length>0&&(d=this._meshesWithPoseMatrix[0].getPoseMatrix()),d},m.prototype.sortBones=function(){for(var d=new Array,g=new Array(this.bones.length),v=0;v<this.bones.length;v++)this._sortBones(v,d,g);this.bones=d},m.prototype._sortBones=function(d,g,v){if(!v[d]){v[d]=!0;var l=this.bones[d];l._index===void 0&&(l._index=d);var y=l.getParent();y&&this._sortBones(this.bones.indexOf(y),g,v),g.push(l)}},m.prototype.setCurrentPoseAsRest=function(){this.bones.forEach(function(d){d.setCurrentPoseAsRest()})},m}()},561:function(Ue,P,u){"use strict";u.d(P,"a",function(){return H});var T=u(490),S=u(440),j=u(448),O=u(608),M=u(631),H=function(){function A(p){if(p===void 0&&(p=null),this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new T.a(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,p||(p=j.a.LastCreatedScene),this._scene=p,this._scene){this._scene.morphTargetManagers.push(this),this._uniqueId=this._scene.getUniqueId();var f=this._scene.getEngine().getCaps();this._canUseTextureForTargets=f.canUseGLVertexID&&f.textureFloat&&f.maxVertexTextureImageUnits>0}}return Object.defineProperty(A.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"vertexCount",{get:function(){return this._vertexCount},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"supportsNormals",{get:function(){return this._supportsNormals&&this.enableNormalMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"supportsTangents",{get:function(){return this._supportsTangents&&this.enableTangentMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"supportsUVs",{get:function(){return this._supportsUVs&&this.enableUVMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"numTargets",{get:function(){return this._targets.length},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"numInfluencers",{get:function(){return this._activeTargets.length},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"influences",{get:function(){return this._influences},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"useTextureToStoreTargets",{get:function(){return this._useTextureToStoreTargets},set:function(p){this._useTextureToStoreTargets=p},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"isUsingTextureForTargets",{get:function(){return this.useTextureToStoreTargets&&this._canUseTextureForTargets},enumerable:!1,configurable:!0}),A.prototype.getActiveTarget=function(p){return this._activeTargets.data[p]},A.prototype.getTarget=function(p){return this._targets[p]},A.prototype.addTarget=function(p){var f=this;this._targets.push(p),this._targetInfluenceChangedObservers.push(p.onInfluenceChanged.add(function(h){f._syncActiveTargets(h)})),this._targetDataLayoutChangedObservers.push(p._onDataLayoutChanged.add(function(){f._syncActiveTargets(!0)})),this._syncActiveTargets(!0)},A.prototype.removeTarget=function(p){var f=this._targets.indexOf(p);f>=0&&(this._targets.splice(f,1),p.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(f,1)[0]),p._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(f,1)[0]),this._syncActiveTargets(!0))},A.prototype._bind=function(p){p.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),p.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),p.setTexture("morphTargets",this._targetStoreTexture)},A.prototype.clone=function(){for(var p=new A(this._scene),f=0,h=this._targets;f<h.length;f++){var m=h[f];p.addTarget(m.clone())}return p.enableNormalMorphing=this.enableNormalMorphing,p.enableTangentMorphing=this.enableTangentMorphing,p.enableUVMorphing=this.enableUVMorphing,p},A.prototype.serialize=function(){var p={};p.id=this.uniqueId,p.targets=[];for(var f=0,h=this._targets;f<h.length;f++){var m=h[f];p.targets.push(m.serialize())}return p},A.prototype._syncActiveTargets=function(p){var f=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));for(var h=-1,m=0,d=this._targets;m<d.length;m++){var g=d[m];if(h++,!(g.influence===0&&this.optimizeInfluencers)){this._activeTargets.push(g),this._morphTargetTextureIndices[f]=h,this._tempInfluences[f++]=g.influence,this._supportsNormals=this._supportsNormals&&g.hasNormals,this._supportsTangents=this._supportsTangents&&g.hasTangents,this._supportsUVs=this._supportsUVs&&g.hasUVs;var v=g.getPositions();if(v){var l=v.length/3;if(this._vertexCount===0)this._vertexCount=l;else if(this._vertexCount!==l){S.a.Error("Incompatible target. Targets must all have the same vertices count.");return}}}}(!this._influences||this._influences.length!==f)&&(this._influences=new Float32Array(f));for(var y=0;y<f;y++)this._influences[y]=this._tempInfluences[y];p&&this.synchronize()},A.prototype.synchronize=function(){if(!!this._scene){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;var p=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>p&&(this._textureHeight=Math.ceil(this._textureWidth/p),this._textureWidth=p);var f=!0;if(this._targetStoreTexture){var h=this._targetStoreTexture.getSize();h.width===this._textureWidth&&h.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(f=!1)}if(f){this._targetStoreTexture&&this._targetStoreTexture.dispose();for(var m=this._targets.length,d=new Float32Array(m*this._textureWidth*this._textureHeight*4),g=0,v=0;v<m;v++){var l=this._targets[v],y=l.getPositions(),E=l.getNormals(),R=l.getUVs(),F=l.getTangents();if(!y){v===0&&S.a.Error("Invalid morph target. Target must have positions.");return}g=v*this._textureWidth*this._textureHeight*4;for(var B=0;B<this._vertexCount;B++)d[g]=y[B*3],d[g+1]=y[B*3+1],d[g+2]=y[B*3+2],g+=4,E&&(d[g]=E[B*3],d[g+1]=E[B*3+1],d[g+2]=E[B*3+2],g+=4),R&&(d[g]=R[B*2],d[g+1]=R[B*2+1],g+=4),F&&(d[g]=F[B*3],d[g+1]=F[B*3+1],d[g+2]=F[B*3+2],g+=4)}this._targetStoreTexture=M.a.CreateRGBATexture(d,this._textureWidth,this._textureHeight,m,this._scene,!1,!1,1,1)}}for(var L=0,I=this._scene.meshes;L<I.length;L++){var k=I[L];k.morphTargetManager===this&&k._syncGeometryWithMorphTargetManager()}}},A.prototype.dispose=function(){this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null},A.Parse=function(p,f){var h=new A(f);h._uniqueId=p.id;for(var m=0,d=p.targets;m<d.length;m++){var g=d[m];h.addTarget(O.a.Parse(g))}return h},A}()},565:function(Ue,P,u){"use strict";var T=u(434),S=u(467),j=u(456),O=u(440),M=u(662),H=u(709);S.a.prototype._createDepthStencilCubeTexture=function(A,p){var f=new j.a(this,j.b.Unknown);if(f.isCube=!0,this.webGLVersion===1)return O.a.Error("Depth cube texture is not supported by WebGL 1."),f;var h=Object(T.a)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},p),m=this._gl;this._bindTextureDirectly(m.TEXTURE_CUBE_MAP,f,!0),this._setupDepthStencilTexture(f,A,h.generateStencil,h.bilinearFiltering,h.comparisonFunction);for(var d=0;d<6;d++)h.generateStencil?m.texImage2D(m.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,m.DEPTH24_STENCIL8,A,A,0,m.DEPTH_STENCIL,m.UNSIGNED_INT_24_8,null):m.texImage2D(m.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,m.DEPTH_COMPONENT24,A,A,0,m.DEPTH_COMPONENT,m.UNSIGNED_INT,null);return this._bindTextureDirectly(m.TEXTURE_CUBE_MAP,null),f},S.a.prototype._partialLoadFile=function(A,p,f,h,m){m===void 0&&(m=null);var d=function(v){f[p]=v,f._internalCount++,f._internalCount===6&&h(f)},g=function(v,l){m&&v&&m(v.status+" "+v.statusText,l)};this._loadFile(A,d,void 0,void 0,!0,g)},S.a.prototype._cascadeLoadFiles=function(A,p,f,h){h===void 0&&(h=null);var m=[];m._internalCount=0;for(var d=0;d<6;d++)this._partialLoadFile(f[d],d,m,p,h)},S.a.prototype._cascadeLoadImgs=function(A,p,f,h,m,d){m===void 0&&(m=null);var g=[];g._internalCount=0;for(var v=0;v<6;v++)this._partialLoadImg(h[v],v,g,A,p,f,m,d)},S.a.prototype._partialLoadImg=function(A,p,f,h,m,d,g,v){g===void 0&&(g=null);var l=H.a.RandomId(),y=function(R){f[p]=R,f._internalCount++,h&&h._removePendingData(l),f._internalCount===6&&d&&d(m,f)},E=function(R,F){h&&h._removePendingData(l),g&&g(R,F)};M.a.LoadImage(A,y,E,h?h.offlineProvider:null,v),h&&h._addPendingData(l)},S.a.prototype._setCubeMapTextureParams=function(A,p){var f=this._gl;f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,p?f.LINEAR_MIPMAP_LINEAR:f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),A.samplingMode=p?3:2,this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null)},S.a.prototype.createCubeTextureBase=function(A,p,f,h,m,d,g,v,l,y,E,R,F,B){var L=this;m===void 0&&(m=null),d===void 0&&(d=null),v===void 0&&(v=null),l===void 0&&(l=!1),y===void 0&&(y=0),E===void 0&&(E=0),R===void 0&&(R=null),F===void 0&&(F=null),B===void 0&&(B=null);var I=R||new j.a(this,j.b.Cube);I.isCube=!0,I.url=A,I.generateMipMaps=!h,I._lodGenerationScale=y,I._lodGenerationOffset=E,this._doNotHandleContextLost||(I._extension=v,I._files=f);var k=A;this._transformTextureUrl&&!R&&(A=this._transformTextureUrl(A));for(var Z=A.lastIndexOf("."),Y=v||(Z>-1?A.substring(Z).toLowerCase():""),U=null,Q=0,G=S.a._TextureLoaders;Q<G.length;Q++){var K=G[Q];if(K.canLoad(Y)){U=K;break}}var fe=function(re,Re){A===k?d&&re&&d(re.status+" "+re.statusText,Re):(O.a.Warn("Failed to load "+A+", falling back to the "+k),L.createCubeTextureBase(k,p,f,!!h,m,d,g,v,l,y,E,I,F,B))};if(U){var ce=function(re){F&&F(I,re),U.loadCubeData(re,I,l,m,d)};f&&f.length===6?U.supportCascades?this._cascadeLoadFiles(p,function(re){return ce(re.map(function(Re){return new Uint8Array(Re)}))},f,d):d?d("Textures type does not support cascades."):O.a.Warn("Texture loader does not support cascades."):this._loadFile(A,function(re){return ce(new Uint8Array(re))},void 0,void 0,!0,fe)}else{if(!f)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(p,I,function(re,Re){B&&B(re,Re)},f,d)}return this._internalTexturesCache.push(I),I},S.a.prototype.createCubeTexture=function(A,p,f,h,m,d,g,v,l,y,E,R){var F=this;m===void 0&&(m=null),d===void 0&&(d=null),v===void 0&&(v=null),l===void 0&&(l=!1),y===void 0&&(y=0),E===void 0&&(E=0),R===void 0&&(R=null);var B=this._gl;return this.createCubeTextureBase(A,p,f,!!h,m,d,g,v,l,y,E,R,function(L,I){return F._bindTextureDirectly(B.TEXTURE_CUBE_MAP,L,!0)},function(L,I){var k=F.needPOTTextures?S.a.GetExponentOfTwo(I[0].width,F._caps.maxCubemapTextureSize):I[0].width,Z=k,Y=[B.TEXTURE_CUBE_MAP_POSITIVE_X,B.TEXTURE_CUBE_MAP_POSITIVE_Y,B.TEXTURE_CUBE_MAP_POSITIVE_Z,B.TEXTURE_CUBE_MAP_NEGATIVE_X,B.TEXTURE_CUBE_MAP_NEGATIVE_Y,B.TEXTURE_CUBE_MAP_NEGATIVE_Z];F._bindTextureDirectly(B.TEXTURE_CUBE_MAP,L,!0),F._unpackFlipY(!1);for(var U=g?F._getInternalFormat(g):F._gl.RGBA,Q=0;Q<Y.length;Q++)if(I[Q].width!==k||I[Q].height!==Z){if(F._prepareWorkingCanvas(),!F._workingCanvas||!F._workingContext){O.a.Warn("Cannot create canvas to resize texture.");return}F._workingCanvas.width=k,F._workingCanvas.height=Z,F._workingContext.drawImage(I[Q],0,0,I[Q].width,I[Q].height,0,0,k,Z),B.texImage2D(Y[Q],0,U,U,B.UNSIGNED_BYTE,F._workingCanvas)}else B.texImage2D(Y[Q],0,U,U,B.UNSIGNED_BYTE,I[Q]);h||B.generateMipmap(B.TEXTURE_CUBE_MAP),F._setCubeMapTextureParams(L,!h),L.width=k,L.height=Z,L.isReady=!0,g&&(L.format=g),L.onLoadedObservable.notifyObservers(L),L.onLoadedObservable.clear(),m&&m()})}},566:function(Ue,P,u){"use strict";u.d(P,"a",function(){return M});var T=u(442),S=u(458),j=u(486),O=u(444),M=function(){function H(){}return H.CreateResizedCopy=function(A,p,f,h){h===void 0&&(h=!0);var m=A.getScene(),d=m.getEngine(),g=new S.a("resized"+A.name,{width:p,height:f},m,!A.noMipmap,!0,A._texture.type,!1,A.samplingMode,!1);g.wrapU=A.wrapU,g.wrapV=A.wrapV,g.uOffset=A.uOffset,g.vOffset=A.vOffset,g.uScale=A.uScale,g.vScale=A.vScale,g.uAng=A.uAng,g.vAng=A.vAng,g.wAng=A.wAng,g.coordinatesIndex=A.coordinatesIndex,g.level=A.level,g.anisotropicFilteringLevel=A.anisotropicFilteringLevel,g._texture.isReady=!1,A.wrapU=T.a.CLAMP_ADDRESSMODE,A.wrapV=T.a.CLAMP_ADDRESSMODE;var v=new j.b("pass",1,null,h?T.a.BILINEAR_SAMPLINGMODE:T.a.NEAREST_SAMPLINGMODE,d,!1,0);return v.getEffect().executeWhenCompiled(function(){v.onApply=function(y){y.setTexture("textureSampler",A)};var l=g.getInternalTexture();l&&(m.postProcessManager.directRender([v],l),d.unBindFramebuffer(l),g.disposeFramebufferObjects(),v.dispose(),l.isReady=!0)}),g},H.ApplyPostProcess=function(A,p,f,h,m,d){var g=p.getEngine();return p.isReady=!1,m=m!=null?m:p.samplingMode,h=h!=null?h:p.type,d=d!=null?d:p.format,h===-1&&(h=0),new Promise(function(v){var l=new O.a("postprocess",A,null,null,1,null,m,g,!1,void 0,h,void 0,null,!1,d),y=g.createRenderTargetTexture({width:p.width,height:p.height},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:m,type:h,format:d});l.getEffect().executeWhenCompiled(function(){l.onApply=function(E){E._bindTexture("textureSampler",p),E.setFloat2("scale",1,1)},f.postProcessManager.directRender([l],y,!0),g.restoreDefaultFramebuffer(),g._releaseTexture(p),g._releaseFramebufferObjects(y),l&&l.dispose(),y._swapAndDie(p),p.type=h,p.format=5,p.isReady=!0,v(p)})})},H}()},567:function(Ue,P,u){"use strict";u.d(P,"a",function(){return g});var T=u(434),S=u(436),j=u(477),O=u(442),M=u(568),H=u(521),A=u(437),p=u(443),f=u(515),h=u(637),m=u(492),d=u(523),g=function(v){Object(T.d)(l,v);function l(y,E,R,F,B,L,I,k,Z){F===void 0&&(F=!1),B===void 0&&(B=!0),L===void 0&&(L=!1),I===void 0&&(I=!1),k===void 0&&(k=null),Z===void 0&&(Z=null);var Y,U=v.call(this,E)||this;return U._generateHarmonics=!0,U._onLoad=null,U._onError=null,U._isBlocking=!0,U._rotationY=0,U.boundingBoxPosition=S.e.Zero(),y&&(U._coordinatesMode=O.a.CUBIC_MODE,U.name=y,U.url=y,U.hasAlpha=!1,U.isCube=!0,U._textureMatrix=S.a.Identity(),U._prefilterOnLoad=I,U._onLoad=k,U._onError=Z,U.gammaSpace=L,U._noMipmap=F,U._size=R,U._generateHarmonics=B,U._texture=U._getFromCache(y,U._noMipmap),U._texture?k&&(U._texture.isReady?p.b.SetImmediate(function(){return k()}):U._texture.onLoadedObservable.add(k)):((Y=U.getScene())===null||Y===void 0?void 0:Y.useDelayedTextureLoading)?U.delayLoadState=4:U.loadTexture()),U}return Object.defineProperty(l.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(y){this._isBlocking=y},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"rotationY",{get:function(){return this._rotationY},set:function(y){this._rotationY=y,this.setReflectionTextureMatrix(S.a.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(y){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(y))){this._boundingBoxSize=y;var E=this.getScene();E&&E.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),l.prototype.getClassName=function(){return"HDRCubeTexture"},l.prototype.loadTexture=function(){var y=this,E=this._getEngine(),R=function(L){y.lodGenerationOffset=0,y.lodGenerationScale=.8;var I=M.a.GetCubeMapTextureData(L,y._size);if(y._generateHarmonics){var k=H.a.ConvertCubeMapToSphericalPolynomial(I);y.sphericalPolynomial=k}for(var Z=[],Y=null,U=0;U<6;U++){if(!E.getCaps().textureFloat){var Q=new ArrayBuffer(y._size*y._size*3);Y=new Uint8Array(Q)}var G=I[l._facesMapping[U]];if(y.gammaSpace||Y){for(var K=0;K<y._size*y._size;K++)if(y.gammaSpace&&(G[K*3+0]=Math.pow(G[K*3+0],f.b),G[K*3+1]=Math.pow(G[K*3+1],f.b),G[K*3+2]=Math.pow(G[K*3+2],f.b)),Y){var fe=Math.max(G[K*3+0]*255,0),ce=Math.max(G[K*3+1]*255,0),re=Math.max(G[K*3+2]*255,0),Re=Math.max(Math.max(fe,ce),re);if(Re>255){var Ie=255/Re;fe*=Ie,ce*=Ie,re*=Ie}Y[K*3+0]=fe,Y[K*3+1]=ce,Y[K*3+2]=re}}Y?Z.push(Y):Z.push(G)}return Z};if(E._features.allowTexturePrefiltering&&this._prefilterOnLoad){var F=this._onLoad,B=new h.a(E);this._onLoad=function(){B.prefilter(y,F)}}this._texture=E.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,E.getCaps().textureFloat?1:0,this._noMipmap,R,null,this._onLoad,this._onError)},l.prototype.clone=function(){var y=new l(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return y.level=this.level,y.wrapU=this.wrapU,y.wrapV=this.wrapV,y.coordinatesIndex=this.coordinatesIndex,y.coordinatesMode=this.coordinatesMode,y},l.prototype.delayLoad=function(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this.loadTexture())},l.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},l.prototype.setReflectionTextureMatrix=function(y){var E=this,R;this._textureMatrix=y,y.updateFlag!==this._textureMatrix.updateFlag&&y.isIdentity()!==this._textureMatrix.isIdentity()&&((R=this.getScene())===null||R===void 0||R.markAllMaterialsAsDirty(1,function(F){return F.getActiveTextures().indexOf(E)!==-1}))},l.Parse=function(y,E,R){var F=null;return y.name&&!y.isRenderTarget&&(F=new l(R+y.name,E,y.size,y.noMipmap,y.generateHarmonics,y.useInGammaSpace),F.name=y.name,F.hasAlpha=y.hasAlpha,F.level=y.level,F.coordinatesMode=y.coordinatesMode,F.isBlocking=y.isBlocking),F&&(y.boundingBoxPosition&&(F.boundingBoxPosition=S.e.FromArray(y.boundingBoxPosition)),y.boundingBoxSize&&(F.boundingBoxSize=S.e.FromArray(y.boundingBoxSize)),y.rotationY&&(F.rotationY=y.rotationY)),F},l.prototype.serialize=function(){if(!this.name)return null;var y={};return y.name=this.name,y.hasAlpha=this.hasAlpha,y.isCube=!0,y.level=this.level,y.size=this._size,y.coordinatesMode=this.coordinatesMode,y.useInGammaSpace=this.gammaSpace,y.generateHarmonics=this._generateHarmonics,y.customType="BABYLON.HDRCubeTexture",y.noMipmap=this._noMipmap,y.isBlocking=this._isBlocking,y.rotationY=this._rotationY,y},l._facesMapping=["right","left","up","down","front","back"],l}(j.a);A.a.RegisteredTypes["BABYLON.HDRCubeTexture"]=g},568:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});var T=u(569),S=function(){function j(){}return j.Ldexp=function(O,M){return M>1023?O*Math.pow(2,1023)*Math.pow(2,M-1023):M<-1074?O*Math.pow(2,-1074)*Math.pow(2,M+1074):O*Math.pow(2,M)},j.Rgbe2float=function(O,M,H,A,p,f){p>0?(p=this.Ldexp(1,p-(128+8)),O[f+0]=M*p,O[f+1]=H*p,O[f+2]=A*p):(O[f+0]=0,O[f+1]=0,O[f+2]=0)},j.readStringLine=function(O,M){for(var H="",A="",p=M;p<O.length-M&&(A=String.fromCharCode(O[p]),A!=`
`);p++)H+=A;return H},j.RGBE_ReadHeader=function(O){var M=0,H=0,A=this.readStringLine(O,0);if(A[0]!="#"||A[1]!="?")throw"Bad HDR Format.";var p=!1,f=!1,h=0;do h+=A.length+1,A=this.readStringLine(O,h),A=="FORMAT=32-bit_rle_rgbe"?f=!0:A.length==0&&(p=!0);while(!p);if(!f)throw"HDR Bad header format, unsupported FORMAT";h+=A.length+1,A=this.readStringLine(O,h);var m=/^\-Y (.*) \+X (.*)$/g,d=m.exec(A);if(!d||d.length<3)throw"HDR Bad header format, no size";if(H=parseInt(d[2]),M=parseInt(d[1]),H<8||H>32767)throw"HDR Bad header format, unsupported size";return h+=A.length+1,{height:M,width:H,dataPosition:h}},j.GetCubeMapTextureData=function(O,M){var H=new Uint8Array(O),A=this.RGBE_ReadHeader(H),p=this.RGBE_ReadPixels(H,A),f=T.a.ConvertPanoramaToCubemap(p,A.width,A.height,M);return f},j.RGBE_ReadPixels=function(O,M){return this.RGBE_ReadPixels_RLE(O,M)},j.RGBE_ReadPixels_RLE=function(O,M){for(var H=M.height,A=M.width,p,f,h,m,d,g=M.dataPosition,v=0,l=0,y=0,E=new ArrayBuffer(A*4),R=new Uint8Array(E),F=new ArrayBuffer(M.width*M.height*4*3),B=new Float32Array(F);H>0;){if(p=O[g++],f=O[g++],h=O[g++],m=O[g++],p!=2||f!=2||h&128||M.width<8||M.width>32767)return this.RGBE_ReadPixels_NOT_RLE(O,M);if((h<<8|m)!=A)throw"HDR Bad header format, wrong scan line width";for(v=0,y=0;y<4;y++)for(l=(y+1)*A;v<l;)if(p=O[g++],f=O[g++],p>128){if(d=p-128,d==0||d>l-v)throw"HDR Bad Format, bad scanline data (run)";for(;d-- >0;)R[v++]=f}else{if(d=p,d==0||d>l-v)throw"HDR Bad Format, bad scanline data (non-run)";if(R[v++]=f,--d>0)for(var L=0;L<d;L++)R[v++]=O[g++]}for(y=0;y<A;y++)p=R[y],f=R[y+A],h=R[y+2*A],m=R[y+3*A],this.Rgbe2float(B,p,f,h,m,(M.height-H)*A*3+y*3);H--}return B},j.RGBE_ReadPixels_NOT_RLE=function(O,M){for(var H=M.height,A=M.width,p,f,h,m,d,g=M.dataPosition,v=new ArrayBuffer(M.width*M.height*4*3),l=new Float32Array(v);H>0;){for(d=0;d<M.width;d++)p=O[g++],f=O[g++],h=O[g++],m=O[g++],this.Rgbe2float(l,p,f,h,m,(M.height-H)*A*3+d*3);H--}return l},j}()},569:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});var T=u(436),S=function(){function j(){}return j.ConvertPanoramaToCubemap=function(O,M,H,A){if(!O)throw"ConvertPanoramaToCubemap: input cannot be null";if(O.length!=M*H*3)throw"ConvertPanoramaToCubemap: input size is wrong";var p=this.CreateCubemapTexture(A,this.FACE_FRONT,O,M,H),f=this.CreateCubemapTexture(A,this.FACE_BACK,O,M,H),h=this.CreateCubemapTexture(A,this.FACE_LEFT,O,M,H),m=this.CreateCubemapTexture(A,this.FACE_RIGHT,O,M,H),d=this.CreateCubemapTexture(A,this.FACE_UP,O,M,H),g=this.CreateCubemapTexture(A,this.FACE_DOWN,O,M,H);return{front:p,back:f,left:h,right:m,up:d,down:g,size:A,type:1,format:4,gammaSpace:!1}},j.CreateCubemapTexture=function(O,M,H,A,p){for(var f=new ArrayBuffer(O*O*4*3),h=new Float32Array(f),m=M[1].subtract(M[0]).scale(1/O),d=M[3].subtract(M[2]).scale(1/O),g=1/O,v=0,l=0;l<O;l++){for(var y=M[0],E=M[2],R=0;R<O;R++){var F=E.subtract(y).scale(v).add(y);F.normalize();var B=this.CalcProjectionSpherical(F,H,A,p);h[l*O*3+R*3+0]=B.r,h[l*O*3+R*3+1]=B.g,h[l*O*3+R*3+2]=B.b,y=y.add(m),E=E.add(d)}v+=g}return h},j.CalcProjectionSpherical=function(O,M,H,A){for(var p=Math.atan2(O.z,O.x),f=Math.acos(O.y);p<-Math.PI;)p+=2*Math.PI;for(;p>Math.PI;)p-=2*Math.PI;var h=p/Math.PI,m=f/Math.PI;h=h*.5+.5;var d=Math.round(h*H);d<0?d=0:d>=H&&(d=H-1);var g=Math.round(m*A);g<0?g=0:g>=A&&(g=A-1);var v=A-g-1,l=M[v*H*3+d*3+0],y=M[v*H*3+d*3+1],E=M[v*H*3+d*3+2];return{r:l,g:y,b:E}},j.FACE_LEFT=[new T.e(-1,-1,-1),new T.e(1,-1,-1),new T.e(-1,1,-1),new T.e(1,1,-1)],j.FACE_RIGHT=[new T.e(1,-1,1),new T.e(-1,-1,1),new T.e(1,1,1),new T.e(-1,1,1)],j.FACE_FRONT=[new T.e(1,-1,-1),new T.e(1,-1,1),new T.e(1,1,-1),new T.e(1,1,1)],j.FACE_BACK=[new T.e(-1,-1,1),new T.e(-1,-1,-1),new T.e(-1,1,1),new T.e(-1,1,-1)],j.FACE_DOWN=[new T.e(1,1,-1),new T.e(1,1,1),new T.e(-1,1,-1),new T.e(-1,1,1)],j.FACE_UP=[new T.e(-1,-1,-1),new T.e(-1,-1,1),new T.e(1,-1,-1),new T.e(1,-1,1)],j}()},570:function(Ue,P,u){"use strict";u.d(P,"b",function(){return p}),u.d(P,"a",function(){return f});var T=u(434),S=u(436),j=u(442),O=u(466),M=u(582),H=u(580),A=u(583),p;(function(h){h[h.Low=0]="Low",h[h.Medium=1]="Medium",h[h.High=2]="High"})(p||(p={}));var f=function(h){Object(T.d)(m,h);function m(d,g,v,l,y){v===void 0&&(v=p.Low),l===void 0&&(l=0),y===void 0&&(y=!1);var E=h.call(this,d.getEngine(),"depth of field",function(){return E._effects},!0)||this;E._effects=[],E._circleOfConfusion=new M.a("circleOfConfusion",g,1,null,j.a.BILINEAR_SAMPLINGMODE,d.getEngine(),!1,l,y),E._depthOfFieldBlurY=[],E._depthOfFieldBlurX=[];var R=1,F=15;switch(v){case p.High:{R=3,F=51;break}case p.Medium:{R=2,F=31;break}default:{F=15,R=1;break}}for(var B=F/Math.pow(2,R-1),L=1,I=0;I<R;I++){var k=new H.a("vertical blur",d,new S.d(0,1),B,L,null,E._circleOfConfusion,I==0?E._circleOfConfusion:null,j.a.BILINEAR_SAMPLINGMODE,d.getEngine(),!1,l,y);k.autoClear=!1,L=.75/Math.pow(2,I);var Z=new H.a("horizontal blur",d,new S.d(1,0),B,L,null,E._circleOfConfusion,null,j.a.BILINEAR_SAMPLINGMODE,d.getEngine(),!1,l,y);Z.autoClear=!1,E._depthOfFieldBlurY.push(k),E._depthOfFieldBlurX.push(Z)}E._effects=[E._circleOfConfusion];for(var I=0;I<E._depthOfFieldBlurX.length;I++)E._effects.push(E._depthOfFieldBlurY[I]),E._effects.push(E._depthOfFieldBlurX[I]);return E._dofMerge=new A.a("dofMerge",E._circleOfConfusion,E._circleOfConfusion,E._depthOfFieldBlurX,L,null,j.a.BILINEAR_SAMPLINGMODE,d.getEngine(),!1,l,y),E._dofMerge.autoClear=!1,E._effects.push(E._dofMerge),E}return Object.defineProperty(m.prototype,"focalLength",{get:function(){return this._circleOfConfusion.focalLength},set:function(d){this._circleOfConfusion.focalLength=d},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"fStop",{get:function(){return this._circleOfConfusion.fStop},set:function(d){this._circleOfConfusion.fStop=d},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"focusDistance",{get:function(){return this._circleOfConfusion.focusDistance},set:function(d){this._circleOfConfusion.focusDistance=d},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"lensSize",{get:function(){return this._circleOfConfusion.lensSize},set:function(d){this._circleOfConfusion.lensSize=d},enumerable:!1,configurable:!0}),m.prototype.getClassName=function(){return"DepthOfFieldEffect"},Object.defineProperty(m.prototype,"depthTexture",{set:function(d){this._circleOfConfusion.depthTexture=d},enumerable:!1,configurable:!0}),m.prototype.disposeEffects=function(d){for(var g=0;g<this._effects.length;g++)this._effects[g].dispose(d)},m.prototype._updateEffects=function(){for(var d=0;d<this._effects.length;d++)this._effects[d].updateEffect()},m.prototype._isReady=function(){for(var d=0;d<this._effects.length;d++)if(!this._effects[d].isReady())return!1;return!0},m}(O.a)},571:function(Ue,P,u){"use strict";u.d(P,"a",function(){return l});var T=u(434),S=u(440),j=u(436),O=u(444),M=u(502),H=function(){function y(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}return y}(),A=u(530),p=u(547),f=u(435),h="motionBlurPixelShader",m=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float motionStrength;
uniform float motionScale;
uniform vec2 screenSize;
#ifdef OBJECT_BASED
uniform sampler2D velocitySampler;
#else
uniform sampler2D depthSampler;
uniform mat4 inverseViewProjection;
uniform mat4 prevViewProjection;
#endif
void main(void)
{
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
vec2 texelSize=1.0/screenSize;
vec2 velocityColor=texture2D(velocitySampler,vUV).rg*2.0-1.0;
vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0));
velocity*=motionScale*motionStrength;
float speed=length(velocity/texelSize);
int samplesCount=int(clamp(speed,1.0,SAMPLES));
velocity=normalize(velocity)*texelSize;
float hlim=float(-samplesCount)*0.5+0.5;
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(SAMPLES); ++i)
{
if (i>=samplesCount)
break;
vec2 offset=vUV+velocity*(hlim+float(i));
result+=texture2D(textureSampler,offset);
}
gl_FragColor=result/float(samplesCount);
gl_FragColor.a=1.0;
#else
vec2 texelSize=1.0/screenSize;
float depth=texture2D(depthSampler,vUV).r;
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);
cpos=cpos*inverseViewProjection;
vec4 ppos=cpos*prevViewProjection;
ppos.xyz/=ppos.w;
ppos.xy=ppos.xy*0.5+0.5;
vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;
float speed=length(velocity/texelSize);
int nSamples=int(clamp(speed,1.0,SAMPLES));
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(SAMPLES); ++i) {
if (i>=nSamples)
break;
vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
result+=texture2D(textureSampler,offset1);
}
gl_FragColor=result/float(nSamples);
#endif
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;f.a.ShadersStore[h]=m;var d={name:h,shader:m},g=u(439),v=u(437),l=function(y){Object(T.d)(E,y);function E(R,F,B,L,I,k,Z,Y,U,Q){Y===void 0&&(Y=0),U===void 0&&(U=!1),Q===void 0&&(Q=!1);var G=y.call(this,R,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection"],["velocitySampler"],B,L,I,k,Z,`#define GEOMETRY_SUPPORTED
#define SAMPLES 64.0
#define OBJECT_BASED`,Y,void 0,null,U)||this;return G.motionStrength=1,G._motionBlurSamples=32,G._isObjectBased=!0,G._forceGeometryBuffer=!1,G._geometryBufferRenderer=null,G._prePassRenderer=null,G._invViewProjection=null,G._previousViewProjection=null,G._forceGeometryBuffer=Q,G._forceGeometryBuffer?(G._geometryBufferRenderer=F.enableGeometryBufferRenderer(),G._geometryBufferRenderer&&(G._geometryBufferRenderer.enableVelocity=!0)):(G._prePassRenderer=F.enablePrePassRenderer(),G._prePassRenderer&&(G._prePassRenderer.markAsDirty(),G._prePassEffectConfiguration=new H)),G._applyMode(),G}return Object.defineProperty(E.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(R){this._motionBlurSamples=R,this._updateEffect()},enumerable:!1,configurable:!0}),Object.defineProperty(E.prototype,"isObjectBased",{get:function(){return this._isObjectBased},set:function(R){this._isObjectBased!==R&&(this._isObjectBased=R,this._applyMode())},enumerable:!1,configurable:!0}),E.prototype.getClassName=function(){return"MotionBlurPostProcess"},E.prototype.excludeSkinnedMesh=function(R){if(R.skeleton){var F=void 0;if(this._geometryBufferRenderer)F=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)F=this._prePassRenderer.excludedSkinnedMesh;else return;F.push(R)}},E.prototype.removeExcludedSkinnedMesh=function(R){if(R.skeleton){var F=void 0;if(this._geometryBufferRenderer)F=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)F=this._prePassRenderer.excludedSkinnedMesh;else return;var B=F.indexOf(R);B!==-1&&F.splice(B,1)}},E.prototype.dispose=function(R){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),y.prototype.dispose.call(this,R)},E.prototype._applyMode=function(){var R=this;if(!this._geometryBufferRenderer&&!this._prePassRenderer)return S.a.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=function(F){return R._onApplyObjectBased(F)}):(this._invViewProjection=j.a.Identity(),this._previousViewProjection=j.a.Identity(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=function(F){return R._onApplyScreenBased(F)})},E.prototype._onApplyObjectBased=function(R){if(R.setVector2("screenSize",new j.d(this.width,this.height)),R.setFloat("motionScale",this._scene.getAnimationRatio()),R.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){var F=this._geometryBufferRenderer.getTextureIndex(M.a.VELOCITY_TEXTURE_TYPE);R.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[F])}else if(this._prePassRenderer){var F=this._prePassRenderer.getIndex(2);R.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[F])}},E.prototype._onApplyScreenBased=function(R){var F=this._scene.getProjectionMatrix().multiply(this._scene.getViewMatrix());if(F.invertToRef(this._invViewProjection),R.setMatrix("inverseViewProjection",this._invViewProjection),R.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection=F,R.setVector2("screenSize",new j.d(this.width,this.height)),R.setFloat("motionScale",this._scene.getAnimationRatio()),R.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){var B=this._geometryBufferRenderer.getTextureIndex(M.a.DEPTH_TEXTURE_TYPE);R.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[B])}else if(this._prePassRenderer){var B=this._prePassRenderer.getIndex(5);R.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[B])}},E.prototype._updateEffect=function(){if(this._geometryBufferRenderer||this._prePassRenderer){var R=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(R.join(`
`))}},E._Parse=function(R,F,B,L){return g.a.Parse(function(){return new E(R.name,B,R.options,F,R.renderTargetSamplingMode,B.getEngine(),R.reusable,R.textureType,!1)},R,B,L)},Object(T.c)([Object(g.c)()],E.prototype,"motionStrength",void 0),Object(T.c)([Object(g.c)()],E.prototype,"motionBlurSamples",null),Object(T.c)([Object(g.c)()],E.prototype,"isObjectBased",null),E}(O.a);v.a.RegisteredTypes["BABYLON.MotionBlurPostProcess"]=l},572:function(Ue,P,u){"use strict";u.d(P,"a",function(){return h});var T=u(436),S=u(441),j=u(483),O=u(700),M=Object.freeze(new T.b(0,0,0,0)),H=Object.freeze(T.e.Zero()),A=Object.freeze(T.d.Zero()),p=Object.freeze(O.a.Zero()),f=Object.freeze(S.a.Black()),h=function(){function m(d,g,v,l){var y=this;if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=g,this._target=d,this._scene=v,this._host=l,this._activeTargets=[],g._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===j.a.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=T.a.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){var E={frame:0,value:this._minValue};this._keys.splice(0,0,E)}if(this._target instanceof Array){for(var R=0,F=0,B=this._target;F<B.length;F++){var L=B[F];this._preparePath(L,R),this._getOriginalValues(R),R++}this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];var I=g.getEvents();I&&I.length>0&&I.forEach(function(k){y._events.push(k._clone())}),this._enableBlending=d&&d.animationPropertiesOverride?d.animationPropertiesOverride.enableBlending:this._animation.enableBlending}return Object.defineProperty(m.prototype,"currentFrame",{get:function(){return this._currentFrame},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"weight",{get:function(){return this._weight},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"currentValue",{get:function(){return this._currentValue},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"targetPath",{get:function(){return this._targetPath},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"target",{get:function(){return this._currentActiveTarget},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"isAdditive",{get:function(){return this._host&&this._host.isAdditive},enumerable:!1,configurable:!0}),m.prototype._preparePath=function(d,g){g===void 0&&(g=0);var v=this._animation.targetPropertyPath;if(v.length>1){for(var l=d[v[0]],y=1;y<v.length-1;y++)l=l[v[y]];this._targetPath=v[v.length-1],this._activeTargets[g]=l}else this._targetPath=v[0],this._activeTargets[g]=d},Object.defineProperty(m.prototype,"animation",{get:function(){return this._animation},enumerable:!1,configurable:!0}),m.prototype.reset=function(d){if(d===void 0&&(d=!1),d)if(this._target instanceof Array)for(var g=0,v=0,l=this._target;v<l.length;v++){var y=l[v];this._originalValue[g]!==void 0&&this._setValue(y,this._activeTargets[g],this._originalValue[g],-1,g),g++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(var g=0;g<this._events.length;g++)this._events[g].isDone=!1},m.prototype.isStopped=function(){return this._stopped},m.prototype.dispose=function(){var d=this._animation.runtimeAnimations.indexOf(this);d>-1&&this._animation.runtimeAnimations.splice(d,1)},m.prototype.setValue=function(d,g){if(this._targetIsArray){for(var v=0;v<this._target.length;v++){var l=this._target[v];this._setValue(l,this._activeTargets[v],d,g,v)}return}this._setValue(this._target,this._directTarget,d,g,0)},m.prototype._getOriginalValues=function(d){d===void 0&&(d=0);var g,v=this._activeTargets[d];v.getRestPose&&this._targetPath==="_matrix"?g=v.getRestPose():g=v[this._targetPath],g&&g.clone?this._originalValue[d]=g.clone():this._originalValue[d]=g},m.prototype._setValue=function(d,g,v,l,y){if(this._currentActiveTarget=g,this._weight=l,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){var E=g[this._targetPath];E.clone?this._originalBlendValue=E.clone():this._originalBlendValue=E}this._originalBlendValue.m?j.a.AllowMatrixDecomposeForInterpolation?this._currentValue?T.a.DecomposeLerpToRef(this._originalBlendValue,v,this._blendingFactor,this._currentValue):this._currentValue=T.a.DecomposeLerp(this._originalBlendValue,v,this._blendingFactor):this._currentValue?T.a.LerpToRef(this._originalBlendValue,v,this._blendingFactor,this._currentValue):this._currentValue=T.a.Lerp(this._originalBlendValue,v,this._blendingFactor):this._currentValue=j.a._UniversalLerp(this._originalBlendValue,v,this._blendingFactor);var R=d&&d.animationPropertiesOverride?d.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=R}else this._currentValue=v;l!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[y]):g[this._targetPath]=this._currentValue,d.markAsDirty&&d.markAsDirty(this._animation.targetProperty)},m.prototype._getCorrectLoopMode=function(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode},m.prototype.goToFrame=function(d){var g=this._animation.getKeys();d<g[0].frame?d=g[0].frame:d>g[g.length-1].frame&&(d=g[g.length-1].frame);var v=this._events;if(v.length)for(var l=0;l<v.length;l++)v[l].onlyOnce||(v[l].isDone=v[l].frame<d);this._currentFrame=d;var y=this._animation._interpolate(d,this._animationState);this.setValue(y,-1)},m.prototype._prepareForSpeedRatioChange=function(d){var g=this._previousDelay*(this._animation.framePerSecond*d)/1e3;this._ratioOffset=this._previousRatio-g},m.prototype.animate=function(d,g,v,l,y,E){E===void 0&&(E=-1);var R=this._animation,F=R.targetPropertyPath;if(!F||F.length<1)return this._stopped=!0,!1;var B=!0;(g<this._minFrame||g>this._maxFrame)&&(g=this._minFrame),(v<this._minFrame||v>this._maxFrame)&&(v=this._maxFrame);var L=v-g,I,k=d*(R.framePerSecond*y)/1e3+this._ratioOffset,Z=0;if(this._previousDelay=d,this._previousRatio=k,!l&&v>=g&&k>=L)B=!1,Z=R._getKeyValue(this._maxValue);else if(!l&&g>=v&&k<=L)B=!1,Z=R._getKeyValue(this._minValue);else if(this._animationState.loopMode!==j.a.ANIMATIONLOOPMODE_CYCLE){var Y=v.toString()+g.toString();if(!this._offsetsCache[Y]){this._animationState.repeatCount=0,this._animationState.loopMode=j.a.ANIMATIONLOOPMODE_CYCLE;var U=R._interpolate(g,this._animationState),Q=R._interpolate(v,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),R.dataType){case j.a.ANIMATIONTYPE_FLOAT:this._offsetsCache[Y]=Q-U;break;case j.a.ANIMATIONTYPE_QUATERNION:this._offsetsCache[Y]=Q.subtract(U);break;case j.a.ANIMATIONTYPE_VECTOR3:this._offsetsCache[Y]=Q.subtract(U);break;case j.a.ANIMATIONTYPE_VECTOR2:this._offsetsCache[Y]=Q.subtract(U);break;case j.a.ANIMATIONTYPE_SIZE:this._offsetsCache[Y]=Q.subtract(U);break;case j.a.ANIMATIONTYPE_COLOR3:this._offsetsCache[Y]=Q.subtract(U);break;default:break}this._highLimitsCache[Y]=Q}Z=this._highLimitsCache[Y],I=this._offsetsCache[Y]}if(I===void 0)switch(R.dataType){case j.a.ANIMATIONTYPE_FLOAT:I=0;break;case j.a.ANIMATIONTYPE_QUATERNION:I=M;break;case j.a.ANIMATIONTYPE_VECTOR3:I=H;break;case j.a.ANIMATIONTYPE_VECTOR2:I=A;break;case j.a.ANIMATIONTYPE_SIZE:I=p;break;case j.a.ANIMATIONTYPE_COLOR3:I=f}var G;if(this._host&&this._host.syncRoot){var K=this._host.syncRoot,fe=(K.masterFrame-K.fromFrame)/(K.toFrame-K.fromFrame);G=g+(v-g)*fe}else G=B&&L!==0?g+k%L:v;var ce=this._events;if((L>0&&this.currentFrame>G||L<0&&this.currentFrame<G)&&(this._onLoop(),ce.length))for(var re=0;re<ce.length;re++)ce[re].onlyOnce||(ce[re].isDone=!1);this._currentFrame=G,this._animationState.repeatCount=L===0?0:k/L>>0,this._animationState.highLimitValue=Z,this._animationState.offsetValue=I;var Re=R._interpolate(G,this._animationState);if(this.setValue(Re,E),ce.length){for(var re=0;re<ce.length;re++)if(L>0&&G>=ce[re].frame&&ce[re].frame>=g||L<0&&G<=ce[re].frame&&ce[re].frame<=g){var Ie=ce[re];Ie.isDone||(Ie.onlyOnce&&(ce.splice(re,1),re--),Ie.isDone=!0,Ie.action(G))}}return B||(this._stopped=!0),B},m}()},573:function(Ue,P,u){"use strict";u.d(P,"a",function(){return d});var T=u(434),S=u(438),j=u(436),O=u(499),M=u(446),H=u(494),A=u(505),p=u(471),f=u(461),h=u(455),m=u(441),d=function(g){Object(T.d)(v,g);function v(l,y,E,R,F){y===void 0&&(y=m.a.Gray()),E===void 0&&(E=f.a.DefaultUtilityLayer),R===void 0&&(R=null),F===void 0&&(F=1);var B,L=g.call(this,E)||this;L._pointerObserver=null,L.snapDistance=0,L.onSnapObservable=new S.c,L._isEnabled=!0,L._parent=null,L._dragging=!1,L._parent=R,L._coloredMaterial=new h.a("",E.utilityLayerScene),L._coloredMaterial.diffuseColor=y,L._coloredMaterial.specularColor=y.subtract(new m.a(.1,.1,.1)),L._hoverMaterial=new h.a("",E.utilityLayerScene),L._hoverMaterial.diffuseColor=m.a.Yellow(),L._disableMaterial=new h.a("",E.utilityLayerScene),L._disableMaterial.diffuseColor=m.a.Gray(),L._disableMaterial.alpha=.4;var I=v._CreateArrow(E.utilityLayerScene,L._coloredMaterial,F),k=v._CreateArrow(E.utilityLayerScene,L._coloredMaterial,F+4,!0);L._gizmoMesh=new M.a("",E.utilityLayerScene),L._gizmoMesh.addChild(I),L._gizmoMesh.addChild(k),L._gizmoMesh.lookAt(L._rootMesh.position.add(l)),L._gizmoMesh.scaling.scaleInPlace(1/3),L._gizmoMesh.parent=L._rootMesh;var Z=0,Y=new j.e,U={snapDistance:0};L.dragBehavior=new A.a({dragAxis:l}),L.dragBehavior.moveAttached=!1,L._rootMesh.addBehavior(L.dragBehavior),L.dragBehavior.onDragObservable.add(function(K){if(L.attachedNode){if(L.snapDistance==0)L.attachedNode.position&&L.attachedNode.position.addInPlaceFromFloats(K.delta.x,K.delta.y,K.delta.z),L.attachedNode.getWorldMatrix().addTranslationFromFloats(K.delta.x,K.delta.y,K.delta.z),L.attachedNode.updateCache();else if(Z+=K.dragDistance,Math.abs(Z)>L.snapDistance){var fe=Math.floor(Math.abs(Z)/L.snapDistance);Z=Z%L.snapDistance,K.delta.normalizeToRef(Y),Y.scaleInPlace(L.snapDistance*fe),L.attachedNode.getWorldMatrix().addTranslationFromFloats(Y.x,Y.y,Y.z),L.attachedNode.updateCache(),U.snapDistance=L.snapDistance*fe,L.onSnapObservable.notifyObservers(U)}L._matrixChanged()}}),L.dragBehavior.onDragStartObservable.add(function(){L._dragging=!0}),L.dragBehavior.onDragEndObservable.add(function(){L._dragging=!1});var Q=E._getSharedGizmoLight();Q.includedOnlyMeshes=Q.includedOnlyMeshes.concat(L._rootMesh.getChildMeshes(!1));var G={gizmoMeshes:I.getChildMeshes(),colliderMeshes:k.getChildMeshes(),material:L._coloredMaterial,hoverMaterial:L._hoverMaterial,disableMaterial:L._disableMaterial,active:!1};return(B=L._parent)===null||B===void 0||B.addToAxisCache(k,G),L._pointerObserver=E.utilityLayerScene.onPointerObservable.add(function(K){var fe;if(!L._customMeshSet&&(L._isHovered=G.colliderMeshes.indexOf((fe=K==null?void 0:K.pickInfo)===null||fe===void 0?void 0:fe.pickedMesh)!=-1,!L._parent)){var ce=L._isHovered||L._dragging?L._hoverMaterial:L._coloredMaterial;G.gizmoMeshes.forEach(function(re){re.material=ce,re.color&&(re.color=ce.diffuseColor)})}}),L}return v._CreateArrow=function(l,y,E,R){E===void 0&&(E=1),R===void 0&&(R=!1);var F=new O.a("arrow",l),B=H.a.CreateCylinder("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(E-1)/4),tessellation:96},l),L=H.a.CreateCylinder("cylinder",{diameterTop:.005*E,height:.275,diameterBottom:.005*E,tessellation:96},l);return B.parent=F,B.material=y,B.rotation.x=Math.PI/2,B.position.z+=.3,L.parent=F,L.material=y,L.position.z+=.275/2,L.rotation.x=Math.PI/2,R&&(L.visibility=0,B.visibility=0),F},v._CreateArrowInstance=function(l,y){for(var E=new O.a("arrow",l),R=0,F=y.getChildMeshes();R<F.length;R++){var B=F[R],L=B.createInstance(B.name);L.parent=E}return E},v.prototype._attachedNodeChanged=function(l){this.dragBehavior&&(this.dragBehavior.enabled=!!l)},Object.defineProperty(v.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(l){this._isEnabled=l,l?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)},enumerable:!1,configurable:!0}),v.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(l){l&&l.dispose()}),g.prototype.dispose.call(this)},v}(p.a)},574:function(Ue,P,u){"use strict";var T=u(456),S=u(440),j=u(467);j.a.prototype.restoreSingleAttachment=function(){var O=this._gl;this.bindAttachments([O.BACK])},j.a.prototype.restoreSingleAttachmentForRenderTarget=function(){var O=this._gl;this.bindAttachments([O.COLOR_ATTACHMENT0])},j.a.prototype.buildTextureLayout=function(O){for(var M=this._gl,H=[],A=0;A<O.length;A++)O[A]?H.push(M["COLOR_ATTACHMENT"+A]):H.push(M.NONE);return H},j.a.prototype.bindAttachments=function(O){var M=this._gl;M.drawBuffers(O)},j.a.prototype.clearAttachments=function(O,M,H,A,p){if(O.length!==0){var f=this._gl;f.drawBuffers([O[0]]),this.clear(M,M!==null,A,p);var h=O[0];O[0]=f.NONE,f.drawBuffers(O),this.clear(H,H!==null,!1,!1),O[0]=h}},j.a.prototype.unBindMultiColorAttachmentFramebuffer=function(O,M,H){M===void 0&&(M=!1),this._currentRenderTarget=null;var A=this._gl,p=O[0]._attachments,f=p.length;if(O[0]._MSAAFramebuffer){A.bindFramebuffer(A.READ_FRAMEBUFFER,O[0]._MSAAFramebuffer),A.bindFramebuffer(A.DRAW_FRAMEBUFFER,O[0]._framebuffer);for(var h=0;h<f;h++){for(var m=O[h],d=0;d<f;d++)p[d]=A.NONE;p[h]=A[this.webGLVersion>1?"COLOR_ATTACHMENT"+h:"COLOR_ATTACHMENT"+h+"_WEBGL"],A.readBuffer(p[h]),A.drawBuffers(p),A.blitFramebuffer(0,0,m.width,m.height,0,0,m.width,m.height,A.COLOR_BUFFER_BIT,A.NEAREST)}for(var h=0;h<f;h++)p[h]=A[this.webGLVersion>1?"COLOR_ATTACHMENT"+h:"COLOR_ATTACHMENT"+h+"_WEBGL"];A.drawBuffers(p)}for(var h=0;h<f;h++){var m=O[h];m.generateMipMaps&&!M&&!m.isCube&&(this._bindTextureDirectly(A.TEXTURE_2D,m,!0),A.generateMipmap(A.TEXTURE_2D),this._bindTextureDirectly(A.TEXTURE_2D,null))}H&&(O[0]._MSAAFramebuffer&&this._bindUnboundFramebuffer(O[0]._framebuffer),H()),this._bindUnboundFramebuffer(null)},j.a.prototype.createMultipleRenderTarget=function(O,M,H){H===void 0&&(H=!0);var A=!1,p=!0,f=!1,h=!1,m=1,d=0,g=3,v=new Array,l=new Array;M!==void 0&&(A=M.generateMipMaps===void 0?!1:M.generateMipMaps,p=M.generateDepthBuffer===void 0?!0:M.generateDepthBuffer,f=M.generateStencilBuffer===void 0?!1:M.generateStencilBuffer,h=M.generateDepthTexture===void 0?!1:M.generateDepthTexture,m=M.textureCount||1,M.types&&(v=M.types),M.samplingModes&&(l=M.samplingModes));var y=this._gl,E=y.createFramebuffer();this._bindUnboundFramebuffer(E);for(var R=O.width||O,F=O.height||O,B=[],L=[],I=this._setupFramebufferDepthAttachments(f,p,R,F),k=0;k<m;k++){var Z=l[k]||g,Y=v[k]||d;(Y===1&&!this._caps.textureFloatLinearFiltering||Y===2&&!this._caps.textureHalfFloatLinearFiltering)&&(Z=1);var U=this._getSamplingParameters(Z,A);Y===1&&!this._caps.textureFloat&&(Y=0,S.a.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var Q=new T.a(this,T.b.MultiRenderTarget),G=y[this.webGLVersion>1?"COLOR_ATTACHMENT"+k:"COLOR_ATTACHMENT"+k+"_WEBGL"];B.push(Q),L.push(G),y.activeTexture(y["TEXTURE"+k]),y.bindTexture(y.TEXTURE_2D,Q._hardwareTexture.underlyingResource),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,U.mag),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,U.min),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texImage2D(y.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(Y),R,F,0,y.RGBA,this._getWebGLTextureType(Y),null),y.framebufferTexture2D(y.DRAW_FRAMEBUFFER,G,y.TEXTURE_2D,Q._hardwareTexture.underlyingResource,0),A&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(y.TEXTURE_2D,null),Q._framebuffer=E,Q._depthStencilBuffer=I,Q.baseWidth=R,Q.baseHeight=F,Q.width=R,Q.height=F,Q.isReady=!0,Q.samples=1,Q.generateMipMaps=A,Q.samplingMode=Z,Q.type=Y,Q._generateDepthBuffer=p,Q._generateStencilBuffer=f,Q._attachments=L,Q._textureArray=B,this._internalTexturesCache.push(Q)}if(h&&this._caps.depthTextureExtension){var K=new T.a(this,T.b.MultiRenderTarget);y.activeTexture(y.TEXTURE0),y.bindTexture(y.TEXTURE_2D,K._hardwareTexture.underlyingResource),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,y.NEAREST),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,y.NEAREST),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texImage2D(y.TEXTURE_2D,0,this.webGLVersion<2?y.DEPTH_COMPONENT:y.DEPTH_COMPONENT16,R,F,0,y.DEPTH_COMPONENT,y.UNSIGNED_SHORT,null),y.framebufferTexture2D(y.FRAMEBUFFER,y.DEPTH_ATTACHMENT,y.TEXTURE_2D,K._hardwareTexture.underlyingResource,0),K._framebuffer=E,K.baseWidth=R,K.baseHeight=F,K.width=R,K.height=F,K.isReady=!0,K.samples=1,K.generateMipMaps=A,K.samplingMode=y.NEAREST,K._generateDepthBuffer=p,K._generateStencilBuffer=f,B.push(K),this._internalTexturesCache.push(K)}return H&&y.drawBuffers(L),this._bindUnboundFramebuffer(null),this.resetTextureCache(),B},j.a.prototype.updateMultipleRenderTargetTextureSampleCount=function(O,M,H){if(H===void 0&&(H=!0),this.webGLVersion<2||!O)return 1;if(O[0].samples===M)return M;var A=O[0]._attachments.length;if(A===0)return 1;var p=this._gl;M=Math.min(M,this.getCaps().maxMSAASamples),O[0]._depthStencilBuffer&&(p.deleteRenderbuffer(O[0]._depthStencilBuffer),O[0]._depthStencilBuffer=null),O[0]._MSAAFramebuffer&&(p.deleteFramebuffer(O[0]._MSAAFramebuffer),O[0]._MSAAFramebuffer=null);for(var f=0;f<A;f++)O[f]._MSAARenderBuffer&&(p.deleteRenderbuffer(O[f]._MSAARenderBuffer),O[f]._MSAARenderBuffer=null);if(M>1&&p.renderbufferStorageMultisample){var h=p.createFramebuffer();if(!h)throw new Error("Unable to create multi sampled framebuffer");this._bindUnboundFramebuffer(h);for(var m=this._setupFramebufferDepthAttachments(O[0]._generateStencilBuffer,O[0]._generateDepthBuffer,O[0].width,O[0].height,M),d=[],f=0;f<A;f++){var g=O[f],v=p[this.webGLVersion>1?"COLOR_ATTACHMENT"+f:"COLOR_ATTACHMENT"+f+"_WEBGL"],l=p.createRenderbuffer();if(!l)throw new Error("Unable to create multi sampled framebuffer");p.bindRenderbuffer(p.RENDERBUFFER,l),p.renderbufferStorageMultisample(p.RENDERBUFFER,M,this._getRGBAMultiSampleBufferFormat(g.type),g.width,g.height),p.framebufferRenderbuffer(p.FRAMEBUFFER,v,p.RENDERBUFFER,l),g._MSAAFramebuffer=h,g._MSAARenderBuffer=l,g.samples=M,g._depthStencilBuffer=m,p.bindRenderbuffer(p.RENDERBUFFER,null),d.push(v)}H&&p.drawBuffers(d)}else this._bindUnboundFramebuffer(O[0]._framebuffer);return this._bindUnboundFramebuffer(null),M}},575:function(Ue,P,u){"use strict";u.d(P,"a",function(){return T});var T=function(){function S(j){this._pendingActions=new Array,this._workerInfos=j.map(function(O){return{worker:O,active:!1}})}return S.prototype.dispose=function(){for(var j=0,O=this._workerInfos;j<O.length;j++){var M=O[j];M.worker.terminate()}this._workerInfos=[],this._pendingActions=[]},S.prototype.push=function(j){for(var O=0,M=this._workerInfos;O<M.length;O++){var H=M[O];if(!H.active){this._execute(H,j);return}}this._pendingActions.push(j)},S.prototype._execute=function(j,O){var M=this;j.active=!0,O(j.worker,function(){j.active=!1;var H=M._pendingActions.shift();H&&M._execute(j,H)})},S}()},576:function(Ue,P,u){"use strict";u.d(P,"a",function(){return M});var T=u(451),S=u(452),j=u(516),O=u(468);O.a.AddParser(S.a.NAME_EFFECTLAYER,function(H,A,p,f){if(H.effectLayers){p.effectLayers||(p.effectLayers=new Array);for(var h=0;h<H.effectLayers.length;h++){var m=j.a.Parse(H.effectLayers[h],A,f);p.effectLayers.push(m)}}}),O.a.prototype.removeEffectLayer=function(H){var A=this.effectLayers.indexOf(H);return A!==-1&&this.effectLayers.splice(A,1),A},O.a.prototype.addEffectLayer=function(H){this.effectLayers.push(H)};var M=function(){function H(A){this.name=S.a.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=A,this._engine=A.getEngine(),A.effectLayers=new Array}return H.prototype.register=function(){this.scene._isReadyForMeshStage.registerStep(S.a.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(S.a.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(S.a.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(S.a.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(S.a.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(S.a.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)},H.prototype.rebuild=function(){for(var A=this.scene.effectLayers,p=0,f=A;p<f.length;p++){var h=f[p];h._rebuild()}},H.prototype.serialize=function(A){A.effectLayers=[];for(var p=this.scene.effectLayers,f=0,h=p;f<h.length;f++){var m=h[f];m.serialize&&A.effectLayers.push(m.serialize())}},H.prototype.addFromContainer=function(A){var p=this;!A.effectLayers||A.effectLayers.forEach(function(f){p.scene.addEffectLayer(f)})},H.prototype.removeFromContainer=function(A,p){var f=this;!A.effectLayers||A.effectLayers.forEach(function(h){f.scene.removeEffectLayer(h),p&&h.dispose()})},H.prototype.dispose=function(){for(var A=this.scene.effectLayers;A.length;)A[0].dispose()},H.prototype._isReadyForMesh=function(A,p){for(var f=this.scene.effectLayers,h=0,m=f;h<m.length;h++){var d=m[h];if(!!d.hasMesh(A))for(var g=0,v=A.subMeshes;g<v.length;g++){var l=v[g];if(!d.isReady(l,p))return!1}}return!0},H.prototype._renderMainTexture=function(A){this._renderEffects=!1,this._needStencil=!1;var p=!1,f=this.scene.effectLayers;if(f&&f.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(var h=0,m=f;h<m.length;h++){var d=m[h];if(d.shouldRender()&&(!d.camera||d.camera.cameraRigMode===T.a.RIG_MODE_NONE&&A===d.camera||d.camera.cameraRigMode!==T.a.RIG_MODE_NONE&&d.camera._rigCameras.indexOf(A)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||d.needStencil();var g=d._mainTexture;g._shouldRender()&&(this.scene.incrementRenderId(),g.render(!1,!1),p=!0)}}this.scene.incrementRenderId()}return p},H.prototype._setStencil=function(){this._needStencil&&this._engine.setStencilBuffer(!0)},H.prototype._setStencilBack=function(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)},H.prototype._draw=function(A){if(this._renderEffects){this._engine.setDepthBuffer(!1);for(var p=this.scene.effectLayers,f=0;f<p.length;f++){var h=p[f];h.renderingGroupId===A&&h.shouldRender()&&h.render()}this._engine.setDepthBuffer(!0)}},H.prototype._drawCamera=function(){this._renderEffects&&this._draw(-1)},H.prototype._drawRenderingGroup=function(A){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(A)},H}();j.a._SceneComponentInitialization=function(H){var A=H._getComponent(S.a.NAME_EFFECTLAYER);A||(A=new M(H),H._addComponent(A))}},577:function(Ue,P,u){"use strict";u.d(P,"a",function(){return E});var T=u(434),S=u(439),j=u(436),O=u(447),M=u(442),H=u(458),A=u(459),p=u(472),f=u(516),h=u(468),m=u(437),d=u(445),g=u(441),v=u(646),l=u(647),y=u(576);h.a.prototype.getGlowLayerByName=function(R){for(var F=0;F<this.effectLayers.length;F++)if(this.effectLayers[F].name===R&&this.effectLayers[F].getEffectName()===E.EffectName)return this.effectLayers[F];return null};var E=function(R){Object(T.d)(F,R);function F(B,L,I){var k=R.call(this,B,L)||this;return k._intensity=1,k._includedOnlyMeshes=[],k._excludedMeshes=[],k._meshesUsingTheirOwnMaterials=[],k.neutralColor=new g.b(0,0,0,1),k._options=Object(T.a)({mainTextureRatio:F.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1},I),k._init({alphaBlendingMode:1,camera:k._options.camera,mainTextureFixedSize:k._options.mainTextureFixedSize,mainTextureRatio:k._options.mainTextureRatio,renderingGroupId:k._options.renderingGroupId}),k}return Object.defineProperty(F.prototype,"blurKernelSize",{get:function(){return this._horizontalBlurPostprocess1.kernel},set:function(B){this._horizontalBlurPostprocess1.kernel=B,this._verticalBlurPostprocess1.kernel=B,this._horizontalBlurPostprocess2.kernel=B,this._verticalBlurPostprocess2.kernel=B},enumerable:!1,configurable:!0}),Object.defineProperty(F.prototype,"intensity",{get:function(){return this._intensity},set:function(B){this._intensity=B},enumerable:!1,configurable:!0}),F.prototype.getEffectName=function(){return F.EffectName},F.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[O.b.PositionKind],["offset"],["textureSampler","textureSampler2"],`#define EMISSIVE 
`)},F.prototype._createTextureAndPostProcesses=function(){var B=this,L=this._mainTextureDesiredSize.width,I=this._mainTextureDesiredSize.height;L=this._engine.needPOTTextures?d.a.GetExponentOfTwo(L,this._maxSize):L,I=this._engine.needPOTTextures?d.a.GetExponentOfTwo(I,this._maxSize):I;var k=0;this._engine.getCaps().textureHalfFloatRender?k=2:k=0,this._blurTexture1=new H.a("GlowLayerBlurRTT",{width:L,height:I},this._scene,!1,!0,k),this._blurTexture1.wrapU=M.a.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=M.a.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(M.a.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;var Z=Math.floor(L/2),Y=Math.floor(I/2);this._blurTexture2=new H.a("GlowLayerBlurRTT2",{width:Z,height:Y},this._scene,!1,!0,k),this._blurTexture2.wrapU=M.a.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=M.a.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(M.a.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2],this._horizontalBlurPostprocess1=new p.a("GlowLayerHBP1",new j.d(1,0),this._options.blurKernelSize/2,{width:L,height:I},null,M.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,k),this._horizontalBlurPostprocess1.width=L,this._horizontalBlurPostprocess1.height=I,this._horizontalBlurPostprocess1.onApplyObservable.add(function(U){U.setTexture("textureSampler",B._mainTexture)}),this._verticalBlurPostprocess1=new p.a("GlowLayerVBP1",new j.d(0,1),this._options.blurKernelSize/2,{width:L,height:I},null,M.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,k),this._horizontalBlurPostprocess2=new p.a("GlowLayerHBP2",new j.d(1,0),this._options.blurKernelSize/2,{width:Z,height:Y},null,M.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,k),this._horizontalBlurPostprocess2.width=Z,this._horizontalBlurPostprocess2.height=Y,this._horizontalBlurPostprocess2.onApplyObservable.add(function(U){U.setTexture("textureSampler",B._blurTexture1)}),this._verticalBlurPostprocess2=new p.a("GlowLayerVBP2",new j.d(0,1),this._options.blurKernelSize/2,{width:Z,height:Y},null,M.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,k),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(function(){var U=B._blurTexture1.getInternalTexture();if(U){B._scene.postProcessManager.directRender(B._postProcesses1,U,!0);var Q=B._blurTexture2.getInternalTexture();Q&&B._scene.postProcessManager.directRender(B._postProcesses2,Q,!0),B._engine.unBindFramebuffer(Q!=null?Q:U,!0)}}),this._postProcesses.map(function(U){U.autoClear=!1})},F.prototype.isReady=function(B,L){var I=B.getMaterial(),k=B.getRenderingMesh();if(!I||!k)return!1;var Z=I.emissiveTexture;return R.prototype._isReady.call(this,B,L,Z)},F.prototype.needStencil=function(){return!1},F.prototype._canRenderMesh=function(B,L){return!0},F.prototype._internalRender=function(B){B.setTexture("textureSampler",this._blurTexture1),B.setTexture("textureSampler2",this._blurTexture2),B.setFloat("offset",this._intensity);var L=this._engine,I=L.getStencilBuffer();L.setStencilBuffer(!1),L.drawElementsType(A.a.TriangleFillMode,0,6),L.setStencilBuffer(I)},F.prototype._setEmissiveTextureAndColor=function(B,L,I){var k=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(B,L,I):I?(this._emissiveTextureAndColor.texture=I.emissiveTexture,this._emissiveTextureAndColor.texture&&(k=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(B,L,I,this._emissiveTextureAndColor.color):I.emissiveColor?this._emissiveTextureAndColor.color.set(I.emissiveColor.r*k,I.emissiveColor.g*k,I.emissiveColor.b*k,I.alpha):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)},F.prototype._shouldRenderMesh=function(B){return this.hasMesh(B)},F.prototype._addCustomEffectDefines=function(B){B.push("#define GLOW")},F.prototype.addExcludedMesh=function(B){this._excludedMeshes.indexOf(B.uniqueId)===-1&&this._excludedMeshes.push(B.uniqueId)},F.prototype.removeExcludedMesh=function(B){var L=this._excludedMeshes.indexOf(B.uniqueId);L!==-1&&this._excludedMeshes.splice(L,1)},F.prototype.addIncludedOnlyMesh=function(B){this._includedOnlyMeshes.indexOf(B.uniqueId)===-1&&this._includedOnlyMeshes.push(B.uniqueId)},F.prototype.removeIncludedOnlyMesh=function(B){var L=this._includedOnlyMeshes.indexOf(B.uniqueId);L!==-1&&this._includedOnlyMeshes.splice(L,1)},F.prototype.hasMesh=function(B){return R.prototype.hasMesh.call(this,B)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(B.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(B.uniqueId)===-1:!0:!1},F.prototype._useMeshMaterial=function(B){return this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(B.uniqueId)>-1},F.prototype.referenceMeshToUseItsOwnMaterial=function(B){this._meshesUsingTheirOwnMaterials.push(B.uniqueId)},F.prototype.unReferenceMeshFromUsingItsOwnMaterial=function(B){for(var L=this._meshesUsingTheirOwnMaterials.indexOf(B.uniqueId);L>=0;)this._meshesUsingTheirOwnMaterials.splice(L,1),L=this._meshesUsingTheirOwnMaterials.indexOf(B.uniqueId)},F.prototype._disposeMesh=function(B){this.removeIncludedOnlyMesh(B),this.removeExcludedMesh(B)},F.prototype.getClassName=function(){return"GlowLayer"},F.prototype.serialize=function(){var B=S.a.Serialize(this);B.customType="BABYLON.GlowLayer";var L;if(B.includedMeshes=[],this._includedOnlyMeshes.length)for(L=0;L<this._includedOnlyMeshes.length;L++){var I=this._scene.getMeshByUniqueID(this._includedOnlyMeshes[L]);I&&B.includedMeshes.push(I.id)}if(B.excludedMeshes=[],this._excludedMeshes.length)for(L=0;L<this._excludedMeshes.length;L++){var I=this._scene.getMeshByUniqueID(this._excludedMeshes[L]);I&&B.excludedMeshes.push(I.id)}return B},F.Parse=function(B,L,I){var k=S.a.Parse(function(){return new F(B.name,L,B.options)},B,L,I),Z;for(Z=0;Z<B.excludedMeshes.length;Z++){var Y=L.getMeshByID(B.excludedMeshes[Z]);Y&&k.addExcludedMesh(Y)}for(Z=0;Z<B.includedMeshes.length;Z++){var Y=L.getMeshByID(B.includedMeshes[Z]);Y&&k.addIncludedOnlyMesh(Y)}return k},F.EffectName="GlowLayer",F.DefaultBlurKernelSize=32,F.DefaultTextureRatio=.5,Object(T.c)([Object(S.c)()],F.prototype,"blurKernelSize",null),Object(T.c)([Object(S.c)()],F.prototype,"intensity",null),Object(T.c)([Object(S.c)("options")],F.prototype,"_options",void 0),F}(f.a);m.a.RegisteredTypes["BABYLON.GlowLayer"]=E},578:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(434),S=u(466),j=u(584),O=u(472),M=u(585),H=u(436),A=u(442),p=function(f){Object(T.d)(h,f);function h(m,d,g,v,l,y){l===void 0&&(l=0),y===void 0&&(y=!1);var E=f.call(this,m.getEngine(),"bloom",function(){return E._effects},!0)||this;return E.bloomScale=d,E._effects=[],E._downscale=new j.a("highlights",1,null,A.a.BILINEAR_SAMPLINGMODE,m.getEngine(),!1,l,y),E._blurX=new O.a("horizontal blur",new H.d(1,0),10,d,null,A.a.BILINEAR_SAMPLINGMODE,m.getEngine(),!1,l,void 0,y),E._blurX.alwaysForcePOT=!0,E._blurX.autoClear=!1,E._blurY=new O.a("vertical blur",new H.d(0,1),10,d,null,A.a.BILINEAR_SAMPLINGMODE,m.getEngine(),!1,l,void 0,y),E._blurY.alwaysForcePOT=!0,E._blurY.autoClear=!1,E.kernel=v,E._effects=[E._downscale,E._blurX,E._blurY],E._merge=new M.a("bloomMerge",E._downscale,E._blurY,g,d,null,A.a.BILINEAR_SAMPLINGMODE,m.getEngine(),!1,l,y),E._merge.autoClear=!1,E._effects.push(E._merge),E}return Object.defineProperty(h.prototype,"threshold",{get:function(){return this._downscale.threshold},set:function(m){this._downscale.threshold=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"weight",{get:function(){return this._merge.weight},set:function(m){this._merge.weight=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"kernel",{get:function(){return this._blurX.kernel/this.bloomScale},set:function(m){this._blurX.kernel=m*this.bloomScale,this._blurY.kernel=m*this.bloomScale},enumerable:!1,configurable:!0}),h.prototype.disposeEffects=function(m){for(var d=0;d<this._effects.length;d++)this._effects[d].dispose(m)},h.prototype._updateEffects=function(){for(var m=0;m<this._effects.length;m++)this._effects[m].updateEffect()},h.prototype._isReady=function(){for(var m=0;m<this._effects.length;m++)if(!this._effects[m].isReady())return!1;return!0},h}(S.a)},579:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(436),j=u(444),O=u(600),M=u(437),H=u(439),A=function(p){Object(T.d)(f,p);function f(h,m,d,g,v,l,y,E,R,F){R===void 0&&(R=0),F===void 0&&(F=!1);var B=p.call(this,h,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],g,v,l,y,E,null,R,void 0,null,F)||this;return B.aberrationAmount=30,B.radialIntensity=0,B.direction=new S.d(.707,.707),B.centerPosition=new S.d(.5,.5),B.screenWidth=m,B.screenHeight=d,B.onApplyObservable.add(function(L){L.setFloat("chromatic_aberration",B.aberrationAmount),L.setFloat("screen_width",m),L.setFloat("screen_height",d),L.setFloat("radialIntensity",B.radialIntensity),L.setFloat2("direction",B.direction.x,B.direction.y),L.setFloat2("centerPosition",B.centerPosition.x,B.centerPosition.y)}),B}return f.prototype.getClassName=function(){return"ChromaticAberrationPostProcess"},f._Parse=function(h,m,d,g){return H.a.Parse(function(){return new f(h.name,h.screenWidth,h.screenHeight,h.options,m,h.renderTargetSamplingMode,d.getEngine(),h.reusable,h.textureType,!1)},h,d,g)},Object(T.c)([Object(H.c)()],f.prototype,"aberrationAmount",void 0),Object(T.c)([Object(H.c)()],f.prototype,"radialIntensity",void 0),Object(T.c)([Object(H.c)()],f.prototype,"direction",void 0),Object(T.c)([Object(H.c)()],f.prototype,"centerPosition",void 0),Object(T.c)([Object(H.c)()],f.prototype,"screenWidth",void 0),Object(T.c)([Object(H.c)()],f.prototype,"screenHeight",void 0),f}(j.a);M.a.RegisteredTypes["BABYLON.ChromaticAberrationPostProcess"]=A},580:function(Ue,P,u){"use strict";u.d(P,"a",function(){return H});var T=u(434),S=u(442),j=u(472),O=u(437),M=u(439),H=function(A){Object(T.d)(p,A);function p(f,h,m,d,g,v,l,y,E,R,F,B,L){y===void 0&&(y=null),E===void 0&&(E=S.a.BILINEAR_SAMPLINGMODE),B===void 0&&(B=0),L===void 0&&(L=!1);var I=A.call(this,f,m,d,g,v,E=2,R,F,B=0,`#define DOF 1\r
`,L)||this;return I.direction=m,I.onApplyObservable.add(function(k){y!=null&&k.setTextureFromPostProcess("textureSampler",y),k.setTextureFromPostProcessOutput("circleOfConfusionSampler",l),h.activeCamera&&k.setFloat2("cameraMinMaxZ",h.activeCamera.minZ,h.activeCamera.maxZ)}),I}return p.prototype.getClassName=function(){return"DepthOfFieldBlurPostProcess"},Object(T.c)([Object(M.c)()],p.prototype,"direction",void 0),p}(j.a);O.a.RegisteredTypes["BABYLON.DepthOfFieldBlurPostProcess"]=H},581:function(Ue,P,u){"use strict";u.d(P,"a",function(){return m});var T=u(434),S=u(444),j=u(502),O=u(439),M=function(){function d(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}return d}(),H=u(435),A="screenSpaceReflectionPixelShader",p=`

uniform sampler2D textureSampler;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;
uniform sampler2D normalSampler;
uniform sampler2D positionSampler;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform float step;
uniform float strength;
uniform float threshold;
uniform float roughnessFactor;
uniform float reflectionSpecularFalloffExponent;

varying vec2 vUV;
#ifdef SSR_SUPPORTED

struct ReflectionInfo {
vec3 color;
vec4 coords;
};

vec3 fresnelSchlick(float cosTheta,vec3 F0)
{
return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);
}

ReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)
{
ReflectionInfo info;
info.color=vec3(0.0);
vec4 projectedCoord;
float sampledDepth;
for(int i=0; i<SMOOTH_STEPS; i++)
{
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;
float depth=sampledDepth-hitCoord.z;
dir*=0.5;
if(depth>0.0)
hitCoord-=dir;
else
hitCoord+=dir;
info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;
}
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);

info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);
info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;
info.color/=float(SMOOTH_STEPS+1);
return info;
}

ReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)
{
ReflectionInfo info;
vec4 projectedCoord;
float sampledDepth;
dir*=step;
for(int i=0; i<REFLECTION_SAMPLES; i++)
{
hitCoord+=dir;
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;
float depth=sampledDepth-hitCoord.z;
if(((depth-dir.z)<threshold) && depth<=0.0)
{
#ifdef ENABLE_SMOOTH_REFLECTIONS
return smoothReflectionInfo(dir,hitCoord);
#else
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;
info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);
return info;
#endif
}
}
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;
info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);
return info;
}
vec3 hash(vec3 a)
{
a=fract(a*0.8);
a+=dot(a,a.yxz+19.19);
return fract((a.xxy+a.yxx)*a.zyx);
}
#endif
void main()
{
#ifdef SSR_SUPPORTED

vec4 albedoFull=texture2D(textureSampler,vUV);
vec3 albedo=albedoFull.rgb;
float spec=texture2D(reflectivitySampler,vUV).r;
if (spec == 0.0) {
gl_FragColor=albedoFull;
return;
}

vec3 normal=(texture2D(normalSampler,vUV)).xyz;
vec3 position=(view*texture2D(positionSampler,vUV)).xyz;
vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));
float roughness=1.0-texture2D(reflectivitySampler,vUV).a;
vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;
ReflectionInfo info=getReflectionInfo(jitt+reflected,position);

vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));
float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);

vec3 F0=vec3(0.04);
F0=mix(F0,albedo,spec);
vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);

float reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);
float albedoMultiplier=1.0-reflectionMultiplier;
vec3 SSR=info.color*fresnel;
gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;H.a.ShadersStore[A]=p;var f={name:A,shader:p},h=u(437),m=function(d){Object(T.d)(g,d);function g(v,l,y,E,R,F,B,L,I,k){L===void 0&&(L=0),I===void 0&&(I=!1),k===void 0&&(k=!1);var Z=d.call(this,v,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","step","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],y,E,R,F,B,`#define SSR_SUPPORTED
#define REFLECTION_SAMPLES 64
#define SMOOTH_STEPS 5
`,L,void 0,null,I)||this;if(Z.threshold=1.2,Z.strength=1,Z.reflectionSpecularFalloffExponent=3,Z.step=1,Z.roughnessFactor=.2,Z._forceGeometryBuffer=!1,Z._enableSmoothReflections=!1,Z._reflectionSamples=64,Z._smoothSteps=5,Z._forceGeometryBuffer=k,Z._forceGeometryBuffer){var Y=l.enableGeometryBufferRenderer();Y&&Y.isSupported&&(Y.enablePosition=!0,Y.enableReflectivity=!0,Z._geometryBufferRenderer=Y)}else Z._prePassRenderer=l.enablePrePassRenderer(),Z._prePassRenderer.markAsDirty(),Z._prePassEffectConfiguration=new M;return Z._updateEffectDefines(),Z.onApply=function(U){var Q=Z._geometryBufferRenderer,G=Z._prePassRenderer;if(!(!G&&!Q)){if(Q){var K=Q.getTextureIndex(j.a.POSITION_TEXTURE_TYPE),fe=Q.getTextureIndex(j.a.REFLECTIVITY_TEXTURE_TYPE);U.setTexture("normalSampler",Q.getGBuffer().textures[1]),U.setTexture("positionSampler",Q.getGBuffer().textures[K]),U.setTexture("reflectivitySampler",Q.getGBuffer().textures[fe])}else{var K=G.getIndex(1),fe=G.getIndex(3),ce=G.getIndex(6);U.setTexture("normalSampler",G.getRenderTarget().textures[ce]),U.setTexture("positionSampler",G.getRenderTarget().textures[K]),U.setTexture("reflectivitySampler",G.getRenderTarget().textures[fe])}var re=l.activeCamera;if(!!re){var Re=re.getViewMatrix(!0),Ie=re.getProjectionMatrix(!0);U.setMatrix("projection",Ie),U.setMatrix("view",Re),U.setFloat("threshold",Z.threshold),U.setFloat("reflectionSpecularFalloffExponent",Z.reflectionSpecularFalloffExponent),U.setFloat("strength",Z.strength),U.setFloat("step",Z.step),U.setFloat("roughnessFactor",Z.roughnessFactor)}}},Z}return g.prototype.getClassName=function(){return"ScreenSpaceReflectionPostProcess"},Object.defineProperty(g.prototype,"enableSmoothReflections",{get:function(){return this._enableSmoothReflections},set:function(v){v!==this._enableSmoothReflections&&(this._enableSmoothReflections=v,this._updateEffectDefines())},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"reflectionSamples",{get:function(){return this._reflectionSamples},set:function(v){v!==this._reflectionSamples&&(this._reflectionSamples=v,this._updateEffectDefines())},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"smoothSteps",{get:function(){return this._smoothSteps},set:function(v){v!==this._smoothSteps&&(this._smoothSteps=v,this._updateEffectDefines())},enumerable:!1,configurable:!0}),g.prototype._updateEffectDefines=function(){var v=[];(this._geometryBufferRenderer||this._prePassRenderer)&&v.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&v.push("#define ENABLE_SMOOTH_REFLECTIONS"),v.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),v.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(v.join(`
`))},g._Parse=function(v,l,y,E){return O.a.Parse(function(){return new g(v.name,y,v.options,l,v.renderTargetSamplingMode,y.getEngine(),v.textureType,v.reusable)},v,y,E)},Object(T.c)([Object(O.c)()],g.prototype,"threshold",void 0),Object(T.c)([Object(O.c)()],g.prototype,"strength",void 0),Object(T.c)([Object(O.c)()],g.prototype,"reflectionSpecularFalloffExponent",void 0),Object(T.c)([Object(O.c)()],g.prototype,"step",void 0),Object(T.c)([Object(O.c)()],g.prototype,"roughnessFactor",void 0),Object(T.c)([Object(O.c)()],g.prototype,"enableSmoothReflections",null),Object(T.c)([Object(O.c)()],g.prototype,"reflectionSamples",null),Object(T.c)([Object(O.c)()],g.prototype,"smoothSteps",null),g}(S.a);h.a.RegisteredTypes["BABYLON.ScreenSpaceReflectionPostProcess"]=m},582:function(Ue,P,u){"use strict";u.d(P,"a",function(){return h});var T=u(434),S=u(444),j=u(440),O=u(435),M="circleOfConfusionPixelShader",H=`
uniform sampler2D depthSampler;

varying vec2 vUV;

uniform vec2 cameraMinMaxZ;

uniform float focusDistance;
uniform float cocPrecalculation;
void main(void)
{
float depth=texture2D(depthSampler,vUV).r;
float pixelDistance=(cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth)*1000.0;
float coc=abs(cocPrecalculation* ((focusDistance-pixelDistance)/pixelDistance));
coc=clamp(coc,0.0,1.0);
gl_FragColor=vec4(coc,depth,coc,1.0);
}
`;O.a.ShadersStore[M]=H;var A={name:M,shader:H},p=u(437),f=u(439),h=function(m){Object(T.d)(d,m);function d(g,v,l,y,E,R,F,B,L){B===void 0&&(B=0),L===void 0&&(L=!1);var I=m.call(this,g,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],l,y,E,R,F,null,B,void 0,null,L)||this;return I.lensSize=50,I.fStop=1.4,I.focusDistance=2e3,I.focalLength=50,I._depthTexture=null,I._depthTexture=v,I.onApplyObservable.add(function(k){if(!I._depthTexture){j.a.Warn("No depth texture set on CircleOfConfusionPostProcess");return}k.setTexture("depthSampler",I._depthTexture);var Z=I.lensSize/I.fStop,Y=Z*I.focalLength/(I.focusDistance-I.focalLength);k.setFloat("focusDistance",I.focusDistance),k.setFloat("cocPrecalculation",Y),k.setFloat2("cameraMinMaxZ",I._depthTexture.activeCamera.minZ,I._depthTexture.activeCamera.maxZ)}),I}return d.prototype.getClassName=function(){return"CircleOfConfusionPostProcess"},Object.defineProperty(d.prototype,"depthTexture",{set:function(g){this._depthTexture=g},enumerable:!1,configurable:!0}),Object(T.c)([Object(f.c)()],d.prototype,"lensSize",void 0),Object(T.c)([Object(f.c)()],d.prototype,"fStop",void 0),Object(T.c)([Object(f.c)()],d.prototype,"focusDistance",void 0),Object(T.c)([Object(f.c)()],d.prototype,"focalLength",void 0),d}(S.a);p.a.RegisteredTypes["BABYLON.CircleOfConfusionPostProcess"]=h},583:function(Ue,P,u){"use strict";u.d(P,"b",function(){return A}),u.d(P,"a",function(){return p});var T=u(434),S=u(444),j=u(435),O="depthOfFieldMergePixelShader",M=`uniform sampler2D textureSampler;
varying vec2 vUV;
uniform sampler2D circleOfConfusionSampler;
uniform sampler2D blurStep0;
#if BLUR_LEVEL>0
uniform sampler2D blurStep1;
#endif
#if BLUR_LEVEL>1
uniform sampler2D blurStep2;
#endif
void main(void)
{
float coc=texture2D(circleOfConfusionSampler,vUV).r;
#if BLUR_LEVEL == 0
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred0=texture2D(blurStep0,vUV);
gl_FragColor=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL == 1
if(coc<0.5){
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(original,blurred1,coc/0.5);
}else{
vec4 blurred0=texture2D(blurStep0,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);
}
#endif
#if BLUR_LEVEL == 2
if(coc<0.33){
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred2=texture2D(blurStep2,vUV);
gl_FragColor=mix(original,blurred2,coc/0.33);
}else if(coc<0.66){
vec4 blurred1=texture2D(blurStep1,vUV);
vec4 blurred2=texture2D(blurStep2,vUV);
gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);
}else{
vec4 blurred0=texture2D(blurStep0,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);
}
#endif
}
`;j.a.ShadersStore[O]=M;var H={name:O,shader:M},A=function(){function f(){}return f}(),p=function(f){Object(T.d)(h,f);function h(m,d,g,v,l,y,E,R,F,B,L){B===void 0&&(B=0),L===void 0&&(L=!1);var I=f.call(this,m,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],l,y,E,R,F,null,B,void 0,null,!0)||this;return I.blurSteps=v,I.onApplyObservable.add(function(k){k.setTextureFromPostProcess("textureSampler",d),k.setTextureFromPostProcessOutput("circleOfConfusionSampler",g),v.forEach(function(Z,Y){k.setTextureFromPostProcessOutput("blurStep"+(v.length-Y-1),Z)})}),L||I.updateEffect(),I}return h.prototype.getClassName=function(){return"DepthOfFieldMergePostProcess"},h.prototype.updateEffect=function(m,d,g,v,l,y){m===void 0&&(m=null),d===void 0&&(d=null),g===void 0&&(g=null),m||(m="",m+="#define BLUR_LEVEL "+(this.blurSteps.length-1)+`
`),f.prototype.updateEffect.call(this,m,d,g,v,l,y)},h}(S.a)},584:function(Ue,P,u){"use strict";u.d(P,"a",function(){return m});var T=u(434),S=u(444),j=u(515),O=u(435),M=u(457),H="extractHighlightsPixelShader",A=`#include<helperFunctions>

varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float threshold;
uniform float exposure;
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
float luma=getLuminance(gl_FragColor.rgb*exposure);
gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;
}`;O.a.ShadersStore[H]=A;var p={name:H,shader:A},f=u(439),h=u(437),m=function(d){Object(T.d)(g,d);function g(v,l,y,E,R,F,B,L){B===void 0&&(B=0),L===void 0&&(L=!1);var I=d.call(this,v,"extractHighlights",["threshold","exposure"],null,l,y,E,R,F,null,B,void 0,null,L)||this;return I.threshold=.9,I._exposure=1,I._inputPostProcess=null,I.onApplyObservable.add(function(k){I._inputPostProcess&&k.setTextureFromPostProcess("textureSampler",I._inputPostProcess),k.setFloat("threshold",Math.pow(I.threshold,j.b)),k.setFloat("exposure",I._exposure)}),I}return g.prototype.getClassName=function(){return"ExtractHighlightsPostProcess"},Object(T.c)([Object(f.c)()],g.prototype,"threshold",void 0),g}(S.a);h.a.RegisteredTypes["BABYLON.ExtractHighlightsPostProcess"]=m},585:function(Ue,P,u){"use strict";u.d(P,"a",function(){return f});var T=u(434),S=u(444),j=u(435),O="bloomMergePixelShader",M=`uniform sampler2D textureSampler;
uniform sampler2D bloomBlur;
varying vec2 vUV;
uniform float bloomWeight;
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
vec3 blurred=texture2D(bloomBlur,vUV).rgb;
gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight);
}
`;j.a.ShadersStore[O]=M;var H={name:O,shader:M},A=u(437),p=u(439),f=function(h){Object(T.d)(m,h);function m(d,g,v,l,y,E,R,F,B,L,I){L===void 0&&(L=0),I===void 0&&(I=!1);var k=h.call(this,d,"bloomMerge",["bloomWeight"],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2","bloomBlur"],y,E,R,F,B,null,L,void 0,null,!0)||this;return k.weight=1,k.weight=l,k.onApplyObservable.add(function(Z){Z.setTextureFromPostProcess("textureSampler",g),Z.setTextureFromPostProcessOutput("bloomBlur",v),Z.setFloat("bloomWeight",k.weight)}),I||k.updateEffect(),k}return m.prototype.getClassName=function(){return"BloomMergePostProcess"},Object(T.c)([Object(p.c)()],m.prototype,"weight",void 0),m}(S.a);A.a.RegisteredTypes["BABYLON.BloomMergePostProcess"]=f},586:function(Ue,P,u){"use strict";u.d(P,"a",function(){return h});var T=u(434),S=u(444),j=u(435),O=u(457),M="grainPixelShader",H=`#include<helperFunctions>

uniform sampler2D textureSampler;

uniform float intensity;
uniform float animatedSeed;

varying vec2 vUV;
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
vec2 seed=vUV*(animatedSeed);
float grain=dither(seed,intensity);

float lum=getLuminance(gl_FragColor.rgb);
float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;
gl_FragColor.rgb+=grain*grainAmount;
gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);
}`;j.a.ShadersStore[M]=H;var A={name:M,shader:H},p=u(437),f=u(439),h=function(m){Object(T.d)(d,m);function d(g,v,l,y,E,R,F,B){F===void 0&&(F=0),B===void 0&&(B=!1);var L=m.call(this,g,"grain",["intensity","animatedSeed"],[],v,l,y,E,R,null,F,void 0,null,B)||this;return L.intensity=30,L.animated=!1,L.onApplyObservable.add(function(I){I.setFloat("intensity",L.intensity),I.setFloat("animatedSeed",L.animated?Math.random()+1:1)}),L}return d.prototype.getClassName=function(){return"GrainPostProcess"},d._Parse=function(g,v,l,y){return f.a.Parse(function(){return new d(g.name,g.options,v,g.renderTargetSamplingMode,l.getEngine(),g.reusable)},g,l,y)},Object(T.c)([Object(f.c)()],d.prototype,"intensity",void 0),Object(T.c)([Object(f.c)()],d.prototype,"animated",void 0),d}(S.a);p.a.RegisteredTypes["BABYLON.GrainPostProcess"]=h},587:function(Ue,P,u){"use strict";u.d(P,"a",function(){return f});var T=u(434),S=u(444),j=u(435),O="sharpenPixelShader",M=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform vec2 sharpnessAmounts;
void main(void)
{
vec2 onePixel=vec2(1.0,1.0)/screenSize;
vec4 color=texture2D(textureSampler,vUV);
vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(0,1)) -
color*4.0;
gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);
}`;j.a.ShadersStore[O]=M;var H={name:O,shader:M},A=u(437),p=u(439),f=function(h){Object(T.d)(m,h);function m(d,g,v,l,y,E,R,F){R===void 0&&(R=0),F===void 0&&(F=!1);var B=h.call(this,d,"sharpen",["sharpnessAmounts","screenSize"],null,g,v,l,y,E,null,R,void 0,null,F)||this;return B.colorAmount=1,B.edgeAmount=.3,B.onApply=function(L){L.setFloat2("screenSize",B.width,B.height),L.setFloat2("sharpnessAmounts",B.edgeAmount,B.colorAmount)},B}return m.prototype.getClassName=function(){return"SharpenPostProcess"},m._Parse=function(d,g,v,l){return p.a.Parse(function(){return new m(d.name,d.options,g,d.renderTargetSamplingMode,v.getEngine(),d.textureType,d.reusable)},d,v,l)},Object(T.c)([Object(p.c)()],m.prototype,"colorAmount",void 0),Object(T.c)([Object(p.c)()],m.prototype,"edgeAmount",void 0),m}(S.a);A.a.RegisteredTypes["BABYLON.SharpenPostProcess"]=f},594:function(Ue,P,u){"use strict";u.d(P,"a",function(){return L});var T=u(434),S=u(440),j=u(439),O=u(436),M=u(451),H=u(442),A=u(479),p=u(444),f=u(481),h=u(466),m=u(486),d=u(437),g=u(448),v=function(){function I(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}return I}(),l=u(482),y=u(435),E="ssao2PixelShader",R=`
precision highp float;
uniform sampler2D textureSampler;
uniform float near;
uniform float far;
uniform float radius;
float scales[16]=float[16](
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);
varying vec2 vUV;
float perspectiveDepthToViewZ( const in float invClipZ,const in float near,const in float far ) {
return ( near*far )/( ( far-near )*invClipZ-far );
}
float viewZToPerspectiveDepth( const in float viewZ,const in float near,const in float far ) {
return ( near*far/viewZ+far)/( far-near );
}
float viewZToOrthographicDepth( const in float viewZ,const in float near,const in float far ) {
return ( viewZ+near )/( near-far );
}
#ifdef SSAO
uniform sampler2D randomSampler;
uniform sampler2D depthSampler;
uniform sampler2D normalSampler;
uniform float randTextureTiles;
uniform float samplesFactor;
uniform vec3 sampleSphere[SAMPLES];
uniform float totalStrength;
uniform float base;
uniform float xViewport;
uniform float yViewport;
uniform mat3 depthProjection;
uniform float maxZ;
uniform float minZAspect;
uniform vec2 texelSize;
uniform mat4 projection;
void main()
{
vec3 random=texture2D(randomSampler,vUV*randTextureTiles).rgb;
float depth=texture2D(depthSampler,vUV).r;
float depthSign=depth/abs(depth);
depth=depth*depthSign;
vec3 normal=texture2D(normalSampler,vUV).rgb;
float occlusion=0.0;
float correctedRadius=min(radius,minZAspect*depth/near);
vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);
vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);
vec3 origin=vViewRay*vDepthFactor;
vec3 rvec=random*2.0-1.0;
rvec.z=0.0;

float dotProduct=dot(rvec,normal);
rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);
vec3 tangent=normalize(rvec-normal*dot(rvec,normal));
vec3 bitangent=cross(normal,tangent);
mat3 tbn=mat3(tangent,bitangent,normal);
float difference;
for (int i=0; i<SAMPLES; ++i) {

vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];
samplePosition=samplePosition*correctedRadius+origin;

vec4 offset=vec4(samplePosition,1.0);
offset=projection*offset;
offset.xyz/=offset.w;
offset.xy=offset.xy*0.5+0.5;
if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {
continue;
}

float sampleDepth=abs(texture2D(depthSampler,offset.xy).r);

difference=depthSign*samplePosition.z-sampleDepth;
float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);
occlusion+=(difference>=0.0 ? 1.0 : 0.0)*rangeCheck;
}
occlusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));
float ao=1.0-totalStrength*occlusion*samplesFactor;
float result=clamp(ao+base,0.0,1.0);
gl_FragColor=vec4(vec3(result),1.0);
}
#endif
#ifdef BILATERAL_BLUR
uniform sampler2D depthSampler;
uniform float outSize;
uniform float samplerOffsets[SAMPLES];
vec4 blur9(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.3846153846)*direction;
vec2 off2=vec2(3.2307692308)*direction;
color+=texture2D(image,uv)*0.2270270270;
color+=texture2D(image,uv+(off1/resolution))*0.3162162162;
color+=texture2D(image,uv-(off1/resolution))*0.3162162162;
color+=texture2D(image,uv+(off2/resolution))*0.0702702703;
color+=texture2D(image,uv-(off2/resolution))*0.0702702703;
return color;
}
vec4 blur13(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.411764705882353)*direction;
vec2 off2=vec2(3.2941176470588234)*direction;
vec2 off3=vec2(5.176470588235294)*direction;
color+=texture2D(image,uv)*0.1964825501511404;
color+=texture2D(image,uv+(off1/resolution))*0.2969069646728344;
color+=texture2D(image,uv-(off1/resolution))*0.2969069646728344;
color+=texture2D(image,uv+(off2/resolution))*0.09447039785044732;
color+=texture2D(image,uv-(off2/resolution))*0.09447039785044732;
color+=texture2D(image,uv+(off3/resolution))*0.010381362401148057;
color+=texture2D(image,uv-(off3/resolution))*0.010381362401148057;
return color;
}
vec4 blur13Bilateral(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.411764705882353)*direction;
vec2 off2=vec2(3.2941176470588234)*direction;
vec2 off3=vec2(5.176470588235294)*direction;
float compareDepth=abs(texture2D(depthSampler,uv).r);
float sampleDepth;
float weight;
float weightSum=30.0;
color+=texture2D(image,uv)*30.0;
sampleDepth=abs(texture2D(depthSampler,uv+(off1/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off1/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off1/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off1/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv+(off2/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off2/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off2/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off2/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv+(off3/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off3/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off3/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off3/resolution))*weight;
return color/weightSum;
}
void main()
{
#if EXPENSIVE
float compareDepth=abs(texture2D(depthSampler,vUV).r);
float texelsize=1.0/outSize;
float result=0.0;
float weightSum=0.0;
for (int i=0; i<SAMPLES; ++i)
{
#ifdef BILATERAL_BLUR_H
vec2 direction=vec2(1.0,0.0);
vec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);
#else
vec2 direction=vec2(0.0,1.0);
vec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);
#endif
vec2 samplePos=vUV+sampleOffset;
float sampleDepth=abs(texture2D(depthSampler,samplePos).r);
float weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30000.0);
result+=texture2D(textureSampler,samplePos).r*weight;
weightSum+=weight;
}
result/=weightSum;
gl_FragColor.rgb=vec3(result);
gl_FragColor.a=1.0;
#else
vec4 color;
#ifdef BILATERAL_BLUR_H
vec2 direction=vec2(1.0,0.0);
color=blur13Bilateral(textureSampler,vUV,outSize,direction);
#else
vec2 direction=vec2(0.0,1.0);
color=blur13Bilateral(textureSampler,vUV,outSize,direction);
#endif
gl_FragColor.rgb=vec3(color.r);
gl_FragColor.a=1.0;
#endif
}
#endif
`;y.a.ShadersStore[E]=R;var F={name:E,shader:R},B=u(601),L=function(I){Object(T.d)(k,I);function k(Z,Y,U,Q,G){G===void 0&&(G=!1);var K=I.call(this,Y.getEngine(),Z)||this;if(K.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",K.SSAORenderEffect="SSAORenderEffect",K.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",K.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",K.SSAOCombineRenderEffect="SSAOCombineRenderEffect",K.totalStrength=1,K.maxZ=100,K.minZAspect=.2,K._samples=8,K._textureSamples=1,K._forceGeometryBuffer=!1,K._expensiveBlur=!0,K.radius=2,K.base=0,K._bits=new Uint32Array(1),K._scene=Y,K._ratio=U,K._forceGeometryBuffer=G,!K.isSupported)return S.a.Error("The current engine does not support SSAO 2."),K;var fe=K._ratio.ssaoRatio||U,ce=K._ratio.blurRatio||U;return K._forceGeometryBuffer?Y.enableGeometryBufferRenderer():K._prePassRenderer=Y.enablePrePassRenderer(),K._createRandomTexture(),K._originalColorPostProcess=new m.b("SSAOOriginalSceneColor",1,null,H.a.BILINEAR_SAMPLINGMODE,Y.getEngine(),!1),K._originalColorPostProcess.samples=K.textureSamples,K._createSSAOPostProcess(1),K._createBlurPostProcess(fe,ce),K._createSSAOCombinePostProcess(ce),K.addEffect(new h.a(Y.getEngine(),K.SSAOOriginalSceneColorEffect,function(){return K._originalColorPostProcess},!0)),K.addEffect(new h.a(Y.getEngine(),K.SSAORenderEffect,function(){return K._ssaoPostProcess},!0)),K.addEffect(new h.a(Y.getEngine(),K.SSAOBlurHRenderEffect,function(){return K._blurHPostProcess},!0)),K.addEffect(new h.a(Y.getEngine(),K.SSAOBlurVRenderEffect,function(){return K._blurVPostProcess},!0)),K.addEffect(new h.a(Y.getEngine(),K.SSAOCombineRenderEffect,function(){return K._ssaoCombinePostProcess},!0)),Y.postProcessRenderPipelineManager.addPipeline(K),Q&&Y.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(Z,Q),K}return Object.defineProperty(k.prototype,"samples",{get:function(){return this._samples},set:function(Z){this._samples=Z,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()},enumerable:!1,configurable:!0}),Object.defineProperty(k.prototype,"textureSamples",{get:function(){return this._textureSamples},set:function(Z){this._textureSamples=Z,this._prePassRenderer?this._prePassRenderer.samples=Z:this._originalColorPostProcess.samples=Z},enumerable:!1,configurable:!0}),Object.defineProperty(k.prototype,"expensiveBlur",{get:function(){return this._expensiveBlur},set:function(Z){this._blurHPostProcess.updateEffect(`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(Z?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._blurVPostProcess.updateEffect(`#define BILATERAL_BLUR
#define SAMPLES 16
#define EXPENSIVE `+(Z?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._expensiveBlur=Z},enumerable:!1,configurable:!0}),Object.defineProperty(k,"IsSupported",{get:function(){var Z=g.a.LastCreatedEngine;return Z?Z._features.supportSSAO2:!1},enumerable:!1,configurable:!0}),Object.defineProperty(k.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),k.prototype.getClassName=function(){return"SSAO2RenderingPipeline"},k.prototype.dispose=function(Z){Z===void 0&&(Z=!1);for(var Y=0;Y<this._scene.cameras.length;Y++){var U=this._scene.cameras[Y];this._originalColorPostProcess.dispose(U),this._ssaoPostProcess.dispose(U),this._blurHPostProcess.dispose(U),this._blurVPostProcess.dispose(U),this._ssaoCombinePostProcess.dispose(U)}this._randomTexture.dispose(),Z&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),I.prototype.dispose.call(this)},k.prototype._createBlurPostProcess=function(Z,Y){var U=this;this._samplerOffsets=[];for(var Q=this.expensiveBlur,G=-8;G<8;G++)this._samplerOffsets.push(G*2+.5);this._blurHPostProcess=new p.a("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],Z,null,H.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(Q?"1":"0")+`
`),this._blurHPostProcess.onApply=function(K){!U._scene.activeCamera||(K.setFloat("outSize",U._ssaoCombinePostProcess.width>0?U._ssaoCombinePostProcess.width:U._originalColorPostProcess.width),K.setFloat("near",U._scene.activeCamera.minZ),K.setFloat("far",U._scene.activeCamera.maxZ),K.setFloat("radius",U.radius),U._forceGeometryBuffer?K.setTexture("depthSampler",U._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]):K.setTexture("depthSampler",U._prePassRenderer.getRenderTarget().textures[U._prePassRenderer.getIndex(5)]),K.setArray("samplerOffsets",U._samplerOffsets))},this._blurVPostProcess=new p.a("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],Y,null,H.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_V
#define SAMPLES 16
#define EXPENSIVE `+(Q?"1":"0")+`
`),this._blurVPostProcess.onApply=function(K){!U._scene.activeCamera||(K.setFloat("outSize",U._ssaoCombinePostProcess.height>0?U._ssaoCombinePostProcess.height:U._originalColorPostProcess.height),K.setFloat("near",U._scene.activeCamera.minZ),K.setFloat("far",U._scene.activeCamera.maxZ),K.setFloat("radius",U.radius),U._forceGeometryBuffer?K.setTexture("depthSampler",U._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]):K.setTexture("depthSampler",U._prePassRenderer.getRenderTarget().textures[U._prePassRenderer.getIndex(5)]),K.setArray("samplerOffsets",U._samplerOffsets))},this._blurHPostProcess.samples=this.textureSamples,this._blurVPostProcess.samples=this.textureSamples},k.prototype._rebuild=function(){I.prototype._rebuild.call(this)},k.prototype._radicalInverse_VdC=function(Z){return this._bits[0]=Z,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(this._bits[0]&1431655765)<<1|(this._bits[0]&2863311530)>>>1>>>0,this._bits[0]=(this._bits[0]&858993459)<<2|(this._bits[0]&3435973836)>>>2>>>0,this._bits[0]=(this._bits[0]&252645135)<<4|(this._bits[0]&4042322160)>>>4>>>0,this._bits[0]=(this._bits[0]&16711935)<<8|(this._bits[0]&4278255360)>>>8>>>0,this._bits[0]*23283064365386963e-26},k.prototype._hammersley=function(Z,Y){return[Z/Y,this._radicalInverse_VdC(Z)]},k.prototype._hemisphereSample_uniform=function(Z,Y){var U=Y*2*Math.PI,Q=1-(Z*.85+.15),G=Math.sqrt(1-Q*Q);return new O.e(Math.cos(U)*G,Math.sin(U)*G,Q)},k.prototype._generateHemisphere=function(){for(var Z=this.samples,Y=[],U,Q=0;Q<Z;){if(Z<16)U=this._hemisphereSample_uniform(Math.random(),Math.random());else{var G=this._hammersley(Q,Z);U=this._hemisphereSample_uniform(G[0],G[1])}Y.push(U.x,U.y,U.z),Q++}return Y},k.prototype._getDefinesForSSAO=function(){var Z="#define SAMPLES "+this.samples+`
#define SSAO`;return Z},k.prototype._createSSAOPostProcess=function(Z){var Y=this;this._sampleSphere=this._generateHemisphere();var U=this._getDefinesForSSAO(),Q=["randomSampler","depthSampler","normalSampler"];this._ssaoPostProcess=new p.a("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],Q,Z,null,H.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,U),this._ssaoPostProcess.onApply=function(G){var K,fe,ce,re;if(!!Y._scene.activeCamera){if(G.setArray3("sampleSphere",Y._sampleSphere),G.setFloat("randTextureTiles",32),G.setFloat("samplesFactor",1/Y.samples),G.setFloat("totalStrength",Y.totalStrength),G.setFloat2("texelSize",1/Y._ssaoPostProcess.width,1/Y._ssaoPostProcess.height),G.setFloat("radius",Y.radius),G.setFloat("maxZ",Y.maxZ),G.setFloat("minZAspect",Y.minZAspect),G.setFloat("base",Y.base),G.setFloat("near",Y._scene.activeCamera.minZ),G.setFloat("far",Y._scene.activeCamera.maxZ),Y._scene.activeCamera.mode===M.a.PERSPECTIVE_CAMERA)G.setMatrix3x3("depthProjection",k.PERSPECTIVE_DEPTH_PROJECTION),G.setFloat("xViewport",Math.tan(Y._scene.activeCamera.fov/2)*Y._scene.getEngine().getAspectRatio(Y._scene.activeCamera,!0)),G.setFloat("yViewport",Math.tan(Y._scene.activeCamera.fov/2));else{var Re=Y._scene.getEngine().getRenderWidth()/2,Ie=Y._scene.getEngine().getRenderHeight()/2,Ce=(K=Y._scene.activeCamera.orthoLeft)!==null&&K!==void 0?K:-Re,X=(fe=Y._scene.activeCamera.orthoRight)!==null&&fe!==void 0?fe:Re,ae=(ce=Y._scene.activeCamera.orthoBottom)!==null&&ce!==void 0?ce:-Ie,ee=(re=Y._scene.activeCamera.orthoTop)!==null&&re!==void 0?re:Ie;G.setMatrix3x3("depthProjection",k.ORTHO_DEPTH_PROJECTION),G.setFloat("xViewport",(X-Ce)*.5),G.setFloat("yViewport",(ee-ae)*.5)}G.setMatrix("projection",Y._scene.getProjectionMatrix()),Y._forceGeometryBuffer?(G.setTexture("depthSampler",Y._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]),G.setTexture("normalSampler",Y._scene.enableGeometryBufferRenderer().getGBuffer().textures[1])):(G.setTexture("depthSampler",Y._prePassRenderer.getRenderTarget().textures[Y._prePassRenderer.getIndex(5)]),G.setTexture("normalSampler",Y._prePassRenderer.getRenderTarget().textures[Y._prePassRenderer.getIndex(6)])),G.setTexture("randomSampler",Y._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples},k.prototype._createSSAOCombinePostProcess=function(Z){var Y=this;this._ssaoCombinePostProcess=new p.a("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],Z,null,H.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(U){var Q=Y._scene.activeCamera.viewport;U.setVector4("viewport",O.c.Vector4[0].copyFromFloats(Q.x,Q.y,Q.width,Q.height)),U.setTextureFromPostProcessOutput("originalColor",Y._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoCombinePostProcess._prePassEffectConfiguration=new v)},k.prototype._createRandomTexture=function(){var Z=128;this._randomTexture=new A.a("SSAORandomTexture",Z,this._scene,!1,H.a.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=H.a.WRAP_ADDRESSMODE,this._randomTexture.wrapV=H.a.WRAP_ADDRESSMODE;for(var Y=this._randomTexture.getContext(),U=function(fe,ce){return Math.random()*(ce-fe)+fe},Q=O.e.Zero(),G=0;G<Z;G++)for(var K=0;K<Z;K++)Q.x=U(0,1),Q.y=U(0,1),Q.z=0,Q.normalize(),Q.scaleInPlace(255),Q.x=Math.floor(Q.x),Q.y=Math.floor(Q.y),Y.fillStyle="rgb("+Q.x+", "+Q.y+", "+Q.z+")",Y.fillRect(G,K,1,1);this._randomTexture.update(!1)},k.prototype.serialize=function(){var Z=j.a.Serialize(this);return Z.customType="SSAO2RenderingPipeline",Z},k.Parse=function(Z,Y,U){return j.a.Parse(function(){return new k(Z._name,Y,Z._ratio)},Z,Y,U)},k.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],k.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],Object(T.c)([Object(j.c)()],k.prototype,"totalStrength",void 0),Object(T.c)([Object(j.c)()],k.prototype,"maxZ",void 0),Object(T.c)([Object(j.c)()],k.prototype,"minZAspect",void 0),Object(T.c)([Object(j.c)("samples")],k.prototype,"_samples",void 0),Object(T.c)([Object(j.c)("textureSamples")],k.prototype,"_textureSamples",void 0),Object(T.c)([Object(j.c)()],k.prototype,"_ratio",void 0),Object(T.c)([Object(j.c)("expensiveBlur")],k.prototype,"_expensiveBlur",void 0),Object(T.c)([Object(j.c)()],k.prototype,"radius",void 0),Object(T.c)([Object(j.c)()],k.prototype,"base",void 0),k}(f.a);d.a.RegisteredTypes["BABYLON.SSAO2RenderingPipeline"]=L},598:function(Ue,P,u){"use strict";u.d(P,"a",function(){return f});var T=u(434),S=u(538),j=u(518),O=function(h){Object(T.d)(m,h);function m(d,g,v,l,y,E){var R=h.call(this,d,v,l,y,E)||this;return R._beforeCompositionPostProcesses=[],R._internalTextureDirty=!1,R.enabled=!1,R.renderTargetTexture=null,R.renderTargetTexture=g,R}return m.prototype._createCompositionEffect=function(){this.imageProcessingPostProcess=new j.a("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()},m.prototype._checkSize=function(){var d=this._engine.getRenderWidth(!0),g=this._engine.getRenderHeight(!0),v=this.getRenderWidth(),l=this.getRenderHeight();(v!==d||l!==g)&&(this.resize({width:d,height:g}),this._internalTextureDirty=!0)},m.prototype.updateCount=function(d,g){h.prototype.updateCount.call(this,d,g),this._internalTextureDirty=!0},m.prototype._resetPostProcessChain=function(){this._beforeCompositionPostProcesses=[]},m.prototype.dispose=function(){var d=this._scene;if(h.prototype.dispose.call(this),d&&d.prePassRenderer){var g=d.prePassRenderer.renderTargets.indexOf(this);g!==-1&&d.prePassRenderer.renderTargets.splice(g,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose()},m}(S.a),M=u(476),H=u(441),A=u(459),p=u(502),f=function(){function h(m){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtFormats=[],this._mrtLayout=[],this._textureIndices=[],this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!1,this.renderTargets=[],this._clearColor=new H.b(0,0,0,0),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=m,this._engine=m.getEngine(),h._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._setRenderTarget(null)}return h.prototype.getIndex=function(m){return this._textureIndices[m]},Object.defineProperty(h.prototype,"samples",{get:function(){return this.defaultRT.samples},set:function(m){this.defaultRT.samples=m},enumerable:!1,configurable:!0}),h.prototype.getRenderTarget=function(){return this._currentTarget},h.prototype._setRenderTarget=function(m){m?this._currentTarget=m:this._currentTarget=this.defaultRT},Object.defineProperty(h.prototype,"currentRTisSceneRT",{get:function(){return this._currentTarget===this.defaultRT},enumerable:!1,configurable:!0}),h.prototype._refreshGeometryBufferRendererLink=function(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}},Object.defineProperty(h.prototype,"enabled",{get:function(){return this._enabled},enumerable:!1,configurable:!0}),h.prototype._createRenderTarget=function(m,d){var g=new O(m,d,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(g),g},Object.defineProperty(h.prototype,"isSupported",{get:function(){return this._scene.getEngine().getCaps().drawBuffersExtension},enumerable:!1,configurable:!0}),h.prototype.bindAttachmentsForEffect=function(m,d){if(this.enabled&&this._currentTarget.enabled){if(m._multiTarget)this._engine.bindAttachments(this._multiRenderAttachments);else if(this._engine.bindAttachments(this._defaultAttachments),this._geometryBuffer&&this.currentRTisSceneRT){var g=d.getMaterial();g&&!g.isPrePassCapable&&this.excludedMaterials.indexOf(g)===-1&&this._geometryBuffer.renderList.push(d.getRenderingMesh())}}},h.prototype._reinitializeAttachments=function(){for(var m=[],d=[!1],g=[!0],v=0;v<this.mrtCount;v++)m.push(!0),v>0&&(d.push(!0),g.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(m),this._clearAttachments=this._engine.buildTextureLayout(d),this._defaultAttachments=this._engine.buildTextureLayout(g)},h.prototype._resetLayout=function(){for(var m=0;m<h._textureFormats.length;m++)this._textureIndices[h._textureFormats[m].type]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtFormats=[2],this.mrtCount=1},h.prototype._updateGeometryBufferLayout=function(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();for(var m=[],d=0;d<this._mrtLayout.length;d++)m.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());for(var g=[{prePassConstant:5,geometryBufferConstant:p.a.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:p.a.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:p.a.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:p.a.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:p.a.VELOCITY_TEXTURE_TYPE}],d=0;d<g.length;d++){var v=this._mrtLayout.indexOf(g[d].prePassConstant);v!==-1&&(this._geometryBuffer._forceTextureType(g[d].geometryBufferConstant,v),m[v]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(m))}},h.prototype.restoreAttachments=function(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&this._engine.bindAttachments(this._defaultAttachments)},h.prototype._beforeDraw=function(m,d,g){this._isDirty&&this._update(),!(!this._enabled||!this._currentTarget.enabled)&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,m))},h.prototype._prepareFrame=function(m,d,g){m.renderTargetTexture?m.renderTargetTexture._prepareFrame(this._scene,d,g,m.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()},h.prototype._renderPostProcesses=function(m,d){var g=this._postProcessesSourceForThisPass[0],v=g?g.inputTexture:m.renderTargetTexture?m.renderTargetTexture.getInternalTexture():null,l=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(l=l.concat([this._currentTarget.imageProcessingPostProcess])),l.length&&(this._scene.postProcessManager._prepareFrame(this._currentTarget.getInternalTexture(),l),this._scene.postProcessManager.directRender(l,v,!1,d))},h.prototype._afterDraw=function(m,d){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,m,d),this._renderPostProcesses(this._currentTarget,m))},h.prototype._clear=function(){this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(this._currentTarget),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._engine.bindAttachments(this._defaultAttachments))},h.prototype._bindFrameBuffer=function(m){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();var d=this._currentTarget.getInternalTexture();d&&this._engine.bindFramebuffer(d)}},h.prototype._setEnabled=function(m){this._enabled=m},h.prototype._setRenderTargetEnabled=function(m,d){m.enabled=d},h.prototype.addEffectConfiguration=function(m){for(var d=0;d<this._effectConfigurations.length;d++)if(this._effectConfigurations[d].name===m.name)return this._effectConfigurations[d];return this._effectConfigurations.push(m),m},h.prototype._enable=function(){for(var m=this.mrtCount,d=0;d<this._effectConfigurations.length;d++)this._effectConfigurations[d].enabled&&this._enableTextures(this._effectConfigurations[d].texturesRequired);for(var d=0;d<this.renderTargets.length;d++){this.mrtCount!==m&&this.renderTargets[d].updateCount(this.mrtCount,{types:this._mrtFormats}),this.renderTargets[d]._resetPostProcessChain();for(var g=0;g<this._effectConfigurations.length;g++)this._effectConfigurations[g].enabled&&(!this._effectConfigurations[g].postProcess&&this._effectConfigurations[g].createPostProcess&&this._effectConfigurations[g].createPostProcess(),this._effectConfigurations[g].postProcess&&this.renderTargets[d]._beforeCompositionPostProcesses.push(this._effectConfigurations[g].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()},h.prototype._disable=function(){this._setEnabled(!1);for(var m=0;m<this.renderTargets.length;m++)this._setRenderTargetEnabled(this.renderTargets[m],!1);this._resetLayout();for(var m=0;m<this._effectConfigurations.length;m++)this._effectConfigurations[m].enabled=!1},h.prototype._getPostProcessesSource=function(m,d){if(d)return d._postProcesses;if(m.renderTargetTexture)if(m.renderTargetTexture.useCameraPostProcesses){var g=m.renderTargetTexture.activeCamera?m.renderTargetTexture.activeCamera:this._scene.activeCamera;return g?g._postProcesses:[]}else return m.renderTargetTexture.postProcesses?m.renderTargetTexture.postProcesses:[];else return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]},h.prototype._setupOutputForThisPass=function(m,d){var g=d&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&this._scene.activeCameras.indexOf(d)!==0;this._postProcessesSourceForThisPass=this._getPostProcessesSource(m,d),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(function(R){return R!=null}),this._scene.autoClear=!0;var v=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!v&&!this.disableGammaTransform&&this._needsImageProcessing()&&!g;var l=this._getFirstPostProcess(this._postProcessesSourceForThisPass),y=m._beforeCompositionPostProcesses&&m._beforeCompositionPostProcesses[0],E=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||v,this._needsCompositionForThisPass&&!m.imageProcessingPostProcess&&m._createCompositionEffect(),y?E=y:this._needsCompositionForThisPass?E=m.imageProcessingPostProcess:l&&(E=l),this._bindFrameBuffer(m),this._linkInternalTexture(m,E)},h.prototype._linkInternalTexture=function(m,d){d&&(d.autoClear=!1,d.inputTexture=m.getInternalTexture()),m._outputPostProcess!==d&&(m._outputPostProcess&&m._outputPostProcess.restoreDefaultInputTexture(),m._outputPostProcess=d),m._internalTextureDirty&&(this._updateGeometryBufferLayout(),m._internalTextureDirty=!1)},h.prototype._needsImageProcessing=function(){for(var m=0;m<this._effectConfigurations.length;m++)if(this._effectConfigurations[m].enabled&&this._effectConfigurations[m].needsImageProcessing)return!0;return!1},h.prototype._hasImageProcessing=function(m){var d,g=!1;if(m){for(var v=0;v<m.length;v++)if(((d=m[v])===null||d===void 0?void 0:d.getClassName())==="ImageProcessingPostProcess"){g=!0;break}}return g},h.prototype._getFirstPostProcess=function(m){for(var d=0;d<m.length;d++)if(m[d]!==null)return m[d];return null},h.prototype.markAsDirty=function(){this._isDirty=!0},h.prototype._enableTextures=function(m){for(var d=0;d<m.length;d++){var g=m[d];this._textureIndices[g]===-1&&(this._textureIndices[g]=this._mrtLayout.length,this._mrtLayout.push(g),this._mrtFormats.push(h._textureFormats[g].format),this.mrtCount++)}},h.prototype._update=function(){this._disable();var m=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1;for(var d=0;d<this._scene.materials.length;d++)this._scene.materials[d].setPrePassRenderer(this)&&(m=!0);m&&this._setRenderTargetEnabled(this.defaultRT,!0);for(var g,d=0;d<this.renderTargets.length;d++){if(this.renderTargets[d].renderTargetTexture)g=this._getPostProcessesSource(this.renderTargets[d]);else{var v=this._scene.activeCamera;if(!v)continue;g=v._postProcesses}if(!!g&&(g=g.filter(function(E){return E!=null}),g)){for(var l=0;l<g.length;l++)g[l].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[d],!0),m=!0);this._hasImageProcessing(g)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,m&&this._enable()},h.prototype._markAllMaterialsAsPrePassDirty=function(){for(var m=this._scene.materials,d=0;d<m.length;d++)m[d].markAsDirty(A.a.PrePassDirtyFlag)},h.prototype.dispose=function(){for(var m=this.renderTargets.length-1;m>=0;m--)this.renderTargets[m].dispose();for(var m=0;m<this._effectConfigurations.length;m++)this._effectConfigurations[m].dispose&&this._effectConfigurations[m].dispose()},h._SceneComponentInitialization=function(m){throw M.a.WarnImport("PrePassRendererSceneComponent")},h._textureFormats=[{type:0,format:2},{type:1,format:2},{type:2,format:2},{type:3,format:0},{type:4,format:2},{type:5,format:2},{type:6,format:2},{type:7,format:0}],h}()},599:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(439),j=u(436),O=u(453),M=u(484),H=u(537);O.a.AddNodeConstructor("Light_Type_1",function(p,f){return function(){return new A(p,j.e.Zero(),f)}});var A=function(p){Object(T.d)(f,p);function f(h,m,d){var g=p.call(this,h,d)||this;return g._shadowFrustumSize=0,g._shadowOrthoScale=.1,g.autoUpdateExtends=!0,g.autoCalcShadowZBounds=!1,g._orthoLeft=Number.MAX_VALUE,g._orthoRight=Number.MIN_VALUE,g._orthoTop=Number.MIN_VALUE,g._orthoBottom=Number.MAX_VALUE,g.position=m.scale(-1),g.direction=m,g}return Object.defineProperty(f.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(h){this._shadowFrustumSize=h,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(h){this._shadowOrthoScale=h,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"orthoLeft",{get:function(){return this._orthoLeft},set:function(h){this._orthoLeft=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"orthoRight",{get:function(){return this._orthoRight},set:function(h){this._orthoRight=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"orthoTop",{get:function(){return this._orthoTop},set:function(h){this._orthoTop=h},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"orthoBottom",{get:function(){return this._orthoBottom},set:function(h){this._orthoBottom=h},enumerable:!1,configurable:!0}),f.prototype.getClassName=function(){return"DirectionalLight"},f.prototype.getTypeID=function(){return M.a.LIGHTTYPEID_DIRECTIONALLIGHT},f.prototype._setDefaultShadowProjectionMatrix=function(h,m,d){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(h):this._setDefaultAutoExtendShadowProjectionMatrix(h,m,d)},f.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(h){var m=this.getScene().activeCamera;!m||j.a.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:m.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:m.maxZ,h)},f.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(h,m,d){var g=this.getScene().activeCamera;if(!!g){if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var v=j.e.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;for(var l=Number.MAX_VALUE,y=Number.MIN_VALUE,E=0;E<d.length;E++){var R=d[E];if(!!R)for(var F=R.getBoundingInfo(),B=F.boundingBox,L=0;L<B.vectorsWorld.length;L++)j.e.TransformCoordinatesToRef(B.vectorsWorld[L],m,v),v.x<this._orthoLeft&&(this._orthoLeft=v.x),v.y<this._orthoBottom&&(this._orthoBottom=v.y),v.x>this._orthoRight&&(this._orthoRight=v.x),v.y>this._orthoTop&&(this._orthoTop=v.y),this.autoCalcShadowZBounds&&(v.z<l&&(l=v.z),v.z>y&&(y=v.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=l,this._shadowMaxZ=y)}var I=this._orthoRight-this._orthoLeft,k=this._orthoTop-this._orthoBottom;j.a.OrthoOffCenterLHToRef(this._orthoLeft-I*this.shadowOrthoScale,this._orthoRight+I*this.shadowOrthoScale,this._orthoBottom-k*this.shadowOrthoScale,this._orthoTop+k*this.shadowOrthoScale,this.shadowMinZ!==void 0?this.shadowMinZ:g.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:g.maxZ,h)}},f.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},f.prototype.transferToEffect=function(h,m){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,m),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,m),this)},f.prototype.transferToNodeMaterialEffect=function(h,m){return this.computeTransformedInformation()?(h.setFloat3(m,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(h.setFloat3(m,this.direction.x,this.direction.y,this.direction.z),this)},f.prototype.getDepthMinZ=function(h){return 1},f.prototype.getDepthMaxZ=function(h){return 1},f.prototype.prepareLightSpecificDefines=function(h,m){h["DIRLIGHT"+m]=!0},Object(T.c)([Object(S.c)()],f.prototype,"shadowFrustumSize",null),Object(T.c)([Object(S.c)()],f.prototype,"shadowOrthoScale",null),Object(T.c)([Object(S.c)()],f.prototype,"autoUpdateExtends",void 0),Object(T.c)([Object(S.c)()],f.prototype,"autoCalcShadowZBounds",void 0),Object(T.c)([Object(S.c)("orthoLeft")],f.prototype,"_orthoLeft",void 0),Object(T.c)([Object(S.c)("orthoRight")],f.prototype,"_orthoRight",void 0),Object(T.c)([Object(S.c)("orthoTop")],f.prototype,"_orthoTop",void 0),Object(T.c)([Object(S.c)("orthoBottom")],f.prototype,"_orthoBottom",void 0),f}(H.a)},600:function(Ue,P,u){"use strict";var T=u(435),S="chromaticAberrationPixelShader",j=`
uniform sampler2D textureSampler;

uniform float chromatic_aberration;
uniform float radialIntensity;
uniform vec2 direction;
uniform vec2 centerPosition;
uniform float screen_width;
uniform float screen_height;

varying vec2 vUV;
void main(void)
{
vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);
vec2 directionOfEffect=direction;
if(directionOfEffect.x == 0. && directionOfEffect.y == 0.){
directionOfEffect=normalize(centered_screen_pos);
}
float radius2=centered_screen_pos.x*centered_screen_pos.x
+centered_screen_pos.y*centered_screen_pos.y;
float radius=sqrt(radius2);
vec4 original=texture2D(textureSampler,vUV);

vec3 ref_indices=vec3(-0.3,0.0,0.3);
float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;
float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;

vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);
vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);
vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);
original.r=texture2D(textureSampler,ref_coords_r).r;
original.g=texture2D(textureSampler,ref_coords_g).g;
original.b=texture2D(textureSampler,ref_coords_b).b;
original.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);
gl_FragColor=original;
}`;T.a.ShadersStore[S]=j;var O={name:S,shader:j}},601:function(Ue,P,u){"use strict";var T=u(435),S="ssaoCombinePixelShader",j=`uniform sampler2D textureSampler;
uniform sampler2D originalColor;
uniform vec4 viewport;
varying vec2 vUV;
void main(void) {
vec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);
vec4 sceneColor=texture2D(originalColor,vUV);
gl_FragColor=sceneColor*ssaoColor;
}
`;T.a.ShadersStore[S]=j;var O={name:S,shader:j}},602:function(Ue,P,u){"use strict";u.d(P,"a",function(){return F}),u.d(P,"b",function(){return fe}),u.d(P,"g",function(){return ce.a}),u.d(P,"h",function(){return w}),u.d(P,"i",function(){return Me}),u.d(P,"c",function(){return g.a}),u.d(P,"d",function(){return d.a}),u.d(P,"e",function(){return Te.a}),u.d(P,"f",function(){return R.a});var T=u(434),S=u(439),j=u(438),O=u(440),M=u(442),H=u(577),A=u(587),p=u(518),f=u(579),h=u(586),m=u(517),d=u(481),g=u(466),v=u(570),l=u(578),y=u(437),E=u(448),R=u(482),F=function(Ae){Object(T.d)(se,Ae);function se(te,he,de,Ne,Le){te===void 0&&(te=""),he===void 0&&(he=!0),de===void 0&&(de=E.a.LastCreatedScene),Le===void 0&&(Le=!0);var pe=Ae.call(this,de.getEngine(),te)||this;pe._camerasToBeAttached=[],pe.SharpenPostProcessId="SharpenPostProcessEffect",pe.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",pe.FxaaPostProcessId="FxaaPostProcessEffect",pe.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",pe.GrainPostProcessId="GrainPostProcessEffect",pe._glowLayer=null,pe.animations=[],pe._imageProcessingConfigurationObserver=null,pe._sharpenEnabled=!1,pe._bloomEnabled=!1,pe._depthOfFieldEnabled=!1,pe._depthOfFieldBlurLevel=v.b.Low,pe._fxaaEnabled=!1,pe._imageProcessingEnabled=!0,pe._bloomScale=.5,pe._chromaticAberrationEnabled=!1,pe._grainEnabled=!1,pe._buildAllowed=!0,pe.onBuildObservable=new j.c,pe._resizeObserver=null,pe._hardwareScaleLevel=1,pe._bloomKernel=64,pe._bloomWeight=.15,pe._bloomThreshold=.9,pe._samples=1,pe._hasCleared=!1,pe._prevPostProcess=null,pe._prevPrevPostProcess=null,pe._depthOfFieldSceneObserver=null,pe._cameras=Ne||de.cameras,pe._cameras=pe._cameras.slice(),pe._camerasToBeAttached=pe._cameras.slice(),pe._buildAllowed=Le,pe._scene=de;var He=pe._scene.getEngine().getCaps();pe._hdr=he&&(He.textureHalfFloatRender||He.textureFloatRender),pe._hdr?He.textureHalfFloatRender?pe._defaultPipelineTextureType=2:He.textureFloatRender&&(pe._defaultPipelineTextureType=1):pe._defaultPipelineTextureType=0,de.postProcessRenderPipelineManager.addPipeline(pe);var rt=pe._scene.getEngine();return pe.sharpen=new A.a("sharpen",1,null,M.a.BILINEAR_SAMPLINGMODE,rt,!1,pe._defaultPipelineTextureType,!0),pe._sharpenEffect=new g.a(rt,pe.SharpenPostProcessId,function(){return pe.sharpen},!0),pe.depthOfField=new v.a(pe._scene,null,pe._depthOfFieldBlurLevel,pe._defaultPipelineTextureType,!0),pe.bloom=new l.a(pe._scene,pe._bloomScale,pe._bloomWeight,pe.bloomKernel,pe._defaultPipelineTextureType,!0),pe.chromaticAberration=new f.a("ChromaticAberration",rt.getRenderWidth(),rt.getRenderHeight(),1,null,M.a.BILINEAR_SAMPLINGMODE,rt,!1,pe._defaultPipelineTextureType,!0),pe._chromaticAberrationEffect=new g.a(rt,pe.ChromaticAberrationPostProcessId,function(){return pe.chromaticAberration},!0),pe.grain=new h.a("Grain",1,null,M.a.BILINEAR_SAMPLINGMODE,rt,!1,pe._defaultPipelineTextureType,!0),pe._grainEffect=new g.a(rt,pe.GrainPostProcessId,function(){return pe.grain},!0),pe._resizeObserver=rt.onResizeObservable.add(function(){pe._hardwareScaleLevel=rt.getHardwareScalingLevel(),pe.bloomKernel=pe.bloomKernel}),pe._imageProcessingConfigurationObserver=pe._scene.imageProcessingConfiguration.onUpdateParameters.add(function(){pe.bloom._downscale._exposure=pe._scene.imageProcessingConfiguration.exposure,pe.imageProcessingEnabled!==pe._scene.imageProcessingConfiguration.isEnabled&&(pe._imageProcessingEnabled=pe._scene.imageProcessingConfiguration.isEnabled,pe._buildPipeline())}),pe._buildPipeline(),pe}return Object.defineProperty(se.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"sharpenEnabled",{get:function(){return this._sharpenEnabled},set:function(te){this._sharpenEnabled!==te&&(this._sharpenEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"bloomKernel",{get:function(){return this._bloomKernel},set:function(te){this._bloomKernel=te,this.bloom.kernel=te/this._hardwareScaleLevel},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"bloomWeight",{get:function(){return this._bloomWeight},set:function(te){this._bloomWeight!==te&&(this.bloom.weight=te,this._bloomWeight=te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"bloomThreshold",{get:function(){return this._bloomThreshold},set:function(te){this._bloomThreshold!==te&&(this.bloom.threshold=te,this._bloomThreshold=te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"bloomScale",{get:function(){return this._bloomScale},set:function(te){this._bloomScale!==te&&(this._bloomScale=te,this._rebuildBloom(),this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"bloomEnabled",{get:function(){return this._bloomEnabled},set:function(te){this._bloomEnabled!==te&&(this._bloomEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),se.prototype._rebuildBloom=function(){var te=this.bloom;this.bloom=new l.a(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel,this._defaultPipelineTextureType,!1),this.bloom.threshold=te.threshold;for(var he=0;he<this._cameras.length;he++)te.disposeEffects(this._cameras[he])},Object.defineProperty(se.prototype,"depthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(te){this._depthOfFieldEnabled!==te&&(this._depthOfFieldEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"depthOfFieldBlurLevel",{get:function(){return this._depthOfFieldBlurLevel},set:function(te){if(this._depthOfFieldBlurLevel!==te){this._depthOfFieldBlurLevel=te;var he=this.depthOfField;this.depthOfField=new v.a(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=he.focalLength,this.depthOfField.focusDistance=he.focusDistance,this.depthOfField.fStop=he.fStop,this.depthOfField.lensSize=he.lensSize;for(var de=0;de<this._cameras.length;de++)he.disposeEffects(this._cameras[de]);this._buildPipeline()}},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(te){this._fxaaEnabled!==te&&(this._fxaaEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"samples",{get:function(){return this._samples},set:function(te){this._samples!==te&&(this._samples=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"imageProcessingEnabled",{get:function(){return this._imageProcessingEnabled},set:function(te){this._imageProcessingEnabled!==te&&(this._scene.imageProcessingConfiguration.isEnabled=te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"glowLayerEnabled",{get:function(){return this._glowLayer!=null},set:function(te){te&&!this._glowLayer?this._glowLayer=new H.a("",this._scene):!te&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"glowLayer",{get:function(){return this._glowLayer},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"chromaticAberrationEnabled",{get:function(){return this._chromaticAberrationEnabled},set:function(te){this._chromaticAberrationEnabled!==te&&(this._chromaticAberrationEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"grainEnabled",{get:function(){return this._grainEnabled},set:function(te){this._grainEnabled!==te&&(this._grainEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),se.prototype.getClassName=function(){return"DefaultRenderingPipeline"},se.prototype.prepare=function(){var te=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=te},se.prototype._setAutoClearAndTextureSharing=function(te,he){he===void 0&&(he=!1),this._hasCleared?te.autoClear=!1:(te.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),he||(this._prevPrevPostProcess?te.shareOutputWith(this._prevPrevPostProcess):te.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=te)},se.prototype._buildPipeline=function(){var te=this;if(!!this._buildAllowed){this._scene.autoClear=!0;var he=this._scene.getEngine();if(this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(var de=0,Ne=this._cameras;de<Ne.length;de++){var Le=Ne[de],pe=this._scene.enableDepthRenderer(Le);pe.useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(function(He){te._cameras.indexOf(He.activeCamera)>-1&&(te.depthOfField.depthTexture=He.enableDepthRenderer(He.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);var pe=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=pe.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new p.a("imageProcessing",1,null,M.a.BILINEAR_SAMPLINGMODE,he,!1,this._defaultPipelineTextureType),this._hdr?(this.addEffect(new g.a(he,this.ImageProcessingPostProcessId,function(){return te.imageProcessing},!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,(!this.cameras||this.cameras.length===0)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new m.a("fxaa",1,null,M.a.BILINEAR_SAMPLINGMODE,he,!1,this._defaultPipelineTextureType),this.addEffect(new g.a(he,this.FxaaPostProcessId,function(){return te.fxaa},!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&O.a.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}},se.prototype._disposePostProcesses=function(te){te===void 0&&(te=!1);for(var he=0;he<this._cameras.length;he++){var de=this._cameras[he];this.imageProcessing&&this.imageProcessing.dispose(de),this.fxaa&&this.fxaa.dispose(de),te&&(this.sharpen&&this.sharpen.dispose(de),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(de)),this.bloom&&this.bloom.disposeEffects(de),this.chromaticAberration&&this.chromaticAberration.dispose(de),this.grain&&this.grain.dispose(de),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,te&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)},se.prototype.addCamera=function(te){this._camerasToBeAttached.push(te),this._buildPipeline()},se.prototype.removeCamera=function(te){var he=this._camerasToBeAttached.indexOf(te);this._camerasToBeAttached.splice(he,1),this._buildPipeline()},se.prototype.dispose=function(){this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),Ae.prototype.dispose.call(this)},se.prototype.serialize=function(){var te=S.a.Serialize(this);return te.customType="DefaultRenderingPipeline",te},se.Parse=function(te,he,de){return S.a.Parse(function(){return new se(te._name,te._name._hdr,he)},te,he,de)},Object(T.c)([Object(S.c)()],se.prototype,"sharpenEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"bloomKernel",null),Object(T.c)([Object(S.c)()],se.prototype,"_bloomWeight",void 0),Object(T.c)([Object(S.c)()],se.prototype,"_bloomThreshold",void 0),Object(T.c)([Object(S.c)()],se.prototype,"_hdr",void 0),Object(T.c)([Object(S.c)()],se.prototype,"bloomWeight",null),Object(T.c)([Object(S.c)()],se.prototype,"bloomThreshold",null),Object(T.c)([Object(S.c)()],se.prototype,"bloomScale",null),Object(T.c)([Object(S.c)()],se.prototype,"bloomEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"depthOfFieldEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"depthOfFieldBlurLevel",null),Object(T.c)([Object(S.c)()],se.prototype,"fxaaEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"samples",null),Object(T.c)([Object(S.c)()],se.prototype,"imageProcessingEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"glowLayerEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"chromaticAberrationEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"grainEnabled",null),se}(d.a);y.a.RegisteredTypes["BABYLON.DefaultRenderingPipeline"]=F;var B=u(479),L=u(444),I=u(600),k=u(435),Z="lensHighlightsPixelShader",Y=`
uniform sampler2D textureSampler;

uniform float gain;
uniform float threshold;
uniform float screen_width;
uniform float screen_height;

varying vec2 vUV;

vec4 highlightColor(vec4 color) {
vec4 highlight=color;
float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));
float lum_threshold;
if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }
else { lum_threshold=0.5+0.44*threshold; }
luminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);
highlight*=luminance*gain;
highlight.a=1.0;
return highlight;
}
void main(void)
{
vec4 original=texture2D(textureSampler,vUV);

if (gain == -1.0) {
gl_FragColor=vec4(0.0,0.0,0.0,1.0);
return;
}
float w=2.0/screen_width;
float h=2.0/screen_height;
float weight=1.0;

vec4 blurred=vec4(0.0,0.0,0.0,0.0);
#ifdef PENTAGON
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));
#else
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));
#endif
blurred/=39.0;
gl_FragColor=blurred;

}`;k.a.ShadersStore[Z]=Y;var U={name:Z,shader:Y},Q="depthOfFieldPixelShader",G=`




uniform sampler2D textureSampler;
uniform sampler2D highlightsSampler;
uniform sampler2D depthSampler;
uniform sampler2D grainSampler;

uniform float grain_amount;
uniform bool blur_noise;
uniform float screen_width;
uniform float screen_height;
uniform float distortion;
uniform bool dof_enabled;

uniform float screen_distance;
uniform float aperture;
uniform float darken;
uniform float edge_blur;
uniform bool highlights;

uniform float near;
uniform float far;

varying vec2 vUV;

#define PI 3.14159265
#define TWOPI 6.28318530
#define inverse_focal_length 0.1

vec2 centered_screen_pos;
vec2 distorted_coords;
float radius2;
float radius;

vec2 rand(vec2 co)
{
float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));
float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));
return clamp(vec2(noise1,noise2),0.0,1.0);
}

vec2 getDistortedCoords(vec2 coords) {
if (distortion == 0.0) { return coords; }
vec2 direction=1.0*normalize(centered_screen_pos);
vec2 dist_coords=vec2(0.5,0.5);
dist_coords.x=0.5+direction.x*radius2*1.0;
dist_coords.y=0.5+direction.y*radius2*1.0;
float dist_amount=clamp(distortion*0.23,0.0,1.0);
dist_coords=mix(coords,dist_coords,dist_amount);
return dist_coords;
}

float sampleScreen(inout vec4 color,const in vec2 offset,const in float weight) {

vec2 coords=distorted_coords;
float angle=rand(coords*100.0).x*TWOPI;
coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));
color+=texture2D(textureSampler,coords)*weight;
return weight;
}

float getBlurLevel(float size) {
return min(3.0,ceil(size/1.0));
}

vec4 getBlurColor(float size) {
vec4 col=texture2D(textureSampler,distorted_coords);


float blur_level=getBlurLevel(size);
float w=(size/screen_width);
float h=(size/screen_height);
float total_weight=1.0;
vec2 sample_coords;
total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);
total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);
total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);
total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);
total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);
total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);
total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);
total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);
total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);
total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);
if (blur_level>1.0) {
total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);
total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);
total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);
total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);
total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);
total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);
total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);
total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);
total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);
total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);
}
if (blur_level>2.0) {
total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);
total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);
total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);
total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);
total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);
total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);
total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);
total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);
total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);
}
col/=total_weight;

if (darken>0.0) {
col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);
}




return col;
}
void main(void)
{

centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);
radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;
radius=sqrt(radius2);
distorted_coords=getDistortedCoords(vUV);
vec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height);
float depth=texture2D(depthSampler,distorted_coords).r;
float distance=near+(far-near)*depth;
vec4 color=texture2D(textureSampler,vUV);


float coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));

if (dof_enabled == false || coc<0.07) { coc=0.0; }

float edge_blur_amount=0.0;
if (edge_blur>0.0) {
edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;
}

float blur_amount=max(edge_blur_amount,coc);

if (blur_amount == 0.0) {
gl_FragColor=texture2D(textureSampler,distorted_coords);
}
else {

gl_FragColor=getBlurColor(blur_amount*1.7);

if (highlights) {
gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;
}
if (blur_noise) {

vec2 noise=rand(distorted_coords)*0.01*blur_amount;
vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);
gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;
}
}

if (grain_amount>0.0) {
vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);
gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;
}
}
`;k.a.ShadersStore[Q]=G;var K={name:Q,shader:G},fe=function(Ae){Object(T.d)(se,Ae);function se(te,he,de,Ne,Le){Ne===void 0&&(Ne=1);var pe=Ae.call(this,de.getEngine(),te)||this;return pe.LensChromaticAberrationEffect="LensChromaticAberrationEffect",pe.HighlightsEnhancingEffect="HighlightsEnhancingEffect",pe.LensDepthOfFieldEffect="LensDepthOfFieldEffect",pe._pentagonBokehIsEnabled=!1,pe._scene=de,pe._depthTexture=de.enableDepthRenderer().getDepthMap(),he.grain_texture?pe._grainTexture=he.grain_texture:pe._createGrainTexture(),pe._edgeBlur=he.edge_blur?he.edge_blur:0,pe._grainAmount=he.grain_amount?he.grain_amount:0,pe._chromaticAberration=he.chromatic_aberration?he.chromatic_aberration:0,pe._distortion=he.distortion?he.distortion:0,pe._highlightsGain=he.dof_gain!==void 0?he.dof_gain:-1,pe._highlightsThreshold=he.dof_threshold?he.dof_threshold:1,pe._dofDistance=he.dof_focus_distance!==void 0?he.dof_focus_distance:-1,pe._dofAperture=he.dof_aperture?he.dof_aperture:1,pe._dofDarken=he.dof_darken?he.dof_darken:0,pe._dofPentagon=he.dof_pentagon!==void 0?he.dof_pentagon:!0,pe._blurNoise=he.blur_noise!==void 0?he.blur_noise:!0,pe._createChromaticAberrationPostProcess(Ne),pe._createHighlightsPostProcess(Ne),pe._createDepthOfFieldPostProcess(Ne/4),pe.addEffect(new g.a(de.getEngine(),pe.LensChromaticAberrationEffect,function(){return pe._chromaticAberrationPostProcess},!0)),pe.addEffect(new g.a(de.getEngine(),pe.HighlightsEnhancingEffect,function(){return pe._highlightsPostProcess},!0)),pe.addEffect(new g.a(de.getEngine(),pe.LensDepthOfFieldEffect,function(){return pe._depthOfFieldPostProcess},!0)),pe._highlightsGain===-1&&pe._disableEffect(pe.HighlightsEnhancingEffect,null),de.postProcessRenderPipelineManager.addPipeline(pe),Le&&de.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(te,Le),pe}return se.prototype.getClassName=function(){return"LensRenderingPipeline"},Object.defineProperty(se.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"edgeBlur",{get:function(){return this._edgeBlur},set:function(te){this.setEdgeBlur(te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"grainAmount",{get:function(){return this._grainAmount},set:function(te){this.setGrainAmount(te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"chromaticAberration",{get:function(){return this._chromaticAberration},set:function(te){this.setChromaticAberration(te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"dofAperture",{get:function(){return this._dofAperture},set:function(te){this.setAperture(te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"edgeDistortion",{get:function(){return this._distortion},set:function(te){this.setEdgeDistortion(te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"dofDistortion",{get:function(){return this._dofDistance},set:function(te){this.setFocusDistance(te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"darkenOutOfFocus",{get:function(){return this._dofDarken},set:function(te){this.setDarkenOutOfFocus(te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"blurNoise",{get:function(){return this._blurNoise},set:function(te){this._blurNoise=te},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"pentagonBokeh",{get:function(){return this._pentagonBokehIsEnabled},set:function(te){te?this.enablePentagonBokeh():this.disablePentagonBokeh()},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"highlightsGain",{get:function(){return this._highlightsGain},set:function(te){this.setHighlightsGain(te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"highlightsThreshold",{get:function(){return this._highlightsThreshold},set:function(te){this.setHighlightsThreshold(te)},enumerable:!1,configurable:!0}),se.prototype.setEdgeBlur=function(te){this._edgeBlur=te},se.prototype.disableEdgeBlur=function(){this._edgeBlur=0},se.prototype.setGrainAmount=function(te){this._grainAmount=te},se.prototype.disableGrain=function(){this._grainAmount=0},se.prototype.setChromaticAberration=function(te){this._chromaticAberration=te},se.prototype.disableChromaticAberration=function(){this._chromaticAberration=0},se.prototype.setEdgeDistortion=function(te){this._distortion=te},se.prototype.disableEdgeDistortion=function(){this._distortion=0},se.prototype.setFocusDistance=function(te){this._dofDistance=te},se.prototype.disableDepthOfField=function(){this._dofDistance=-1},se.prototype.setAperture=function(te){this._dofAperture=te},se.prototype.setDarkenOutOfFocus=function(te){this._dofDarken=te},se.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect(`#define PENTAGON
`),this._pentagonBokehIsEnabled=!0},se.prototype.disablePentagonBokeh=function(){this._pentagonBokehIsEnabled=!1,this._highlightsPostProcess.updateEffect()},se.prototype.enableNoiseBlur=function(){this._blurNoise=!0},se.prototype.disableNoiseBlur=function(){this._blurNoise=!1},se.prototype.setHighlightsGain=function(te){this._highlightsGain=te},se.prototype.setHighlightsThreshold=function(te){this._highlightsGain===-1&&(this._highlightsGain=1),this._highlightsThreshold=te},se.prototype.disableHighlights=function(){this._highlightsGain=-1},se.prototype.dispose=function(te){te===void 0&&(te=!1),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=null,this._highlightsPostProcess=null,this._depthOfFieldPostProcess=null,this._grainTexture.dispose(),te&&this._scene.disableDepthRenderer()},se.prototype._createChromaticAberrationPostProcess=function(te){var he=this;this._chromaticAberrationPostProcess=new L.a("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],te,null,M.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=function(de){de.setFloat("chromatic_aberration",he._chromaticAberration),de.setFloat("screen_width",he._scene.getEngine().getRenderWidth()),de.setFloat("screen_height",he._scene.getEngine().getRenderHeight()),de.setFloat("radialIntensity",1),de.setFloat2("direction",17,17),de.setFloat2("centerPosition",.5,.5)}},se.prototype._createHighlightsPostProcess=function(te){var he=this;this._highlightsPostProcess=new L.a("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],te,null,M.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?`#define PENTAGON
`:""),this._highlightsPostProcess.onApply=function(de){de.setFloat("gain",he._highlightsGain),de.setFloat("threshold",he._highlightsThreshold),de.setTextureFromPostProcess("textureSampler",he._chromaticAberrationPostProcess),de.setFloat("screen_width",he._scene.getEngine().getRenderWidth()),de.setFloat("screen_height",he._scene.getEngine().getRenderHeight())}},se.prototype._createDepthOfFieldPostProcess=function(te){var he=this;this._depthOfFieldPostProcess=new L.a("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],te,null,M.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.onApply=function(de){de.setTexture("depthSampler",he._depthTexture),de.setTexture("grainSampler",he._grainTexture),de.setTextureFromPostProcess("textureSampler",he._highlightsPostProcess),de.setTextureFromPostProcess("highlightsSampler",he._depthOfFieldPostProcess),de.setFloat("grain_amount",he._grainAmount),de.setBool("blur_noise",he._blurNoise),de.setFloat("screen_width",he._scene.getEngine().getRenderWidth()),de.setFloat("screen_height",he._scene.getEngine().getRenderHeight()),de.setFloat("distortion",he._distortion),de.setBool("dof_enabled",he._dofDistance!==-1),de.setFloat("screen_distance",1/(.1-1/he._dofDistance)),de.setFloat("aperture",he._dofAperture),de.setFloat("darken",he._dofDarken),de.setFloat("edge_blur",he._edgeBlur),de.setBool("highlights",he._highlightsGain!==-1),he._scene.activeCamera&&(de.setFloat("near",he._scene.activeCamera.minZ),de.setFloat("far",he._scene.activeCamera.maxZ))}},se.prototype._createGrainTexture=function(){var te=512;this._grainTexture=new B.a("LensNoiseTexture",te,this._scene,!1,M.a.BILINEAR_SAMPLINGMODE),this._grainTexture.wrapU=M.a.WRAP_ADDRESSMODE,this._grainTexture.wrapV=M.a.WRAP_ADDRESSMODE;for(var he=this._grainTexture.getContext(),de=function(He,rt){return Math.random()*(rt-He)+He},Ne,Le=0;Le<te;Le++)for(var pe=0;pe<te;pe++)Ne=Math.floor(de(.42,.58)*255),he.fillStyle="rgb("+Ne+", "+Ne+", "+Ne+")",he.fillRect(Le,pe,1,1);this._grainTexture.update(!1)},se}(d.a),ce=u(594),re=u(436),Re=u(486),Ie=u(472),Ce="ssaoPixelShader",X=`
uniform sampler2D textureSampler;
varying vec2 vUV;
#ifdef SSAO
uniform sampler2D randomSampler;
uniform float randTextureTiles;
uniform float samplesFactor;
uniform vec3 sampleSphere[SAMPLES];
uniform float totalStrength;
uniform float radius;
uniform float area;
uniform float fallOff;
uniform float base;
vec3 normalFromDepth(float depth,vec2 coords)
{
vec2 offset1=vec2(0.0,radius);
vec2 offset2=vec2(radius,0.0);
float depth1=texture2D(textureSampler,coords+offset1).r;
float depth2=texture2D(textureSampler,coords+offset2).r;
vec3 p1=vec3(offset1,depth1-depth);
vec3 p2=vec3(offset2,depth2-depth);
vec3 normal=cross(p1,p2);
normal.z=-normal.z;
return normalize(normal);
}
void main()
{
vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);
float depth=texture2D(textureSampler,vUV).r;
vec3 position=vec3(vUV,depth);
vec3 normal=normalFromDepth(depth,vUV);
float radiusDepth=radius/depth;
float occlusion=0.0;
vec3 ray;
vec3 hemiRay;
float occlusionDepth;
float difference;
for (int i=0; i<SAMPLES; i++)
{
ray=radiusDepth*reflect(sampleSphere[i],random);
hemiRay=position+sign(dot(ray,normal))*ray;
occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;
difference=depth-occlusionDepth;
occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));
}
float ao=1.0-totalStrength*occlusion*samplesFactor;
float result=clamp(ao+base,0.0,1.0);
gl_FragColor.r=result;
gl_FragColor.g=result;
gl_FragColor.b=result;
gl_FragColor.a=1.0;
}
#endif
`;k.a.ShadersStore[Ce]=X;var ae={name:Ce,shader:X},ee=u(601),w=function(Ae){Object(T.d)(se,Ae);function se(te,he,de,Ne){var Le=Ae.call(this,he.getEngine(),te)||this;Le.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",Le.SSAORenderEffect="SSAORenderEffect",Le.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",Le.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",Le.SSAOCombineRenderEffect="SSAOCombineRenderEffect",Le.totalStrength=1,Le.radius=1e-4,Le.area=.0075,Le.fallOff=1e-6,Le.base=.5,Le._firstUpdate=!0,Le._scene=he,Le._createRandomTexture(),Le._depthTexture=he.enableDepthRenderer().getDepthMap();var pe=de.ssaoRatio||de,He=de.combineRatio||de;return Le._originalColorPostProcess=new Re.b("SSAOOriginalSceneColor",He,null,M.a.BILINEAR_SAMPLINGMODE,he.getEngine(),!1),Le._createSSAOPostProcess(pe),Le._createBlurPostProcess(pe),Le._createSSAOCombinePostProcess(He),Le.addEffect(new g.a(he.getEngine(),Le.SSAOOriginalSceneColorEffect,function(){return Le._originalColorPostProcess},!0)),Le.addEffect(new g.a(he.getEngine(),Le.SSAORenderEffect,function(){return Le._ssaoPostProcess},!0)),Le.addEffect(new g.a(he.getEngine(),Le.SSAOBlurHRenderEffect,function(){return Le._blurHPostProcess},!0)),Le.addEffect(new g.a(he.getEngine(),Le.SSAOBlurVRenderEffect,function(){return Le._blurVPostProcess},!0)),Le.addEffect(new g.a(he.getEngine(),Le.SSAOCombineRenderEffect,function(){return Le._ssaoCombinePostProcess},!0)),he.postProcessRenderPipelineManager.addPipeline(Le),Ne&&he.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(te,Ne),Le}return Object.defineProperty(se.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),se.prototype.getClassName=function(){return"SSAORenderingPipeline"},se.prototype.dispose=function(te){te===void 0&&(te=!1);for(var he=0;he<this._scene.cameras.length;he++){var de=this._scene.cameras[he];this._originalColorPostProcess.dispose(de),this._ssaoPostProcess.dispose(de),this._blurHPostProcess.dispose(de),this._blurVPostProcess.dispose(de),this._ssaoCombinePostProcess.dispose(de)}this._randomTexture.dispose(),te&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),Ae.prototype.dispose.call(this)},se.prototype._createBlurPostProcess=function(te){var he=this,de=16;this._blurHPostProcess=new Ie.a("BlurH",new re.d(1,0),de,te,null,M.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new Ie.a("BlurV",new re.d(0,1),de,te,null,M.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(function(){var Ne=he._blurHPostProcess.width/he._scene.getEngine().getRenderWidth();he._blurHPostProcess.kernel=de*Ne}),this._blurVPostProcess.onActivateObservable.add(function(){var Ne=he._blurVPostProcess.height/he._scene.getEngine().getRenderHeight();he._blurVPostProcess.kernel=de*Ne})},se.prototype._rebuild=function(){this._firstUpdate=!0,Ae.prototype._rebuild.call(this)},se.prototype._createSSAOPostProcess=function(te){var he=this,de=16,Ne=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],Le=1/de;this._ssaoPostProcess=new L.a("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],te,null,M.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES "+de+`
#define SSAO`),this._ssaoPostProcess.onApply=function(pe){he._firstUpdate&&(pe.setArray3("sampleSphere",Ne),pe.setFloat("samplesFactor",Le),pe.setFloat("randTextureTiles",4)),pe.setFloat("totalStrength",he.totalStrength),pe.setFloat("radius",he.radius),pe.setFloat("area",he.area),pe.setFloat("fallOff",he.fallOff),pe.setFloat("base",he.base),pe.setTexture("textureSampler",he._depthTexture),pe.setTexture("randomSampler",he._randomTexture)}},se.prototype._createSSAOCombinePostProcess=function(te){var he=this;this._ssaoCombinePostProcess=new L.a("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],te,null,M.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(de){de.setVector4("viewport",re.c.Vector4[0].copyFromFloats(0,0,1,1)),de.setTextureFromPostProcess("originalColor",he._originalColorPostProcess)}},se.prototype._createRandomTexture=function(){var te=512;this._randomTexture=new B.a("SSAORandomTexture",te,this._scene,!1,M.a.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=M.a.WRAP_ADDRESSMODE,this._randomTexture.wrapV=M.a.WRAP_ADDRESSMODE;for(var he=this._randomTexture.getContext(),de=function(He,rt){return Math.random()*(rt-He)+He},Ne=re.e.Zero(),Le=0;Le<te;Le++)for(var pe=0;pe<te;pe++)Ne.x=Math.floor(de(-1,1)*255),Ne.y=Math.floor(de(-1,1)*255),Ne.z=Math.floor(de(-1,1)*255),he.fillStyle="rgb("+Ne.x+", "+Ne.y+", "+Ne.z+")",he.fillRect(Le,pe,1,1);this._randomTexture.update(!1)},Object(T.c)([Object(S.c)()],se.prototype,"totalStrength",void 0),Object(T.c)([Object(S.c)()],se.prototype,"radius",void 0),Object(T.c)([Object(S.c)()],se.prototype,"area",void 0),Object(T.c)([Object(S.c)()],se.prototype,"fallOff",void 0),Object(T.c)([Object(S.c)()],se.prototype,"base",void 0),se}(d.a),N=u(450),W=u(571),$=u(581),J=u(535),le="standardPixelShader",ne=`uniform sampler2D textureSampler;
varying vec2 vUV;
#if defined(PASS_POST_PROCESS)
void main(void)
{
vec4 color=texture2D(textureSampler,vUV);
gl_FragColor=color;
}
#endif
#if defined(DOWN_SAMPLE_X4)
uniform vec2 dsOffsets[16];
void main(void)
{
vec4 average=vec4(0.0,0.0,0.0,0.0);
average=texture2D(textureSampler,vUV+dsOffsets[0]);
average+=texture2D(textureSampler,vUV+dsOffsets[1]);
average+=texture2D(textureSampler,vUV+dsOffsets[2]);
average+=texture2D(textureSampler,vUV+dsOffsets[3]);
average+=texture2D(textureSampler,vUV+dsOffsets[4]);
average+=texture2D(textureSampler,vUV+dsOffsets[5]);
average+=texture2D(textureSampler,vUV+dsOffsets[6]);
average+=texture2D(textureSampler,vUV+dsOffsets[7]);
average+=texture2D(textureSampler,vUV+dsOffsets[8]);
average+=texture2D(textureSampler,vUV+dsOffsets[9]);
average+=texture2D(textureSampler,vUV+dsOffsets[10]);
average+=texture2D(textureSampler,vUV+dsOffsets[11]);
average+=texture2D(textureSampler,vUV+dsOffsets[12]);
average+=texture2D(textureSampler,vUV+dsOffsets[13]);
average+=texture2D(textureSampler,vUV+dsOffsets[14]);
average+=texture2D(textureSampler,vUV+dsOffsets[15]);
average/=16.0;
gl_FragColor=average;
}
#endif
#if defined(BRIGHT_PASS)
uniform vec2 dsOffsets[4];
uniform float brightThreshold;
void main(void)
{
vec4 average=vec4(0.0,0.0,0.0,0.0);
average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));
average*=0.25;
float luminance=length(average.rgb);
if (luminance<brightThreshold) {
average=vec4(0.0,0.0,0.0,1.0);
}
gl_FragColor=average;
}
#endif
#if defined(TEXTURE_ADDER)
uniform sampler2D otherSampler;
uniform sampler2D lensSampler;
uniform float exposure;
void main(void)
{
vec3 colour=texture2D(textureSampler,vUV).rgb;
colour*=exposure;
vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);
vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);
colour=retColor*retColor;
colour+=colour*texture2D(lensSampler,vUV).rgb;
vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);
gl_FragColor=finalColor;
}
#endif
#if defined(VLS)
#define PI 3.1415926535897932384626433832795
uniform mat4 shadowViewProjection;
uniform mat4 lightWorld;
uniform vec3 cameraPosition;
uniform vec3 sunDirection;
uniform vec3 sunColor;
uniform vec2 depthValues;
uniform float scatteringCoefficient;
uniform float scatteringPower;
uniform sampler2D shadowMapSampler;
uniform sampler2D positionSampler;
float computeScattering(float lightDotView)
{
float result=1.0-scatteringCoefficient*scatteringCoefficient;
result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));
return result;
}
void main(void)
{

vec3 worldPos=texture2D(positionSampler,vUV).rgb;
vec3 startPosition=cameraPosition;
vec3 rayVector=worldPos-startPosition;
float rayLength=length(rayVector);
vec3 rayDirection=rayVector/rayLength;
float stepLength=rayLength/NB_STEPS;
vec3 stepL=rayDirection*stepLength;
vec3 currentPosition=startPosition;
vec3 accumFog=vec3(0.0);
for (int i=0; i<int(NB_STEPS); i++)
{
vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);
float depthMetric=(worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depthMetric,0.0,1.0);
worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;
worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);
float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;
if (shadowMapValue>shadowPixelDepth)
accumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));
currentPosition+=stepL;
}
accumFog/=NB_STEPS;
vec3 color=accumFog*scatteringPower;
gl_FragColor=vec4(color*exp(color) ,1.0);
}
#endif
#if defined(VLSMERGE)
uniform sampler2D originalSampler;
void main(void)
{
gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);
}
#endif
#if defined(LUMINANCE)
uniform vec2 lumOffsets[4];
void main()
{
float average=0.0;
vec4 color=vec4(0.0);
float maximum=-1e20;
vec3 weight=vec3(0.299,0.587,0.114);
for (int i=0; i<4; i++)
{
color=texture2D(textureSampler,vUV+ lumOffsets[i]);

float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));

#ifdef WEIGHTED_AVERAGE
float GreyValue=dot(color.rgb,weight);
#endif
#ifdef BRIGHTNESS
float GreyValue=max(color.r,max(color.g,color.b));
#endif
#ifdef HSL_COMPONENT
float GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));
#endif
#ifdef MAGNITUDE
float GreyValue=length(color.rgb);
#endif
maximum=max(maximum,GreyValue);
average+=(0.25*log(1e-5+GreyValue));
}
average=exp(average);
gl_FragColor=vec4(average,maximum,0.0,1.0);
}
#endif
#if defined(LUMINANCE_DOWN_SAMPLE)
uniform vec2 dsOffsets[9];
uniform float halfDestPixelSize;
#ifdef FINAL_DOWN_SAMPLER
#include<packingFunctions>
#endif
void main()
{
vec4 color=vec4(0.0);
float average=0.0;
for (int i=0; i<9; i++)
{
color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);
average+=color.r;
}
average/=9.0;
#ifdef FINAL_DOWN_SAMPLER
gl_FragColor=pack(average);
#else
gl_FragColor=vec4(average,average,0.0,1.0);
#endif
}
#endif
#if defined(HDR)
uniform sampler2D textureAdderSampler;
uniform float averageLuminance;
void main()
{
vec4 color=texture2D(textureAdderSampler,vUV);
#ifndef AUTO_EXPOSURE
vec4 adjustedColor=color/averageLuminance;
color=adjustedColor;
color.a=1.0;
#endif
gl_FragColor=color;
}
#endif
#if defined(LENS_FLARE)
#define GHOSTS 3
uniform sampler2D lensColorSampler;
uniform float strength;
uniform float ghostDispersal;
uniform float haloWidth;
uniform vec2 resolution;
uniform float distortionStrength;
float hash(vec2 p)
{
float h=dot(p,vec2(127.1,311.7));
return -1.0+2.0*fract(sin(h)*43758.5453123);
}
float noise(in vec2 p)
{
vec2 i=floor(p);
vec2 f=fract(p);
vec2 u=f*f*(3.0-2.0*f);
return mix(mix(hash(i+vec2(0.0,0.0)),
hash(i+vec2(1.0,0.0)),u.x),
mix(hash(i+vec2(0.0,1.0)),
hash(i+vec2(1.0,1.0)),u.x),u.y);
}
float fbm(vec2 p)
{
float f=0.0;
f+=0.5000*noise(p); p*=2.02;
f+=0.2500*noise(p); p*=2.03;
f+=0.1250*noise(p); p*=2.01;
f+=0.0625*noise(p); p*=2.04;
f/=0.9375;
return f;
}
vec3 pattern(vec2 uv)
{
vec2 p=-1.0+2.0*uv;
float p2=dot(p,p);
float f=fbm(vec2(15.0*p2))/2.0;
float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));
float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));
float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));
return (1.0-f)*vec3(r,g,b);
}
float luminance(vec3 color)
{
return dot(color.rgb,vec3(0.2126,0.7152,0.0722));
}
vec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)
{
return vec4(
texture2D(tex,texcoord+direction*distortion.r).r,
texture2D(tex,texcoord+direction*distortion.g).g,
texture2D(tex,texcoord+direction*distortion.b).b,
1.0
);
}
void main(void)
{
vec2 uv=-vUV+vec2(1.0);
vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;
vec2 texelSize=1.0/resolution;
vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);
vec4 result=vec4(0.0);
float ghostIndice=1.0;
for (int i=0; i<GHOSTS; ++i)
{
vec2 offset=fract(uv+ghostDir*ghostIndice);
float weight=length(vec2(0.5)-offset)/length(vec2(0.5));
weight=pow(1.0-weight,10.0);
result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;
ghostIndice+=1.0;
}
vec2 haloVec=normalize(ghostDir)*haloWidth;
float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));
weight=pow(1.0-weight,10.0);
result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;
result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));
gl_FragColor=result;
}
#endif
#if defined(LENS_FLARE_COMPOSE)
uniform sampler2D otherSampler;
uniform sampler2D lensDirtSampler;
uniform sampler2D lensStarSampler;
uniform mat4 lensStarMatrix;
void main(void)
{
vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;
vec4 lensMod=texture2D(lensDirtSampler,vUV);
lensMod+=texture2D(lensStarSampler,vUV);
vec4 result=texture2D(textureSampler,vUV)*lensMod;
gl_FragColor=texture2D(otherSampler,vUV)+result;
}
#endif
#if defined(DEPTH_OF_FIELD)
uniform sampler2D otherSampler;
uniform sampler2D depthSampler;
uniform float distance;
void main(void)
{
vec4 sharp=texture2D(otherSampler,vUV);
vec4 blur=texture2D(textureSampler,vUV);
float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);
float factor=0.0;
if (dist<0.05)
factor=1.0;
else if (dist<0.1)
factor=20.0*(0.1-dist);
else if (dist<0.5)
factor=0.0;
else
factor=2.0*(dist-0.5);
factor=clamp(factor,0.0,0.90);
gl_FragColor=mix(sharp,blur,factor);
}
#endif
#if defined(MOTION_BLUR)
uniform mat4 inverseViewProjection;
uniform mat4 prevViewProjection;
uniform vec2 screenSize;
uniform float motionScale;
uniform float motionStrength;
uniform sampler2D depthSampler;
void main(void)
{
vec2 texelSize=1.0/screenSize;
float depth=texture2D(depthSampler,vUV).r;
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);
cpos=cpos*inverseViewProjection;
vec4 ppos=cpos*prevViewProjection;
ppos.xyz/=ppos.w;
ppos.xy=ppos.xy*0.5+0.5;
vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;
float speed=length(velocity/texelSize);
int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {
if (i>=nSamples)
break;
vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
result+=texture2D(textureSampler,offset1);
}
gl_FragColor=result/float(nSamples);
}
#endif
`;k.a.ShadersStore[le]=ne;var be={name:le,shader:ne},Me=function(Ae){Object(T.d)(se,Ae);function se(te,he,de,Ne,Le){Ne===void 0&&(Ne=null);var pe=Ae.call(this,he.getEngine(),te)||this;return pe.downSampleX4PostProcess=null,pe.brightPassPostProcess=null,pe.blurHPostProcesses=[],pe.blurVPostProcesses=[],pe.textureAdderPostProcess=null,pe.volumetricLightPostProcess=null,pe.volumetricLightSmoothXPostProcess=null,pe.volumetricLightSmoothYPostProcess=null,pe.volumetricLightMergePostProces=null,pe.volumetricLightFinalPostProcess=null,pe.luminancePostProcess=null,pe.luminanceDownSamplePostProcesses=[],pe.hdrPostProcess=null,pe.textureAdderFinalPostProcess=null,pe.lensFlareFinalPostProcess=null,pe.hdrFinalPostProcess=null,pe.lensFlarePostProcess=null,pe.lensFlareComposePostProcess=null,pe.motionBlurPostProcess=null,pe.depthOfFieldPostProcess=null,pe.fxaaPostProcess=null,pe.screenSpaceReflectionPostProcess=null,pe.brightThreshold=1,pe.blurWidth=512,pe.horizontalBlur=!1,pe.lensTexture=null,pe.volumetricLightCoefficient=.2,pe.volumetricLightPower=4,pe.volumetricLightBlurScale=64,pe.sourceLight=null,pe.hdrMinimumLuminance=1,pe.hdrDecreaseRate=.5,pe.hdrIncreaseRate=.5,pe.lensColorTexture=null,pe.lensFlareStrength=20,pe.lensFlareGhostDispersal=1.4,pe.lensFlareHaloWidth=.7,pe.lensFlareDistortionStrength=16,pe.lensFlareBlurWidth=512,pe.lensStarTexture=null,pe.lensFlareDirtTexture=null,pe.depthOfFieldDistance=10,pe.depthOfFieldBlurWidth=64,pe.animations=[],pe._currentDepthOfFieldSource=null,pe._fixedExposure=1,pe._currentExposure=1,pe._hdrAutoExposure=!1,pe._hdrCurrentLuminance=1,pe._motionStrength=1,pe._isObjectBasedMotionBlur=!1,pe._camerasToBeAttached=[],pe._bloomEnabled=!1,pe._depthOfFieldEnabled=!1,pe._vlsEnabled=!1,pe._lensFlareEnabled=!1,pe._hdrEnabled=!1,pe._motionBlurEnabled=!1,pe._fxaaEnabled=!1,pe._screenSpaceReflectionsEnabled=!1,pe._motionBlurSamples=64,pe._volumetricLightStepsCount=50,pe._samples=1,pe._cameras=Le||he.cameras,pe._cameras=pe._cameras.slice(),pe._camerasToBeAttached=pe._cameras.slice(),pe._scene=he,pe._basePostProcess=Ne,pe._ratio=de,pe._floatTextureType=he.getEngine().getCaps().textureFloatRender?1:2,he.postProcessRenderPipelineManager.addPipeline(pe),pe._buildPipeline(),pe}return Object.defineProperty(se.prototype,"exposure",{get:function(){return this._fixedExposure},set:function(te){this._fixedExposure=te,this._currentExposure=te},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"hdrAutoExposure",{get:function(){return this._hdrAutoExposure},set:function(te){if(this._hdrAutoExposure=te,this.hdrPostProcess){var he=["#define HDR"];te&&he.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(he.join(`
`))}},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"motionStrength",{get:function(){return this._motionStrength},set:function(te){this._motionStrength=te,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=te)},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"objectBasedMotionBlur",{get:function(){return this._isObjectBasedMotionBlur},set:function(te){var he=this._isObjectBasedMotionBlur!==te;this._isObjectBasedMotionBlur=te,he&&this._buildPipeline()},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"BloomEnabled",{get:function(){return this._bloomEnabled},set:function(te){this._bloomEnabled!==te&&(this._bloomEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"DepthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(te){this._depthOfFieldEnabled!==te&&(this._depthOfFieldEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"LensFlareEnabled",{get:function(){return this._lensFlareEnabled},set:function(te){this._lensFlareEnabled!==te&&(this._lensFlareEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"HDREnabled",{get:function(){return this._hdrEnabled},set:function(te){this._hdrEnabled!==te&&(this._hdrEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"VLSEnabled",{get:function(){return this._vlsEnabled},set:function(te){if(this._vlsEnabled!==te){if(te){var he=this._scene.enableGeometryBufferRenderer();if(!he){O.a.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}}this._vlsEnabled=te,this._buildPipeline()}},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"MotionBlurEnabled",{get:function(){return this._motionBlurEnabled},set:function(te){this._motionBlurEnabled!==te&&(this._motionBlurEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(te){this._fxaaEnabled!==te&&(this._fxaaEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"screenSpaceReflectionsEnabled",{get:function(){return this._screenSpaceReflectionsEnabled},set:function(te){this._screenSpaceReflectionsEnabled!==te&&(this._screenSpaceReflectionsEnabled=te,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"volumetricLightStepsCount",{get:function(){return this._volumetricLightStepsCount},set:function(te){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect(`#define VLS
#define NB_STEPS `+te.toFixed(1)),this._volumetricLightStepsCount=te},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(te){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=te:this.motionBlurPostProcess.updateEffect(`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+te.toFixed(1))),this._motionBlurSamples=te},enumerable:!1,configurable:!0}),Object.defineProperty(se.prototype,"samples",{get:function(){return this._samples},set:function(te){this._samples!==te&&(this._samples=te,this._buildPipeline())},enumerable:!1,configurable:!0}),se.prototype._buildPipeline=function(){var te=this,he=this._ratio,de=this._scene;this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new $.a("HDRPass",de,he,null,M.a.BILINEAR_SAMPLINGMODE,de.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(function(){te._currentDepthOfFieldSource=te.screenSpaceReflectionPostProcess}),this.addEffect(new g.a(de.getEngine(),"HDRScreenSpaceReflections",function(){return te.screenSpaceReflectionPostProcess},!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new L.a("HDRPass","standard",[],[],he,null,M.a.BILINEAR_SAMPLINGMODE,de.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(function(){te._currentDepthOfFieldSource=te.originalPostProcess}),this.addEffect(new g.a(de.getEngine(),"HDRPassPostProcess",function(){return te.originalPostProcess},!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(de,he/4),this._createBrightPassPostProcess(de,he/4),this._createBlurPostProcesses(de,he/4,1),this._createTextureAdderPostProcess(de,he),this.textureAdderFinalPostProcess=new L.a("HDRDepthOfFieldSource","standard",[],[],he,null,M.a.BILINEAR_SAMPLINGMODE,de.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new g.a(de.getEngine(),"HDRBaseDepthOfFieldSource",function(){return te.textureAdderFinalPostProcess},!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(de,he),this.volumetricLightFinalPostProcess=new L.a("HDRVLSFinal","standard",[],[],he,null,M.a.BILINEAR_SAMPLINGMODE,de.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new g.a(de.getEngine(),"HDRVLSFinal",function(){return te.volumetricLightFinalPostProcess},!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(de,he),this.lensFlareFinalPostProcess=new L.a("HDRPostLensFlareDepthOfFieldSource","standard",[],[],he,null,M.a.BILINEAR_SAMPLINGMODE,de.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new g.a(de.getEngine(),"HDRPostLensFlareDepthOfFieldSource",function(){return te.lensFlareFinalPostProcess},!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(de,this._floatTextureType),this._createHdrPostProcess(de,he),this.hdrFinalPostProcess=new L.a("HDRPostHDReDepthOfFieldSource","standard",[],[],he,null,M.a.BILINEAR_SAMPLINGMODE,de.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new g.a(de.getEngine(),"HDRPostHDReDepthOfFieldSource",function(){return te.hdrFinalPostProcess},!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(de,he/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(de,he)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(de,he),this._fxaaEnabled&&(this.fxaaPostProcess=new m.a("fxaa",1,null,M.a.BILINEAR_SAMPLINGMODE,de.getEngine(),!1,0),this.addEffect(new g.a(de.getEngine(),"HDRFxaa",function(){return te.fxaaPostProcess},!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&O.a.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")},se.prototype._createDownSampleX4PostProcess=function(te,he){var de=this,Ne=new Array(32);this.downSampleX4PostProcess=new L.a("HDRDownSampleX4","standard",["dsOffsets"],[],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=function(Le){for(var pe=0,He=de.downSampleX4PostProcess.width,rt=de.downSampleX4PostProcess.height,ot=-2;ot<2;ot++)for(var et=-2;et<2;et++)Ne[pe]=(ot+.5)*(1/He),Ne[pe+1]=(et+.5)*(1/rt),pe+=2;Le.setArray2("dsOffsets",Ne)},this.addEffect(new g.a(te.getEngine(),"HDRDownSampleX4",function(){return de.downSampleX4PostProcess},!0))},se.prototype._createBrightPassPostProcess=function(te,he){var de=this,Ne=new Array(8);this.brightPassPostProcess=new L.a("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=function(Le){var pe=1/de.brightPassPostProcess.width,He=1/de.brightPassPostProcess.height;Ne[0]=-.5*pe,Ne[1]=.5*He,Ne[2]=.5*pe,Ne[3]=.5*He,Ne[4]=-.5*pe,Ne[5]=-.5*He,Ne[6]=.5*pe,Ne[7]=-.5*He,Le.setArray2("dsOffsets",Ne),Le.setFloat("brightThreshold",de.brightThreshold)},this.addEffect(new g.a(te.getEngine(),"HDRBrightPass",function(){return de.brightPassPostProcess},!0))},se.prototype._createBlurPostProcesses=function(te,he,de,Ne){var Le=this;Ne===void 0&&(Ne="blurWidth");var pe=te.getEngine(),He=new Ie.a("HDRBlurH_"+de,new re.d(1,0),this[Ne],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,this._floatTextureType),rt=new Ie.a("HDRBlurV_"+de,new re.d(0,1),this[Ne],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,this._floatTextureType);He.onActivateObservable.add(function(){var ot=He.width/pe.getRenderWidth();He.kernel=Le[Ne]*ot}),rt.onActivateObservable.add(function(){var ot=rt.height/pe.getRenderHeight();rt.kernel=Le.horizontalBlur?64*ot:Le[Ne]*ot}),this.addEffect(new g.a(te.getEngine(),"HDRBlurH"+de,function(){return He},!0)),this.addEffect(new g.a(te.getEngine(),"HDRBlurV"+de,function(){return rt},!0)),this.blurHPostProcesses.push(He),this.blurVPostProcesses.push(rt)},se.prototype._createTextureAdderPostProcess=function(te,he){var de=this;this.textureAdderPostProcess=new L.a("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=function(Ne){Ne.setTextureFromPostProcess("otherSampler",de._vlsEnabled?de._currentDepthOfFieldSource:de.originalPostProcess),Ne.setTexture("lensSampler",de.lensTexture),Ne.setFloat("exposure",de._currentExposure),de._currentDepthOfFieldSource=de.textureAdderFinalPostProcess},this.addEffect(new g.a(te.getEngine(),"HDRTextureAdder",function(){return de.textureAdderPostProcess},!0))},se.prototype._createVolumetricLightPostProcess=function(te,he){var de=this,Ne=te.enableGeometryBufferRenderer();Ne.enablePosition=!0;var Le=Ne.getGBuffer();this.volumetricLightPostProcess=new L.a("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],he/8,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,`#define VLS
#define NB_STEPS `+this._volumetricLightStepsCount.toFixed(1));var pe=re.d.Zero();this.volumetricLightPostProcess.onApply=function(He){if(de.sourceLight&&de.sourceLight.getShadowGenerator()&&de._scene.activeCamera){var rt=de.sourceLight.getShadowGenerator();He.setTexture("shadowMapSampler",rt.getShadowMap()),He.setTexture("positionSampler",Le.textures[2]),He.setColor3("sunColor",de.sourceLight.diffuse),He.setVector3("sunDirection",de.sourceLight.getShadowDirection()),He.setVector3("cameraPosition",de._scene.activeCamera.globalPosition),He.setMatrix("shadowViewProjection",rt.getTransformMatrix()),He.setFloat("scatteringCoefficient",de.volumetricLightCoefficient),He.setFloat("scatteringPower",de.volumetricLightPower),pe.x=de.sourceLight.getDepthMinZ(de._scene.activeCamera),pe.y=de.sourceLight.getDepthMaxZ(de._scene.activeCamera),He.setVector2("depthValues",pe)}},this.addEffect(new g.a(te.getEngine(),"HDRVLS",function(){return de.volumetricLightPostProcess},!0)),this._createBlurPostProcesses(te,he/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new L.a("HDRVLSMerge","standard",[],["originalSampler"],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=function(He){He.setTextureFromPostProcess("originalSampler",de._bloomEnabled?de.textureAdderFinalPostProcess:de.originalPostProcess),de._currentDepthOfFieldSource=de.volumetricLightFinalPostProcess},this.addEffect(new g.a(te.getEngine(),"HDRVLSMerge",function(){return de.volumetricLightMergePostProces},!0))},se.prototype._createLuminancePostProcesses=function(te,he){var de=this,Ne=Math.pow(3,se.LuminanceSteps);this.luminancePostProcess=new L.a("HDRLuminance","standard",["lumOffsets"],[],{width:Ne,height:Ne},null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,"#define LUMINANCE",he);var Le=[];this.luminancePostProcess.onApply=function(et){var ht=1/de.luminancePostProcess.width,Ee=1/de.luminancePostProcess.height;Le[0]=-.5*ht,Le[1]=.5*Ee,Le[2]=.5*ht,Le[3]=.5*Ee,Le[4]=-.5*ht,Le[5]=-.5*Ee,Le[6]=.5*ht,Le[7]=-.5*Ee,et.setArray2("lumOffsets",Le)},this.addEffect(new g.a(te.getEngine(),"HDRLuminance",function(){return de.luminancePostProcess},!0));for(var pe=se.LuminanceSteps-1;pe>=0;pe--){var Ne=Math.pow(3,pe),He=`#define LUMINANCE_DOWN_SAMPLE
`;pe===0&&(He+="#define FINAL_DOWN_SAMPLER");var rt=new L.a("HDRLuminanceDownSample"+pe,"standard",["dsOffsets","halfDestPixelSize"],[],{width:Ne,height:Ne},null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,He,he);this.luminanceDownSamplePostProcesses.push(rt)}var ot=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(function(et,ht){var Ee=new Array(18);et.onApply=function(At){if(!!ot){for(var Ht=0,Ot=-1;Ot<2;Ot++)for(var Ut=-1;Ut<2;Ut++)Ee[Ht]=Ot/ot.width,Ee[Ht+1]=Ut/ot.height,Ht+=2;At.setArray2("dsOffsets",Ee),At.setFloat("halfDestPixelSize",.5/ot.width),ht===de.luminanceDownSamplePostProcesses.length-1?ot=de.luminancePostProcess:ot=et}},ht===de.luminanceDownSamplePostProcesses.length-1&&(et.onAfterRender=function(){var At=te.getEngine().readPixels(0,0,1,1),Ht=new re.f(1/(255*255*255),1/(255*255),1/255,1);At.then(function(Ot){var Ut=new Uint8Array(Ot.buffer);de._hdrCurrentLuminance=(Ut[0]*Ht.x+Ut[1]*Ht.y+Ut[2]*Ht.z+Ut[3]*Ht.w)/100})}),de.addEffect(new g.a(te.getEngine(),"HDRLuminanceDownSample"+ht,function(){return et},!0))})},se.prototype._createHdrPostProcess=function(te,he){var de=this,Ne=["#define HDR"];this._hdrAutoExposure&&Ne.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new L.a("HDR","standard",["averageLuminance"],["textureAdderSampler"],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,Ne.join(`
`),0);var Le=1,pe=0,He=0;this.hdrPostProcess.onApply=function(rt){if(rt.setTextureFromPostProcess("textureAdderSampler",de._currentDepthOfFieldSource),pe+=te.getEngine().getDeltaTime(),Le<0)Le=de._hdrCurrentLuminance;else{var ot=(He-pe)/1e3;de._hdrCurrentLuminance<Le+de.hdrDecreaseRate*ot?Le+=de.hdrDecreaseRate*ot:de._hdrCurrentLuminance>Le-de.hdrIncreaseRate*ot?Le-=de.hdrIncreaseRate*ot:Le=de._hdrCurrentLuminance}de.hdrAutoExposure?de._currentExposure=de._fixedExposure/Le:(Le=N.a.Clamp(Le,de.hdrMinimumLuminance,1e20),rt.setFloat("averageLuminance",Le)),He=pe,de._currentDepthOfFieldSource=de.hdrFinalPostProcess},this.addEffect(new g.a(te.getEngine(),"HDR",function(){return de.hdrPostProcess},!0))},se.prototype._createLensFlarePostProcess=function(te,he){var de=this;this.lensFlarePostProcess=new L.a("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],he/2,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new g.a(te.getEngine(),"HDRLensFlare",function(){return de.lensFlarePostProcess},!0)),this._createBlurPostProcesses(te,he/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new L.a("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new g.a(te.getEngine(),"HDRLensFlareCompose",function(){return de.lensFlareComposePostProcess},!0));var Ne=new re.d(0,0);this.lensFlarePostProcess.onApply=function(He){He.setTextureFromPostProcess("textureSampler",de._bloomEnabled?de.blurHPostProcesses[0]:de.originalPostProcess),He.setTexture("lensColorSampler",de.lensColorTexture),He.setFloat("strength",de.lensFlareStrength),He.setFloat("ghostDispersal",de.lensFlareGhostDispersal),He.setFloat("haloWidth",de.lensFlareHaloWidth),Ne.x=de.lensFlarePostProcess.width,Ne.y=de.lensFlarePostProcess.height,He.setVector2("resolution",Ne),He.setFloat("distortionStrength",de.lensFlareDistortionStrength)};var Le=re.a.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),pe=re.a.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(He){if(!!de._scene.activeCamera){He.setTextureFromPostProcess("otherSampler",de.lensFlarePostProcess),He.setTexture("lensDirtSampler",de.lensFlareDirtTexture),He.setTexture("lensStarSampler",de.lensStarTexture);var rt=de._scene.activeCamera.getViewMatrix().getRow(0),ot=de._scene.activeCamera.getViewMatrix().getRow(2),et=re.e.Dot(rt.toVector3(),new re.e(1,0,0))+re.e.Dot(ot.toVector3(),new re.e(0,0,1));et*=4;var ht=re.a.FromValues(Math.cos(et)*.5,-Math.sin(et),0,0,Math.sin(et),Math.cos(et)*.5,0,0,0,0,1,0,0,0,0,1),Ee=pe.multiply(ht).multiply(Le);He.setMatrix("lensStarMatrix",Ee),de._currentDepthOfFieldSource=de.lensFlareFinalPostProcess}}},se.prototype._createDepthOfFieldPostProcess=function(te,he){var de=this;this.depthOfFieldPostProcess=new L.a("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=function(Ne){Ne.setTextureFromPostProcess("otherSampler",de._currentDepthOfFieldSource),Ne.setTexture("depthSampler",de._getDepthTexture()),Ne.setFloat("distance",de.depthOfFieldDistance)},this.addEffect(new g.a(te.getEngine(),"HDRDepthOfField",function(){return de.depthOfFieldPostProcess},!0))},se.prototype._createMotionBlurPostProcess=function(te,he){var de=this;if(this._isObjectBasedMotionBlur){var Ne=new W.a("HDRMotionBlur",te,he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,0);Ne.motionStrength=this.motionStrength,Ne.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=Ne}else{this.motionBlurPostProcess=new L.a("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],he,null,M.a.BILINEAR_SAMPLINGMODE,te.getEngine(),!1,`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+this.motionBlurSamples.toFixed(1),0);var Le=0,pe=re.a.Identity(),He=re.a.Identity(),rt=re.a.Identity(),ot=re.d.Zero();this.motionBlurPostProcess.onApply=function(et){rt=te.getProjectionMatrix().multiply(te.getViewMatrix()),rt.invertToRef(He),et.setMatrix("inverseViewProjection",He),et.setMatrix("prevViewProjection",pe),pe=rt,ot.x=de.motionBlurPostProcess.width,ot.y=de.motionBlurPostProcess.height,et.setVector2("screenSize",ot),Le=te.getEngine().getFps()/60,et.setFloat("motionScale",Le),et.setFloat("motionStrength",de.motionStrength),et.setTexture("depthSampler",de._getDepthTexture())}}this.addEffect(new g.a(te.getEngine(),"HDRMotionBlur",function(){return de.motionBlurPostProcess},!0))},se.prototype._getDepthTexture=function(){if(this._scene.getEngine().getCaps().drawBuffersExtension){var te=this._scene.enableGeometryBufferRenderer();return te.getGBuffer().textures[0]}return this._scene.enableDepthRenderer().getDepthMap()},se.prototype._disposePostProcesses=function(){for(var te=0;te<this._cameras.length;te++){var he=this._cameras[te];this.originalPostProcess&&this.originalPostProcess.dispose(he),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(he),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(he),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(he),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(he),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(he),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(he),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(he),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(he),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(he),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(he),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(he);for(var de=0;de<this.luminanceDownSamplePostProcesses.length;de++)this.luminanceDownSamplePostProcesses[de].dispose(he);this.luminancePostProcess&&this.luminancePostProcess.dispose(he),this.hdrPostProcess&&this.hdrPostProcess.dispose(he),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(he),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(he),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(he),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(he);for(var de=0;de<this.blurHPostProcesses.length;de++)this.blurHPostProcesses[de].dispose(he);for(var de=0;de<this.blurVPostProcesses.length;de++)this.blurVPostProcesses[de].dispose(he)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses=[],this.blurHPostProcesses=[],this.blurVPostProcesses=[]},se.prototype.dispose=function(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),Ae.prototype.dispose.call(this)},se.prototype.serialize=function(){var te=S.a.Serialize(this);return this.sourceLight&&(te.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(te.screenSpaceReflectionPostProcess=S.a.Serialize(this.screenSpaceReflectionPostProcess)),te.customType="StandardRenderingPipeline",te},se.Parse=function(te,he,de){var Ne=S.a.Parse(function(){return new se(te._name,he,te._ratio)},te,he,de);return te.sourceLightId&&(Ne.sourceLight=he.getLightByID(te.sourceLightId)),te.screenSpaceReflectionPostProcess&&S.a.Parse(function(){return Ne.screenSpaceReflectionPostProcess},te.screenSpaceReflectionPostProcess,he,de),Ne},se.LuminanceSteps=6,Object(T.c)([Object(S.c)()],se.prototype,"brightThreshold",void 0),Object(T.c)([Object(S.c)()],se.prototype,"blurWidth",void 0),Object(T.c)([Object(S.c)()],se.prototype,"horizontalBlur",void 0),Object(T.c)([Object(S.c)()],se.prototype,"exposure",null),Object(T.c)([Object(S.m)("lensTexture")],se.prototype,"lensTexture",void 0),Object(T.c)([Object(S.c)()],se.prototype,"volumetricLightCoefficient",void 0),Object(T.c)([Object(S.c)()],se.prototype,"volumetricLightPower",void 0),Object(T.c)([Object(S.c)()],se.prototype,"volumetricLightBlurScale",void 0),Object(T.c)([Object(S.c)()],se.prototype,"hdrMinimumLuminance",void 0),Object(T.c)([Object(S.c)()],se.prototype,"hdrDecreaseRate",void 0),Object(T.c)([Object(S.c)()],se.prototype,"hdrIncreaseRate",void 0),Object(T.c)([Object(S.c)()],se.prototype,"hdrAutoExposure",null),Object(T.c)([Object(S.m)("lensColorTexture")],se.prototype,"lensColorTexture",void 0),Object(T.c)([Object(S.c)()],se.prototype,"lensFlareStrength",void 0),Object(T.c)([Object(S.c)()],se.prototype,"lensFlareGhostDispersal",void 0),Object(T.c)([Object(S.c)()],se.prototype,"lensFlareHaloWidth",void 0),Object(T.c)([Object(S.c)()],se.prototype,"lensFlareDistortionStrength",void 0),Object(T.c)([Object(S.c)()],se.prototype,"lensFlareBlurWidth",void 0),Object(T.c)([Object(S.m)("lensStarTexture")],se.prototype,"lensStarTexture",void 0),Object(T.c)([Object(S.m)("lensFlareDirtTexture")],se.prototype,"lensFlareDirtTexture",void 0),Object(T.c)([Object(S.c)()],se.prototype,"depthOfFieldDistance",void 0),Object(T.c)([Object(S.c)()],se.prototype,"depthOfFieldBlurWidth",void 0),Object(T.c)([Object(S.c)()],se.prototype,"motionStrength",null),Object(T.c)([Object(S.c)()],se.prototype,"objectBasedMotionBlur",null),Object(T.c)([Object(S.c)()],se.prototype,"_ratio",void 0),Object(T.c)([Object(S.c)()],se.prototype,"BloomEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"DepthOfFieldEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"LensFlareEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"HDREnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"VLSEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"MotionBlurEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"fxaaEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"screenSpaceReflectionsEnabled",null),Object(T.c)([Object(S.c)()],se.prototype,"volumetricLightStepsCount",null),Object(T.c)([Object(S.c)()],se.prototype,"motionBlurSamples",null),Object(T.c)([Object(S.c)()],se.prototype,"samples",null),se}(d.a);y.a.RegisteredTypes["BABYLON.StandardRenderingPipeline"]=Me;var Te=u(548)},604:function(Ue,P,u){"use strict";u.d(P,"c",function(){return H}),u.d(P,"b",function(){return A}),u.d(P,"a",function(){return p});var T=u(434),S=u(468),j=u(446),O=u(440),M=u(448),H=function(f){Object(T.d)(h,f);function h(){return f!==null&&f.apply(this,arguments)||this}return h}(S.a),A=function(){function f(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}return f}(),p=function(f){Object(T.d)(h,f);function h(m){var d=f.call(this)||this;return d._wasAddedToScene=!1,d.scene=m,d.sounds=[],d.effectLayers=[],d.layers=[],d.lensFlareSystems=[],d.proceduralTextures=[],d.reflectionProbes=[],m.onDisposeObservable.add(function(){d._wasAddedToScene||d.dispose()}),d}return h.prototype.instantiateModelsToScene=function(m,d,g){var v=this;d===void 0&&(d=!1);var l={},y={},E=new A,R=[],F=[];g||(g={doNotInstantiate:!1});var B=function(L,I){if(l[L.uniqueId]=I.uniqueId,y[I.uniqueId]=I,m&&(I.name=m(L.name)),I instanceof j.a){var k=I;if(k.morphTargetManager){var Z=L.morphTargetManager;k.morphTargetManager=Z.clone();for(var Y=0;Y<Z.numTargets;Y++){var U=Z.getTarget(Y),Q=k.morphTargetManager.getTarget(Y);l[U.uniqueId]=Q.uniqueId,y[Q.uniqueId]=Q}}}};return this.transformNodes.forEach(function(L){if(!L.parent){var I=L.instantiateHierarchy(null,g,function(k,Z){B(k,Z)});I&&E.rootNodes.push(I)}}),this.meshes.forEach(function(L){if(!L.parent){var I=L.instantiateHierarchy(null,g,function(k,Z){if(B(k,Z),Z.material){var Y=Z;if(Y.material)if(d){var U=k.material;if(F.indexOf(U)===-1){var Q=U.clone(m?m(U.name):"Clone of "+U.name);if(F.push(U),l[U.uniqueId]=Q.uniqueId,y[Q.uniqueId]=Q,U.getClassName()==="MultiMaterial"){for(var G=U,K=0,fe=G.subMaterials;K<fe.length;K++){var ce=fe[K];!ce||(Q=ce.clone(m?m(ce.name):"Clone of "+ce.name),F.push(ce),l[ce.uniqueId]=Q.uniqueId,y[Q.uniqueId]=Q)}G.subMaterials=G.subMaterials.map(function(re){return re&&y[l[re.uniqueId]]})}}Y.getClassName()!=="InstancedMesh"&&(Y.material=y[l[U.uniqueId]])}else Y.material.getClassName()==="MultiMaterial"?v.scene.multiMaterials.indexOf(Y.material)===-1&&v.scene.addMultiMaterial(Y.material):v.scene.materials.indexOf(Y.material)===-1&&v.scene.addMaterial(Y.material)}});I&&E.rootNodes.push(I)}}),this.skeletons.forEach(function(L){var I=L.clone(m?m(L.name):"Clone of "+L.name);L.overrideMesh&&(I.overrideMesh=y[l[L.overrideMesh.uniqueId]]);for(var k=0,Z=v.meshes;k<Z.length;k++){var Y=Z[k];if(Y.skeleton===L&&!Y.isAnInstance){var U=y[l[Y.uniqueId]];if(U.skeleton=I,R.indexOf(I)!==-1)continue;R.push(I);for(var Q=0,G=I.bones;Q<G.length;Q++){var K=G[Q];K._linkedTransformNode&&(K._linkedTransformNode=y[l[K._linkedTransformNode.uniqueId]])}}}E.skeletons.push(I)}),this.animationGroups.forEach(function(L){var I=L.clone(L.name,function(k){var Z=y[l[k.uniqueId]];return Z||k});E.animationGroups.push(I)}),E},h.prototype.addAllToScene=function(){var m=this;this._wasAddedToScene=!0,this.cameras.forEach(function(l){m.scene.addCamera(l)}),this.lights.forEach(function(l){m.scene.addLight(l)}),this.meshes.forEach(function(l){m.scene.addMesh(l)}),this.skeletons.forEach(function(l){m.scene.addSkeleton(l)}),this.animations.forEach(function(l){m.scene.addAnimation(l)}),this.animationGroups.forEach(function(l){m.scene.addAnimationGroup(l)}),this.multiMaterials.forEach(function(l){m.scene.addMultiMaterial(l)}),this.materials.forEach(function(l){m.scene.addMaterial(l)}),this.morphTargetManagers.forEach(function(l){m.scene.addMorphTargetManager(l)}),this.geometries.forEach(function(l){m.scene.addGeometry(l)}),this.transformNodes.forEach(function(l){m.scene.addTransformNode(l)}),this.actionManagers.forEach(function(l){m.scene.addActionManager(l)}),this.textures.forEach(function(l){m.scene.addTexture(l)}),this.reflectionProbes.forEach(function(l){m.scene.addReflectionProbe(l)}),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(var d=0,g=this.scene._serializableComponents;d<g.length;d++){var v=g[d];v.addFromContainer(this)}},h.prototype.removeAllFromScene=function(){var m=this;this._wasAddedToScene=!1,this.cameras.forEach(function(l){m.scene.removeCamera(l)}),this.lights.forEach(function(l){m.scene.removeLight(l)}),this.meshes.forEach(function(l){m.scene.removeMesh(l)}),this.skeletons.forEach(function(l){m.scene.removeSkeleton(l)}),this.animations.forEach(function(l){m.scene.removeAnimation(l)}),this.animationGroups.forEach(function(l){m.scene.removeAnimationGroup(l)}),this.multiMaterials.forEach(function(l){m.scene.removeMultiMaterial(l)}),this.materials.forEach(function(l){m.scene.removeMaterial(l)}),this.morphTargetManagers.forEach(function(l){m.scene.removeMorphTargetManager(l)}),this.geometries.forEach(function(l){m.scene.removeGeometry(l)}),this.transformNodes.forEach(function(l){m.scene.removeTransformNode(l)}),this.actionManagers.forEach(function(l){m.scene.removeActionManager(l)}),this.textures.forEach(function(l){m.scene.removeTexture(l)}),this.reflectionProbes.forEach(function(l){m.scene.removeReflectionProbe(l)}),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(var d=0,g=this.scene._serializableComponents;d<g.length;d++){var v=g[d];v.removeFromContainer(this)}},h.prototype.dispose=function(){this.cameras.forEach(function(v){v.dispose()}),this.cameras=[],this.lights.forEach(function(v){v.dispose()}),this.lights=[],this.meshes.forEach(function(v){v.dispose()}),this.meshes=[],this.skeletons.forEach(function(v){v.dispose()}),this.skeletons=[],this.animationGroups.forEach(function(v){v.dispose()}),this.animationGroups=[],this.multiMaterials.forEach(function(v){v.dispose()}),this.multiMaterials=[],this.materials.forEach(function(v){v.dispose()}),this.materials=[],this.geometries.forEach(function(v){v.dispose()}),this.geometries=[],this.transformNodes.forEach(function(v){v.dispose()}),this.transformNodes=[],this.actionManagers.forEach(function(v){v.dispose()}),this.actionManagers=[],this.textures.forEach(function(v){v.dispose()}),this.textures=[],this.reflectionProbes.forEach(function(v){v.dispose()}),this.reflectionProbes=[],this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(var m=0,d=this.scene._serializableComponents;m<d.length;m++){var g=d[m];g.removeFromContainer(this,!0)}},h.prototype._moveAssets=function(m,d,g){if(!!m)for(var v=0,l=m;v<l.length;v++){var y=l[v],E=!0;if(g)for(var R=0,F=g;R<F.length;R++){var B=F[R];if(y===B){E=!1;break}}E&&d.push(y)}},h.prototype.moveAllFromScene=function(m){this._wasAddedToScene=!1,m===void 0&&(m=new H);for(var d in this)this.hasOwnProperty(d)&&(this[d]=this[d]||(d==="environmentTexture"?null:[]),this._moveAssets(this.scene[d],this[d],m[d]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()},h.prototype.createRootMesh=function(){var m=new j.a("assetContainerRootMesh",this.scene);return this.meshes.forEach(function(d){d.parent||m.addChild(d)}),this.meshes.unshift(m),m},h.prototype.mergeAnimationsTo=function(m,d,g){if(m===void 0&&(m=M.a.LastCreatedScene),g===void 0&&(g=null),!m)return O.a.Error("No scene available to merge animations to"),[];var v=g||function(E){var R=null,F=E.animations.length?E.animations[0].targetProperty:"",B=E.name.split(".").join("").split("_primitive")[0];switch(F){case"position":case"rotationQuaternion":R=m.getTransformNodeByName(E.name)||m.getTransformNodeByName(B);break;case"influence":R=m.getMorphTargetByName(E.name)||m.getMorphTargetByName(B);break;default:R=m.getNodeByName(E.name)||m.getNodeByName(B)}return R},l=this.getNodes();l.forEach(function(E){var R=v(E);if(R!==null){for(var F=function(k){for(var Z=R.animations.filter(function(K){return K.targetProperty===k.targetProperty}),Y=0,U=Z;Y<U.length;Y++){var Q=U[Y],G=R.animations.indexOf(Q,0);G>-1&&R.animations.splice(G,1)}},B=0,L=E.animations;B<L.length;B++){var I=L[B];F(I)}R.animations=R.animations.concat(E.animations)}});var y=new Array;return this.animationGroups.slice().forEach(function(E){y.push(E.clone(E.name,v)),E.animatables.forEach(function(R){R.stop()})}),d.forEach(function(E){var R=v(E.target);R&&(m.beginAnimation(R,E.fromFrame,E.toFrame,E.loopAnimation,E.speedRatio,E.onAnimationEnd?E.onAnimationEnd:void 0,void 0,!0,void 0,E.onAnimationLoop?E.onAnimationLoop:void 0),m.stopAnimation(E.target))}),y},h}(S.a)},605:function(Ue,P,u){"use strict";var T=u(435),S="importanceSampling",j=`




























vec3 hemisphereCosSample(vec2 u) {

float phi=2.*PI*u.x;
float cosTheta2=1.-u.y;
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}





































vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {

float phi=2.*PI*u.x;

float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}

























































vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) {

float phi=2.*PI*u.x;
float sinTheta=pow(u.y,a/(2.*a+1.));
float cosTheta=sqrt(1.-sinTheta*sinTheta);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}`;T.a.IncludesShadersStore[S]=j;var O={name:S,shader:j}},606:function(Ue,P,u){"use strict";var T=u(435),S="pbrBRDFFunctions",j=`
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25




#ifdef MS_BRDF_ENERGY_CONSERVATION


vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);
}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {

vec2 UV=vec2(NdotV,perceptualRoughness);

vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;

#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;
}
#endif

#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{

float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)

vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {
vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;
return sheenEnvironmentReflectance;
}
#endif
























vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
#ifdef CLEARCOAT





vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);
vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);
return t*t;
#endif
}
#endif






float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{



float a2=square(alphaG);
float d=NdotH*NdotH*(a2-1.0)+1.0;
return a2/(PI*d*d);
}
#ifdef SHEEN


float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{
float invR=1./alphaG;
float cos2h=NdotH*NdotH;
float sin2h=1.-cos2h;
return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);
}
#endif
#ifdef ANISOTROPIC


float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {
float a2=alphaTB.x*alphaTB.y;
vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x*BdotH,a2*NdotH);
float v2=dot(v,v);
float w2=a2/v2;
return a2*w2*w2*RECIPROCAL_PI;
}
#endif




#ifdef BRDF_V_HEIGHT_CORRELATED



float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE

float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);
float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);
return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;
float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);
float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);
return 0.5/(GGXV+GGXL);
#endif
}
#else















float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE

return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;
return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{
float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);

return visibility;
}
#endif
#ifdef ANISOTROPIC


float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {
float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));
float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));
float v=0.5/(lambdaV+lambdaL);
return v;
}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {



return 0.25/(VdotH*VdotH);
}
#endif
#ifdef SHEEN



float visibility_Ashikhmin(float NdotL,float NdotV)
{
return 1./(4.*(NdotL+NdotV-NdotL*NdotV));
}

#endif







float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {


float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));
float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));
float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;
float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);
return fresnel/PI;
}
#ifdef SS_TRANSLUCENCY


vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {
vec3 S=1./maxEps(diffusionDistance);
vec3 temp=exp((-0.333333333*thickness)*S);
return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);
}


float computeWrappedDiffuseNdotL(float NdotL,float w) {
float t=1.0+w;
float invt2=1.0/square(t);
return saturate((NdotL+w)*invt2);
}
#endif
`;T.a.IncludesShadersStore[S]=j;var O={name:S,shader:j}},607:function(Ue,P,u){"use strict";var T=u(435),S="hdrFilteringFunctions",j=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU)


float radicalInverse_VdC(uint bits)
{
bits=(bits << 16u) | (bits >> 16u);
bits=((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);
bits=((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);
bits=((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);
bits=((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);
return float(bits)*2.3283064365386963e-10;
}
vec2 hammersley(uint i,uint N)
{
return vec2(float(i)/float(N),radicalInverse_VdC(i));
}
#else
float vanDerCorpus(int n,int base)
{
float invBase=1.0/float(base);
float denom=1.0;
float result=0.0;
for(int i=0; i<32; ++i)
{
if(n>0)
{
denom=mod(float(n),2.0);
result+=denom*invBase;
invBase=invBase/2.0;
n=int(float(n)/2.0);
}
}
return result;
}
vec2 hammersley(int i,int N)
{
return vec2(float(i)/float(N),vanDerCorpus(i,2));
}
#endif
float log4(float x) {
return log2(x)/2.;
}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);
const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;
const float K=4.;



















































































































#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
vec3 result=vec3(0.0);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 Ls=hemisphereCosSample(Xi);
Ls=normalize(Ls);
vec3 Ns=vec3(0.,0.,1.);
float NoL=dot(Ns,Ls);
if (NoL>0.) {
float pdf_inversed=PI/NoL;
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(l,0.0,maxLevel);
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;
}
}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
return result;
}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
if (alphaG == 0.) {
vec3 c=textureCube(inputTexture,n).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;
} else {
vec3 result=vec3(0.);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);
float NoV=1.;
float NoH=H.z;
float NoH2=H.z*H.z;
float NoL=2.*NoH2-1.;
vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);
L=normalize(L);
if (NoL>0.) {
float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(float(l),0.0,maxLevel);
weight+=NoL;
vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;
}
}
result=result/weight;
return result;
}
}
#endif
#endif`;T.a.IncludesShadersStore[S]=j;var O={name:S,shader:j}},608:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(438),j=u(448),O=u(447),M=u(439),H=u(437),A=function(){function p(f,h,m){h===void 0&&(h=0),m===void 0&&(m=null),this.name=f,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new S.c,this._onDataLayoutChanged=new S.c,this._animationPropertiesOverride=null,this._scene=m||j.a.LastCreatedScene,this.influence=h,this._scene&&(this._uniqueId=this._scene.getUniqueId())}return Object.defineProperty(p.prototype,"influence",{get:function(){return this._influence},set:function(f){if(this._influence!==f){var h=this._influence;this._influence=f,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(h===0||f===0)}},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"animationPropertiesOverride",{get:function(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride},set:function(f){this._animationPropertiesOverride=f},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"hasPositions",{get:function(){return!!this._positions},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"hasNormals",{get:function(){return!!this._normals},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"hasTangents",{get:function(){return!!this._tangents},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"hasUVs",{get:function(){return!!this._uvs},enumerable:!1,configurable:!0}),p.prototype.setPositions=function(f){var h=this.hasPositions;this._positions=f,h!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)},p.prototype.getPositions=function(){return this._positions},p.prototype.setNormals=function(f){var h=this.hasNormals;this._normals=f,h!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)},p.prototype.getNormals=function(){return this._normals},p.prototype.setTangents=function(f){var h=this.hasTangents;this._tangents=f,h!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)},p.prototype.getTangents=function(){return this._tangents},p.prototype.setUVs=function(f){var h=this.hasUVs;this._uvs=f,h!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)},p.prototype.getUVs=function(){return this._uvs},p.prototype.clone=function(){var f=this,h=M.a.Clone(function(){return new p(f.name,f.influence,f._scene)},this);return h._positions=this._positions,h._normals=this._normals,h._tangents=this._tangents,h._uvs=this._uvs,h},p.prototype.serialize=function(){var f={};return f.name=this.name,f.influence=this.influence,f.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(f.id=this.id),this.hasNormals&&(f.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(f.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(f.uvs=Array.prototype.slice.call(this.getUVs())),M.a.AppendSerializedAnimations(this,f),f},p.prototype.getClassName=function(){return"MorphTarget"},p.Parse=function(f){var h=new p(f.name,f.influence);if(h.setPositions(f.positions),f.id!=null&&(h.id=f.id),f.normals&&h.setNormals(f.normals),f.tangents&&h.setTangents(f.tangents),f.uvs&&h.setUVs(f.uvs),f.animations)for(var m=0;m<f.animations.length;m++){var d=f.animations[m],g=H.a.GetClass("BABYLON.Animation");g&&h.animations.push(g.Parse(d))}return h},p.FromMesh=function(f,h,m){h||(h=f.name);var d=new p(h,m,f.getScene());return d.setPositions(f.getVerticesData(O.b.PositionKind)),f.isVerticesDataPresent(O.b.NormalKind)&&d.setNormals(f.getVerticesData(O.b.NormalKind)),f.isVerticesDataPresent(O.b.TangentKind)&&d.setTangents(f.getVerticesData(O.b.TangentKind)),f.isVerticesDataPresent(O.b.UVKind)&&d.setUVs(f.getVerticesData(O.b.UVKind)),d},Object(T.c)([Object(M.c)()],p.prototype,"id",void 0),p}()},609:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});var T=u(436),S=function(){function j(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=T.e.Zero(),this._hitPointWorld=T.e.Zero(),this._rayFromWorld=T.e.Zero(),this._rayToWorld=T.e.Zero()}return Object.defineProperty(j.prototype,"hasHit",{get:function(){return this._hasHit},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"hitDistance",{get:function(){return this._hitDistance},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"hitNormalWorld",{get:function(){return this._hitNormalWorld},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"hitPointWorld",{get:function(){return this._hitPointWorld},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"rayFromWorld",{get:function(){return this._rayFromWorld},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"rayToWorld",{get:function(){return this._rayToWorld},enumerable:!1,configurable:!0}),j.prototype.setHitData=function(O,M){this._hasHit=!0,this._hitNormalWorld=new T.e(O.x,O.y,O.z),this._hitPointWorld=new T.e(M.x,M.y,M.z)},j.prototype.setHitDistance=function(O){this._hitDistance=O},j.prototype.calculateHitDistance=function(){this._hitDistance=T.e.Distance(this._rayFromWorld,this._hitPointWorld)},j.prototype.reset=function(O,M){O===void 0&&(O=T.e.Zero()),M===void 0&&(M=T.e.Zero()),this._rayFromWorld=O,this._rayToWorld=M,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=T.e.Zero(),this._hitPointWorld=T.e.Zero()},j}()},610:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S}),u.d(P,"b",function(){return j});var T=u(475),S=function(){function O(M,H,A,p,f){this.idx=0,this.color=new T.f(1,1,1,1),this.position=T.z.Zero(),this.rotation=T.z.Zero(),this.uv=new T.y(0,0),this.velocity=T.z.Zero(),this.pivot=T.z.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=T.z.Zero(),this.idx=M,this._group=H,this.groupId=A,this.idxInGroup=p,this._pcs=f}return Object.defineProperty(O.prototype,"size",{get:function(){return this.size},set:function(M){this.size=M},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(M){this.rotationQuaternion=M},enumerable:!1,configurable:!0}),O.prototype.intersectsMesh=function(M,H){if(!M._boundingInfo)return!1;if(H=H||!1,H)return M.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));var A=0,p=0,f=0,h=0,m=0,d=0;A=M.getBoundingInfo().boundingBox.maximumWorld.x,p=M.getBoundingInfo().boundingBox.minimumWorld.x,f=M.getBoundingInfo().boundingBox.maximumWorld.y,h=M.getBoundingInfo().boundingBox.minimumWorld.y,m=M.getBoundingInfo().boundingBox.maximumWorld.z,d=M.getBoundingInfo().boundingBox.minimumWorld.z;var g=this.position.x+this._pcs.mesh.position.x,v=this.position.y+this._pcs.mesh.position.y,l=this.position.z+this._pcs.mesh.position.z;return p<=g&&g<=A&&h<=v&&v<=f&&d<=l&&l<=m},O.prototype.getRotationMatrix=function(M){var H;if(this.rotationQuaternion)H=this.rotationQuaternion;else{H=T.v.Quaternion[0];var A=this.rotation;T.r.RotationYawPitchRollToRef(A.y,A.x,A.z,H)}H.toRotationMatrix(M)},O}(),j=function(){function O(M,H){this.groupID=M,this._positionFunction=H}return O}()},618:function(Ue,P,u){"use strict";u.d(P,"a",function(){return d});var T=u(434),S=u(436),j=u(441),O=u(619),M=u(511),H=u(620),A=u(448),p=u(440),f=u(474),h=u(437),m=u(669),d=function(g){Object(T.d)(v,g);function v(l){var y=g.call(this)||this;return y._scene=l||A.a.LastCreatedScene,l.actionManagers.push(y),y}return v.prototype.dispose=function(){for(var l=this._scene.actionManagers.indexOf(this),y=0;y<this.actions.length;y++){var E=this.actions[y];v.Triggers[E.trigger]--,v.Triggers[E.trigger]===0&&delete v.Triggers[E.trigger]}l>-1&&this._scene.actionManagers.splice(l,1)},v.prototype.getScene=function(){return this._scene},v.prototype.hasSpecificTriggers=function(l){for(var y=0;y<this.actions.length;y++){var E=this.actions[y];if(l.indexOf(E.trigger)>-1)return!0}return!1},v.prototype.hasSpecificTriggers2=function(l,y){for(var E=0;E<this.actions.length;E++){var R=this.actions[E];if(l==R.trigger||y==R.trigger)return!0}return!1},v.prototype.hasSpecificTrigger=function(l,y){for(var E=0;E<this.actions.length;E++){var R=this.actions[E];if(R.trigger===l)if(y){if(y(R.getTriggerParameter()))return!0}else return!0}return!1},Object.defineProperty(v.prototype,"hasPointerTriggers",{get:function(){for(var l=0;l<this.actions.length;l++){var y=this.actions[l];if(y.trigger>=v.OnPickTrigger&&y.trigger<=v.OnPointerOutTrigger)return!0}return!1},enumerable:!1,configurable:!0}),Object.defineProperty(v.prototype,"hasPickTriggers",{get:function(){for(var l=0;l<this.actions.length;l++){var y=this.actions[l];if(y.trigger>=v.OnPickTrigger&&y.trigger<=v.OnPickUpTrigger)return!0}return!1},enumerable:!1,configurable:!0}),v.prototype.registerAction=function(l){return l.trigger===v.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(p.a.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(l),v.Triggers[l.trigger]?v.Triggers[l.trigger]++:v.Triggers[l.trigger]=1,l._actionManager=this,l._prepare(),l)},v.prototype.unregisterAction=function(l){var y=this.actions.indexOf(l);return y!==-1?(this.actions.splice(y,1),v.Triggers[l.trigger]-=1,v.Triggers[l.trigger]===0&&delete v.Triggers[l.trigger],l._actionManager=null,!0):!1},v.prototype.processTrigger=function(l,y){for(var E=0;E<this.actions.length;E++){var R=this.actions[E];if(R.trigger===l){if(y&&(l===v.OnKeyUpTrigger||l===v.OnKeyDownTrigger)){var F=R.getTriggerParameter();if(F&&F!==y.sourceEvent.keyCode){if(!F.toLowerCase)continue;var B=F.toLowerCase();if(B!==y.sourceEvent.key){var L=y.sourceEvent.charCode?y.sourceEvent.charCode:y.sourceEvent.keyCode,I=String.fromCharCode(L).toLowerCase();if(I!==B)continue}}}R._executeCurrent(y)}}},v.prototype._getEffectiveTarget=function(l,y){for(var E=y.split("."),R=0;R<E.length-1;R++)l=l[E[R]];return l},v.prototype._getProperty=function(l){var y=l.split(".");return y[y.length-1]},v.prototype.serialize=function(l){for(var y={children:new Array,name:l,type:3,properties:new Array},E=0;E<this.actions.length;E++){var R={type:0,children:new Array,name:v.GetTriggerName(this.actions[E].trigger),properties:new Array},F=this.actions[E].triggerOptions;if(F&&typeof F!="number")if(F.parameter instanceof Node)R.properties.push(M.a._GetTargetProperty(F.parameter));else{var B={};f.a.DeepCopy(F.parameter,B,["mesh"]),F.parameter&&F.parameter.mesh&&(B._meshId=F.parameter.mesh.id),R.properties.push({name:"parameter",targetType:null,value:B})}this.actions[E].serialize(R),y.children.push(R)}return y},v.Parse=function(l,y,E){var R=new v(E);y===null?E.actionManager=R:y.actionManager=R;for(var F=function(G,K){var fe=h.a.GetClass("BABYLON."+G);if(fe){var ce=Object.create(fe.prototype);return ce.constructor.apply(ce,K),ce}},B=function(G,K,fe,ce){if(ce===null){var re=parseFloat(K);return K==="true"||K==="false"?K==="true":isNaN(re)?K:re}for(var Re=ce.split("."),Ie=K.split(","),Ce=0;Ce<Re.length;Ce++)fe=fe[Re[Ce]];if(typeof fe=="boolean")return Ie[0]==="true";if(typeof fe=="string")return Ie[0];for(var X=new Array,Ce=0;Ce<Ie.length;Ce++)X.push(parseFloat(Ie[Ce]));return fe instanceof S.e?S.e.FromArray(X):fe instanceof S.f?S.f.FromArray(X):fe instanceof j.a?j.a.FromArray(X):fe instanceof j.b?j.b.FromArray(X):parseFloat(Ie[0])},L=function(G,K,fe,ce,re){if(re===void 0&&(re=null),!G.detached){var Re=new Array,Ie=null,Ce=null,X=G.combine&&G.combine.length>0;if(G.type===2?Re.push(R):Re.push(K),X){for(var ae=new Array,ee=0;ee<G.combine.length;ee++)L(G.combine[ee],v.NothingTrigger,fe,ce,ae);Re.push(ae)}else for(var w=0;w<G.properties.length;w++){var N=G.properties[w].value,W=G.properties[w].name,$=G.properties[w].targetType;W==="target"?$!==null&&$==="SceneProperties"?N=Ie=E:N=Ie=E.getNodeByName(N):W==="parent"?N=E.getNodeByName(N):W==="sound"?E.getSoundByName&&(N=E.getSoundByName(N)):W!=="propertyPath"?G.type===2&&W==="operator"?N=O.d[N]:N=B(W,N,Ie,W==="value"?Ce:null):Ce=N,Re.push(N)}if(re===null?Re.push(fe):Re.push(null),G.name==="InterpolateValueAction"){var J=Re[Re.length-2];Re[Re.length-1]=J,Re[Re.length-2]=fe}var le=F(G.name,Re);if(le instanceof O.a&&fe!==null){var ne=new H.b(K,fe);ce?ce.then(ne):R.registerAction(ne),ce=ne}re===null?le instanceof O.a?(fe=le,le=ce):(fe=null,ce?ce.then(le):R.registerAction(le)):re.push(le);for(var w=0;w<G.children.length;w++)L(G.children[w],K,fe,le,null)}},I=0;I<l.children.length;I++){var k,Z=l.children[I];if(Z.properties.length>0){var Y=Z.properties[0].value,U=Z.properties[0].targetType===null?Y:E.getMeshByName(Y);U._meshId&&(U.mesh=E.getMeshByID(U._meshId)),k={trigger:v[Z.name],parameter:U}}else k=v[Z.name];for(var Q=0;Q<Z.children.length;Q++)Z.detached||L(Z.children[Q],k,null,null)}},v.GetTriggerName=function(l){switch(l){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnPickUpTrigger";case 7:return"OnLongPressTrigger";case 8:return"OnPointerOverTrigger";case 9:return"OnPointerOutTrigger";case 10:return"OnEveryFrameTrigger";case 11:return"OnIntersectionEnterTrigger";case 12:return"OnIntersectionExitTrigger";case 13:return"OnKeyDownTrigger";case 14:return"OnKeyUpTrigger";case 15:return"OnPickOutTrigger";default:return""}},v.NothingTrigger=0,v.OnPickTrigger=1,v.OnLeftPickTrigger=2,v.OnRightPickTrigger=3,v.OnCenterPickTrigger=4,v.OnPickDownTrigger=5,v.OnDoublePickTrigger=6,v.OnPickUpTrigger=7,v.OnPickOutTrigger=16,v.OnLongPressTrigger=8,v.OnPointerOverTrigger=9,v.OnPointerOutTrigger=10,v.OnEveryFrameTrigger=11,v.OnIntersectionEnterTrigger=12,v.OnIntersectionExitTrigger=13,v.OnKeyDownTrigger=14,v.OnKeyUpTrigger=15,v}(m.a)},619:function(Ue,P,u){"use strict";u.d(P,"a",function(){return O}),u.d(P,"d",function(){return M}),u.d(P,"b",function(){return H}),u.d(P,"c",function(){return A});var T=u(434),S=u(511),j=u(437),O=function(){function p(f){this._actionManager=f}return p.prototype.isValid=function(){return!0},p.prototype._getProperty=function(f){return this._actionManager._getProperty(f)},p.prototype._getEffectiveTarget=function(f,h){return this._actionManager._getEffectiveTarget(f,h)},p.prototype.serialize=function(){},p.prototype._serialize=function(f){return{type:2,children:[],name:f.name,properties:f.properties}},p}(),M=function(p){Object(T.d)(f,p);function f(h,m,d,g,v){v===void 0&&(v=f.IsEqual);var l=p.call(this,h)||this;return l.propertyPath=d,l.value=g,l.operator=v,l._target=m,l._effectiveTarget=l._getEffectiveTarget(m,l.propertyPath),l._property=l._getProperty(l.propertyPath),l}return Object.defineProperty(f,"IsEqual",{get:function(){return f._IsEqual},enumerable:!1,configurable:!0}),Object.defineProperty(f,"IsDifferent",{get:function(){return f._IsDifferent},enumerable:!1,configurable:!0}),Object.defineProperty(f,"IsGreater",{get:function(){return f._IsGreater},enumerable:!1,configurable:!0}),Object.defineProperty(f,"IsLesser",{get:function(){return f._IsLesser},enumerable:!1,configurable:!0}),f.prototype.isValid=function(){switch(this.operator){case f.IsGreater:return this._effectiveTarget[this._property]>this.value;case f.IsLesser:return this._effectiveTarget[this._property]<this.value;case f.IsEqual:case f.IsDifferent:var h;return this.value.equals?h=this.value.equals(this._effectiveTarget[this._property]):h=this.value===this._effectiveTarget[this._property],this.operator===f.IsEqual?h:!h}return!1},f.prototype.serialize=function(){return this._serialize({name:"ValueCondition",properties:[S.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:S.a._SerializeValueAsString(this.value)},{name:"operator",value:f.GetOperatorName(this.operator)}]})},f.GetOperatorName=function(h){switch(h){case f._IsEqual:return"IsEqual";case f._IsDifferent:return"IsDifferent";case f._IsGreater:return"IsGreater";case f._IsLesser:return"IsLesser";default:return""}},f._IsEqual=0,f._IsDifferent=1,f._IsGreater=2,f._IsLesser=3,f}(O),H=function(p){Object(T.d)(f,p);function f(h,m){var d=p.call(this,h)||this;return d.predicate=m,d}return f.prototype.isValid=function(){return this.predicate()},f}(O),A=function(p){Object(T.d)(f,p);function f(h,m,d){var g=p.call(this,h)||this;return g.value=d,g._target=m,g}return f.prototype.isValid=function(){return this._target.state===this.value},f.prototype.serialize=function(){return this._serialize({name:"StateCondition",properties:[S.a._GetTargetProperty(this._target),{name:"value",value:this.value}]})},f}(O);j.a.RegisteredTypes["BABYLON.ValueCondition"]=M,j.a.RegisteredTypes["BABYLON.PredicateCondition"]=H,j.a.RegisteredTypes["BABYLON.StateCondition"]=A},620:function(Ue,P,u){"use strict";u.d(P,"j",function(){return H}),u.d(P,"g",function(){return A}),u.d(P,"h",function(){return p}),u.d(P,"d",function(){return f}),u.d(P,"e",function(){return h}),u.d(P,"i",function(){return m}),u.d(P,"b",function(){return d}),u.d(P,"a",function(){return g}),u.d(P,"c",function(){return v}),u.d(P,"f",function(){return l});var T=u(434),S=u(440),j=u(436),O=u(511),M=u(437),H=function(y){Object(T.d)(E,y);function E(R,F,B,L){var I=y.call(this,R,L)||this;return I.propertyPath=B,I._target=I._effectiveTarget=F,I}return E.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},E.prototype.execute=function(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]},E.prototype.serialize=function(R){return y.prototype._serialize.call(this,{name:"SwitchBooleanAction",properties:[O.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},R)},E}(O.a),A=function(y){Object(T.d)(E,y);function E(R,F,B,L){var I=y.call(this,R,L)||this;return I.value=B,I._target=F,I}return E.prototype.execute=function(){this._target.state=this.value},E.prototype.serialize=function(R){return y.prototype._serialize.call(this,{name:"SetStateAction",properties:[O.a._GetTargetProperty(this._target),{name:"value",value:this.value}]},R)},E}(O.a),p=function(y){Object(T.d)(E,y);function E(R,F,B,L,I){var k=y.call(this,R,I)||this;return k.propertyPath=B,k.value=L,k._target=k._effectiveTarget=F,k}return E.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},E.prototype.execute=function(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)},E.prototype.serialize=function(R){return y.prototype._serialize.call(this,{name:"SetValueAction",properties:[O.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:O.a._SerializeValueAsString(this.value)}]},R)},E}(O.a),f=function(y){Object(T.d)(E,y);function E(R,F,B,L,I){var k=y.call(this,R,I)||this;return k.propertyPath=B,k.value=L,k._target=k._effectiveTarget=F,k}return E.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&S.a.Warn("Warning: IncrementValueAction can only be used with number values")},E.prototype.execute=function(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)},E.prototype.serialize=function(R){return y.prototype._serialize.call(this,{name:"IncrementValueAction",properties:[O.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:O.a._SerializeValueAsString(this.value)}]},R)},E}(O.a),h=function(y){Object(T.d)(E,y);function E(R,F,B,L,I,k){var Z=y.call(this,R,k)||this;return Z.from=B,Z.to=L,Z.loop=I,Z._target=F,Z}return E.prototype._prepare=function(){},E.prototype.execute=function(){var R=this._actionManager.getScene();R.beginAnimation(this._target,this.from,this.to,this.loop)},E.prototype.serialize=function(R){return y.prototype._serialize.call(this,{name:"PlayAnimationAction",properties:[O.a._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:O.a._SerializeValueAsString(this.loop)||!1}]},R)},E}(O.a),m=function(y){Object(T.d)(E,y);function E(R,F,B){var L=y.call(this,R,B)||this;return L._target=F,L}return E.prototype._prepare=function(){},E.prototype.execute=function(){var R=this._actionManager.getScene();R.stopAnimation(this._target)},E.prototype.serialize=function(R){return y.prototype._serialize.call(this,{name:"StopAnimationAction",properties:[O.a._GetTargetProperty(this._target)]},R)},E}(O.a),d=function(y){Object(T.d)(E,y);function E(R,F){return R===void 0&&(R=0),y.call(this,R,F)||this}return E.prototype.execute=function(){},E.prototype.serialize=function(R){return y.prototype._serialize.call(this,{name:"DoNothingAction",properties:[]},R)},E}(O.a),g=function(y){Object(T.d)(E,y);function E(R,F,B){var L=y.call(this,R,B)||this;return L.children=F,L}return E.prototype._prepare=function(){for(var R=0;R<this.children.length;R++)this.children[R]._actionManager=this._actionManager,this.children[R]._prepare()},E.prototype.execute=function(R){for(var F=0;F<this.children.length;F++)this.children[F].execute(R)},E.prototype.serialize=function(R){for(var F=y.prototype._serialize.call(this,{name:"CombineAction",properties:[],combine:[]},R),B=0;B<this.children.length;B++)F.combine.push(this.children[B].serialize(null));return F},E}(O.a),v=function(y){Object(T.d)(E,y);function E(R,F,B){var L=y.call(this,R,B)||this;return L.func=F,L}return E.prototype.execute=function(R){this.func(R)},E}(O.a),l=function(y){Object(T.d)(E,y);function E(R,F,B,L){var I=y.call(this,R,L)||this;return I._target=F,I._parent=B,I}return E.prototype._prepare=function(){},E.prototype.execute=function(){if(this._target.parent!==this._parent){var R=this._parent.getWorldMatrix().clone();R.invert(),this._target.position=j.e.TransformCoordinates(this._target.position,R),this._target.parent=this._parent}},E.prototype.serialize=function(R){return y.prototype._serialize.call(this,{name:"SetParentAction",properties:[O.a._GetTargetProperty(this._target),O.a._GetTargetProperty(this._parent)]},R)},E}(O.a);M.a.RegisteredTypes["BABYLON.SetParentAction"]=l,M.a.RegisteredTypes["BABYLON.ExecuteCodeAction"]=v,M.a.RegisteredTypes["BABYLON.DoNothingAction"]=d,M.a.RegisteredTypes["BABYLON.StopAnimationAction"]=m,M.a.RegisteredTypes["BABYLON.PlayAnimationAction"]=h,M.a.RegisteredTypes["BABYLON.IncrementValueAction"]=f,M.a.RegisteredTypes["BABYLON.SetValueAction"]=p,M.a.RegisteredTypes["BABYLON.SetStateAction"]=A,M.a.RegisteredTypes["BABYLON.SetParentAction"]=l},625:function(Ue,P,u){"use strict";var T=u(435),S=u(457),j="rgbdDecodePixelShader",O=`
varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
void main(void)
{
gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);
}`;T.a.ShadersStore[j]=O;var M={name:j,shader:O}},626:function(Ue,P,u){"use strict";u.d(P,"a",function(){return H});var T=u(434),S=u(439),j=u(441),O=u(480),M=u(454),H=function(){function A(p){this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=A._DefaultIndexOfRefraction,this.indexOfRefraction=A._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=j.a.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=p}return A.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},A.prototype.isReadyForSubMesh=function(p,f,h,m){return!(p._areTexturesDirty&&f.texturesEnabled&&(this._texture&&O.a.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&O.a.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||h.getCaps().standardDerivatives&&this._bumpTexture&&O.a.ClearCoatBumpTextureEnabled&&!m&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&O.a.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))},A.prototype.prepareDefines=function(p,f){var h;this._isEnabled?(p.CLEARCOAT=!0,p.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,p.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((h=this._textureRoughness)===null||h===void 0?void 0:h._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),p.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,p._areTexturesDirty&&f.texturesEnabled&&(this._texture&&O.a.ClearCoatTextureEnabled?M.a.PrepareDefinesForMergedUV(this._texture,p,"CLEARCOAT_TEXTURE"):p.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&O.a.ClearCoatTextureEnabled?M.a.PrepareDefinesForMergedUV(this._textureRoughness,p,"CLEARCOAT_TEXTURE_ROUGHNESS"):p.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&O.a.ClearCoatBumpTextureEnabled?M.a.PrepareDefinesForMergedUV(this._bumpTexture,p,"CLEARCOAT_BUMP"):p.CLEARCOAT_BUMP=!1,p.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===A._DefaultIndexOfRefraction,this._isTintEnabled?(p.CLEARCOAT_TINT=!0,this._tintTexture&&O.a.ClearCoatTintTextureEnabled?M.a.PrepareDefinesForMergedUV(this._tintTexture,p,"CLEARCOAT_TINT_TEXTURE"):p.CLEARCOAT_TINT_TEXTURE=!1):(p.CLEARCOAT_TINT=!1,p.CLEARCOAT_TINT_TEXTURE=!1))):(p.CLEARCOAT=!1,p.CLEARCOAT_TEXTURE=!1,p.CLEARCOAT_TEXTURE_ROUGHNESS=!1,p.CLEARCOAT_BUMP=!1,p.CLEARCOAT_TINT=!1,p.CLEARCOAT_TINT_TEXTURE=!1,p.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,p.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1)},A.prototype.bindForSubMesh=function(p,f,h,m,d,g,v,l){var y,E,R,F,B,L,I,k,Z=l._materialDefines,Y=Z.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!p.useUbo||!d||!p.isSync){Y&&O.a.ClearCoatTextureEnabled?(p.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),M.a.BindTextureMatrix(this._texture,p,"clearCoat")):(this._texture||this._textureRoughness)&&O.a.ClearCoatTextureEnabled&&(p.updateFloat4("vClearCoatInfos",(E=(y=this._texture)===null||y===void 0?void 0:y.coordinatesIndex)!==null&&E!==void 0?E:0,(F=(R=this._texture)===null||R===void 0?void 0:R.level)!==null&&F!==void 0?F:0,(L=(B=this._textureRoughness)===null||B===void 0?void 0:B.coordinatesIndex)!==null&&L!==void 0?L:0,(k=(I=this._textureRoughness)===null||I===void 0?void 0:I.level)!==null&&k!==void 0?k:0),this._texture&&M.a.BindTextureMatrix(this._texture,p,"clearCoat"),this._textureRoughness&&!Y&&!Z.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&M.a.BindTextureMatrix(this._textureRoughness,p,"clearCoatRoughness")),this._bumpTexture&&h.getCaps().standardDerivatives&&O.a.ClearCoatTextureEnabled&&!m&&(p.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),M.a.BindTextureMatrix(this._bumpTexture,p,"clearCoatBump"),f._mirroredCameraPosition?p.updateFloat2("vClearCoatTangentSpaceParams",g?1:-1,v?1:-1):p.updateFloat2("vClearCoatTangentSpaceParams",g?-1:1,v?-1:1)),this._tintTexture&&O.a.ClearCoatTintTextureEnabled&&(p.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),M.a.BindTextureMatrix(this._tintTexture,p,"clearCoatTint")),p.updateFloat2("vClearCoatParams",this.intensity,this.roughness);var U=1-this._indexOfRefraction,Q=1+this._indexOfRefraction,G=Math.pow(-U/Q,2),K=1/this._indexOfRefraction;p.updateFloat4("vClearCoatRefractionParams",G,K,U,Q),this._isTintEnabled&&(p.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),p.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}f.texturesEnabled&&(this._texture&&O.a.ClearCoatTextureEnabled&&p.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!Y&&!Z.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&O.a.ClearCoatTextureEnabled&&p.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&h.getCaps().standardDerivatives&&O.a.ClearCoatBumpTextureEnabled&&!m&&p.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&O.a.ClearCoatTintTextureEnabled&&p.setTexture("clearCoatTintSampler",this._tintTexture))},A.prototype.hasTexture=function(p){return this._texture===p||this._textureRoughness===p||this._bumpTexture===p||this._tintTexture===p},A.prototype.getActiveTextures=function(p){this._texture&&p.push(this._texture),this._textureRoughness&&p.push(this._textureRoughness),this._bumpTexture&&p.push(this._bumpTexture),this._tintTexture&&p.push(this._tintTexture)},A.prototype.getAnimatables=function(p){this._texture&&this._texture.animations&&this._texture.animations.length>0&&p.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&p.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&p.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&p.push(this._tintTexture)},A.prototype.dispose=function(p){var f,h,m,d;p&&((f=this._texture)===null||f===void 0||f.dispose(),(h=this._textureRoughness)===null||h===void 0||h.dispose(),(m=this._bumpTexture)===null||m===void 0||m.dispose(),(d=this._tintTexture)===null||d===void 0||d.dispose())},A.prototype.getClassName=function(){return"PBRClearCoatConfiguration"},A.AddFallbacks=function(p,f,h){return p.CLEARCOAT_BUMP&&f.addFallback(h++,"CLEARCOAT_BUMP"),p.CLEARCOAT_TINT&&f.addFallback(h++,"CLEARCOAT_TINT"),p.CLEARCOAT&&f.addFallback(h++,"CLEARCOAT"),h},A.AddUniforms=function(p){p.push("vClearCoatTangentSpaceParams","vClearCoatParams","vClearCoatRefractionParams","vClearCoatTintParams","clearCoatColorAtDistance","clearCoatMatrix","clearCoatRoughnessMatrix","clearCoatBumpMatrix","clearCoatTintMatrix","vClearCoatInfos","vClearCoatBumpInfos","vClearCoatTintInfos")},A.AddSamplers=function(p){p.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")},A.PrepareUniformBuffer=function(p){p.addUniform("vClearCoatParams",2),p.addUniform("vClearCoatRefractionParams",4),p.addUniform("vClearCoatInfos",4),p.addUniform("clearCoatMatrix",16),p.addUniform("clearCoatRoughnessMatrix",16),p.addUniform("vClearCoatBumpInfos",2),p.addUniform("vClearCoatTangentSpaceParams",2),p.addUniform("clearCoatBumpMatrix",16),p.addUniform("vClearCoatTintParams",4),p.addUniform("clearCoatColorAtDistance",1),p.addUniform("vClearCoatTintInfos",2),p.addUniform("clearCoatTintMatrix",16)},A.prototype.copyTo=function(p){S.a.Clone(function(){return p},this)},A.prototype.serialize=function(){return S.a.Serialize(this)},A.prototype.parse=function(p,f,h){var m=this;S.a.Parse(function(){return m},p,f,h)},A._DefaultIndexOfRefraction=1.5,Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"isEnabled",void 0),Object(T.c)([Object(S.c)()],A.prototype,"intensity",void 0),Object(T.c)([Object(S.c)()],A.prototype,"roughness",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"indexOfRefraction",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"texture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useRoughnessFromMainTexture",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"textureRoughness",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"remapF0OnInterfaceChange",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"bumpTexture",void 0),Object(T.c)([Object(S.c)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"isTintEnabled",void 0),Object(T.c)([Object(S.e)()],A.prototype,"tintColor",void 0),Object(T.c)([Object(S.c)()],A.prototype,"tintColorAtDistance",void 0),Object(T.c)([Object(S.c)()],A.prototype,"tintThickness",void 0),Object(T.c)([Object(S.m)(),Object(S.b)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"tintTexture",void 0),A}()},627:function(Ue,P,u){"use strict";var T=u(435),S="subSurfaceScatteringFunctions",j=`bool testLightingForSSS(float diffusionProfile)
{
return diffusionProfile<1.;
}`;T.a.IncludesShadersStore[S]=j;var O={name:S,shader:j}},628:function(Ue,P,u){"use strict";u.d(P,"a",function(){return F});var T=u(434),S=u(436),j=u(458),O=u(679),M=u(680),H=u(676),A=u(476),p=u(541),f=u(536),h=u(629),m=u(440),d=u(448),g=S.e.Up(),v=S.e.Zero(),l=new S.e,y=new S.e,E=new S.a,R=new S.a,F=function(B){Object(T.d)(L,B);function L(I,k,Z){var Y=this;if(!L.IsSupported){m.a.Error("CascadedShadowMap is not supported by the current engine.");return}return Y=B.call(this,I,k,Z)||this,Y.usePercentageCloserFiltering=!0,Y}return L.prototype._validateFilter=function(I){return I===p.a.FILTER_NONE||I===p.a.FILTER_PCF||I===p.a.FILTER_PCSS?I:(console.error('Unsupported filter "'+I+'"!'),p.a.FILTER_NONE)},Object.defineProperty(L.prototype,"numCascades",{get:function(){return this._numCascades},set:function(I){I=Math.min(Math.max(I,L.MIN_CASCADES_COUNT),L.MAX_CASCADES_COUNT),I!==this._numCascades&&(this._numCascades=I,this.recreateShadowMap())},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"freezeShadowCastersBoundingInfo",{get:function(){return this._freezeShadowCastersBoundingInfo},set:function(I){this._freezeShadowCastersBoundingInfoObservable&&I&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!I&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=I,I&&this._computeShadowCastersBoundingInfo()},enumerable:!1,configurable:!0}),L.prototype._computeShadowCastersBoundingInfo=function(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){for(var I=this._shadowMap.renderList,k=0;k<I.length;k++){var Z=I[k];if(!!Z){var Y=Z.getBoundingInfo(),U=Y.boundingBox;this._scbiMin.minimizeInPlace(U.minimumWorld),this._scbiMax.maximizeInPlace(U.maximumWorld)}}for(var Q=this._scene.meshes,k=0;k<Q.length;k++){var Z=Q[k];if(!(!Z||!Z.isVisible||!Z.isEnabled||!Z.receiveShadows)){var Y=Z.getBoundingInfo(),U=Y.boundingBox;this._scbiMin.minimizeInPlace(U.minimumWorld),this._scbiMax.maximizeInPlace(U.maximumWorld)}}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)},Object.defineProperty(L.prototype,"shadowCastersBoundingInfo",{get:function(){return this._shadowCastersBoundingInfo},set:function(I){this._shadowCastersBoundingInfo=I},enumerable:!1,configurable:!0}),L.prototype.setMinMaxDistance=function(I,k){this._minDistance===I&&this._maxDistance===k||(I>k&&(I=0,k=1),I<0&&(I=0),k>1&&(k=1),this._minDistance=I,this._maxDistance=k,this._breaksAreDirty=!0)},Object.defineProperty(L.prototype,"minDistance",{get:function(){return this._minDistance},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"maxDistance",{get:function(){return this._maxDistance},enumerable:!1,configurable:!0}),L.prototype.getClassName=function(){return L.CLASSNAME},L.prototype.getCascadeMinExtents=function(I){return I>=0&&I<this._numCascades?this._cascadeMinExtents[I]:null},L.prototype.getCascadeMaxExtents=function(I){return I>=0&&I<this._numCascades?this._cascadeMaxExtents[I]:null},Object.defineProperty(L.prototype,"shadowMaxZ",{get:function(){return!this._scene||!this._scene.activeCamera?0:this._shadowMaxZ},set:function(I){if(!this._scene||!this._scene.activeCamera){this._shadowMaxZ=I;return}this._shadowMaxZ===I||I<this._scene.activeCamera.minZ||I>this._scene.activeCamera.maxZ||(this._shadowMaxZ=I,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"debug",{get:function(){return this._debug},set:function(I){this._debug=I,this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"depthClamp",{get:function(){return this._depthClamp},set:function(I){this._depthClamp=I},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"cascadeBlendPercentage",{get:function(){return this._cascadeBlendPercentage},set:function(I){this._cascadeBlendPercentage=I,this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"lambda",{get:function(){return this._lambda},set:function(I){var k=Math.min(Math.max(I,0),1);this._lambda!=k&&(this._lambda=k,this._breaksAreDirty=!0)},enumerable:!1,configurable:!0}),L.prototype.getCascadeViewMatrix=function(I){return I>=0&&I<this._numCascades?this._viewMatrices[I]:null},L.prototype.getCascadeProjectionMatrix=function(I){return I>=0&&I<this._numCascades?this._projectionMatrices[I]:null},L.prototype.getCascadeTransformMatrix=function(I){return I>=0&&I<this._numCascades?this._transformMatrices[I]:null},L.prototype.setDepthRenderer=function(I){this._depthRenderer=I,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)},Object.defineProperty(L.prototype,"autoCalcDepthBounds",{get:function(){return this._autoCalcDepthBounds},set:function(I){var k=this,Z=this._scene.activeCamera;if(!!Z){if(this._autoCalcDepthBounds=I,!I){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new h.a(Z),this._depthReducer.onAfterReductionPerformed.add(function(Y){var U=Y.min,Q=Y.max;U>=Q&&(U=0,Q=1),(U!=k._minDistance||Q!=k._maxDistance)&&k.setMinMaxDistance(U,Q)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}},enumerable:!1,configurable:!0}),Object.defineProperty(L.prototype,"autoCalcDepthBoundsRefreshRate",{get:function(){var I,k,Z;return(Z=(k=(I=this._depthReducer)===null||I===void 0?void 0:I.depthRenderer)===null||k===void 0?void 0:k.getDepthMap().refreshRate)!==null&&Z!==void 0?Z:-1},set:function(I){var k;((k=this._depthReducer)===null||k===void 0?void 0:k.depthRenderer)&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=I)},enumerable:!1,configurable:!0}),L.prototype.splitFrustum=function(){this._breaksAreDirty=!0},L.prototype._splitFrustum=function(){var I=this._scene.activeCamera;if(!!I){for(var k=I.minZ,Z=I.maxZ,Y=Z-k,U=this._minDistance,Q=this._shadowMaxZ<Z&&this._shadowMaxZ>=k?Math.min((this._shadowMaxZ-k)/(Z-k),this._maxDistance):this._maxDistance,G=k+U*Y,K=k+Q*Y,fe=K-G,ce=K/G,re=0;re<this._cascades.length;++re){var Re=(re+1)/this._numCascades,Ie=G*Math.pow(ce,Re),Ce=G+fe*Re,X=this._lambda*(Ie-Ce)+Ce;this._cascades[re].prevBreakDistance=re===0?U:this._cascades[re-1].breakDistance,this._cascades[re].breakDistance=(X-k)/Y,this._viewSpaceFrustumsZ[re]=k+this._cascades[re].breakDistance*Y,this._frustumLengths[re]=(this._cascades[re].breakDistance-this._cascades[re].prevBreakDistance)*Y}this._breaksAreDirty=!1}},L.prototype._computeMatrices=function(){var I=this._scene,k=I.activeCamera;if(!!k){S.e.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(S.e.Dot(this._lightDirection,S.e.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);for(var Z=0;Z<this._numCascades;++Z){this._computeFrustumInWorldSpace(Z),this._computeCascadeFrustum(Z),this._cascadeMaxExtents[Z].subtractToRef(this._cascadeMinExtents[Z],l),this._frustumCenter[Z].addToRef(this._lightDirection.scale(this._cascadeMinExtents[Z].z),this._shadowCameraPos[Z]),S.a.LookAtLHToRef(this._shadowCameraPos[Z],this._frustumCenter[Z],g,this._viewMatrices[Z]);var Y=0,U=l.z,Q=this._shadowCastersBoundingInfo;Q.update(this._viewMatrices[Z]),U=Math.min(U,Q.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===p.a.FILTER_PCSS?Y=Math.min(Y,Q.boundingBox.minimumWorld.z):Y=Math.max(Y,Q.boundingBox.minimumWorld.z),S.a.OrthoOffCenterLHToRef(this._cascadeMinExtents[Z].x,this._cascadeMaxExtents[Z].x,this._cascadeMinExtents[Z].y,this._cascadeMaxExtents[Z].y,Y,U,this._projectionMatrices[Z]),this._cascadeMinExtents[Z].z=Y,this._cascadeMaxExtents[Z].z=U,this._viewMatrices[Z].multiplyToRef(this._projectionMatrices[Z],this._transformMatrices[Z]),S.e.TransformCoordinatesToRef(v,this._transformMatrices[Z],l),l.scaleInPlace(this._mapSize/2),y.copyFromFloats(Math.round(l.x),Math.round(l.y),Math.round(l.z)),y.subtractInPlace(l).scaleInPlace(2/this._mapSize),S.a.TranslationToRef(y.x,y.y,0,E),this._projectionMatrices[Z].multiplyToRef(E,this._projectionMatrices[Z]),this._viewMatrices[Z].multiplyToRef(this._projectionMatrices[Z],this._transformMatrices[Z]),this._transformMatrices[Z].copyToArray(this._transformMatricesAsArray,Z*16)}}},L.prototype._computeFrustumInWorldSpace=function(I){if(!!this._scene.activeCamera){var k=this._cascades[I].prevBreakDistance,Z=this._cascades[I].breakDistance;this._scene.activeCamera.getViewMatrix();for(var Y=S.a.Invert(this._scene.activeCamera.getTransformationMatrix()),U=0;U<L.frustumCornersNDCSpace.length;++U)S.e.TransformCoordinatesToRef(L.frustumCornersNDCSpace[U],Y,this._frustumCornersWorldSpace[I][U]);for(var U=0;U<L.frustumCornersNDCSpace.length/2;++U)l.copyFrom(this._frustumCornersWorldSpace[I][U+4]).subtractInPlace(this._frustumCornersWorldSpace[I][U]),y.copyFrom(l).scaleInPlace(k),l.scaleInPlace(Z),l.addInPlace(this._frustumCornersWorldSpace[I][U]),this._frustumCornersWorldSpace[I][U+4].copyFrom(l),this._frustumCornersWorldSpace[I][U].addInPlace(y)}},L.prototype._computeCascadeFrustum=function(I){this._cascadeMinExtents[I].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[I].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[I].copyFromFloats(0,0,0);var k=this._scene.activeCamera;if(!!k){for(var Z=0;Z<this._frustumCornersWorldSpace[I].length;++Z)this._frustumCenter[I].addInPlace(this._frustumCornersWorldSpace[I][Z]);if(this._frustumCenter[I].scaleInPlace(1/this._frustumCornersWorldSpace[I].length),this.stabilizeCascades){for(var Y=0,Z=0;Z<this._frustumCornersWorldSpace[I].length;++Z){var U=this._frustumCornersWorldSpace[I][Z].subtractToRef(this._frustumCenter[I],l).length();Y=Math.max(Y,U)}Y=Math.ceil(Y*16)/16,this._cascadeMaxExtents[I].copyFromFloats(Y,Y,Y),this._cascadeMinExtents[I].copyFromFloats(-Y,-Y,-Y)}else{var Q=this._frustumCenter[I];this._frustumCenter[I].addToRef(this._lightDirection,l),S.a.LookAtLHToRef(Q,l,g,E);for(var Z=0;Z<this._frustumCornersWorldSpace[I].length;++Z)S.e.TransformCoordinatesToRef(this._frustumCornersWorldSpace[I][Z],E,l),this._cascadeMinExtents[I].minimizeInPlace(l),this._cascadeMaxExtents[I].maximizeInPlace(l)}}},Object.defineProperty(L,"IsSupported",{get:function(){var I=d.a.LastCreatedEngine;return I?I._features.supportCSM:!1},enumerable:!1,configurable:!0}),L.prototype._initializeGenerator=function(){var I,k,Z,Y,U,Q,G,K,fe,ce,re,Re,Ie,Ce,X,ae,ee,w,N,W;this.penumbraDarkness=(I=this.penumbraDarkness)!==null&&I!==void 0?I:1,this._numCascades=(k=this._numCascades)!==null&&k!==void 0?k:L.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=(Z=this.stabilizeCascades)!==null&&Z!==void 0?Z:!1,this._freezeShadowCastersBoundingInfoObservable=(Y=this._freezeShadowCastersBoundingInfoObservable)!==null&&Y!==void 0?Y:null,this.freezeShadowCastersBoundingInfo=(U=this.freezeShadowCastersBoundingInfo)!==null&&U!==void 0?U:!1,this._scbiMin=(Q=this._scbiMin)!==null&&Q!==void 0?Q:new S.e(0,0,0),this._scbiMax=(G=this._scbiMax)!==null&&G!==void 0?G:new S.e(0,0,0),this._shadowCastersBoundingInfo=(K=this._shadowCastersBoundingInfo)!==null&&K!==void 0?K:new f.a(new S.e(0,0,0),new S.e(0,0,0)),this._breaksAreDirty=(fe=this._breaksAreDirty)!==null&&fe!==void 0?fe:!0,this._minDistance=(ce=this._minDistance)!==null&&ce!==void 0?ce:0,this._maxDistance=(re=this._maxDistance)!==null&&re!==void 0?re:1,this._currentLayer=(Re=this._currentLayer)!==null&&Re!==void 0?Re:0,this._shadowMaxZ=(X=(Ie=this._shadowMaxZ)!==null&&Ie!==void 0?Ie:(Ce=this._scene.activeCamera)===null||Ce===void 0?void 0:Ce.maxZ)!==null&&X!==void 0?X:1e4,this._debug=(ae=this._debug)!==null&&ae!==void 0?ae:!1,this._depthClamp=(ee=this._depthClamp)!==null&&ee!==void 0?ee:!0,this._cascadeBlendPercentage=(w=this._cascadeBlendPercentage)!==null&&w!==void 0?w:.1,this._lambda=(N=this._lambda)!==null&&N!==void 0?N:.5,this._autoCalcDepthBounds=(W=this._autoCalcDepthBounds)!==null&&W!==void 0?W:!1,B.prototype._initializeGenerator.call(this)},L.prototype._createTargetRenderTexture=function(){var I={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new j.a(this._light.name+"_shadowMap",I,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(513,!0)},L.prototype._initializeShadowMap=function(){var I=this;if(B.prototype._initializeShadowMap.call(this),this._shadowMap!==null){this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(var k=0;k<this._numCascades;++k){this._cascades[k]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[k]=S.a.Zero(),this._projectionMatrices[k]=S.a.Zero(),this._transformMatrices[k]=S.a.Zero(),this._cascadeMinExtents[k]=new S.e,this._cascadeMaxExtents[k]=new S.e,this._frustumCenter[k]=new S.e,this._shadowCameraPos[k]=new S.e,this._frustumCornersWorldSpace[k]=new Array(L.frustumCornersNDCSpace.length);for(var Z=0;Z<L.frustumCornersNDCSpace.length;++Z)this._frustumCornersWorldSpace[k][Z]=new S.e}var Y=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(function(U){I._currentLayer=U,I._filter===p.a.FILTER_PCF&&Y.setColorWrite(!1),I._scene.setTransformMatrix(I.getCascadeViewMatrix(U),I.getCascadeProjectionMatrix(U))}),this._shadowMap.onBeforeBindObservable.add(function(){Y._debugPushGroup("cascaded shadow map generation for "+I._nameForCustomEffect,1),I._breaksAreDirty&&I._splitFrustum(),I._computeMatrices()}),this._splitFrustum()}},L.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(I,k,Z,Y){var U,Q,G,K,fe,ce;k.setMatrix((U=Z==null?void 0:Z.viewProjection)!==null&&U!==void 0?U:"viewProjection",this.getCascadeTransformMatrix(this._currentLayer)),k.setMatrix((Q=Z==null?void 0:Z.view)!==null&&Q!==void 0?Q:"view",this.getCascadeViewMatrix(this._currentLayer)),k.setMatrix((G=Z==null?void 0:Z.projection)!==null&&G!==void 0?G:"projection",this.getCascadeProjectionMatrix(this._currentLayer));var re=Y.getWorldMatrix();k.setMatrix((K=Z==null?void 0:Z.world)!==null&&K!==void 0?K:"world",re),re.multiplyToRef(this.getCascadeTransformMatrix(this._currentLayer),E),k.setMatrix((fe=Z==null?void 0:Z.worldViewProjection)!==null&&fe!==void 0?fe:"worldViewProjection",E),re.multiplyToRef(this.getCascadeViewMatrix(this._currentLayer),R),k.setMatrix((ce=Z==null?void 0:Z.worldView)!==null&&ce!==void 0?ce:"worldView",R)},L.prototype._isReadyCustomDefines=function(I,k,Z){I.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==p.a.FILTER_PCSS?"1":"0"))},L.prototype.prepareDefines=function(I,k){B.prototype.prepareDefines.call(this,I,k);var Z=this._scene,Y=this._light;if(!(!Z.shadowsEnabled||!Y.shadowEnabled)){I["SHADOWCSM"+k]=!0,I["SHADOWCSMDEBUG"+k]=this.debug,I["SHADOWCSMNUM_CASCADES"+k]=this.numCascades,I["SHADOWCSM_RIGHTHANDED"+k]=Z.useRightHandedSystem;var U=Z.activeCamera;U&&this._shadowMaxZ<U.maxZ&&(I["SHADOWCSMUSESHADOWMAXZ"+k]=!0),this.cascadeBlendPercentage===0&&(I["SHADOWCSMNOBLEND"+k]=!0)}},L.prototype.bindShadowLight=function(I,k){var Z=this._light,Y=this._scene;if(!(!Y.shadowsEnabled||!Z.shadowEnabled)){var U=Y.activeCamera;if(!!U){var Q=this.getShadowMap();if(!!Q){var G=Q.getSize().width;if(k.setMatrices("lightMatrix"+I,this._transformMatricesAsArray),k.setArray("viewFrustumZ"+I,this._viewSpaceFrustumsZ),k.setFloat("cascadeBlendFactor"+I,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),k.setArray("frustumLengths"+I,this._frustumLengths),this._filter===p.a.FILTER_PCF)k.setDepthStencilTexture("shadowSampler"+I,Q),Z._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),G,1/G,this.frustumEdgeFalloff,I);else if(this._filter===p.a.FILTER_PCSS){for(var K=0;K<this._numCascades;++K)this._lightSizeUVCorrection[K*2+0]=K===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[K].x-this._cascadeMinExtents[K].x),this._lightSizeUVCorrection[K*2+1]=K===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[K].y-this._cascadeMinExtents[K].y),this._depthCorrection[K]=K===0?1:(this._cascadeMaxExtents[K].z-this._cascadeMinExtents[K].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);k.setDepthStencilTexture("shadowSampler"+I,Q),k.setTexture("depthSampler"+I,Q),k.setArray2("lightSizeUVCorrection"+I,this._lightSizeUVCorrection),k.setArray("depthCorrection"+I,this._depthCorrection),k.setFloat("penumbraDarkness"+I,this.penumbraDarkness),Z._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/G,this._contactHardeningLightSizeUVRatio*G,this.frustumEdgeFalloff,I)}else k.setTexture("shadowSampler"+I,Q),Z._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),G,1/G,this.frustumEdgeFalloff,I);Z._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(U),this.getLight().getDepthMinZ(U)+this.getLight().getDepthMaxZ(U),I)}}}},L.prototype.getTransformMatrix=function(){return this.getCascadeTransformMatrix(0)},L.prototype.dispose=function(){B.prototype.dispose.call(this),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)},L.prototype.serialize=function(){var I=B.prototype.serialize.call(this),k=this.getShadowMap();if(!k)return I;if(I.numCascades=this._numCascades,I.debug=this._debug,I.stabilizeCascades=this.stabilizeCascades,I.lambda=this._lambda,I.cascadeBlendPercentage=this.cascadeBlendPercentage,I.depthClamp=this._depthClamp,I.autoCalcDepthBounds=this.autoCalcDepthBounds,I.shadowMaxZ=this._shadowMaxZ,I.penumbraDarkness=this.penumbraDarkness,I.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,I.minDistance=this.minDistance,I.maxDistance=this.maxDistance,I.renderList=[],k.renderList)for(var Z=0;Z<k.renderList.length;Z++){var Y=k.renderList[Z];I.renderList.push(Y.id)}return I},L.Parse=function(I,k){var Z=p.a.Parse(I,k,function(Y,U){return new L(Y,U)});return I.numCascades!==void 0&&(Z.numCascades=I.numCascades),I.debug!==void 0&&(Z.debug=I.debug),I.stabilizeCascades!==void 0&&(Z.stabilizeCascades=I.stabilizeCascades),I.lambda!==void 0&&(Z.lambda=I.lambda),I.cascadeBlendPercentage!==void 0&&(Z.cascadeBlendPercentage=I.cascadeBlendPercentage),I.depthClamp!==void 0&&(Z.depthClamp=I.depthClamp),I.autoCalcDepthBounds!==void 0&&(Z.autoCalcDepthBounds=I.autoCalcDepthBounds),I.shadowMaxZ!==void 0&&(Z.shadowMaxZ=I.shadowMaxZ),I.penumbraDarkness!==void 0&&(Z.penumbraDarkness=I.penumbraDarkness),I.freezeShadowCastersBoundingInfo!==void 0&&(Z.freezeShadowCastersBoundingInfo=I.freezeShadowCastersBoundingInfo),I.minDistance!==void 0&&I.maxDistance!==void 0&&Z.setMinMaxDistance(I.minDistance,I.maxDistance),Z},L.frustumCornersNDCSpace=[new S.e(-1,1,-1),new S.e(1,1,-1),new S.e(1,-1,-1),new S.e(-1,-1,-1),new S.e(-1,1,1),new S.e(1,1,1),new S.e(1,-1,1),new S.e(-1,-1,1)],L.CLASSNAME="CascadedShadowGenerator",L.DEFAULT_CASCADES_COUNT=4,L.MIN_CASCADES_COUNT=2,L.MAX_CASCADES_COUNT=4,L._SceneComponentInitialization=function(I){throw A.a.WarnImport("ShadowGeneratorSceneComponent")},L}(p.a)},629:function(Ue,P,u){"use strict";u.d(P,"a",function(){return O});var T=u(434),S=u(556),j=u(638),O=function(M){Object(T.d)(H,M);function H(A){return M.call(this,A)||this}return Object.defineProperty(H.prototype,"depthRenderer",{get:function(){return this._depthRenderer},enumerable:!1,configurable:!0}),H.prototype.setDepthRenderer=function(A,p,f){A===void 0&&(A=null),p===void 0&&(p=2),f===void 0&&(f=!0);var h=this._camera.getScene();this._depthRenderer&&(delete h._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),A===null&&(h._depthRenderer||(h._depthRenderer={}),A=this._depthRenderer=new S.a(h,p,this._camera,!1),A.enabled=!1,this._depthRendererId="minmax"+this._camera.id,h._depthRenderer[this._depthRendererId]=A),M.prototype.setSourceTexture.call(this,A.getDepthMap(),!0,p,f)},H.prototype.setSourceTexture=function(A,p,f,h){f===void 0&&(f=2),h===void 0&&(h=!0),M.prototype.setSourceTexture.call(this,A,p,f,h)},H.prototype.activate=function(){this._depthRenderer&&(this._depthRenderer.enabled=!0),M.prototype.activate.call(this)},H.prototype.deactivate=function(){M.prototype.deactivate.call(this),this._depthRenderer&&(this._depthRenderer.enabled=!1)},H.prototype.dispose=function(A){if(A===void 0&&(A=!0),M.prototype.dispose.call(this,A),this._depthRenderer&&A){var p=this._depthRenderer.getDepthMap().getScene();p&&delete p._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}},H}(j.a)},630:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A}),u.d(P,"b",function(){return p});var T=u(434),S=u(447),j=u(520),O=u(438),M=u(435),H=u(534),A=function(){function f(h,m){var d;m===void 0&&(m=f._DefaultOptions),this.engine=h,this._fullscreenViewport=new j.a(0,0,1,1),m=Object(T.a)(Object(T.a)({},f._DefaultOptions),m),this._vertexBuffers=(d={},d[S.b.PositionKind]=new S.b(h,m.positions,S.b.PositionKind,!1,!1,2),d),this._indexBuffer=h.createIndexBuffer(m.indices)}return f.prototype.setViewport=function(h){h===void 0&&(h=this._fullscreenViewport),this.engine.setViewport(h)},f.prototype.bindBuffers=function(h){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,h)},f.prototype.applyEffectWrapper=function(h){this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(h.effect),this.bindBuffers(h.effect),h.onApplyObservable.notifyObservers({})},f.prototype.restoreStates=function(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0},f.prototype.draw=function(){this.engine.drawElementsType(0,0,6)},f.prototype.isRenderTargetTexture=function(h){return h.renderList!==void 0},f.prototype.render=function(h,m){if(m===void 0&&(m=null),!!h.effect.isReady()){this.setViewport();var d=m===null?null:this.isRenderTargetTexture(m)?m.getInternalTexture():m;d&&this.engine.bindFramebuffer(d),this.applyEffectWrapper(h),this.draw(),d&&this.engine.unBindFramebuffer(d),this.restoreStates()}},f.prototype.dispose=function(){var h=this._vertexBuffers[S.b.PositionKind];h&&(h.dispose(),delete this._vertexBuffers[S.b.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer)},f._DefaultOptions={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},f}(),p=function(){function f(h){var m=this;this.onApplyObservable=new O.c;var d,g=h.uniformNames||[];h.vertexShader?d={fragmentSource:h.fragmentShader,vertexSource:h.vertexShader,spectorName:h.name||"effectWrapper"}:(g.push("scale"),d={fragmentSource:h.fragmentShader,vertex:"postprocess",spectorName:h.name||"effectWrapper"},this.onApplyObservable.add(function(){m.effect.setFloat2("scale",1,1)}));var v=h.defines?h.defines.join(`
`):"";h.useShaderStore?(d.fragment=d.fragmentSource,d.vertex||(d.vertex=d.vertexSource),delete d.fragmentSource,delete d.vertexSource,this.effect=h.engine.createEffect(d.spectorName,h.attributeNames||["position"],g,h.samplerNames,v,void 0,h.onCompiled)):this.effect=new M.a(d,h.attributeNames||["position"],g,h.samplerNames,h.engine,v,void 0,h.onCompiled)}return f.prototype.dispose=function(){this.effect.dispose()},f}()},631:function(Ue,P,u){"use strict";u.d(P,"a",function(){return O});var T=u(434),S=u(442),j=u(492),O=function(M){Object(T.d)(H,M);function H(A,p,f,h,m,d,g,v,l,y){g===void 0&&(g=!0),v===void 0&&(v=!1),l===void 0&&(l=S.a.TRILINEAR_SAMPLINGMODE),y===void 0&&(y=0);var E=M.call(this,null,d,!g,v)||this;return E.format=m,E._texture=d.getEngine().createRawTexture2DArray(A,p,f,h,m,g,v,l,null,y),E._depth=h,E.is2DArray=!0,E}return Object.defineProperty(H.prototype,"depth",{get:function(){return this._depth},enumerable:!1,configurable:!0}),H.prototype.update=function(A){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,A,this._texture.format,this._texture.invertY,null,this._texture.type)},H.CreateRGBATexture=function(A,p,f,h,m,d,g,v,l){return d===void 0&&(d=!0),g===void 0&&(g=!1),v===void 0&&(v=3),l===void 0&&(l=0),new H(A,p,f,h,5,m,d,g,v,l)},H}(S.a)},632:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(440),S=u(436),j=u(447),O=u(503),M=u(510),H=u(544),A=u(609),p=function(){function f(h,m,d){if(h===void 0&&(h=!0),m===void 0&&(m=10),d===void 0&&(d=CANNON),this._useDeltaForWorldStep=h,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodysToRemoveAfterStep=new Array,this._firstFrame=!0,this._minus90X=new S.b(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new S.b(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=S.e.Zero(),this._tmpDeltaPosition=S.e.Zero(),this._tmpUnityRotation=new S.b,this.BJSCANNON=d,!this.isSupported()){T.a.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=m,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new A.a}return f.prototype.setGravity=function(h){var m=h;this.world.gravity.set(m.x,m.y,m.z)},f.prototype.setTimeStep=function(h){this._fixedTimeStep=h},f.prototype.getTimeStep=function(){return this._fixedTimeStep},f.prototype.executeStep=function(h,m){if(this._firstFrame){this._firstFrame=!1;for(var d=0,g=m;d<g.length;d++){var v=g[d];v.type==O.a.HeightmapImpostor||v.type===O.a.PlaneImpostor||v.beforeStep()}}this.world.step(this._useDeltaForWorldStep?h:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()},f.prototype._removeMarkedPhysicsBodiesFromWorld=function(){var h=this;this._physicsBodysToRemoveAfterStep.length>0&&(this._physicsBodysToRemoveAfterStep.forEach(function(m){h.world.remove(m)}),this._physicsBodysToRemoveAfterStep=[])},f.prototype.applyImpulse=function(h,m,d){var g=new this.BJSCANNON.Vec3(d.x,d.y,d.z),v=new this.BJSCANNON.Vec3(m.x,m.y,m.z);h.physicsBody.applyImpulse(v,g)},f.prototype.applyForce=function(h,m,d){var g=new this.BJSCANNON.Vec3(d.x,d.y,d.z),v=new this.BJSCANNON.Vec3(m.x,m.y,m.z);h.physicsBody.applyForce(v,g)},f.prototype.generatePhysicsBody=function(h){if(this._removeMarkedPhysicsBodiesFromWorld(),h.parent){h.physicsBody&&(this.removePhysicsBody(h),h.forceUpdate());return}if(h.isBodyInitRequired()){var m=this._createShape(h),d=h.physicsBody;d&&this.removePhysicsBody(h);var g=this._addMaterial("mat-"+h.uniqueId,h.getParam("friction"),h.getParam("restitution")),v={mass:h.getParam("mass"),material:g},l=h.getParam("nativeOptions");for(var y in l)l.hasOwnProperty(y)&&(v[y]=l[y]);h.physicsBody=new this.BJSCANNON.Body(v),h.physicsBody.addEventListener("collide",h.onCollide),this.world.addEventListener("preStep",h.beforeStep),this.world.addEventListener("postStep",h.afterStep),h.physicsBody.addShape(m),this.world.add(h.physicsBody),d&&["force","torque","velocity","angularVelocity"].forEach(function(E){var R=d[E];h.physicsBody[E].set(R.x,R.y,R.z)}),this._processChildMeshes(h)}this._updatePhysicsBodyTransformation(h)},f.prototype._processChildMeshes=function(h){var m=this,d=h.object.getChildMeshes?h.object.getChildMeshes(!0):[],g=h.object.rotationQuaternion;if(d.length){var v=function(l){if(!(!g||!l.rotationQuaternion)){var y=l.getPhysicsImpostor();if(y){var E=y.parent;if(E!==h){var R=l.getAbsolutePosition().subtract(l.parent.getAbsolutePosition()),F=l.rotationQuaternion;y.physicsBody&&(m.removePhysicsBody(y),y.physicsBody=null),y.parent=h,y.resetUpdateFlags(),h.physicsBody.addShape(m._createShape(y),new m.BJSCANNON.Vec3(R.x,R.y,R.z),new m.BJSCANNON.Quaternion(F.x,F.y,F.z,F.w)),h.physicsBody.mass+=y.getParam("mass")}}g.multiplyInPlace(l.rotationQuaternion),l.getChildMeshes(!0).filter(function(B){return!!B.physicsImpostor}).forEach(v)}};d.filter(function(l){return!!l.physicsImpostor}).forEach(v)}},f.prototype.removePhysicsBody=function(h){h.physicsBody.removeEventListener("collide",h.onCollide),this.world.removeEventListener("preStep",h.beforeStep),this.world.removeEventListener("postStep",h.afterStep),this._physicsBodysToRemoveAfterStep.indexOf(h.physicsBody)===-1&&this._physicsBodysToRemoveAfterStep.push(h.physicsBody)},f.prototype.generateJoint=function(h){var m=h.mainImpostor.physicsBody,d=h.connectedImpostor.physicsBody;if(!(!m||!d)){var g,v=h.joint.jointData,l={pivotA:v.mainPivot?new this.BJSCANNON.Vec3().set(v.mainPivot.x,v.mainPivot.y,v.mainPivot.z):null,pivotB:v.connectedPivot?new this.BJSCANNON.Vec3().set(v.connectedPivot.x,v.connectedPivot.y,v.connectedPivot.z):null,axisA:v.mainAxis?new this.BJSCANNON.Vec3().set(v.mainAxis.x,v.mainAxis.y,v.mainAxis.z):null,axisB:v.connectedAxis?new this.BJSCANNON.Vec3().set(v.connectedAxis.x,v.connectedAxis.y,v.connectedAxis.z):null,maxForce:v.nativeParams.maxForce,collideConnected:!!v.collision};switch(h.joint.type){case M.e.HingeJoint:case M.e.Hinge2Joint:g=new this.BJSCANNON.HingeConstraint(m,d,l);break;case M.e.DistanceJoint:g=new this.BJSCANNON.DistanceConstraint(m,d,v.maxDistance||2);break;case M.e.SpringJoint:var y=v;g=new this.BJSCANNON.Spring(m,d,{restLength:y.length,stiffness:y.stiffness,damping:y.damping,localAnchorA:l.pivotA,localAnchorB:l.pivotB});break;case M.e.LockJoint:g=new this.BJSCANNON.LockConstraint(m,d,l);break;case M.e.PointToPointJoint:case M.e.BallAndSocketJoint:default:g=new this.BJSCANNON.PointToPointConstraint(m,l.pivotA,d,l.pivotB,l.maxForce);break}g.collideConnected=!!v.collision,h.joint.physicsJoint=g,h.joint.type!==M.e.SpringJoint?this.world.addConstraint(g):(h.joint.jointData.forceApplicationCallback=h.joint.jointData.forceApplicationCallback||function(){g.applyForce()},h.mainImpostor.registerAfterPhysicsStep(h.joint.jointData.forceApplicationCallback))}},f.prototype.removeJoint=function(h){h.joint.type!==M.e.SpringJoint?this.world.removeConstraint(h.joint.physicsJoint):h.mainImpostor.unregisterAfterPhysicsStep(h.joint.jointData.forceApplicationCallback)},f.prototype._addMaterial=function(h,m,d){var g,v;for(g=0;g<this._physicsMaterials.length;g++)if(v=this._physicsMaterials[g],v.friction===m&&v.restitution===d)return v;var l=new this.BJSCANNON.Material(h);return l.friction=m,l.restitution=d,this._physicsMaterials.push(l),l},f.prototype._checkWithEpsilon=function(h){return h<H.a.Epsilon?H.a.Epsilon:h},f.prototype._createShape=function(h){var m=h.object,d,g=h.getObjectExtendSize();switch(h.type){case O.a.SphereImpostor:var v=g.x,l=g.y,y=g.z;d=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(v),this._checkWithEpsilon(l),this._checkWithEpsilon(y))/2);break;case O.a.CylinderImpostor:var E=h.getParam("nativeOptions");E||(E={});var R=E.radiusTop!==void 0?E.radiusTop:this._checkWithEpsilon(g.x)/2,F=E.radiusBottom!==void 0?E.radiusBottom:this._checkWithEpsilon(g.x)/2,B=E.height!==void 0?E.height:this._checkWithEpsilon(g.y),L=E.numSegments!==void 0?E.numSegments:16;d=new this.BJSCANNON.Cylinder(R,F,B,L);var I=new this.BJSCANNON.Quaternion;I.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);var k=new this.BJSCANNON.Vec3(0,0,0);d.transformAllPoints(k,I);break;case O.a.BoxImpostor:var Z=g.scale(.5);d=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(Z.x),this._checkWithEpsilon(Z.y),this._checkWithEpsilon(Z.z)));break;case O.a.PlaneImpostor:T.a.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),d=new this.BJSCANNON.Plane;break;case O.a.MeshImpostor:var Y=m.getVerticesData?m.getVerticesData(j.b.PositionKind):[],U=m.getIndices?m.getIndices():[];if(!Y)return;var Q=m.position.clone(),G=m.rotation&&m.rotation.clone(),K=m.rotationQuaternion&&m.rotationQuaternion.clone();m.position.copyFromFloats(0,0,0),m.rotation&&m.rotation.copyFromFloats(0,0,0),m.rotationQuaternion&&m.rotationQuaternion.copyFrom(h.getParentsRotation()),m.rotationQuaternion&&m.parent&&m.rotationQuaternion.conjugateInPlace();var fe=m.computeWorldMatrix(!0),ce=new Array,re;for(re=0;re<Y.length;re+=3)S.e.TransformCoordinates(S.e.FromArray(Y,re),fe).toArray(ce,re);T.a.Warn("MeshImpostor only collides against spheres."),d=new this.BJSCANNON.Trimesh(ce,U),m.position.copyFrom(Q),G&&m.rotation&&m.rotation.copyFrom(G),K&&m.rotationQuaternion&&m.rotationQuaternion.copyFrom(K);break;case O.a.HeightmapImpostor:var Re=m.position.clone(),Ie=m.rotation&&m.rotation.clone(),Ce=m.rotationQuaternion&&m.rotationQuaternion.clone();m.position.copyFromFloats(0,0,0),m.rotation&&m.rotation.copyFromFloats(0,0,0),m.rotationQuaternion&&m.rotationQuaternion.copyFrom(h.getParentsRotation()),m.rotationQuaternion&&m.parent&&m.rotationQuaternion.conjugateInPlace(),m.rotationQuaternion&&m.rotationQuaternion.multiplyInPlace(this._minus90X),d=this._createHeightmap(m),m.position.copyFrom(Re),Ie&&m.rotation&&m.rotation.copyFrom(Ie),Ce&&m.rotationQuaternion&&m.rotationQuaternion.copyFrom(Ce),m.computeWorldMatrix(!0);break;case O.a.ParticleImpostor:d=new this.BJSCANNON.Particle;break;case O.a.NoImpostor:d=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return d},f.prototype._createHeightmap=function(h,m){var d=h.getVerticesData(j.b.PositionKind),g=h.computeWorldMatrix(!0),v=new Array,l;for(l=0;l<d.length;l+=3)S.e.TransformCoordinates(S.e.FromArray(d,l),g).toArray(v,l);d=v;for(var y=new Array,E=m||~~(Math.sqrt(d.length/3)-1),R=h.getBoundingInfo(),F=Math.min(R.boundingBox.extendSizeWorld.x,R.boundingBox.extendSizeWorld.y),B=R.boundingBox.extendSizeWorld.z,L=F*2/E,I=0;I<d.length;I=I+3){var k=Math.round(d[I+0]/L+E/2),Z=Math.round((d[I+1]/L-E/2)*-1),Y=-d[I+2]+B;y[k]||(y[k]=[]),y[k][Z]||(y[k][Z]=Y),y[k][Z]=Math.max(Y,y[k][Z])}for(var k=0;k<=E;++k){if(!y[k]){for(var U=1;!y[(k+U)%E];)U++;y[k]=y[(k+U)%E].slice()}for(var Z=0;Z<=E;++Z)if(!y[k][Z]){for(var U=1,Q;Q===void 0;)Q=y[k][(Z+U++)%E];y[k][Z]=Q}}var G=new this.BJSCANNON.Heightfield(y,{elementSize:L});return G.minY=B,G},f.prototype._updatePhysicsBodyTransformation=function(h){var m=h.object;if(m.computeWorldMatrix&&m.computeWorldMatrix(!0),!!m.getBoundingInfo()){var d=h.getObjectCenter();this._tmpDeltaPosition.copyFrom(m.getAbsolutePivotPoint().subtract(d)),this._tmpDeltaPosition.divideInPlace(h.object.scaling),this._tmpPosition.copyFrom(d);var g=m.rotationQuaternion;if(!!g){if((h.type===O.a.PlaneImpostor||h.type===O.a.HeightmapImpostor)&&(g=g.multiply(this._minus90X),h.setDeltaRotation(this._plus90X)),h.type===O.a.HeightmapImpostor){var v=m,l=v.getBoundingInfo(),y=v.rotationQuaternion;v.rotationQuaternion=this._tmpUnityRotation,v.computeWorldMatrix(!0);var E=d.clone(),R=v.getPivotMatrix();R?R=R.clone():R=S.a.Identity();var F=S.a.Translation(l.boundingBox.extendSizeWorld.x,0,-l.boundingBox.extendSizeWorld.z);v.setPreTransformMatrix(F),v.computeWorldMatrix(!0);var B=l.boundingBox.centerWorld.subtract(d).subtract(v.position).negate();this._tmpPosition.copyFromFloats(B.x,B.y-l.boundingBox.extendSizeWorld.y,B.z),this._tmpDeltaPosition.copyFrom(l.boundingBox.centerWorld.subtract(E)),this._tmpDeltaPosition.y+=l.boundingBox.extendSizeWorld.y,v.rotationQuaternion=y,v.setPreTransformMatrix(R),v.computeWorldMatrix(!0)}else h.type===O.a.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);h.setDeltaPosition(this._tmpDeltaPosition),h.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),h.physicsBody.quaternion.set(g.x,g.y,g.z,g.w)}}},f.prototype.setTransformationFromPhysicsBody=function(h){if(h.object.position.set(h.physicsBody.position.x,h.physicsBody.position.y,h.physicsBody.position.z),h.object.rotationQuaternion){var m=h.physicsBody.quaternion;h.object.rotationQuaternion.set(m.x,m.y,m.z,m.w)}},f.prototype.setPhysicsBodyTransformation=function(h,m,d){h.physicsBody.position.set(m.x,m.y,m.z),h.physicsBody.quaternion.set(d.x,d.y,d.z,d.w)},f.prototype.isSupported=function(){return this.BJSCANNON!==void 0},f.prototype.setLinearVelocity=function(h,m){h.physicsBody.velocity.set(m.x,m.y,m.z)},f.prototype.setAngularVelocity=function(h,m){h.physicsBody.angularVelocity.set(m.x,m.y,m.z)},f.prototype.getLinearVelocity=function(h){var m=h.physicsBody.velocity;return m?new S.e(m.x,m.y,m.z):null},f.prototype.getAngularVelocity=function(h){var m=h.physicsBody.angularVelocity;return m?new S.e(m.x,m.y,m.z):null},f.prototype.setBodyMass=function(h,m){h.physicsBody.mass=m,h.physicsBody.updateMassProperties()},f.prototype.getBodyMass=function(h){return h.physicsBody.mass},f.prototype.getBodyFriction=function(h){return h.physicsBody.material.friction},f.prototype.setBodyFriction=function(h,m){h.physicsBody.material.friction=m},f.prototype.getBodyRestitution=function(h){return h.physicsBody.material.restitution},f.prototype.setBodyRestitution=function(h,m){h.physicsBody.material.restitution=m},f.prototype.sleepBody=function(h){h.physicsBody.sleep()},f.prototype.wakeUpBody=function(h){h.physicsBody.wakeUp()},f.prototype.updateDistanceJoint=function(h,m){h.physicsJoint.distance=m},f.prototype.setMotor=function(h,m,d,g){g||(h.physicsJoint.enableMotor(),h.physicsJoint.setMotorSpeed(m),d&&this.setLimit(h,d))},f.prototype.setLimit=function(h,m,d){h.physicsJoint.motorEquation.maxForce=m,h.physicsJoint.motorEquation.minForce=d===void 0?-m:d},f.prototype.syncMeshWithImpostor=function(h,m){var d=m.physicsBody;h.position.x=d.position.x,h.position.y=d.position.y,h.position.z=d.position.z,h.rotationQuaternion&&(h.rotationQuaternion.x=d.quaternion.x,h.rotationQuaternion.y=d.quaternion.y,h.rotationQuaternion.z=d.quaternion.z,h.rotationQuaternion.w=d.quaternion.w)},f.prototype.getRadius=function(h){var m=h.physicsBody.shapes[0];return m.boundingSphereRadius},f.prototype.getBoxSizeToRef=function(h,m){var d=h.physicsBody.shapes[0];m.x=d.halfExtents.x*2,m.y=d.halfExtents.y*2,m.z=d.halfExtents.z*2},f.prototype.dispose=function(){},f.prototype._extendNamespace=function(){var h=new this.BJSCANNON.Vec3,m=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(d,g,v){if(v=v||10,g=g||0,g===0)this.internalStep(d),this.time+=d;else{var l=Math.floor((this.time+g)/d)-Math.floor(this.time/d);l=Math.min(l,v)||1;for(var y=performance.now(),E=0;E!==l&&(this.internalStep(d),!(performance.now()-y>d*1e3));E++);this.time+=g;for(var R=this.time%d,F=R/d,B=h,L=this.bodies,I=0;I!==L.length;I++){var k=L[I];k.type!==m.Body.STATIC&&k.sleepState!==m.Body.SLEEPING?(k.position.vsub(k.previousPosition,B),B.scale(F,B),k.position.vadd(B,k.interpolatedPosition)):(k.interpolatedPosition.set(k.position.x,k.position.y,k.position.z),k.interpolatedQuaternion.set(k.quaternion.x,k.quaternion.y,k.quaternion.z,k.quaternion.w))}}}},f.prototype.raycast=function(h,m){return this._cannonRaycastResult.reset(),this.world.raycastClosest(h,m,{},this._cannonRaycastResult),this._raycastResult.reset(h,m),this._cannonRaycastResult.hasHit&&(this._raycastResult.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),this._raycastResult.setHitDistance(this._cannonRaycastResult.distance)),this._raycastResult},f}();H.a.DefaultPluginFactory=function(){return new p}},633:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(503),S=u(510),j=u(544),O=u(436),M=u(440),H=u(609),A=function(){function p(f,h,m){f===void 0&&(f=!0),m===void 0&&(m=OIMO),this._useDeltaForWorldStep=f,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=O.e.Zero(),this.BJSOIMO=m,this.world=new this.BJSOIMO.World({iterations:h}),this.world.clear(),this._raycastResult=new H.a}return p.prototype.setGravity=function(f){this.world.gravity.set(f.x,f.y,f.z)},p.prototype.setTimeStep=function(f){this.world.timeStep=f},p.prototype.getTimeStep=function(){return this.world.timeStep},p.prototype.executeStep=function(f,h){var m=this;h.forEach(function(l){l.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?f:this._fixedTimeStep,this.world.step(),h.forEach(function(l){l.afterStep(),m._tmpImpostorsArray[l.uniqueId]=l});for(var d=this.world.contacts;d!==null;){if(d.touching&&!d.body1.sleeping&&!d.body2.sleeping){d=d.next;continue}var g=this._tmpImpostorsArray[+d.body1.name],v=this._tmpImpostorsArray[+d.body2.name];if(!g||!v){d=d.next;continue}g.onCollide({body:v.physicsBody,point:null}),v.onCollide({body:g.physicsBody,point:null}),d=d.next}},p.prototype.applyImpulse=function(f,h,m){var d=f.physicsBody.mass;f.physicsBody.applyImpulse(m.scale(this.world.invScale),h.scale(this.world.invScale*d))},p.prototype.applyForce=function(f,h,m){M.a.Warn("Oimo doesn't support applying force. Using impule instead."),this.applyImpulse(f,h,m)},p.prototype.generatePhysicsBody=function(f){var h=this;if(f.parent){f.physicsBody&&(this.removePhysicsBody(f),f.forceUpdate());return}if(f.isBodyInitRequired()){var m={name:f.uniqueId,config:[f.getParam("mass")||.001,f.getParam("friction"),f.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:f.getParam("mass")!==0,density:f.getParam("mass"),friction:f.getParam("friction"),restitution:f.getParam("restitution"),world:this.world},d=[f],g=function(y){!y.getChildMeshes||y.getChildMeshes().forEach(function(E){E.physicsImpostor&&d.push(E.physicsImpostor)})};g(f.object);var v=function(y){return Math.max(y,j.a.Epsilon)},l=new O.b;d.forEach(function(y){if(!!y.object.rotationQuaternion){var E=y.object.rotationQuaternion;l.copyFrom(E),y.object.rotationQuaternion.set(0,0,0,1),y.object.computeWorldMatrix(!0);var R=l.toEulerAngles(),F=y.getObjectExtendSize(),B=57.29577951308232;if(y===f){var L=f.getObjectCenter();f.object.getAbsolutePivotPoint().subtractToRef(L,h._tmpPositionVector),h._tmpPositionVector.divideInPlace(f.object.scaling),m.pos.push(L.x),m.pos.push(L.y),m.pos.push(L.z),m.posShape.push(0,0,0),m.rotShape.push(0,0,0)}else{var I=y.object.position.clone();m.posShape.push(I.x),m.posShape.push(I.y),m.posShape.push(I.z),m.rotShape.push(R.x*B,R.y*B,R.z*B)}switch(y.object.rotationQuaternion.copyFrom(l),y.type){case T.a.ParticleImpostor:M.a.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case T.a.SphereImpostor:var k=F.x,Z=F.y,Y=F.z,U=Math.max(v(k),v(Z),v(Y))/2;m.type.push("sphere"),m.size.push(U),m.size.push(U),m.size.push(U);break;case T.a.CylinderImpostor:var Q=v(F.x)/2,G=v(F.y);m.type.push("cylinder"),m.size.push(Q),m.size.push(G),m.size.push(G);break;case T.a.PlaneImpostor:case T.a.BoxImpostor:default:var Q=v(F.x),G=v(F.y),K=v(F.z);m.type.push("box"),m.size.push(Q),m.size.push(G),m.size.push(K);break}y.object.rotationQuaternion=E}}),f.physicsBody=this.world.add(m),f.physicsBody.resetQuaternion(l),f.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);f.setDeltaPosition(this._tmpPositionVector)},p.prototype.removePhysicsBody=function(f){this.world.removeRigidBody(f.physicsBody)},p.prototype.generateJoint=function(f){var h=f.mainImpostor.physicsBody,m=f.connectedImpostor.physicsBody;if(!(!h||!m)){var d=f.joint.jointData,g=d.nativeParams||{},v,l={body1:h,body2:m,axe1:g.axe1||(d.mainAxis?d.mainAxis.asArray():null),axe2:g.axe2||(d.connectedAxis?d.connectedAxis.asArray():null),pos1:g.pos1||(d.mainPivot?d.mainPivot.asArray():null),pos2:g.pos2||(d.connectedPivot?d.connectedPivot.asArray():null),min:g.min,max:g.max,collision:g.collision||d.collision,spring:g.spring,world:this.world};switch(f.joint.type){case S.e.BallAndSocketJoint:v="jointBall";break;case S.e.SpringJoint:M.a.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");var y=d;l.min=y.length||l.min,l.max=Math.max(l.min,l.max);case S.e.DistanceJoint:v="jointDistance",l.max=d.maxDistance;break;case S.e.PrismaticJoint:v="jointPrisme";break;case S.e.SliderJoint:v="jointSlide";break;case S.e.WheelJoint:v="jointWheel";break;case S.e.HingeJoint:default:v="jointHinge";break}l.type=v,f.joint.physicsJoint=this.world.add(l)}},p.prototype.removeJoint=function(f){try{this.world.removeJoint(f.joint.physicsJoint)}catch(h){M.a.Warn(h)}},p.prototype.isSupported=function(){return this.BJSOIMO!==void 0},p.prototype.setTransformationFromPhysicsBody=function(f){if(!f.physicsBody.sleeping){if(f.physicsBody.shapes.next){for(var h=f.physicsBody.shapes;h.next;)h=h.next;f.object.position.set(h.position.x,h.position.y,h.position.z)}else{var m=f.physicsBody.getPosition();f.object.position.set(m.x,m.y,m.z)}if(f.object.rotationQuaternion){var d=f.physicsBody.getQuaternion();f.object.rotationQuaternion.set(d.x,d.y,d.z,d.w)}}},p.prototype.setPhysicsBodyTransformation=function(f,h,m){var d=f.physicsBody;f.physicsBody.shapes.next||(d.position.set(h.x,h.y,h.z),d.orientation.set(m.x,m.y,m.z,m.w),d.syncShapes(),d.awake())},p.prototype.setLinearVelocity=function(f,h){f.physicsBody.linearVelocity.set(h.x,h.y,h.z)},p.prototype.setAngularVelocity=function(f,h){f.physicsBody.angularVelocity.set(h.x,h.y,h.z)},p.prototype.getLinearVelocity=function(f){var h=f.physicsBody.linearVelocity;return h?new O.e(h.x,h.y,h.z):null},p.prototype.getAngularVelocity=function(f){var h=f.physicsBody.angularVelocity;return h?new O.e(h.x,h.y,h.z):null},p.prototype.setBodyMass=function(f,h){var m=h===0;f.physicsBody.shapes.density=m?1:h,f.physicsBody.setupMass(m?2:1)},p.prototype.getBodyMass=function(f){return f.physicsBody.shapes.density},p.prototype.getBodyFriction=function(f){return f.physicsBody.shapes.friction},p.prototype.setBodyFriction=function(f,h){f.physicsBody.shapes.friction=h},p.prototype.getBodyRestitution=function(f){return f.physicsBody.shapes.restitution},p.prototype.setBodyRestitution=function(f,h){f.physicsBody.shapes.restitution=h},p.prototype.sleepBody=function(f){f.physicsBody.sleep()},p.prototype.wakeUpBody=function(f){f.physicsBody.awake()},p.prototype.updateDistanceJoint=function(f,h,m){f.physicsJoint.limitMotor.upperLimit=h,m!==void 0&&(f.physicsJoint.limitMotor.lowerLimit=m)},p.prototype.setMotor=function(f,h,m,d){m!==void 0?M.a.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):m=1e6,h*=-1;var g=d?f.physicsJoint.rotationalLimitMotor2:f.physicsJoint.rotationalLimitMotor1||f.physicsJoint.rotationalLimitMotor||f.physicsJoint.limitMotor;g&&g.setMotor(h,m)},p.prototype.setLimit=function(f,h,m,d){var g=d?f.physicsJoint.rotationalLimitMotor2:f.physicsJoint.rotationalLimitMotor1||f.physicsJoint.rotationalLimitMotor||f.physicsJoint.limitMotor;g&&g.setLimit(h,m===void 0?-h:m)},p.prototype.syncMeshWithImpostor=function(f,h){var m=h.physicsBody;f.position.x=m.position.x,f.position.y=m.position.y,f.position.z=m.position.z,f.rotationQuaternion&&(f.rotationQuaternion.x=m.orientation.x,f.rotationQuaternion.y=m.orientation.y,f.rotationQuaternion.z=m.orientation.z,f.rotationQuaternion.w=m.orientation.s)},p.prototype.getRadius=function(f){return f.physicsBody.shapes.radius},p.prototype.getBoxSizeToRef=function(f,h){var m=f.physicsBody.shapes;h.x=m.halfWidth*2,h.y=m.halfHeight*2,h.z=m.halfDepth*2},p.prototype.dispose=function(){this.world.clear()},p.prototype.raycast=function(f,h){return M.a.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(f,h),this._raycastResult},p}()},634:function(Ue,P,u){"use strict";u.d(P,"a",function(){return d});var T=u(436),S=u(440),j=u(503),O=u(510),M=u(447),H=u(485),A=u(617),p=u(493),f=u(609),h=u(450),m=u(515),d=function(){function g(v,l,y){var E=this;if(v===void 0&&(v=!0),l===void 0&&(l=Ammo),y===void 0&&(y=null),this._useDeltaForWorldStep=v,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new T.b,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new T.e,this._tmpMatrix=new T.a,typeof l=="function"){S.a.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=l;if(!this.isSupported()){S.a.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=y||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=function(R,F,B,L){R=E.bjsAMMO.wrapPointer(R,Ammo.btManifoldPoint);var I=R.getPositionWorldOnA();E._tmpContactPoint.x=I.x(),E._tmpContactPoint.y=I.y(),E._tmpContactPoint.z=I.z(),E._tmpContactCallbackResult=!0},this._raycastResult=new f.a,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}return g.prototype.setGravity=function(v){this._tmpAmmoVectorA.setValue(v.x,v.y,v.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)},g.prototype.setTimeStep=function(v){this._timeStep=v},g.prototype.setFixedTimeStep=function(v){this._fixedTimeStep=v},g.prototype.setMaxSteps=function(v){this._maxSteps=v},g.prototype.getTimeStep=function(){return this._timeStep},g.prototype._isImpostorInContact=function(v){return this._tmpContactCallbackResult=!1,this.world.contactTest(v.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},g.prototype._isImpostorPairInContact=function(v,l){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(v.physicsBody,l.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},g.prototype._stepSimulation=function(v,l,y){if(v===void 0&&(v=1/60),l===void 0&&(l=10),y===void 0&&(y=1/60),l==0)this.world.stepSimulation(v,0);else for(;l>0&&v>0;)v-y<y?(this.world.stepSimulation(v,0),v=0):(v-=y,this.world.stepSimulation(y,0)),l--},g.prototype.executeStep=function(v,l){for(var y=0,E=l;y<E.length;y++){var R=E[y];R.soft||R.beforeStep()}this._stepSimulation(this._useDeltaForWorldStep?v:this._timeStep,this._maxSteps,this._fixedTimeStep);for(var F=0,B=l;F<B.length;F++){var L=B[F];if(L.soft?this._afterSoftStep(L):L.afterStep(),L._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(L))for(var I=0,k=L._onPhysicsCollideCallbacks;I<k.length;I++)for(var Z=k[I],Y=0,U=Z.otherImpostors;Y<U.length;Y++){var Q=U[Y];(L.physicsBody.isActive()||Q.physicsBody.isActive())&&this._isImpostorPairInContact(L,Q)&&(L.onCollide({body:Q.physicsBody,point:this._tmpContactPoint}),Q.onCollide({body:L.physicsBody,point:this._tmpContactPoint}))}}},g.prototype._afterSoftStep=function(v){v.type===j.a.RopeImpostor?this._ropeStep(v):this._softbodyOrClothStep(v)},g.prototype._ropeStep=function(v){for(var l=v.physicsBody.get_m_nodes(),y=l.size(),E,R,F,B,L,I=new Array,k=0;k<y;k++)E=l.at(k),R=E.get_m_x(),F=R.x(),B=R.y(),L=R.z(),I.push(new T.e(F,B,L));var Z=v.object,Y=v.getParam("shape");v._isFromLine?v.object=p.a.CreateLines("lines",{points:I,instance:Z}):v.object=A.a.ExtrudeShape("ext",{shape:Y,path:I,instance:Z})},g.prototype._softbodyOrClothStep=function(v){var l=v.type===j.a.ClothImpostor?1:-1,y=v.object,E=y.getVerticesData(M.b.PositionKind);E||(E=[]);var R=y.getVerticesData(M.b.NormalKind);R||(R=[]);for(var F=E.length/3,B=v.physicsBody.get_m_nodes(),L,I,k,Z,Y,U,Q,G,K,fe=0;fe<F;fe++){L=B.at(fe),I=L.get_m_x(),Z=I.x(),Y=I.y(),U=I.z()*l;var k=L.get_m_n();Q=k.x(),G=k.y(),K=k.z()*l,E[3*fe]=Z,E[3*fe+1]=Y,E[3*fe+2]=U,R[3*fe]=Q,R[3*fe+1]=G,R[3*fe+2]=K}var ce=new H.a;ce.positions=E,ce.normals=R,ce.uvs=y.getVerticesData(M.b.UVKind),ce.colors=y.getVerticesData(M.b.ColorKind),y&&y.getIndices&&(ce.indices=y.getIndices()),ce.applyToMesh(y)},g.prototype.applyImpulse=function(v,l,y){if(v.soft)S.a.Warn("Cannot be applied to a soft body");else{v.physicsBody.activate();var E=this._tmpAmmoVectorA,R=this._tmpAmmoVectorB;v.object&&v.object.getWorldMatrix&&y.subtractInPlace(v.object.getWorldMatrix().getTranslation()),E.setValue(y.x,y.y,y.z),R.setValue(l.x,l.y,l.z),v.physicsBody.applyImpulse(R,E)}},g.prototype.applyForce=function(v,l,y){if(v.soft)S.a.Warn("Cannot be applied to a soft body");else{v.physicsBody.activate();var E=this._tmpAmmoVectorA,R=this._tmpAmmoVectorB;if(E.setValue(y.x,y.y,y.z),v.object&&v.object.getWorldMatrix){var F=v.object.getWorldMatrix().getTranslation();E.x-=F.x,E.y-=F.y,E.z-=F.z}R.setValue(l.x,l.y,l.z),v.physicsBody.applyForce(R,E)}},g.prototype.generatePhysicsBody=function(v){if(v._pluginData.toDispose=[],v.parent){v.physicsBody&&(this.removePhysicsBody(v),v.forceUpdate());return}if(v.isBodyInitRequired()){var l=this._createShape(v),y=v.getParam("mass");if(v._pluginData.mass=y,v.soft)l.get_m_cfg().set_collisions(17),l.get_m_cfg().set_kDP(v.getParam("damping")),this.bjsAMMO.castObject(l,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(v.getParam("margin")),l.setActivationState(g.DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(l,1,-1),v.physicsBody=l,v._pluginData.toDispose.push(l),this.setBodyPressure(v,0),v.type===j.a.SoftbodyImpostor&&this.setBodyPressure(v,v.getParam("pressure")),this.setBodyStiffness(v,v.getParam("stiffness")),this.setBodyVelocityIterations(v,v.getParam("velocityIterations")),this.setBodyPositionIterations(v,v.getParam("positionIterations"));else{var E=new this.bjsAMMO.btVector3(0,0,0),R=new this.bjsAMMO.btTransform;R.setIdentity(),y!==0&&l.calculateLocalInertia(y,E),this._tmpAmmoVectorA.setValue(v.object.position.x,v.object.position.y,v.object.position.z),this._tmpAmmoQuaternion.setValue(v.object.rotationQuaternion.x,v.object.rotationQuaternion.y,v.object.rotationQuaternion.z,v.object.rotationQuaternion.w),R.setOrigin(this._tmpAmmoVectorA),R.setRotation(this._tmpAmmoQuaternion);var F=new this.bjsAMMO.btDefaultMotionState(R),B=new this.bjsAMMO.btRigidBodyConstructionInfo(y,F,l,E),L=new this.bjsAMMO.btRigidBody(B);y===0&&(L.setCollisionFlags(L.getCollisionFlags()|g.KINEMATIC_FLAG),L.setActivationState(g.DISABLE_DEACTIVATION_FLAG)),v.type==j.a.NoImpostor&&!l.getChildShape&&L.setCollisionFlags(L.getCollisionFlags()|g.DISABLE_COLLISION_FLAG);var I=v.getParam("group"),k=v.getParam("mask");I&&k?this.world.addRigidBody(L,I,k):this.world.addRigidBody(L),v.physicsBody=L,v._pluginData.toDispose=v._pluginData.toDispose.concat([L,B,F,R,E,l])}this.setBodyRestitution(v,v.getParam("restitution")),this.setBodyFriction(v,v.getParam("friction"))}},g.prototype.removePhysicsBody=function(v){var l=this;this.world&&(v.soft?this.world.removeSoftBody(v.physicsBody):this.world.removeRigidBody(v.physicsBody),v._pluginData&&(v._pluginData.toDispose.forEach(function(y){l.bjsAMMO.destroy(y)}),v._pluginData.toDispose=[]))},g.prototype.generateJoint=function(v){var l=v.mainImpostor.physicsBody,y=v.connectedImpostor.physicsBody;if(!(!l||!y)){var E=v.joint.jointData;E.mainPivot||(E.mainPivot=new T.e(0,0,0)),E.connectedPivot||(E.connectedPivot=new T.e(0,0,0));var R;switch(v.joint.type){case O.e.DistanceJoint:var F=E.maxDistance;F&&(E.mainPivot=new T.e(0,-F/2,0),E.connectedPivot=new T.e(0,F/2,0)),R=new this.bjsAMMO.btPoint2PointConstraint(l,y,new this.bjsAMMO.btVector3(E.mainPivot.x,E.mainPivot.y,E.mainPivot.z),new this.bjsAMMO.btVector3(E.connectedPivot.x,E.connectedPivot.y,E.connectedPivot.z));break;case O.e.HingeJoint:E.mainAxis||(E.mainAxis=new T.e(0,0,0)),E.connectedAxis||(E.connectedAxis=new T.e(0,0,0));var B=new this.bjsAMMO.btVector3(E.mainAxis.x,E.mainAxis.y,E.mainAxis.z),L=new this.bjsAMMO.btVector3(E.connectedAxis.x,E.connectedAxis.y,E.connectedAxis.z);R=new this.bjsAMMO.btHingeConstraint(l,y,new this.bjsAMMO.btVector3(E.mainPivot.x,E.mainPivot.y,E.mainPivot.z),new this.bjsAMMO.btVector3(E.connectedPivot.x,E.connectedPivot.y,E.connectedPivot.z),B,L);break;case O.e.BallAndSocketJoint:R=new this.bjsAMMO.btPoint2PointConstraint(l,y,new this.bjsAMMO.btVector3(E.mainPivot.x,E.mainPivot.y,E.mainPivot.z),new this.bjsAMMO.btVector3(E.connectedPivot.x,E.connectedPivot.y,E.connectedPivot.z));break;default:S.a.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),R=new this.bjsAMMO.btPoint2PointConstraint(l,y,new this.bjsAMMO.btVector3(E.mainPivot.x,E.mainPivot.y,E.mainPivot.z),new this.bjsAMMO.btVector3(E.connectedPivot.x,E.connectedPivot.y,E.connectedPivot.z));break}this.world.addConstraint(R,!v.joint.jointData.collision),v.joint.physicsJoint=R}},g.prototype.removeJoint=function(v){this.world&&this.world.removeConstraint(v.joint.physicsJoint)},g.prototype._addMeshVerts=function(v,l,y){var E=this,R=0;if(y&&y.getIndices&&y.getWorldMatrix&&y.getChildMeshes){var F=y.getIndices();F||(F=[]);var B=y.getVerticesData(M.b.PositionKind);B||(B=[]),y.computeWorldMatrix(!1);for(var L=F.length/3,I=0;I<L;I++){for(var k=[],Z=0;Z<3;Z++){var Y=new T.e(B[F[I*3+Z]*3+0],B[F[I*3+Z]*3+1],B[F[I*3+Z]*3+2]);T.a.ScalingToRef(y.scaling.x,y.scaling.y,y.scaling.z,this._tmpMatrix),Y=T.e.TransformCoordinates(Y,this._tmpMatrix);var U;Z==0?U=this._tmpAmmoVectorA:Z==1?U=this._tmpAmmoVectorB:U=this._tmpAmmoVectorC,U.setValue(Y.x,Y.y,Y.z),k.push(U)}v.addTriangle(k[0],k[1],k[2]),R++}y.getChildMeshes().forEach(function(Q){R+=E._addMeshVerts(v,l,Q)})}return R},g.prototype._softVertexData=function(v){var l=v.object;if(l&&l.getIndices&&l.getWorldMatrix&&l.getChildMeshes){var y=l.getIndices();y||(y=[]);var E=l.getVerticesData(M.b.PositionKind);E||(E=[]);var R=l.getVerticesData(M.b.NormalKind);R||(R=[]),l.computeWorldMatrix(!1);for(var F=[],B=[],L=0;L<E.length;L+=3){var I=new T.e(E[L],E[L+1],E[L+2]),k=new T.e(R[L],R[L+1],R[L+2]);I=T.e.TransformCoordinates(I,l.getWorldMatrix()),k=T.e.TransformNormal(k,l.getWorldMatrix()),F.push(I.x,I.y,I.z),B.push(k.x,k.y,k.z)}var Z=new H.a;return Z.positions=F,Z.normals=B,Z.uvs=l.getVerticesData(M.b.UVKind),Z.colors=l.getVerticesData(M.b.ColorKind),l&&l.getIndices&&(Z.indices=l.getIndices()),Z.applyToMesh(l),l.position=T.e.Zero(),l.rotationQuaternion=null,l.rotation=T.e.Zero(),l.computeWorldMatrix(!0),Z}return H.a.ExtractFromMesh(l)},g.prototype._createSoftbody=function(v){var l=v.object;if(l&&l.getIndices){var y=l.getIndices();y||(y=[]);var E=this._softVertexData(v),R=E.positions,F=E.normals;if(R===null||F===null)return new this.bjsAMMO.btCompoundShape;for(var B=[],L=[],I=0;I<R.length;I+=3){var k=new T.e(R[I],R[I+1],R[I+2]),Z=new T.e(F[I],F[I+1],F[I+2]);B.push(k.x,k.y,-k.z),L.push(Z.x,Z.y,-Z.z)}for(var Y=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),B,l.getIndices(),y.length/3,!0),U=R.length/3,Q=Y.get_m_nodes(),G,K,I=0;I<U;I++){G=Q.at(I);var K=G.get_m_n();K.setX(L[3*I]),K.setY(L[3*I+1]),K.setZ(L[3*I+2])}return Y}},g.prototype._createCloth=function(v){var l=v.object;if(l&&l.getIndices){var y=l.getIndices();y||(y=[]);var E=this._softVertexData(v),R=E.positions,F=E.normals;if(R===null||F===null)return new this.bjsAMMO.btCompoundShape;var B=R.length,L=Math.sqrt(B/3);v.segments=L;var I=L-1;this._tmpAmmoVectorA.setValue(R[0],R[1],R[2]),this._tmpAmmoVectorB.setValue(R[3*I],R[3*I+1],R[3*I+2]),this._tmpAmmoVectorD.setValue(R[B-3],R[B-2],R[B-1]),this._tmpAmmoVectorC.setValue(R[B-3-3*I],R[B-2-3*I],R[B-1-3*I]);var k=new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,L,L,v.getParam("fixedPoints"),!0);return k}},g.prototype._createRope=function(v){var l,y,E=this._softVertexData(v),R=E.positions,F=E.normals;if(R===null||F===null)return new this.bjsAMMO.btCompoundShape;E.applyToMesh(v.object,!0),v._isFromLine=!0;var B=F.map(function(Q){return Q*Q}),L=function(Q,G){return Q+G},I=B.reduce(L);if(I===0)l=R.length,y=l/3-1,this._tmpAmmoVectorA.setValue(R[0],R[1],R[2]),this._tmpAmmoVectorB.setValue(R[l-3],R[l-2],R[l-1]);else{v._isFromLine=!1;var k=v.getParam("path"),Z=v.getParam("shape");if(Z===null)return S.a.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;l=k.length,y=l-1,this._tmpAmmoVectorA.setValue(k[0].x,k[0].y,k[0].z),this._tmpAmmoVectorB.setValue(k[l-1].x,k[l-1].y,k[l-1].z)}v.segments=y;var Y=v.getParam("fixedPoints");Y=Y>3?3:Y;var U=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,y-1,Y);return U.get_m_cfg().set_collisions(17),U},g.prototype._createCustom=function(v){var l=null;return this.onCreateCustomShape&&(l=this.onCreateCustomShape(v)),l==null&&(l=new this.bjsAMMO.btCompoundShape),l},g.prototype._addHullVerts=function(v,l,y){var E=this,R=0;if(y&&y.getIndices&&y.getWorldMatrix&&y.getChildMeshes){var F=y.getIndices();F||(F=[]);var B=y.getVerticesData(M.b.PositionKind);B||(B=[]),y.computeWorldMatrix(!1);for(var L=F.length/3,I=0;I<L;I++){for(var k=[],Z=0;Z<3;Z++){var Y=new T.e(B[F[I*3+Z]*3+0],B[F[I*3+Z]*3+1],B[F[I*3+Z]*3+2]);T.a.ScalingToRef(y.scaling.x,y.scaling.y,y.scaling.z,this._tmpMatrix),Y=T.e.TransformCoordinates(Y,this._tmpMatrix);var U;Z==0?U=this._tmpAmmoVectorA:Z==1?U=this._tmpAmmoVectorB:U=this._tmpAmmoVectorC,U.setValue(Y.x,Y.y,Y.z),k.push(U)}v.addPoint(k[0],!0),v.addPoint(k[1],!0),v.addPoint(k[2],!0),R++}y.getChildMeshes().forEach(function(Q){R+=E._addHullVerts(v,l,Q)})}return R},g.prototype._createShape=function(v,l){var y=this;l===void 0&&(l=!1);var E=v.object,R,F=v.getObjectExtendSize();if(!l){var B=v.object.getChildMeshes?v.object.getChildMeshes(!0):[];R=new this.bjsAMMO.btCompoundShape;var L=0;if(B.forEach(function(K){var fe=K.getPhysicsImpostor();if(fe){if(fe.type==j.a.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";var ce=y._createShape(fe),re=K.parent.getWorldMatrix().clone(),Re=new T.e;re.decompose(Re),y._tmpAmmoTransform.getOrigin().setValue(K.position.x*Re.x,K.position.y*Re.y,K.position.z*Re.z),y._tmpAmmoQuaternion.setValue(K.rotationQuaternion.x,K.rotationQuaternion.y,K.rotationQuaternion.z,K.rotationQuaternion.w),y._tmpAmmoTransform.setRotation(y._tmpAmmoQuaternion),R.addChildShape(y._tmpAmmoTransform,ce),fe.dispose(),L++}}),L>0){if(v.type!=j.a.NoImpostor){var I=this._createShape(v,!0);I&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),R.addChildShape(this._tmpAmmoTransform,I))}return R}else this.bjsAMMO.destroy(R),R=null}switch(v.type){case j.a.SphereImpostor:if(h.a.WithinEpsilon(F.x,F.y,1e-4)&&h.a.WithinEpsilon(F.x,F.z,1e-4))R=new this.bjsAMMO.btSphereShape(F.x/2);else{var k=[new this.bjsAMMO.btVector3(0,0,0)],Z=[1];R=new this.bjsAMMO.btMultiSphereShape(k,Z,1),R.setLocalScaling(new this.bjsAMMO.btVector3(F.x/2,F.y/2,F.z/2))}break;case j.a.CapsuleImpostor:var Y=F.x/2;R=new this.bjsAMMO.btCapsuleShape(Y,F.y-Y*2);break;case j.a.CylinderImpostor:this._tmpAmmoVectorA.setValue(F.x/2,F.y/2,F.z/2),R=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case j.a.PlaneImpostor:case j.a.BoxImpostor:this._tmpAmmoVectorA.setValue(F.x/2,F.y/2,F.z/2),R=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case j.a.MeshImpostor:if(v.getParam("mass")==0){var U=new this.bjsAMMO.btTriangleMesh;v._pluginData.toDispose.push(U);var G=this._addMeshVerts(U,E,E);G==0?R=new this.bjsAMMO.btCompoundShape:R=new this.bjsAMMO.btBvhTriangleMeshShape(U);break}case j.a.ConvexHullImpostor:var Q=new this.bjsAMMO.btConvexHullShape,G=this._addHullVerts(Q,E,E);G==0?(v._pluginData.toDispose.push(Q),R=new this.bjsAMMO.btCompoundShape):R=Q;break;case j.a.NoImpostor:R=new this.bjsAMMO.btSphereShape(F.x/2);break;case j.a.CustomImpostor:R=this._createCustom(v);break;case j.a.SoftbodyImpostor:R=this._createSoftbody(v);break;case j.a.ClothImpostor:R=this._createCloth(v);break;case j.a.RopeImpostor:R=this._createRope(v);break;default:S.a.Warn("The impostor type is not currently supported by the ammo plugin.");break}return R},g.prototype.setTransformationFromPhysicsBody=function(v){v.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),v.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),v.object.rotationQuaternion?v.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):v.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(v.object.rotation))},g.prototype.setPhysicsBodyTransformation=function(v,l,y){var E=v.physicsBody.getWorldTransform();if(Math.abs(E.getOrigin().x()-l.x)>m.a||Math.abs(E.getOrigin().y()-l.y)>m.a||Math.abs(E.getOrigin().z()-l.z)>m.a||Math.abs(E.getRotation().x()-y.x)>m.a||Math.abs(E.getRotation().y()-y.y)>m.a||Math.abs(E.getRotation().z()-y.z)>m.a||Math.abs(E.getRotation().w()-y.w)>m.a)if(this._tmpAmmoVectorA.setValue(l.x,l.y,l.z),E.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(y.x,y.y,y.z,y.w),E.setRotation(this._tmpAmmoQuaternion),v.physicsBody.setWorldTransform(E),v.mass==0){var R=v.physicsBody.getMotionState();R&&R.setWorldTransform(E)}else v.physicsBody.activate()},g.prototype.isSupported=function(){return this.bjsAMMO!==void 0},g.prototype.setLinearVelocity=function(v,l){this._tmpAmmoVectorA.setValue(l.x,l.y,l.z),v.soft?v.physicsBody.linearVelocity(this._tmpAmmoVectorA):v.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)},g.prototype.setAngularVelocity=function(v,l){this._tmpAmmoVectorA.setValue(l.x,l.y,l.z),v.soft?v.physicsBody.angularVelocity(this._tmpAmmoVectorA):v.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)},g.prototype.getLinearVelocity=function(v){if(v.soft)var l=v.physicsBody.linearVelocity();else var l=v.physicsBody.getLinearVelocity();if(!l)return null;var y=new T.e(l.x(),l.y(),l.z());return this.bjsAMMO.destroy(l),y},g.prototype.getAngularVelocity=function(v){if(v.soft)var l=v.physicsBody.angularVelocity();else var l=v.physicsBody.getAngularVelocity();if(!l)return null;var y=new T.e(l.x(),l.y(),l.z());return this.bjsAMMO.destroy(l),y},g.prototype.setBodyMass=function(v,l){v.soft?v.physicsBody.setTotalMass(l,!1):v.physicsBody.setMassProps(l),v._pluginData.mass=l},g.prototype.getBodyMass=function(v){return v._pluginData.mass||0},g.prototype.getBodyFriction=function(v){return v._pluginData.friction||0},g.prototype.setBodyFriction=function(v,l){v.soft?v.physicsBody.get_m_cfg().set_kDF(l):v.physicsBody.setFriction(l),v._pluginData.friction=l},g.prototype.getBodyRestitution=function(v){return v._pluginData.restitution||0},g.prototype.setBodyRestitution=function(v,l){v.physicsBody.setRestitution(l),v._pluginData.restitution=l},g.prototype.getBodyPressure=function(v){return v.soft?v._pluginData.pressure||0:(S.a.Warn("Pressure is not a property of a rigid body"),0)},g.prototype.setBodyPressure=function(v,l){v.soft?v.type===j.a.SoftbodyImpostor?(v.physicsBody.get_m_cfg().set_kPR(l),v._pluginData.pressure=l):(v.physicsBody.get_m_cfg().set_kPR(0),v._pluginData.pressure=0):S.a.Warn("Pressure can only be applied to a softbody")},g.prototype.getBodyStiffness=function(v){return v.soft?v._pluginData.stiffness||0:(S.a.Warn("Stiffness is not a property of a rigid body"),0)},g.prototype.setBodyStiffness=function(v,l){v.soft?(l=l<0?0:l,l=l>1?1:l,v.physicsBody.get_m_materials().at(0).set_m_kLST(l),v._pluginData.stiffness=l):S.a.Warn("Stiffness cannot be applied to a rigid body")},g.prototype.getBodyVelocityIterations=function(v){return v.soft?v._pluginData.velocityIterations||0:(S.a.Warn("Velocity iterations is not a property of a rigid body"),0)},g.prototype.setBodyVelocityIterations=function(v,l){v.soft?(l=l<0?0:l,v.physicsBody.get_m_cfg().set_viterations(l),v._pluginData.velocityIterations=l):S.a.Warn("Velocity iterations cannot be applied to a rigid body")},g.prototype.getBodyPositionIterations=function(v){return v.soft?v._pluginData.positionIterations||0:(S.a.Warn("Position iterations is not a property of a rigid body"),0)},g.prototype.setBodyPositionIterations=function(v,l){v.soft?(l=l<0?0:l,v.physicsBody.get_m_cfg().set_piterations(l),v._pluginData.positionIterations=l):S.a.Warn("Position iterations cannot be applied to a rigid body")},g.prototype.appendAnchor=function(v,l,y,E,R,F){R===void 0&&(R=1),F===void 0&&(F=!1);var B=v.segments,L=Math.round((B-1)*y),I=Math.round((B-1)*E),k=B-1-I,Z=L+B*k;v.physicsBody.appendAnchor(Z,l.physicsBody,F,R)},g.prototype.appendHook=function(v,l,y,E,R){E===void 0&&(E=1),R===void 0&&(R=!1);var F=Math.round(v.segments*y);v.physicsBody.appendAnchor(F,l.physicsBody,R,E)},g.prototype.sleepBody=function(v){S.a.Warn("sleepBody is not currently supported by the Ammo physics plugin")},g.prototype.wakeUpBody=function(v){v.physicsBody.activate()},g.prototype.updateDistanceJoint=function(v,l,y){S.a.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")},g.prototype.setMotor=function(v,l,y,E){v.physicsJoint.enableAngularMotor(!0,l,y)},g.prototype.setLimit=function(v,l,y){S.a.Warn("setLimit is not currently supported by the Ammo physics plugin")},g.prototype.syncMeshWithImpostor=function(v,l){var y=l.physicsBody;y.getMotionState().getWorldTransform(this._tmpAmmoTransform),v.position.x=this._tmpAmmoTransform.getOrigin().x(),v.position.y=this._tmpAmmoTransform.getOrigin().y(),v.position.z=this._tmpAmmoTransform.getOrigin().z(),v.rotationQuaternion&&(v.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),v.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),v.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),v.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())},g.prototype.getRadius=function(v){var l=v.getObjectExtendSize();return l.x/2},g.prototype.getBoxSizeToRef=function(v,l){var y=v.getObjectExtendSize();l.x=y.x,l.y=y.y,l.z=y.z},g.prototype.dispose=function(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null},g.prototype.raycast=function(v,l){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(v.x,v.y,v.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(l.x,l.y,l.z);var y=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);return this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,y),this._raycastResult.reset(v,l),y.hasHit()&&(this._raycastResult.setHitData({x:y.get_m_hitNormalWorld().x(),y:y.get_m_hitNormalWorld().y(),z:y.get_m_hitNormalWorld().z()},{x:y.get_m_hitPointWorld().x(),y:y.get_m_hitPointWorld().y(),z:y.get_m_hitPointWorld().z()}),this._raycastResult.calculateHitDistance()),this.bjsAMMO.destroy(y),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB),this._raycastResult},g.DISABLE_COLLISION_FLAG=4,g.KINEMATIC_FLAG=2,g.DISABLE_DEACTIVATION_FLAG=4,g}()},635:function(Ue,P,u){"use strict";u.d(P,"a",function(){return H});var T=u(434),S=u(439),j=u(458),O=u(436),M=u(468);M.a.prototype.removeReflectionProbe=function(A){if(!this.reflectionProbes)return-1;var p=this.reflectionProbes.indexOf(A);return p!==-1&&this.reflectionProbes.splice(p,1),p},M.a.prototype.addReflectionProbe=function(A){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(A)};var H=function(){function A(p,f,h,m,d,g){var v=this;m===void 0&&(m=!0),d===void 0&&(d=!1),g===void 0&&(g=!1),this.name=p,this._viewMatrix=O.a.Identity(),this._target=O.e.Zero(),this._add=O.e.Zero(),this._invertYAxis=!1,this.position=O.e.Zero(),this._scene=h,this._scene.reflectionProbes||(this._scene.reflectionProbes=new Array),this._scene.reflectionProbes.push(this);var l=0;if(d){var y=this._scene.getEngine().getCaps();y.textureHalfFloatRender?l=2:y.textureFloatRender&&(l=1)}this._renderTargetTexture=new j.a(p,f,h,m,!0,l,!0),this._renderTargetTexture.gammaSpace=!g,this._renderTargetTexture.onBeforeRenderObservable.add(function(R){switch(R){case 0:v._add.copyFromFloats(1,0,0);break;case 1:v._add.copyFromFloats(-1,0,0);break;case 2:v._add.copyFromFloats(0,v._invertYAxis?1:-1,0);break;case 3:v._add.copyFromFloats(0,v._invertYAxis?-1:1,0);break;case 4:v._add.copyFromFloats(0,0,h.useRightHandedSystem?-1:1);break;case 5:v._add.copyFromFloats(0,0,h.useRightHandedSystem?1:-1);break}v._attachedMesh&&v.position.copyFrom(v._attachedMesh.getAbsolutePosition()),v.position.addToRef(v._add,v._target),h.useRightHandedSystem?(O.a.LookAtRHToRef(v.position,v._target,O.e.Up(),v._viewMatrix),h.activeCamera&&(v._projectionMatrix=O.a.PerspectiveFovRH(Math.PI/2,1,h.activeCamera.minZ,h.activeCamera.maxZ),h.setTransformMatrix(v._viewMatrix,v._projectionMatrix))):(O.a.LookAtLHToRef(v.position,v._target,O.e.Up(),v._viewMatrix),h.activeCamera&&(v._projectionMatrix=O.a.PerspectiveFovLH(Math.PI/2,1,h.activeCamera.minZ,h.activeCamera.maxZ),h.setTransformMatrix(v._viewMatrix,v._projectionMatrix))),h._forcedViewPosition=v.position});var E;this._renderTargetTexture.onBeforeBindObservable.add(function(){h.getEngine()._debugPushGroup("reflection probe generation for "+p,1),E=v._scene.imageProcessingConfiguration.applyByPostProcess,g&&(h.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(function(){h.imageProcessingConfiguration.applyByPostProcess=E,h._forcedViewPosition=null,h.updateTransformMatrix(!0),h.getEngine()._debugPopGroup(1)})}return Object.defineProperty(A.prototype,"samples",{get:function(){return this._renderTargetTexture.samples},set:function(p){this._renderTargetTexture.samples=p},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"refreshRate",{get:function(){return this._renderTargetTexture.refreshRate},set:function(p){this._renderTargetTexture.refreshRate=p},enumerable:!1,configurable:!0}),A.prototype.getScene=function(){return this._scene},Object.defineProperty(A.prototype,"cubeTexture",{get:function(){return this._renderTargetTexture},enumerable:!1,configurable:!0}),Object.defineProperty(A.prototype,"renderList",{get:function(){return this._renderTargetTexture.renderList},enumerable:!1,configurable:!0}),A.prototype.attachToMesh=function(p){this._attachedMesh=p},A.prototype.setRenderingAutoClearDepthStencil=function(p,f){this._renderTargetTexture.setRenderingAutoClearDepthStencil(p,f)},A.prototype.dispose=function(){var p=this._scene.reflectionProbes.indexOf(this);p!==-1&&this._scene.reflectionProbes.splice(p,1),this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null)},A.prototype.toString=function(p){var f="Name: "+this.name;return p&&(f+=", position: "+this.position.toString(),this._attachedMesh&&(f+=", attached mesh: "+this._attachedMesh.name)),f},A.prototype.getClassName=function(){return"ReflectionProbe"},A.prototype.serialize=function(){var p=S.a.Serialize(this,this._renderTargetTexture.serialize());return p.isReflectionProbe=!0,p},A.Parse=function(p,f,h){var m=null;if(f.reflectionProbes)for(var d=0;d<f.reflectionProbes.length;d++){var g=f.reflectionProbes[d];if(g.name===p.name){m=g;break}}return m=S.a.Parse(function(){return m||new A(p.name,p.renderTargetSize,f,p._generateMipMaps)},p,f,h),m.cubeTexture._waitingRenderList=p.renderList,p._attachedMesh&&m.attachToMesh(f.getMeshByID(p._attachedMesh)),m},Object(T.c)([Object(S.k)()],A.prototype,"_attachedMesh",void 0),Object(T.c)([Object(S.o)()],A.prototype,"position",void 0),A}()},637:function(Ue,P,u){"use strict";u.d(P,"a",function(){return y});var T=u(475),S=u(450),j=u(630),O=u(435),M="hdrFilteringVertexShader",H=`
attribute vec2 position;

varying vec3 direction;

uniform vec3 up;
uniform vec3 right;
uniform vec3 front;
void main(void) {
mat3 view=mat3(up,right,front);
direction=view*vec3(position,1.0);
gl_Position=vec4(position,0.0,1.0);
}`;O.a.ShadersStore[M]=H;var A={name:M,shader:H},p=u(457),f=u(605),h=u(606),m=u(607),d="hdrFilteringPixelShader",g=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;
uniform samplerCube inputTexture;
uniform vec2 vFilteringInfo;
uniform float hdrScale;
varying vec3 direction;
void main() {
vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);
gl_FragColor=vec4(color*hdrScale,1.0);
}`;O.a.ShadersStore[d]=g;var v={name:d,shader:g},l=u(440),y=function(){function E(R,F){F===void 0&&(F={}),this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=R,this.hdrScale=F.hdrScale||this.hdrScale,this.quality=F.hdrScale||this.quality}return E.prototype._createRenderTarget=function(R){var F=0;this._engine.getCaps().textureHalfFloatRender?F=2:this._engine.getCaps().textureFloatRender&&(F=1);var B=this._engine.createRenderTargetCubeTexture(R,{format:5,type:F,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(B,0,0,0),this._engine.updateTextureSamplingMode(3,B,!0),B},E.prototype._prefilterInternal=function(R){var F=R.getSize().width,B=S.a.ILog2(F)+1,L=this._effectWrapper.effect,I=this._createRenderTarget(F);this._effectRenderer.setViewport();var k=R.getInternalTexture();k&&this._engine.updateTextureSamplingMode(3,k,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);var Z=[[new T.z(0,0,-1),new T.z(0,-1,0),new T.z(1,0,0)],[new T.z(0,0,1),new T.z(0,-1,0),new T.z(-1,0,0)],[new T.z(1,0,0),new T.z(0,0,1),new T.z(0,1,0)],[new T.z(1,0,0),new T.z(0,0,-1),new T.z(0,-1,0)],[new T.z(1,0,0),new T.z(0,-1,0),new T.z(0,0,1)],[new T.z(-1,0,0),new T.z(0,-1,0),new T.z(0,0,-1)]];L.setFloat("hdrScale",this.hdrScale),L.setFloat2("vFilteringInfo",R.getSize().width,B),L.setTexture("inputTexture",R);for(var Y=0;Y<6;Y++){L.setVector3("up",Z[Y][0]),L.setVector3("right",Z[Y][1]),L.setVector3("front",Z[Y][2]);for(var U=0;U<B;U++){this._engine.bindFramebuffer(I,Y,void 0,void 0,!0,U),this._effectRenderer.applyEffectWrapper(this._effectWrapper);var Q=Math.pow(2,(U-this._lodGenerationOffset)/this._lodGenerationScale)/F;U===0&&(Q=0),L.setFloat("alphaG",Q),this._effectRenderer.draw()}}return this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseFramebufferObjects(I),this._engine._releaseTexture(R._texture),I._swapAndDie(R._texture),R._prefiltered=!0,R},E.prototype._createEffect=function(R,F){var B=[];R.gammaSpace&&B.push("#define GAMMA_INPUT"),B.push("#define NUM_SAMPLES "+this.quality+"u");var L=new j.b({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:B,onCompiled:F});return L},E.prototype.isReady=function(R){return R.isReady()&&this._effectWrapper.effect.isReady()},E.prototype.prefilter=function(R,F){var B=this;return F===void 0&&(F=null),this._engine._features.allowTexturePrefiltering?new Promise(function(L){B._effectRenderer=new j.a(B._engine),B._effectWrapper=B._createEffect(R),B._effectWrapper.effect.executeWhenCompiled(function(){B._prefilterInternal(R),B._effectRenderer.dispose(),B._effectWrapper.dispose(),L(),F&&F()})}):(l.a.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))},E}()},638:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(444),S=u(590),j=u(438),O=u(435),M="minmaxReduxPixelShader",H=`varying vec2 vUV;
uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
float f1=texelFetch(sourceTexture,coord,0).r;
float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;
float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;
float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;
float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(MAIN)
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
vec2 f1=texelFetch(textureSampler,coord,0).rg;
vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;
vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;
vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;
float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);
float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*vec2(texSize-1));
vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;
vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;
vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;
vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;
float minz=min(f1.x,f2.x);
float maxz=max(f1.y,f2.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(LAST)
void main(void)
{
discard;
glFragColor=vec4(0.);
}
#endif
`;O.a.ShadersStore[M]=H;var A={name:M,shader:H},p=function(){function f(h){this.onAfterReductionPerformed=new j.c,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=h,this._postProcessManager=new S.a(h.getScene())}return Object.defineProperty(f.prototype,"sourceTexture",{get:function(){return this._sourceTexture},enumerable:!1,configurable:!0}),f.prototype.setSourceTexture=function(h,m,d,g){var v=this;if(d===void 0&&(d=2),g===void 0&&(g=!0),h!==this._sourceTexture){this.dispose(!1),this._sourceTexture=h,this._reductionSteps=[],this._forceFullscreenViewport=g;var l=this._camera.getScene(),y=new T.a("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,l.getEngine(),!1,"#define INITIAL"+(m?`
#define DEPTH_REDUX`:""),d,void 0,void 0,void 0,7);y.autoClear=!1,y.forceFullscreenViewport=g;var E=this._sourceTexture.getRenderWidth(),R=this._sourceTexture.getRenderHeight();y.onApply=function(I,k){return function(Z){Z.setTexture("sourceTexture",v._sourceTexture),Z.setFloat2("texSize",I,k)}}(E,R),this._reductionSteps.push(y);for(var F=1;E>1||R>1;){E=Math.max(Math.round(E/2),1),R=Math.max(Math.round(R/2),1);var B=new T.a("Reduction phase "+F,"minmaxRedux",["texSize"],null,{width:E,height:R},null,1,l.getEngine(),!1,"#define "+(E==1&&R==1?"LAST":E==1||R==1?"ONEBEFORELAST":"MAIN"),d,void 0,void 0,void 0,7);if(B.autoClear=!1,B.forceFullscreenViewport=g,B.onApply=function(I,k){return function(Z){I==1||k==1?Z.setInt2("texSize",I,k):Z.setFloat2("texSize",I,k)}}(E,R),this._reductionSteps.push(B),F++,E==1&&R==1){var L=function(I,k,Z){var Y=new Float32Array(4*I*k),U={min:0,max:0};return function(){l.getEngine()._readTexturePixels(Z.inputTexture,I,k,-1,0,Y,!1),U.min=Y[0],U.max=Y[1],v.onAfterReductionPerformed.notifyObservers(U)}};B.onAfterRenderObservable.add(L(E,R,B))}}}},Object.defineProperty(f.prototype,"refreshRate",{get:function(){return this._sourceTexture?this._sourceTexture.refreshRate:-1},set:function(h){this._sourceTexture&&(this._sourceTexture.refreshRate=h)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"activated",{get:function(){return this._activated},enumerable:!1,configurable:!0}),f.prototype.activate=function(){var h=this;this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(function(){var m=h._camera.getScene().getEngine();m._debugPushGroup("min max reduction",1),h._reductionSteps[0].activate(h._camera),h._postProcessManager.directRender(h._reductionSteps,h._reductionSteps[0].inputTexture,h._forceFullscreenViewport),m.unBindFramebuffer(h._reductionSteps[0].inputTexture,!1),m._debugPopGroup(1)}),this._activated=!0)},f.prototype.deactivate=function(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)},f.prototype.dispose=function(h){if(h===void 0&&(h=!0),h&&this.onAfterReductionPerformed.clear(),this.deactivate(),this._reductionSteps){for(var m=0;m<this._reductionSteps.length;++m)this._reductionSteps[m].dispose();this._reductionSteps=null}this._postProcessManager&&h&&this._postProcessManager.dispose(),this._sourceTexture=null},f}()},639:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(439),j=u(438),O=u(464),M=u(443),H=u(688),A=function(){function p(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new j.c,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}return p.prototype.attachControl=function(f){var h=this;f=M.b.BackCompatCameraNoPreventDefault(arguments),this._wheel=function(m){if(m.type===O.a.POINTERWHEEL){var d=m.event,g=d.deltaMode===H.b.DOM_DELTA_LINE?h._ffMultiplier:1;d.deltaY!==void 0?(h._wheelDeltaX+=h.wheelPrecisionX*g*d.deltaX/h._normalize,h._wheelDeltaY-=h.wheelPrecisionY*g*d.deltaY/h._normalize,h._wheelDeltaZ+=h.wheelPrecisionZ*g*d.deltaZ/h._normalize):d.wheelDeltaY!==void 0?(h._wheelDeltaX+=h.wheelPrecisionX*g*d.wheelDeltaX/h._normalize,h._wheelDeltaY-=h.wheelPrecisionY*g*d.wheelDeltaY/h._normalize,h._wheelDeltaZ+=h.wheelPrecisionZ*g*d.wheelDeltaZ/h._normalize):d.wheelDelta&&(h._wheelDeltaY-=h.wheelPrecisionY*d.wheelDelta/h._normalize),d.preventDefault&&(f||d.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,O.a.POINTERWHEEL)},p.prototype.detachControl=function(f){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()},p.prototype.checkInputs=function(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0},p.prototype.getClassName=function(){return"BaseCameraMouseWheelInput"},p.prototype.getSimpleName=function(){return"mousewheel"},Object(T.c)([Object(S.c)()],p.prototype,"wheelPrecisionX",void 0),Object(T.c)([Object(S.c)()],p.prototype,"wheelPrecisionY",void 0),Object(T.c)([Object(S.c)()],p.prototype,"wheelPrecisionZ",void 0),p}()},640:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(439),j=u(460),O=u(562),M=u(436),H=u(443),A=function(){function p(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this._keys=new Array}return p.prototype.attachControl=function(f){var h=this;f=H.b.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){h._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(m){var d=m.event;if(!d.metaKey){if(m.type===O.a.KEYDOWN){if(h.keysUp.indexOf(d.keyCode)!==-1||h.keysDown.indexOf(d.keyCode)!==-1||h.keysLeft.indexOf(d.keyCode)!==-1||h.keysRight.indexOf(d.keyCode)!==-1||h.keysUpward.indexOf(d.keyCode)!==-1||h.keysDownward.indexOf(d.keyCode)!==-1){var g=h._keys.indexOf(d.keyCode);g===-1&&h._keys.push(d.keyCode),f||d.preventDefault()}}else if(h.keysUp.indexOf(d.keyCode)!==-1||h.keysDown.indexOf(d.keyCode)!==-1||h.keysLeft.indexOf(d.keyCode)!==-1||h.keysRight.indexOf(d.keyCode)!==-1||h.keysUpward.indexOf(d.keyCode)!==-1||h.keysDownward.indexOf(d.keyCode)!==-1){var g=h._keys.indexOf(d.keyCode);g>=0&&h._keys.splice(g,1),f||d.preventDefault()}}}))},p.prototype.detachControl=function(f){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},p.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var f=this.camera,h=0;h<this._keys.length;h++){var m=this._keys[h],d=f._computeLocalCameraSpeed();this.keysLeft.indexOf(m)!==-1?f._localDirection.copyFromFloats(-d,0,0):this.keysUp.indexOf(m)!==-1?f._localDirection.copyFromFloats(0,0,d):this.keysRight.indexOf(m)!==-1?f._localDirection.copyFromFloats(d,0,0):this.keysDown.indexOf(m)!==-1?f._localDirection.copyFromFloats(0,0,-d):this.keysUpward.indexOf(m)!==-1?f._localDirection.copyFromFloats(0,d,0):this.keysDownward.indexOf(m)!==-1&&f._localDirection.copyFromFloats(0,-d,0),f.getScene().useRightHandedSystem&&(f._localDirection.z*=-1),f.getViewMatrix().invertToRef(f._cameraTransformMatrix),M.e.TransformNormalToRef(f._localDirection,f._cameraTransformMatrix,f._transformedDirection),f.cameraDirection.addInPlace(f._transformedDirection)}},p.prototype.getClassName=function(){return"FreeCameraKeyboardMoveInput"},p.prototype._onLostFocus=function(){this._keys=[]},p.prototype.getSimpleName=function(){return"keyboard"},Object(T.c)([Object(S.c)()],p.prototype,"keysUp",void 0),Object(T.c)([Object(S.c)()],p.prototype,"keysUpward",void 0),Object(T.c)([Object(S.c)()],p.prototype,"keysDown",void 0),Object(T.c)([Object(S.c)()],p.prototype,"keysDownward",void 0),Object(T.c)([Object(S.c)()],p.prototype,"keysLeft",void 0),Object(T.c)([Object(S.c)()],p.prototype,"keysRight",void 0),p}();j.a.FreeCameraKeyboardMoveInput=A},641:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(438),j=u(439),O=u(460),M=u(464),H=u(443),A=function(){function p(f){f===void 0&&(f=!0),this.touchEnabled=f,this.buttons=[0,1,2],this.angularSensibility=2e3,this.previousPosition=null,this.onPointerMovedObservable=new S.c,this._allowCameraRotation=!0}return p.prototype.attachControl=function(f){var h=this;f=H.b.BackCompatCameraNoPreventDefault(arguments);var m=this.camera.getEngine(),d=m.getInputElement();this._pointerInput||(this._pointerInput=function(g){var v=g.event;if(!m.isInVRExclusivePointerMode&&!(!h.touchEnabled&&v.pointerType==="touch")&&!(g.type!==M.a.POINTERMOVE&&h.buttons.indexOf(v.button)===-1)){var l=v.srcElement||v.target;if(g.type===M.a.POINTERDOWN&&l){try{l.setPointerCapture(v.pointerId)}catch(R){}h.previousPosition={x:v.clientX,y:v.clientY},f||(v.preventDefault(),d&&d.focus()),m.isPointerLock&&h._onMouseMove&&h._onMouseMove(g.event)}else if(g.type===M.a.POINTERUP&&l){try{l.releasePointerCapture(v.pointerId)}catch(R){}h.previousPosition=null,f||v.preventDefault()}else if(g.type===M.a.POINTERMOVE){if(!h.previousPosition){m.isPointerLock&&h._onMouseMove&&h._onMouseMove(g.event);return}var y=v.clientX-h.previousPosition.x,E=v.clientY-h.previousPosition.y;h.camera.getScene().useRightHandedSystem&&(y*=-1),h.camera.parent&&h.camera.parent._getWorldMatrixDeterminant()<0&&(y*=-1),h._allowCameraRotation&&(h.camera.cameraRotation.y+=y/h.angularSensibility,h.camera.cameraRotation.x+=E/h.angularSensibility),h.onPointerMovedObservable.notifyObservers({offsetX:y,offsetY:E}),h.previousPosition={x:v.clientX,y:v.clientY},f||v.preventDefault()}}}),this._onMouseMove=function(g){if(!!m.isPointerLock&&!m.isInVRExclusivePointerMode){var v=g.movementX||g.mozMovementX||g.webkitMovementX||g.msMovementX||0;h.camera.getScene().useRightHandedSystem&&(v*=-1),h.camera.parent&&h.camera.parent._getWorldMatrixDeterminant()<0&&(v*=-1),h.camera.cameraRotation.y+=v/h.angularSensibility;var l=g.movementY||g.mozMovementY||g.webkitMovementY||g.msMovementY||0;h.camera.cameraRotation.x+=l/h.angularSensibility,h.previousPosition=null,f||g.preventDefault()}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,M.a.POINTERDOWN|M.a.POINTERUP|M.a.POINTERMOVE),d&&d.addEventListener("contextmenu",this.onContextMenu.bind(this),!1)},p.prototype.onContextMenu=function(f){f.preventDefault()},p.prototype.detachControl=function(f){if(this._observer){if(this.camera.getScene().onPointerObservable.remove(this._observer),this.onContextMenu){var h=this.camera.getEngine(),m=h.getInputElement();m&&m.removeEventListener("contextmenu",this.onContextMenu)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this.previousPosition=null}},p.prototype.getClassName=function(){return"FreeCameraMouseInput"},p.prototype.getSimpleName=function(){return"mouse"},Object(T.c)([Object(j.c)()],p.prototype,"buttons",void 0),Object(T.c)([Object(j.c)()],p.prototype,"angularSensibility",void 0),p}();O.a.FreeCameraMouseInput=A},642:function(Ue,P,u){"use strict";u.d(P,"a",function(){return p});var T=u(434),S=u(439),j=u(460),O=u(639),M=u(436),H=u(465),A;(function(f){f[f.MoveRelative=0]="MoveRelative",f[f.RotateRelative=1]="RotateRelative",f[f.MoveScene=2]="MoveScene"})(A||(A={}));var p=function(f){Object(T.d)(h,f);function h(){var m=f!==null&&f.apply(this,arguments)||this;return m._moveRelative=M.e.Zero(),m._rotateRelative=M.e.Zero(),m._moveScene=M.e.Zero(),m._wheelXAction=A.MoveRelative,m._wheelXActionCoordinate=H.b.X,m._wheelYAction=A.MoveRelative,m._wheelYActionCoordinate=H.b.Z,m._wheelZAction=null,m._wheelZActionCoordinate=null,m}return h.prototype.getClassName=function(){return"FreeCameraMouseWheelInput"},Object.defineProperty(h.prototype,"wheelXMoveRelative",{get:function(){return this._wheelXAction!==A.MoveRelative?null:this._wheelXActionCoordinate},set:function(m){m===null&&this._wheelXAction!==A.MoveRelative||(this._wheelXAction=A.MoveRelative,this._wheelXActionCoordinate=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"wheelYMoveRelative",{get:function(){return this._wheelYAction!==A.MoveRelative?null:this._wheelYActionCoordinate},set:function(m){m===null&&this._wheelYAction!==A.MoveRelative||(this._wheelYAction=A.MoveRelative,this._wheelYActionCoordinate=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"wheelZMoveRelative",{get:function(){return this._wheelZAction!==A.MoveRelative?null:this._wheelZActionCoordinate},set:function(m){m===null&&this._wheelZAction!==A.MoveRelative||(this._wheelZAction=A.MoveRelative,this._wheelZActionCoordinate=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"wheelXRotateRelative",{get:function(){return this._wheelXAction!==A.RotateRelative?null:this._wheelXActionCoordinate},set:function(m){m===null&&this._wheelXAction!==A.RotateRelative||(this._wheelXAction=A.RotateRelative,this._wheelXActionCoordinate=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"wheelYRotateRelative",{get:function(){return this._wheelYAction!==A.RotateRelative?null:this._wheelYActionCoordinate},set:function(m){m===null&&this._wheelYAction!==A.RotateRelative||(this._wheelYAction=A.RotateRelative,this._wheelYActionCoordinate=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"wheelZRotateRelative",{get:function(){return this._wheelZAction!==A.RotateRelative?null:this._wheelZActionCoordinate},set:function(m){m===null&&this._wheelZAction!==A.RotateRelative||(this._wheelZAction=A.RotateRelative,this._wheelZActionCoordinate=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"wheelXMoveScene",{get:function(){return this._wheelXAction!==A.MoveScene?null:this._wheelXActionCoordinate},set:function(m){m===null&&this._wheelXAction!==A.MoveScene||(this._wheelXAction=A.MoveScene,this._wheelXActionCoordinate=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"wheelYMoveScene",{get:function(){return this._wheelYAction!==A.MoveScene?null:this._wheelYActionCoordinate},set:function(m){m===null&&this._wheelYAction!==A.MoveScene||(this._wheelYAction=A.MoveScene,this._wheelYActionCoordinate=m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"wheelZMoveScene",{get:function(){return this._wheelZAction!==A.MoveScene?null:this._wheelZActionCoordinate},set:function(m){m===null&&this._wheelZAction!==A.MoveScene||(this._wheelZAction=A.MoveScene,this._wheelZActionCoordinate=m)},enumerable:!1,configurable:!0}),h.prototype.checkInputs=function(){if(!(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)){this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);var m=M.a.Zero();this.camera.getViewMatrix().invertToRef(m);var d=M.e.Zero();M.e.TransformNormalToRef(this._moveRelative,m,d),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(d),this.camera.cameraDirection.addInPlace(this._moveScene),f.prototype.checkInputs.call(this)}},h.prototype._updateCamera=function(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)},h.prototype._updateCameraProperty=function(m,d,g){if(m!==0&&!(d===null||g===null)){var v=null;switch(d){case A.MoveRelative:v=this._moveRelative;break;case A.RotateRelative:v=this._rotateRelative;break;case A.MoveScene:v=this._moveScene;break}switch(g){case H.b.X:v.set(m,0,0);break;case H.b.Y:v.set(0,m,0);break;case H.b.Z:v.set(0,0,m);break}}},Object(T.c)([Object(S.c)()],h.prototype,"wheelXMoveRelative",null),Object(T.c)([Object(S.c)()],h.prototype,"wheelYMoveRelative",null),Object(T.c)([Object(S.c)()],h.prototype,"wheelZMoveRelative",null),Object(T.c)([Object(S.c)()],h.prototype,"wheelXRotateRelative",null),Object(T.c)([Object(S.c)()],h.prototype,"wheelYRotateRelative",null),Object(T.c)([Object(S.c)()],h.prototype,"wheelZRotateRelative",null),Object(T.c)([Object(S.c)()],h.prototype,"wheelXMoveScene",null),Object(T.c)([Object(S.c)()],h.prototype,"wheelYMoveScene",null),Object(T.c)([Object(S.c)()],h.prototype,"wheelZMoveScene",null),h}(O.a);j.a.FreeCameraMouseWheelInput=p},643:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(434),S=u(439),j=u(460),O=u(464),M=u(436),H=u(443),A=function(){function p(f){f===void 0&&(f=!1),this.allowMouse=f,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array}return p.prototype.attachControl=function(f){var h=this;f=H.b.BackCompatCameraNoPreventDefault(arguments);var m=null;if(this._pointerInput===void 0&&(this._onLostFocus=function(){h._offsetX=null,h._offsetY=null},this._pointerInput=function(v){var l=v.event,y=!h.camera.getEngine().hostInformation.isMobile&&l instanceof MouseEvent;if(!(!h.allowMouse&&(l.pointerType==="mouse"||y))){if(v.type===O.a.POINTERDOWN){if(f||l.preventDefault(),h._pointerPressed.push(l.pointerId),h._pointerPressed.length!==1)return;m={x:l.clientX,y:l.clientY}}else if(v.type===O.a.POINTERUP){f||l.preventDefault();var E=h._pointerPressed.indexOf(l.pointerId);if(E===-1||(h._pointerPressed.splice(E,1),E!=0))return;m=null,h._offsetX=null,h._offsetY=null}else if(v.type===O.a.POINTERMOVE){if(f||l.preventDefault(),!m)return;var E=h._pointerPressed.indexOf(l.pointerId);if(E!=0)return;h._offsetX=l.clientX-m.x,h._offsetY=-(l.clientY-m.y)}}}),this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,O.a.POINTERDOWN|O.a.POINTERUP|O.a.POINTERMOVE),this._onLostFocus){var d=this.camera.getEngine(),g=d.getInputElement();g&&g.addEventListener("blur",this._onLostFocus)}},p.prototype.detachControl=function(f){if(this._pointerInput){if(this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null),this._onLostFocus){var h=this.camera.getEngine(),m=h.getInputElement();m&&m.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed=[],this._offsetX=null,this._offsetY=null}},p.prototype.checkInputs=function(){if(!(this._offsetX===null||this._offsetY===null)&&!(this._offsetX===0&&this._offsetY===0)){var f=this.camera;if(f.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this._pointerPressed.length>1)f.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{var h=f._computeLocalCameraSpeed(),m=new M.e(0,0,h*this._offsetY/this.touchMoveSensibility);M.a.RotationYawPitchRollToRef(f.rotation.y,f.rotation.x,0,f._cameraRotationMatrix),f.cameraDirection.addInPlace(M.e.TransformCoordinates(m,f._cameraRotationMatrix))}}},p.prototype.getClassName=function(){return"FreeCameraTouchInput"},p.prototype.getSimpleName=function(){return"touch"},Object(T.c)([Object(S.c)()],p.prototype,"touchAngularSensibility",void 0),Object(T.c)([Object(S.c)()],p.prototype,"touchMoveSensibility",void 0),p}();j.a.FreeCameraTouchInput=A},644:function(Ue,P,u){"use strict";var T=u(435),S=u(524),j=u(457),O=u(525),M="imageProcessingPixelShader",H=`
varying vec2 vUV;
uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
void main(void)
{
vec4 result=texture2D(textureSampler,vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE

result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else

#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;
}`;T.a.ShadersStore[M]=H;var A={name:M,shader:H}},645:function(Ue,P,u){"use strict";(function(T){u.d(P,"b",function(){return f}),u.d(P,"a",function(){return h});var S=u(434),j=u(440),O=u(445),M=u(595),H=u(456),A=u(563),p=u(670),f=function(){function m(){this.renderWidth=512,this.renderHeight=256,this.textureSize=512,this.deterministicLockstep=!1,this.lockstepMaxSteps=4}return m}(),h=function(m){Object(S.d)(d,m);function d(g){g===void 0&&(g=new f);var v=m.call(this,null)||this;O.a.Instances.push(v),g.deterministicLockstep===void 0&&(g.deterministicLockstep=!1),g.lockstepMaxSteps===void 0&&(g.lockstepMaxSteps=4),v._options=g,p.a.SetMatrixPrecision(!!g.useHighPrecisionMatrix),v._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:512,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!1,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:0,uintIndices:!1,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!1,instancedArrays:!1,canUseTimestampForTimerQuery:!1,maxMSAASamples:1,blendMinMax:!1,canUseGLInstanceID:!1,canUseGLVertexID:!1},v._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!1,_collectUbosUpdatedInFrame:!1},j.a.Log("Babylon.js v"+O.a.Version+" - Null engine");var l=typeof self!="undefined"?self:typeof T!="undefined"?T:window;return typeof URL=="undefined"&&(l.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob=="undefined"&&(l.Blob=function(){}),v}return d.prototype.isDeterministicLockStep=function(){return this._options.deterministicLockstep},d.prototype.getLockstepMaxSteps=function(){return this._options.lockstepMaxSteps},d.prototype.getHardwareScalingLevel=function(){return 1},d.prototype.createVertexBuffer=function(g){var v=new A.a;return v.references=1,v},d.prototype.createIndexBuffer=function(g){var v=new A.a;return v.references=1,v},d.prototype.clear=function(g,v,l,y){y===void 0&&(y=!1)},d.prototype.getRenderWidth=function(g){return g===void 0&&(g=!1),!g&&this._currentRenderTarget?this._currentRenderTarget.width:this._options.renderWidth},d.prototype.getRenderHeight=function(g){return g===void 0&&(g=!1),!g&&this._currentRenderTarget?this._currentRenderTarget.height:this._options.renderHeight},d.prototype.setViewport=function(g,v,l){this._cachedViewport=g},d.prototype.createShaderProgram=function(g,v,l,y,E){return{__SPECTOR_rebuildProgram:null}},d.prototype.getUniforms=function(g,v){return[]},d.prototype.getAttributes=function(g,v){return[]},d.prototype.bindSamplers=function(g){this._currentEffect=null},d.prototype.enableEffect=function(g){this._currentEffect=g,g.onBind&&g.onBind(g),g._onBindObservable&&g._onBindObservable.notifyObservers(g)},d.prototype.setState=function(g,v,l,y){v===void 0&&(v=0),y===void 0&&(y=!1)},d.prototype.setIntArray=function(g,v){return!0},d.prototype.setIntArray2=function(g,v){return!0},d.prototype.setIntArray3=function(g,v){return!0},d.prototype.setIntArray4=function(g,v){return!0},d.prototype.setFloatArray=function(g,v){return!0},d.prototype.setFloatArray2=function(g,v){return!0},d.prototype.setFloatArray3=function(g,v){return!0},d.prototype.setFloatArray4=function(g,v){return!0},d.prototype.setArray=function(g,v){return!0},d.prototype.setArray2=function(g,v){return!0},d.prototype.setArray3=function(g,v){return!0},d.prototype.setArray4=function(g,v){return!0},d.prototype.setMatrices=function(g,v){return!0},d.prototype.setMatrix3x3=function(g,v){return!0},d.prototype.setMatrix2x2=function(g,v){return!0},d.prototype.setFloat=function(g,v){return!0},d.prototype.setFloat2=function(g,v,l){return!0},d.prototype.setFloat3=function(g,v,l,y){return!0},d.prototype.setBool=function(g,v){return!0},d.prototype.setFloat4=function(g,v,l,y,E){return!0},d.prototype.setAlphaMode=function(g,v){v===void 0&&(v=!1),this._alphaMode!==g&&(this.alphaState.alphaBlend=g!==0,v||this.setDepthWrite(g===0),this._alphaMode=g)},d.prototype.bindBuffers=function(g,v,l){},d.prototype.wipeCaches=function(g){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,g&&(this._currentProgram=null,this.stencilState.reset(),this.depthCullingState.reset(),this.alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},d.prototype.draw=function(g,v,l,y){},d.prototype.drawElementsType=function(g,v,l,y){},d.prototype.drawArraysType=function(g,v,l,y){},d.prototype._createTexture=function(){return{}},d.prototype._releaseTexture=function(g){},d.prototype.createTexture=function(g,v,l,y,E,R,F,B,L,I,k,Z){E===void 0&&(E=3),R===void 0&&(R=null),F===void 0&&(F=null),B===void 0&&(B=null),L===void 0&&(L=null),I===void 0&&(I=null),k===void 0&&(k=null);var Y=new H.a(this,H.b.Url),U=String(g);return Y.url=U,Y.generateMipMaps=!v,Y.samplingMode=E,Y.invertY=l,Y.baseWidth=this._options.textureSize,Y.baseHeight=this._options.textureSize,Y.width=this._options.textureSize,Y.height=this._options.textureSize,I&&(Y.format=I),Y.isReady=!0,R&&R(),this._internalTexturesCache.push(Y),Y},d.prototype.createRenderTargetTexture=function(g,v){var l=new M.a;v!==void 0&&typeof v=="object"?(l.generateMipMaps=v.generateMipMaps,l.generateDepthBuffer=v.generateDepthBuffer===void 0?!0:v.generateDepthBuffer,l.generateStencilBuffer=l.generateDepthBuffer&&v.generateStencilBuffer,l.type=v.type===void 0?0:v.type,l.samplingMode=v.samplingMode===void 0?3:v.samplingMode):(l.generateMipMaps=v,l.generateDepthBuffer=!0,l.generateStencilBuffer=!1,l.type=0,l.samplingMode=3);var y=new H.a(this,H.b.RenderTarget),E=g.width||g,R=g.height||g;return y._depthStencilBuffer={},y._framebuffer={},y.baseWidth=E,y.baseHeight=R,y.width=E,y.height=R,y.isReady=!0,y.samples=1,y.generateMipMaps=!!l.generateMipMaps,y.samplingMode=l.samplingMode,y.type=l.type,y._generateDepthBuffer=l.generateDepthBuffer,y._generateStencilBuffer=!!l.generateStencilBuffer,this._internalTexturesCache.push(y),y},d.prototype.updateTextureSamplingMode=function(g,v){v.samplingMode=g},d.prototype.bindFramebuffer=function(g,v,l,y,E){this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=g,this._currentFramebuffer=g._MSAAFramebuffer?g._MSAAFramebuffer:g._framebuffer,this._cachedViewport&&!E&&this.setViewport(this._cachedViewport,l,y)},d.prototype.unBindFramebuffer=function(g,v,l){v===void 0&&(v=!1),this._currentRenderTarget=null,l&&(g._MSAAFramebuffer&&(this._currentFramebuffer=g._framebuffer),l()),this._currentFramebuffer=null},d.prototype.createDynamicVertexBuffer=function(g){var v=new A.a;return v.references=1,v.capacity=1,v},d.prototype.updateDynamicTexture=function(g,v,l,y,E){y===void 0&&(y=!1)},d.prototype.areAllEffectsReady=function(){return!0},d.prototype.getError=function(){return 0},d.prototype._getUnpackAlignement=function(){return 1},d.prototype._unpackFlipY=function(g){},d.prototype.updateDynamicIndexBuffer=function(g,v,l){l===void 0&&(l=0)},d.prototype.updateDynamicVertexBuffer=function(g,v,l,y){},d.prototype._bindTextureDirectly=function(g,v){return this._boundTexturesCache[this._activeChannel]!==v?(this._boundTexturesCache[this._activeChannel]=v,!0):!1},d.prototype._bindTexture=function(g,v){g<0||this._bindTextureDirectly(0,v)},d.prototype._deleteBuffer=function(g){},d.prototype.releaseEffects=function(){},d.prototype.displayLoadingUI=function(){},d.prototype.hideLoadingUI=function(){},d.prototype._uploadCompressedDataToTextureDirectly=function(g,v,l,y,E,R,F){R===void 0&&(R=0),F===void 0&&(F=0)},d.prototype._uploadDataToTextureDirectly=function(g,v,l,y){l===void 0&&(l=0),y===void 0&&(y=0)},d.prototype._uploadArrayBufferViewToTexture=function(g,v,l,y){l===void 0&&(l=0),y===void 0&&(y=0)},d.prototype._uploadImageToTexture=function(g,v,l,y){l===void 0&&(l=0),y===void 0&&(y=0)},d}(O.a)}).call(this,u(15))},646:function(Ue,P,u){"use strict";var T=u(435),S="glowMapMergePixelShader",j=`
varying vec2 vUV;
uniform sampler2D textureSampler;
#ifdef EMISSIVE
uniform sampler2D textureSampler2;
#endif

uniform float offset;
void main(void) {
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef EMISSIVE
baseColor+=texture2D(textureSampler2,vUV);
baseColor*=offset;
#else
baseColor.a=abs(offset-baseColor.a);
#ifdef STROKE
float alpha=smoothstep(.0,.1,baseColor.a);
baseColor.a=alpha;
baseColor.rgb=baseColor.rgb*alpha;
#endif
#endif
gl_FragColor=baseColor;
}`;T.a.ShadersStore[S]=j;var O={name:S,shader:j}},647:function(Ue,P,u){"use strict";var T=u(435),S="glowMapMergeVertexShader",j=`
attribute vec2 position;

varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
}`;T.a.ShadersStore[S]=j;var O={name:S,shader:j}},649:function(Ue,P,u){"use strict";u.d(P,"a",function(){return M});var T=u(449),S=u(452),j=u(598),O=u(440);Object.defineProperty(T.a.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(H){H&&H.isSupported&&(this._prePassRenderer=H)},enumerable:!0,configurable:!0}),T.a.prototype.enablePrePassRenderer=function(){return this._prePassRenderer?this._prePassRenderer:(this._prePassRenderer=new j.a(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,O.a.Error(`PrePassRenderer needs WebGL 2 support.
Maybe you tried to use the following features that need the PrePassRenderer :
 + Subsurface Scattering`)),this._prePassRenderer)},T.a.prototype.disablePrePassRenderer=function(){!this._prePassRenderer||(this._prePassRenderer.dispose(),this._prePassRenderer=null)};var M=function(){function H(A){this.name=S.a.NAME_PREPASSRENDERER,this.scene=A}return H.prototype.register=function(){this.scene._beforeCameraDrawStage.registerStep(S.a.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(S.a.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(S.a.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(S.a.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(S.a.STEP_BEFORECLEARSTAGE_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(S.a.STEP_BEFORERENDERTARGETCLEARSTAGE_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(S.a.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(S.a.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)},H.prototype._beforeRenderTargetDraw=function(A,p,f){this.scene.prePassRenderer&&(A._prePassRenderTarget||(A._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(A.name+"_prePassRTT",A)),this.scene.prePassRenderer._setRenderTarget(A._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,p,f))},H.prototype._afterRenderTargetDraw=function(A,p,f){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw(p,f)},H.prototype._beforeRenderTargetClearStage=function(A,p,f){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(A._prePassRenderTarget),this.scene.prePassRenderer._clear())},H.prototype._beforeCameraDraw=function(A){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(A))},H.prototype._afterCameraDraw=function(A){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()},H.prototype._beforeClearStage=function(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())},H.prototype._beforeRenderingMeshStage=function(A,p,f,h){if(!!h){var m=A.getScene();m.prePassRenderer&&m.prePassRenderer.bindAttachmentsForEffect(h,p)}},H.prototype._afterRenderingMeshStage=function(A){var p=A.getScene();p.prePassRenderer&&p.prePassRenderer.restoreAttachments()},H.prototype.rebuild=function(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()},H.prototype.dispose=function(){this.scene.disablePrePassRenderer()},H}();j.a._SceneComponentInitialization=function(H){var A=H._getComponent(S.a.NAME_PREPASSRENDERER);A||(A=new M(H),H._addComponent(A))}},664:function(Ue,P,u){"use strict";var T=u(435),S=u(487),j=u(496),O=u(497),M=u(501),H=u(507),A=u(508),p=u(488),f=u(489),h="depthVertexShader",m=`
attribute vec3 position;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
varying float vDepthMetric;
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;T.a.ShadersStore[h]=m;var d={name:h,shader:m}},665:function(Ue,P,u){"use strict";u.d(P,"a",function(){return v}),u.d(P,"b",function(){return l});var T=u(475),S=u(436),j=u(440),O=u(447),M=u(485),H=u(446),A=u(448),p=u(610),f=u(536),h=u(469),m=u(455),d=u(477),g=u(450),v;(function(y){y[y.Color=2]="Color",y[y.UV=1]="UV",y[y.Random=0]="Random",y[y.Stated=3]="Stated"})(v||(v={}));var l=function(){function y(E,R,F,B){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=E,this._size=R,this._scene=F||A.a.LastCreatedScene,B&&B.updatable!==void 0?this._updatable=B.updatable:this._updatable=!0}return y.prototype.buildMeshAsync=function(){var E=this;return Promise.all(this._promises).then(function(){return E._isReady=!0,E._buildMesh()})},y.prototype._buildMesh=function(){this.nbParticles===0&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);var E=new M.a;E.set(this._positions32,O.b.PositionKind),this._uvs32.length>0&&E.set(this._uvs32,O.b.UVKind);var R=0;this._colors32.length>0&&(R=1,E.set(this._colors32,O.b.ColorKind));var F=new H.a(this.name,this._scene);E.applyToMesh(F,this._updatable),this.mesh=F,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);var B=new m.a("point cloud material",this._scene);return B.emissiveColor=new T.e(R,R,R),B.disableLighting=!0,B.pointsCloud=!0,B.pointSize=this._size,F.material=B,new Promise(function(L){return L(F)})},y.prototype._addParticle=function(E,R,F,B){var L=new p.a(E,R,F,B,this);return this.particles.push(L),L},y.prototype._randomUnitVector=function(E){E.position=new S.e(Math.random(),Math.random(),Math.random()),E.color=new T.f(1,1,1,1)},y.prototype._getColorIndicesForCoord=function(E,R,F,B){var L=E._groupImageData,I=F*(B*4)+R*4,k=[I,I+1,I+2,I+3],Z=k[0],Y=k[1],U=k[2],Q=k[3],G=L[Z],K=L[Y],fe=L[U],ce=L[Q];return new T.f(G/255,K/255,fe/255,ce)},y.prototype._setPointsColorOrUV=function(E,R,F,B,L,I,k){F&&E.updateFacetData();var Z=E.getBoundingInfo(),Y=2*Z.boundingSphere.radius,U=E.getVerticesData(O.b.PositionKind),Q=E.getIndices(),G=E.getVerticesData(O.b.UVKind),K=E.getVerticesData(O.b.ColorKind),fe=S.e.Zero();E.computeWorldMatrix();var ce=E.getWorldMatrix();if(!ce.isIdentity())for(var re=0;re<U.length/3;re++)S.e.TransformCoordinatesFromFloatsToRef(U[3*re],U[3*re+1],U[3*re+2],ce,fe),U[3*re]=fe.x,U[3*re+1]=fe.y,U[3*re+2]=fe.z;var Re=0,Ie=0,Ce=0,X=0,ae=0,ee=0,w=0,N=0,W=0,$=0,J=0,le=0,ne=0,be=0,Me=S.e.Zero(),Te=S.e.Zero(),Ae=S.e.Zero(),se=S.e.Zero(),te=S.e.Zero(),he=0,de=0,Ne=0,Le=0,pe=0,He=0,rt=S.d.Zero(),ot=S.d.Zero(),et=S.d.Zero(),ht=S.d.Zero(),Ee=S.d.Zero(),At=0,Ht=0,Ot=0,Ut=0,Qt=0,Zi=0,zi=0,li=0,Di=0,Zt=0,_i=0,ji=0,yi=S.f.Zero(),ai=S.f.Zero(),Ei=S.f.Zero(),Gt=S.f.Zero(),wi=S.f.Zero(),ui=0,Wi=0;k=k||0;for(var Hi,Pi,It=new S.f(0,0,0,0),Ji=S.e.Zero(),Dr=S.e.Zero(),Vt=S.e.Zero(),Ci=0,dr=S.e.Zero(),Ii=0,kt=0,Nt=new h.a(S.e.Zero(),new S.e(1,0,0)),sr,Ai=S.e.Zero(),Ie=0;Ie<Q.length/3;Ie++){Ce=Q[3*Ie],X=Q[3*Ie+1],ae=Q[3*Ie+2],ee=U[3*Ce],w=U[3*Ce+1],N=U[3*Ce+2],W=U[3*X],$=U[3*X+1],J=U[3*X+2],le=U[3*ae],ne=U[3*ae+1],be=U[3*ae+2],Me.set(ee,w,N),Te.set(W,$,J),Ae.set(le,ne,be),Te.subtractToRef(Me,se),Ae.subtractToRef(Te,te),G&&(he=G[2*Ce],de=G[2*Ce+1],Ne=G[2*X],Le=G[2*X+1],pe=G[2*ae],He=G[2*ae+1],rt.set(he,de),ot.set(Ne,Le),et.set(pe,He),ot.subtractToRef(rt,ht),et.subtractToRef(ot,Ee)),K&&B&&(At=K[4*Ce],Ht=K[4*Ce+1],Ot=K[4*Ce+2],Ut=K[4*Ce+3],Qt=K[4*X],Zi=K[4*X+1],zi=K[4*X+2],li=K[4*X+3],Di=K[4*ae],Zt=K[4*ae+1],_i=K[4*ae+2],ji=K[4*ae+3],yi.set(At,Ht,Ot,Ut),ai.set(Qt,Zi,zi,li),Ei.set(Di,Zt,_i,ji),ai.subtractToRef(yi,Gt),Ei.subtractToRef(ai,wi));for(var pr,Er,Vi,$i,Pr,mr,Jt,Kt,Li=new T.e(0,0,0),Ui=new T.e(0,0,0),qi,Xt,er=0;er<R._groupDensity[Ie];er++)Re=this.particles.length,this._addParticle(Re,R,this._groupCounter,Ie+er),Xt=this.particles[Re],ui=g.a.RandomRange(0,1),Wi=g.a.RandomRange(0,1),Hi=Me.add(se.scale(ui)).add(te.scale(ui*Wi)),F&&(Ji=E.getFacetNormal(Ie).normalize().scale(-1),Dr=se.clone().normalize(),Vt=S.e.Cross(Ji,Dr),Ci=g.a.RandomRange(0,2*Math.PI),dr=Dr.scale(Math.cos(Ci)).add(Vt.scale(Math.sin(Ci))),Ci=g.a.RandomRange(.1,Math.PI/2),Ai=dr.scale(Math.cos(Ci)).add(Ji.scale(Math.sin(Ci))),Nt.origin=Hi.add(Ai.scale(1e-5)),Nt.direction=Ai,Nt.length=Y,sr=Nt.intersectsMesh(E),sr.hit&&(kt=sr.pickedPoint.subtract(Hi).length(),Ii=g.a.RandomRange(0,1)*kt,Hi.addInPlace(Ai.scale(Ii)))),Xt.position=Hi.clone(),this._positions.push(Xt.position.x,Xt.position.y,Xt.position.z),B!==void 0?G&&(Pi=rt.add(ht.scale(ui)).add(Ee.scale(ui*Wi)),B?L&&R._groupImageData!==null?(pr=R._groupImgWidth,Er=R._groupImgHeight,qi=this._getColorIndicesForCoord(R,Math.round(Pi.x*pr),Math.round(Pi.y*Er),pr),Xt.color=qi,this._colors.push(qi.r,qi.g,qi.b,qi.a)):K?(It=yi.add(Gt.scale(ui)).add(wi.scale(ui*Wi)),Xt.color=new T.f(It.x,It.y,It.z,It.w),this._colors.push(It.x,It.y,It.z,It.w)):(It=yi.set(Math.random(),Math.random(),Math.random(),1),Xt.color=new T.f(It.x,It.y,It.z,It.w),this._colors.push(It.x,It.y,It.z,It.w)):(Xt.uv=Pi.clone(),this._uvs.push(Xt.uv.x,Xt.uv.y))):(I?(Li.set(I.r,I.g,I.b),Vi=g.a.RandomRange(-k,k),$i=g.a.RandomRange(-k,k),Kt=Li.toHSV(),Pr=Kt.r,mr=Kt.g+Vi,Jt=Kt.b+$i,mr<0&&(mr=0),mr>1&&(mr=1),Jt<0&&(Jt=0),Jt>1&&(Jt=1),T.e.HSVtoRGBToRef(Pr,mr,Jt,Ui),It.set(Ui.r,Ui.g,Ui.b,1)):It=yi.set(Math.random(),Math.random(),Math.random(),1),Xt.color=new T.f(It.x,It.y,It.z,It.w),this._colors.push(It.x,It.y,It.z,It.w))}},y.prototype._colorFromTexture=function(E,R,F){var B=this;if(E.material===null){j.a.Warn(E.name+"has no material."),R._groupImageData=null,this._setPointsColorOrUV(E,R,F,!0,!1);return}var L=E.material,I=L.getActiveTextures();if(I.length===0){j.a.Warn(E.name+"has no usable texture."),R._groupImageData=null,this._setPointsColorOrUV(E,R,F,!0,!1);return}var k=E.clone();k.setEnabled(!1),this._promises.push(new Promise(function(Z){d.a.WhenAllReady(I,function(){var Y=R._textureNb;Y<0&&(Y=0),Y>I.length-1&&(Y=I.length-1);var U=function(){R._groupImgWidth=I[Y].getSize().width,R._groupImgHeight=I[Y].getSize().height,B._setPointsColorOrUV(k,R,F,!0,!0),k.dispose(),Z()};R._groupImageData=null;var Q=I[Y].readPixels();Q?Q.then(function(G){R._groupImageData=G,U()}):U()})}))},y.prototype._calculateDensity=function(E,R,F){for(var B=new Array,L,I,k,Z,Y,U,Q,G,K,fe,ce,re,Re,Ie=S.e.Zero(),Ce=S.e.Zero(),X=S.e.Zero(),ae=S.e.Zero(),ee=S.e.Zero(),w=S.e.Zero(),N,W,$,J,le,ne=new Array,be=0,Me=F.length/3,L=0;L<Me;L++)I=F[3*L],k=F[3*L+1],Z=F[3*L+2],Y=R[3*I],U=R[3*I+1],Q=R[3*I+2],G=R[3*k],K=R[3*k+1],fe=R[3*k+2],ce=R[3*Z],re=R[3*Z+1],Re=R[3*Z+2],Ie.set(Y,U,Q),Ce.set(G,K,fe),X.set(ce,re,Re),Ce.subtractToRef(Ie,ae),X.subtractToRef(Ce,ee),X.subtractToRef(Ie,w),N=ae.length(),W=ee.length(),$=w.length(),J=(N+W+$)/2,le=Math.sqrt(J*(J-N)*(J-W)*(J-$)),be+=le,ne[L]=le;for(var Te=0,L=0;L<Me;L++)B[L]=Math.floor(E*ne[L]/be),Te+=B[L];var Ae=E-Te,se=Math.floor(Ae/Me),te=Ae%Me;se>0&&(B=B.map(function(he){return he+se}));for(var L=0;L<te;L++)B[L]+=1;return B},y.prototype.addPoints=function(E,R){R===void 0&&(R=this._randomUnitVector);for(var F=new p.b(this._groupCounter,R),B,L=this.nbParticles,I=0;I<E;I++)B=this._addParticle(L,F,this._groupCounter,I),F&&F._positionFunction&&F._positionFunction(B,L,I),this._positions.push(B.position.x,B.position.y,B.position.z),B.color&&this._colors.push(B.color.r,B.color.g,B.color.b,B.color.a),B.uv&&this._uvs.push(B.uv.x,B.uv.y),L++;return this.nbParticles+=E,this._groupCounter++,this._groupCounter},y.prototype.addSurfacePoints=function(E,R,F,B,L){var I=F||v.Random;(isNaN(I)||I<0||I>3)&&(I=v.Random);var k=E.getVerticesData(O.b.PositionKind),Z=E.getIndices();this._groups.push(this._groupCounter);var Y=new p.b(this._groupCounter,null);switch(Y._groupDensity=this._calculateDensity(R,k,Z),I===v.Color?Y._textureNb=B||0:B=B||new T.f(1,1,1,1),I){case v.Color:this._colorFromTexture(E,Y,!1);break;case v.UV:this._setPointsColorOrUV(E,Y,!1,!1,!1);break;case v.Random:this._setPointsColorOrUV(E,Y,!1);break;case v.Stated:this._setPointsColorOrUV(E,Y,!1,void 0,void 0,B,L);break}return this.nbParticles+=R,this._groupCounter++,this._groupCounter-1},y.prototype.addVolumePoints=function(E,R,F,B,L){var I=F||v.Random;(isNaN(I)||I<0||I>3)&&(I=v.Random);var k=E.getVerticesData(O.b.PositionKind),Z=E.getIndices();this._groups.push(this._groupCounter);var Y=new p.b(this._groupCounter,null);switch(Y._groupDensity=this._calculateDensity(R,k,Z),I===v.Color?Y._textureNb=B||0:B=B||new T.f(1,1,1,1),I){case v.Color:this._colorFromTexture(E,Y,!0);break;case v.UV:this._setPointsColorOrUV(E,Y,!0,!1,!1);break;case v.Random:this._setPointsColorOrUV(E,Y,!0);break;case v.Stated:this._setPointsColorOrUV(E,Y,!0,void 0,void 0,B,L);break}return this.nbParticles+=R,this._groupCounter++,this._groupCounter-1},y.prototype.setParticles=function(E,R,F){if(E===void 0&&(E=0),R===void 0&&(R=this.nbParticles-1),F===void 0&&(F=!0),!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(E,R,F);var B=S.c.Matrix[0],L=this.mesh,I=this._colors32,k=this._positions32,Z=this._uvs32,Y=S.c.Vector3,U=Y[5].copyFromFloats(1,0,0),Q=Y[6].copyFromFloats(0,1,0),G=Y[7].copyFromFloats(0,0,1),K=Y[8].setAll(Number.MAX_VALUE),fe=Y[9].setAll(-Number.MAX_VALUE);S.a.IdentityToRef(B);var ce=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),R=R>=this.nbParticles?this.nbParticles-1:R,this._computeBoundingBox&&(E!=0||R!=this.nbParticles-1)){var re=this.mesh._boundingInfo;re&&(K.copyFrom(re.minimum),fe.copyFrom(re.maximum))}for(var ce=0,Re=0,Ie=0,Ce=0,X=E;X<=R;X++){var ae=this.particles[X];ce=ae.idx,Re=3*ce,Ie=4*ce,Ce=2*ce,this.updateParticle(ae);var ee=ae._rotationMatrix,w=ae.position,N=ae._globalPosition;this._computeParticleRotation&&ae.getRotationMatrix(B);var W=ae.parentId!==null;if(W){var $=this.particles[ae.parentId],J=$._rotationMatrix,le=$._globalPosition,ne=w.x*J[1]+w.y*J[4]+w.z*J[7],be=w.x*J[0]+w.y*J[3]+w.z*J[6],Me=w.x*J[2]+w.y*J[5]+w.z*J[8];if(N.x=le.x+be,N.y=le.y+ne,N.z=le.z+Me,this._computeParticleRotation){var Te=B.m;ee[0]=Te[0]*J[0]+Te[1]*J[3]+Te[2]*J[6],ee[1]=Te[0]*J[1]+Te[1]*J[4]+Te[2]*J[7],ee[2]=Te[0]*J[2]+Te[1]*J[5]+Te[2]*J[8],ee[3]=Te[4]*J[0]+Te[5]*J[3]+Te[6]*J[6],ee[4]=Te[4]*J[1]+Te[5]*J[4]+Te[6]*J[7],ee[5]=Te[4]*J[2]+Te[5]*J[5]+Te[6]*J[8],ee[6]=Te[8]*J[0]+Te[9]*J[3]+Te[10]*J[6],ee[7]=Te[8]*J[1]+Te[9]*J[4]+Te[10]*J[7],ee[8]=Te[8]*J[2]+Te[9]*J[5]+Te[10]*J[8]}}else if(N.x=0,N.y=0,N.z=0,this._computeParticleRotation){var Te=B.m;ee[0]=Te[0],ee[1]=Te[1],ee[2]=Te[2],ee[3]=Te[4],ee[4]=Te[5],ee[5]=Te[6],ee[6]=Te[8],ee[7]=Te[9],ee[8]=Te[10]}var Ae=Y[11];ae.translateFromPivot?Ae.setAll(0):Ae.copyFrom(ae.pivot);var se=Y[0];se.copyFrom(ae.position);var te=se.x-ae.pivot.x,he=se.y-ae.pivot.y,de=se.z-ae.pivot.z,Ne=te*ee[0]+he*ee[3]+de*ee[6],Le=te*ee[1]+he*ee[4]+de*ee[7],pe=te*ee[2]+he*ee[5]+de*ee[8];Ne+=Ae.x,Le+=Ae.y,pe+=Ae.z;var He=k[Re]=N.x+U.x*Ne+Q.x*Le+G.x*pe,rt=k[Re+1]=N.y+U.y*Ne+Q.y*Le+G.y*pe,ot=k[Re+2]=N.z+U.z*Ne+Q.z*Le+G.z*pe;if(this._computeBoundingBox&&(K.minimizeInPlaceFromFloats(He,rt,ot),fe.maximizeInPlaceFromFloats(He,rt,ot)),this._computeParticleColor&&ae.color){var et=ae.color,ht=this._colors32;ht[Ie]=et.r,ht[Ie+1]=et.g,ht[Ie+2]=et.b,ht[Ie+3]=et.a}if(this._computeParticleTexture&&ae.uv){var Ee=ae.uv,At=this._uvs32;At[Ce]=Ee.x,At[Ce+1]=Ee.y}}return F&&(this._computeParticleColor&&L.updateVerticesData(O.b.ColorKind,I,!1,!1),this._computeParticleTexture&&L.updateVerticesData(O.b.UVKind,Z,!1,!1),L.updateVerticesData(O.b.PositionKind,k,!1,!1)),this._computeBoundingBox&&(L._boundingInfo?L._boundingInfo.reConstruct(K,fe,L._worldMatrix):L._boundingInfo=new f.a(K,fe,L._worldMatrix)),this.afterUpdateParticles(E,R,F),this},y.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null},y.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},y.prototype.setVisibilityBox=function(E){var R=E/2;this.mesh._boundingInfo=new f.a(new S.e(-R,-R,-R),new S.e(R,R,R))},Object.defineProperty(y.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(E){this._alwaysVisible=E,this.mesh.alwaysSelectAsActiveMesh=E},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"computeParticleRotation",{set:function(E){this._computeParticleRotation=E},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(E){this._computeParticleColor=E},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(E){this._computeParticleTexture=E},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(E){this._computeBoundingBox=E},enumerable:!1,configurable:!0}),y.prototype.initParticles=function(){},y.prototype.recycleParticle=function(E){return E},y.prototype.updateParticle=function(E){return E},y.prototype.beforeUpdateParticles=function(E,R,F){},y.prototype.afterUpdateParticles=function(E,R,F){},y}()},666:function(Ue,P,u){"use strict";u.d(P,"a",function(){return O});var T=u(449),S=u(556),j=u(452);T.a.prototype.enableDepthRenderer=function(M,H,A){if(H===void 0&&(H=!1),A===void 0&&(A=!1),M=M||this.activeCamera,!M)throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[M.id]){var p=!!this.getEngine().getCaps().textureFloatRender,f=0;this.getEngine().getCaps().textureHalfFloatRender&&(!A||!p)?f=2:p?f=1:f=0,this._depthRenderer[M.id]=new S.a(this,f,M,H)}return this._depthRenderer[M.id]},T.a.prototype.disableDepthRenderer=function(M){M=M||this.activeCamera,!(!M||!this._depthRenderer||!this._depthRenderer[M.id])&&(this._depthRenderer[M.id].dispose(),delete this._depthRenderer[M.id])};var O=function(){function M(H){this.name=j.a.NAME_DEPTHRENDERER,this.scene=H}return M.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(j.a.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(j.a.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)},M.prototype.rebuild=function(){},M.prototype.dispose=function(){for(var H in this.scene._depthRenderer)this.scene._depthRenderer[H].dispose()},M.prototype._gatherRenderTargets=function(H){if(this.scene._depthRenderer)for(var A in this.scene._depthRenderer){var p=this.scene._depthRenderer[A];p.enabled&&!p.useOnlyInActiveCamera&&H.push(p.getDepthMap())}},M.prototype._gatherActiveCameraRenderTargets=function(H){if(this.scene._depthRenderer)for(var A in this.scene._depthRenderer){var p=this.scene._depthRenderer[A];p.enabled&&p.useOnlyInActiveCamera&&this.scene.activeCamera.id===A&&H.push(p.getDepthMap())}},M}();S.a._SceneComponentInitialization=function(M){var H=M._getComponent(j.a.NAME_DEPTHRENDERER);H||(H=new O(M),M._addComponent(H))}},676:function(Ue,P,u){"use strict";var T=u(435),S="depthBoxBlurPixelShader",j=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform vec2 screenSize;
void main(void)
{
vec4 colorDepth=vec4(0.0);
for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);
gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));
}`;T.a.ShadersStore[S]=j;var O={name:S,shader:j}},677:function(Ue,P,u){"use strict";u.d(P,"b",function(){return K}),u.d(P,"a",function(){return fe});var T=u(440),S=u(451),j=u(436),O=u(441),M=u(446),H=u(661),A=u(499),p=u(459),f=u(543),h=u(504),m=u(567),d=u(540),g=u(484),v=u(452),l=u(463),y=u(468),E=u(604),R=u(618),F=u(560),B=u(561),L=u(632),I=u(633),k=u(634),Z=u(635),Y=u(437),U=u(443),Q=u(473),G=u(444),K=!0,fe=function(){function X(){}return X.LoaderInjectedPhysicsEngine=void 0,X}(),ce=function(X,ae,ee,w){for(var N=0,W=ae.materials.length;N<W;N++){var $=ae.materials[N];if($.id===X)return p.a.Parse($,ee,w)}return null},re=function(X,ae,ee){for(var w in ae)if(X.name===ae[w])return ee.push(X.id),!0;return X.parentId&&ee.indexOf(X.parentId)!==-1?(ee.push(X.id),!0):!1},Re=function(X,ae){return X+" of "+(ae?ae.file+" from "+ae.name+" version: "+ae.version+", exporter version: "+ae.exporter_version:"unknown")},Ie=function(X,ae){var ee=ae;if(ae._waitingData.lods){if(ae._waitingData.lods.ids&&ae._waitingData.lods.ids.length>0){var w=ae._waitingData.lods.ids,N=ee.isEnabled(!1);if(ae._waitingData.lods.distances){var W=ae._waitingData.lods.distances;if(W.length>=w.length){var $=W.length>w.length?W[W.length-1]:0;ee.setEnabled(!1);for(var J=0;J<w.length;J++){var le=w[J],ne=X.getMeshByID(le);ne!=null&&ee.addLODLevel(W[J],ne)}$>0&&ee.addLODLevel($,null),N===!0&&ee.setEnabled(!0)}else U.b.Warn("Invalid level of detail distances for "+ae.name)}}ae._waitingData.lods=null}},Ce=function(X,ae,ee,w,N){N===void 0&&(N=!1);var W=new E.a(X),$="importScene has failed JSON parse";try{var J=JSON.parse(ae);$="";var le=l.a.loggingLevel===l.a.DETAILED_LOGGING,ne,be;if(J.environmentTexture!==void 0&&J.environmentTexture!==null){var Me=J.isPBR!==void 0?J.isPBR:!0;if(J.environmentTextureType&&J.environmentTextureType==="BABYLON.HDRCubeTexture"){var Te=J.environmentTextureSize?J.environmentTextureSize:128,Ae=new m.a((J.environmentTexture.match(/https?:\/\//g)?"":ee)+J.environmentTexture,X,Te,!0,!Me);J.environmentTextureRotationY&&(Ae.rotationY=J.environmentTextureRotationY),X.environmentTexture=Ae}else if(Q.a.EndsWith(J.environmentTexture,".env")){var se=new h.a((J.environmentTexture.match(/https?:\/\//g)?"":ee)+J.environmentTexture,X);J.environmentTextureRotationY&&(se.rotationY=J.environmentTextureRotationY),X.environmentTexture=se}else{var te=h.a.CreateFromPrefilteredData((J.environmentTexture.match(/https?:\/\//g)?"":ee)+J.environmentTexture,X);J.environmentTextureRotationY&&(te.rotationY=J.environmentTextureRotationY),X.environmentTexture=te}if(J.createDefaultSkybox===!0){var he=X.activeCamera!==void 0&&X.activeCamera!==null?(X.activeCamera.maxZ-X.activeCamera.minZ)/2:1e3,de=J.skyboxBlurLevel||0;X.createDefaultSkybox(X.environmentTexture,Me,he,de)}W.environmentTexture=X.environmentTexture}if(J.environmentIntensity!==void 0&&J.environmentIntensity!==null&&(X.environmentIntensity=J.environmentIntensity),J.lights!==void 0&&J.lights!==null)for(ne=0,be=J.lights.length;ne<be;ne++){var Ne=J.lights[ne],Le=g.a.Parse(Ne,X);Le&&(W.lights.push(Le),$+=ne===0?`
	Lights:`:"",$+=`
		`+Le.toString(le))}if(J.reflectionProbes!==void 0&&J.reflectionProbes!==null)for(ne=0,be=J.reflectionProbes.length;ne<be;ne++){var pe=J.reflectionProbes[ne],He=Z.a.Parse(pe,X,ee);He&&(W.reflectionProbes.push(He),$+=ne===0?`
	Reflection Probes:`:"",$+=`
		`+He.toString(le))}if(J.animations!==void 0&&J.animations!==null)for(ne=0,be=J.animations.length;ne<be;ne++){var rt=J.animations[ne],ot=Y.a.GetClass("BABYLON.Animation");if(ot){var et=ot.Parse(rt);X.animations.push(et),W.animations.push(et),$+=ne===0?`
	Animations:`:"",$+=`
		`+et.toString(le)}}if(J.materials!==void 0&&J.materials!==null)for(ne=0,be=J.materials.length;ne<be;ne++){var ht=J.materials[ne],Ee=p.a.Parse(ht,X,ee);if(Ee){W.materials.push(Ee),$+=ne===0?`
	Materials:`:"",$+=`
		`+Ee.toString(le);var At=Ee.getActiveTextures();At.forEach(function(Vi){W.textures.indexOf(Vi)==-1&&W.textures.push(Vi)})}}if(J.multiMaterials!==void 0&&J.multiMaterials!==null)for(ne=0,be=J.multiMaterials.length;ne<be;ne++){var Ht=J.multiMaterials[ne],Ot=f.a.ParseMultiMaterial(Ht,X);W.multiMaterials.push(Ot),$+=ne===0?`
	MultiMaterials:`:"",$+=`
		`+Ot.toString(le);var At=Ot.getActiveTextures();At.forEach(function($i){W.textures.indexOf($i)==-1&&W.textures.push($i)})}if(J.morphTargetManagers!==void 0&&J.morphTargetManagers!==null)for(var Ut=0,Qt=J.morphTargetManagers;Ut<Qt.length;Ut++){var Zi=Qt[Ut];W.morphTargetManagers.push(B.a.Parse(Zi,X))}if(J.skeletons!==void 0&&J.skeletons!==null)for(ne=0,be=J.skeletons.length;ne<be;ne++){var zi=J.skeletons[ne],li=F.a.Parse(zi,X);W.skeletons.push(li),$+=ne===0?`
	Skeletons:`:"",$+=`
		`+li.toString(le)}var Di=J.geometries;if(Di!=null){var Zt=new Array,_i=Di.vertexData;if(_i!=null)for(ne=0,be=_i.length;ne<be;ne++){var ji=_i[ne];Zt.push(H.a.Parse(ji,X,ee))}Zt.forEach(function(Vi){Vi&&W.geometries.push(Vi)})}if(J.transformNodes!==void 0&&J.transformNodes!==null)for(ne=0,be=J.transformNodes.length;ne<be;ne++){var yi=J.transformNodes[ne],ai=A.a.Parse(yi,X,ee);W.transformNodes.push(ai)}if(J.meshes!==void 0&&J.meshes!==null)for(ne=0,be=J.meshes.length;ne<be;ne++){var Ei=J.meshes[ne],Gt=M.a.Parse(Ei,X,ee);if(W.meshes.push(Gt),Gt.hasInstances)for(var wi=0,ui=Gt.instances;wi<ui.length;wi++){var Wi=ui[wi];W.meshes.push(Wi)}$+=ne===0?`
	Meshes:`:"",$+=`
		`+Gt.toString(le)}if(J.cameras!==void 0&&J.cameras!==null)for(ne=0,be=J.cameras.length;ne<be;ne++){var Hi=J.cameras[ne],Pi=S.a.Parse(Hi,X);W.cameras.push(Pi),$+=ne===0?`
	Cameras:`:"",$+=`
		`+Pi.toString(le)}if(J.postProcesses!==void 0&&J.postProcesses!==null)for(ne=0,be=J.postProcesses.length;ne<be;ne++){var It=J.postProcesses[ne],Ji=G.a.Parse(It,X,ee);Ji&&(W.postProcesses.push(Ji),$+=ne===0?`
Postprocesses:`:"",$+=`
		`+Ji.toString())}if(J.animationGroups!==void 0&&J.animationGroups!==null)for(ne=0,be=J.animationGroups.length;ne<be;ne++){var Dr=J.animationGroups[ne],Vt=d.a.Parse(Dr,X);W.animationGroups.push(Vt),$+=ne===0?`
	AnimationGroups:`:"",$+=`
		`+Vt.toString(le)}for(ne=0,be=X.cameras.length;ne<be;ne++){var Pi=X.cameras[ne];Pi._waitingParentId&&(Pi.parent=X.getLastEntryByID(Pi._waitingParentId),Pi._waitingParentId=null)}for(ne=0,be=X.lights.length;ne<be;ne++){var Ci=X.lights[ne];Ci&&Ci._waitingParentId&&(Ci.parent=X.getLastEntryByID(Ci._waitingParentId),Ci._waitingParentId=null)}for(ne=0,be=X.transformNodes.length;ne<be;ne++){var dr=X.transformNodes[ne];dr._waitingParentId&&(dr.parent=X.getLastEntryByID(dr._waitingParentId),dr._waitingParentId=null)}for(ne=0,be=X.meshes.length;ne<be;ne++){var Gt=X.meshes[ne];Gt._waitingParentId&&(Gt.parent=X.getLastEntryByID(Gt._waitingParentId),Gt._waitingParentId=null),Gt._waitingData.lods&&Ie(X,Gt)}for(ne=0,be=X.skeletons.length;ne<be;ne++){var li=X.skeletons[ne];li._hasWaitingData&&(li.bones!=null&&li.bones.forEach(function($i){if($i._waitingTransformNodeId){var Pr=X.getLastEntryByID($i._waitingTransformNodeId);Pr&&$i.linkTransformNode(Pr),$i._waitingTransformNodeId=null}}),li._waitingOverrideMeshId&&(li.overrideMesh=X.getMeshByID(li._waitingOverrideMeshId),li._waitingOverrideMeshId=null),li._hasWaitingData=null)}for(ne=0,be=X.meshes.length;ne<be;ne++){var Ii=X.meshes[ne];Ii._waitingData.freezeWorldMatrix?(Ii.freezeWorldMatrix(),Ii._waitingData.freezeWorldMatrix=null):Ii.computeWorldMatrix(!0)}for(ne=0,be=X.lights.length;ne<be;ne++){var kt=X.lights[ne];if(kt._excludedMeshesIds.length>0){for(var Nt=0;Nt<kt._excludedMeshesIds.length;Nt++){var sr=X.getMeshByID(kt._excludedMeshesIds[Nt]);sr&&kt.excludedMeshes.push(sr)}kt._excludedMeshesIds=[]}if(kt._includedOnlyMeshesIds.length>0){for(var Ai=0;Ai<kt._includedOnlyMeshesIds.length;Ai++){var pr=X.getMeshByID(kt._includedOnlyMeshesIds[Ai]);pr&&kt.includedOnlyMeshes.push(pr)}kt._includedOnlyMeshesIds=[]}}for(y.a.Parse(J,X,W,ee),ne=0,be=X.meshes.length;ne<be;ne++){var Gt=X.meshes[ne];Gt._waitingData.actions&&(R.a.Parse(Gt._waitingData.actions,Gt,X),Gt._waitingData.actions=null)}J.actions!==void 0&&J.actions!==null&&R.a.Parse(J.actions,null,X)}catch(Vi){var Er=Re("loadAssets",J?J.producer:"Unknown")+$;if(w)w(Er,Vi);else throw T.a.Log(Er),Vi}finally{N||W.removeAllFromScene(),$!==null&&l.a.loggingLevel!==l.a.NO_LOGGING&&T.a.Log(Re("loadAssets",J?J.producer:"Unknown")+(l.a.loggingLevel!==l.a.MINIMAL_LOGGING?$:""))}return W};l.a.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:function(X){return X.indexOf("babylon")!==-1},importMesh:function(X,ae,ee,w,N,W,$,J){var le="importMesh has failed JSON parse";try{var ne=JSON.parse(ee);le="";var be=l.a.loggingLevel===l.a.DETAILED_LOGGING;X?Array.isArray(X)||(X=[X]):X=null;var Me=new Array;if(ne.meshes!==void 0&&ne.meshes!==null){var Te=[],Ae=[],se,te;for(se=0,te=ne.meshes.length;se<te;se++){var he=ne.meshes[se];if(X===null||re(he,X,Me)){if(X!==null&&delete X[X.indexOf(he.name)],he.geometryId!==void 0&&he.geometryId!==null&&ne.geometries!==void 0&&ne.geometries!==null){var de=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(function(ai){de===!0||!ne.geometries[ai]||!Array.isArray(ne.geometries[ai])||ne.geometries[ai].forEach(function(Ei){if(Ei.id===he.geometryId){switch(ai){case"vertexData":H.a.Parse(Ei,ae,w);break}de=!0}})}),de===!1&&T.a.Warn("Geometry not found for mesh "+he.id)}if(he.materialId){var Ne=Ae.indexOf(he.materialId)!==-1;if(Ne===!1&&ne.multiMaterials!==void 0&&ne.multiMaterials!==null)for(var Le=0,pe=ne.multiMaterials.length;Le<pe;Le++){var He=ne.multiMaterials[Le];if(He.id===he.materialId){for(var rt=0,ot=He.materials.length;rt<ot;rt++){var et=He.materials[rt];Ae.push(et);var ht=ce(et,ne,ae,w);ht&&(le+=`
	Material `+ht.toString(be))}Ae.push(He.id);var Ee=f.a.ParseMultiMaterial(He,ae);Ee&&(Ne=!0,le+=`
	Multi-Material `+Ee.toString(be));break}}if(Ne===!1){Ae.push(he.materialId);var ht=ce(he.materialId,ne,ae,w);ht?le+=`
	Material `+ht.toString(be):T.a.Warn("Material not found for mesh "+he.id)}}if(he.skeletonId>-1&&ne.skeletons!==void 0&&ne.skeletons!==null){var At=Te.indexOf(he.skeletonId)>-1;if(At===!1)for(var Ht=0,Ot=ne.skeletons.length;Ht<Ot;Ht++){var Ut=ne.skeletons[Ht];if(Ut.id===he.skeletonId){var Qt=F.a.Parse(Ut,ae);$.push(Qt),Te.push(Ut.id),le+=`
	Skeleton `+Qt.toString(be)}}}if(ne.morphTargetManagers!==void 0&&ne.morphTargetManagers!==null)for(var Zi=0,zi=ne.morphTargetManagers;Zi<zi.length;Zi++){var li=zi[Zi];B.a.Parse(li,ae)}var Di=M.a.Parse(he,ae,w);N.push(Di),le+=`
	Mesh `+Di.toString(be)}}var Zt;for(se=0,te=ae.meshes.length;se<te;se++)Zt=ae.meshes[se],Zt._waitingParentId&&(Zt.parent=ae.getLastEntryByID(Zt._waitingParentId),Zt._waitingParentId=null),Zt._waitingData.lods&&Ie(ae,Zt);for(se=0,te=ae.skeletons.length;se<te;se++){var Qt=ae.skeletons[se];Qt._hasWaitingData&&(Qt.bones!=null&&Qt.bones.forEach(function(Ei){if(Ei._waitingTransformNodeId){var Gt=ae.getLastEntryByID(Ei._waitingTransformNodeId);Gt&&Ei.linkTransformNode(Gt),Ei._waitingTransformNodeId=null}}),Qt._waitingOverrideMeshId&&(Qt.overrideMesh=ae.getMeshByID(Qt._waitingOverrideMeshId),Qt._waitingOverrideMeshId=null),Qt._hasWaitingData=null)}for(se=0,te=ae.meshes.length;se<te;se++)Zt=ae.meshes[se],Zt._waitingData.freezeWorldMatrix?(Zt.freezeWorldMatrix(),Zt._waitingData.freezeWorldMatrix=null):Zt.computeWorldMatrix(!0)}if(ne.particleSystems!==void 0&&ne.particleSystems!==null){var _i=y.a.GetIndividualParser(v.a.NAME_PARTICLESYSTEM);if(_i)for(se=0,te=ne.particleSystems.length;se<te;se++){var ji=ne.particleSystems[se];Me.indexOf(ji.emitterId)!==-1&&W.push(_i(ji,ae,w))}}return!0}catch(ai){var yi=Re("importMesh",ne?ne.producer:"Unknown")+le;if(J)J(yi,ai);else throw T.a.Log(yi),ai}finally{le!==null&&l.a.loggingLevel!==l.a.NO_LOGGING&&T.a.Log(Re("importMesh",ne?ne.producer:"Unknown")+(l.a.loggingLevel!==l.a.MINIMAL_LOGGING?le:""))}return!1},load:function(X,ae,ee,w){var N="importScene has failed JSON parse";try{var W=JSON.parse(ae);if(N="",W.useDelayedTextureLoading!==void 0&&W.useDelayedTextureLoading!==null&&(X.useDelayedTextureLoading=W.useDelayedTextureLoading&&!l.a.ForceFullSceneLoadingForIncremental),W.autoClear!==void 0&&W.autoClear!==null&&(X.autoClear=W.autoClear),W.clearColor!==void 0&&W.clearColor!==null&&(X.clearColor=O.b.FromArray(W.clearColor)),W.ambientColor!==void 0&&W.ambientColor!==null&&(X.ambientColor=O.a.FromArray(W.ambientColor)),W.gravity!==void 0&&W.gravity!==null&&(X.gravity=j.e.FromArray(W.gravity)),W.fogMode&&W.fogMode!==0)switch(X.fogMode=W.fogMode,X.fogColor=O.a.FromArray(W.fogColor),X.fogStart=W.fogStart,X.fogEnd=W.fogEnd,X.fogDensity=W.fogDensity,N+="	Fog mode for scene:  ",X.fogMode){case 1:N+=`exp
`;break;case 2:N+=`exp2
`;break;case 3:N+=`linear
`;break}if(W.physicsEnabled){var $;W.physicsEngine==="cannon"?$=new L.a(void 0,void 0,fe.LoaderInjectedPhysicsEngine):W.physicsEngine==="oimo"?$=new I.a(void 0,fe.LoaderInjectedPhysicsEngine):W.physicsEngine==="ammo"&&($=new k.a(void 0,fe.LoaderInjectedPhysicsEngine,void 0)),N="	Physics engine "+(W.physicsEngine?W.physicsEngine:"oimo")+` enabled
`;var J=W.physicsGravity?j.e.FromArray(W.physicsGravity):null;X.enablePhysics(J,$)}W.metadata!==void 0&&W.metadata!==null&&(X.metadata=W.metadata),W.collisionsEnabled!==void 0&&W.collisionsEnabled!==null&&(X.collisionsEnabled=W.collisionsEnabled);var le=Ce(X,ae,ee,w,!0);return le?(W.autoAnimate&&X.beginAnimation(X,W.autoAnimateFrom,W.autoAnimateTo,W.autoAnimateLoop,W.autoAnimateSpeed||1),W.activeCameraID!==void 0&&W.activeCameraID!==null&&X.setActiveCameraByID(W.activeCameraID),!0):!1}catch(be){var ne=Re("importScene",W?W.producer:"Unknown")+N;if(w)w(ne,be);else throw T.a.Log(ne),be}finally{N!==null&&l.a.loggingLevel!==l.a.NO_LOGGING&&T.a.Log(Re("importScene",W?W.producer:"Unknown")+(l.a.loggingLevel!==l.a.MINIMAL_LOGGING?N:""))}return!1},loadAssetContainer:function(X,ae,ee,w){var N=Ce(X,ae,ee,w);return N}})},678:function(Ue,P,u){"use strict";u.r(P),u.d(P,"AxesViewer",function(){return M}),u.d(P,"BoneAxesViewer",function(){return p}),u.d(P,"DebugLayerTab",function(){return g}),u.d(P,"DebugLayer",function(){return v}),u.d(P,"PhysicsViewer",function(){return I}),u.d(P,"RayHelper",function(){return Z}),u.d(P,"SkeletonViewer",function(){return ce}),u.d(P,"DirectionalLightFrustumViewer",function(){return Ie});var T=u(436),S=u(455),j=u(573),O=u(441),M=function(){function Ce(X,ae,ee,w,N,W){if(ae===void 0&&(ae=1),ee===void 0&&(ee=2),this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this.scaleLines=1,this.scaleLines=ae,!w){var $=new S.a("",X);$.disableLighting=!0,$.emissiveColor=O.a.Red().scale(.5),w=j.a._CreateArrow(X,$)}if(!N){var J=new S.a("",X);J.disableLighting=!0,J.emissiveColor=O.a.Green().scale(.5),N=j.a._CreateArrow(X,J)}if(!W){var le=new S.a("",X);le.disableLighting=!0,le.emissiveColor=O.a.Blue().scale(.5),W=j.a._CreateArrow(X,le)}this._xAxis=w,this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis=N,this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis=W,this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),ee!=null&&(Ce._SetRenderingGroupId(this._xAxis,ee),Ce._SetRenderingGroupId(this._yAxis,ee),Ce._SetRenderingGroupId(this._zAxis,ee)),this.scene=X,this.update(new T.e,T.e.Right(),T.e.Up(),T.e.Forward())}return Object.defineProperty(Ce.prototype,"xAxis",{get:function(){return this._xAxis},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"yAxis",{get:function(){return this._yAxis},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"zAxis",{get:function(){return this._zAxis},enumerable:!1,configurable:!0}),Ce.prototype.update=function(X,ae,ee,w){this._xAxis.position.copyFrom(X),this._xAxis.setDirection(ae),this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis.position.copyFrom(X),this._yAxis.setDirection(ee),this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis.position.copyFrom(X),this._zAxis.setDirection(w),this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor)},Ce.prototype.createInstance=function(){var X=j.a._CreateArrowInstance(this.scene,this._xAxis),ae=j.a._CreateArrowInstance(this.scene,this._yAxis),ee=j.a._CreateArrowInstance(this.scene,this._zAxis),w=new Ce(this.scene,this.scaleLines,null,X,ae,ee);return w._instanced=!0,w},Ce.prototype.dispose=function(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null},Ce._SetRenderingGroupId=function(X,ae){X.getChildMeshes().forEach(function(ee){ee.renderingGroupId=ae})},Ce}(),H=u(434),A=u(465),p=function(Ce){Object(H.d)(X,Ce);function X(ae,ee,w,N){N===void 0&&(N=1);var W=Ce.call(this,ae,N)||this;return W.pos=T.e.Zero(),W.xaxis=T.e.Zero(),W.yaxis=T.e.Zero(),W.zaxis=T.e.Zero(),W.mesh=w,W.bone=ee,W}return X.prototype.update=function(){if(!(!this.mesh||!this.bone)){var ae=this.bone;ae._markAsDirtyAndCompose(),ae.getAbsolutePositionToRef(this.mesh,this.pos),ae.getDirectionToRef(A.a.X,this.mesh,this.xaxis),ae.getDirectionToRef(A.a.Y,this.mesh,this.yaxis),ae.getDirectionToRef(A.a.Z,this.mesh,this.zaxis),Ce.prototype.update.call(this,this.pos,this.xaxis,this.yaxis,this.zaxis)}},X.prototype.dispose=function(){this.mesh&&(this.mesh=null,this.bone=null,Ce.prototype.dispose.call(this))},X}(M),f=u(443),h=u(438),m=u(449),d=u(445);Object.defineProperty(m.a.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new v(this)),this._debugLayer},enumerable:!0,configurable:!0});var g;(function(Ce){Ce[Ce.Properties=0]="Properties",Ce[Ce.Debug=1]="Debug",Ce[Ce.Statistics=2]="Statistics",Ce[Ce.Tools=3]="Tools",Ce[Ce.Settings=4]="Settings"})(g||(g={}));var v=function(){function Ce(X){var ae=this;this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=X,this._scene.onDisposeObservable.add(function(){ae._scene._debugLayer&&ae._scene._debugLayer.hide()})}return Object.defineProperty(Ce.prototype,"onPropertyChangedObservable",{get:function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new h.c),this._onPropertyChangedObservable)},enumerable:!1,configurable:!0}),Ce.prototype._createInspector=function(X){if(!this.isVisible()){if(this._onPropertyChangedObservable){for(var ae=0,ee=this._onPropertyChangedObservable.observers;ae<ee.length;ae++){var w=ee[ae];this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(w)}this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}var N=Object(H.a)({overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0},X);this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,N)}},Ce.prototype.select=function(X,ae){this.BJSINSPECTOR&&(ae&&(Object.prototype.toString.call(ae)=="[object String]"?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(ae):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(ae)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(X))},Ce.prototype._getGlobalInspector=function(){if(typeof INSPECTOR!="undefined")return INSPECTOR;if(typeof BABYLON!="undefined"&&typeof BABYLON.Inspector!="undefined")return BABYLON},Ce.prototype.isVisible=function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible},Ce.prototype.hide=function(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()},Ce.prototype.setAsActiveScene=function(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)},Ce.prototype.show=function(X){var ae=this;return new Promise(function(ee,w){if(typeof ae.BJSINSPECTOR=="undefined"){var N=X&&X.inspectorURL?X.inspectorURL:Ce.InspectorURL;f.b.LoadScript(N,function(){ae._createInspector(X),ee(ae)})}else ae._createInspector(X),ee(ae)})},Ce.InspectorURL="https://unpkg.com/babylonjs-inspector@"+d.a.Version+"/babylon.inspector.bundle.js",Ce}(),l=u(446),y=u(495),E=u(470),R=u(448),F=u(503),B=u(461),L=u(494),I=function(){function Ce(X){this._impostors=[],this._meshes=[],this._numMeshes=0,this._debugMeshMeshes=new Array,this._scene=X||R.a.LastCreatedScene;var ae=this._scene.getPhysicsEngine();ae&&(this._physicsEnginePlugin=ae.getPhysicsPlugin()),this._utilityLayer=new B.a(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0}return Ce.prototype._updateDebugMeshes=function(){for(var X=this._physicsEnginePlugin,ae=0;ae<this._numMeshes;ae++){var ee=this._impostors[ae];if(!!ee)if(ee.isDisposed)this.hideImpostor(this._impostors[ae--]);else{if(ee.type===F.a.MeshImpostor)continue;var w=this._meshes[ae];w&&X&&X.syncMeshWithImpostor(w,ee)}}},Ce.prototype.showImpostor=function(X,ae){if(!this._scene)return null;for(var ee=0;ee<this._numMeshes;ee++)if(this._impostors[ee]==X)return null;var w=this._getDebugMesh(X,ae);return w&&(this._impostors[this._numMeshes]=X,this._meshes[this._numMeshes]=w,this._numMeshes===0&&(this._renderFunction=this._updateDebugMeshes.bind(this),this._scene.registerBeforeRender(this._renderFunction)),this._numMeshes++),w},Ce.prototype.hideImpostor=function(X){if(!(!X||!this._scene||!this._utilityLayer)){for(var ae=!1,ee=this._utilityLayer.utilityLayerScene,w=0;w<this._numMeshes;w++)if(this._impostors[w]==X){var N=this._meshes[w];if(!N)continue;ee.removeMesh(N),N.dispose();var W=this._debugMeshMeshes.indexOf(N);W>-1&&this._debugMeshMeshes.splice(W,1),this._numMeshes--,this._numMeshes>0?(this._meshes[w]=this._meshes[this._numMeshes],this._impostors[w]=this._impostors[this._numMeshes],this._meshes[this._numMeshes]=null,this._impostors[this._numMeshes]=null):(this._meshes[0]=null,this._impostors[0]=null),ae=!0;break}ae&&this._numMeshes===0&&this._scene.unregisterBeforeRender(this._renderFunction)}},Ce.prototype._getDebugMaterial=function(X){return this._debugMaterial||(this._debugMaterial=new S.a("",X),this._debugMaterial.wireframe=!0,this._debugMaterial.emissiveColor=O.a.White(),this._debugMaterial.disableLighting=!0),this._debugMaterial},Ce.prototype._getDebugBoxMesh=function(X){return this._debugBoxMesh||(this._debugBoxMesh=y.a.CreateBox("physicsBodyBoxViewMesh",{size:1},X),this._debugBoxMesh.rotationQuaternion=T.b.Identity(),this._debugBoxMesh.material=this._getDebugMaterial(X),this._debugBoxMesh.setEnabled(!1)),this._debugBoxMesh.createInstance("physicsBodyBoxViewInstance")},Ce.prototype._getDebugSphereMesh=function(X){return this._debugSphereMesh||(this._debugSphereMesh=E.a.CreateSphere("physicsBodySphereViewMesh",{diameter:1},X),this._debugSphereMesh.rotationQuaternion=T.b.Identity(),this._debugSphereMesh.material=this._getDebugMaterial(X),this._debugSphereMesh.setEnabled(!1)),this._debugSphereMesh.createInstance("physicsBodyBoxViewInstance")},Ce.prototype._getDebugCylinderMesh=function(X){return this._debugCylinderMesh||(this._debugCylinderMesh=L.a.CreateCylinder("physicsBodyCylinderViewMesh",{diameterTop:1,diameterBottom:1,height:1},X),this._debugCylinderMesh.rotationQuaternion=T.b.Identity(),this._debugCylinderMesh.material=this._getDebugMaterial(X),this._debugCylinderMesh.setEnabled(!1)),this._debugCylinderMesh.createInstance("physicsBodyBoxViewInstance")},Ce.prototype._getDebugMeshMesh=function(X,ae){var ee=new l.a(X.name,ae,null,X);return ee.position=T.e.Zero(),ee.setParent(X),ee.material=this._getDebugMaterial(ae),this._debugMeshMeshes.push(ee),ee},Ce.prototype._getDebugMesh=function(X,ae){var ee=this;if(!this._utilityLayer||ae&&ae.parent&&ae.parent.physicsImpostor)return null;var w=null,N=this._utilityLayer.utilityLayerScene;switch(X.type){case F.a.BoxImpostor:w=this._getDebugBoxMesh(N),X.getBoxSizeToRef(w.scaling);break;case F.a.SphereImpostor:w=this._getDebugSphereMesh(N);var W=X.getRadius();w.scaling.x=W*2,w.scaling.y=W*2,w.scaling.z=W*2;break;case F.a.MeshImpostor:ae&&(w=this._getDebugMeshMesh(ae,N));break;case F.a.NoImpostor:if(ae){var $=ae.getChildMeshes().filter(function(le){return le.physicsImpostor?1:0});$.forEach(function(le){var ne=ee._getDebugBoxMesh(N);ne.parent=le})}break;case F.a.CylinderImpostor:w=this._getDebugCylinderMesh(N);var J=X.object.getBoundingInfo();w.scaling.x=J.boundingBox.maximum.x-J.boundingBox.minimum.x,w.scaling.y=J.boundingBox.maximum.y-J.boundingBox.minimum.y,w.scaling.z=J.boundingBox.maximum.z-J.boundingBox.minimum.z;break}return w},Ce.prototype.dispose=function(){for(var X=this._numMeshes,ae=0;ae<X;ae++)this.hideImpostor(this._impostors[0]);this._debugBoxMesh&&this._debugBoxMesh.dispose(),this._debugSphereMesh&&this._debugSphereMesh.dispose(),this._debugCylinderMesh&&this._debugCylinderMesh.dispose(),this._debugMaterial&&this._debugMaterial.dispose(),this._impostors.length=0,this._scene=null,this._physicsEnginePlugin=null,this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null)},Ce}(),k=u(493),Z=function(){function Ce(X){this.ray=X}return Ce.CreateAndShow=function(X,ae,ee){var w=new Ce(X);return w.show(ae,ee),w},Ce.prototype.show=function(X,ae){if(!this._renderFunction&&this.ray){var ee=this.ray;this._renderFunction=this._render.bind(this),this._scene=X,this._renderPoints=[ee.origin,ee.origin.add(ee.direction.scale(ee.length))],this._renderLine=l.a.CreateLines("ray",this._renderPoints,X,!0),this._renderLine.isPickable=!1,this._renderFunction&&this._scene.registerBeforeRender(this._renderFunction)}ae&&this._renderLine&&this._renderLine.color.copyFrom(ae)},Ce.prototype.hide=function(){this._renderFunction&&this._scene&&(this._scene.unregisterBeforeRender(this._renderFunction),this._scene=null,this._renderFunction=null,this._renderLine&&(this._renderLine.dispose(),this._renderLine=null),this._renderPoints=[])},Ce.prototype._render=function(){var X=this.ray;if(!!X){var ae=this._renderPoints[1],ee=Math.min(X.length,1e6);ae.copyFrom(X.direction),ae.scaleInPlace(ee),ae.addInPlace(X.origin),this._renderPoints[0].copyFrom(X.origin),l.a.CreateLines("ray",this._renderPoints,this._scene,!0,this._renderLine)}},Ce.prototype.attachToMesh=function(X,ae,ee,w){var N=this;this._attachedToMesh=X;var W=this.ray;!W||(W.direction||(W.direction=T.e.Zero()),W.origin||(W.origin=T.e.Zero()),w&&(W.length=w),ee||(ee=T.e.Zero()),ae||(ae=new T.e(0,0,-1)),this._scene||(this._scene=X.getScene()),this._meshSpaceDirection?(this._meshSpaceDirection.copyFrom(ae),this._meshSpaceOrigin.copyFrom(ee)):(this._meshSpaceDirection=ae.clone(),this._meshSpaceOrigin=ee.clone()),this._onAfterRenderObserver||(this._onAfterRenderObserver=this._scene.onBeforeRenderObservable.add(function(){return N._updateToMesh()}),this._onAfterStepObserver=this._scene.onAfterStepObservable.add(function(){return N._updateToMesh()})),this._attachedToMesh.computeWorldMatrix(!0),this._updateToMesh())},Ce.prototype.detachFromMesh=function(){this._attachedToMesh&&this._scene&&(this._onAfterRenderObserver&&(this._scene.onBeforeRenderObservable.remove(this._onAfterRenderObserver),this._scene.onAfterStepObservable.remove(this._onAfterStepObserver)),this._attachedToMesh=null,this._onAfterRenderObserver=null,this._onAfterStepObserver=null,this._scene=null)},Ce.prototype._updateToMesh=function(){var X=this.ray;if(!(!this._attachedToMesh||!X)){if(this._attachedToMesh._isDisposed){this.detachFromMesh();return}this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,X.direction),T.e.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),X.origin)}},Ce.prototype.dispose=function(){this.hide(),this.detachFromMesh(),this.ray=null},Ce}(),Y=u(459),U=u(509),Q=u(479),G=u(447),K=u(435),fe=u(617),ce=function(){function Ce(X,ae,ee,w,N,W){w===void 0&&(w=!0),N===void 0&&(N=3),W===void 0&&(W={});var $,J,le,ne,be,Me,Te,Ae,se,te,he,de,Ne,Le;this.skeleton=X,this.mesh=ae,this.autoUpdateBonesMatrices=w,this.renderingGroupId=N,this.options=W,this.color=O.a.White(),this._debugLines=new Array,this._localAxes=null,this._isEnabled=!1,this._obs=null,this._scene=ee,this._ready=!1,W.pauseAnimations=($=W.pauseAnimations)!==null&&$!==void 0?$:!0,W.returnToRest=(J=W.returnToRest)!==null&&J!==void 0?J:!1,W.displayMode=(le=W.displayMode)!==null&&le!==void 0?le:Ce.DISPLAY_LINES,W.displayOptions=(ne=W.displayOptions)!==null&&ne!==void 0?ne:{},W.displayOptions.midStep=(be=W.displayOptions.midStep)!==null&&be!==void 0?be:.235,W.displayOptions.midStepFactor=(Me=W.displayOptions.midStepFactor)!==null&&Me!==void 0?Me:.155,W.displayOptions.sphereBaseSize=(Te=W.displayOptions.sphereBaseSize)!==null&&Te!==void 0?Te:.15,W.displayOptions.sphereScaleUnit=(Ae=W.displayOptions.sphereScaleUnit)!==null&&Ae!==void 0?Ae:2,W.displayOptions.sphereFactor=(se=W.displayOptions.sphereFactor)!==null&&se!==void 0?se:.865,W.displayOptions.spurFollowsChild=(te=W.displayOptions.spurFollowsChild)!==null&&te!==void 0?te:!1,W.displayOptions.showLocalAxes=(he=W.displayOptions.showLocalAxes)!==null&&he!==void 0?he:!1,W.displayOptions.localAxesSize=(de=W.displayOptions.localAxesSize)!==null&&de!==void 0?de:.075,W.computeBonesUsingShaders=(Ne=W.computeBonesUsingShaders)!==null&&Ne!==void 0?Ne:!0,W.useAllBones=(Le=W.useAllBones)!==null&&Le!==void 0?Le:!0;var pe=ae.getVerticesData(G.b.MatricesIndicesKind),He=ae.getVerticesData(G.b.MatricesWeightsKind);if(this._boneIndices=new Set,!W.useAllBones&&pe&&He)for(var rt=0;rt<pe.length;++rt){var ot=pe[rt],et=He[rt];et!==0&&this._boneIndices.add(ot)}this._utilityLayer=new B.a(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;var ht=this.options.displayMode||0;ht>Ce.DISPLAY_SPHERE_AND_SPURS&&(ht=Ce.DISPLAY_LINES),this.displayMode=ht,this.update(),this._bindObs()}return Ce.CreateBoneWeightShader=function(X,ae){var ee,w,N,W,$,J,le=X.skeleton,ne=(ee=X.colorBase)!==null&&ee!==void 0?ee:O.a.Black(),be=(w=X.colorZero)!==null&&w!==void 0?w:O.a.Blue(),Me=(N=X.colorQuarter)!==null&&N!==void 0?N:O.a.Green(),Te=(W=X.colorHalf)!==null&&W!==void 0?W:O.a.Yellow(),Ae=($=X.colorFull)!==null&&$!==void 0?$:O.a.Red(),se=(J=X.targetBoneIndex)!==null&&J!==void 0?J:0;K.a.ShadersStore["boneWeights:"+le.name+"VertexShader"]=`precision highp float;

        attribute vec3 position;
        attribute vec2 uv;

        uniform mat4 view;
        uniform mat4 projection;
        uniform mat4 worldViewProjection;

        #include<bonesDeclaration>
        #if NUM_BONE_INFLUENCERS == 0
            attribute vec4 matricesIndices;
            attribute vec4 matricesWeights;
        #endif

        #include<instancesDeclaration>

        varying vec3 vColor;

        uniform vec3 colorBase;
        uniform vec3 colorZero;
        uniform vec3 colorQuarter;
        uniform vec3 colorHalf;
        uniform vec3 colorFull;

        uniform float targetBoneIndex;

        void main() {
            vec3 positionUpdated = position;

            #include<instancesVertex>
            #include<bonesVertex>

            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);

            vec3 color = colorBase;
            float totalWeight = 0.;
            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){
                totalWeight += matricesWeights[0];
            }
            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){
                totalWeight += matricesWeights[1];
            }
            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){
                totalWeight += matricesWeights[2];
            }
            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){
                totalWeight += matricesWeights[3];
            }

            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));
            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));
            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));
            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));
            vColor = color;

        gl_Position = projection * view * worldPos;
        }`,K.a.ShadersStore["boneWeights:"+le.name+"FragmentShader"]=`
            precision highp float;
            varying vec3 vPosition;

            varying vec3 vColor;

            void main() {
                vec4 color = vec4(vColor, 1.0);
                gl_FragColor = color;
            }
        `;var te=new U.a("boneWeight:"+le.name,ae,{vertex:"boneWeights:"+le.name,fragment:"boneWeights:"+le.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return te.setColor3("colorBase",ne),te.setColor3("colorZero",be),te.setColor3("colorQuarter",Me),te.setColor3("colorHalf",Te),te.setColor3("colorFull",Ae),te.setFloat("targetBoneIndex",se),te.getClassName=function(){return"BoneWeightShader"},te.transparencyMode=Y.a.MATERIAL_OPAQUE,te},Ce.CreateSkeletonMapShader=function(X,ae){var ee,w=X.skeleton,N=(ee=X.colorMap)!==null&&ee!==void 0?ee:[{color:new O.a(1,.38,.18),location:0},{color:new O.a(.59,.18,1),location:.2},{color:new O.a(.59,1,.18),location:.4},{color:new O.a(1,.87,.17),location:.6},{color:new O.a(1,.17,.42),location:.8},{color:new O.a(.17,.68,1),location:1}],W=w.bones.length+1,$=Ce._CreateBoneMapColorBuffer(W,N,ae),J=new U.a("boneWeights:"+w.name,ae,{vertexSource:`precision highp float;

            attribute vec3 position;
            attribute vec2 uv;

            uniform mat4 view;
            uniform mat4 projection;
            uniform mat4 worldViewProjection;
            uniform float colorMap[`+w.bones.length*4+`];

            #include<bonesDeclaration>
            #if NUM_BONE_INFLUENCERS == 0
                attribute vec4 matricesIndices;
                attribute vec4 matricesWeights;
            #endif
            #include<instancesDeclaration>

            varying vec3 vColor;

            void main() {
                vec3 positionUpdated = position;

                #include<instancesVertex>
                #include<bonesVertex>

                vec3 color = vec3(0.);
                bool first = true;

                for (int i = 0; i < 4; i++) {
                    int boneIdx = int(matricesIndices[i]);
                    float boneWgt = matricesWeights[i];

                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);

                    if (boneWgt > 0.) {
                        if (first) {
                            first = false;
                            color = c;
                        } else {
                            color = mix(color, c, boneWgt);
                        }
                    }
                }

                vColor = color;

                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);

                gl_Position = projection * view * worldPos;
            }`,fragmentSource:`
            precision highp float;
            varying vec3 vColor;

            void main() {
                vec4 color = vec4( vColor, 1.0 );
                gl_FragColor = color;
            }
            `},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return J.setFloats("colorMap",$),J.getClassName=function(){return"SkeletonMapShader"},J.transparencyMode=Y.a.MATERIAL_OPAQUE,J},Ce._CreateBoneMapColorBuffer=function(X,ae,ee){var w=new Q.a("temp",{width:X,height:1},ee,!1),N=w.getContext(),W=N.createLinearGradient(0,0,X,0);ae.forEach(function(be){W.addColorStop(be.location,be.color.toHexString())}),N.fillStyle=W,N.fillRect(0,0,X,1),w.update();for(var $=[],J=N.getImageData(0,0,X,1).data,le=1/255,ne=0;ne<J.length;ne++)$.push(J[ne]*le);return w.dispose(),$},Object.defineProperty(Ce.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"utilityLayer",{get:function(){return this._utilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"isReady",{get:function(){return this._ready},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"ready",{set:function(X){this._ready=X},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"debugMesh",{get:function(){return this._debugMesh},set:function(X){this._debugMesh=X},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"displayMode",{get:function(){return this.options.displayMode||Ce.DISPLAY_LINES},set:function(X){X>Ce.DISPLAY_SPHERE_AND_SPURS&&(X=Ce.DISPLAY_LINES),this.options.displayMode=X},enumerable:!1,configurable:!0}),Ce.prototype._bindObs=function(){var X=this;switch(this.displayMode){case Ce.DISPLAY_LINES:{this._obs=this.scene.onBeforeRenderObservable.add(function(){X._displayLinesUpdate()});break}}},Ce.prototype.update=function(){switch(this.displayMode){case Ce.DISPLAY_LINES:{this._displayLinesUpdate();break}case Ce.DISPLAY_SPHERES:{this._buildSpheresAndSpurs(!0);break}case Ce.DISPLAY_SPHERE_AND_SPURS:{this._buildSpheresAndSpurs(!1);break}}this._buildLocalAxes()},Object.defineProperty(Ce.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(X){this.isEnabled!==X&&(this._isEnabled=X,this.debugMesh&&this.debugMesh.setEnabled(X),X&&!this._obs?this._bindObs():!X&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))},enumerable:!1,configurable:!0}),Ce.prototype._getBonePosition=function(X,ae,ee,w,N,W){w===void 0&&(w=0),N===void 0&&(N=0),W===void 0&&(W=0);var $=T.c.Matrix[0],J=ae.getParent();if($.copyFrom(ae.getLocalMatrix()),w!==0||N!==0||W!==0){var le=T.c.Matrix[1];T.a.IdentityToRef(le),le.setTranslationFromFloats(w,N,W),le.multiplyToRef($,$)}J&&$.multiplyToRef(J.getAbsoluteTransform(),$),$.multiplyToRef(ee,$),X.x=$.m[12],X.y=$.m[13],X.z=$.m[14]},Ce.prototype._getLinesForBonesWithLength=function(X,ae){for(var ee=X.length,w=this.mesh._effectiveMesh,N=w.position,W=0,$=0;$<ee;$++){var J=X[$],le=this._debugLines[W];J._index===-1||!this._boneIndices.has(J.getIndex())&&!this.options.useAllBones||(le||(le=[T.e.Zero(),T.e.Zero()],this._debugLines[W]=le),this._getBonePosition(le[0],J,ae),this._getBonePosition(le[1],J,ae,0,J.length,0),le[0].subtractInPlace(N),le[1].subtractInPlace(N),W++)}},Ce.prototype._getLinesForBonesNoLength=function(X){for(var ae=X.length,ee=0,w=this.mesh._effectiveMesh,N=w.position,W=ae-1;W>=0;W--){var $=X[W],J=$.getParent();if(!(!J||!this._boneIndices.has($.getIndex())&&!this.options.useAllBones)){var le=this._debugLines[ee];le||(le=[T.e.Zero(),T.e.Zero()],this._debugLines[ee]=le),$.getAbsolutePositionToRef(w,le[0]),J.getAbsolutePositionToRef(w,le[1]),le[0].subtractInPlace(N),le[1].subtractInPlace(N),ee++}}},Ce.prototype._revert=function(X){this.options.pauseAnimations&&(this.scene.animationsEnabled=X,this.utilityLayer.utilityLayerScene.animationsEnabled=X)},Ce.prototype._getAbsoluteBindPoseToRef=function(X,ae){if(X===null||X._index===-1){ae.copyFrom(T.a.Identity());return}this._getAbsoluteBindPoseToRef(X.getParent(),ae),X.getBindPose().multiplyToRef(ae,ae)},Ce.prototype._buildSpheresAndSpurs=function(X){var ae,ee;X===void 0&&(X=!0),this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;var w=(ae=this.utilityLayer)===null||ae===void 0?void 0:ae.utilityLayerScene,N=this.skeleton.bones,W=[],$=[],J=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,w.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms();for(var le=Number.NEGATIVE_INFINITY,ne=this.options.displayOptions||{},be=function(ot){var et=N[ot];if(et._index===-1||!Me._boneIndices.has(et.getIndex())&&!Me.options.useAllBones)return"continue";var ht=new T.a;Me._getAbsoluteBindPoseToRef(et,ht);var Ee=new T.e;ht.decompose(void 0,void 0,Ee),et.children.forEach(function(zi,li){var Di=new T.a;zi.getBindPose().multiplyToRef(ht,Di);var Zt=new T.e;Di.decompose(void 0,void 0,Zt);var _i=T.e.Distance(Ee,Zt);if(_i>le&&(le=_i),!X){for(var ji=Zt.clone().subtract(Ee.clone()),yi=ji.length(),ai=ji.normalize().scale(yi),Ei=ne.midStep||.165,Gt=ne.midStepFactor||.215,wi=ai.scale(Ei),ui=fe.a.ExtrudeShapeCustom("skeletonViewer",{shape:[new T.e(1,-1,0),new T.e(1,1,0),new T.e(-1,1,0),new T.e(-1,-1,0),new T.e(1,-1,0)],path:[T.e.Zero(),wi,ai],scaleFunction:function(Ji){switch(Ji){case 0:case 2:return 0;case 1:return yi*Gt}return 0},sideOrientation:l.a.DEFAULTSIDE,updatable:!1},w),Wi=ui.getTotalVertices(),Hi=[],Pi=[],It=0;It<Wi;It++)Hi.push(1,0,0,0),ne.spurFollowsChild&&It>9?Pi.push(zi.getIndex(),0,0,0):Pi.push(et.getIndex(),0,0,0);ui.position=Ee.clone(),ui.setVerticesData(G.b.MatricesWeightsKind,Hi,!1),ui.setVerticesData(G.b.MatricesIndicesKind,Pi,!1),ui.convertToFlatShadedMesh(),$.push(ui)}});for(var At=ne.sphereBaseSize||.2,Ht=E.a.CreateSphere("skeletonViewer",{segments:6,diameter:At,updatable:!0},w),Ot=Ht.getTotalVertices(),Ut=[],Qt=[],Zi=0;Zi<Ot;Zi++)Ut.push(1,0,0,0),Qt.push(et.getIndex(),0,0,0);Ht.setVerticesData(G.b.MatricesWeightsKind,Ut,!1),Ht.setVerticesData(G.b.MatricesIndicesKind,Qt,!1),Ht.position=Ee.clone(),W.push([Ht,et])},Me=this,Te=0;Te<N.length;Te++)be(Te);for(var Ae=ne.sphereScaleUnit||2,se=ne.sphereFactor||.85,te=[],Te=0;Te<W.length;Te++){for(var he=W[Te],de=he[0],Ne=he[1],Le=1/(Ae/le),pe=0,He=Ne;He.getParent()&&He.getParent().getIndex()!==-1;)pe++,He=He.getParent();de.scaling.scaleInPlace(Le*Math.pow(se,pe)),te.push(de)}this.debugMesh=l.a.MergeMeshes(te.concat($),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=(ee=this.options.computeBonesUsingShaders)!==null&&ee!==void 0?ee:!0,this.debugMesh.alwaysSelectAsActiveMesh=!0);var rt=this.utilityLayer._getSharedGizmoLight();rt.intensity=.7,this._revert(J),this.ready=!0}catch(ot){console.error(ot),this._revert(J),this.dispose()}},Ce.prototype._buildLocalAxes=function(){var X;this._localAxes&&this._localAxes.dispose(),this._localAxes=null;var ae=this.options.displayOptions||{};if(!!ae.showLocalAxes){var ee=this._utilityLayer.utilityLayerScene,w=ae.localAxesSize||.075,N=[],W=[],$=new O.b(1,0,0,1),J=new O.b(0,1,0,1),le=new O.b(0,0,1,1),ne=[],be=[],Me=6;for(var Te in this.skeleton.bones){var Ae=this.skeleton.bones[Te];if(!(Ae._index===-1||!this._boneIndices.has(Ae.getIndex())&&!this.options.useAllBones)){var se=new T.a,te=new T.e;this._getAbsoluteBindPoseToRef(Ae,se),se.decompose(void 0,void 0,te);var he=Ae.getBindPose().getRotationMatrix(),de=T.e.TransformCoordinates(new T.e(0+w,0,0),he),Ne=T.e.TransformCoordinates(new T.e(0,0+w,0),he),Le=T.e.TransformCoordinates(new T.e(0,0,0+w),he),pe=[te,te.add(de)],He=[te,te.add(Ne)],rt=[te,te.add(Le)],ot=[pe,He,rt],et=[[$,$],[J,J],[le,le]];N.push.apply(N,ot),W.push.apply(W,et);for(var ht=0;ht<Me;ht++)ne.push(1,0,0,0),be.push(Ae.getIndex(),0,0,0)}}this._localAxes=k.a.CreateLineSystem("localAxes",{lines:N,colors:W,updatable:!0},ee),this._localAxes.setVerticesData(G.b.MatricesWeightsKind,ne,!1),this._localAxes.setVerticesData(G.b.MatricesIndicesKind,be,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=(X=this.options.computeBonesUsingShaders)!==null&&X!==void 0?X:!0}},Ce.prototype._displayLinesUpdate=function(){if(!!this._utilityLayer){this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms();var X=this.mesh._effectiveMesh;this.skeleton.bones[0].length===void 0?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,X.getWorldMatrix());var ae=this._utilityLayer.utilityLayerScene;ae&&(this._debugMesh?k.a.CreateLineSystem("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},ae):(this._debugMesh=k.a.CreateLineSystem("",{lines:this._debugLines,updatable:!0,instance:null},ae),this._debugMesh.renderingGroupId=this.renderingGroupId),this._debugMesh.position.copyFrom(this.mesh.position),this._debugMesh.color=this.color)}},Ce.prototype.changeDisplayMode=function(X){var ae=!!this.isEnabled;this.displayMode!==X&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=X,this.update(),this._bindObs(),this.isEnabled=ae)},Ce.prototype.changeDisplayOptions=function(X,ae){var ee=!!this.isEnabled;this.options.displayOptions[X]=ae,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=ee},Ce.prototype.dispose=function(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1},Ce.DISPLAY_LINES=0,Ce.DISPLAY_SPHERES=1,Ce.DISPLAY_SPHERE_AND_SPURS=2,Ce}(),re=u(485),Re=u(499),Ie=function(){function Ce(X,ae){this._oldPosition=new T.e(Number.NaN,Number.NaN,Number.NaN),this._oldDirection=new T.e(Number.NaN,Number.NaN,Number.NaN),this._transparency=.3,this._showLines=!0,this._showPlanes=!0,this._scene=X.getScene(),this._light=X,this._camera=ae,this._inverseViewMatrix=T.a.Identity(),this._lightHelperFrustumMeshes=[],this._createGeometry(),this.show(),this.update()}return Object.defineProperty(Ce.prototype,"transparency",{get:function(){return this._transparency},set:function(X){this._transparency=X;for(var ae=6;ae<12;++ae)this._lightHelperFrustumMeshes[ae].material.alpha=X},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"showLines",{get:function(){return this._showLines},set:function(X){if(this._showLines!==X){this._showLines=X;for(var ae=0;ae<6;++ae)this._lightHelperFrustumMeshes[ae].setEnabled(X)}},enumerable:!1,configurable:!0}),Object.defineProperty(Ce.prototype,"showPlanes",{get:function(){return this._showPlanes},set:function(X){if(this._showPlanes!==X){this._showPlanes=X;for(var ae=6;ae<12;++ae)this._lightHelperFrustumMeshes[ae].setEnabled(X)}},enumerable:!1,configurable:!0}),Ce.prototype.show=function(){var X=this;this._lightHelperFrustumMeshes.forEach(function(ae,ee){ae.setEnabled(ee<6&&X._showLines||ee>=6&&X._showPlanes)}),this._oldPosition.set(Number.NaN,Number.NaN,Number.NaN),this._visible=!0},Ce.prototype.hide=function(){this._lightHelperFrustumMeshes.forEach(function(X){X.setEnabled(!1)}),this._visible=!1},Ce.prototype.update=function(){var X,ae,ee,w,N,W;if(!!this._visible&&!(this._oldPosition.equals(this._light.position)&&this._oldDirection.equals(this._light.direction)&&this._oldAutoCalc===this._light.autoCalcShadowZBounds&&this._oldMinZ===this._light.shadowMinZ&&this._oldMaxZ===this._light.shadowMaxZ)){this._oldPosition.copyFrom(this._light.position),this._oldDirection.copyFrom(this._light.direction),this._oldAutoCalc=this._light.autoCalcShadowZBounds,this._oldMinZ=this._light.shadowMinZ,this._oldMaxZ=this._light.shadowMaxZ,T.c.Vector3[0].set(this._light.orthoLeft,this._light.orthoBottom,this._light.shadowMinZ!==void 0?this._light.shadowMinZ:this._camera.minZ),T.c.Vector3[1].set(this._light.orthoRight,this._light.orthoTop,this._light.shadowMaxZ!==void 0?this._light.shadowMaxZ:this._camera.maxZ);var $=this._getInvertViewMatrix();T.c.Vector3[2].copyFromFloats(T.c.Vector3[1].x,T.c.Vector3[1].y,T.c.Vector3[0].z),T.c.Vector3[3].copyFromFloats(T.c.Vector3[1].x,T.c.Vector3[0].y,T.c.Vector3[0].z),T.c.Vector3[4].copyFromFloats(T.c.Vector3[0].x,T.c.Vector3[0].y,T.c.Vector3[0].z),T.c.Vector3[5].copyFromFloats(T.c.Vector3[0].x,T.c.Vector3[1].y,T.c.Vector3[0].z),T.e.TransformCoordinatesToRef(T.c.Vector3[2],$,T.c.Vector3[2]),T.e.TransformCoordinatesToRef(T.c.Vector3[3],$,T.c.Vector3[3]),T.e.TransformCoordinatesToRef(T.c.Vector3[4],$,T.c.Vector3[4]),T.e.TransformCoordinatesToRef(T.c.Vector3[5],$,T.c.Vector3[5]),T.c.Vector3[6].copyFromFloats(T.c.Vector3[1].x,T.c.Vector3[1].y,T.c.Vector3[1].z),T.c.Vector3[7].copyFromFloats(T.c.Vector3[1].x,T.c.Vector3[0].y,T.c.Vector3[1].z),T.c.Vector3[8].copyFromFloats(T.c.Vector3[0].x,T.c.Vector3[0].y,T.c.Vector3[1].z),T.c.Vector3[9].copyFromFloats(T.c.Vector3[0].x,T.c.Vector3[1].y,T.c.Vector3[1].z),T.e.TransformCoordinatesToRef(T.c.Vector3[6],$,T.c.Vector3[6]),T.e.TransformCoordinatesToRef(T.c.Vector3[7],$,T.c.Vector3[7]),T.e.TransformCoordinatesToRef(T.c.Vector3[8],$,T.c.Vector3[8]),T.e.TransformCoordinatesToRef(T.c.Vector3[9],$,T.c.Vector3[9]),k.a.CreateLines("nearlines",{updatable:!0,points:this._nearLinesPoints,instance:this._lightHelperFrustumMeshes[0]},this._scene),k.a.CreateLines("farlines",{updatable:!0,points:this._farLinesPoints,instance:this._lightHelperFrustumMeshes[1]},this._scene),k.a.CreateLines("trlines",{updatable:!0,points:this._trLinesPoints,instance:this._lightHelperFrustumMeshes[2]},this._scene),k.a.CreateLines("brlines",{updatable:!0,points:this._brLinesPoints,instance:this._lightHelperFrustumMeshes[3]},this._scene),k.a.CreateLines("tllines",{updatable:!0,points:this._tlLinesPoints,instance:this._lightHelperFrustumMeshes[4]},this._scene),k.a.CreateLines("bllines",{updatable:!0,points:this._blLinesPoints,instance:this._lightHelperFrustumMeshes[5]},this._scene),T.c.Vector3[2].toArray(this._nearPlaneVertices,0),T.c.Vector3[3].toArray(this._nearPlaneVertices,3),T.c.Vector3[4].toArray(this._nearPlaneVertices,6),T.c.Vector3[5].toArray(this._nearPlaneVertices,9),(X=this._lightHelperFrustumMeshes[6].geometry)===null||X===void 0||X.updateVerticesDataDirectly("position",this._nearPlaneVertices,0),T.c.Vector3[6].toArray(this._farPlaneVertices,0),T.c.Vector3[7].toArray(this._farPlaneVertices,3),T.c.Vector3[8].toArray(this._farPlaneVertices,6),T.c.Vector3[9].toArray(this._farPlaneVertices,9),(ae=this._lightHelperFrustumMeshes[7].geometry)===null||ae===void 0||ae.updateVerticesDataDirectly("position",this._farPlaneVertices,0),T.c.Vector3[2].toArray(this._rightPlaneVertices,0),T.c.Vector3[6].toArray(this._rightPlaneVertices,3),T.c.Vector3[7].toArray(this._rightPlaneVertices,6),T.c.Vector3[3].toArray(this._rightPlaneVertices,9),(ee=this._lightHelperFrustumMeshes[8].geometry)===null||ee===void 0||ee.updateVerticesDataDirectly("position",this._rightPlaneVertices,0),T.c.Vector3[5].toArray(this._leftPlaneVertices,0),T.c.Vector3[9].toArray(this._leftPlaneVertices,3),T.c.Vector3[8].toArray(this._leftPlaneVertices,6),T.c.Vector3[4].toArray(this._leftPlaneVertices,9),(w=this._lightHelperFrustumMeshes[9].geometry)===null||w===void 0||w.updateVerticesDataDirectly("position",this._leftPlaneVertices,0),T.c.Vector3[2].toArray(this._topPlaneVertices,0),T.c.Vector3[6].toArray(this._topPlaneVertices,3),T.c.Vector3[9].toArray(this._topPlaneVertices,6),T.c.Vector3[5].toArray(this._topPlaneVertices,9),(N=this._lightHelperFrustumMeshes[10].geometry)===null||N===void 0||N.updateVerticesDataDirectly("position",this._topPlaneVertices,0),T.c.Vector3[3].toArray(this._bottomPlaneVertices,0),T.c.Vector3[7].toArray(this._bottomPlaneVertices,3),T.c.Vector3[8].toArray(this._bottomPlaneVertices,6),T.c.Vector3[4].toArray(this._bottomPlaneVertices,9),(W=this._lightHelperFrustumMeshes[11].geometry)===null||W===void 0||W.updateVerticesDataDirectly("position",this._bottomPlaneVertices,0)}},Ce.prototype.dispose=function(){this._lightHelperFrustumMeshes.forEach(function(X){var ae;(ae=X.material)===null||ae===void 0||ae.dispose(),X.dispose()}),this._rootNode.dispose()},Ce.prototype._createGeometry=function(){var X=this;this._rootNode=new Re.a("directionalLightHelperRoot_"+this._light.name,this._scene),this._rootNode.parent=this._light.parent,this._nearLinesPoints=[T.e.ZeroReadOnly,T.e.ZeroReadOnly,T.e.ZeroReadOnly,T.e.ZeroReadOnly,T.e.ZeroReadOnly];var ae=k.a.CreateLines("nearlines",{updatable:!0,points:this._nearLinesPoints},this._scene);ae.parent=this._rootNode,ae.alwaysSelectAsActiveMesh=!0,this._farLinesPoints=[T.e.ZeroReadOnly,T.e.ZeroReadOnly,T.e.ZeroReadOnly,T.e.ZeroReadOnly,T.e.ZeroReadOnly];var ee=k.a.CreateLines("farlines",{updatable:!0,points:this._farLinesPoints},this._scene);ee.parent=this._rootNode,ee.alwaysSelectAsActiveMesh=!0,this._trLinesPoints=[T.e.ZeroReadOnly,T.e.ZeroReadOnly];var w=k.a.CreateLines("trlines",{updatable:!0,points:this._trLinesPoints},this._scene);w.parent=this._rootNode,w.alwaysSelectAsActiveMesh=!0,this._brLinesPoints=[T.e.ZeroReadOnly,T.e.ZeroReadOnly];var N=k.a.CreateLines("brlines",{updatable:!0,points:this._brLinesPoints},this._scene);N.parent=this._rootNode,N.alwaysSelectAsActiveMesh=!0,this._tlLinesPoints=[T.e.ZeroReadOnly,T.e.ZeroReadOnly];var W=k.a.CreateLines("tllines",{updatable:!0,points:this._tlLinesPoints},this._scene);W.parent=this._rootNode,W.alwaysSelectAsActiveMesh=!0,this._blLinesPoints=[T.e.ZeroReadOnly,T.e.ZeroReadOnly];var $=k.a.CreateLines("bllines",{updatable:!0,points:this._blLinesPoints},this._scene);$.parent=this._rootNode,$.alwaysSelectAsActiveMesh=!0,this._lightHelperFrustumMeshes.push(ae,ee,w,N,W,$);var J=function(le,ne,be){var Me=new l.a(le+"plane",X._scene),Te=new S.a(le+"PlaneMat",X._scene);Me.material=Te,Me.parent=X._rootNode,Me.alwaysSelectAsActiveMesh=!0,Te.emissiveColor=ne,Te.alpha=X.transparency,Te.backFaceCulling=!1,Te.disableLighting=!0;var Ae=[0,1,2,0,2,3],se=new re.a;se.positions=be,se.indices=Ae,se.applyToMesh(Me,!0),X._lightHelperFrustumMeshes.push(Me)};this._nearPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._farPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._rightPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._leftPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._topPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._bottomPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],J("near",new O.a(1,0,0),this._nearPlaneVertices),J("far",new O.a(.3,0,0),this._farPlaneVertices),J("right",new O.a(0,1,0),this._rightPlaneVertices),J("left",new O.a(0,.3,0),this._leftPlaneVertices),J("top",new O.a(0,0,1),this._topPlaneVertices),J("bottom",new O.a(0,0,.3),this._bottomPlaneVertices),this._nearLinesPoints[0]=T.c.Vector3[2],this._nearLinesPoints[1]=T.c.Vector3[3],this._nearLinesPoints[2]=T.c.Vector3[4],this._nearLinesPoints[3]=T.c.Vector3[5],this._nearLinesPoints[4]=T.c.Vector3[2],this._farLinesPoints[0]=T.c.Vector3[6],this._farLinesPoints[1]=T.c.Vector3[7],this._farLinesPoints[2]=T.c.Vector3[8],this._farLinesPoints[3]=T.c.Vector3[9],this._farLinesPoints[4]=T.c.Vector3[6],this._trLinesPoints[0]=T.c.Vector3[2],this._trLinesPoints[1]=T.c.Vector3[6],this._brLinesPoints[0]=T.c.Vector3[3],this._brLinesPoints[1]=T.c.Vector3[7],this._tlLinesPoints[0]=T.c.Vector3[4],this._tlLinesPoints[1]=T.c.Vector3[8],this._blLinesPoints[0]=T.c.Vector3[5],this._blLinesPoints[1]=T.c.Vector3[9]},Ce.prototype._getInvertViewMatrix=function(){return T.a.LookAtLHToRef(this._light.position,this._light.position.add(this._light.direction),T.e.UpReadOnly,this._inverseViewMatrix),this._inverseViewMatrix.invertToRef(this._inverseViewMatrix),this._inverseViewMatrix},Ce}()},679:function(Ue,P,u){"use strict";var T=u(435),S=u(535),j="bayerDitherFunctions",O=`




float bayerDither2(vec2 _P) {
return mod(2.0*_P.y+_P.x+1.0,4.0);
}


float bayerDither4(vec2 _P) {
vec2 P1=mod(_P,2.0);
vec2 P2=floor(0.5*mod(_P,4.0));
return 4.0*bayerDither2(P1)+bayerDither2(P2);
}

float bayerDither8(vec2 _P) {
vec2 P1=mod(_P,2.0);
vec2 P2=floor(0.5*mod(_P,4.0));
vec2 P4=floor(0.25*mod(_P,8.0));
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);
}
`;T.a.IncludesShadersStore[j]=O;var M={name:j,shader:O},H="shadowMapFragmentDeclaration",A=`#if SM_FLOAT == 0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW == 1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE == 1
uniform vec3 lightDataSM;
varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP == 1
varying float zSM;
#endif
`;T.a.IncludesShadersStore[H]=A;var p={name:H,shader:A},f=u(592),h=u(550),m="shadowMapFragment",d=` float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP == 1
#if SM_USEDISTANCE == 1
depthSM=clamp(((length(vPositionWSM-lightDataSM)+depthValuesSM.x)/(depthValuesSM.y))+biasAndScaleSM.x,0.0,1.0);
#else
depthSM=clamp(((zSM+depthValuesSM.x)/(depthValuesSM.y))+biasAndScaleSM.x,0.0,1.0);
#endif
gl_FragDepth=depthSM;
#elif SM_USEDISTANCE == 1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/(depthValuesSM.y)+biasAndScaleSM.x;
#endif
#if SM_ESM == 1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT == 1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;T.a.IncludesShadersStore[m]=d;var g={name:m,shader:d},v="shadowMapPixelShader",l=`#include<shadowMapFragmentDeclaration>
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
if (alphaFromAlphaTexture<0.4)
discard;
#endif
#if SM_SOFTTRANSPARENTSHADOW == 1
#ifdef ALPHATEST
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;T.a.ShadersStore[v]=l;var y={name:v,shader:l}},680:function(Ue,P,u){"use strict";var T=u(435),S=u(487),j=u(496),O=u(497),M=u(501),H=u(457),A="shadowMapVertexDeclaration",p=`#if SM_NORMALBIAS == 1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
varying float vDepthMetricSM;
#if SM_USEDISTANCE == 1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP == 1
varying float zSM;
#endif
`;T.a.IncludesShadersStore[A]=p;var f={name:A,shader:p},h=u(593),m=u(507),d=u(508),g=u(488),v=u(489),l="shadowMapVertexNormalBias",y=`
#if SM_NORMALBIAS == 1
#if SM_DIRECTIONINLIGHTDATA == 1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;
vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);
float sinNLSM=sqrt(1.0-ndlSM*ndlSM);
float normalBiasSM=biasAndScaleSM.y*sinNLSM;
worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;T.a.IncludesShadersStore[l]=y;var E={name:l,shader:y},R="shadowMapVertexMetric",F=`#if SM_USEDISTANCE == 1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE == 1

gl_Position.z+=biasAndScaleSM.x*gl_Position.w;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP == 1
zSM=gl_Position.z;
gl_Position.z=0.0;
#elif SM_USEDISTANCE == 0

vDepthMetricSM=((gl_Position.z+depthValuesSM.x)/(depthValuesSM.y))+biasAndScaleSM.x;
#endif
`;T.a.IncludesShadersStore[R]=F;var B={name:R,shader:F},L=u(551),I="shadowMapVertexShader",k=`
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

#include<instancesDeclaration>
#include<helperFunctions>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexDeclaration>
#include<clipPlaneVertexDeclaration>
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));
vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>

gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;T.a.ShadersStore[I]=k;var Z={name:I,shader:k}},694:function(Ue,P,u){"use strict";u.d(P,"a",function(){return M});var T=u(541),S=u(628),j=u(452),O=u(468);O.a.AddParser(j.a.NAME_SHADOWGENERATOR,function(H,A){if(H.shadowGenerators!==void 0&&H.shadowGenerators!==null)for(var p=0,f=H.shadowGenerators.length;p<f;p++){var h=H.shadowGenerators[p];h.className===S.a.CLASSNAME?S.a.Parse(h,A):T.a.Parse(h,A)}});var M=function(){function H(A){this.name=j.a.NAME_SHADOWGENERATOR,this.scene=A}return H.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(j.a.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)},H.prototype.rebuild=function(){},H.prototype.serialize=function(A){A.shadowGenerators=[];for(var p=this.scene.lights,f=0,h=p;f<h.length;f++){var m=h[f],d=m.getShadowGenerator();d&&A.shadowGenerators.push(d.serialize())}},H.prototype.addFromContainer=function(A){},H.prototype.removeFromContainer=function(A,p){},H.prototype.dispose=function(){},H.prototype._gatherRenderTargets=function(A){var p=this.scene;if(this.scene.shadowsEnabled)for(var f=0;f<p.lights.length;f++){var h=p.lights[f],m=h.getShadowGenerator();if(h.isEnabled()&&h.shadowEnabled&&m){var d=m.getShadowMap();p.textures.indexOf(d)!==-1&&A.push(d)}}},H}();T.a._SceneComponentInitialization=function(H){var A=H._getComponent(j.a.NAME_SHADOWGENERATOR);A||(A=new M(H),H._addComponent(A))}},695:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});var T=u(445),S=function(){function j(O,M,H){var A=this;M===void 0&&(M=""),H===void 0&&(H="black"),this._renderingCanvas=O,this._loadingText=M,this._loadingDivBackgroundColor=H,this._resizeLoadingUI=function(){var p=A._renderingCanvas.getBoundingClientRect(),f=window.getComputedStyle(A._renderingCanvas).position;!A._loadingDiv||(A._loadingDiv.style.position=f==="fixed"?"fixed":"absolute",A._loadingDiv.style.left=p.left+"px",A._loadingDiv.style.top=p.top+"px",A._loadingDiv.style.width=p.width+"px",A._loadingDiv.style.height=p.height+"px")}}return j.prototype.displayLoadingUI=function(){if(!this._loadingDiv){this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText;var O=document.createElement("style");O.type="text/css";var M=`@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}
                    100% { -webkit-transform: rotate(360deg);}
                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}
                    100% { transform: rotate(360deg);}
                }`;O.innerHTML=M,document.getElementsByTagName("head")[0].appendChild(O);var H=!!window.SVGSVGElement,A=new Image;j.DefaultLogoUrl?A.src=j.DefaultLogoUrl:A.src=H?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",A.style.width="150px",A.style.gridColumn="1",A.style.gridRow="1",A.style.top="50%",A.style.left="50%",A.style.transform="translate(-50%, -50%)",A.style.position="absolute";var p=document.createElement("div");p.style.width="300px",p.style.gridColumn="1",p.style.gridRow="1",p.style.top="50%",p.style.left="50%",p.style.transform="translate(-50%, -50%)",p.style.position="absolute";var f=new Image;if(j.DefaultSpinnerUrl?f.src=j.DefaultSpinnerUrl:f.src=H?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",f.style.animation="spin1 0.75s infinite linear",f.style.webkitAnimation="spin1 0.75s infinite linear",f.style.transformOrigin="50% 50%",f.style.webkitTransformOrigin="50% 50%",!H){var h={w:16,h:18.5},m={w:30,h:30};A.style.width=h.w+"vh",A.style.height=h.h+"vh",A.style.left="calc(50% - "+h.w/2+"vh)",A.style.top="calc(50% - "+h.h/2+"vh)",f.style.width=m.w+"vh",f.style.height=m.h+"vh",f.style.left="calc(50% - "+m.w/2+"vh)",f.style.top="calc(50% - "+m.h/2+"vh)"}p.appendChild(f),this._loadingDiv.appendChild(A),this._loadingDiv.appendChild(p),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}},j.prototype.hideLoadingUI=function(){var O=this;if(!!this._loadingDiv){var M=function(){!O._loadingDiv||(O._loadingDiv.parentElement&&O._loadingDiv.parentElement.removeChild(O._loadingDiv),window.removeEventListener("resize",O._resizeLoadingUI),O._loadingDiv=null)};this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",M)}},Object.defineProperty(j.prototype,"loadingUIText",{get:function(){return this._loadingText},set:function(O){this._loadingText=O,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)},enumerable:!1,configurable:!0}),Object.defineProperty(j.prototype,"loadingUIBackgroundColor",{get:function(){return this._loadingDivBackgroundColor},set:function(O){this._loadingDivBackgroundColor=O,!!this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)},enumerable:!1,configurable:!0}),j.DefaultLogoUrl="",j.DefaultSpinnerUrl="",j}();T.a.DefaultLoadingScreenFactory=function(j){return new S(j)}},696:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(443),S=u(575),j=u(485);function O(p){return new Promise(function(f){DracoDecoderModule({wasmBinary:p}).then(function(h){f({module:h})})})}function M(p,f,h,m,d){var g=new p.DecoderBuffer;g.Init(f,f.byteLength);var v=new p.Decoder,l,y;try{var E=v.GetEncodedGeometryType(g);switch(E){case p.TRIANGULAR_MESH:l=new p.Mesh,y=v.DecodeBufferToMesh(g,l);break;case p.POINT_CLOUD:l=new p.PointCloud,y=v.DecodeBufferToPointCloud(g,l);break;default:throw new Error("Invalid geometry type "+E)}if(!y.ok()||!l.ptr)throw new Error(y.error_msg());if(E===p.TRIANGULAR_MESH){var R=l.num_faces(),F=R*3,B=F*4,L=p._malloc(B);try{v.GetTrianglesUInt32Array(l,B,L);var I=new Uint32Array(F);I.set(new Uint32Array(p.HEAPF32.buffer,L,F)),m(I)}finally{p._free(L)}}var k=function(G,K){var fe=K.num_components(),ce=l.num_points(),re=ce*fe,Re=re*Float32Array.BYTES_PER_ELEMENT,Ie=p._malloc(Re);try{v.GetAttributeDataArrayForAllPoints(l,K,p.DT_FLOAT32,Re,Ie);var Ce=new Float32Array(p.HEAPF32.buffer,Ie,re);if(G==="color"&&fe===3){for(var X=new Float32Array(ce*4),ae=0,ee=0;ae<X.length;ae+=4,ee+=fe)X[ae+0]=Ce[ee+0],X[ae+1]=Ce[ee+1],X[ae+2]=Ce[ee+2],X[ae+3]=1;d(G,X)}else{var X=new Float32Array(re);X.set(new Float32Array(p.HEAPF32.buffer,Ie,re)),d(G,X)}}finally{p._free(Ie)}};if(h)for(var Z in h){var Y=h[Z],U=v.GetAttributeByUniqueId(l,Y);k(Z,U)}else{var Q={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(var Z in Q){var Y=v.GetAttributeId(l,p[Q[Z]]);if(Y!==-1){var U=v.GetAttribute(l,Y);k(Z,U)}}}}finally{l&&p.destroy(l),p.destroy(v),p.destroy(g)}}function H(){var p;onmessage=function(f){var h=f.data;switch(h.id){case"init":{var m=h.decoder;m.url&&(importScripts(m.url),p=DracoDecoderModule({wasmBinary:m.wasmBinary})),postMessage("done");break}case"decodeMesh":{if(!p)throw new Error("Draco decoder module is not available");p.then(function(d){M(d,h.dataView,h.attributes,function(g){postMessage({id:"indices",value:g},[g.buffer])},function(g,v){postMessage({id:g,value:v},[v.buffer])}),postMessage("done")});break}}}}var A=function(){function p(f){f===void 0&&(f=p.DefaultNumWorkers);var h=p.Configuration.decoder,m=h.wasmUrl&&h.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:h.wasmUrl,wasmBinaryPromise:T.b.LoadFileAsync(h.wasmBinaryUrl)}:{url:h.fallbackUrl,wasmBinaryPromise:Promise.resolve(void 0)};f&&typeof Worker=="function"?this._workerPoolPromise=m.wasmBinaryPromise.then(function(d){for(var g=M+"("+H+")()",v=URL.createObjectURL(new Blob([g],{type:"application/javascript"})),l=new Array(f),y=0;y<l.length;y++)l[y]=new Promise(function(E,R){var F=new Worker(v),B=function(I){F.removeEventListener("error",B),F.removeEventListener("message",L),R(I)},L=function(I){I.data==="done"&&(F.removeEventListener("error",B),F.removeEventListener("message",L),E(F))};F.addEventListener("error",B),F.addEventListener("message",L),F.postMessage({id:"init",decoder:{url:m.url,wasmBinary:d}})});return Promise.all(l).then(function(E){return new S.a(E)})}):this._decoderModulePromise=m.wasmBinaryPromise.then(function(d){if(!m.url)throw new Error("Draco decoder module is not available");return T.b.LoadScriptAsync(m.url).then(function(){return O(d)})})}return Object.defineProperty(p,"DecoderAvailable",{get:function(){var f=p.Configuration.decoder;return!!(f.wasmUrl&&f.wasmBinaryUrl&&typeof WebAssembly=="object"||f.fallbackUrl)},enumerable:!1,configurable:!0}),p.GetDefaultNumWorkers=function(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)},Object.defineProperty(p,"Default",{get:function(){return p._Default||(p._Default=new p),p._Default},enumerable:!1,configurable:!0}),p.prototype.dispose=function(){this._workerPoolPromise&&this._workerPoolPromise.then(function(f){f.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise},p.prototype.whenReadyAsync=function(){return this._workerPoolPromise?this._workerPoolPromise.then(function(){}):this._decoderModulePromise?this._decoderModulePromise.then(function(){}):Promise.resolve()},p.prototype.decodeMeshAsync=function(f,h){var m=f instanceof ArrayBuffer?new Uint8Array(f):f;if(this._workerPoolPromise)return this._workerPoolPromise.then(function(d){return new Promise(function(g,v){d.push(function(l,y){var E=new j.a,R=function(L){l.removeEventListener("error",R),l.removeEventListener("message",F),v(L),y()},F=function(L){L.data==="done"?(l.removeEventListener("error",R),l.removeEventListener("message",F),g(E),y()):L.data.id==="indices"?E.indices=L.data.value:E.set(L.data.value,L.data.id)};l.addEventListener("error",R),l.addEventListener("message",F);var B=new Uint8Array(m.byteLength);B.set(new Uint8Array(m.buffer,m.byteOffset,m.byteLength)),l.postMessage({id:"decodeMesh",dataView:B,attributes:h},[B.buffer])})})});if(this._decoderModulePromise)return this._decoderModulePromise.then(function(d){var g=new j.a;return M(d.module,m,h,function(v){g.indices=v},function(v,l){g.set(l,v)}),g});throw new Error("Draco decoder module is not available")},p.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},p.DefaultNumWorkers=p.GetDefaultNumWorkers(),p._Default=null,p}()},698:function(Ue,P,u){"use strict";u.d(P,"a",function(){return T});var T=function(){function S(){var j=this;this.promise=new Promise(function(O,M){j._resolve=O,j._reject=M})}return Object.defineProperty(S.prototype,"resolve",{get:function(){return this._resolve},enumerable:!1,configurable:!0}),Object.defineProperty(S.prototype,"reject",{get:function(){return this._reject},enumerable:!1,configurable:!0}),S}()},699:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});var T=u(473),S=function(){function j(O){this.byteOffset=0,this.buffer=O}return j.prototype.loadAsync=function(O){var M=this;return this.buffer.readAsync(this.byteOffset,O).then(function(H){M._dataView=new DataView(H.buffer,H.byteOffset,H.byteLength),M._dataByteOffset=0})},j.prototype.readUint32=function(){var O=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,O},j.prototype.readUint8Array=function(O){var M=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,O);return this._dataByteOffset+=O,this.byteOffset+=O,M},j.prototype.readString=function(O){return T.a.Decode(this.readUint8Array(O))},j.prototype.skipBytes=function(O){this._dataByteOffset+=O,this.byteOffset+=O},j}()},704:function(Ue,P,u){"use strict";u.r(P),u.d(P,"AbstractScene",function(){return T.a}),u.d(P,"AbstractActionManager",function(){return S.a}),u.d(P,"Action",function(){return j.a}),u.d(P,"ActionEvent",function(){return O.a}),u.d(P,"ActionManager",function(){return M.a}),u.d(P,"Condition",function(){return H.a}),u.d(P,"ValueCondition",function(){return H.d}),u.d(P,"PredicateCondition",function(){return H.b}),u.d(P,"StateCondition",function(){return H.c}),u.d(P,"SwitchBooleanAction",function(){return A.j}),u.d(P,"SetStateAction",function(){return A.g}),u.d(P,"SetValueAction",function(){return A.h}),u.d(P,"IncrementValueAction",function(){return A.d}),u.d(P,"PlayAnimationAction",function(){return A.e}),u.d(P,"StopAnimationAction",function(){return A.i}),u.d(P,"DoNothingAction",function(){return A.b}),u.d(P,"CombineAction",function(){return A.a}),u.d(P,"ExecuteCodeAction",function(){return A.c}),u.d(P,"SetParentAction",function(){return A.f}),u.d(P,"PlaySoundAction",function(){return h}),u.d(P,"StopSoundAction",function(){return m}),u.d(P,"InterpolateValueAction",function(){return E}),u.d(P,"Animatable",function(){return R.a}),u.d(P,"_IAnimationState",function(){return y.b}),u.d(P,"Animation",function(){return y.a}),u.d(P,"TargetedAnimation",function(){return F.b}),u.d(P,"AnimationGroup",function(){return F.a}),u.d(P,"AnimationPropertiesOverride",function(){return B}),u.d(P,"EasingFunction",function(){return L.f}),u.d(P,"CircleEase",function(){return L.d}),u.d(P,"BackEase",function(){return L.a}),u.d(P,"BounceEase",function(){return L.c}),u.d(P,"CubicEase",function(){return L.e}),u.d(P,"ElasticEase",function(){return L.g}),u.d(P,"ExponentialEase",function(){return L.h}),u.d(P,"PowerEase",function(){return L.i}),u.d(P,"QuadraticEase",function(){return L.j}),u.d(P,"QuarticEase",function(){return L.k}),u.d(P,"QuinticEase",function(){return L.l}),u.d(P,"SineEase",function(){return L.m}),u.d(P,"BezierCurveEase",function(){return L.b}),u.d(P,"RuntimeAnimation",function(){return I.a}),u.d(P,"AnimationEvent",function(){return k}),u.d(P,"AnimationKeyInterpolation",function(){return Z.a}),u.d(P,"AnimationRange",function(){return Y.a}),u.d(P,"PathCursor",function(){return U}),u.d(P,"KeepAssets",function(){return Q.c}),u.d(P,"InstantiatedEntries",function(){return Q.b}),u.d(P,"AssetContainer",function(){return Q.a}),u.d(P,"Analyser",function(){return K}),u.d(P,"AudioEngine",function(){return ce}),u.d(P,"AudioSceneComponent",function(){return w}),u.d(P,"Sound",function(){return Ie}),u.d(P,"SoundTrack",function(){return Ce}),u.d(P,"WeightedSound",function(){return N}),u.d(P,"AutoRotationBehavior",function(){return W.a}),u.d(P,"BouncingBehavior",function(){return $.a}),u.d(P,"FramingBehavior",function(){return J.a}),u.d(P,"AttachToBoxBehavior",function(){return ne}),u.d(P,"FadeInOutBehavior",function(){return be}),u.d(P,"MultiPointerScaleBehavior",function(){return Te}),u.d(P,"PointerDragBehavior",function(){return Me.a}),u.d(P,"SixDofDragBehavior",function(){return de}),u.d(P,"Bone",function(){return Ne.a}),u.d(P,"BoneIKController",function(){return pe}),u.d(P,"BoneLookController",function(){return rt}),u.d(P,"Skeleton",function(){return ot.a}),u.d(P,"BaseCameraMouseWheelInput",function(){return et.a}),u.d(P,"BaseCameraPointersInput",function(){return ht.a}),u.d(P,"ArcRotateCameraGamepadInput",function(){return Qt}),u.d(P,"ArcRotateCameraKeyboardMoveInput",function(){return Zi.a}),u.d(P,"ArcRotateCameraMouseWheelInput",function(){return zi.a}),u.d(P,"ArcRotateCameraPointersInput",function(){return li.a}),u.d(P,"ArcRotateCameraVRDeviceOrientationInput",function(){return Zt}),u.d(P,"FlyCameraKeyboardInput",function(){return ji}),u.d(P,"FlyCameraMouseInput",function(){return yi}),u.d(P,"FollowCameraKeyboardMoveInput",function(){return ai}),u.d(P,"FollowCameraMouseWheelInput",function(){return Ei}),u.d(P,"FollowCameraPointersInput",function(){return Gt}),u.d(P,"FreeCameraDeviceOrientationInput",function(){return ui}),u.d(P,"FreeCameraGamepadInput",function(){return Wi}),u.d(P,"FreeCameraKeyboardMoveInput",function(){return Hi.a}),u.d(P,"FreeCameraMouseInput",function(){return Pi.a}),u.d(P,"FreeCameraMouseWheelInput",function(){return It.a}),u.d(P,"FreeCameraTouchInput",function(){return Ji.a}),u.d(P,"FreeCameraVirtualJoystickInput",function(){return dr}),u.d(P,"CameraInputTypes",function(){return At.a}),u.d(P,"CameraInputsManager",function(){return At.b}),u.d(P,"Camera",function(){return te.a}),u.d(P,"TargetCamera",function(){return Ii.a}),u.d(P,"FreeCamera",function(){return kt.a}),u.d(P,"FreeCameraInputsManager",function(){return wi.a}),u.d(P,"TouchCamera",function(){return sr}),u.d(P,"ArcRotateCamera",function(){return Ai.a}),u.d(P,"ArcRotateCameraInputsManager",function(){return Di.a}),u.d(P,"DeviceOrientationCamera",function(){return pr}),u.d(P,"FlyCamera",function(){return Vi}),u.d(P,"FlyCameraInputsManager",function(){return Er}),u.d(P,"FollowCamera",function(){return Pr}),u.d(P,"ArcFollowCamera",function(){return mr}),u.d(P,"FollowCameraInputsManager",function(){return $i}),u.d(P,"GamepadCamera",function(){return ln}),u.d(P,"AnaglyphArcRotateCamera",function(){return jn}),u.d(P,"AnaglyphFreeCamera",function(){return Wn}),u.d(P,"AnaglyphGamepadCamera",function(){return Fa}),u.d(P,"AnaglyphUniversalCamera",function(){return Ba}),u.d(P,"StereoscopicArcRotateCamera",function(){return Xn}),u.d(P,"StereoscopicFreeCamera",function(){return Yn}),u.d(P,"StereoscopicGamepadCamera",function(){return Va}),u.d(P,"StereoscopicUniversalCamera",function(){return Ua}),u.d(P,"UniversalCamera",function(){return Ir}),u.d(P,"VirtualJoysticksCamera",function(){return Ga}),u.d(P,"VRCameraMetrics",function(){return Lr}),u.d(P,"VRDeviceOrientationArcRotateCamera",function(){return Ha}),u.d(P,"VRDeviceOrientationFreeCamera",function(){return Jn}),u.d(P,"VRDeviceOrientationGamepadCamera",function(){return ka}),u.d(P,"OnAfterEnteringVRObservableEvent",function(){return Ka}),u.d(P,"VRExperienceHelper",function(){return We}),u.d(P,"WebVRFreeCamera",function(){return qn}),u.d(P,"Collider",function(){return Ve}),u.d(P,"DefaultCollisionCoordinator",function(){return dt}),u.d(P,"PickingInfo",function(){return vt.a}),u.d(P,"IntersectionInfo",function(){return ut.a}),u.d(P,"_MeshCollisionData",function(){return Yt.a}),u.d(P,"BoundingBox",function(){return pt.a}),u.d(P,"BoundingInfo",function(){return Ye.a}),u.d(P,"BoundingSphere",function(){return Pt.a}),u.d(P,"Octree",function(){return _t}),u.d(P,"OctreeBlock",function(){return ri}),u.d(P,"OctreeSceneComponent",function(){return qt}),u.d(P,"Ray",function(){return Jt.a}),u.d(P,"AxesViewer",function(){return mi.AxesViewer}),u.d(P,"BoneAxesViewer",function(){return mi.BoneAxesViewer}),u.d(P,"DebugLayerTab",function(){return mi.DebugLayerTab}),u.d(P,"DebugLayer",function(){return mi.DebugLayer}),u.d(P,"PhysicsViewer",function(){return mi.PhysicsViewer}),u.d(P,"RayHelper",function(){return mi.RayHelper}),u.d(P,"SkeletonViewer",function(){return mi.SkeletonViewer}),u.d(P,"DirectionalLightFrustumViewer",function(){return mi.DirectionalLightFrustumViewer}),u.d(P,"DeviceInputSystem",function(){return wr.a}),u.d(P,"DeviceType",function(){return Ri.a}),u.d(P,"PointerInput",function(){return Ri.c}),u.d(P,"DualShockInput",function(){return Ri.b}),u.d(P,"XboxInput",function(){return Ri.e}),u.d(P,"SwitchInput",function(){return Ri.d}),u.d(P,"DeviceSource",function(){return Pn}),u.d(P,"DeviceSourceManager",function(){return mp}),u.d(P,"Constants",function(){return gp}),u.d(P,"ThinEngine",function(){return fn.a}),u.d(P,"Engine",function(){return G.a}),u.d(P,"EngineStore",function(){return Kt.a}),u.d(P,"NullEngineOptions",function(){return Qa.b}),u.d(P,"NullEngine",function(){return Qa.a}),u.d(P,"_OcclusionDataStorage",function(){return Bl}),u.d(P,"_forceTransformFeedbackToBundle",function(){return vp}),u.d(P,"EngineView",function(){return _p}),u.d(P,"WebGLPipelineContext",function(){return bp.a}),u.d(P,"PowerPreference",function(){return Za}),u.d(P,"FeatureName",function(){return io}),u.d(P,"BufferUsage",function(){return Fi}),u.d(P,"MapMode",function(){return Vo}),u.d(P,"TextureDimension",function(){return Vr}),u.d(P,"TextureUsage",function(){return ei}),u.d(P,"TextureViewDimension",function(){return Oi}),u.d(P,"TextureAspect",function(){return qr}),u.d(P,"TextureFormat",function(){return De}),u.d(P,"AddressMode",function(){return hn}),u.d(P,"FilterMode",function(){return yt}),u.d(P,"CompareFunction",function(){return ti}),u.d(P,"ShaderStage",function(){return ro}),u.d(P,"BufferBindingType",function(){return Uo}),u.d(P,"SamplerBindingType",function(){return no}),u.d(P,"TextureSampleType",function(){return dn}),u.d(P,"StorageTextureAccess",function(){return Ja}),u.d(P,"CompilationMessageType",function(){return $a}),u.d(P,"PrimitiveTopology",function(){return ki}),u.d(P,"FrontFace",function(){return oo}),u.d(P,"CullMode",function(){return Cn}),u.d(P,"ColorWrite",function(){return Go}),u.d(P,"BlendFactor",function(){return Si}),u.d(P,"BlendOperation",function(){return Ur}),u.d(P,"StencilOperation",function(){return ir}),u.d(P,"IndexFormat",function(){return Gr}),u.d(P,"VertexFormat",function(){return jt}),u.d(P,"InputStepMode",function(){return ao}),u.d(P,"LoadOp",function(){return Gi}),u.d(P,"StoreOp",function(){return Sr}),u.d(P,"QueryType",function(){return qa}),u.d(P,"PipelineStatisticName",function(){return es}),u.d(P,"DeviceLostReason",function(){return ts}),u.d(P,"ErrorFilter",function(){return is}),u.d(P,"WebGPUEngine",function(){return as}),u.d(P,"WebGPUCacheRenderPipeline",function(){return Wl}),u.d(P,"WebGPUCacheRenderPipelineTree",function(){return kl}),u.d(P,"WebGL2ShaderProcessor",function(){return $l.a}),u.d(P,"NativeEngine",function(){return $p}),u.d(P,"ShaderCodeInliner",function(){return zo.a}),u.d(P,"PerformanceConfigurator",function(){return qp.a}),u.d(P,"EngineFactory",function(){return em}),u.d(P,"KeyboardEventTypes",function(){return _i.a}),u.d(P,"KeyboardInfo",function(){return _i.b}),u.d(P,"KeyboardInfoPre",function(){return _i.c}),u.d(P,"PointerEventTypes",function(){return se.a}),u.d(P,"PointerInfoBase",function(){return se.c}),u.d(P,"PointerInfoPre",function(){return se.d}),u.d(P,"PointerInfo",function(){return se.b}),u.d(P,"ClipboardEventTypes",function(){return Wo}),u.d(P,"ClipboardInfo",function(){return tm}),u.d(P,"DeviceInputEventType",function(){return nu.a}),u.d(P,"EventConstants",function(){return nu.b}),u.d(P,"DaydreamController",function(){return ss}),u.d(P,"GearVRController",function(){return ls}),u.d(P,"GenericController",function(){return Ho}),u.d(P,"OculusTouchController",function(){return us}),u.d(P,"PoseEnabledControllerType",function(){return Li}),u.d(P,"PoseEnabledControllerHelper",function(){return Ui}),u.d(P,"PoseEnabledController",function(){return qi}),u.d(P,"ViveController",function(){return ou}),u.d(P,"WebVRController",function(){return Br}),u.d(P,"WindowsMotionController",function(){return ko}),u.d(P,"XRWindowsMotionController",function(){return rm}),u.d(P,"StickValues",function(){return Ht}),u.d(P,"Gamepad",function(){return Ot}),u.d(P,"GenericPad",function(){return Ut}),u.d(P,"GamepadManager",function(){return Gn}),u.d(P,"GamepadSystemSceneComponent",function(){return Da}),u.d(P,"Xbox360Button",function(){return Xt}),u.d(P,"Xbox360Dpad",function(){return er}),u.d(P,"Xbox360Pad",function(){return Vn}),u.d(P,"DualShockButton",function(){return tr}),u.d(P,"DualShockDpad",function(){return Jr}),u.d(P,"DualShockPad",function(){return Un}),u.d(P,"AxisDragGizmo",function(){return Xo.a}),u.d(P,"AxisScaleGizmo",function(){return fo}),u.d(P,"BoundingBoxGizmo",function(){return au}),u.d(P,"Gizmo",function(){return rr.a}),u.d(P,"GizmoManager",function(){return nm}),u.d(P,"PlaneRotationGizmo",function(){return Yo}),u.d(P,"PositionGizmo",function(){return uu}),u.d(P,"RotationGizmo",function(){return su}),u.d(P,"ScaleGizmo",function(){return cu}),u.d(P,"LightGizmo",function(){return om}),u.d(P,"CameraGizmo",function(){return am}),u.d(P,"PlaneDragGizmo",function(){return Ko}),u.d(P,"EnvironmentHelper",function(){return vs}),u.d(P,"PhotoDome",function(){return lm}),u.d(P,"_forceSceneHelpersToBundle",function(){return Om}),u.d(P,"VideoDome",function(){return Mm}),u.d(P,"EngineInstrumentation",function(){return xm}),u.d(P,"SceneInstrumentation",function(){return Dm}),u.d(P,"_TimeToken",function(){return Fl}),u.d(P,"EffectLayer",function(){return qu.a}),u.d(P,"EffectLayerSceneComponent",function(){return Im.a}),u.d(P,"GlowLayer",function(){return Lm.a}),u.d(P,"HighlightLayer",function(){return Ts}),u.d(P,"Layer",function(){return Fm}),u.d(P,"LayerSceneComponent",function(){return rc}),u.d(P,"LensFlare",function(){return lc}),u.d(P,"LensFlareSystem",function(){return As}),u.d(P,"LensFlareSystemSceneComponent",function(){return dc}),u.d(P,"Light",function(){return Zo.a}),u.d(P,"ShadowLight",function(){return fs.a}),u.d(P,"ShadowGenerator",function(){return pc.a}),u.d(P,"CascadedShadowGenerator",function(){return Bm.a}),u.d(P,"ShadowGeneratorSceneComponent",function(){return Nm.a}),u.d(P,"DirectionalLight",function(){return fu.a}),u.d(P,"HemisphericLight",function(){return $n.a}),u.d(P,"PointLight",function(){return Rs}),u.d(P,"SpotLight",function(){return hs}),u.d(P,"DefaultLoadingScreen",function(){return wm.a}),u.d(P,"_BabylonLoaderRegistered",function(){return mc.b}),u.d(P,"BabylonFileLoaderConfiguration",function(){return mc.a}),u.d(P,"SceneLoaderAnimationGroupLoadingMode",function(){return Mi.b}),u.d(P,"SceneLoader",function(){return Mi.a}),u.d(P,"SceneLoaderFlags",function(){return Vm.a}),u.d(P,"BackgroundMaterial",function(){return go}),u.d(P,"ColorCurves",function(){return Um.a}),u.d(P,"EffectFallbacks",function(){return gs.a}),u.d(P,"Effect",function(){return qe.a}),u.d(P,"FresnelParameters",function(){return gc}),u.d(P,"ImageProcessingConfigurationDefines",function(){return gr.b}),u.d(P,"ImageProcessingConfiguration",function(){return gr.a}),u.d(P,"Material",function(){return Yi.a}),u.d(P,"MaterialDefines",function(){return ps.a}),u.d(P,"ThinMaterialHelper",function(){return vc.a}),u.d(P,"MaterialHelper",function(){return xt.a}),u.d(P,"MultiMaterial",function(){return yo.a}),u.d(P,"OcclusionMaterial",function(){return Gm}),u.d(P,"PBRMaterialDefines",function(){return Hr.b}),u.d(P,"PBRBaseMaterial",function(){return Hr.a}),u.d(P,"PBRBaseSimpleMaterial",function(){return Os}),u.d(P,"PBRMaterial",function(){return Pu.a}),u.d(P,"PBRMetallicRoughnessMaterial",function(){return _c}),u.d(P,"PBRSpecularGlossinessMaterial",function(){return yc}),u.d(P,"PushMaterial",function(){return ms.a}),u.d(P,"ShaderMaterial",function(){return Tn.a}),u.d(P,"StandardMaterialDefines",function(){return zt.b}),u.d(P,"StandardMaterial",function(){return zt.a}),u.d(P,"BaseTexture",function(){return jr.a}),u.d(P,"ColorGradingTexture",function(){return bc}),u.d(P,"CubeTexture",function(){return pn.a}),u.d(P,"DynamicTexture",function(){return un.a}),u.d(P,"EquiRectangularCubeTexture",function(){return Pc}),u.d(P,"HDRFiltering",function(){return zm.a}),u.d(P,"HDRCubeTexture",function(){return Cc.a}),u.d(P,"HtmlElementTexture",function(){return jm}),u.d(P,"InternalTextureSource",function(){return gt.b}),u.d(P,"InternalTexture",function(){return gt.a}),u.d(P,"_DDSTextureLoader",function(){return Gu}),u.d(P,"_ENVTextureLoader",function(){return zu}),u.d(P,"_KTXTextureLoader",function(){return Wu}),u.d(P,"_TGATextureLoader",function(){return Sc}),u.d(P,"_HDRTextureLoader",function(){return Tc}),u.d(P,"_BasisTextureLoader",function(){return Ac}),u.d(P,"MirrorTexture",function(){return ds}),u.d(P,"MultiRenderTarget",function(){return km.a}),u.d(P,"TexturePacker",function(){return Xm}),u.d(P,"TexturePackerFrame",function(){return xs}),u.d(P,"CustomProceduralTexture",function(){return Ym}),u.d(P,"NoiseProceduralTexture",function(){return Ic}),u.d(P,"ProceduralTexture",function(){return Po}),u.d(P,"ProceduralTextureSceneComponent",function(){return Rc}),u.d(P,"RawCubeTexture",function(){return Km}),u.d(P,"RawTexture",function(){return kr.a}),u.d(P,"RawTexture2DArray",function(){return Qm.a}),u.d(P,"RawTexture3D",function(){return Zm}),u.d(P,"RefractionTexture",function(){return Jm}),u.d(P,"RenderTargetTexture",function(){return Cr.a}),u.d(P,"Texture",function(){return Ze.a}),u.d(P,"VideoTexture",function(){return $u}),u.d(P,"UniformBuffer",function(){return Fr.a}),u.d(P,"MaterialFlags",function(){return en.a}),u.d(P,"NodeMaterialBlockTargets",function(){return ve}),u.d(P,"NodeMaterialBlockConnectionPointTypes",function(){return ie}),u.d(P,"NodeMaterialBlockConnectionPointMode",function(){return Ti}),u.d(P,"NodeMaterialSystemValues",function(){return mt}),u.d(P,"NodeMaterialModes",function(){return Ki}),u.d(P,"NodeMaterialConnectionPointCompatibilityStates",function(){return _r}),u.d(P,"NodeMaterialConnectionPointDirection",function(){return Ni}),u.d(P,"NodeMaterialConnectionPoint",function(){return ea}),u.d(P,"NodeMaterialBlock",function(){return nt}),u.d(P,"NodeMaterialDefines",function(){return Ao}),u.d(P,"NodeMaterial",function(){return oa}),u.d(P,"VertexOutputBlock",function(){return Co}),u.d(P,"BonesBlock",function(){return wc}),u.d(P,"InstancesBlock",function(){return Vc}),u.d(P,"MorphTargetsBlock",function(){return Uc}),u.d(P,"LightInformationBlock",function(){return Gc}),u.d(P,"FragmentOutputBlock",function(){return On}),u.d(P,"ImageProcessingBlock",function(){return zc}),u.d(P,"PerturbNormalBlock",function(){return jc}),u.d(P,"DiscardBlock",function(){return Wc}),u.d(P,"FrontFacingBlock",function(){return Hc}),u.d(P,"DerivativeBlock",function(){return kc}),u.d(P,"FragCoordBlock",function(){return Xc}),u.d(P,"ScreenSizeBlock",function(){return Yc}),u.d(P,"FogBlock",function(){return Kc}),u.d(P,"LightBlock",function(){return Qc}),u.d(P,"TextureBlock",function(){return Zc}),u.d(P,"ReflectionTextureBlock",function(){return Jc}),u.d(P,"CurrentScreenBlock",function(){return Is}),u.d(P,"InputBlock",function(){return bt}),u.d(P,"AnimatedInputBlockTypes",function(){return on}),u.d(P,"MultiplyBlock",function(){return ia}),u.d(P,"AddBlock",function(){return $c}),u.d(P,"ScaleBlock",function(){return qc}),u.d(P,"ClampBlock",function(){return ef}),u.d(P,"CrossBlock",function(){return tf}),u.d(P,"DotBlock",function(){return rf}),u.d(P,"TransformBlock",function(){return ta}),u.d(P,"RemapBlock",function(){return Ns}),u.d(P,"NormalizeBlock",function(){return nf}),u.d(P,"TrigonometryBlockOperations",function(){return ni}),u.d(P,"TrigonometryBlock",function(){return Ws}),u.d(P,"ColorMergerBlock",function(){return of}),u.d(P,"VectorMergerBlock",function(){return So}),u.d(P,"ColorSplitterBlock",function(){return js}),u.d(P,"VectorSplitterBlock",function(){return af}),u.d(P,"LerpBlock",function(){return sf}),u.d(P,"DivideBlock",function(){return lf}),u.d(P,"SubtractBlock",function(){return uf}),u.d(P,"StepBlock",function(){return cf}),u.d(P,"OneMinusBlock",function(){return Xs}),u.d(P,"ViewDirectionBlock",function(){return Ys}),u.d(P,"FresnelBlock",function(){return ff}),u.d(P,"MaxBlock",function(){return hf}),u.d(P,"MinBlock",function(){return df}),u.d(P,"DistanceBlock",function(){return pf}),u.d(P,"LengthBlock",function(){return mf}),u.d(P,"NegateBlock",function(){return gf}),u.d(P,"PowBlock",function(){return vf}),u.d(P,"RandomNumberBlock",function(){return _f}),u.d(P,"ArcTan2Block",function(){return yf}),u.d(P,"SmoothStepBlock",function(){return bf}),u.d(P,"ReciprocalBlock",function(){return Ef}),u.d(P,"ReplaceColorBlock",function(){return Pf}),u.d(P,"PosterizeBlock",function(){return Cf}),u.d(P,"WaveBlockKind",function(){return mn}),u.d(P,"WaveBlock",function(){return Sf}),u.d(P,"GradientBlockColorStep",function(){return aa}),u.d(P,"GradientBlock",function(){return Tf}),u.d(P,"NLerpBlock",function(){return Af}),u.d(P,"WorleyNoise3DBlock",function(){return Rf}),u.d(P,"SimplexPerlin3DBlock",function(){return Of}),u.d(P,"NormalBlendBlock",function(){return Mf}),u.d(P,"Rotate2dBlock",function(){return xf}),u.d(P,"ReflectBlock",function(){return Df}),u.d(P,"RefractBlock",function(){return If}),u.d(P,"DesaturateBlock",function(){return Lf}),u.d(P,"PBRMetallicRoughnessBlock",function(){return Nf}),u.d(P,"SheenBlock",function(){return Ks}),u.d(P,"AnisotropyBlock",function(){return Qs}),u.d(P,"ReflectionBlock",function(){return Zs}),u.d(P,"ClearCoatBlock",function(){return sa}),u.d(P,"RefractionBlock",function(){return Js}),u.d(P,"SubSurfaceBlock",function(){return la}),u.d(P,"ParticleTextureBlock",function(){return Ls}),u.d(P,"ParticleRampGradientBlock",function(){return Fs}),u.d(P,"ParticleBlendMultiplyBlock",function(){return Bs}),u.d(P,"ModBlock",function(){return wf}),u.d(P,"MatrixBuilderBlock",function(){return Vf}),u.d(P,"NodeMaterialOptimizer",function(){return ig}),u.d(P,"PropertyTypeForEdition",function(){return Dt}),u.d(P,"editableInPropertyPage",function(){return Lt}),u.d(P,"EffectRenderer",function(){return Uf.a}),u.d(P,"EffectWrapper",function(){return Uf.b}),u.d(P,"ShadowDepthWrapper",function(){return og}),u.d(P,"Scalar",function(){return $e.a}),u.d(P,"extractMinAndMaxIndexed",function(){return Gf.b}),u.d(P,"extractMinAndMax",function(){return Gf.a}),u.d(P,"Space",function(){return tt.t}),u.d(P,"Axis",function(){return tt.c}),u.d(P,"Coordinate",function(){return tt.g}),u.d(P,"Color3",function(){return tt.e}),u.d(P,"Color4",function(){return tt.f}),u.d(P,"TmpColors",function(){return tt.u}),u.d(P,"ToGammaSpace",function(){return tt.w}),u.d(P,"ToLinearSpace",function(){return tt.x}),u.d(P,"Epsilon",function(){return tt.i}),u.d(P,"Frustum",function(){return tt.j}),u.d(P,"Orientation",function(){return tt.l}),u.d(P,"BezierCurve",function(){return tt.d}),u.d(P,"Angle",function(){return tt.a}),u.d(P,"Arc2",function(){return tt.b}),u.d(P,"Path2",function(){return tt.m}),u.d(P,"Path3D",function(){return tt.n}),u.d(P,"Curve3",function(){return tt.h}),u.d(P,"Plane",function(){return tt.o}),u.d(P,"Size",function(){return tt.s}),u.d(P,"Vector2",function(){return tt.y}),u.d(P,"Vector3",function(){return tt.z}),u.d(P,"Vector4",function(){return tt.A}),u.d(P,"Quaternion",function(){return tt.r}),u.d(P,"Matrix",function(){return tt.k}),u.d(P,"TmpVectors",function(){return tt.v}),u.d(P,"PositionNormalVertex",function(){return tt.q}),u.d(P,"PositionNormalTextureVertex",function(){return tt.p}),u.d(P,"Viewport",function(){return tt.B}),u.d(P,"SphericalHarmonics",function(){return uo.a}),u.d(P,"SphericalPolynomial",function(){return uo.b}),u.d(P,"AbstractMesh",function(){return Ae.a}),u.d(P,"Buffer",function(){return Be.a}),u.d(P,"VertexBuffer",function(){return Be.b}),u.d(P,"DracoCompression",function(){return ag.a}),u.d(P,"CSG",function(){return ug}),u.d(P,"Geometry",function(){return cg.a}),u.d(P,"GroundMesh",function(){return fg.a}),u.d(P,"TrailMesh",function(){return hg}),u.d(P,"InstancedMesh",function(){return dg.a}),u.d(P,"LinesMesh",function(){return Oo.b}),u.d(P,"InstancedLinesMesh",function(){return Oo.a}),u.d(P,"_CreationDataStorage",function(){return st.b}),u.d(P,"_InstancesBatch",function(){return st.c}),u.d(P,"Mesh",function(){return st.a}),u.d(P,"VertexData",function(){return an.a}),u.d(P,"MeshBuilder",function(){return pg.a}),u.d(P,"SimplificationSettings",function(){return mg}),u.d(P,"SimplificationQueue",function(){return jf}),u.d(P,"SimplificationType",function(){return Mo}),u.d(P,"QuadraticErrorSimplification",function(){return Hf}),u.d(P,"SimplicationQueueSceneComponent",function(){return kf}),u.d(P,"Polygon",function(){return Xf.a}),u.d(P,"PolygonMeshBuilder",function(){return Xf.b}),u.d(P,"SubMesh",function(){return Ro.a}),u.d(P,"MeshLODLevel",function(){return yg.a}),u.d(P,"TransformNode",function(){return po.a}),u.d(P,"BoxBuilder",function(){return co.a}),u.d(P,"TiledBoxBuilder",function(){return bg.a}),u.d(P,"DiscBuilder",function(){return Yf.a}),u.d(P,"RibbonBuilder",function(){return Eg.a}),u.d(P,"SphereBuilder",function(){return nr.a}),u.d(P,"HemisphereBuilder",function(){return Qo}),u.d(P,"CylinderBuilder",function(){return Tr.a}),u.d(P,"TorusBuilder",function(){return eo.a}),u.d(P,"TorusKnotBuilder",function(){return Pg.a}),u.d(P,"LinesBuilder",function(){return Bi.a}),u.d(P,"PolygonBuilder",function(){return Cg.a}),u.d(P,"ShapeBuilder",function(){return Sg.a}),u.d(P,"LatheBuilder",function(){return Tg.a}),u.d(P,"PlaneBuilder",function(){return lu.a}),u.d(P,"TiledPlaneBuilder",function(){return Ag.a}),u.d(P,"GroundBuilder",function(){return Ya.a}),u.d(P,"TubeBuilder",function(){return Rg.a}),u.d(P,"PolyhedronBuilder",function(){return cs.a}),u.d(P,"IcoSphereBuilder",function(){return Og.a}),u.d(P,"DecalBuilder",function(){return Mg.a}),u.d(P,"CapsuleBuilder",function(){return xg.a}),u.d(P,"DataBuffer",function(){return ns.a}),u.d(P,"WebGLDataBuffer",function(){return Dg.a}),u.d(P,"WebGPUDataBuffer",function(){return zl}),u.d(P,"MorphTarget",function(){return Ig.a}),u.d(P,"MorphTargetManager",function(){return Kf.a}),u.d(P,"RecastJSPlugin",function(){return Lg}),u.d(P,"RecastJSCrowd",function(){return Qf}),u.d(P,"Node",function(){return Nt.a}),u.d(P,"Database",function(){return Zf}),u.d(P,"BaseParticleSystem",function(){return To}),u.d(P,"BoxParticleEmitter",function(){return Mn}),u.d(P,"ConeParticleEmitter",function(){return ws}),u.d(P,"CylinderParticleEmitter",function(){return ra}),u.d(P,"CylinderDirectedParticleEmitter",function(){return Vs}),u.d(P,"HemisphericParticleEmitter",function(){return Us}),u.d(P,"PointParticleEmitter",function(){return Gs}),u.d(P,"SphereParticleEmitter",function(){return na}),u.d(P,"SphereDirectedParticleEmitter",function(){return zs}),u.d(P,"CustomParticleEmitter",function(){return xn}),u.d(P,"MeshParticleEmitter",function(){return Bc}),u.d(P,"GPUParticleSystem",function(){return gn}),u.d(P,"Particle",function(){return $f}),u.d(P,"ParticleHelper",function(){return Fg}),u.d(P,"ParticleSystem",function(){return gi}),u.d(P,"ParticleSystemSet",function(){return ua}),u.d(P,"SolidParticle",function(){return tl}),u.d(P,"ModelShape",function(){return il}),u.d(P,"DepthSortedParticle",function(){return mh}),u.d(P,"SolidParticleVertex",function(){return gh}),u.d(P,"SolidParticleSystem",function(){return Bg}),u.d(P,"CloudPoint",function(){return vh.a}),u.d(P,"PointsGroup",function(){return vh.b}),u.d(P,"PointColor",function(){return _h.a}),u.d(P,"PointsCloudSystem",function(){return _h.b}),u.d(P,"SubEmitterType",function(){return Dn}),u.d(P,"SubEmitter",function(){return xo}),u.d(P,"PhysicsEngine",function(){return yh.a}),u.d(P,"PhysicsEngineSceneComponent",function(){return bh}),u.d(P,"PhysicsHelper",function(){return Ng}),u.d(P,"PhysicsRadialExplosionEventOptions",function(){return Ln}),u.d(P,"PhysicsUpdraftEventOptions",function(){return rl}),u.d(P,"PhysicsVortexEventOptions",function(){return nl}),u.d(P,"PhysicsRadialImpulseFalloff",function(){return Do}),u.d(P,"PhysicsUpdraftMode",function(){return Fn}),u.d(P,"PhysicsImpostor",function(){return Xr.a}),u.d(P,"PhysicsJoint",function(){return In.e}),u.d(P,"DistanceJoint",function(){return In.a}),u.d(P,"MotorEnabledJoint",function(){return In.d}),u.d(P,"HingeJoint",function(){return In.c}),u.d(P,"Hinge2Joint",function(){return In.b}),u.d(P,"CannonJSPlugin",function(){return Gg.a}),u.d(P,"AmmoJSPlugin",function(){return zg.a}),u.d(P,"OimoJSPlugin",function(){return jg.a}),u.d(P,"AnaglyphPostProcess",function(){return Fo}),u.d(P,"BlackAndWhitePostProcess",function(){return Sh}),u.d(P,"BloomEffect",function(){return Wg.a}),u.d(P,"BloomMergePostProcess",function(){return Hg.a}),u.d(P,"BlurPostProcess",function(){return mo.a}),u.d(P,"ChromaticAberrationPostProcess",function(){return kg.a}),u.d(P,"CircleOfConfusionPostProcess",function(){return Xg.a}),u.d(P,"ColorCorrectionPostProcess",function(){return Rh}),u.d(P,"ConvolutionPostProcess",function(){return xh}),u.d(P,"DepthOfFieldBlurPostProcess",function(){return Yg.a}),u.d(P,"DepthOfFieldEffectBlurLevel",function(){return Dh.b}),u.d(P,"DepthOfFieldEffect",function(){return Dh.a}),u.d(P,"DepthOfFieldMergePostProcessOptions",function(){return Ih.b}),u.d(P,"DepthOfFieldMergePostProcess",function(){return Ih.a}),u.d(P,"DisplayPassPostProcess",function(){return Bh}),u.d(P,"ExtractHighlightsPostProcess",function(){return Kg.a}),u.d(P,"FilterPostProcess",function(){return Vh}),u.d(P,"FxaaPostProcess",function(){return Uh.a}),u.d(P,"GrainPostProcess",function(){return Qg.a}),u.d(P,"HighlightsPostProcess",function(){return Zg}),u.d(P,"ImageProcessingPostProcess",function(){return Xa.a}),u.d(P,"MotionBlurPostProcess",function(){return Jg.a}),u.d(P,"PassPostProcess",function(){return yn.b}),u.d(P,"PassCubePostProcess",function(){return yn.a}),u.d(P,"PostProcess",function(){return ii.a}),u.d(P,"PostProcessManager",function(){return $g.a}),u.d(P,"RefractionPostProcess",function(){return Hh}),u.d(P,"DefaultRenderingPipeline",function(){return Yr.a}),u.d(P,"LensRenderingPipeline",function(){return Yr.b}),u.d(P,"SSAO2RenderingPipeline",function(){return Yr.g}),u.d(P,"SSAORenderingPipeline",function(){return Yr.h}),u.d(P,"StandardRenderingPipeline",function(){return Yr.i}),u.d(P,"PostProcessRenderEffect",function(){return Yr.c}),u.d(P,"PostProcessRenderPipeline",function(){return Yr.d}),u.d(P,"PostProcessRenderPipelineManager",function(){return Yr.e}),u.d(P,"PostProcessRenderPipelineManagerSceneComponent",function(){return Yr.f}),u.d(P,"SharpenPostProcess",function(){return qg.a}),u.d(P,"StereoscopicInterlacePostProcessI",function(){return kn}),u.d(P,"StereoscopicInterlacePostProcess",function(){return Dl}),u.d(P,"TonemappingOperator",function(){return vn}),u.d(P,"TonemapPostProcess",function(){return ev}),u.d(P,"VolumetricLightScatteringPostProcess",function(){return qh}),u.d(P,"VRDistortionCorrectionPostProcess",function(){return Bo}),u.d(P,"VRMultiviewToSingleviewPostProcess",function(){return No}),u.d(P,"ScreenSpaceReflectionPostProcess",function(){return tv.a}),u.d(P,"ScreenSpaceCurvaturePostProcess",function(){return id}),u.d(P,"ReflectionProbe",function(){return rv.a}),u.d(P,"BoundingBoxRenderer",function(){return rd}),u.d(P,"DepthRenderer",function(){return nv.a}),u.d(P,"DepthRendererSceneComponent",function(){return ov.a}),u.d(P,"EdgesRenderer",function(){return ol}),u.d(P,"LineEdgesRenderer",function(){return ld}),u.d(P,"GeometryBufferRenderer",function(){return sv.a}),u.d(P,"GeometryBufferRendererSceneComponent",function(){return iv.a}),u.d(P,"PrePassRenderer",function(){return lv.a}),u.d(P,"PrePassRendererSceneComponent",function(){return uv.a}),u.d(P,"SubSurfaceSceneComponent",function(){return gd}),u.d(P,"OutlineRenderer",function(){return Ed}),u.d(P,"RenderingGroup",function(){return fv.a}),u.d(P,"RenderingGroupInfo",function(){return Pd.a}),u.d(P,"RenderingManager",function(){return Pd.b}),u.d(P,"UtilityLayerRenderer",function(){return Xi.a}),u.d(P,"Scene",function(){return ae.a}),u.d(P,"SceneComponentConstants",function(){return X.a}),u.d(P,"Stage",function(){return X.b}),u.d(P,"Sprite",function(){return Cd}),u.d(P,"SpriteManager",function(){return Dd}),u.d(P,"SpriteMap",function(){return pv}),u.d(P,"SpritePackedManager",function(){return mv}),u.d(P,"SpriteSceneComponent",function(){return Sd}),u.d(P,"AlphaState",function(){return gv.a}),u.d(P,"DepthCullingState",function(){return Yl.a}),u.d(P,"StencilState",function(){return Xl.a}),u.d(P,"AndOrNotEvaluator",function(){return vv.a}),u.d(P,"AssetTaskState",function(){return Or}),u.d(P,"AbstractAssetTask",function(){return Mr}),u.d(P,"AssetsProgressEvent",function(){return Nd}),u.d(P,"ContainerAssetTask",function(){return wd}),u.d(P,"MeshAssetTask",function(){return Vd}),u.d(P,"TextFileAssetTask",function(){return Ud}),u.d(P,"BinaryFileAssetTask",function(){return Gd}),u.d(P,"ImageAssetTask",function(){return zd}),u.d(P,"TextureAssetTask",function(){return jd}),u.d(P,"CubeTextureAssetTask",function(){return Wd}),u.d(P,"HDRCubeTextureAssetTask",function(){return Hd}),u.d(P,"EquiRectangularCubeTextureAssetTask",function(){return kd}),u.d(P,"AssetsManager",function(){return _v}),u.d(P,"BasisTranscodeConfiguration",function(){return Wm}),u.d(P,"BasisTools",function(){return Eo}),u.d(P,"DDSTools",function(){return rn}),u.d(P,"expandToProperty",function(){return Ee.b}),u.d(P,"serialize",function(){return Ee.c}),u.d(P,"serializeAsTexture",function(){return Ee.m}),u.d(P,"serializeAsColor3",function(){return Ee.e}),u.d(P,"serializeAsFresnelParameters",function(){return Ee.h}),u.d(P,"serializeAsVector2",function(){return Ee.n}),u.d(P,"serializeAsVector3",function(){return Ee.o}),u.d(P,"serializeAsMeshReference",function(){return Ee.k}),u.d(P,"serializeAsColorCurves",function(){return Ee.g}),u.d(P,"serializeAsColor4",function(){return Ee.f}),u.d(P,"serializeAsImageProcessingConfiguration",function(){return Ee.i}),u.d(P,"serializeAsQuaternion",function(){return Ee.l}),u.d(P,"serializeAsMatrix",function(){return Ee.j}),u.d(P,"serializeAsCameraReference",function(){return Ee.d}),u.d(P,"SerializationHelper",function(){return Ee.a}),u.d(P,"Deferred",function(){return yv.a}),u.d(P,"EnvironmentTextureTools",function(){return Wr}),u.d(P,"MeshExploder",function(){return bv}),u.d(P,"FilesInput",function(){return Ev}),u.d(P,"CubeMapToSphericalPolynomialTools",function(){return Cu.a}),u.d(P,"HDRTools",function(){return Ms.a}),u.d(P,"PanoramaToCubeMapTools",function(){return Ec.a}),u.d(P,"KhronosTextureContainer",function(){return $o}),u.d(P,"EventState",function(){return g.a}),u.d(P,"Observer",function(){return g.d}),u.d(P,"MultiObserver",function(){return g.b}),u.d(P,"Observable",function(){return g.c}),u.d(P,"PerformanceMonitor",function(){return Yd.a}),u.d(P,"RollingAverage",function(){return Yd.b}),u.d(P,"PromisePolyfill",function(){return Pv.a}),u.d(P,"SceneOptimization",function(){return xr}),u.d(P,"TextureOptimization",function(){return ca}),u.d(P,"HardwareScalingOptimization",function(){return al}),u.d(P,"ShadowsOptimization",function(){return fa}),u.d(P,"PostProcessesOptimization",function(){return ha}),u.d(P,"LensFlaresOptimization",function(){return da}),u.d(P,"CustomOptimization",function(){return Kd}),u.d(P,"ParticlesOptimization",function(){return pa}),u.d(P,"RenderTargetsOptimization",function(){return sl}),u.d(P,"MergeMeshesOptimization",function(){return ma}),u.d(P,"SceneOptimizerOptions",function(){return ll}),u.d(P,"SceneOptimizer",function(){return Cv}),u.d(P,"SceneSerializer",function(){return cl}),u.d(P,"SmartArray",function(){return Ct.a}),u.d(P,"SmartArrayNoDuplicate",function(){return Ct.b}),u.d(P,"StringDictionary",function(){return Dr.a}),u.d(P,"Tags",function(){return Zd.a}),u.d(P,"TextureTools",function(){return Tv.a}),u.d(P,"TGATools",function(){return qo}),u.d(P,"Tools",function(){return re.b}),u.d(P,"className",function(){return re.c}),u.d(P,"AsyncLoop",function(){return re.a}),u.d(P,"VideoRecorder",function(){return Av}),u.d(P,"JoystickAxis",function(){return Vt}),u.d(P,"VirtualJoystick",function(){return Ci}),u.d(P,"WorkerPool",function(){return ju.a}),u.d(P,"Logger",function(){return d.a}),u.d(P,"_TypeStore",function(){return f.a}),u.d(P,"FilesInputStore",function(){return Xd.a}),u.d(P,"DeepCopier",function(){return vr.a}),u.d(P,"PivotTools",function(){return he.a}),u.d(P,"PrecisionDate",function(){return ee.a}),u.d(P,"ScreenshotTools",function(){return Io}),u.d(P,"WebRequest",function(){return Rr.a}),u.d(P,"InspectableType",function(){return fl}),u.d(P,"BRDFTextureTools",function(){return Ff.a}),u.d(P,"RGBDTextureTools",function(){return tu.a}),u.d(P,"ColorGradient",function(){return qs}),u.d(P,"Color3Gradient",function(){return Jf}),u.d(P,"FactorGradient",function(){return el}),u.d(P,"GradientHelper",function(){return Qi}),u.d(P,"PerfCounter",function(){return fr.a}),u.d(P,"RetryStrategy",function(){return Rv.a}),u.d(P,"CanvasGenerator",function(){return Nl.a}),u.d(P,"LoadFileError",function(){return va.b}),u.d(P,"RequestFileError",function(){return va.d}),u.d(P,"ReadFileError",function(){return va.c}),u.d(P,"FileTools",function(){return va.a}),u.d(P,"StringTools",function(){return Ar.a}),u.d(P,"DataReader",function(){return Ov.a}),u.d(P,"MinMaxReducer",function(){return Mv.a}),u.d(P,"DepthReducer",function(){return xv.a}),u.d(P,"DataStorage",function(){return Dv}),u.d(P,"SceneRecorder",function(){return Iv}),u.d(P,"KhronosTextureContainer2",function(){return Ps}),u.d(P,"Trajectory",function(){return Lv}),u.d(P,"TrajectoryClassifier",function(){return Fv}),u.d(P,"TimerState",function(){return nn}),u.d(P,"setAndStartTimer",function(){return Ss}),u.d(P,"AdvancedTimer",function(){return Am}),u.d(P,"CopyTools",function(){return Bv.a}),u.d(P,"WebXRCamera",function(){return Hu}),u.d(P,"WebXREnterExitUIButton",function(){return Qu}),u.d(P,"WebXREnterExitUIOptions",function(){return Sm}),u.d(P,"WebXREnterExitUI",function(){return Zu}),u.d(P,"WebXRExperienceHelper",function(){return ku}),u.d(P,"WebXRInput",function(){return Ku}),u.d(P,"WebXRInputSource",function(){return Yu}),u.d(P,"WebXRManagedOutputCanvasOptions",function(){return wo}),u.d(P,"WebXRManagedOutputCanvas",function(){return to}),u.d(P,"WebXRState",function(){return pi}),u.d(P,"WebXRTrackingState",function(){return Nr}),u.d(P,"WebXRSessionManager",function(){return bn}),u.d(P,"WebXRDefaultExperienceOptions",function(){return Rm}),u.d(P,"WebXRDefaultExperience",function(){return Ju}),u.d(P,"WebXRFeatureName",function(){return ur}),u.d(P,"WebXRFeaturesManager",function(){return or}),u.d(P,"WebXRAbstractFeature",function(){return cr}),u.d(P,"WebXRHitTestLegacy",function(){return _a}),u.d(P,"WebXRAnchorSystem",function(){return ya}),u.d(P,"WebXRPlaneDetector",function(){return ba}),u.d(P,"WebXRBackgroundRemover",function(){return Ea}),u.d(P,"WebXRMotionControllerTeleportation",function(){return _o}),u.d(P,"WebXRControllerPointerSelection",function(){return vo}),u.d(P,"IWebXRControllerPhysicsOptions",function(){return Vv}),u.d(P,"WebXRControllerPhysics",function(){return Pa}),u.d(P,"WebXRHitTest",function(){return Ca}),u.d(P,"WebXRFeaturePointSystem",function(){return Sa}),u.d(P,"WebXRHand",function(){return ep}),u.d(P,"WebXRHandTracking",function(){return Ta}),u.d(P,"WebXRMeshDetector",function(){return Aa}),u.d(P,"WebXRImageTracking",function(){return Ra}),u.d(P,"WebXRAbstractMotionController",function(){return Rn}),u.d(P,"WebXRControllerComponent",function(){return An}),u.d(P,"WebXRGenericTriggerMotionController",function(){return Cs}),u.d(P,"WebXRMicrosoftMixedRealityController",function(){return tp}),u.d(P,"WebXRMotionControllerManager",function(){return ar}),u.d(P,"WebXROculusTouchMotionController",function(){return dl}),u.d(P,"WebXRHTCViveMotionController",function(){return ip}),u.d(P,"WebXRProfiledMotionController",function(){return Xu});var T=u(468),S=u(669),j=u(511),O=u(671),M=u(618),H=u(619),A=u(620),p=u(434),f=u(437),h=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,r)||this;return o._sound=i,o}return t.prototype._prepare=function(){},t.prototype.execute=function(){this._sound!==void 0&&this._sound.play()},t.prototype.serialize=function(e){return n.prototype._serialize.call(this,{name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)},t}(j.a),m=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,r)||this;return o._sound=i,o}return t.prototype._prepare=function(){},t.prototype.execute=function(){this._sound!==void 0&&this._sound.stop()},t.prototype.serialize=function(e){return n.prototype._serialize.call(this,{name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)},t}(j.a);f.a.RegisteredTypes["BABYLON.PlaySoundAction"]=m,f.a.RegisteredTypes["BABYLON.StopSoundAction"]=m;var d=u(440),g=u(438),v=u(441),l=u(436),y=u(483),E=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_){a===void 0&&(a=1e3);var b=n.call(this,e,s)||this;return b.duration=1e3,b.onInterpolationDoneObservable=new g.c,b.propertyPath=r,b.value=o,b.duration=a,b.stopOtherAnimations=c,b.onInterpolationDone=_,b._target=b._effectiveTarget=i,b}return t.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},t.prototype.execute=function(){var e=this,i=this._actionManager.getScene(),r=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}],o;if(typeof this.value=="number")o=y.a.ANIMATIONTYPE_FLOAT;else if(this.value instanceof v.a)o=y.a.ANIMATIONTYPE_COLOR3;else if(this.value instanceof l.e)o=y.a.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof l.a)o=y.a.ANIMATIONTYPE_MATRIX;else if(this.value instanceof l.b)o=y.a.ANIMATIONTYPE_QUATERNION;else{d.a.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}var a=new y.a("InterpolateValueAction",this._property,100*(1e3/this.duration),o,y.a.ANIMATIONLOOPMODE_CONSTANT);a.setKeys(r),this.stopOtherAnimations&&i.stopAnimation(this._effectiveTarget);var s=function(){e.onInterpolationDoneObservable.notifyObservers(e),e.onInterpolationDone&&e.onInterpolationDone()};i.beginDirectAnimation(this._effectiveTarget,[a],0,100,!1,1,s)},t.prototype.serialize=function(e){return n.prototype._serialize.call(this,{name:"InterpolateValueAction",properties:[j.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:j.a._SerializeValueAsString(this.value)},{name:"duration",value:j.a._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:j.a._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)},t}(j.a);f.a.RegisteredTypes["BABYLON.InterpolateValueAction"]=E;var R=u(530),F=u(540),B=function(){function n(){this.enableBlending=!1,this.blendingSpeed=.01,this.loopMode=y.a.ANIMATIONLOOPMODE_CYCLE}return n}(),L=u(613),I=u(572),k=function(){function n(t,e,i){this.frame=t,this.action=e,this.onlyOnce=i,this.isDone=!1}return n.prototype._clone=function(){return new n(this.frame,this.action,this.onlyOnce)},n}(),Z=u(707),Y=u(672),U=function(){function n(t){this.path=t,this._onchange=new Array,this.value=0,this.animations=new Array}return n.prototype.getPoint=function(){var t=this.path.getPointAtLengthPosition(this.value);return new l.e(t.x,0,t.y)},n.prototype.moveAhead=function(t){return t===void 0&&(t=.002),this.move(t),this},n.prototype.moveBack=function(t){return t===void 0&&(t=.002),this.move(-t),this},n.prototype.move=function(t){if(Math.abs(t)>1)throw"step size should be less than 1.";return this.value+=t,this.ensureLimits(),this.raiseOnChange(),this},n.prototype.ensureLimits=function(){for(;this.value>1;)this.value-=1;for(;this.value<0;)this.value+=1;return this},n.prototype.raiseOnChange=function(){var t=this;return this._onchange.forEach(function(e){return e(t)}),this},n.prototype.onchange=function(t){return this._onchange.push(t),this},n}(),Q=u(604),G=u(445),K=function(){function n(t){this.SMOOTHING=.75,this.FFT_SIZE=512,this.BARGRAPHAMPLITUDE=256,this.DEBUGCANVASPOS={x:20,y:20},this.DEBUGCANVASSIZE={width:320,height:200},this._scene=t,this._audioEngine=G.a.audioEngine,this._audioEngine.canUseWebAudio&&this._audioEngine.audioContext&&(this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser(),this._webAudioAnalyser.minDecibels=-140,this._webAudioAnalyser.maxDecibels=0,this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount))}return n.prototype.getFrequencyBinCount=function(){return this._audioEngine.canUseWebAudio?this._webAudioAnalyser.frequencyBinCount:0},n.prototype.getByteFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)),this._byteFreqs},n.prototype.getByteTimeDomainData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)),this._byteTime},n.prototype.getFloatFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)),this._floatFreqs},n.prototype.drawDebugCanvas=function(){var t=this;if(this._audioEngine.canUseWebAudio&&(this._debugCanvas||(this._debugCanvas=document.createElement("canvas"),this._debugCanvas.width=this.DEBUGCANVASSIZE.width,this._debugCanvas.height=this.DEBUGCANVASSIZE.height,this._debugCanvas.style.position="absolute",this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px",this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px",this._debugCanvasContext=this._debugCanvas.getContext("2d"),document.body.appendChild(this._debugCanvas),this._registerFunc=function(){t.drawDebugCanvas()},this._scene.registerBeforeRender(this._registerFunc)),this._registerFunc&&this._debugCanvasContext)){var e=this.getByteFrequencyData();this._debugCanvasContext.fillStyle="rgb(0, 0, 0)",this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(var i=0;i<this.getFrequencyBinCount();i++){var r=e[i],o=r/this.BARGRAPHAMPLITUDE,a=this.DEBUGCANVASSIZE.height*o,s=this.DEBUGCANVASSIZE.height-a-1,c=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount(),_=i/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+_+", 100%, 50%)",this._debugCanvasContext.fillRect(i*c,s,c,a)}}},n.prototype.stopDebugCanvas=function(){this._debugCanvas&&(this._registerFunc&&(this._scene.unregisterBeforeRender(this._registerFunc),this._registerFunc=null),document.body.removeChild(this._debugCanvas),this._debugCanvas=null,this._debugCanvasContext=null)},n.prototype.connectAudioNodes=function(t,e){this._audioEngine.canUseWebAudio&&(t.connect(this._webAudioAnalyser),this._webAudioAnalyser.connect(e))},n.prototype.dispose=function(){this._audioEngine.canUseWebAudio&&this._webAudioAnalyser.disconnect()},n}(),fe=u(660);G.a.AudioEngineFactory=function(n){return new ce(n)};var ce=function(){function n(t){var e=this;if(t===void 0&&(t=null),this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!0,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new g.c,this.onAudioLockedObservable=new g.c,this._tryToRun=!1,this._onResize=function(){e._moveButtonToTopLeft()},!!fe.a.IsWindowObjectExist()){(typeof window.AudioContext!="undefined"||typeof window.webkitAudioContext!="undefined")&&(window.AudioContext=window.AudioContext||window.webkitAudioContext,this.canUseWebAudio=!0);var i=document.createElement("audio");this._hostElement=t;try{i&&!!i.canPlayType&&(i.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||i.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch(r){}try{i&&!!i.canPlayType&&i.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch(r){}}}return Object.defineProperty(n.prototype,"audioContext",{get:function(){return this._audioContextInitialized?!this.unlocked&&!this._muteButton&&this._displayMuteButton():this._initializeAudioContext(),this._audioContext},enumerable:!1,configurable:!0}),n.prototype.lock=function(){this._triggerSuspendedState()},n.prototype.unlock=function(){this._triggerRunningState()},n.prototype._resumeAudioContext=function(){var t;return this._audioContext.resume!==void 0&&(t=this._audioContext.resume()),t||Promise.resolve()},n.prototype._initializeAudioContext=function(){try{this.canUseWebAudio&&(this._audioContext=new AudioContext,this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(this._audioContext.destination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(t){this.canUseWebAudio=!1,d.a.Error("Web Audio: "+t.message)}},n.prototype._triggerRunningState=function(){var t=this;this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(function(){t._tryToRun=!1,t._muteButton&&t._hideMuteButton(),t.unlocked=!0,t.onAudioUnlockedObservable.notifyObservers(t)}).catch(function(){t._tryToRun=!1,t.unlocked=!1}))},n.prototype._triggerSuspendedState=function(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()},n.prototype._displayMuteButton=function(){var t=this;if(!(this.useCustomUnlockedButton||this._muteButton)){this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";var e=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png",i=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+e+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",r=document.createElement("style");r.appendChild(document.createTextNode(i)),document.getElementsByTagName("head")[0].appendChild(r),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",function(){t._triggerRunningState()},!0),this._muteButton.addEventListener("click",function(){t._triggerRunningState()},!0),window.addEventListener("resize",this._onResize)}},n.prototype._moveButtonToTopLeft=function(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")},n.prototype._hideMuteButton=function(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)},n.prototype.dispose=function(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()},n.prototype.getGlobalVolume=function(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1},n.prototype.setGlobalVolume=function(t){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=t)},n.prototype.connectToAnalyser=function(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=t,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))},n}(),re=u(443),Re=u(476),Ie=function(){function n(t,e,i,r,o){var a=this;r===void 0&&(r=null);var s,c,_,b;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.spatialSound=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new g.c,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=l.e.Zero(),this._localDirection=new l.e(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=t,this._scene=i,n._SceneComponentInitialization(i),this._readyToPlayCallback=r,this._customAttenuationFunction=function(q,ue,ge,Se,Pe){return ue<ge?q*(1-ue/ge):0},o&&(this.autoplay=o.autoplay||!1,this._loop=o.loop||!1,o.volume!==void 0&&(this._volume=o.volume),this.spatialSound=(s=o.spatialSound)!==null&&s!==void 0?s:!1,this.maxDistance=(c=o.maxDistance)!==null&&c!==void 0?c:100,this.useCustomAttenuation=(_=o.useCustomAttenuation)!==null&&_!==void 0?_:!1,this.rolloffFactor=o.rolloffFactor||1,this.refDistance=o.refDistance||1,this.distanceModel=o.distanceModel||"linear",this._playbackRate=o.playbackRate||1,this._streaming=(b=o.streaming)!==null&&b!==void 0?b:!1,this._length=o.length,this._offset=o.offset),G.a.audioEngine.canUseWebAudio&&G.a.audioEngine.audioContext){this._soundGain=G.a.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this.spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);var C=!0;if(e)try{typeof e=="string"?this._urlType="String":e instanceof ArrayBuffer?this._urlType="ArrayBuffer":e instanceof MediaStream?this._urlType="MediaStream":Array.isArray(e)&&(this._urlType="Array");var x=[],V=!1;switch(this._urlType){case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=G.a.audioEngine.audioContext.createMediaStreamSource(e),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":e.byteLength>0&&(V=!0,this._soundLoaded(e));break;case"String":x.push(e);case"Array":x.length===0&&(x=e);for(var D=0;D<x.length;D++){var z=x[D];if(V=o&&o.skipCodecCheck||z.indexOf(".mp3",z.length-4)!==-1&&G.a.audioEngine.isMP3supported||z.indexOf(".ogg",z.length-4)!==-1&&G.a.audioEngine.isOGGsupported||z.indexOf(".wav",z.length-4)!==-1||z.indexOf(".m4a",z.length-4)!==-1||z.indexOf("blob:")!==-1,V){this._streaming?(this._htmlAudioElement=new Audio(z),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,re.b.SetCorsBehavior(z,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",function(){a._isReadyToPlay=!0,a.autoplay&&a.play(0,a._offset,a._length),a._readyToPlayCallback&&a._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(z,function(q){a._soundLoaded(q)},void 0,!0,!0,function(q){q&&d.a.Error("XHR "+q.status+" error on: "+z+"."),d.a.Error("Sound creation aborted."),a._scene.mainSoundTrack.removeSound(a)});break}}break;default:C=!1;break}C?V||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout(function(){a._readyToPlayCallback&&a._readyToPlayCallback()},1e3)):d.a.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(q){d.a.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),G.a.audioEngine.WarnedWebAudioUnsupported||(d.a.Error("Web Audio is not supported by your browser."),G.a.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout(function(){a._readyToPlayCallback&&a._readyToPlayCallback()},1e3)}return Object.defineProperty(n.prototype,"loop",{get:function(){return this._loop},set:function(t){t!==this._loop&&(this._loop=t,this.updateOptions({loop:t}))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentTime",{get:function(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;var t=this._startOffset;return this.isPlaying&&G.a.audioEngine.audioContext&&(t+=G.a.audioEngine.audioContext.currentTime-this._startTime),t},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){G.a.audioEngine.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))},n.prototype.isReady=function(){return this._isReadyToPlay},n.prototype.getClassName=function(){return"Sound"},n.prototype._soundLoaded=function(t){var e=this;!G.a.audioEngine.audioContext||G.a.audioEngine.audioContext.decodeAudioData(t,function(i){e._audioBuffer=i,e._isReadyToPlay=!0,e.autoplay&&e.play(0,e._offset,e._length),e._readyToPlayCallback&&e._readyToPlayCallback()},function(i){d.a.Error("Error while decoding audio data for: "+e.name+" / Error: "+i)})},n.prototype.setAudioBuffer=function(t){G.a.audioEngine.canUseWebAudio&&(this._audioBuffer=t,this._isReadyToPlay=!0)},n.prototype.updateOptions=function(t){var e,i,r,o,a,s,c,_,b;t&&(this.loop=(e=t.loop)!==null&&e!==void 0?e:this.loop,this.maxDistance=(i=t.maxDistance)!==null&&i!==void 0?i:this.maxDistance,this.useCustomAttenuation=(r=t.useCustomAttenuation)!==null&&r!==void 0?r:this.useCustomAttenuation,this.rolloffFactor=(o=t.rolloffFactor)!==null&&o!==void 0?o:this.rolloffFactor,this.refDistance=(a=t.refDistance)!==null&&a!==void 0?a:this.refDistance,this.distanceModel=(s=t.distanceModel)!==null&&s!==void 0?s:this.distanceModel,this._playbackRate=(c=t.playbackRate)!==null&&c!==void 0?c:this._playbackRate,this._length=(_=t.length)!==null&&_!==void 0?_:void 0,this._offset=(b=t.offset)!==null&&b!==void 0?b:void 0,this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))},n.prototype._createSpatialParameters=function(){G.a.audioEngine.canUseWebAudio&&G.a.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=G.a.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))},n.prototype._updateSpatialParameters=function(){this.spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))},n.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF",this._switchPanningModel()},n.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower",this._switchPanningModel()},n.prototype._switchPanningModel=function(){G.a.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)},n.prototype.connectToSoundTrackAudioNode=function(t){G.a.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(t),this._isOutputConnected=!0)},n.prototype.setDirectionalCone=function(t,e,i){if(e<t){d.a.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,this._coneOuterAngle=e,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))},Object.defineProperty(n.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(t){if(t!=this._coneInnerAngle){if(this._coneOuterAngle<t){d.a.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,G.a.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(t){if(t!=this._coneOuterAngle){if(t<this._coneInnerAngle){d.a.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=t,G.a.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}},enumerable:!1,configurable:!0}),n.prototype.setPosition=function(t){this._position=t,G.a.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z)},n.prototype.setLocalDirectionToMesh=function(t){this._localDirection=t,G.a.audioEngine.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()},n.prototype._updateDirection=function(){if(!(!this._connectedTransformNode||!this._soundPanner)){var t=this._connectedTransformNode.getWorldMatrix(),e=l.e.TransformNormal(this._localDirection,t);e.normalize(),this._soundPanner.setOrientation(e.x,e.y,e.z)}},n.prototype.updateDistanceFromListener=function(){if(G.a.audioEngine.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){var t=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}},n.prototype.setAttenuationFunction=function(t){this._customAttenuationFunction=t},n.prototype.play=function(t,e,i){var r=this;if(this._isReadyToPlay&&this._scene.audioEnabled&&G.a.audioEngine.audioContext)try{this._startOffset<0&&(t=-this._startOffset,this._startOffset=0);var o=t?G.a.audioEngine.audioContext.currentTime+t:G.a.audioEngine.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this.spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=G.a.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=function(){r._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){var a=function(){if(G.a.audioEngine.unlocked){var s=r._htmlAudioElement.play();s!==void 0&&s.catch(function(c){G.a.audioEngine.lock(),(r.loop||r.autoplay)&&G.a.audioEngine.onAudioUnlockedObservable.addOnce(function(){a()})})}else(r.loop||r.autoplay)&&G.a.audioEngine.onAudioUnlockedObservable.addOnce(function(){a()})};a()}}else{var a=function(){if(G.a.audioEngine.audioContext){if(i=i||r._length,e=e||r._offset,r._soundSource){var c=r._soundSource;c.onended=function(){c.disconnect()}}if(r._soundSource=G.a.audioEngine.audioContext.createBufferSource(),r._soundSource&&r._inputAudioNode){r._soundSource.buffer=r._audioBuffer,r._soundSource.connect(r._inputAudioNode),r._soundSource.loop=r.loop,e!==void 0&&(r._soundSource.loopStart=e),i!==void 0&&(r._soundSource.loopEnd=(e|0)+i),r._soundSource.playbackRate.value=r._playbackRate,r._soundSource.onended=function(){r._onended()},o=t?G.a.audioEngine.audioContext.currentTime+t:G.a.audioEngine.audioContext.currentTime;var _=r.isPaused?r._startOffset%r._soundSource.buffer.duration:e||0;r._soundSource.start(o,_,r.loop?void 0:i)}}};G.a.audioEngine.audioContext.state==="suspended"?setTimeout(function(){G.a.audioEngine.audioContext.state==="suspended"?(G.a.audioEngine.lock(),(r.loop||r.autoplay)&&G.a.audioEngine.onAudioUnlockedObservable.addOnce(function(){a()})):a()},500):a()}this._startTime=o,this.isPlaying=!0,this.isPaused=!1}catch(s){d.a.Error("Error while trying to play audio: "+this.name+", "+s.message)}},n.prototype._onended=function(){this.isPlaying=!1,this._startOffset=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)},n.prototype.stop=function(t){var e=this;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(G.a.audioEngine.audioContext&&this._soundSource){var i=t?G.a.audioEngine.audioContext.currentTime+t:void 0;this._soundSource.stop(i),i===void 0?this.isPlaying=!1:this._soundSource.onended=function(){e.isPlaying=!1},this.isPaused||(this._startOffset=0)}}},n.prototype.pause=function(){this.isPlaying&&(this.isPaused=!0,this._streaming?this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect():G.a.audioEngine.audioContext&&(this.stop(0),this._startOffset+=G.a.audioEngine.audioContext.currentTime-this._startTime))},n.prototype.setVolume=function(t,e){G.a.audioEngine.canUseWebAudio&&this._soundGain&&(e&&G.a.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(G.a.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,G.a.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(t,G.a.audioEngine.audioContext.currentTime+e)):this._soundGain.gain.value=t),this._volume=t},n.prototype.setPlaybackRate=function(t){this._playbackRate=t,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))},n.prototype.getVolume=function(){return this._volume},n.prototype.attachToMesh=function(t){var e=this;this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=t,this.spatialSound||(this.spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=function(i){return e._onRegisterAfterWorldMatrixUpdate(i)},this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)},n.prototype.detachFromMesh=function(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)},n.prototype._onRegisterAfterWorldMatrixUpdate=function(t){if(!t.getBoundingInfo)this.setPosition(t.absolutePosition);else{var e=t,i=e.getBoundingInfo();this.setPosition(i.boundingSphere.centerWorld)}G.a.audioEngine.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()},n.prototype.clone=function(){var t=this;if(this._streaming)return null;var e=function(){t._isReadyToPlay?(r._audioBuffer=t.getAudioBuffer(),r._isReadyToPlay=!0,r.autoplay&&r.play(0,t._offset,t._length)):window.setTimeout(e,300)},i={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},r=new n(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,i);return this.useCustomAttenuation&&r.setAttenuationFunction(this._customAttenuationFunction),r.setPosition(this._position),r.setPlaybackRate(this._playbackRate),e(),r},n.prototype.getAudioBuffer=function(){return this._audioBuffer},n.prototype.getSoundSource=function(){return this._soundSource},n.prototype.getSoundGain=function(){return this._soundGain},n.prototype.serialize=function(){var t={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this.spatialSound&&(this._connectedTransformNode&&(t.connectedMeshId=this._connectedTransformNode.id),t.position=this._position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this._coneInnerAngle,t.coneOuterAngle=this._coneOuterAngle,t.coneOuterGain=this._coneOuterGain),t},n.Parse=function(t,e,i,r){var o=t.name,a;t.url?a=i+t.url:a=i+o;var s={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate},c;if(!r)c=new n(o,a,e,function(){e._removePendingData(c)},s),e._addPendingData(c);else{var _=function(){r._isReadyToPlay?(c._audioBuffer=r.getAudioBuffer(),c._isReadyToPlay=!0,c.autoplay&&c.play(0,c._offset,c._length)):window.setTimeout(_,300)};c=new n(o,new ArrayBuffer(0),e,null,s),_()}if(t.position){var b=l.e.FromArray(t.position);c.setPosition(b)}if(t.isDirectional&&(c.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){var C=l.e.FromArray(t.localDirectionToMesh);c.setLocalDirectionToMesh(C)}if(t.connectedMeshId){var x=e.getMeshByID(t.connectedMeshId);x&&c.attachToMesh(x)}return t.metadata&&(c.metadata=t.metadata),c},n._SceneComponentInitialization=function(t){throw Re.a.WarnImport("AudioSceneComponent")},n}(),Ce=function(){function n(t,e){e===void 0&&(e={}),this.id=-1,this._isInitialized=!1,this._scene=t,this.soundCollection=new Array,this._options=e,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1)}return n.prototype._initializeSoundTrackAudioGraph=function(){G.a.audioEngine.canUseWebAudio&&G.a.audioEngine.audioContext&&(this._outputAudioNode=G.a.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(G.a.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)},n.prototype.dispose=function(){if(G.a.audioEngine&&G.a.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}},n.prototype.addSound=function(t){this._isInitialized||this._initializeSoundTrackAudioGraph(),G.a.audioEngine.canUseWebAudio&&this._outputAudioNode&&t.connectToSoundTrackAudioNode(this._outputAudioNode),t.soundTrackId&&(t.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(t):this._scene.soundTracks&&this._scene.soundTracks[t.soundTrackId].removeSound(t)),this.soundCollection.push(t),t.soundTrackId=this.id},n.prototype.removeSound=function(t){var e=this.soundCollection.indexOf(t);e!==-1&&this.soundCollection.splice(e,1)},n.prototype.setVolume=function(t){G.a.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=t)},n.prototype.switchPanningModelToHRTF=function(){if(G.a.audioEngine.canUseWebAudio)for(var t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()},n.prototype.switchPanningModelToEqualPower=function(){if(G.a.audioEngine.canUseWebAudio)for(var t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()},n.prototype.connectToAnalyser=function(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=t,G.a.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,G.a.audioEngine.masterGain))},n}(),X=u(452),ae=u(449),ee=u(589);T.a.AddParser(X.a.NAME_AUDIO,function(n,t,e,i){var r=[],o;if(e.sounds=e.sounds||[],n.sounds!==void 0&&n.sounds!==null)for(var a=0,s=n.sounds.length;a<s;a++){var c=n.sounds[a];G.a.audioEngine.canUseWebAudio?(c.url||(c.url=c.name),r[c.url]?e.sounds.push(Ie.Parse(c,t,i,r[c.url])):(o=Ie.Parse(c,t,i),r[c.url]=o,e.sounds.push(o))):e.sounds.push(new Ie(c.name,null,t))}r=[]}),Object.defineProperty(ae.a.prototype,"mainSoundTrack",{get:function(){var n=this._getComponent(X.a.NAME_AUDIO);return n||(n=new w(this),this._addComponent(n)),this._mainSoundTrack||(this._mainSoundTrack=new Ce(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),ae.a.prototype.getSoundByName=function(n){var t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===n)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks){for(var e=0;e<this.soundTracks.length;e++)for(t=0;t<this.soundTracks[e].soundCollection.length;t++)if(this.soundTracks[e].soundCollection[t].name===n)return this.soundTracks[e].soundCollection[t]}return null},Object.defineProperty(ae.a.prototype,"audioEnabled",{get:function(){var n=this._getComponent(X.a.NAME_AUDIO);return n||(n=new w(this),this._addComponent(n)),n.audioEnabled},set:function(n){var t=this._getComponent(X.a.NAME_AUDIO);t||(t=new w(this),this._addComponent(t)),n?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(ae.a.prototype,"headphone",{get:function(){var n=this._getComponent(X.a.NAME_AUDIO);return n||(n=new w(this),this._addComponent(n)),n.headphone},set:function(n){var t=this._getComponent(X.a.NAME_AUDIO);t||(t=new w(this),this._addComponent(t)),n?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(ae.a.prototype,"audioListenerPositionProvider",{get:function(){var n=this._getComponent(X.a.NAME_AUDIO);return n||(n=new w(this),this._addComponent(n)),n.audioListenerPositionProvider},set:function(n){var t=this._getComponent(X.a.NAME_AUDIO);if(t||(t=new w(this),this._addComponent(t)),typeof n!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=n},enumerable:!0,configurable:!0}),Object.defineProperty(ae.a.prototype,"audioPositioningRefreshRate",{get:function(){var n=this._getComponent(X.a.NAME_AUDIO);return n||(n=new w(this),this._addComponent(n)),n.audioPositioningRefreshRate},set:function(n){var t=this._getComponent(X.a.NAME_AUDIO);t||(t=new w(this),this._addComponent(t)),t.audioPositioningRefreshRate=n},enumerable:!0,configurable:!0});var w=function(){function n(t){this.name=X.a.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this._audioListenerPositionProvider=null,this._cachedCameraDirection=new l.e,this._cachedCameraPosition=new l.e,this._lastCheck=0,this.scene=t,t.soundTracks=new Array,t.sounds=new Array}return Object.defineProperty(n.prototype,"audioEnabled",{get:function(){return this._audioEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"headphone",{get:function(){return this._headphone},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"audioListenerPositionProvider",{get:function(){return this._audioListenerPositionProvider},set:function(t){this._audioListenerPositionProvider=t},enumerable:!1,configurable:!0}),n.prototype.register=function(){this.scene._afterRenderStage.registerStep(X.a.STEP_AFTERRENDER_AUDIO,this,this._afterRender)},n.prototype.rebuild=function(){},n.prototype.serialize=function(t){if(t.sounds=[],this.scene.soundTracks)for(var e=0;e<this.scene.soundTracks.length;e++)for(var i=this.scene.soundTracks[e],r=0;r<i.soundCollection.length;r++)t.sounds.push(i.soundCollection[r].serialize())},n.prototype.addFromContainer=function(t){var e=this;!t.sounds||t.sounds.forEach(function(i){i.play(),i.autoplay=!0,e.scene.mainSoundTrack.addSound(i)})},n.prototype.removeFromContainer=function(t,e){var i=this;e===void 0&&(e=!1),!!t.sounds&&t.sounds.forEach(function(r){r.stop(),r.autoplay=!1,i.scene.mainSoundTrack.removeSound(r),e&&r.dispose()})},n.prototype.dispose=function(){var t=this.scene;if(t._mainSoundTrack&&t.mainSoundTrack.dispose(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].dispose()},n.prototype.disableAudio=function(){var t=this.scene;this._audioEnabled=!1,G.a.audioEngine&&G.a.audioEngine.audioContext&&G.a.audioEngine.audioContext.suspend();var e;for(e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].pause();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(var i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].pause()},n.prototype.enableAudio=function(){var t=this.scene;this._audioEnabled=!0,G.a.audioEngine&&G.a.audioEngine.audioContext&&G.a.audioEngine.audioContext.resume();var e;for(e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].isPaused&&t.mainSoundTrack.soundCollection[e].play();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(var i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].isPaused&&t.soundTracks[e].soundCollection[i].play()},n.prototype.switchAudioModeForHeadphones=function(){var t=this.scene;if(this._headphone=!0,t.mainSoundTrack.switchPanningModelToHRTF(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToHRTF()},n.prototype.switchAudioModeForNormalSpeakers=function(){var t=this.scene;if(this._headphone=!1,t.mainSoundTrack.switchPanningModelToEqualPower(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToEqualPower()},n.prototype._afterRender=function(){var t=ee.a.Now;if(!(this._lastCheck&&t-this._lastCheck<this.audioPositioningRefreshRate)){this._lastCheck=t;var e=this.scene;if(!(!this._audioEnabled||!e._mainSoundTrack||!e.soundTracks||e._mainSoundTrack.soundCollection.length===0&&e.soundTracks.length===1)){var i=G.a.audioEngine;if(!!i&&i.audioContext){if(this._audioListenerPositionProvider){var r=this._audioListenerPositionProvider();r.x=r.x||0,r.y=r.y||0,r.z=r.z||0,i.audioContext.listener.setPosition(r.x,r.y,r.z)}else{var o;if(e.activeCameras&&e.activeCameras.length>0?o=e.activeCameras[0]:o=e.activeCamera,o){this._cachedCameraPosition.equals(o.globalPosition)||(this._cachedCameraPosition.copyFrom(o.globalPosition),i.audioContext.listener.setPosition(o.globalPosition.x,o.globalPosition.y,o.globalPosition.z)),o.rigCameras&&o.rigCameras.length>0&&(o=o.rigCameras[0]);var a=l.a.Invert(o.getViewMatrix()),s=l.e.TransformNormal(n._CameraDirection,a);s.normalize(),!isNaN(s.x)&&!isNaN(s.y)&&!isNaN(s.z)&&(this._cachedCameraDirection.equals(s)||(this._cachedCameraDirection.copyFrom(s),i.audioContext.listener.setOrientation(s.x,s.y,s.z,0,1,0)))}else i.audioContext.listener.setPosition(0,0,0)}var c;for(c=0;c<e.mainSoundTrack.soundCollection.length;c++){var _=e.mainSoundTrack.soundCollection[c];_.useCustomAttenuation&&_.updateDistanceFromListener()}if(e.soundTracks)for(c=0;c<e.soundTracks.length;c++)for(var b=0;b<e.soundTracks[c].soundCollection.length;b++)_=e.soundTracks[c].soundCollection[b],_.useCustomAttenuation&&_.updateDistanceFromListener()}}}},n._CameraDirection=new l.e(0,0,-1),n}();Ie._SceneComponentInitialization=function(n){var t=n._getComponent(X.a.NAME_AUDIO);t||(t=new w(n),n._addComponent(t))};var N=function(){function n(t,e,i){var r=this;if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],e.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=t,this._weights=i;for(var o=0,a=0,s=i;a<s.length;a++){var c=s[a];o+=c}for(var _=o>0?1/o:0,b=0;b<this._weights.length;b++)this._weights[b]*=_;this._sounds=e;for(var C=0,x=this._sounds;C<x.length;C++){var V=x[C];V.onEndedObservable.add(function(){r._onended()})}}return Object.defineProperty(n.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(t){if(t!==this._coneInnerAngle){if(this._coneOuterAngle<t){d.a.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t;for(var e=0,i=this._sounds;e<i.length;e++){var r=i[e];r.directionalConeInnerAngle=t}}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(t){if(t!==this._coneOuterAngle){if(t<this._coneInnerAngle){d.a.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=t;for(var e=0,i=this._sounds;e<i.length;e++){var r=i[e];r.directionalConeOuterAngle=t}}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"volume",{get:function(){return this._volume},set:function(t){if(t!==this._volume)for(var e=0,i=this._sounds;e<i.length;e++){var r=i[e];r.setVolume(t)}},enumerable:!1,configurable:!0}),n.prototype._onended=function(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1},n.prototype.pause=function(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()},n.prototype.stop=function(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()},n.prototype.play=function(t){if(!this.isPaused){this.stop();for(var e=Math.random(),i=0,r=0;r<this._weights.length;r++)if(i+=this._weights[r],e<=i){this._currentIndex=r;break}}var o=this._sounds[this._currentIndex];o.isReady()?o.play(0,this.isPaused?void 0:t):o.autoplay=!0,this.isPlaying=!0,this.isPaused=!1},n}(),W=u(722),$=u(723),J=u(724),le=function(){function n(t,e,i,r){e===void 0&&(e=new l.e),i===void 0&&(i=0),r===void 0&&(r=!1),this.direction=t,this.rotatedDirection=e,this.diff=i,this.ignore=r}return n}(),ne=function(){function n(t){this.ui=t,this.name="AttachToBoxBehavior",this.distanceAwayFromFace=.15,this.distanceAwayFromBottomOfFace=.15,this._faceVectors=[new le(l.e.Up()),new le(l.e.Down()),new le(l.e.Left()),new le(l.e.Right()),new le(l.e.Forward()),new le(l.e.Forward().scaleInPlace(-1))],this._tmpMatrix=new l.a,this._tmpVector=new l.e,this._zeroVector=l.e.Zero(),this._lookAtTmpMatrix=new l.a}return n.prototype.init=function(){},n.prototype._closestFace=function(t){var e=this;return this._faceVectors.forEach(function(i){e._target.rotationQuaternion||(e._target.rotationQuaternion=l.b.RotationYawPitchRoll(e._target.rotation.y,e._target.rotation.x,e._target.rotation.z)),e._target.rotationQuaternion.toRotationMatrix(e._tmpMatrix),l.e.TransformCoordinatesToRef(i.direction,e._tmpMatrix,i.rotatedDirection),i.diff=l.e.GetAngleBetweenVectors(i.rotatedDirection,t,l.e.Cross(i.rotatedDirection,t))}),this._faceVectors.reduce(function(i,r){return i.ignore?r:r.ignore||i.diff<r.diff?i:r},this._faceVectors[0])},n.prototype._lookAtToRef=function(t,e,i){e===void 0&&(e=new l.e(0,1,0)),l.a.LookAtLHToRef(this._zeroVector,t,e,this._lookAtTmpMatrix),this._lookAtTmpMatrix.invert(),l.b.FromRotationMatrixToRef(this._lookAtTmpMatrix,i)},n.prototype.attach=function(t){var e=this;this._target=t,this._scene=this._target.getScene(),this._onRenderObserver=this._scene.onBeforeRenderObservable.add(function(){if(!!e._scene.activeCamera){var i=e._scene.activeCamera.position;e._scene.activeCamera.devicePosition&&(i=e._scene.activeCamera.devicePosition);var r=e._closestFace(i.subtract(t.position));e._scene.activeCamera.leftCamera?e._scene.activeCamera.leftCamera.computeWorldMatrix().getRotationMatrixToRef(e._tmpMatrix):e._scene.activeCamera.computeWorldMatrix().getRotationMatrixToRef(e._tmpMatrix),l.e.TransformCoordinatesToRef(l.e.Up(),e._tmpMatrix,e._tmpVector),e._faceVectors.forEach(function(a){r.direction.x&&a.direction.x&&(a.ignore=!0),r.direction.y&&a.direction.y&&(a.ignore=!0),r.direction.z&&a.direction.z&&(a.ignore=!0)});var o=e._closestFace(e._tmpVector);e._faceVectors.forEach(function(a){a.ignore=!1}),e.ui.position.copyFrom(t.position),r.direction.x&&(r.rotatedDirection.scaleToRef(t.scaling.x/2+e.distanceAwayFromFace,e._tmpVector),e.ui.position.addInPlace(e._tmpVector)),r.direction.y&&(r.rotatedDirection.scaleToRef(t.scaling.y/2+e.distanceAwayFromFace,e._tmpVector),e.ui.position.addInPlace(e._tmpVector)),r.direction.z&&(r.rotatedDirection.scaleToRef(t.scaling.z/2+e.distanceAwayFromFace,e._tmpVector),e.ui.position.addInPlace(e._tmpVector)),e.ui.rotationQuaternion||(e.ui.rotationQuaternion=l.b.RotationYawPitchRoll(e.ui.rotation.y,e.ui.rotation.x,e.ui.rotation.z)),r.rotatedDirection.scaleToRef(-1,e._tmpVector),e._lookAtToRef(e._tmpVector,o.rotatedDirection,e.ui.rotationQuaternion),o.direction.x&&e.ui.up.scaleToRef(e.distanceAwayFromBottomOfFace-t.scaling.x/2,e._tmpVector),o.direction.y&&e.ui.up.scaleToRef(e.distanceAwayFromBottomOfFace-t.scaling.y/2,e._tmpVector),o.direction.z&&e.ui.up.scaleToRef(e.distanceAwayFromBottomOfFace-t.scaling.z/2,e._tmpVector),e.ui.position.addInPlace(e._tmpVector)}})},n.prototype.detach=function(){this._scene.onBeforeRenderObservable.remove(this._onRenderObserver)},n}(),be=function(){function n(){var t=this;this.delay=0,this.fadeInTime=300,this._millisecondsPerFrame=1e3/60,this._hovered=!1,this._hoverValue=0,this._ownerNode=null,this._update=function(){if(t._ownerNode){if(t._hoverValue+=t._hovered?t._millisecondsPerFrame:-t._millisecondsPerFrame,t._setAllVisibility(t._ownerNode,(t._hoverValue-t.delay)/t.fadeInTime),t._ownerNode.visibility>1){t._setAllVisibility(t._ownerNode,1),t._hoverValue=t.fadeInTime+t.delay;return}else if(t._ownerNode.visibility<0&&(t._setAllVisibility(t._ownerNode,0),t._hoverValue<0)){t._hoverValue=0;return}setTimeout(t._update,t._millisecondsPerFrame)}}}return Object.defineProperty(n.prototype,"name",{get:function(){return"FadeInOut"},enumerable:!1,configurable:!0}),n.prototype.init=function(){},n.prototype.attach=function(t){this._ownerNode=t,this._setAllVisibility(this._ownerNode,0)},n.prototype.detach=function(){this._ownerNode=null},n.prototype.fadeIn=function(t){this._hovered=t,this._update()},n.prototype._setAllVisibility=function(t,e){var i=this;t.visibility=e,t.getChildMeshes().forEach(function(r){i._setAllVisibility(r,e)})},n}(),Me=u(505),Te=function(){function n(){this._startDistance=0,this._initialScale=new l.e(0,0,0),this._targetScale=new l.e(0,0,0),this._sceneRenderObserver=null,this._dragBehaviorA=new Me.a({}),this._dragBehaviorA.moveAttached=!1,this._dragBehaviorB=new Me.a({}),this._dragBehaviorB.moveAttached=!1}return Object.defineProperty(n.prototype,"name",{get:function(){return"MultiPointerScale"},enumerable:!1,configurable:!0}),n.prototype.init=function(){},n.prototype._getCurrentDistance=function(){return this._dragBehaviorA.lastDragPosition.subtract(this._dragBehaviorB.lastDragPosition).length()},n.prototype.attach=function(t){var e=this;this._ownerNode=t,this._dragBehaviorA.onDragStartObservable.add(function(i){e._dragBehaviorA.dragging&&e._dragBehaviorB.dragging&&(e._dragBehaviorA.currentDraggingPointerID==e._dragBehaviorB.currentDraggingPointerID?e._dragBehaviorA.releaseDrag():(e._initialScale.copyFrom(t.scaling),e._startDistance=e._getCurrentDistance()))}),this._dragBehaviorB.onDragStartObservable.add(function(i){e._dragBehaviorA.dragging&&e._dragBehaviorB.dragging&&(e._dragBehaviorA.currentDraggingPointerID==e._dragBehaviorB.currentDraggingPointerID?e._dragBehaviorB.releaseDrag():(e._initialScale.copyFrom(t.scaling),e._startDistance=e._getCurrentDistance()))}),[this._dragBehaviorA,this._dragBehaviorB].forEach(function(i){i.onDragObservable.add(function(){if(e._dragBehaviorA.dragging&&e._dragBehaviorB.dragging){var r=e._getCurrentDistance()/e._startDistance;e._initialScale.scaleToRef(r,e._targetScale)}})}),t.addBehavior(this._dragBehaviorA),t.addBehavior(this._dragBehaviorB),this._sceneRenderObserver=t.getScene().onBeforeRenderObservable.add(function(){if(e._dragBehaviorA.dragging&&e._dragBehaviorB.dragging){var i=e._targetScale.subtract(t.scaling).scaleInPlace(.1);i.length()>.01&&t.scaling.addInPlace(i)}})},n.prototype.detach=function(){var t=this;this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),[this._dragBehaviorA,this._dragBehaviorB].forEach(function(e){e.onDragStartObservable.clear(),e.onDragObservable.clear(),t._ownerNode.removeBehavior(e)})},n}(),Ae=u(462),se=u(464),te=u(451),he=u(546),de=function(){function n(){this._sceneRenderObserver=null,this._targetPosition=new l.e(0,0,0),this._moving=!1,this._startingOrientation=new l.b,this._attachedToElement=!1,this.zDragFactor=3,this.rotateDraggedObject=!0,this.dragging=!1,this.dragDeltaRatio=.2,this.currentDraggingPointerID=-1,this.detachCameraControls=!0,this.onDragStartObservable=new g.c,this.onDragObservable=new g.c,this.onDragEndObservable=new g.c}return Object.defineProperty(n.prototype,"name",{get:function(){return"SixDofDrag"},enumerable:!1,configurable:!0}),n.prototype.init=function(){},Object.defineProperty(n.prototype,"_pointerCamera",{get:function(){return this._scene.cameraToUseForPointers?this._scene.cameraToUseForPointers:this._scene.activeCamera},enumerable:!1,configurable:!0}),n.prototype.attach=function(t){var e=this;this._ownerNode=t,this._scene=this._ownerNode.getScene(),n._virtualScene||(n._virtualScene=new ae.a(this._scene.getEngine(),{virtual:!0}),n._virtualScene.detachControl(),this._scene.getEngine().scenes.pop());var i=null,r=new l.e(0,0,0);this._virtualOriginMesh=new Ae.a("",n._virtualScene),this._virtualOriginMesh.rotationQuaternion=new l.b,this._virtualDragMesh=new Ae.a("",n._virtualScene),this._virtualDragMesh.rotationQuaternion=new l.b;var o=function(s){return e._ownerNode==s||s.isDescendantOf(e._ownerNode)};this._pointerObserver=this._scene.onPointerObservable.add(function(s,c){if(s.type==se.a.POINTERDOWN){if(!e.dragging&&s.pickInfo&&s.pickInfo.hit&&s.pickInfo.pickedMesh&&s.pickInfo.ray&&o(s.pickInfo.pickedMesh)){e._pointerCamera&&e._pointerCamera.cameraRigMode==te.a.RIG_MODE_NONE&&s.pickInfo.ray.origin.copyFrom(e._pointerCamera.globalPosition),i=e._ownerNode,he.a._RemoveAndStorePivotPoint(i),r.copyFrom(s.pickInfo.ray.origin),e._virtualOriginMesh.position.copyFrom(s.pickInfo.ray.origin),e._virtualOriginMesh.lookAt(s.pickInfo.ray.origin.add(s.pickInfo.ray.direction)),e._virtualOriginMesh.removeChild(e._virtualDragMesh),i.computeWorldMatrix(),e._virtualDragMesh.position.copyFrom(i.absolutePosition),i.rotationQuaternion||(i.rotationQuaternion=l.b.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z));var _=i.parent;i.setParent(null),e._virtualDragMesh.rotationQuaternion.copyFrom(i.rotationQuaternion),i.setParent(_),e._virtualOriginMesh.addChild(e._virtualDragMesh),e._targetPosition.copyFrom(e._virtualDragMesh.absolutePosition),e.dragging=!0,e.currentDraggingPointerID=s.event.pointerId,e.detachCameraControls&&e._pointerCamera&&!e._pointerCamera.leftCamera&&(e._pointerCamera.inputs.attachedToElement?(e._pointerCamera.detachControl(),e._attachedToElement=!0):e._attachedToElement=!1),he.a._RestorePivotPoint(i),e.onDragStartObservable.notifyObservers({})}}else if(s.type==se.a.POINTERUP||s.type==se.a.POINTERDOUBLETAP)e.currentDraggingPointerID==s.event.pointerId&&(e.dragging=!1,e._moving=!1,e.currentDraggingPointerID=-1,i=null,e._virtualOriginMesh.removeChild(e._virtualDragMesh),e.detachCameraControls&&e._attachedToElement&&e._pointerCamera&&!e._pointerCamera.leftCamera&&(e._pointerCamera.attachControl(!0),e._attachedToElement=!1),e.onDragEndObservable.notifyObservers({}));else if(s.type==se.a.POINTERMOVE&&e.currentDraggingPointerID==s.event.pointerId&&e.dragging&&s.pickInfo&&s.pickInfo.ray&&i){var b=e.zDragFactor;e._pointerCamera&&e._pointerCamera.cameraRigMode==te.a.RIG_MODE_NONE&&(s.pickInfo.ray.origin.copyFrom(e._pointerCamera.globalPosition),b=0);var C=s.pickInfo.ray.origin.subtract(r);r.copyFrom(s.pickInfo.ray.origin);var x=-l.e.Dot(C,s.pickInfo.ray.direction);e._virtualOriginMesh.addChild(e._virtualDragMesh),e._virtualDragMesh.position.z-=e._virtualDragMesh.position.z<1?x*e.zDragFactor:x*b*e._virtualDragMesh.position.z,e._virtualDragMesh.position.z<0&&(e._virtualDragMesh.position.z=0),e._virtualOriginMesh.position.copyFrom(s.pickInfo.ray.origin),e._virtualOriginMesh.lookAt(s.pickInfo.ray.origin.add(s.pickInfo.ray.direction)),e._virtualOriginMesh.removeChild(e._virtualDragMesh),e._targetPosition.copyFrom(e._virtualDragMesh.absolutePosition),i.parent&&l.e.TransformCoordinatesToRef(e._targetPosition,l.a.Invert(i.parent.getWorldMatrix()),e._targetPosition),e._moving||e._startingOrientation.copyFrom(e._virtualDragMesh.rotationQuaternion),e._moving=!0}});var a=new l.b;this._sceneRenderObserver=t.getScene().onBeforeRenderObservable.add(function(){if(e.dragging&&e._moving&&i){if(he.a._RemoveAndStorePivotPoint(i),i.position.addInPlace(e._targetPosition.subtract(i.position).scale(e.dragDeltaRatio)),e.rotateDraggedObject){a.copyFrom(e._startingOrientation),a.x=-a.x,a.y=-a.y,a.z=-a.z,e._virtualDragMesh.rotationQuaternion.multiplyToRef(a,a),l.b.RotationYawPitchRollToRef(a.toEulerAngles("xyz").y,0,0,a),a.multiplyToRef(e._startingOrientation,a);var s=i.parent;(!s||s.scaling&&!s.scaling.isNonUniformWithinEpsilon(.001))&&(i.setParent(null),l.b.SlerpToRef(i.rotationQuaternion,a,e.dragDeltaRatio,i.rotationQuaternion),i.setParent(s))}he.a._RestorePivotPoint(i),e.onDragObservable.notifyObservers()}})},n.prototype.detach=function(){this._scene&&(this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._pointerCamera.attachControl(!0),this._attachedToElement=!1),this._scene.onPointerObservable.remove(this._pointerObserver)),this._ownerNode&&this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),this._virtualOriginMesh&&this._virtualOriginMesh.dispose(),this._virtualDragMesh&&this._virtualDragMesh.dispose(),this.onDragEndObservable.clear(),this.onDragObservable.clear(),this.onDragStartObservable.clear()},n}(),Ne=u(542),Le=u(465),pe=function(){function n(t,e,i){if(this.targetPosition=l.e.Zero(),this.poleTargetPosition=l.e.Zero(),this.poleTargetLocalOffset=l.e.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=l.b.Identity(),this._bone1Mat=l.a.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=l.e.Right(),this._slerping=!1,this._adjustRoll=0,this._bone2=e,this._bone1=e.getParent(),!!this._bone1){this.mesh=t;var r=e.getPosition();if(e.getAbsoluteTransform().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,r.x>r.y&&r.x>r.z&&(this._adjustRoll=Math.PI*.5,this._bendAxis.z=1)),this._bone1.length){var o=this._bone1.getScale(),a=this._bone2.getScale();this._bone1Length=this._bone1.length*o.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*a.y*this.mesh.scaling.y}else if(this._bone1.children[0]){t.computeWorldMatrix(!0);var s=this._bone2.children[0].getAbsolutePosition(t),c=this._bone2.getAbsolutePosition(t),_=this._bone1.getAbsolutePosition(t);this._bone1Length=l.e.Distance(s,c),this._bone2Length=l.e.Distance(c,_)}this._bone1.getRotationMatrixToRef(Le.c.WORLD,t,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}}return Object.defineProperty(n.prototype,"maxAngle",{get:function(){return this._maxAngle},set:function(t){this._setMaxAngle(t)},enumerable:!1,configurable:!0}),n.prototype._setMaxAngle=function(t){t<0&&(t=0),(t>Math.PI||t==null)&&(t=Math.PI),this._maxAngle=t;var e=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(e*e+i*i-2*e*i*Math.cos(t))},n.prototype.update=function(){var t=this._bone1;if(!!t){var e=this.targetPosition,i=this.poleTargetPosition,r=n._tmpMats[0],o=n._tmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,i):this.poleTargetMesh&&l.e.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),i);var a=n._tmpVecs[0],s=n._tmpVecs[1],c=n._tmpVecs[2],_=n._tmpVecs[3],b=n._tmpVecs[4],C=n._tmpQuat;t.getAbsolutePositionToRef(this.mesh,a),i.subtractToRef(a,b),b.x==0&&b.y==0&&b.z==0?b.y=1:b.normalize(),e.subtractToRef(a,_),_.normalize(),l.e.CrossToRef(_,b,s),s.normalize(),l.e.CrossToRef(_,s,c),c.normalize(),l.a.FromXYZAxesToRef(c,_,s,r);var x=this._bone1Length,V=this._bone2Length,D=l.e.Distance(a,e);this._maxReach>0&&(D=Math.min(this._maxReach,D));var z=(V*V+D*D-x*x)/(2*V*D),q=(D*D+x*x-V*V)/(2*D*x);z>1&&(z=1),q>1&&(q=1),z<-1&&(z=-1),q<-1&&(q=-1);var ue=Math.acos(z),ge=Math.acos(q),Se=-ue-ge;if(this._rightHandedSystem)l.a.RotationYawPitchRollToRef(0,0,this._adjustRoll,o),o.multiplyToRef(r,r),l.a.RotationAxisToRef(this._bendAxis,ge,o),o.multiplyToRef(r,r);else{var Pe=n._tmpVecs[5];Pe.copyFrom(this._bendAxis),Pe.x*=-1,l.a.RotationAxisToRef(Pe,-ge,o),o.multiplyToRef(r,r)}this.poleAngle&&(l.a.RotationAxisToRef(_,this.poleAngle,o),r.multiplyToRef(o,r)),this._bone1&&(this.slerpAmount<1?(this._slerping||l.b.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),l.b.FromRotationMatrixToRef(r,C),l.b.SlerpToRef(this._bone1Quat,C,this.slerpAmount,this._bone1Quat),Se=this._bone2Ang*(1-this.slerpAmount)+Se*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,Le.c.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(r,Le.c.WORLD,this.mesh),this._bone1Mat.copyFrom(r),this._slerping=!1)),this._bone2.setAxisAngle(this._bendAxis,Se,Le.c.LOCAL),this._bone2Ang=Se}},n._tmpVecs=[l.e.Zero(),l.e.Zero(),l.e.Zero(),l.e.Zero(),l.e.Zero(),l.e.Zero()],n._tmpQuat=l.b.Identity(),n._tmpMats=[l.a.Identity(),l.a.Identity()],n}(),He=u(588),rt=function(){function n(t,e,i,r){if(this.upAxis=l.e.Up(),this.upAxisSpace=Le.c.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=l.b.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=l.e.Forward(),this.mesh=t,this.bone=e,this.target=i,r&&(r.adjustYaw&&(this.adjustYaw=r.adjustYaw),r.adjustPitch&&(this.adjustPitch=r.adjustPitch),r.adjustRoll&&(this.adjustRoll=r.adjustRoll),r.maxYaw!=null?this.maxYaw=r.maxYaw:this.maxYaw=Math.PI,r.minYaw!=null?this.minYaw=r.minYaw:this.minYaw=-Math.PI,r.maxPitch!=null?this.maxPitch=r.maxPitch:this.maxPitch=Math.PI,r.minPitch!=null?this.minPitch=r.minPitch:this.minPitch=-Math.PI,r.slerpAmount!=null&&(this.slerpAmount=r.slerpAmount),r.upAxis!=null&&(this.upAxis=r.upAxis),r.upAxisSpace!=null&&(this.upAxisSpace=r.upAxisSpace),r.yawAxis!=null||r.pitchAxis!=null)){var o=Le.a.Y,a=Le.a.X;r.yawAxis!=null&&(o=r.yawAxis.clone(),o.normalize()),r.pitchAxis!=null&&(a=r.pitchAxis.clone(),a.normalize());var s=l.e.Cross(a,o);this._transformYawPitch=l.a.Identity(),l.a.FromXYZAxesToRef(a,o,s,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}!e.getParent()&&this.upAxisSpace==Le.c.BONE&&(this.upAxisSpace=Le.c.LOCAL)}return Object.defineProperty(n.prototype,"minYaw",{get:function(){return this._minYaw},set:function(t){this._minYaw=t,this._minYawSin=Math.sin(t),this._minYawCos=Math.cos(t),this._maxYaw!=null&&(this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"maxYaw",{get:function(){return this._maxYaw},set:function(t){this._maxYaw=t,this._maxYawSin=Math.sin(t),this._maxYawCos=Math.cos(t),this._minYaw!=null&&(this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"minPitch",{get:function(){return this._minPitch},set:function(t){this._minPitch=t,this._minPitchTan=Math.tan(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"maxPitch",{get:function(){return this._maxPitch},set:function(t){this._maxPitch=t,this._maxPitchTan=Math.tan(t)},enumerable:!1,configurable:!0}),n.prototype.update=function(){if(this.slerpAmount<1&&!this._firstFrameSkipped){this._firstFrameSkipped=!0;return}var t=this.bone,e=n._tmpVecs[0];t.getAbsolutePositionToRef(this.mesh,e);var i=this.target,r=n._tmpMats[0],o=n._tmpMats[1],a=this.mesh,s=t.getParent(),c=n._tmpVecs[1];c.copyFrom(this.upAxis),this.upAxisSpace==Le.c.BONE&&s?(this._transformYawPitch&&l.e.TransformCoordinatesToRef(c,this._transformYawPitchInv,c),s.getDirectionToRef(c,this.mesh,c)):this.upAxisSpace==Le.c.LOCAL&&(a.getDirectionToRef(c,c),(a.scaling.x!=1||a.scaling.y!=1||a.scaling.z!=1)&&c.normalize());var _=!1,b=!1;if((this._maxYaw!=Math.PI||this._minYaw!=-Math.PI)&&(_=!0),(this._maxPitch!=Math.PI||this._minPitch!=-Math.PI)&&(b=!0),_||b){var C=n._tmpMats[2],x=n._tmpMats[3];if(this.upAxisSpace==Le.c.BONE&&c.y==1&&s)s.getRotationMatrixToRef(Le.c.WORLD,this.mesh,C);else if(this.upAxisSpace==Le.c.LOCAL&&c.y==1&&!s)C.copyFrom(a.getWorldMatrix());else{var V=n._tmpVecs[2];V.copyFrom(this._fowardAxis),this._transformYawPitch&&l.e.TransformCoordinatesToRef(V,this._transformYawPitchInv,V),s?s.getDirectionToRef(V,this.mesh,V):a.getDirectionToRef(V,V);var D=l.e.Cross(c,V);D.normalize();var V=l.e.Cross(D,c);l.a.FromXYZAxesToRef(D,c,V,C)}C.invertToRef(x);var z=null;if(b){var q=n._tmpVecs[3];i.subtractToRef(e,q),l.e.TransformCoordinatesToRef(q,x,q),z=Math.sqrt(q.x*q.x+q.z*q.z);var ue=Math.atan2(q.y,z),ge=ue;ue>this._maxPitch?(q.y=this._maxPitchTan*z,ge=this._maxPitch):ue<this._minPitch&&(q.y=this._minPitchTan*z,ge=this._minPitch),ue!=ge&&(l.e.TransformCoordinatesToRef(q,C,q),q.addInPlace(e),i=q)}if(_){var q=n._tmpVecs[4];i.subtractToRef(e,q),l.e.TransformCoordinatesToRef(q,x,q);var Se=Math.atan2(q.x,q.z),Pe=Se;if((Se>this._maxYaw||Se<this._minYaw)&&(z==null&&(z=Math.sqrt(q.x*q.x+q.z*q.z)),this._yawRange>Math.PI?this._isAngleBetween(Se,this._maxYaw,this._midYawConstraint)?(q.z=this._maxYawCos*z,q.x=this._maxYawSin*z,Pe=this._maxYaw):this._isAngleBetween(Se,this._midYawConstraint,this._minYaw)&&(q.z=this._minYawCos*z,q.x=this._minYawSin*z,Pe=this._minYaw):Se>this._maxYaw?(q.z=this._maxYawCos*z,q.x=this._maxYawSin*z,Pe=this._maxYaw):Se<this._minYaw&&(q.z=this._minYawCos*z,q.x=this._minYawSin*z,Pe=this._minYaw)),this._slerping&&this._yawRange>Math.PI){var me=n._tmpVecs[8];me.copyFrom(Le.a.Z),this._transformYawPitch&&l.e.TransformCoordinatesToRef(me,this._transformYawPitchInv,me);var xe=n._tmpMats[4];this._boneQuat.toRotationMatrix(xe),this.mesh.getWorldMatrix().multiplyToRef(xe,xe),l.e.TransformCoordinatesToRef(me,xe,me),l.e.TransformCoordinatesToRef(me,x,me);var Fe=Math.atan2(me.x,me.z),we=this._getAngleBetween(Fe,Se),Ge=this._getAngleBetween(Fe,this._midYawConstraint);if(we>Ge){z==null&&(z=Math.sqrt(q.x*q.x+q.z*q.z));var Xe=this._getAngleBetween(Fe,this._maxYaw),Oe=this._getAngleBetween(Fe,this._minYaw);Oe<Xe?(Pe=Fe+Math.PI*.75,q.z=Math.cos(Pe)*z,q.x=Math.sin(Pe)*z):(Pe=Fe-Math.PI*.75,q.z=Math.cos(Pe)*z,q.x=Math.sin(Pe)*z)}}Se!=Pe&&(l.e.TransformCoordinatesToRef(q,C,q),q.addInPlace(e),i=q)}}var je=n._tmpVecs[5],ke=n._tmpVecs[6],ze=n._tmpVecs[7],Je=n._tmpQuat;i.subtractToRef(e,je),je.normalize(),l.e.CrossToRef(c,je,ke),ke.normalize(),l.e.CrossToRef(je,ke,ze),ze.normalize(),l.a.FromXYZAxesToRef(ke,ze,je,r),!(ke.x===0&&ke.y===0&&ke.z===0)&&(ze.x===0&&ze.y===0&&ze.z===0||je.x===0&&je.y===0&&je.z===0||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(l.a.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,o),o.multiplyToRef(r,r)),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(Le.c.WORLD,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),l.b.FromRotationMatrixToRef(r,Je),l.b.SlerpToRef(this._boneQuat,Je,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,Le.c.WORLD,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),this.bone.setRotationMatrix(r,Le.c.WORLD,this.mesh),this._slerping=!1)))},n.prototype._getAngleDiff=function(t,e){var i=e-t;return i%=Math.PI*2,i>Math.PI?i-=Math.PI*2:i<-Math.PI&&(i+=Math.PI*2),i},n.prototype._getAngleBetween=function(t,e){t%=2*Math.PI,t=t<0?t+2*Math.PI:t,e%=2*Math.PI,e=e<0?e+2*Math.PI:e;var i=0;return t<e?i=e-t:i=t-e,i>Math.PI&&(i=Math.PI*2-i),i},n.prototype._isAngleBetween=function(t,e,i){if(t%=2*Math.PI,t=t<0?t+2*Math.PI:t,e%=2*Math.PI,e=e<0?e+2*Math.PI:e,i%=2*Math.PI,i=i<0?i+2*Math.PI:i,e<i){if(t>e&&t<i)return!0}else if(t>i&&t<e)return!0;return!1},n._tmpVecs=He.a.BuildArray(10,l.e.Zero),n._tmpQuat=l.b.Identity(),n._tmpMats=He.a.BuildArray(5,l.a.Identity),n}(),ot=u(560),et=u(639),ht=u(691),Ee=u(439),At=u(460),Ht=function(){function n(t,e){this.x=t,this.y=e}return n}(),Ot=function(){function n(t,e,i,r,o,a,s){r===void 0&&(r=0),o===void 0&&(o=1),a===void 0&&(a=2),s===void 0&&(s=3),this.id=t,this.index=e,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=n.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=o,this._rightStickAxisX=a,this._rightStickAxisY=s,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}return Object.defineProperty(n.prototype,"isConnected",{get:function(){return this._isConnected},enumerable:!1,configurable:!0}),n.prototype.onleftstickchanged=function(t){this._onleftstickchanged=t},n.prototype.onrightstickchanged=function(t){this._onrightstickchanged=t},Object.defineProperty(n.prototype,"leftStick",{get:function(){return this._leftStick},set:function(t){this._onleftstickchanged&&(this._leftStick.x!==t.x||this._leftStick.y!==t.y)&&this._onleftstickchanged(t),this._leftStick=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightStick",{get:function(){return this._rightStick},set:function(t){this._onrightstickchanged&&(this._rightStick.x!==t.x||this._rightStick.y!==t.y)&&this._onrightstickchanged(t),this._rightStick=t},enumerable:!1,configurable:!0}),n.prototype.update=function(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})},n.prototype.dispose=function(){},n.GAMEPAD=0,n.GENERIC=1,n.XBOX=2,n.POSE_ENABLED=3,n.DUALSHOCK=4,n}(),Ut=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o.onButtonDownObservable=new g.c,o.onButtonUpObservable=new g.c,o.type=Ot.GENERIC,o._buttons=new Array(r.buttons.length),o}return t.prototype.onbuttondown=function(e){this._onbuttondown=e},t.prototype.onbuttonup=function(e){this._onbuttonup=e},t.prototype._setButtonValue=function(e,i,r){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(r),this.onButtonDownObservable.notifyObservers(r)),e===0&&(this._onbuttonup&&this._onbuttonup(r),this.onButtonUpObservable.notifyObservers(r))),e},t.prototype.update=function(){n.prototype.update.call(this);for(var e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()},t}(Ot),Qt=function(){function n(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}return Object.defineProperty(n.prototype,"invertYAxis",{get:function(){return this._yAxisScale!==1},set:function(t){this._yAxisScale=t?-1:1},enumerable:!1,configurable:!0}),n.prototype.attachControl=function(){var t=this,e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(function(i){i.type!==Ot.POSE_ENABLED&&(!t.gamepad||i.type===Ot.XBOX)&&(t.gamepad=i)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(function(i){t.gamepad===i&&(t.gamepad=null)}),this.gamepad=e.getGamepadByType(Ot.XBOX)},n.prototype.detachControl=function(t){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null},n.prototype.checkInputs=function(){if(this.gamepad){var t=this.camera,e=this.gamepad.rightStick;if(e){if(e.x!=0){var i=e.x/this.gamepadRotationSensibility;i!=0&&Math.abs(i)>.005&&(t.inertialAlphaOffset+=i)}if(e.y!=0){var r=e.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(t.inertialBetaOffset+=r)}}var o=this.gamepad.leftStick;if(o&&o.y!=0){var a=o.y/this.gamepadMoveSensibility;a!=0&&Math.abs(a)>.005&&(this.camera.inertialRadiusOffset-=a)}}},n.prototype.getClassName=function(){return"ArcRotateCameraGamepadInput"},n.prototype.getSimpleName=function(){return"gamepad"},Object(p.c)([Object(Ee.c)()],n.prototype,"gamepadRotationSensibility",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"gamepadMoveSensibility",void 0),n}();At.a.ArcRotateCameraGamepadInput=Qt;var Zi=u(726),zi=u(727),li=u(728),Di=u(623);Di.a.prototype.addVRDeviceOrientation=function(){return this.add(new Zt),this};var Zt=function(){function n(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}return n.prototype.attachControl=function(t){var e=this;t=re.b.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(t);var i=this.camera.getScene().getEngine().getHostWindow();i&&(typeof DeviceOrientationEvent!="undefined"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(function(r){r==="granted"?i.addEventListener("deviceorientation",e._deviceOrientationHandler):re.b.Warn("Permission not granted.")}).catch(function(r){re.b.Error(r)}):i.addEventListener("deviceorientation",this._deviceOrientationHandler))},n.prototype._onOrientationEvent=function(t){t.alpha!==null&&(this._alpha=(+t.alpha|0)*this.alphaCorrection),t.gamma!==null&&(this._gamma=(+t.gamma|0)*this.gammaCorrection),this._dirty=!0},n.prototype.checkInputs=function(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)},n.prototype.detachControl=function(t){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)},n.prototype.getClassName=function(){return"ArcRotateCameraVRDeviceOrientationInput"},n.prototype.getSimpleName=function(){return"VRDeviceOrientation"},n}();At.a.ArcRotateCameraVRDeviceOrientationInput=Zt;var _i=u(562),ji=function(){function n(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}return n.prototype.attachControl=function(t){var e=this;t=re.b.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){e._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(i){var r=i.event;if(i.type===_i.a.KEYDOWN){if(e.keysForward.indexOf(r.keyCode)!==-1||e.keysBackward.indexOf(r.keyCode)!==-1||e.keysUp.indexOf(r.keyCode)!==-1||e.keysDown.indexOf(r.keyCode)!==-1||e.keysLeft.indexOf(r.keyCode)!==-1||e.keysRight.indexOf(r.keyCode)!==-1){var o=e._keys.indexOf(r.keyCode);o===-1&&e._keys.push(r.keyCode),t||r.preventDefault()}}else if(e.keysForward.indexOf(r.keyCode)!==-1||e.keysBackward.indexOf(r.keyCode)!==-1||e.keysUp.indexOf(r.keyCode)!==-1||e.keysDown.indexOf(r.keyCode)!==-1||e.keysLeft.indexOf(r.keyCode)!==-1||e.keysRight.indexOf(r.keyCode)!==-1){var o=e._keys.indexOf(r.keyCode);o>=0&&e._keys.splice(o,1),t||r.preventDefault()}}))},n.prototype.detachControl=function(t){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},n.prototype.getClassName=function(){return"FlyCameraKeyboardInput"},n.prototype._onLostFocus=function(t){this._keys=[]},n.prototype.getSimpleName=function(){return"keyboard"},n.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var t=this.camera,e=0;e<this._keys.length;e++){var i=this._keys[e],r=t._computeLocalCameraSpeed();this.keysForward.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,0,r):this.keysBackward.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,0,-r):this.keysUp.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,r,0):this.keysDown.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,-r,0):this.keysRight.indexOf(i)!==-1?t._localDirection.copyFromFloats(r,0,0):this.keysLeft.indexOf(i)!==-1&&t._localDirection.copyFromFloats(-r,0,0),t.getScene().useRightHandedSystem&&(t._localDirection.z*=-1),t.getViewMatrix().invertToRef(t._cameraTransformMatrix),l.e.TransformNormalToRef(t._localDirection,t._cameraTransformMatrix,t._transformedDirection),t.cameraDirection.addInPlace(t._transformedDirection)}},Object(p.c)([Object(Ee.c)()],n.prototype,"keysForward",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysBackward",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysUp",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysDown",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRight",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysLeft",void 0),n}();At.a.FlyCameraKeyboardInput=ji;var yi=function(){function n(t){t===void 0&&(t=!0),this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this.previousPosition=null}return n.prototype.attachControl=function(t){var e=this;t=re.b.BackCompatCameraNoPreventDefault(arguments),this.noPreventDefault=t,this._observer=this.camera.getScene().onPointerObservable.add(function(i,r){e._pointerInput(i,r)},se.a.POINTERDOWN|se.a.POINTERUP|se.a.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(function(){e.camera.rollCorrect&&e.camera.restoreRoll(e.camera.rollCorrect)})},n.prototype.detachControl=function(t){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this.previousPosition=null,this.noPreventDefault=void 0)},n.prototype.getClassName=function(){return"FlyCameraMouseInput"},n.prototype.getSimpleName=function(){return"mouse"},n.prototype._pointerInput=function(t,e){var i=t.event,r=this.camera,o=r.getEngine();if(!o.isInVRExclusivePointerMode&&!(!this.touchEnabled&&i.pointerType==="touch")&&!(t.type!==se.a.POINTERMOVE&&this.buttons.indexOf(i.button)===-1)){var a=i.srcElement||i.target;if(t.type===se.a.POINTERDOWN&&a){try{a.setPointerCapture(i.pointerId)}catch(_){}this.previousPosition={x:i.clientX,y:i.clientY},this.activeButton=i.button,this.noPreventDefault||(i.preventDefault(),this.element.focus()),o.isPointerLock&&this._onMouseMove(t.event)}else if(t.type===se.a.POINTERUP&&a){try{a.releasePointerCapture(i.pointerId)}catch(_){}this.activeButton=-1,this.previousPosition=null,this.noPreventDefault||i.preventDefault()}else if(t.type===se.a.POINTERMOVE){if(!this.previousPosition){o.isPointerLock&&this._onMouseMove(t.event);return}var s=i.clientX-this.previousPosition.x,c=i.clientY-this.previousPosition.y;this.rotateCamera(s,c),this.previousPosition={x:i.clientX,y:i.clientY},this.noPreventDefault||i.preventDefault()}}},n.prototype._onMouseMove=function(t){var e=this.camera,i=e.getEngine();if(!(!i.isPointerLock||i.isInVRExclusivePointerMode)){var r=t.movementX||t.mozMovementX||t.webkitMovementX||t.msMovementX||0,o=t.movementY||t.mozMovementY||t.webkitMovementY||t.msMovementY||0;this.rotateCamera(r,o),this.previousPosition=null,this.noPreventDefault||t.preventDefault()}},n.prototype.rotateCamera=function(t,e){var i=this,r=this.camera,o=this.camera.getScene();o.useRightHandedSystem&&(t*=-1),r.parent&&r.parent._getWorldMatrixDeterminant()<0&&(t*=-1);var a=t/this.angularSensibility,s=e/this.angularSensibility,c=l.b.RotationYawPitchRoll(r.rotation.y,r.rotation.x,r.rotation.z),_;if(this.buttonsPitch.some(function(x){return x===i.activeButton})&&(_=l.b.RotationAxis(Le.a.X,s),c.multiplyInPlace(_)),this.buttonsYaw.some(function(x){return x===i.activeButton})){_=l.b.RotationAxis(Le.a.Y,a),c.multiplyInPlace(_);var b=r.bankedTurnLimit+r._trackRoll;if(r.bankedTurn&&-b<r.rotation.z&&r.rotation.z<b){var C=r.bankedTurnMultiplier*-a;_=l.b.RotationAxis(Le.a.Z,C),c.multiplyInPlace(_)}}this.buttonsRoll.some(function(x){return x===i.activeButton})&&(_=l.b.RotationAxis(Le.a.Z,-a),r._trackRoll-=a,c.multiplyInPlace(_)),c.toEulerAnglesToRef(r.rotation)},Object(p.c)([Object(Ee.c)()],n.prototype,"buttons",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"angularSensibility",void 0),n}();At.a.FlyCameraMouseInput=yi;var ai=function(){function n(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}return n.prototype.attachControl=function(t){var e=this;t=re.b.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){e._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(i){var r=i.event;if(!r.metaKey){if(i.type===_i.a.KEYDOWN){if(e._ctrlPressed=r.ctrlKey,e._altPressed=r.altKey,e._shiftPressed=r.shiftKey,e.keysHeightOffsetIncr.indexOf(r.keyCode)!==-1||e.keysHeightOffsetDecr.indexOf(r.keyCode)!==-1||e.keysRotationOffsetIncr.indexOf(r.keyCode)!==-1||e.keysRotationOffsetDecr.indexOf(r.keyCode)!==-1||e.keysRadiusIncr.indexOf(r.keyCode)!==-1||e.keysRadiusDecr.indexOf(r.keyCode)!==-1){var o=e._keys.indexOf(r.keyCode);o===-1&&e._keys.push(r.keyCode),r.preventDefault&&(t||r.preventDefault())}}else if(e.keysHeightOffsetIncr.indexOf(r.keyCode)!==-1||e.keysHeightOffsetDecr.indexOf(r.keyCode)!==-1||e.keysRotationOffsetIncr.indexOf(r.keyCode)!==-1||e.keysRotationOffsetDecr.indexOf(r.keyCode)!==-1||e.keysRadiusIncr.indexOf(r.keyCode)!==-1||e.keysRadiusDecr.indexOf(r.keyCode)!==-1){var o=e._keys.indexOf(r.keyCode);o>=0&&e._keys.splice(o,1),r.preventDefault&&(t||r.preventDefault())}}}))},n.prototype.detachControl=function(t){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},n.prototype.checkInputs=function(){var t=this;this._onKeyboardObserver&&this._keys.forEach(function(e){t.keysHeightOffsetIncr.indexOf(e)!==-1&&t._modifierHeightOffset()?t.camera.heightOffset+=t.heightSensibility:t.keysHeightOffsetDecr.indexOf(e)!==-1&&t._modifierHeightOffset()?t.camera.heightOffset-=t.heightSensibility:t.keysRotationOffsetIncr.indexOf(e)!==-1&&t._modifierRotationOffset()?(t.camera.rotationOffset+=t.rotationSensibility,t.camera.rotationOffset%=360):t.keysRotationOffsetDecr.indexOf(e)!==-1&&t._modifierRotationOffset()?(t.camera.rotationOffset-=t.rotationSensibility,t.camera.rotationOffset%=360):t.keysRadiusIncr.indexOf(e)!==-1&&t._modifierRadius()?t.camera.radius+=t.radiusSensibility:t.keysRadiusDecr.indexOf(e)!==-1&&t._modifierRadius()&&(t.camera.radius-=t.radiusSensibility)})},n.prototype.getClassName=function(){return"FollowCameraKeyboardMoveInput"},n.prototype.getSimpleName=function(){return"keyboard"},n.prototype._modifierHeightOffset=function(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed},n.prototype._modifierRotationOffset=function(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed},n.prototype._modifierRadius=function(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed},Object(p.c)([Object(Ee.c)()],n.prototype,"keysHeightOffsetIncr",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysHeightOffsetDecr",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysHeightOffsetModifierAlt",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysHeightOffsetModifierCtrl",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysHeightOffsetModifierShift",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRotationOffsetIncr",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRotationOffsetDecr",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRotationOffsetModifierAlt",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRotationOffsetModifierCtrl",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRotationOffsetModifierShift",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRadiusIncr",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRadiusDecr",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRadiusModifierAlt",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRadiusModifierCtrl",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"keysRadiusModifierShift",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"heightSensibility",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"rotationSensibility",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"radiusSensibility",void 0),n}();At.a.FollowCameraKeyboardMoveInput=ai;var Ei=function(){function n(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}return n.prototype.attachControl=function(t){var e=this;t=re.b.BackCompatCameraNoPreventDefault(arguments),this._wheel=function(i,r){if(i.type===se.a.POINTERWHEEL){var o=i.event,a=0,s=Math.max(-1,Math.min(1,o.deltaY||o.wheelDelta||-o.detail));e.wheelDeltaPercentage?(console.assert(e.axisControlRadius+e.axisControlHeight+e.axisControlRotation<=1,"wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+e.axisControlRadius+", axisControlHeightOffset: "+e.axisControlHeight+", axisControlRotationOffset: "+e.axisControlRotation),e.axisControlRadius?a=s*.01*e.wheelDeltaPercentage*e.camera.radius:e.axisControlHeight?a=s*.01*e.wheelDeltaPercentage*e.camera.heightOffset:e.axisControlRotation&&(a=s*.01*e.wheelDeltaPercentage*e.camera.rotationOffset)):a=s*e.wheelPrecision,a&&(e.axisControlRadius?e.camera.radius+=a:e.axisControlHeight?e.camera.heightOffset-=a:e.axisControlRotation&&(e.camera.rotationOffset-=a)),o.preventDefault&&(t||o.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,se.a.POINTERWHEEL)},n.prototype.detachControl=function(t){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)},n.prototype.getClassName=function(){return"ArcRotateCameraMouseWheelInput"},n.prototype.getSimpleName=function(){return"mousewheel"},Object(p.c)([Object(Ee.c)()],n.prototype,"axisControlRadius",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"axisControlHeight",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"axisControlRotation",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"wheelPrecision",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"wheelDeltaPercentage",void 0),n}();At.a.FollowCameraMouseWheelInput=Ei;var Gt=function(n){Object(p.d)(t,n);function t(){var e=n!==null&&n.apply(this,arguments)||this;return e.angularSensibilityX=1,e.angularSensibilityY=1,e.pinchPrecision=1e4,e.pinchDeltaPercentage=0,e.axisXControlRadius=!1,e.axisXControlHeight=!1,e.axisXControlRotation=!0,e.axisYControlRadius=!1,e.axisYControlHeight=!0,e.axisYControlRotation=!1,e.axisPinchControlRadius=!0,e.axisPinchControlHeight=!1,e.axisPinchControlRotation=!1,e.warningEnable=!0,e._warningCounter=0,e}return t.prototype.getClassName=function(){return"FollowCameraPointersInput"},t.prototype.onTouch=function(e,i,r){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=i/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=r/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=i/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=r/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=i/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=r/this.angularSensibilityY)},t.prototype.onMultiTouch=function(e,i,r,o,a,s){if(!(r===0&&a===null)&&!(o===0&&s===null)){var c=(o-r)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(c*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=c*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=c*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=c*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=c),this.axisPinchControlHeight&&(this.camera.heightOffset+=c),this.axisPinchControlRadius&&(this.camera.radius-=c))}},t.prototype._warning=function(){if(!(!this.warningEnable||this._warningCounter++%100!=0)){var e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";console.assert(this.axisXControlRotation+this.axisXControlHeight+this.axisXControlRadius<=1,e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),console.assert(this.axisYControlRotation+this.axisYControlHeight+this.axisYControlRadius<=1,e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),console.assert(this.axisPinchControlRotation+this.axisPinchControlHeight+this.axisPinchControlRadius<=1,e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}},Object(p.c)([Object(Ee.c)()],t.prototype,"angularSensibilityX",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"angularSensibilityY",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"pinchPrecision",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"pinchDeltaPercentage",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisXControlRadius",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisXControlHeight",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisXControlRotation",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisYControlRadius",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisYControlHeight",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisYControlRotation",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisPinchControlRadius",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisPinchControlHeight",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"axisPinchControlRotation",void 0),t}(ht.a);At.a.FollowCameraPointersInput=Gt;var wi=u(531);wi.a.prototype.addDeviceOrientation=function(){return this._deviceOrientationInput||(this._deviceOrientationInput=new ui,this.add(this._deviceOrientationInput)),this};var ui=function(){function n(){var t=this;this._screenOrientationAngle=0,this._screenQuaternion=new l.b,this._alpha=0,this._beta=0,this._gamma=0,this._onDeviceOrientationChangedObservable=new g.c,this._orientationChanged=function(){t._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,t._screenOrientationAngle=-re.b.ToRadians(t._screenOrientationAngle/2),t._screenQuaternion.copyFromFloats(0,Math.sin(t._screenOrientationAngle),0,Math.cos(t._screenOrientationAngle))},this._deviceOrientation=function(e){t._alpha=e.alpha!==null?e.alpha:0,t._beta=e.beta!==null?e.beta:0,t._gamma=e.gamma!==null?e.gamma:0,e.alpha!==null&&t._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new l.b(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}return n.WaitForOrientationChangeAsync=function(t){return new Promise(function(e,i){var r=!1,o=function(){window.removeEventListener("deviceorientation",o),r=!0,e()};t&&setTimeout(function(){r||(window.removeEventListener("deviceorientation",o),i("WaitForOrientationChangeAsync timed out"))},t),typeof DeviceOrientationEvent!="undefined"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(function(a){a=="granted"?window.addEventListener("deviceorientation",o):re.b.Warn("Permission not granted.")}).catch(function(a){re.b.Error(a)}):window.addEventListener("deviceorientation",o)})},Object.defineProperty(n.prototype,"camera",{get:function(){return this._camera},set:function(t){var e=this;this._camera=t,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new l.b),this._camera&&this._camera.onDisposeObservable.add(function(){e._onDeviceOrientationChangedObservable.clear()})},enumerable:!1,configurable:!0}),n.prototype.attachControl=function(){var t=this,e=this.camera.getScene().getEngine().getHostWindow();if(e){var i=function(){e.addEventListener("orientationchange",t._orientationChanged),e.addEventListener("deviceorientation",t._deviceOrientation),t._orientationChanged()};typeof DeviceOrientationEvent!="undefined"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(function(r){r==="granted"?i():re.b.Warn("Permission not granted.")}).catch(function(r){re.b.Error(r)}):i()}},n.prototype.detachControl=function(t){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0},n.prototype.checkInputs=function(){!this._alpha||(l.b.RotationYawPitchRollToRef(re.b.ToRadians(this._alpha),re.b.ToRadians(this._beta),-re.b.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)},n.prototype.getClassName=function(){return"FreeCameraDeviceOrientationInput"},n.prototype.getSimpleName=function(){return"deviceOrientation"},n}();At.a.FreeCameraDeviceOrientationInput=ui;var Wi=function(){function n(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this._yAxisScale=1,this._cameraTransform=l.a.Identity(),this._deltaTransform=l.e.Zero(),this._vector3=l.e.Zero(),this._vector2=l.d.Zero()}return Object.defineProperty(n.prototype,"invertYAxis",{get:function(){return this._yAxisScale!==1},set:function(t){this._yAxisScale=t?-1:1},enumerable:!1,configurable:!0}),n.prototype.attachControl=function(){var t=this,e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(function(i){i.type!==Ot.POSE_ENABLED&&(!t.gamepad||i.type===Ot.XBOX)&&(t.gamepad=i)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(function(i){t.gamepad===i&&(t.gamepad=null)}),this.gamepad=e.getGamepadByType(Ot.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])},n.prototype.detachControl=function(t){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null},n.prototype.checkInputs=function(){if(this.gamepad&&this.gamepad.leftStick){var t=this.camera,e=this.gamepad.leftStick,i=e.x/this.gamepadMoveSensibility,r=e.y/this.gamepadMoveSensibility;e.x=Math.abs(i)>.005?0+i:0,e.y=Math.abs(r)>.005?0+r:0;var o=this.gamepad.rightStick;if(o){var a=o.x/this.gamepadAngularSensibility,s=o.y/this.gamepadAngularSensibility*this._yAxisScale;o.x=Math.abs(a)>.001?0+a:0,o.y=Math.abs(s)>.001?0+s:0}else o={x:0,y:0};t.rotationQuaternion?t.rotationQuaternion.toRotationMatrix(this._cameraTransform):l.a.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,0,this._cameraTransform);var c=t._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(e.x*c,0,-e.y*c),l.e.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),t.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(o.y,o.x),t.cameraRotation.addInPlace(this._vector2)}},n.prototype.getClassName=function(){return"FreeCameraGamepadInput"},n.prototype.getSimpleName=function(){return"gamepad"},Object(p.c)([Object(Ee.c)()],n.prototype,"gamepadAngularSensibility",void 0),Object(p.c)([Object(Ee.c)()],n.prototype,"gamepadMoveSensibility",void 0),n}();At.a.FreeCameraGamepadInput=Wi;var Hi=u(640),Pi=u(641),It=u(642),Ji=u(643),Dr=u(684),Vt;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(Vt||(Vt={}));var Ci=function(){function n(t,e){var i=this,r=Object(p.a)(Object(p.a)({},n._GetDefaultOptions()),e);if(t?this._leftJoystick=!0:this._leftJoystick=!1,n._globalJoystickIndex++,this._axisTargetedByLeftAndRight=Vt.X,this._axisTargetedByUpAndDown=Vt.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new Dr.a,this.deltaPosition=l.e.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=function(a){n.vjCanvasWidth=window.innerWidth,n.vjCanvasHeight=window.innerHeight,n.Canvas&&(n.Canvas.width=n.vjCanvasWidth,n.Canvas.height=n.vjCanvasHeight),n.halfWidth=n.vjCanvasWidth/2},!n.Canvas){window.addEventListener("resize",this._onResize,!1),n.Canvas=document.createElement("canvas"),n.vjCanvasWidth=window.innerWidth,n.vjCanvasHeight=window.innerHeight,n.Canvas.width=window.innerWidth,n.Canvas.height=window.innerHeight,n.Canvas.style.width="100%",n.Canvas.style.height="100%",n.Canvas.style.position="absolute",n.Canvas.style.backgroundColor="transparent",n.Canvas.style.top="0px",n.Canvas.style.left="0px",n.Canvas.style.zIndex="5",n.Canvas.style.msTouchAction="none",n.Canvas.style.touchAction="none",n.Canvas.setAttribute("touch-action","none");var o=n.Canvas.getContext("2d");if(!o)throw new Error("Unable to create canvas for virtual joystick");n.vjCanvasContext=o,n.vjCanvasContext.strokeStyle="#ffffff",n.vjCanvasContext.lineWidth=2,document.body.appendChild(n.Canvas)}n.halfWidth=n.Canvas.width/2,this.pressed=!1,this.limitToContainer=r.limitToContainer,this._joystickColor=r.color,this.containerSize=r.containerSize,this.puckSize=r.puckSize,r.position&&this.setPosition(r.position.x,r.position.y),r.puckImage&&this.setPuckImage(r.puckImage),r.containerImage&&this.setContainerImage(r.containerImage),r.alwaysVisible&&n._alwaysVisibleSticks++,this.alwaysVisible=r.alwaysVisible,this._joystickPointerID=-1,this._joystickPointerPos=new l.d(0,0),this._joystickPreviousPointerPos=new l.d(0,0),this._joystickPointerStartPos=new l.d(0,0),this._deltaJoystickVector=new l.d(0,0),this._onPointerDownHandlerRef=function(a){i._onPointerDown(a)},this._onPointerMoveHandlerRef=function(a){i._onPointerMove(a)},this._onPointerUpHandlerRef=function(a){i._onPointerUp(a)},n.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),n.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),n.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),n.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),n.Canvas.addEventListener("contextmenu",function(a){a.preventDefault()},!1),requestAnimationFrame(function(){i._drawVirtualJoystick()})}return n._GetDefaultOptions=function(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}},n.prototype.setJoystickSensibility=function(t){this._joystickSensibility=t,this._inversedSensibility=1/(this._joystickSensibility/1e3)},n.prototype._onPointerDown=function(t){var e;t.preventDefault(),this._leftJoystick===!0?e=t.clientX<n.halfWidth:e=t.clientX>n.halfWidth,e&&this._joystickPointerID<0?(this._joystickPointerID=t.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(t)):(this._joystickPointerStartPos.x=t.clientX,this._joystickPointerStartPos.y=t.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(t.pointerId.toString(),t)):n._globalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(t.pointerId.toString(),{x:t.clientX,y:t.clientY,prevX:t.clientX,prevY:t.clientY}))},n.prototype._onPointerMove=function(t){if(this._joystickPointerID==t.pointerId){if(this.limitToContainer){var e=new l.d(t.clientX-this._joystickPointerStartPos.x,t.clientY-this._joystickPointerStartPos.y),i=e.length();i>this.containerSize&&e.scaleInPlace(this.containerSize/i),this._joystickPointerPos.x=this._joystickPointerStartPos.x+e.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+e.y}else this._joystickPointerPos.x=t.clientX,this._joystickPointerPos.y=t.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<n._alwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(n.halfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(n.halfWidth,this._joystickPointerPos.x));var r=this.reverseLeftRight?-1:1,o=r*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case Vt.X:this.deltaPosition.x=Math.min(1,Math.max(-1,o));break;case Vt.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,o));break;case Vt.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,o));break}var a=this.reverseUpDown?1:-1,s=a*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case Vt.X:this.deltaPosition.x=Math.min(1,Math.max(-1,s));break;case Vt.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,s));break;case Vt.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,s));break}}else{var c=this._touches.get(t.pointerId.toString());c&&(c.x=t.clientX,c.y=t.clientY)}},n.prototype._onPointerUp=function(t){if(this._joystickPointerID==t.pointerId)this._clearPreviousDraw(),this._joystickPointerID=-1,this.pressed=!1;else{var e=this._touches.get(t.pointerId.toString());e&&n.vjCanvasContext.clearRect(e.prevX-44,e.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(t.pointerId.toString())},n.prototype.setJoystickColor=function(t){this._joystickColor=t},Object.defineProperty(n.prototype,"containerSize",{get:function(){return this._joystickContainerSize},set:function(t){this._joystickContainerSize=t,this._clearContainerSize=~~(this._joystickContainerSize*2.1),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"puckSize",{get:function(){return this._joystickPuckSize},set:function(t){this._joystickPuckSize=t,this._clearPuckSize=~~(this._joystickPuckSize*2.1),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)},enumerable:!1,configurable:!0}),n.prototype.clearPosition=function(){this.alwaysVisible=!1,this._joystickPosition=null},Object.defineProperty(n.prototype,"alwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible!==t&&(t&&this._joystickPosition?(n._alwaysVisibleSticks++,this._alwaysVisible=!0):(n._alwaysVisibleSticks--,this._alwaysVisible=!1))},enumerable:!1,configurable:!0}),n.prototype.setPosition=function(t,e){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new l.d(t,e)},n.prototype.setActionOnTouch=function(t){this._action=t},n.prototype.setAxisForLeftRight=function(t){switch(t){case Vt.X:case Vt.Y:case Vt.Z:this._axisTargetedByLeftAndRight=t;break;default:this._axisTargetedByLeftAndRight=Vt.X;break}},n.prototype.setAxisForUpDown=function(t){switch(t){case Vt.X:case Vt.Y:case Vt.Z:this._axisTargetedByUpAndDown=t;break;default:this._axisTargetedByUpAndDown=Vt.Y;break}},n.prototype._clearPreviousDraw=function(){var t=this._joystickPosition||this._joystickPointerStartPos;n.vjCanvasContext.clearRect(t.x-this._clearContainerSizeOffset,t.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),n.vjCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset,this._clearPuckSize,this._clearPuckSize)},n.prototype.setContainerImage=function(t){var e=this,i=new Image;i.src=t,i.onload=function(){return e._containerImage=i}},n.prototype.setPuckImage=function(t){var e=this,i=new Image;i.src=t,i.onload=function(){return e._puckImage=i}},n.prototype._drawContainer=function(){var t=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?n.vjCanvasContext.drawImage(this._containerImage,t.x-this.containerSize,t.y-this.containerSize,this.containerSize*2,this.containerSize*2):(n.vjCanvasContext.beginPath(),n.vjCanvasContext.strokeStyle=this._joystickColor,n.vjCanvasContext.lineWidth=2,n.vjCanvasContext.arc(t.x,t.y,this.containerSize,0,Math.PI*2,!0),n.vjCanvasContext.stroke(),n.vjCanvasContext.closePath(),n.vjCanvasContext.beginPath(),n.vjCanvasContext.lineWidth=6,n.vjCanvasContext.strokeStyle=this._joystickColor,n.vjCanvasContext.arc(t.x,t.y,this.puckSize,0,Math.PI*2,!0),n.vjCanvasContext.stroke(),n.vjCanvasContext.closePath())},n.prototype._drawPuck=function(){this._puckImage?n.vjCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,this.puckSize*2,this.puckSize*2):(n.vjCanvasContext.beginPath(),n.vjCanvasContext.strokeStyle=this._joystickColor,n.vjCanvasContext.lineWidth=2,n.vjCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,Math.PI*2,!0),n.vjCanvasContext.stroke(),n.vjCanvasContext.closePath())},n.prototype._drawVirtualJoystick=function(){var t=this;this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach(function(e,i){i.pointerId===t._joystickPointerID?(t.alwaysVisible||t._drawContainer(),t._drawPuck(),t._joystickPreviousPointerPos=t._joystickPointerPos.clone()):(n.vjCanvasContext.clearRect(i.prevX-44,i.prevY-44,88,88),n.vjCanvasContext.beginPath(),n.vjCanvasContext.fillStyle="white",n.vjCanvasContext.beginPath(),n.vjCanvasContext.strokeStyle="red",n.vjCanvasContext.lineWidth=6,n.vjCanvasContext.arc(i.x,i.y,40,0,Math.PI*2,!0),n.vjCanvasContext.stroke(),n.vjCanvasContext.closePath(),i.prevX=i.x,i.prevY=i.y)}),requestAnimationFrame(function(){t._drawVirtualJoystick()})},n.prototype.releaseCanvas=function(){n.Canvas&&(n.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),n.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),n.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),n.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(n.Canvas),n.Canvas=null)},n._globalJoystickIndex=0,n._alwaysVisibleSticks=0,n}();wi.a.prototype.addVirtualJoystick=function(){return this.add(new dr),this};var dr=function(){function n(){}return n.prototype.getLeftJoystick=function(){return this._leftjoystick},n.prototype.getRightJoystick=function(){return this._rightjoystick},n.prototype.checkInputs=function(){if(this._leftjoystick){var t=this.camera,e=t._computeLocalCameraSpeed()*50,i=l.a.RotationYawPitchRoll(t.rotation.y,t.rotation.x,0),r=l.e.TransformCoordinates(new l.e(this._leftjoystick.deltaPosition.x*e,this._leftjoystick.deltaPosition.y*e,this._leftjoystick.deltaPosition.z*e),i);t.cameraDirection=t.cameraDirection.add(r),t.cameraRotation=t.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}},n.prototype.attachControl=function(){this._leftjoystick=new Ci(!0),this._leftjoystick.setAxisForUpDown(Vt.Z),this._leftjoystick.setAxisForLeftRight(Vt.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new Ci(!1),this._rightjoystick.setAxisForUpDown(Vt.X),this._rightjoystick.setAxisForLeftRight(Vt.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")},n.prototype.detachControl=function(t){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()},n.prototype.getClassName=function(){return"FreeCameraVirtualJoystickInput"},n.prototype.getSimpleName=function(){return"virtualJoystick"},n}();At.a.FreeCameraVirtualJoystickInput=dr;var Ii=u(528),kt=u(478),Nt=u(453);Nt.a.AddNodeConstructor("TouchCamera",function(n,t){return function(){return new sr(n,l.e.Zero(),t)}});var sr=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o.inputs.addTouch(),o._setupInputs(),o}return Object.defineProperty(t.prototype,"touchAngularSensibility",{get:function(){var e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0},set:function(e){var i=this.inputs.attached.touch;i&&(i.touchAngularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"touchMoveSensibility",{get:function(){var e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0},set:function(e){var i=this.inputs.attached.touch;i&&(i.touchMoveSensibility=e)},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"TouchCamera"},t.prototype._setupInputs=function(){var e=this.inputs.attached.touch,i=this.inputs.attached.mouse;i?i.touchEnabled=!1:e.allowMouse=!0},t}(kt.a),Ai=u(506);Nt.a.AddNodeConstructor("DeviceOrientationCamera",function(n,t){return function(){return new pr(n,l.e.Zero(),t)}});var pr=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o._tmpDragQuaternion=new l.b,o._disablePointerInputWhenUsingDeviceOrientation=!0,o._dragFactor=0,o._quaternionCache=new l.b,o.inputs.addDeviceOrientation(),o.inputs._deviceOrientationInput&&o.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(function(){o._disablePointerInputWhenUsingDeviceOrientation&&o.inputs._mouseInput&&(o.inputs._mouseInput._allowCameraRotation=!1,o.inputs._mouseInput.onPointerMovedObservable.add(function(a){o._dragFactor!=0&&(o._initialQuaternion||(o._initialQuaternion=new l.b),l.b.FromEulerAnglesToRef(0,a.offsetX*o._dragFactor,0,o._tmpDragQuaternion),o._initialQuaternion.multiplyToRef(o._tmpDragQuaternion,o._initialQuaternion))}))}),o}return Object.defineProperty(t.prototype,"disablePointerInputWhenUsingDeviceOrientation",{get:function(){return this._disablePointerInputWhenUsingDeviceOrientation},set:function(e){this._disablePointerInputWhenUsingDeviceOrientation=e},enumerable:!1,configurable:!0}),t.prototype.enableHorizontalDragging=function(e){e===void 0&&(e=1/300),this._dragFactor=e},t.prototype.getClassName=function(){return"DeviceOrientationCamera"},t.prototype._checkInputs=function(){n.prototype._checkInputs.call(this),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)},t.prototype.resetToCurrentRotation=function(e){var i=this;e===void 0&&(e=Le.a.Y),!!this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new l.b),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(function(r){e[r]?i._initialQuaternion[r]*=-1:i._initialQuaternion[r]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))},t}(kt.a),Er=function(n){Object(p.d)(t,n);function t(e){return n.call(this,e)||this}return t.prototype.addKeyboard=function(){return this.add(new ji),this},t.prototype.addMouse=function(e){return e===void 0&&(e=!0),this.add(new yi(e)),this},t}(At.b),Vi=function(n){Object(p.d)(t,n);function t(e,i,r,o){o===void 0&&(o=!0);var a=n.call(this,e,i,r,o)||this;return a.ellipsoid=new l.e(1,1,1),a.ellipsoidOffset=new l.e(0,0,0),a.checkCollisions=!1,a.applyGravity=!1,a.cameraDirection=l.e.Zero(),a._trackRoll=0,a.rollCorrect=100,a.bankedTurn=!1,a.bankedTurnLimit=Math.PI/2,a.bankedTurnMultiplier=1,a._needMoveForGravity=!1,a._oldPosition=l.e.Zero(),a._diffPosition=l.e.Zero(),a._newPosition=l.e.Zero(),a._collisionMask=-1,a._onCollisionPositionChange=function(s,c,_){_===void 0&&(_=null);var b=function(C){a._newPosition.copyFrom(C),a._newPosition.subtractToRef(a._oldPosition,a._diffPosition),a._diffPosition.length()>G.a.CollisionsEpsilon&&(a.position.addInPlace(a._diffPosition),a.onCollide&&_&&a.onCollide(_))};b(c)},a.inputs=new Er(a),a.inputs.addKeyboard().addMouse(),a}return Object.defineProperty(t.prototype,"angularSensibility",{get:function(){var e=this.inputs.attached.mouse;return e?e.angularSensibility:0},set:function(e){var i=this.inputs.attached.mouse;i&&(i.angularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysForward",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysForward:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysForward=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysBackward",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysBackward:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysBackward=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysUp",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysUp:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysUp=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysDown",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysDown:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysDown=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysLeft",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysLeft:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysLeft=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"keysRight",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysRight:[]},set:function(e){var i=this.inputs.attached.keyboard;i&&(i.keysRight=e)},enumerable:!1,configurable:!0}),t.prototype.attachControl=function(e,i){i=re.b.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i)},t.prototype.detachControl=function(){this.inputs.detachElement(),this.cameraDirection=new l.e(0,0,0)},Object.defineProperty(t.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=isNaN(e)?-1:e},enumerable:!1,configurable:!0}),t.prototype._collideWithWorld=function(e){var i;this.parent?i=l.e.TransformCoordinates(this.position,this.parent.getWorldMatrix()):i=this.position,i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);var r=this.getScene().collisionCoordinator;this._collider||(this._collider=r.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var o=e;this.applyGravity&&(o=e.add(this.getScene().gravity)),r.getNewPosition(this._oldPosition,o,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},t.prototype._checkInputs=function(){this._localDirection||(this._localDirection=l.e.Zero(),this._transformedDirection=l.e.Zero()),this.inputs.checkInputs(),n.prototype._checkInputs.call(this)},t.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},t.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):n.prototype._updatePosition.call(this)},t.prototype.restoreRoll=function(e){var i=this._trackRoll,r=this.rotation.z,o=i-r,a=.001;Math.abs(o)>=a&&(this.rotation.z+=o/e,Math.abs(i-this.rotation.z)<=a&&(this.rotation.z=i))},t.prototype.dispose=function(){this.inputs.clear(),n.prototype.dispose.call(this)},t.prototype.getClassName=function(){return"FlyCamera"},Object(p.c)([Object(Ee.o)()],t.prototype,"ellipsoid",void 0),Object(p.c)([Object(Ee.o)()],t.prototype,"ellipsoidOffset",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"checkCollisions",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"applyGravity",void 0),t}(Ii.a),$i=function(n){Object(p.d)(t,n);function t(e){return n.call(this,e)||this}return t.prototype.addKeyboard=function(){return this.add(new ai),this},t.prototype.addMouseWheel=function(){return this.add(new Ei),this},t.prototype.addPointers=function(){return this.add(new Gt),this},t.prototype.addVRDeviceOrientation=function(){return console.warn("DeviceOrientation support not yet implemented for FollowCamera."),this},t}(At.b);Nt.a.AddNodeConstructor("FollowCamera",function(n,t){return function(){return new Pr(n,l.e.Zero(),t)}}),Nt.a.AddNodeConstructor("ArcFollowCamera",function(n,t){return function(){return new mr(n,0,0,1,null,t)}});var Pr=function(n){Object(p.d)(t,n);function t(e,i,r,o){o===void 0&&(o=null);var a=n.call(this,e,i,r)||this;return a.radius=12,a.lowerRadiusLimit=null,a.upperRadiusLimit=null,a.rotationOffset=0,a.lowerRotationOffsetLimit=null,a.upperRotationOffsetLimit=null,a.heightOffset=4,a.lowerHeightOffsetLimit=null,a.upperHeightOffsetLimit=null,a.cameraAcceleration=.05,a.maxCameraSpeed=20,a.lockedTarget=o,a.inputs=new $i(a),a.inputs.addKeyboard().addMouseWheel().addPointers(),a}return t.prototype._follow=function(e){if(!!e){var i=l.c.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(i);var r=Math.atan2(i.m[8],i.m[10]),o=re.b.ToRadians(this.rotationOffset)+r,a=e.getAbsolutePosition(),s=a.x+Math.sin(o)*this.radius,c=a.z+Math.cos(o)*this.radius,_=s-this.position.x,b=a.y+this.heightOffset-this.position.y,C=c-this.position.z,x=_*this.cameraAcceleration*2,V=b*this.cameraAcceleration,D=C*this.cameraAcceleration*2;(x>this.maxCameraSpeed||x<-this.maxCameraSpeed)&&(x=x<1?-this.maxCameraSpeed:this.maxCameraSpeed),(V>this.maxCameraSpeed||V<-this.maxCameraSpeed)&&(V=V<1?-this.maxCameraSpeed:this.maxCameraSpeed),(D>this.maxCameraSpeed||D<-this.maxCameraSpeed)&&(D=D<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new l.e(this.position.x+x,this.position.y+V,this.position.z+D),this.setTarget(a)}},t.prototype.attachControl=function(e,i){i=re.b.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(i),this._reset=function(){}},t.prototype.detachControl=function(e){this.inputs.detachElement(),this._reset&&this._reset()},t.prototype._checkInputs=function(){this.inputs.checkInputs(),this._checkLimits(),n.prototype._checkInputs.call(this),this.lockedTarget&&this._follow(this.lockedTarget)},t.prototype._checkLimits=function(){this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),this.lowerHeightOffsetLimit!==null&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),this.upperHeightOffsetLimit!==null&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),this.lowerRotationOffsetLimit!==null&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),this.upperRotationOffsetLimit!==null&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)},t.prototype.getClassName=function(){return"FollowCamera"},Object(p.c)([Object(Ee.c)()],t.prototype,"radius",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"lowerRadiusLimit",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"upperRadiusLimit",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"rotationOffset",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"lowerRotationOffsetLimit",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"upperRotationOffsetLimit",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"heightOffset",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"lowerHeightOffsetLimit",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"upperHeightOffsetLimit",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"cameraAcceleration",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"maxCameraSpeed",void 0),Object(p.c)([Object(Ee.k)("lockedTargetId")],t.prototype,"lockedTarget",void 0),t}(Ii.a),mr=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,l.e.Zero(),s)||this;return c.alpha=i,c.beta=r,c.radius=o,c._cartesianCoordinates=l.e.Zero(),c.setMeshTarget(a),c}return t.prototype.setMeshTarget=function(e){this._meshTarget=e,this._follow()},t.prototype._follow=function(){if(!!this._meshTarget){this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);var e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}},t.prototype._checkInputs=function(){n.prototype._checkInputs.call(this),this._follow()},t.prototype.getClassName=function(){return"ArcFollowCamera"},t}(Ii.a),Jt=u(469),Kt=u(448),Li;(function(n){n[n.VIVE=0]="VIVE",n[n.OCULUS=1]="OCULUS",n[n.WINDOWS=2]="WINDOWS",n[n.GEAR_VR=3]="GEAR_VR",n[n.DAYDREAM=4]="DAYDREAM",n[n.GENERIC=5]="GENERIC"})(Li||(Li={}));var Ui=function(){function n(){}return n.InitiateController=function(t){for(var e=0,i=this._ControllerFactories;e<i.length;e++){var r=i[e];if(r.canCreate(t))return r.create(t)}if(this._DefaultControllerFactory)return this._DefaultControllerFactory(t);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."},n._ControllerFactories=[],n._DefaultControllerFactory=null,n}(),qi=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e.id,e.index,e)||this;return i.isXR=!1,i._deviceRoomPosition=l.e.Zero(),i._deviceRoomRotationQuaternion=new l.b,i.devicePosition=l.e.Zero(),i.deviceRotationQuaternion=new l.b,i.deviceScaleFactor=1,i._trackPosition=!0,i._maxRotationDistFromHeadset=Math.PI/5,i._draggedRoomRotation=0,i._leftHandSystemQuaternion=new l.b,i._deviceToWorld=l.a.Identity(),i._pointingPoseNode=null,i._workingMatrix=l.a.Identity(),i._meshAttachedObservable=new g.c,i.type=Ot.POSE_ENABLED,i.controllerType=Li.GENERIC,i.position=l.e.Zero(),i.rotationQuaternion=new l.b,i._calculatedPosition=l.e.Zero(),i._calculatedRotation=new l.b,l.b.RotationYawPitchRollToRef(Math.PI,0,0,i._leftHandSystemQuaternion),i}return t.prototype._disableTrackPosition=function(e){this._trackPosition&&(this._calculatedPosition.copyFrom(e),this._trackPosition=!1)},t.prototype.update=function(){n.prototype.update.call(this),this._updatePoseAndMesh()},t.prototype._updatePoseAndMesh=function(){if(!this.isXR){var e=this.browserGamepad.pose;if(this.updateFromDevice(e),!this._trackPosition&&Kt.a.LastCreatedScene&&Kt.a.LastCreatedScene.activeCamera&&Kt.a.LastCreatedScene.activeCamera.devicePosition){var i=Kt.a.LastCreatedScene.activeCamera;if(i._computeDevicePosition(),this._deviceToWorld.setTranslation(i.devicePosition),i.deviceRotationQuaternion){var i=i;i._deviceRoomRotationQuaternion.toEulerAnglesToRef(l.c.Vector3[0]);var r=Math.atan2(Math.sin(l.c.Vector3[0].y-this._draggedRoomRotation),Math.cos(l.c.Vector3[0].y-this._draggedRoomRotation));if(Math.abs(r)>this._maxRotationDistFromHeadset){var o=r-(r<0?-this._maxRotationDistFromHeadset:this._maxRotationDistFromHeadset);this._draggedRoomRotation+=o;var a=Math.sin(-o),s=Math.cos(-o);this._calculatedPosition.x=this._calculatedPosition.x*s-this._calculatedPosition.z*a,this._calculatedPosition.z=this._calculatedPosition.x*a+this._calculatedPosition.z*s}}}l.e.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition),this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix),l.b.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation),this._mesh&&(this._mesh.position.copyFrom(this.devicePosition),this._mesh.rotationQuaternion&&this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))}},t.prototype.updateFromDevice=function(e){if(!this.isXR&&e){this.rawPose=e,e.position&&(this._deviceRoomPosition.copyFromFloats(e.position[0],e.position[1],-e.position[2]),this._mesh&&this._mesh.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1),this._trackPosition&&this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition),this._calculatedPosition.addInPlace(this.position));var i=this.rawPose;e.orientation&&i.orientation&&i.orientation.length===4&&(this._deviceRoomRotationQuaternion.copyFromFloats(i.orientation[0],i.orientation[1],-i.orientation[2],-i.orientation[3]),this._mesh&&(this._mesh.getScene().useRightHandedSystem?(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1):this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)),this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation))}},t.prototype.attachToMesh=function(e){if(this._mesh&&(this._mesh.parent=null),this._mesh=e,this._poseControlledCamera&&(this._mesh.parent=this._poseControlledCamera),this._mesh.rotationQuaternion||(this._mesh.rotationQuaternion=new l.b),!this.isXR&&(this._updatePoseAndMesh(),this._pointingPoseNode)){for(var i=[],r=this._pointingPoseNode;r.parent;)i.push(r.parent),r=r.parent;i.reverse().forEach(function(o){o.computeWorldMatrix(!0)})}this._meshAttachedObservable.notifyObservers(e)},t.prototype.attachToPoseControlledCamera=function(e){this._poseControlledCamera=e,this._mesh&&(this._mesh.parent=this._poseControlledCamera)},t.prototype.dispose=function(){this._mesh&&this._mesh.dispose(),this._mesh=null,n.prototype.dispose.call(this)},Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),t.prototype.getForwardRay=function(e){if(e===void 0&&(e=100),!this.mesh)return new Jt.a(l.e.Zero(),new l.e(0,0,1),e);var i=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix(),r=i.getTranslation(),o=new l.e(0,0,-1),a=l.e.TransformNormal(o,i),s=l.e.Normalize(a);return new Jt.a(r,s,e)},t.POINTING_POSE="POINTING_POSE",t}(Ot),Xt;(function(n){n[n.A=0]="A",n[n.B=1]="B",n[n.X=2]="X",n[n.Y=3]="Y",n[n.LB=4]="LB",n[n.RB=5]="RB",n[n.Back=8]="Back",n[n.Start=9]="Start",n[n.LeftStick=10]="LeftStick",n[n.RightStick=11]="RightStick"})(Xt||(Xt={}));var er;(function(n){n[n.Up=12]="Up",n[n.Down=13]="Down",n[n.Left=14]="Left",n[n.Right=15]="Right"})(er||(er={}));var Vn=function(n){Object(p.d)(t,n);function t(e,i,r,o){o===void 0&&(o=!1);var a=n.call(this,e,i,r,0,1,2,3)||this;return a._leftTrigger=0,a._rightTrigger=0,a.onButtonDownObservable=new g.c,a.onButtonUpObservable=new g.c,a.onPadDownObservable=new g.c,a.onPadUpObservable=new g.c,a._buttonA=0,a._buttonB=0,a._buttonX=0,a._buttonY=0,a._buttonBack=0,a._buttonStart=0,a._buttonLB=0,a._buttonRB=0,a._buttonLeftStick=0,a._buttonRightStick=0,a._dPadUp=0,a._dPadDown=0,a._dPadLeft=0,a._dPadRight=0,a._isXboxOnePad=!1,a.type=Ot.XBOX,a._isXboxOnePad=o,a}return t.prototype.onlefttriggerchanged=function(e){this._onlefttriggerchanged=e},t.prototype.onrighttriggerchanged=function(e){this._onrighttriggerchanged=e},Object.defineProperty(t.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e},enumerable:!1,configurable:!0}),t.prototype.onbuttondown=function(e){this._onbuttondown=e},t.prototype.onbuttonup=function(e){this._onbuttonup=e},t.prototype.ondpaddown=function(e){this._ondpaddown=e},t.prototype.ondpadup=function(e){this._ondpadup=e},t.prototype._setButtonValue=function(e,i,r){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(r),this.onButtonDownObservable.notifyObservers(r)),e===0&&(this._onbuttonup&&this._onbuttonup(r),this.onButtonUpObservable.notifyObservers(r))),e},t.prototype._setDPadValue=function(e,i,r){return e!==i&&(e===1&&(this._ondpaddown&&this._ondpaddown(r),this.onPadDownObservable.notifyObservers(r)),e===0&&(this._ondpadup&&this._ondpadup(r),this.onPadUpObservable.notifyObservers(r))),e},Object.defineProperty(t.prototype,"buttonA",{get:function(){return this._buttonA},set:function(e){this._buttonA=this._setButtonValue(e,this._buttonA,Xt.A)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonB",{get:function(){return this._buttonB},set:function(e){this._buttonB=this._setButtonValue(e,this._buttonB,Xt.B)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonX",{get:function(){return this._buttonX},set:function(e){this._buttonX=this._setButtonValue(e,this._buttonX,Xt.X)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonY",{get:function(){return this._buttonY},set:function(e){this._buttonY=this._setButtonValue(e,this._buttonY,Xt.Y)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,Xt.Start)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,Xt.Back)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,Xt.LB)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,Xt.RB)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Xt.LeftStick)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Xt.RightStick)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,er.Up)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,er.Down)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,er.Left)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,er.Right)},enumerable:!1,configurable:!0}),t.prototype.update=function(){n.prototype.update.call(this),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()},t}(Ot),tr;(function(n){n[n.Cross=0]="Cross",n[n.Circle=1]="Circle",n[n.Square=2]="Square",n[n.Triangle=3]="Triangle",n[n.L1=4]="L1",n[n.R1=5]="R1",n[n.Share=8]="Share",n[n.Options=9]="Options",n[n.LeftStick=10]="LeftStick",n[n.RightStick=11]="RightStick"})(tr||(tr={}));var Jr;(function(n){n[n.Up=12]="Up",n[n.Down=13]="Down",n[n.Left=14]="Left",n[n.Right=15]="Right"})(Jr||(Jr={}));var Un=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),i,r,0,1,2,3)||this;return o._leftTrigger=0,o._rightTrigger=0,o.onButtonDownObservable=new g.c,o.onButtonUpObservable=new g.c,o.onPadDownObservable=new g.c,o.onPadUpObservable=new g.c,o._buttonCross=0,o._buttonCircle=0,o._buttonSquare=0,o._buttonTriangle=0,o._buttonShare=0,o._buttonOptions=0,o._buttonL1=0,o._buttonR1=0,o._buttonLeftStick=0,o._buttonRightStick=0,o._dPadUp=0,o._dPadDown=0,o._dPadLeft=0,o._dPadRight=0,o.type=Ot.DUALSHOCK,o}return t.prototype.onlefttriggerchanged=function(e){this._onlefttriggerchanged=e},t.prototype.onrighttriggerchanged=function(e){this._onrighttriggerchanged=e},Object.defineProperty(t.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e},enumerable:!1,configurable:!0}),t.prototype.onbuttondown=function(e){this._onbuttondown=e},t.prototype.onbuttonup=function(e){this._onbuttonup=e},t.prototype.ondpaddown=function(e){this._ondpaddown=e},t.prototype.ondpadup=function(e){this._ondpadup=e},t.prototype._setButtonValue=function(e,i,r){return e!==i&&(e===1&&(this._onbuttondown&&this._onbuttondown(r),this.onButtonDownObservable.notifyObservers(r)),e===0&&(this._onbuttonup&&this._onbuttonup(r),this.onButtonUpObservable.notifyObservers(r))),e},t.prototype._setDPadValue=function(e,i,r){return e!==i&&(e===1&&(this._ondpaddown&&this._ondpaddown(r),this.onPadDownObservable.notifyObservers(r)),e===0&&(this._ondpadup&&this._ondpadup(r),this.onPadUpObservable.notifyObservers(r))),e},Object.defineProperty(t.prototype,"buttonCross",{get:function(){return this._buttonCross},set:function(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,tr.Cross)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonCircle",{get:function(){return this._buttonCircle},set:function(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,tr.Circle)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonSquare",{get:function(){return this._buttonSquare},set:function(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,tr.Square)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonTriangle",{get:function(){return this._buttonTriangle},set:function(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,tr.Triangle)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonOptions",{get:function(){return this._buttonOptions},set:function(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,tr.Options)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonShare",{get:function(){return this._buttonShare},set:function(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,tr.Share)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonL1",{get:function(){return this._buttonL1},set:function(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,tr.L1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonR1",{get:function(){return this._buttonR1},set:function(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,tr.R1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,tr.LeftStick)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,tr.RightStick)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Jr.Up)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Jr.Down)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Jr.Left)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Jr.Right)},enumerable:!1,configurable:!0}),t.prototype.update=function(){n.prototype.update.call(this),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()},t}(Ot),Gn=function(){function n(t){var e=this;if(this._scene=t,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new g.c,fe.a.IsWindowObjectExist()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&(navigator.getGamepads||navigator.webkitGetGamepads||navigator.msGetGamepads||navigator.webkitGamepads)):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new g.c(function(r){for(var o in e._babylonGamepads){var a=e._babylonGamepads[o];a&&a._isConnected&&e.onGamepadConnectedObservable.notifyObserver(r,a)}}),this._onGamepadConnectedEvent=function(r){var o=r.gamepad;if(!(o.index in e._babylonGamepads&&e._babylonGamepads[o.index].isConnected)){var a;e._babylonGamepads[o.index]?(a=e._babylonGamepads[o.index],a.browserGamepad=o,a._isConnected=!0):a=e._addNewGamepad(o),e.onGamepadConnectedObservable.notifyObservers(a),e._startMonitoringGamepads()}},this._onGamepadDisconnectedEvent=function(r){var o=r.gamepad;for(var a in e._babylonGamepads)if(e._babylonGamepads[a].index===o.index){var s=e._babylonGamepads[a];s._isConnected=!1,e.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){var i=this._scene?this._scene.getEngine().getHostWindow():window;i&&(i.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),i.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}return Object.defineProperty(n.prototype,"gamepads",{get:function(){return this._babylonGamepads},enumerable:!1,configurable:!0}),n.prototype.getGamepadByType=function(t){t===void 0&&(t=Ot.XBOX);for(var e=0,i=this._babylonGamepads;e<i.length;e++){var r=i[e];if(r&&r.type===t)return r}return null},n.prototype.dispose=function(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(function(t){t.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]},n.prototype._addNewGamepad=function(t){this._oneGamepadConnected||(this._oneGamepadConnected=!0);var e,i=t.id.search("054c")!==-1&&t.id.search("0ce6")===-1,r=t.id.search("Xbox One")!==-1;return r||t.id.search("Xbox 360")!==-1||t.id.search("xinput")!==-1||t.id.search("045e")!==-1?e=new Vn(t.id,t.index,t,r):i?e=new Un(t.id,t.index,t):t.pose?e=Ui.InitiateController(t):e=new Ut(t.id,t.index,t),this._babylonGamepads[e.index]=e,e},n.prototype._startMonitoringGamepads=function(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())},n.prototype._stopMonitoringGamepads=function(){this._isMonitoring=!1},n.prototype._checkGamepadsStatus=function(){var t=this;this._updateGamepadObjects();for(var e in this._babylonGamepads){var i=this._babylonGamepads[e];!i||!i.isConnected||i.update()}this._isMonitoring&&!this._scene&&G.a.QueueNewFrame(function(){t._checkGamepadsStatus()})},n.prototype._updateGamepadObjects=function(){for(var t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e=0;e<t.length;e++){var i=t[e];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[e].browserGamepad=i,this._babylonGamepads[e].isConnected||(this._babylonGamepads[e]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[e]));else{var r=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(r)}}},n}();Object.defineProperty(ae.a.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Gn(this);var n=this._getComponent(X.a.NAME_GAMEPAD);n||(n=new Da(this),this._addComponent(n))}return this._gamepadManager},enumerable:!0,configurable:!0}),wi.a.prototype.addGamepad=function(){return this.add(new Wi),this},Di.a.prototype.addGamepad=function(){return this.add(new Qt),this};var Da=function(){function n(t){this.name=X.a.NAME_GAMEPAD,this.scene=t}return n.prototype.register=function(){this.scene._beforeCameraUpdateStage.registerStep(X.a.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){var t=this.scene._gamepadManager;t&&(t.dispose(),this.scene._gamepadManager=null)},n.prototype._beforeCameraUpdate=function(){var t=this.scene._gamepadManager;t&&t._isMonitoring&&t._checkGamepadsStatus()},n}();Nt.a.AddNodeConstructor("FreeCamera",function(n,t){return function(){return new Ir(n,l.e.Zero(),t)}});var Ir=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o.inputs.addGamepad(),o}return Object.defineProperty(t.prototype,"gamepadAngularSensibility",{get:function(){var e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0},set:function(e){var i=this.inputs.attached.gamepad;i&&(i.gamepadAngularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gamepadMoveSensibility",{get:function(){var e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0},set:function(e){var i=this.inputs.attached.gamepad;i&&(i.gamepadMoveSensibility=e)},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"UniversalCamera"},t}(sr);te.a._createDefaultParsedCamera=function(n,t){return new Ir(n,l.e.Zero(),t)},Nt.a.AddNodeConstructor("GamepadCamera",function(n,t){return function(){return new ln(n,l.e.Zero(),t)}});var ln=function(n){Object(p.d)(t,n);function t(e,i,r){return n.call(this,e,i,r)||this}return t.prototype.getClassName=function(){return"GamepadCamera"},t}(Ir),yn=u(486),ii=u(444),qe=u(435),Ia="anaglyphPixelShader",zn=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D leftSampler;
void main(void)
{
vec4 leftFrag=texture2D(leftSampler,vUV);
leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);
vec4 rightFrag=texture2D(textureSampler,vUV);
rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);
gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);
}`;qe.a.ShadersStore[Ia]=zn;var La={name:Ia,shader:zn},Fo=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,"anaglyph",null,["leftSampler"],i,r[1],o,a,s)||this;return c._passedProcess=r[0]._rigPostProcess,c.onApplyObservable.add(function(_){_.setTextureFromPostProcess("leftSampler",c._passedProcess)}),c}return t.prototype.getClassName=function(){return"AnaglyphPostProcess"},t}(ii.a);f.a.RegisteredTypes["BABYLON.AnaglyphPostProcess"]=Fo,te.a._setStereoscopicAnaglyphRigMode=function(n){n._rigCameras[0]._rigPostProcess=new yn.b(n.name+"_passthru",1,n._rigCameras[0]),n._rigCameras[1]._rigPostProcess=new Fo(n.name+"_anaglyph",1,n._rigCameras)},Nt.a.AddNodeConstructor("AnaglyphArcRotateCamera",function(n,t,e){return function(){return new jn(n,0,0,1,l.e.Zero(),e.interaxial_distance,t)}});var jn=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){var _=n.call(this,e,i,r,o,a,c)||this;return _.interaxialDistance=s,_.setCameraRigMode(te.a.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:s}),_}return t.prototype.getClassName=function(){return"AnaglyphArcRotateCamera"},t}(Ai.a);Nt.a.AddNodeConstructor("AnaglyphFreeCamera",function(n,t,e){return function(){return new Wn(n,l.e.Zero(),e.interaxial_distance,t)}});var Wn=function(n){Object(p.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,i,o)||this;return a.interaxialDistance=r,a.setCameraRigMode(te.a.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),a}return t.prototype.getClassName=function(){return"AnaglyphFreeCamera"},t}(kt.a);Nt.a.AddNodeConstructor("AnaglyphGamepadCamera",function(n,t,e){return function(){return new Fa(n,l.e.Zero(),e.interaxial_distance,t)}});var Fa=function(n){Object(p.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,i,o)||this;return a.interaxialDistance=r,a.setCameraRigMode(te.a.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),a}return t.prototype.getClassName=function(){return"AnaglyphGamepadCamera"},t}(ln);Nt.a.AddNodeConstructor("AnaglyphUniversalCamera",function(n,t,e){return function(){return new Ba(n,l.e.Zero(),e.interaxial_distance,t)}});var Ba=function(n){Object(p.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,i,o)||this;return a.interaxialDistance=r,a.setCameraRigMode(te.a.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:r}),a}return t.prototype.getClassName=function(){return"AnaglyphUniversalCamera"},t}(Ir),lr=u(520),Hn="stereoscopicInterlacePixelShader",Na=`const vec3 TWO=vec3(2.0,2.0,2.0);
varying vec2 vUV;
uniform sampler2D camASampler;
uniform sampler2D textureSampler;
uniform vec2 stepSize;
void main(void)
{
bool useCamA;
bool useCamB;
vec2 texCoord1;
vec2 texCoord2;
vec3 frag1;
vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;
useCamA=!useCamB;
texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);
texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);
useCamA=mod(rowNum,2.0) == 1.0;
useCamB=mod(rowNum,2.0) == 0.0;
texCoord1=vec2(vUV.x,vUV.y);
texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;
useCamA=!useCamB;
texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);
texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif

if (useCamB){
frag1=texture2D(textureSampler,texCoord1).rgb;
frag2=texture2D(textureSampler,texCoord2).rgb;
}else if (useCamA){
frag1=texture2D(camASampler ,texCoord1).rgb;
frag2=texture2D(camASampler ,texCoord2).rgb;
}else {
discard;
}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);
}
`;qe.a.ShadersStore[Hn]=Na;var wa={name:Hn,shader:Na},kn=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){var _=n.call(this,e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,i[1],a,s,c,o?"#define IS_STEREOSCOPIC_INTERLACED 1":r?"#define IS_STEREOSCOPIC_HORIZ 1":void 0)||this;return _._passedProcess=i[0]._rigPostProcess,_._stepSize=new l.d(1/_.width,1/_.height),_.onSizeChangedObservable.add(function(){_._stepSize=new l.d(1/_.width,1/_.height)}),_.onApplyObservable.add(function(b){b.setTextureFromPostProcess("camASampler",_._passedProcess),b.setFloat2("stepSize",_._stepSize.x,_._stepSize.y)}),_}return t.prototype.getClassName=function(){return"StereoscopicInterlacePostProcessI"},t}(ii.a),Dl=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,i[1],o,a,s,r?"#define IS_STEREOSCOPIC_HORIZ 1":void 0)||this;return c._passedProcess=i[0]._rigPostProcess,c._stepSize=new l.d(1/c.width,1/c.height),c.onSizeChangedObservable.add(function(){c._stepSize=new l.d(1/c.width,1/c.height)}),c.onApplyObservable.add(function(_){_.setTextureFromPostProcess("camASampler",c._passedProcess),_.setFloat2("stepSize",c._stepSize.x,c._stepSize.y)}),c}return t.prototype.getClassName=function(){return"StereoscopicInterlacePostProcess"},t}(ii.a);te.a._setStereoscopicRigMode=function(n){var t=n.cameraRigMode===te.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||n.cameraRigMode===te.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,e=n.cameraRigMode===te.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,i=n.cameraRigMode===te.a.RIG_MODE_STEREOSCOPIC_INTERLACED;i?(n._rigCameras[0]._rigPostProcess=new yn.b(n.name+"_passthru",1,n._rigCameras[0]),n._rigCameras[1]._rigPostProcess=new kn(n.name+"_stereoInterlace",n._rigCameras,!1,!0)):(n._rigCameras[e?1:0].viewport=new lr.a(0,0,t?.5:1,t?1:.5),n._rigCameras[e?0:1].viewport=new lr.a(t?.5:0,t?0:.5,t?.5:1,t?1:.5))},Nt.a.AddNodeConstructor("StereoscopicArcRotateCamera",function(n,t,e){return function(){return new Xn(n,0,0,1,l.e.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,t)}});var Xn=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_){var b=n.call(this,e,i,r,o,a,_)||this;return b.interaxialDistance=s,b.isStereoscopicSideBySide=c,b.setCameraRigMode(c?te.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:te.a.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:s}),b}return t.prototype.getClassName=function(){return"StereoscopicArcRotateCamera"},t}(Ai.a);Nt.a.AddNodeConstructor("StereoscopicFreeCamera",function(n,t,e){return function(){return new Yn(n,l.e.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,t)}});var Yn=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){var s=n.call(this,e,i,a)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=o,s.setCameraRigMode(o?te.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:te.a.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return t.prototype.getClassName=function(){return"StereoscopicFreeCamera"},t}(kt.a);Nt.a.AddNodeConstructor("StereoscopicGamepadCamera",function(n,t,e){return function(){return new Va(n,l.e.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,t)}});var Va=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){var s=n.call(this,e,i,a)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=o,s.setCameraRigMode(o?te.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:te.a.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return t.prototype.getClassName=function(){return"StereoscopicGamepadCamera"},t}(ln);Nt.a.AddNodeConstructor("StereoscopicFreeCamera",function(n,t,e){return function(){return new Ua(n,l.e.Zero(),e.interaxial_distance,e.isStereoscopicSideBySide,t)}});var Ua=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){var s=n.call(this,e,i,a)||this;return s.interaxialDistance=r,s.isStereoscopicSideBySide=o,s.setCameraRigMode(o?te.a.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:te.a.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:r}),s}return t.prototype.getClassName=function(){return"StereoscopicUniversalCamera"},t}(Ir);Nt.a.AddNodeConstructor("VirtualJoysticksCamera",function(n,t){return function(){return new Ga(n,l.e.Zero(),t)}});var Ga=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,i,r)||this;return o.inputs.addVirtualJoystick(),o}return t.prototype.getClassName=function(){return"VirtualJoysticksCamera"},t}(kt.a),Lr=function(){function n(){this.compensateDistortion=!0,this.multiviewEnabled=!1}return Object.defineProperty(n.prototype,"aspectRatio",{get:function(){return this.hResolution/(2*this.vResolution)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"aspectRatioFov",{get:function(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"leftHMatrix",{get:function(){var t=this.hScreenSize/4-this.lensSeparationDistance/2,e=4*t/this.hScreenSize;return l.a.Translation(e,0,0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightHMatrix",{get:function(){var t=this.hScreenSize/4-this.lensSeparationDistance/2,e=4*t/this.hScreenSize;return l.a.Translation(-e,0,0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"leftPreViewMatrix",{get:function(){return l.a.Translation(.5*this.interpupillaryDistance,0,0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightPreViewMatrix",{get:function(){return l.a.Translation(-.5*this.interpupillaryDistance,0,0)},enumerable:!1,configurable:!0}),n.GetDefault=function(){var t=new n;return t.hResolution=1280,t.vResolution=800,t.hScreenSize=.149759993,t.vScreenSize=.0935999975,t.vScreenCenter=.0467999987,t.eyeToScreenDistance=.0410000011,t.lensSeparationDistance=.063500002,t.interpupillaryDistance=.064000003,t.distortionK=[1,.219999999,.239999995,0],t.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],t.postProcessScaleFactor=1.714605507808412,t.lensCenterOffset=.151976421,t},n}(),Ze=u(442),za="vrDistortionCorrectionPixelShader",Kn=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 LensCenter;
uniform vec2 Scale;
uniform vec2 ScaleIn;
uniform vec4 HmdWarpParam;
vec2 HmdWarp(vec2 in01) {
vec2 theta=(in01-LensCenter)*ScaleIn;
float rSq=theta.x*theta.x+theta.y*theta.y;
vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);
return LensCenter+Scale*rvector;
}
void main(void)
{
vec2 tc=HmdWarp(vUV);
if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);
else{
gl_FragColor=texture2D(textureSampler,tc);
}
}`;qe.a.ShadersStore[za]=Kn;var ja={name:za,shader:Kn},Bo=function(n){Object(p.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,o.postProcessScaleFactor,i,Ze.a.BILINEAR_SAMPLINGMODE)||this;return a._isRightEye=r,a._distortionFactors=o.distortionK,a._postProcessScaleFactor=o.postProcessScaleFactor,a._lensCenterOffset=o.lensCenterOffset,a.adaptScaleToCurrentViewport=!0,a.onSizeChangedObservable.add(function(){a._scaleIn=new l.d(2,2/a.aspectRatio),a._scaleFactor=new l.d(.5*(1/a._postProcessScaleFactor),.5*(1/a._postProcessScaleFactor)*a.aspectRatio),a._lensCenter=new l.d(a._isRightEye?.5-a._lensCenterOffset*.5:.5+a._lensCenterOffset*.5,.5)}),a.onApplyObservable.add(function(s){s.setFloat2("LensCenter",a._lensCenter.x,a._lensCenter.y),s.setFloat2("Scale",a._scaleFactor.x,a._scaleFactor.y),s.setFloat2("ScaleIn",a._scaleIn.x,a._scaleIn.y),s.setFloat4("HmdWarpParam",a._distortionFactors[0],a._distortionFactors[1],a._distortionFactors[2],a._distortionFactors[3])}),a}return t.prototype.getClassName=function(){return"VRDistortionCorrectionPostProcess"},t}(ii.a),Qn="vrMultiviewToSingleviewPixelShader",Zn=`precision mediump sampler2DArray;
varying vec2 vUV;
uniform sampler2DArray multiviewSampler;
uniform int imageIndex;
void main(void)
{
gl_FragColor=texture(multiviewSampler,vec3(vUV,imageIndex));
}`;qe.a.ShadersStore[Qn]=Zn;var pp={name:Qn,shader:Zn},gt=u(456),Fr=u(557),Cr=u(458),Wa=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i=512);var r=n.call(this,"multiview rtt",i,e,!1,!0,gt.b.Unknown,!1,void 0,!1,!1,!0,void 0,!0)||this,o=e.getEngine().createMultiviewRenderTargetTexture(r.getRenderWidth(),r.getRenderHeight());return o.isMultiview=!0,o.format=5,r._texture=o,r.samples=r._getEngine().getCaps().maxSamples||r.samples,r}return t.prototype._bindFrameBuffer=function(e){e===void 0&&(e=0),!!this._texture&&this.getScene().getEngine().bindMultiviewFramebuffer(this._texture)},t.prototype.getViewCount=function(){return 2},t}(Cr.a),Il=u(757);G.a.prototype.createMultiviewRenderTargetTexture=function(n,t){var e=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";var i=new gt.a(this,gt.b.Unknown,!0);return i.width=n,i.height=t,i._framebuffer=e.createFramebuffer(),i._colorTextureArray=e.createTexture(),e.bindTexture(e.TEXTURE_2D_ARRAY,i._colorTextureArray),e.texStorage3D(e.TEXTURE_2D_ARRAY,1,e.RGBA8,n,t,2),i._depthStencilTextureArray=e.createTexture(),e.bindTexture(e.TEXTURE_2D_ARRAY,i._depthStencilTextureArray),e.texStorage3D(e.TEXTURE_2D_ARRAY,1,e.DEPTH32F_STENCIL8,n,t,2),i.isReady=!0,i},G.a.prototype.bindMultiviewFramebuffer=function(n){var t=this._gl,e=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(n,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,n._framebuffer),n._colorTextureArray&&n._depthStencilTextureArray)this.getCaps().oculusMultiview?(e.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,n._colorTextureArray,0,n.samples,0,2),e.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,n._depthStencilTextureArray,0,n.samples,0,2)):(e.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,n._colorTextureArray,0,0,2),e.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,n._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"},te.a.prototype._useMultiviewToSingleView=!1,te.a.prototype._multiviewTexture=null,te.a.prototype._resizeOrCreateMultiviewTexture=function(n,t){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=n||this._multiviewTexture.getRenderHeight()!=t)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new Wa(this.getScene(),{width:n,height:t})):this._multiviewTexture=new Wa(this.getScene(),{width:n,height:t})},ae.a.prototype._transformMatrixR=l.a.Zero(),ae.a.prototype._multiviewSceneUbo=null,ae.a.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=new Fr.a(this.getEngine(),void 0,!0,"scene_multiview"),this._multiviewSceneUbo.addUniform("viewProjection",16),this._multiviewSceneUbo.addUniform("viewProjectionR",16),this._multiviewSceneUbo.addUniform("view",16),this._multiviewSceneUbo.addUniform("projection",16),this._multiviewSceneUbo.addUniform("viewPosition",4)},ae.a.prototype._updateMultiviewUbo=function(n,t){n&&t&&n.multiplyToRef(t,this._transformMatrixR),n&&t&&(n.multiplyToRef(t,l.c.Matrix[0]),Il.a.GetRightPlaneToRef(l.c.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},ae.a.prototype._renderMultiviewToSingleView=function(n){n._resizeOrCreateMultiviewTexture(n._rigPostProcess&&n._rigPostProcess&&n._rigPostProcess.width>0?n._rigPostProcess.width:this.getEngine().getRenderWidth(!0),n._rigPostProcess&&n._rigPostProcess&&n._rigPostProcess.height>0?n._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),n.outputRenderTarget=n._multiviewTexture,this._renderForCamera(n),n.outputRenderTarget=null;for(var t=0;t<n._rigCameras.length;t++){var e=this.getEngine();this._activeCamera=n._rigCameras[t],e.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};var No=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],r,i,Ze.a.BILINEAR_SAMPLINGMODE)||this;return o.onSizeChangedObservable.add(function(){}),o.onApplyObservable.add(function(a){i._scene.activeCamera&&i._scene.activeCamera.isLeftCamera?a.setInt("imageIndex",0):a.setInt("imageIndex",1),a.setTexture("multiviewSampler",i._multiviewTexture)}),o}return t.prototype.getClassName=function(){return"VRMultiviewToSingleviewPostProcess"},t}(ii.a);te.a._setVRRigMode=function(n,t){var e=t.vrCameraMetrics||Lr.GetDefault();n._rigCameras[0]._cameraRigParams.vrMetrics=e,n._rigCameras[0].viewport=new lr.a(0,0,.5,1),n._rigCameras[0]._cameraRigParams.vrWorkMatrix=new l.a,n._rigCameras[0]._cameraRigParams.vrHMatrix=e.leftHMatrix,n._rigCameras[0]._cameraRigParams.vrPreViewMatrix=e.leftPreViewMatrix,n._rigCameras[0].getProjectionMatrix=n._rigCameras[0]._getVRProjectionMatrix,n._rigCameras[1]._cameraRigParams.vrMetrics=e,n._rigCameras[1].viewport=new lr.a(.5,0,.5,1),n._rigCameras[1]._cameraRigParams.vrWorkMatrix=new l.a,n._rigCameras[1]._cameraRigParams.vrHMatrix=e.rightHMatrix,n._rigCameras[1]._cameraRigParams.vrPreViewMatrix=e.rightPreViewMatrix,n._rigCameras[1].getProjectionMatrix=n._rigCameras[1]._getVRProjectionMatrix,e.multiviewEnabled&&(n.getScene().getEngine().getCaps().multiview?(n._useMultiviewToSingleView=!0,n._rigPostProcess=new No("VRMultiviewToSingleview",n,e.postProcessScaleFactor)):(d.a.Warn("Multiview is not supported, falling back to standard rendering"),e.multiviewEnabled=!1)),e.compensateDistortion&&(n._rigCameras[0]._rigPostProcess=new Bo("VR_Distort_Compensation_Left",n._rigCameras[0],!1,e),n._rigCameras[1]._rigPostProcess=new Bo("VR_Distort_Compensation_Right",n._rigCameras[1],!0,e))},Nt.a.AddNodeConstructor("VRDeviceOrientationFreeCamera",function(n,t){return function(){return new Ha(n,0,0,1,l.e.Zero(),t)}});var Ha=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_){c===void 0&&(c=!0),_===void 0&&(_=Lr.GetDefault());var b=n.call(this,e,i,r,o,a,s)||this;return _.compensateDistortion=c,b.setCameraRigMode(te.a.RIG_MODE_VR,{vrCameraMetrics:_}),b.inputs.addVRDeviceOrientation(),b}return t.prototype.getClassName=function(){return"VRDeviceOrientationArcRotateCamera"},t}(Ai.a);Nt.a.AddNodeConstructor("VRDeviceOrientationFreeCamera",function(n,t){return function(){return new Jn(n,l.e.Zero(),t)}});var Jn=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!0),a===void 0&&(a=Lr.GetDefault());var s=n.call(this,e,i,r)||this;return a.compensateDistortion=o,s.setCameraRigMode(te.a.RIG_MODE_VR,{vrCameraMetrics:a}),s}return t.prototype.getClassName=function(){return"VRDeviceOrientationFreeCamera"},t}(pr);Nt.a.AddNodeConstructor("VRDeviceOrientationGamepadCamera",function(n,t){return function(){return new ka(n,l.e.Zero(),t)}});var ka=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!0),a===void 0&&(a=Lr.GetDefault());var s=n.call(this,e,i,r,o,a)||this;return s.inputs.addGamepad(),s}return t.prototype.getClassName=function(){return"VRDeviceOrientationGamepadCamera"},t}(Jn),$n=u(498);te.a._setWebVRRigMode=function(n,t){if(t.vrDisplay){var e=t.vrDisplay.getEyeParameters("left"),i=t.vrDisplay.getEyeParameters("right");n._rigCameras[0].viewport=new lr.a(0,0,.5,1),n._rigCameras[0].setCameraRigParameter("left",!0),n._rigCameras[0].setCameraRigParameter("specs",t.specs),n._rigCameras[0].setCameraRigParameter("eyeParameters",e),n._rigCameras[0].setCameraRigParameter("frameData",t.frameData),n._rigCameras[0].setCameraRigParameter("parentCamera",t.parentCamera),n._rigCameras[0]._cameraRigParams.vrWorkMatrix=new l.a,n._rigCameras[0].getProjectionMatrix=n._getWebVRProjectionMatrix,n._rigCameras[0].parent=n,n._rigCameras[0]._getViewMatrix=n._getWebVRViewMatrix,n._rigCameras[1].viewport=new lr.a(.5,0,.5,1),n._rigCameras[1].setCameraRigParameter("eyeParameters",i),n._rigCameras[1].setCameraRigParameter("specs",t.specs),n._rigCameras[1].setCameraRigParameter("frameData",t.frameData),n._rigCameras[1].setCameraRigParameter("parentCamera",t.parentCamera),n._rigCameras[1]._cameraRigParams.vrWorkMatrix=new l.a,n._rigCameras[1].getProjectionMatrix=n._getWebVRProjectionMatrix,n._rigCameras[1].parent=n,n._rigCameras[1]._getViewMatrix=n._getWebVRViewMatrix}};var Ll=u(700);Object.defineProperty(G.a.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0}),G.a.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new g.c,this.onVRRequestPresentComplete=new g.c,this.onVRRequestPresentStart=new g.c},G.a.prototype.isVRDevicePresent=function(){return!!this._vrDisplay},G.a.prototype.getVRDevice=function(){return this._vrDisplay},G.a.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},G.a.prototype.initWebVRAsync=function(){var n=this,t=function(){var i={vrDisplay:n._vrDisplay,vrSupported:n._vrSupported};n.onVRDisplayChangedObservable.notifyObservers(i),n._webVRInitPromise=new Promise(function(r){r(i)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=function(i){n._vrDisplay=i.display,t()},this._onVrDisplayDisconnect=function(){n._vrDisplay.cancelAnimationFrame(n._frameHandler),n._vrDisplay=void 0,n._frameHandler=G.a.QueueNewFrame(n._boundRenderFunction),t()},this._onVrDisplayPresentChange=function(){n._vrExclusivePointerMode=n._vrDisplay&&n._vrDisplay.isPresenting};var e=this.getHostWindow();e&&(e.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),e.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),e.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(t),this._webVRInitPromise},G.a.prototype._getVRDisplaysAsync=function(){var n=this;return new Promise(function(t){navigator.getVRDisplays?navigator.getVRDisplays().then(function(e){n._vrSupported=!0,n._vrDisplay=e[0],t({vrDisplay:n._vrDisplay,vrSupported:n._vrSupported})}):(n._vrDisplay=void 0,n._vrSupported=!1,t({vrDisplay:n._vrDisplay,vrSupported:n._vrSupported}))})},G.a.prototype.enableVR=function(n){var t=this;if(this._vrDisplay&&!this._vrDisplay.isPresenting){var e=function(){t.onVRRequestPresentComplete.notifyObservers(!0),t._onVRFullScreenTriggered()},i=function(){t.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);var r={highRefreshRate:this.vrPresentationAttributes?this.vrPresentationAttributes.highRefreshRate:!1,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&n.useMultiview};this._vrDisplay.requestPresent([Object(p.a)({source:this.getRenderingCanvas(),attributes:r},r)]).then(e).catch(i)}},G.a.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new Ll.a(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();var n=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(n.renderWidth*2,n.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)},G.a.prototype.disableVR=function(){var n=this;this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(function(){return n._onVRFullScreenTriggered()}).catch(function(){return n._onVRFullScreenTriggered()}),fe.a.IsWindowObjectExist()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))},G.a.prototype._connectVREvents=function(n,t){var e=this;if(this._onVRDisplayPointerRestricted=function(){n&&n.requestPointerLock()},this._onVRDisplayPointerUnrestricted=function(){if(!t){var r=e.getHostWindow();r.document&&r.document.exitPointerLock&&r.document.exitPointerLock();return}!t.exitPointerLock||t.exitPointerLock()},fe.a.IsWindowObjectExist()){var i=this.getHostWindow();i.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),i.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}},G.a.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(n){re.b.Warn("webVR submitFrame has had an unexpected failure: "+n)}},G.a.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting},G.a.prototype._requestVRFrame=function(){this._frameHandler=G.a.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)},Nt.a.AddNodeConstructor("WebVRFreeCamera",function(n,t){return function(){return new qn(n,l.e.Zero(),t)}}),Nt.a.AddNodeConstructor("WebVRGamepadCamera",function(n,t){return function(){return new qn(n,l.e.Zero(),t)}});var qn=function(n){Object(p.d)(t,n);function t(e,i,r,o){o===void 0&&(o={});var a=n.call(this,e,i,r)||this;a.webVROptions=o,a._vrDevice=null,a.rawPose=null,a._specsVersion="1.1",a._attached=!1,a._descendants=[],a._deviceRoomPosition=l.e.Zero(),a._deviceRoomRotationQuaternion=l.b.Identity(),a._standingMatrix=null,a.devicePosition=l.e.Zero(),a.deviceRotationQuaternion=l.b.Identity(),a.deviceScaleFactor=1,a._deviceToWorld=l.a.Identity(),a._worldToDevice=l.a.Identity(),a.controllers=[],a.onControllersAttachedObservable=new g.c,a.onControllerMeshLoadedObservable=new g.c,a.onPoseUpdatedFromDeviceObservable=new g.c,a._poseSet=!1,a.rigParenting=!0,a._defaultHeight=void 0,a._detachIfAttached=function(){var c=a.getEngine().getVRDevice();c&&!c.isPresenting&&a.detachControl()},a._workingVector=l.e.Zero(),a._oneVector=l.e.One(),a._workingMatrix=l.a.Identity(),a._tmpMatrix=new l.a,a._cache.position=l.e.Zero(),o.defaultHeight&&(a._defaultHeight=o.defaultHeight,a.position.y=a._defaultHeight),a.minZ=.1,arguments.length===5&&(a.webVROptions=arguments[4]),a.webVROptions.trackPosition==null&&(a.webVROptions.trackPosition=!0),a.webVROptions.controllerMeshes==null&&(a.webVROptions.controllerMeshes=!0),a.webVROptions.defaultLightingOnControllers==null&&(a.webVROptions.defaultLightingOnControllers=!0),a.rotationQuaternion=new l.b,a.webVROptions&&a.webVROptions.positionScale&&(a.deviceScaleFactor=a.webVROptions.positionScale);var s=a.getEngine();return a._onVREnabled=function(c){c&&a.initControllers()},s.onVRRequestPresentComplete.add(a._onVREnabled),s.initWebVR().add(function(c){!c.vrDisplay||a._vrDevice===c.vrDisplay||(a._vrDevice=c.vrDisplay,a.setCameraRigMode(te.a.RIG_MODE_WEBVR,{parentCamera:a,vrDisplay:a._vrDevice,frameData:a._frameData,specs:a._specsVersion}),a._attached&&a.getEngine().enableVR(a.webVROptions))}),typeof VRFrameData!="undefined"&&(a._frameData=new VRFrameData),o.useMultiview&&(a.getScene().getEngine().getCaps().multiview?(a._useMultiviewToSingleView=!0,a._rigPostProcess=new No("VRMultiviewToSingleview",a,1)):(d.a.Warn("Multiview is not supported, falling back to standard rendering"),a._useMultiviewToSingleView=!1)),r.onBeforeCameraRenderObservable.add(function(c){c.parent===a&&a.rigParenting&&(a._descendants=a.getDescendants(!0,function(_){var b=a.controllers.some(function(x){return x._mesh===_}),C=a._rigCameras.indexOf(_)!==-1;return!b&&!C}),a._descendants.forEach(function(_){_.parent=c}))}),r.onAfterCameraRenderObservable.add(function(c){c.parent===a&&a.rigParenting&&a._descendants.forEach(function(_){_.parent=a})}),a}return t.prototype.deviceDistanceToRoomGround=function(){return this._standingMatrix?(this._standingMatrix.getTranslationToRef(this._workingVector),this._deviceRoomPosition.y+this._workingVector.y):this._defaultHeight||0},t.prototype.useStandingMatrix=function(e){var i=this;e===void 0&&(e=function(r){}),this.getEngine().initWebVRAsync().then(function(r){!r.vrDisplay||!r.vrDisplay.stageParameters||!r.vrDisplay.stageParameters.sittingToStandingTransform||!i.webVROptions.trackPosition?e(!1):(i._standingMatrix=new l.a,l.a.FromFloat32ArrayToRefScaled(r.vrDisplay.stageParameters.sittingToStandingTransform,0,1,i._standingMatrix),i.getScene().useRightHandedSystem||i._standingMatrix&&i._standingMatrix.toggleModelMatrixHandInPlace(),e(!0))})},t.prototype.useStandingMatrixAsync=function(){var e=this;return new Promise(function(i){e.useStandingMatrix(function(r){i(r)})})},t.prototype.dispose=function(){this._detachIfAttached(),this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled),this._updateCacheWhenTrackingDisabledObserver&&this._scene.onBeforeRenderObservable.remove(this._updateCacheWhenTrackingDisabledObserver),n.prototype.dispose.call(this)},t.prototype.getControllerByName=function(e){for(var i=0,r=this.controllers;i<r.length;i++){var o=r[i];if(o.hand===e)return o}return null},Object.defineProperty(t.prototype,"leftController",{get:function(){return this._leftController||(this._leftController=this.getControllerByName("left")),this._leftController},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rightController",{get:function(){return this._rightController||(this._rightController=this.getControllerByName("right")),this._rightController},enumerable:!1,configurable:!0}),t.prototype.getForwardRay=function(e){return e===void 0&&(e=100),this.leftCamera?n.prototype.getForwardRay.call(this,e,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition):n.prototype.getForwardRay.call(this,e)},t.prototype._checkInputs=function(){this._vrDevice&&this._vrDevice.isPresenting&&(this._vrDevice.getFrameData(this._frameData),this.updateFromDevice(this._frameData.pose)),n.prototype._checkInputs.call(this)},t.prototype.updateFromDevice=function(e){e&&e.orientation&&e.orientation.length===4&&(this.rawPose=e,this._deviceRoomRotationQuaternion.copyFromFloats(e.orientation[0],e.orientation[1],-e.orientation[2],-e.orientation[3]),this.getScene().useRightHandedSystem&&(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1),this.webVROptions.trackPosition&&this.rawPose.position&&(this._deviceRoomPosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]),this.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1)),this._poseSet=!0)},t.prototype.attachControl=function(e){e=re.b.BackCompatCameraNoPreventDefault(arguments),n.prototype.attachControl.call(this,e),this._attached=!0,e=te.a.ForceAttachControlToAlwaysPreventDefault?!1:e,this._vrDevice&&this.getEngine().enableVR(this.webVROptions);var i=this._scene.getEngine().getHostWindow();i&&i.addEventListener("vrdisplaypresentchange",this._detachIfAttached)},t.prototype.detachControl=function(e){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),n.prototype.detachControl.call(this),this._attached=!1,this.getEngine().disableVR(),window.removeEventListener("vrdisplaypresentchange",this._detachIfAttached)},t.prototype.getClassName=function(){return"WebVRFreeCamera"},t.prototype.resetToCurrentRotation=function(){this._vrDevice.resetPose()},t.prototype._updateRigCameras=function(){var e=this._rigCameras[0],i=this._rigCameras[1];e.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),i.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),e.position.copyFrom(this._deviceRoomPosition),i.position.copyFrom(this._deviceRoomPosition)},t.prototype._correctPositionIfNotTrackPosition=function(e,i){i===void 0&&(i=!1),this.rawPose&&this.rawPose.position&&!this.webVROptions.trackPosition&&(l.a.TranslationToRef(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2],this._tmpMatrix),i||this._tmpMatrix.invert(),this._tmpMatrix.multiplyToRef(e,e))},t.prototype._updateCache=function(e){var i=this;(!this.rotationQuaternion.equals(this._cache.rotationQuaternion)||!this.position.equals(this._cache.position))&&(this.updateCacheCalled||(this.updateCacheCalled=!0,this.update()),this.rotationQuaternion.toRotationMatrix(this._workingMatrix),l.e.TransformCoordinatesToRef(this._deviceRoomPosition,this._workingMatrix,this._workingVector),this.devicePosition.subtractToRef(this._workingVector,this._workingVector),l.a.ComposeToRef(this._oneVector,this.rotationQuaternion,this._workingVector,this._deviceToWorld),this._deviceToWorld.getTranslationToRef(this._workingVector),this._workingVector.addInPlace(this.position),this._workingVector.subtractInPlace(this._cache.position),this._deviceToWorld.setTranslation(this._workingVector),this._deviceToWorld.invertToRef(this._worldToDevice),this.controllers.forEach(function(r){r._deviceToWorld.copyFrom(i._deviceToWorld),i._correctPositionIfNotTrackPosition(r._deviceToWorld),r.update()})),e||n.prototype._updateCache.call(this),this.updateCacheCalled=!1},t.prototype._computeDevicePosition=function(){l.e.TransformCoordinatesToRef(this._deviceRoomPosition,this._deviceToWorld,this.devicePosition)},t.prototype.update=function(){this._computeDevicePosition(),l.a.FromQuaternionToRef(this._deviceRoomRotationQuaternion,this._workingMatrix),this._workingMatrix.multiplyToRef(this._deviceToWorld,this._workingMatrix),l.b.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this._poseSet&&this.onPoseUpdatedFromDeviceObservable.notifyObservers(null),n.prototype.update.call(this)},t.prototype._getViewMatrix=function(){return l.a.Identity()},t.prototype._getWebVRViewMatrix=function(){var e=this._cameraRigParams.parentCamera;e._updateCache();var i=this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix;return l.a.FromArrayToRef(i,0,this._webvrViewMatrix),this.getScene().useRightHandedSystem||this._webvrViewMatrix.toggleModelMatrixHandInPlace(),this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix),l.e.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),e.deviceScaleFactor!==1&&(this._webvrViewMatrix.invert(),e.deviceScaleFactor&&(this._webvrViewMatrix.multiplyAtIndex(12,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(13,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(14,e.deviceScaleFactor)),this._webvrViewMatrix.invert()),e._correctPositionIfNotTrackPosition(this._webvrViewMatrix,!0),e._worldToDevice.multiplyToRef(this._webvrViewMatrix,this._webvrViewMatrix),this._workingMatrix=this._workingMatrix||l.a.Identity(),this._webvrViewMatrix.invertToRef(this._workingMatrix),this._workingMatrix.multiplyToRef(e.getWorldMatrix(),this._workingMatrix),this._workingMatrix.getTranslationToRef(this._globalPosition),this._markSyncedWithParent(),this._webvrViewMatrix},t.prototype._getWebVRProjectionMatrix=function(){var e=this.parent;e._vrDevice.depthNear=e.minZ,e._vrDevice.depthFar=e.maxZ;var i=this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix;return l.a.FromArrayToRef(i,0,this._projectionMatrix),this.getScene().useRightHandedSystem||this._projectionMatrix.toggleProjectionMatrixHandInPlace(),this._projectionMatrix},t.prototype.initControllers=function(){var e=this;this.controllers=[];var i=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=i.onGamepadDisconnectedObservable.add(function(r){if(r.type===Ot.POSE_ENABLED){var o=r;o.defaultModel&&o.defaultModel.setEnabled(!1),o.hand==="right"&&(e._rightController=null),o.hand==="left"&&(e._leftController=null);var a=e.controllers.indexOf(o);a!==-1&&e.controllers.splice(a,1)}}),this._onGamepadConnectedObserver=i.onGamepadConnectedObservable.add(function(r){if(r.type===Ot.POSE_ENABLED){var o=r;if(e.webVROptions.trackPosition||(o._disableTrackPosition(new l.e(o.hand=="left"?-.15:.15,-.5,.25)),e._updateCacheWhenTrackingDisabledObserver||(e._updateCacheWhenTrackingDisabledObserver=e._scene.onBeforeRenderObservable.add(function(){e._updateCache()}))),o.deviceScaleFactor=e.deviceScaleFactor,o._deviceToWorld.copyFrom(e._deviceToWorld),e._correctPositionIfNotTrackPosition(o._deviceToWorld),e.webVROptions.controllerMeshes&&(o.defaultModel?o.defaultModel.setEnabled(!0):o.initControllerMesh(e.getScene(),function(c){if(c.scaling.scaleInPlace(e.deviceScaleFactor),e.onControllerMeshLoadedObservable.notifyObservers(o),e.webVROptions.defaultLightingOnControllers){e._lightOnControllers||(e._lightOnControllers=new $n.a("vrControllersLight",new l.e(0,1,0),e.getScene()));var _=function(b,C){var x=b.getChildren();x&&x.length!==0&&x.forEach(function(V){C.includedOnlyMeshes.push(V),_(V,C)})};e._lightOnControllers.includedOnlyMeshes.push(c),_(c,e._lightOnControllers)}})),o.attachToPoseControlledCamera(e),e.controllers.indexOf(o)===-1){e.controllers.push(o);for(var a=!1,s=0;s<e.controllers.length;s++)e.controllers[s].controllerType===Li.VIVE&&(a?e.controllers[s].hand="right":(a=!0,e.controllers[s].hand="left"));e.controllers.length>=2&&e.onControllersAttachedObservable.notifyObservers(e.controllers)}}})},t}(kt.a),Br=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.onTriggerStateChangedObservable=new g.c,i.onMainButtonStateChangedObservable=new g.c,i.onSecondaryButtonStateChangedObservable=new g.c,i.onPadStateChangedObservable=new g.c,i.onPadValuesChangedObservable=new g.c,i.pad={x:0,y:0},i._changes={pressChanged:!1,touchChanged:!1,valueChanged:!1,changed:!1},i._buttons=new Array(e.buttons.length),i.hand=e.hand,i}return t.prototype.onButtonStateChange=function(e){this._onButtonStateChange=e},Object.defineProperty(t.prototype,"defaultModel",{get:function(){return this._defaultModel},enumerable:!1,configurable:!0}),t.prototype.update=function(){n.prototype.update.call(this);for(var e=0;e<this._buttons.length;e++)this._setButtonValue(this.browserGamepad.buttons[e],this._buttons[e],e);(this.leftStick.x!==this.pad.x||this.leftStick.y!==this.pad.y)&&(this.pad.x=this.leftStick.x,this.pad.y=this.leftStick.y,this.onPadValuesChangedObservable.notifyObservers(this.pad))},t.prototype._setButtonValue=function(e,i,r){if(e||(e={pressed:!1,touched:!1,value:0}),!i){this._buttons[r]={pressed:e.pressed,touched:e.touched,value:e.value};return}this._checkChanges(e,i),this._changes.changed&&(this._onButtonStateChange&&this._onButtonStateChange(this.index,r,e),this._handleButtonChange(r,e,this._changes)),this._buttons[r].pressed=e.pressed,this._buttons[r].touched=e.touched,this._buttons[r].value=e.value<1e-8?0:e.value},t.prototype._checkChanges=function(e,i){return this._changes.pressChanged=e.pressed!==i.pressed,this._changes.touchChanged=e.touched!==i.touched,this._changes.valueChanged=e.value!==i.value,this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged,this._changes},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._defaultModel=null,this.onTriggerStateChangedObservable.clear(),this.onMainButtonStateChangedObservable.clear(),this.onSecondaryButtonStateChangedObservable.clear(),this.onPadStateChangedObservable.clear(),this.onPadValuesChangedObservable.clear()},t}(qi),st=u(446),gr=u(491),zt=u(455),un=u(479),Xa=u(518),Ya=u(624),eo=u(564),Tr=u(494),wo=function(){function n(){}return n.GetDefaults=function(t){var e=new n;return e.canvasOptions={antialias:!0,depth:!0,stencil:t?t.isStencilEnable:!0,alpha:!0,multiview:!1,framebufferScaleFactor:1},e.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",e},n}(),to=function(){function n(t,e){var i=this;if(e===void 0&&(e=wo.GetDefaults()),this._options=e,this._canvas=null,this._engine=null,this.xrLayer=null,this.onXRLayerInitObservable=new g.c,this._engine=t.scene.getEngine(),this._engine.onDisposeObservable.addOnce(function(){i._engine=null}),e.canvasElement)this._setManagedOutputCanvas(e.canvasElement);else{var r=document.createElement("canvas");r.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(r)}t.onXRSessionInit.add(function(){i._addCanvas()}),t.onXRSessionEnded.add(function(){i._removeCanvas()})}return n.prototype.dispose=function(){this._removeCanvas(),this._setManagedOutputCanvas(null)},n.prototype.initializeXRLayerAsync=function(t){var e=this,i=function(){var r=new XRWebGLLayer(t,e.canvasContext,e._options.canvasOptions);return e.onXRLayerInitObservable.notifyObservers(r),r};return this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(function(){},function(){re.b.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")}).then(function(){return e.xrLayer=i(),e.xrLayer}):(this.xrLayer=i(),Promise.resolve(this.xrLayer))},n.prototype._addCanvas=function(){var t=this;this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(function(e){t._setCanvasSize(!0,e)})},n.prototype._removeCanvas=function(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)},n.prototype._setCanvasSize=function(t,e){t===void 0&&(t=!0),e===void 0&&(e=this.xrLayer),!(!this._canvas||!this._engine)&&(t?e&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=e.framebufferWidth+"px",this._canvas.style.height=e.framebufferHeight+"px"):this._engine.setSize(e.framebufferWidth,e.framebufferHeight)):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))},n.prototype._setManagedOutputCanvas=function(t){this._removeCanvas(),t?(this._originalCanvasSize={width:t.offsetWidth,height:t.offsetHeight},this._canvas=t,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)},n}(),bn=function(){function n(t){var e=this;this.scene=t,this._sessionEnded=!1,this.baseLayer=null,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new g.c,this.onXRReferenceSpaceChanged=new g.c,this.onXRSessionEnded=new g.c,this.onXRSessionInit=new g.c,this._engine=t.getEngine(),this._engine.onDisposeObservable.addOnce(function(){e._engine=null})}return Object.defineProperty(n.prototype,"referenceSpace",{get:function(){return this._referenceSpace},set:function(t){this._referenceSpace=t,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this._sessionEnded||this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear()},n.prototype.exitXRAsync=function(){return this.session&&!this._sessionEnded?(this._sessionEnded=!0,this.session.end().catch(function(t){d.a.Warn("Could not end XR session.")})):Promise.resolve()},n.prototype.getRenderTargetTextureForEye=function(t){return this._rttProvider.getRenderTargetForEye(t)},n.prototype.getWebXRRenderTarget=function(t){var e=this.scene.getEngine();return this._xrNavigator.xr.native?this._xrNavigator.xr.getWebXRRenderTarget(e):(t=t||wo.GetDefaults(e),t.canvasElement=e.getRenderingCanvas()||void 0,new to(this,t))},n.prototype.initializeAsync=function(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")},n.prototype.initializeSessionAsync=function(t,e){var i=this;return t===void 0&&(t="immersive-vr"),e===void 0&&(e={}),this._xrNavigator.xr.requestSession(t,e).then(function(r){return i.session=r,i.onXRSessionInit.notifyObservers(r),i._sessionEnded=!1,i.session.addEventListener("end",function(){i._sessionEnded=!0,i._rttProvider=null,i._engine&&(i._engine.framebufferDimensionsObject=null,i._engine.restoreDefaultFramebuffer(),i._engine.customAnimationFrameRequester=null,i._engine._renderLoop()),i.onXRSessionEnded.notifyObservers(null)},{once:!0}),i.session})},n.prototype.isSessionSupportedAsync=function(t){return n.IsSessionSupportedAsync(t)},n.prototype.resetReferenceSpace=function(){this.referenceSpace=this.baseReferenceSpace},n.prototype.runXRRenderLoop=function(){var t=this;if(!(this._sessionEnded||!this._engine)){if(this._engine.customAnimationFrameRequester={requestAnimationFrame:this.session.requestAnimationFrame.bind(this.session),renderFunction:function(a,s){t._sessionEnded||!t._engine||(t.currentFrame=s,t.currentTimestamp=a,s&&(t._engine.framebufferDimensionsObject=t.baseLayer,t.onXRFrameObservable.notifyObservers(s),t._engine._renderLoop(),t._engine.framebufferDimensionsObject=null))}},this._xrNavigator.xr.native)this._rttProvider=this._xrNavigator.xr.getNativeRenderTargetProvider(this.session,this._createRenderTargetTexture.bind(this));else{var e,i,r,o;this._rttProvider={getRenderTargetForEye:function(){var a=t.baseLayer;return(a.framebufferWidth!==i||a.framebufferHeight!==r||a.framebuffer!==o)&&(e=t._createRenderTargetTexture(a.framebufferWidth,a.framebufferHeight,a.framebuffer),i=a.framebufferWidth,r=a.framebufferHeight,o=a.framebuffer),e}},this._engine.framebufferDimensionsObject=this.baseLayer}typeof window!="undefined"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop()}},n.prototype.setReferenceSpaceTypeAsync=function(t){var e=this;return t===void 0&&(t="local-floor"),this.session.requestReferenceSpace(t).then(function(i){return i},function(i){return d.a.Error("XR.requestReferenceSpace failed for the following reason: "),d.a.Error(i),d.a.Log('Defaulting to universally-supported "viewer" reference space type.'),e.session.requestReferenceSpace("viewer").then(function(r){var o=new XRRigidTransform({x:0,y:-e.defaultHeightCompensation,z:0});return r.getOffsetReferenceSpace(o)},function(r){throw d.a.Error(r),'XR initialization failed: required "viewer" reference space type not supported.'})}).then(function(i){return e.session.requestReferenceSpace("viewer").then(function(r){return e.viewerReferenceSpace=r,i})}).then(function(i){return e.referenceSpace=e.baseReferenceSpace=i,e.referenceSpace})},n.prototype.updateRenderStateAsync=function(t){return t.baseLayer&&(this.baseLayer=t.baseLayer),this.session.updateRenderState(t)},n.IsSessionSupportedAsync=function(t){if(!navigator.xr)return Promise.resolve(!1);var e=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return e?e.call(navigator.xr,t).then(function(i){var r=typeof i=="undefined"?!0:i;return Promise.resolve(r)}).catch(function(i){return d.a.Warn(i),Promise.resolve(!1)}):Promise.resolve(!1)},Object.defineProperty(n.prototype,"isNative",{get:function(){var t;return(t=this._xrNavigator.xr.native)!==null&&t!==void 0?t:!1},enumerable:!1,configurable:!0}),n.prototype._createRenderTargetTexture=function(t,e,i){if(!this._engine)throw new Error("Engine is disposed");var r=new gt.a(this._engine,gt.b.Unknown,!0);r.width=t,r.height=e,r._framebuffer=i;var o=new Cr.a("XR renderTargetTexture",{width:t,height:e},this.scene,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0);return o._texture=r,o},n}(),pi;(function(n){n[n.ENTERING_XR=0]="ENTERING_XR",n[n.EXITING_XR=1]="EXITING_XR",n[n.IN_XR=2]="IN_XR",n[n.NOT_IN_XR=3]="NOT_IN_XR"})(pi||(pi={}));var Nr;(function(n){n[n.NOT_TRACKING=0]="NOT_TRACKING",n[n.TRACKING_LOST=1]="TRACKING_LOST",n[n.TRACKING=2]="TRACKING"})(Nr||(Nr={}));var cn=function(){function n(t,e){if(e===void 0&&(e=null),this.scene=t,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=n._idCounter++,e)this._gazeTracker=e.clone("gazeTracker");else{this._gazeTracker=st.a.CreateTorus("gazeTracker",.0035,.0025,20,t,!1),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;var i=new zt.a("targetMat",t);i.specularColor=v.a.Black(),i.emissiveColor=new v.a(.7,.7,.7),i.backFaceCulling=!1,this._gazeTracker.material=i}}return n.prototype._getForwardRay=function(t){return new Jt.a(l.e.Zero(),new l.e(0,0,t))},n.prototype._selectionPointerDown=function(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})},n.prototype._selectionPointerUp=function(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1},n.prototype._activatePointer=function(){this._activePointer=!0},n.prototype._deactivatePointer=function(){this._activePointer=!1},n.prototype._updatePointerDistance=function(t){t===void 0&&(t=100)},n.prototype.dispose=function(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()},n._idCounter=0,n}(),$r=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,i,r)||this;o.webVRController=e,o._laserPointer=st.a.CreateCylinder("laserPointer",1,.004,2e-4,20,1,i,!1);var a=new zt.a("laserPointerMat",i);if(a.emissiveColor=new v.a(.7,.7,.7),a.alpha=.6,o._laserPointer.material=a,o._laserPointer.rotation.x=Math.PI/2,o._laserPointer.position.z=-.5,o._laserPointer.isVisible=!1,o._laserPointer.isPickable=!1,!e.mesh){var s=new st.a("preloadControllerMesh",i),c=new st.a(qi.POINTING_POSE,i);c.rotation.x=-.7,s.addChild(c),e.attachToMesh(s)}return o._setLaserPointerParent(e.mesh),o._meshAttachedObserver=e._meshAttachedObservable.add(function(_){o._setLaserPointerParent(_)}),o}return t.prototype._getForwardRay=function(e){return this.webVRController.getForwardRay(e)},t.prototype._activatePointer=function(){n.prototype._activatePointer.call(this),this._laserPointer.isVisible=!0},t.prototype._deactivatePointer=function(){n.prototype._deactivatePointer.call(this),this._laserPointer.isVisible=!1},t.prototype._setLaserPointerColor=function(e){this._laserPointer.material.emissiveColor=e},t.prototype._setLaserPointerLightingDisabled=function(e){this._laserPointer.material.disableLighting=e},t.prototype._setLaserPointerParent=function(e){var i=function(s){s.isPickable=!1,s.getChildMeshes().forEach(function(c){i(c)})};i(e);var r=e.getChildren(void 0,!1),o=e;this.webVRController._pointingPoseNode=null;for(var a=0;a<r.length;a++)if(r[a].name&&r[a].name.indexOf(qi.POINTING_POSE)>=0){o=r[a],this.webVRController._pointingPoseNode=o;break}this._laserPointer.parent=o},t.prototype._updatePointerDistance=function(e){e===void 0&&(e=100),this._laserPointer.scaling.y=e,this._laserPointer.position.z=-e/2},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._laserPointer.dispose(),this._meshAttachedObserver&&this.webVRController._meshAttachedObservable.remove(this._meshAttachedObserver)},t}(cn),En=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,i)||this;return r.getCamera=e,r}return t.prototype._getForwardRay=function(e){var i=this.getCamera();return i?i.getForwardRay(e):new Jt.a(l.e.Zero(),l.e.Forward())},t}(cn),Ka=function(){function n(){}return n}(),We=function(){function n(t,e){var i=this;e===void 0&&(e={}),this.webVROptions=e,this._webVRsupported=!1,this._webVRready=!1,this._webVRrequesting=!1,this._webVRpresenting=!1,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new g.c,this.onAfterEnteringVRObservable=new g.c,this.onExitingVRObservable=new g.c,this.onControllerMeshLoadedObservable=new g.c,this._useCustomVRButton=!1,this._teleportationRequested=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=n.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new l.e(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new l.e(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._leftController=null,this._rightController=null,this._gazeColor=new v.a(.7,.7,.7),this._laserColor=new v.a(.7,.7,.7),this._pickedLaserColor=new v.a(.2,.2,1),this._pickedGazeColor=new v.a(0,0,1),this.onNewMeshSelected=new g.c,this.onMeshSelectedWithController=new g.c,this.onNewMeshPicked=new g.c,this.onBeforeCameraTeleport=new g.c,this.onAfterCameraTeleport=new g.c,this.onSelectedMeshUnselected=new g.c,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._interactionsRequested=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=function(){i.moveButtonToBottomRight(),i._fullscreenVRpresenting&&i._webVRready&&i.exitVR()},this._onFullscreenChange=function(){var a=document;a.fullscreen!==void 0?i._fullscreenVRpresenting=document.fullscreen:a.mozFullScreen!==void 0?i._fullscreenVRpresenting=a.mozFullScreen:a.webkitIsFullScreen!==void 0?i._fullscreenVRpresenting=a.webkitIsFullScreen:a.msIsFullScreen!==void 0?i._fullscreenVRpresenting=a.msIsFullScreen:document.msFullscreenElement!==void 0&&(i._fullscreenVRpresenting=document.msFullscreenElement),!i._fullscreenVRpresenting&&i._inputElement&&(i.exitVR(),!i._useCustomVRButton&&i._btnVR&&(i._btnVR.style.top=i._inputElement.offsetTop+i._inputElement.offsetHeight-70+"px",i._btnVR.style.left=i._inputElement.offsetLeft+i._inputElement.offsetWidth-100+"px",i.updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this.beforeRender=function(){i._leftController&&i._leftController._activePointer&&i._castRayAndSelectObject(i._leftController),i._rightController&&i._rightController._activePointer&&i._castRayAndSelectObject(i._rightController),i._noControllerIsActive&&(i._scene.getEngine().isPointerLock||i.enableGazeEvenWhenNoPointerLock)?i._castRayAndSelectObject(i._cameraGazer):i._cameraGazer._gazeTracker.isVisible=!1},this._onNewGamepadConnected=function(a){if(a.type!==Ot.POSE_ENABLED)a.leftStick&&a.onleftstickchanged(function(_){i._teleportationInitialized&&i.teleportationEnabled&&(!i._leftController&&!i._rightController||i._leftController&&!i._leftController._activePointer&&i._rightController&&!i._rightController._activePointer)&&(i._checkTeleportWithRay(_,i._cameraGazer),i._checkTeleportBackwards(_,i._cameraGazer))}),a.rightStick&&a.onrightstickchanged(function(_){i._teleportationInitialized&&i._checkRotate(_,i._cameraGazer)}),a.type===Ot.XBOX&&(a.onbuttondown(function(_){i._interactionsEnabled&&_===Xt.A&&i._cameraGazer._selectionPointerDown()}),a.onbuttonup(function(_){i._interactionsEnabled&&_===Xt.A&&i._cameraGazer._selectionPointerUp()}));else{var s=a,c=new $r(s,i._scene,i._cameraGazer._gazeTracker);s.hand==="right"||i._leftController&&i._leftController.webVRController!=s?i._rightController=c:i._leftController=c,i._tryEnableInteractionOnController(c)}},this._tryEnableInteractionOnController=function(a){i._interactionsRequested&&!a._interactionsEnabled&&i._enableInteractionOnController(a),i._teleportationRequested&&!a._teleportationEnabled&&i._enableTeleportationOnController(a)},this._onNewGamepadDisconnected=function(a){a instanceof Br&&(a.hand==="left"&&i._leftController!=null&&(i._leftController.dispose(),i._leftController=null),a.hand==="right"&&i._rightController!=null&&(i._rightController.dispose(),i._rightController=null))},this._workingVector=l.e.Zero(),this._workingQuaternion=l.b.Identity(),this._workingMatrix=l.a.Identity(),this._scene=t,this._inputElement=t.getEngine().getInputElement();var r="getVRDisplays"in navigator;if(r||(e.useXR=!0),e.createFallbackVRDeviceOrientationFreeCamera===void 0&&(e.createFallbackVRDeviceOrientationFreeCamera=!0),e.createDeviceOrientationCamera===void 0&&(e.createDeviceOrientationCamera=!0),e.laserToggle===void 0&&(e.laserToggle=!0),e.defaultHeight===void 0&&(e.defaultHeight=1.7),e.useCustomVRButton&&(this._useCustomVRButton=!0,e.customVRButton&&(this._btnVR=e.customVRButton)),e.rayLength&&(this._rayLength=e.rayLength),this._defaultHeight=e.defaultHeight,e.positionScale&&(this._rayLength*=e.positionScale,this._defaultHeight*=e.positionScale),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new l.e(0,this._defaultHeight,0),e.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new pr("deviceOrientationVRHelper",this._position.clone(),t),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof Ii.a&&this._scene.activeCamera.rotation)){var o=this._scene.activeCamera;o.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(o.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(l.b.RotationYawPitchRoll(o.rotation.y,o.rotation.x,o.rotation.z)),this._deviceOrientationCamera.rotation=o.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?bn.IsSessionSupportedAsync("immersive-vr").then(function(a){a?(d.a.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),t.createDefaultXRExperienceAsync({floorMeshes:e.floorMeshes||[]}).then(function(s){i.xr=s,i.xrTestDone=!0,i._cameraGazer=new En(function(){return i.xr.baseExperience.camera},t),i.xr.baseExperience.onStateChangedObservable.add(function(c){switch(c){case pi.ENTERING_XR:i.onEnteringVRObservable.notifyObservers(i),i._interactionsEnabled||i.xr.pointerSelection.detach(),i.xr.pointerSelection.displayLaserPointer=i._displayLaserPointer;break;case pi.EXITING_XR:i.onExitingVRObservable.notifyObservers(i),i._scene.getEngine().resize();break;case pi.IN_XR:i._hasEnteredVR=!0;break;case pi.NOT_IN_XR:i._hasEnteredVR=!1;break}})})):i.completeVRInit(t,e)}):this.completeVRInit(t,e)}return Object.defineProperty(n.prototype,"onEnteringVR",{get:function(){return this.onEnteringVRObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onExitingVR",{get:function(){return this.onExitingVRObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onControllerMeshLoaded",{get:function(){return this.onControllerMeshLoadedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"teleportationTarget",{get:function(){return this._teleportationTarget},set:function(t){t&&(t.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"gazeTrackerMesh",{get:function(){return this._cameraGazer._gazeTracker},set:function(t){t&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._leftController&&this._leftController._gazeTracker&&this._leftController._gazeTracker.dispose(),this._rightController&&this._rightController._gazeTracker&&this._rightController._gazeTracker.dispose(),this._cameraGazer._gazeTracker=t,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker",this._leftController&&(this._leftController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")),this._rightController&&(this._rightController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"leftControllerGazeTrackerMesh",{get:function(){return this._leftController?this._leftController._gazeTracker:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightControllerGazeTrackerMesh",{get:function(){return this._rightController?this._rightController._gazeTracker:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"displayGaze",{get:function(){return this._displayGaze},set:function(t){this._displayGaze=t,t||(this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"displayLaserPointer",{get:function(){return this._displayLaserPointer},set:function(t){this._displayLaserPointer=t,t?(this._rightController&&this._rightController._activatePointer(),this._leftController&&this._leftController._activatePointer()):(this._rightController&&(this._rightController._deactivatePointer(),this._rightController._gazeTracker.isVisible=!1),this._leftController&&(this._leftController._deactivatePointer(),this._leftController._gazeTracker.isVisible=!1))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"deviceOrientationCamera",{get:function(){return this._deviceOrientationCamera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentVRCamera",{get:function(){return this._webVRready?this._webVRCamera:this._scene.activeCamera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"webVRCamera",{get:function(){return this._webVRCamera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"vrDeviceOrientationCamera",{get:function(){return this._vrDeviceOrientationCamera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"vrButton",{get:function(){return this._btnVR},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_teleportationRequestInitiated",{get:function(){var t=this._cameraGazer._teleportationRequestInitiated||this._leftController!==null&&this._leftController._teleportationRequestInitiated||this._rightController!==null&&this._rightController._teleportationRequestInitiated;return t},enumerable:!1,configurable:!0}),n.prototype.completeVRInit=function(t,e){var i=this;if(this.xrTestDone=!0,e.createFallbackVRDeviceOrientationFreeCamera&&(e.useMultiview&&(e.vrDeviceOrientationCameraMetrics||(e.vrDeviceOrientationCameraMetrics=Lr.GetDefault()),e.vrDeviceOrientationCameraMetrics.multiviewEnabled=!0),this._vrDeviceOrientationCamera=new Jn("VRDeviceOrientationVRHelper",this._position,this._scene,!0,e.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._webVRCamera=new qn("WebVRHelper",this._position,this._scene,e),this._webVRCamera.useStandingMatrix(),this._cameraGazer=new En(function(){return i.currentVRCamera},t),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";var r=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png",o=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+r+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+=".babylonVRicon.vrdisplaypresenting { display: none; }";var a=document.createElement("style");a.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(a),this.moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",function(){i.isInVRMode?i._scene.getEngine().disableVR():i.enterVR()});var s=this._scene.getEngine().getHostWindow();!s||(s.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",this._onFullscreenChange,!1),document.onmsfullscreenchange=this._onFullscreenChange,e.createFallbackVRDeviceOrientationFreeCamera?this.displayVRButton():this._scene.getEngine().onVRDisplayChangedObservable.add(function(c){c.vrDisplay&&i.displayVRButton()}),this._onKeyDown=function(c){c.keyCode===27&&i.isInVRMode&&i.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(function(){i._hasEnteredVR&&i.exitVROnDoubleTap&&(i.exitVR(),i._fullscreenVRpresenting&&i._scene.getEngine().exitFullscreen())},se.a.POINTERDOUBLETAP,!1),this._onVRDisplayChanged=function(c){return i.onVRDisplayChanged(c)},this._onVrDisplayPresentChange=function(){return i.onVrDisplayPresentChange()},this._onVRRequestPresentStart=function(){i._webVRrequesting=!0,i.updateButtonVisibility()},this._onVRRequestPresentComplete=function(){i._webVRrequesting=!1,i.updateButtonVisibility()},t.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChanged),t.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart),t.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete),s.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),t.onDisposeObservable.add(function(){i.dispose()}),this._webVRCamera.onControllerMeshLoadedObservable.add(function(c){return i._onDefaultMeshLoaded(c)}),this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected),this.updateButtonVisibility(),this._circleEase=new L.d,this._circleEase.setEasingMode(L.f.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,t.onPointerObservable.add(function(c){i._interactionsEnabled&&t.activeCamera===i.vrDeviceOrientationCamera&&c.event.pointerType==="mouse"&&(c.type===se.a.POINTERDOWN?i._cameraGazer._selectionPointerDown():c.type===se.a.POINTERUP&&i._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))},n.prototype._onDefaultMeshLoaded=function(t){this._leftController&&this._leftController.webVRController==t&&t.mesh&&this._leftController._setLaserPointerParent(t.mesh),this._rightController&&this._rightController.webVRController==t&&t.mesh&&this._rightController._setLaserPointerParent(t.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(t)}catch(e){d.a.Warn("Error in your custom logic onControllerMeshLoaded: "+e)}},Object.defineProperty(n.prototype,"isInVRMode",{get:function(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===pi.IN_XR||this._webVRpresenting||this._fullscreenVRpresenting},enumerable:!1,configurable:!0}),n.prototype.onVrDisplayPresentChange=function(){var t=this._scene.getEngine().getVRDevice();if(t){var e=this._webVRpresenting;this._webVRpresenting=t.isPresenting,e&&!this._webVRpresenting&&this.exitVR()}else d.a.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?");this.updateButtonVisibility()},n.prototype.onVRDisplayChanged=function(t){this._webVRsupported=t.vrSupported,this._webVRready=!!t.vrDisplay,this._webVRpresenting=t.vrDisplay&&t.vrDisplay.isPresenting,this.updateButtonVisibility()},n.prototype.moveButtonToBottomRight=function(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){var t=this._inputElement.getBoundingClientRect();this._btnVR.style.top=t.top+t.height-70+"px",this._btnVR.style.left=t.left+t.width-100+"px"}},n.prototype.displayVRButton=function(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)},n.prototype.updateButtonVisibility=function(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode?this._btnVR.className+=" vrdisplaypresenting":(this._webVRready&&(this._btnVR.className+=" vrdisplayready"),this._webVRsupported&&(this._btnVR.className+=" vrdisplaysupported"),this._webVRrequesting&&(this._btnVR.className+=" vrdisplayrequesting")))},n.prototype.enterVR=function(){var t=this;if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(a){d.a.Warn("Error in your custom logic onEnteringVR: "+a)}if(this._scene.activeCamera){if(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=l.b.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this.webVRCamera){var e=this.webVRCamera.deviceRotationQuaternion.toEulerAngles().y,i=l.b.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles().y,r=i-e,o=this.webVRCamera.rotationQuaternion.toEulerAngles().y;this.webVRCamera.rotationQuaternion=l.b.FromEulerAngles(0,o+r,0)}this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)}this._webVRrequesting||(this._webVRready?this._webVRpresenting||(this._scene.getEngine().onVRRequestPresentComplete.addOnce(function(a){t.onAfterEnteringVRObservable.notifyObservers({success:a})}),this._webVRCamera.position=this._position,this._scene.activeCamera=this._webVRCamera):this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this.updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(function(){t.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this.beforeRender),this._displayLaserPointer&&[this._leftController,this._rightController].forEach(function(a){a&&a._activatePointer()}),this._hasEnteredVR=!0)},n.prototype.exitVR=function(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){d.a.Warn("Error in your custom logic onExitingVR: "+e)}this._webVRpresenting&&this._scene.getEngine().disableVR(),this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this.updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this.beforeRender),this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1)),this._scene.getEngine().resize(),[this._leftController,this._rightController].forEach(function(e){e&&e._deactivatePointer()}),this._hasEnteredVR=!1;var t=this._scene.getEngine();t._onVrDisplayPresentChange&&t._onVrDisplayPresentChange()}},Object.defineProperty(n.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this._scene.activeCamera&&(this._scene.activeCamera.position=t)},enumerable:!1,configurable:!0}),n.prototype.enableInteractions=function(){var t=this;if(!this._interactionsEnabled){if(this._interactionsRequested=!0,this.xr){this.xr.baseExperience.state===pi.IN_XR&&this.xr.pointerSelection.attach();return}this._leftController&&this._enableInteractionOnController(this._leftController),this._rightController&&this._enableInteractionOnController(this._rightController),this.raySelectionPredicate=function(e){return e.isVisible&&(e.isPickable||e.name===t._floorMeshName)},this.meshSelectionPredicate=function(){return!0},this._raySelectionPredicate=function(e){return t._isTeleportationFloor(e)||e.name.indexOf("gazeTracker")===-1&&e.name.indexOf("teleportationTarget")===-1&&e.name.indexOf("torusTeleportation")===-1?t.raySelectionPredicate(e):!1},this._interactionsEnabled=!0}},Object.defineProperty(n.prototype,"_noControllerIsActive",{get:function(){return!(this._leftController&&this._leftController._activePointer)&&!(this._rightController&&this._rightController._activePointer)},enumerable:!1,configurable:!0}),n.prototype._isTeleportationFloor=function(t){for(var e=0;e<this._floorMeshesCollection.length;e++)if(this._floorMeshesCollection[e].id===t.id)return!0;return!!(this._floorMeshName&&t.name===this._floorMeshName)},n.prototype.addFloorMesh=function(t){!this._floorMeshesCollection||this._floorMeshesCollection.indexOf(t)>-1||this._floorMeshesCollection.push(t)},n.prototype.removeFloorMesh=function(t){if(!!this._floorMeshesCollection){var e=this._floorMeshesCollection.indexOf(t);e!==-1&&this._floorMeshesCollection.splice(e,1)}},n.prototype.enableTeleportation=function(t){var e=this;if(t===void 0&&(t={}),!this._teleportationInitialized){if(this._teleportationRequested=!0,this.enableInteractions(),this.webVROptions.useXR&&(t.floorMeshes||t.floorMeshName)){var i=t.floorMeshes||[];if(!i.length){var r=this._scene.getMeshByName(t.floorMeshName);r&&i.push(r)}if(this.xr){i.forEach(function(s){e.xr.teleportation.addFloorMesh(s)}),this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){var o=function(){e.xrTestDone&&(e._scene.unregisterBeforeRender(o),e.xr?e.xr.teleportation.attached||e.xr.teleportation.attach():e.enableTeleportation(t))};this._scene.registerBeforeRender(o);return}}t.floorMeshName&&(this._floorMeshName=t.floorMeshName),t.floorMeshes&&(this._floorMeshesCollection=t.floorMeshes),t.teleportationMode&&(this._teleportationMode=t.teleportationMode),t.teleportationTime&&t.teleportationTime>0&&(this._teleportationTime=t.teleportationTime),t.teleportationSpeed&&t.teleportationSpeed>0&&(this._teleportationSpeed=t.teleportationSpeed),t.easingFunction!==void 0&&(this._teleportationEasing=t.easingFunction),this._leftController!=null&&this._enableTeleportationOnController(this._leftController),this._rightController!=null&&this._enableTeleportationOnController(this._rightController);var a=new gr.a;a.vignetteColor=new v.b(0,0,0,0),a.vignetteEnabled=!0,this._postProcessMove=new Xa.a("postProcessMove",1,this._webVRCamera,void 0,void 0,void 0,void 0,a),this._webVRCamera.detachPostProcess(this._postProcessMove),this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&(this._createTeleportationCircles(),this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor))}},n.prototype._enableInteractionOnController=function(t){var e=this,i=t.webVRController.mesh;i&&(t._interactionsEnabled=!0,this.isInVRMode&&this._displayLaserPointer&&t._activatePointer(),this.webVROptions.laserToggle&&t.webVRController.onMainButtonStateChangedObservable.add(function(r){e._displayLaserPointer&&r.value===1&&(t._activePointer?t._deactivatePointer():t._activatePointer(),e.displayGaze&&(t._gazeTracker.isVisible=t._activePointer))}),t.webVRController.onTriggerStateChangedObservable.add(function(r){var o=t;e._noControllerIsActive&&(o=e._cameraGazer),o._pointerDownOnMeshAsked?r.value<e._padSensibilityDown&&o._selectionPointerUp():r.value>e._padSensibilityUp&&o._selectionPointerDown()}))},n.prototype._checkTeleportWithRay=function(t,e){this._teleportationRequestInitiated&&!e._teleportationRequestInitiated||(e._teleportationRequestInitiated?Math.sqrt(t.y*t.y+t.x*t.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),e._teleportationRequestInitiated=!1):t.y<-this._padSensibilityUp&&e._dpadPressed&&(e._activatePointer(),e._teleportationRequestInitiated=!0))},n.prototype._checkRotate=function(t,e){e._teleportationRequestInitiated||(e._rotationLeftAsked?t.x>-this._padSensibilityDown&&(e._rotationLeftAsked=!1):t.x<-this._padSensibilityUp&&e._dpadPressed&&(e._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),e._rotationRightAsked?t.x<this._padSensibilityDown&&(e._rotationRightAsked=!1):t.x>this._padSensibilityUp&&e._dpadPressed&&(e._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))},n.prototype._checkTeleportBackwards=function(t,e){if(!e._teleportationRequestInitiated)if(t.y>this._padSensibilityUp&&e._dpadPressed){if(!e._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;var i=l.b.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),r=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(i=this.currentVRCamera.deviceRotationQuaternion,r=this.currentVRCamera.devicePosition),i.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,l.b.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),l.e.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);var o=new Jt.a(r,this._workingVector),a=this._scene.pickWithRay(o,this._raySelectionPredicate);a&&a.pickedPoint&&a.pickedMesh&&this._isTeleportationFloor(a.pickedMesh)&&a.distance<5&&this.teleportCamera(a.pickedPoint),e._teleportationBackRequestInitiated=!0}}else e._teleportationBackRequestInitiated=!1},n.prototype._enableTeleportationOnController=function(t){var e=this,i=t.webVRController.mesh;i&&(t._interactionsEnabled||this._enableInteractionOnController(t),t._interactionsEnabled=!0,t._teleportationEnabled=!0,t.webVRController.controllerType===Li.VIVE&&(t._dpadPressed=!1,t.webVRController.onPadStateChangedObservable.add(function(r){t._dpadPressed=r.pressed,t._dpadPressed||(t._rotationLeftAsked=!1,t._rotationRightAsked=!1,t._teleportationBackRequestInitiated=!1)})),t.webVRController.onPadValuesChangedObservable.add(function(r){e.teleportationEnabled&&(e._checkTeleportBackwards(r,t),e._checkTeleportWithRay(r,t)),e._checkRotate(r,t)}))},n.prototype._createTeleportationCircles=function(){this._teleportationTarget=st.a.CreateGround("teleportationTarget",2,2,2,this._scene),this._teleportationTarget.isPickable=!1;var t=512,e=new un.a("DynamicTexture",t,this._scene,!0);e.hasAlpha=!0;var i=e.getContext(),r=t/2,o=t/2,a=200;i.beginPath(),i.arc(r,o,a,0,2*Math.PI,!1),i.fillStyle=this._teleportationFillColor,i.fill(),i.lineWidth=10,i.strokeStyle=this._teleportationBorderColor,i.stroke(),i.closePath(),e.update();var s=new zt.a("TextPlaneMaterial",this._scene);s.diffuseTexture=e,this._teleportationTarget.material=s;var c=st.a.CreateTorus("torusTeleportation",.75,.1,25,this._scene,!1);c.isPickable=!1,c.parent=this._teleportationTarget;var _=new y.a("animationInnerCircle","position.y",30,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CYCLE),b=[];b.push({frame:0,value:0}),b.push({frame:30,value:.4}),b.push({frame:60,value:0}),_.setKeys(b);var C=new L.m;C.setEasingMode(L.f.EASINGMODE_EASEINOUT),_.setEasingFunction(C),c.animations=[],c.animations.push(_),this._scene.beginAnimation(c,0,60,!0),this._hideTeleportationTarget()},n.prototype._displayTeleportationTarget=function(){this._teleportActive=!0,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!0,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!0))},n.prototype._hideTeleportationTarget=function(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))},n.prototype._rotateCamera=function(t){var e=this;if(this.currentVRCamera instanceof kt.a){t?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];var i=l.b.FromRotationMatrix(l.a.RotationY(Math.PI/4*this._rotationAngle)),r=new y.a("animationRotation","rotationQuaternion",90,y.a.ANIMATIONTYPE_QUATERNION,y.a.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),o.push({frame:6,value:i}),r.setKeys(o),r.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];var a=new y.a("animationPP","vignetteWeight",90,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:0}),s.push({frame:3,value:4}),s.push({frame:6,value:0}),a.setKeys(s),a.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(a);var c=new y.a("animationPP2","vignetteStretch",90,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CONSTANT),_=[];_.push({frame:0,value:0}),_.push({frame:3,value:10}),_.push({frame:6,value:0}),c.setKeys(_),c.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(c),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,6,!1,1,function(){e._webVRCamera.detachPostProcess(e._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}},n.prototype._moveTeleportationSelectorTo=function(t,e,i){if(t.pickedPoint){e._teleportationRequestInitiated&&(this._displayTeleportationTarget(),this._haloCenter.copyFrom(t.pickedPoint),this._teleportationTarget.position.copyFrom(t.pickedPoint));var r=this._convertNormalToDirectionOfRay(t.getNormal(!0,!1),i);if(r){var o=l.e.Cross(Le.a.Y,r),a=l.e.Cross(r,o);l.e.RotationFromAxisToRef(a,r,o,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}},n.prototype.teleportCamera=function(t){var e=this;if(this.currentVRCamera instanceof kt.a){this.webVRCamera.leftCamera?(this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition),this._workingVector.subtractInPlace(this.webVRCamera.position),t.subtractToRef(this._workingVector,this._workingVector)):this._workingVector.copyFrom(t),this.isInVRMode?this._workingVector.y+=this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor:this._workingVector.y+=this._defaultHeight,this.onBeforeCameraTeleport.notifyObservers(this._workingVector);var i=90,r,o;if(this._teleportationMode==n.TELEPORTATIONMODE_CONSTANTSPEED){o=i;var a=l.e.Distance(this.currentVRCamera.position,this._workingVector);r=this._teleportationSpeed/a}else o=Math.round(this._teleportationTime*i/1e3),r=1;this.currentVRCamera.animations=[];var s=new y.a("animationCameraTeleportation","position",i,y.a.ANIMATIONTYPE_VECTOR3,y.a.ANIMATIONLOOPMODE_CONSTANT),c=[{frame:0,value:this.currentVRCamera.position},{frame:o,value:this._workingVector}];s.setKeys(c),s.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];var _=Math.round(o/2),b=new y.a("animationPP","vignetteWeight",i,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CONSTANT),C=[];C.push({frame:0,value:0}),C.push({frame:_,value:8}),C.push({frame:o,value:0}),b.setKeys(C),this._postProcessMove.animations.push(b);var x=new y.a("animationPP2","vignetteStretch",i,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CONSTANT),V=[];V.push({frame:0,value:0}),V.push({frame:_,value:10}),V.push({frame:o,value:0}),x.setKeys(V),this._postProcessMove.animations.push(x),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,o,!1,r,function(){e._webVRCamera.detachPostProcess(e._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,o,!1,r,function(){e.onAfterCameraTeleport.notifyObservers(e._workingVector)}),this._hideTeleportationTarget()}},n.prototype._convertNormalToDirectionOfRay=function(t,e){if(t){var i=Math.acos(l.e.Dot(t,e.direction));i<Math.PI/2&&t.scaleInPlace(-1)}return t},n.prototype._castRayAndSelectObject=function(t){if(this.currentVRCamera instanceof kt.a){var e=t._getForwardRay(this._rayLength),i=this._scene.pickWithRay(e,this._raySelectionPredicate);if(i&&(t._laserPointer&&(i.originMesh=t._laserPointer.parent),this._scene.simulatePointerMove(i,{pointerId:t._id})),t._currentHit=i,i&&i.pickedPoint){if(this._displayGaze){var r=1;t._gazeTracker.isVisible=!0,t._isActionableMesh&&(r=3),this.updateGazeTrackerScale&&(t._gazeTracker.scaling.x=i.distance*r,t._gazeTracker.scaling.y=i.distance*r,t._gazeTracker.scaling.z=i.distance*r);var o=this._convertNormalToDirectionOfRay(i.getNormal(),e),a=.002;if(o){var s=l.e.Cross(Le.a.Y,o),c=l.e.Cross(o,s);l.e.RotationFromAxisToRef(c,o,s,t._gazeTracker.rotation)}t._gazeTracker.position.copyFrom(i.pickedPoint),t._gazeTracker.position.x<0?t._gazeTracker.position.x+=a:t._gazeTracker.position.x-=a,t._gazeTracker.position.y<0?t._gazeTracker.position.y+=a:t._gazeTracker.position.y-=a,t._gazeTracker.position.z<0?t._gazeTracker.position.z+=a:t._gazeTracker.position.z-=a}t._updatePointerDistance(i.distance)}else t._updatePointerDistance(),t._gazeTracker.isVisible=!1;if(i&&i.pickedMesh){if(this._teleportationInitialized&&this._isTeleportationFloor(i.pickedMesh)&&i.pickedPoint){t._currentMeshSelected&&!this._isTeleportationFloor(t._currentMeshSelected)&&this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,t._teleportationRequestInitiated&&this._moveTeleportationSelectorTo(i,t,e);return}if(i.pickedMesh!==t._currentMeshSelected)if(this.meshSelectionPredicate(i.pickedMesh)){this.onNewMeshPicked.notifyObservers(i),t._currentMeshSelected=i.pickedMesh,i.pickedMesh.isPickable&&i.pickedMesh.actionManager?(this.changeGazeColor(this._pickedGazeColor),this.changeLaserColor(this._pickedLaserColor),t._isActionableMesh=!0):(this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor),t._isActionableMesh=!1);try{this.onNewMeshSelected.notifyObservers(i.pickedMesh);var _=t;_.webVRController&&this.onMeshSelectedWithController.notifyObservers({mesh:i.pickedMesh,controller:_.webVRController})}catch(b){d.a.Warn("Error while raising onNewMeshSelected or onMeshSelectedWithController: "+b)}}else this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}else this._notifySelectedMeshUnselected(t._currentMeshSelected),t._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}},n.prototype._notifySelectedMeshUnselected=function(t){t&&this.onSelectedMeshUnselected.notifyObservers(t)},n.prototype.setLaserColor=function(t,e){e===void 0&&(e=this._pickedLaserColor),this._laserColor=t,this._pickedLaserColor=e},n.prototype.setLaserLightingState=function(t){t===void 0&&(t=!0),this._leftController&&this._leftController._setLaserPointerLightingDisabled(!t),this._rightController&&this._rightController._setLaserPointerLightingDisabled(!t)},n.prototype.setGazeColor=function(t,e){e===void 0&&(e=this._pickedGazeColor),this._gazeColor=t,this._pickedGazeColor=e},n.prototype.changeLaserColor=function(t){!this.updateControllerLaserColor||(this._leftController&&this._leftController._setLaserPointerColor(t),this._rightController&&this._rightController._setLaserPointerColor(t))},n.prototype.changeGazeColor=function(t){!this.updateGazeTrackerColor||!this._cameraGazer._gazeTracker.material||(this._cameraGazer._gazeTracker.material.emissiveColor=t,this._leftController&&(this._leftController._gazeTracker.material.emissiveColor=t),this._rightController&&(this._rightController._gazeTracker.material.emissiveColor=t))},n.prototype.dispose=function(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._webVRCamera&&this._webVRCamera.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._leftController&&this._leftController.dispose(),this._rightController&&this._rightController.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection=[],document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.onmsfullscreenchange=null,this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChanged),this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart),this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected),this._scene.unregisterBeforeRender(this.beforeRender)},n.prototype.getClassName=function(){return"VRExperienceHelper"},n.TELEPORTATIONMODE_CONSTANTTIME=0,n.TELEPORTATIONMODE_CONSTANTSPEED=1,n}(),ye=u(603),oe=function(n,t,e,i){return!(n.x>e.x+i||e.x-i>t.x||n.y>e.y+i||e.y-i>t.y||n.z>e.z+i||e.z-i>t.z)},_e=function(){var n={root:0,found:!1};return function(t,e,i,r){n.root=0,n.found=!1;var o=e*e-4*t*i;if(o<0)return n;var a=Math.sqrt(o),s=(-e-a)/(2*t),c=(-e+a)/(2*t);if(s>c){var _=c;c=s,s=_}return s>0&&s<r?(n.root=s,n.found=!0,n):(c>0&&c<r&&(n.root=c,n.found=!0),n)}}(),Ve=function(){function n(){this._collisionPoint=l.e.Zero(),this._planeIntersectionPoint=l.e.Zero(),this._tempVector=l.e.Zero(),this._tempVector2=l.e.Zero(),this._tempVector3=l.e.Zero(),this._tempVector4=l.e.Zero(),this._edge=l.e.Zero(),this._baseToVertex=l.e.Zero(),this._destinationPoint=l.e.Zero(),this._slidePlaneNormal=l.e.Zero(),this._displacementVector=l.e.Zero(),this._radius=l.e.One(),this._retry=0,this._basePointWorld=l.e.Zero(),this._velocityWorld=l.e.Zero(),this._normalizedVelocity=l.e.Zero(),this._collisionMask=-1}return Object.defineProperty(n.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(t){this._collisionMask=isNaN(t)?-1:t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"slidePlaneNormal",{get:function(){return this._slidePlaneNormal},enumerable:!1,configurable:!0}),n.prototype._initialize=function(t,e,i){this._velocity=e,this._velocitySquaredLength=this._velocity.lengthSquared();var r=Math.sqrt(this._velocitySquaredLength);r===0||r===1?this._normalizedVelocity.copyFromFloats(e._x,e._y,e._z):e.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=t,t.multiplyToRef(this._radius,this._basePointWorld),e.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1},n.prototype._checkPointInTriangle=function(t,e,i,r,o){e.subtractToRef(t,this._tempVector),i.subtractToRef(t,this._tempVector2),l.e.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var a=l.e.Dot(this._tempVector4,o);return a<0||(r.subtractToRef(t,this._tempVector3),l.e.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),a=l.e.Dot(this._tempVector4,o),a<0)?!1:(l.e.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),a=l.e.Dot(this._tempVector4,o),a>=0)},n.prototype._canDoCollision=function(t,e,i,r){var o=l.e.Distance(this._basePointWorld,t),a=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(o>this._velocityWorldLength+a+e||!oe(i,r,this._basePointWorld,this._velocityWorldLength+a))},n.prototype._testTriangle=function(t,e,i,r,o,a,s){var c,_=!1;e||(e=[]),e[t]||(e[t]=new ye.a(0,0,0,0),e[t].copyFromPoints(i,r,o));var b=e[t];if(!(!a&&!b.isFrontFacingTo(this._normalizedVelocity,0))){var C=b.signedDistanceTo(this._basePoint),x=l.e.Dot(b.normal,this._velocity);if(x==0){if(Math.abs(C)>=1)return;_=!0,c=0}else{c=(-1-C)/x;var V=(1-C)/x;if(c>V){var D=V;V=c,c=D}if(c>1||V<0)return;c<0&&(c=0),c>1&&(c=1)}this._collisionPoint.copyFromFloats(0,0,0);var z=!1,q=1;if(_||(this._basePoint.subtractToRef(b.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(c,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,o,b.normal)&&(z=!0,q=c,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!z){var ue=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);var ge=2*l.e.Dot(this._velocity,this._tempVector),Se=this._tempVector.lengthSquared()-1,Pe=_e(ue,ge,Se,q);Pe.found&&(q=Pe.root,z=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),ge=2*l.e.Dot(this._velocity,this._tempVector),Se=this._tempVector.lengthSquared()-1,Pe=_e(ue,ge,Se,q),Pe.found&&(q=Pe.root,z=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(o,this._tempVector),ge=2*l.e.Dot(this._velocity,this._tempVector),Se=this._tempVector.lengthSquared()-1,Pe=_e(ue,ge,Se,q),Pe.found&&(q=Pe.root,z=!0,this._collisionPoint.copyFrom(o)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);var me=this._edge.lengthSquared(),xe=l.e.Dot(this._edge,this._velocity),Fe=l.e.Dot(this._edge,this._baseToVertex);if(ue=me*-this._velocitySquaredLength+xe*xe,ge=2*(me*l.e.Dot(this._velocity,this._baseToVertex)-xe*Fe),Se=me*(1-this._baseToVertex.lengthSquared())+Fe*Fe,Pe=_e(ue,ge,Se,q),Pe.found){var we=(xe*Pe.root-Fe)/me;we>=0&&we<=1&&(q=Pe.root,z=!0,this._edge.scaleInPlace(we),i.addToRef(this._edge,this._collisionPoint))}o.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),me=this._edge.lengthSquared(),xe=l.e.Dot(this._edge,this._velocity),Fe=l.e.Dot(this._edge,this._baseToVertex),ue=me*-this._velocitySquaredLength+xe*xe,ge=2*(me*l.e.Dot(this._velocity,this._baseToVertex)-xe*Fe),Se=me*(1-this._baseToVertex.lengthSquared())+Fe*Fe,Pe=_e(ue,ge,Se,q),Pe.found&&(we=(xe*Pe.root-Fe)/me,we>=0&&we<=1&&(q=Pe.root,z=!0,this._edge.scaleInPlace(we),r.addToRef(this._edge,this._collisionPoint))),i.subtractToRef(o,this._edge),o.subtractToRef(this._basePoint,this._baseToVertex),me=this._edge.lengthSquared(),xe=l.e.Dot(this._edge,this._velocity),Fe=l.e.Dot(this._edge,this._baseToVertex),ue=me*-this._velocitySquaredLength+xe*xe,ge=2*(me*l.e.Dot(this._velocity,this._baseToVertex)-xe*Fe),Se=me*(1-this._baseToVertex.lengthSquared())+Fe*Fe,Pe=_e(ue,ge,Se,q),Pe.found&&(we=(xe*Pe.root-Fe)/me,we>=0&&we<=1&&(q=Pe.root,z=!0,this._edge.scaleInPlace(we),o.addToRef(this._edge,this._collisionPoint)))}if(z){var Ge=q*q*this._velocitySquaredLength;(!this.collisionFound||Ge<this._nearestDistanceSquared)&&(s.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=Ge,this._nearestDistance=Math.sqrt(Ge),this.collisionFound=!0),this.collidedMesh=s)}}},n.prototype._collide=function(t,e,i,r,o,a,s,c){if(!i||i.length===0)for(var _=0;_<e.length;_+=3){var b=e[_],C=e[_+1],x=e[_+2];this._testTriangle(_,t,x,C,b,s,c)}else for(var _=r;_<o;_+=3){var b=e[i[_]-a],C=e[i[_+1]-a],x=e[i[_+2]-a];this._testTriangle(_,t,x,C,b,s,c)}},n.prototype._getResponse=function(t,e){t.addToRef(e,this._destinationPoint),e.scaleInPlace(this._nearestDistance/e.length()),this._basePoint.addToRef(e,t),t.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),t.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(ye.a.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,e)},n}(),dt=function(){function n(){this._scaledPosition=l.e.Zero(),this._scaledVelocity=l.e.Zero(),this._finalPosition=l.e.Zero()}return n.prototype.getNewPosition=function(t,e,i,r,o,a,s){t.divideToRef(i._radius,this._scaledPosition),e.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,o),this._finalPosition.multiplyInPlace(i._radius),a(s,this._finalPosition,i.collidedMesh)},n.prototype.createCollider=function(){return new Ve},n.prototype.init=function(t){this._scene=t},n.prototype._collideWithWorld=function(t,e,i,r,o,a){a===void 0&&(a=null);var s=G.a.CollisionsEpsilon*10;if(i._retry>=r){o.copyFrom(t);return}var c=a?a.collisionMask:i.collisionMask;i._initialize(t,e,s);for(var _=a&&a.surroundingMeshes||this._scene.meshes,b=0;b<_.length;b++){var C=_[b];C.isEnabled()&&C.checkCollisions&&C.subMeshes&&C!==a&&(c&C.collisionGroup)!=0&&C._checkCollision(i)}if(!i.collisionFound){t.addToRef(e,o);return}if((e.x!==0||e.y!==0||e.z!==0)&&i._getResponse(t,e),e.length()<=s){o.copyFrom(t);return}i._retry++,this._collideWithWorld(t,e,i,r,o,a)},n}();ae.a.CollisionCoordinatorFactory=function(){return new dt};var vt=u(539),ut=u(667),Yt=u(718),pt=u(686),Ye=u(536),Pt=u(687),Ct=u(490),ri=function(){function n(t,e,i,r,o,a){this.entries=new Array,this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=o,this._creationFunc=a,this._minPoint=t,this._maxPoint=e,this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors[2].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[3].y=e.y,this._boundingVectors.push(t.clone()),this._boundingVectors[4].z=e.z,this._boundingVectors.push(e.clone()),this._boundingVectors[5].z=t.z,this._boundingVectors.push(e.clone()),this._boundingVectors[6].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[7].y=t.y}return Object.defineProperty(n.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:!1,configurable:!0}),n.prototype.addEntry=function(t){if(this.blocks){for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.addEntry(t)}return}this._creationFunc(t,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},n.prototype.removeEntry=function(t){if(this.blocks){for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.removeEntry(t)}return}var r=this.entries.indexOf(t);r>-1&&this.entries.splice(r,1)},n.prototype.addEntries=function(t){for(var e=0;e<t.length;e++){var i=t[e];this.addEntry(i)}},n.prototype.select=function(t,e,i){if(pt.a.IsInFrustum(this._boundingVectors,t)){if(this.blocks){for(var r=0;r<this.blocks.length;r++){var o=this.blocks[r];o.select(t,e,i)}return}i?e.concat(this.entries):e.concatWithNoDuplicate(this.entries)}},n.prototype.intersects=function(t,e,i,r){if(pt.a.IntersectsSphere(this._minPoint,this._maxPoint,t,e)){if(this.blocks){for(var o=0;o<this.blocks.length;o++){var a=this.blocks[o];a.intersects(t,e,i,r)}return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}},n.prototype.intersectsRay=function(t,e){if(t.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.intersectsRay(t,e)}return}e.concatWithNoDuplicate(this.entries)}},n.prototype.createInnerBlocks=function(){n._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},n._CreateBlocks=function(t,e,i,r,o,a,s,c){s.blocks=new Array;for(var _=new l.e((e.x-t.x)/2,(e.y-t.y)/2,(e.z-t.z)/2),b=0;b<2;b++)for(var C=0;C<2;C++)for(var x=0;x<2;x++){var V=t.add(_.multiplyByFloats(b,C,x)),D=t.add(_.multiplyByFloats(b+1,C+1,x+1)),z=new n(V,D,r,o+1,a,c);z.addEntries(i),s.blocks.push(z)}},n}(),_t=function(){function n(t,e,i){i===void 0&&(i=2),this.maxDepth=i,this.dynamicContent=new Array,this._maxBlockCapacity=e||64,this._selectionContent=new Ct.b(1024),this._creationFunc=t}return n.prototype.update=function(t,e,i){ri._CreateBlocks(t,e,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},n.prototype.addMesh=function(t){for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.addEntry(t)}},n.prototype.removeMesh=function(t){for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.removeEntry(t)}},n.prototype.select=function(t,e){this._selectionContent.reset();for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.select(t,this._selectionContent,e)}return e?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},n.prototype.intersects=function(t,e,i){this._selectionContent.reset();for(var r=0;r<this.blocks.length;r++){var o=this.blocks[r];o.intersects(t,e,this._selectionContent,i)}return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},n.prototype.intersectsRay=function(t){this._selectionContent.reset();for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.intersectsRay(t,this._selectionContent)}return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},n.CreationFuncForMeshes=function(t,e){var i=t.getBoundingInfo();!t.isBlocked&&i.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(t)},n.CreationFuncForSubMeshes=function(t,e){var i=t.getBoundingInfo();i.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(t)},n}();ae.a.prototype.createOrUpdateSelectionOctree=function(n,t){n===void 0&&(n=64),t===void 0&&(t=2);var e=this._getComponent(X.a.NAME_OCTREE);e||(e=new qt(this),this._addComponent(e)),this._selectionOctree||(this._selectionOctree=new _t(_t.CreationFuncForMeshes,n,t));var i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree},Object.defineProperty(ae.a.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Ae.a.prototype.createOrUpdateSubmeshesOctree=function(n,t){n===void 0&&(n=64),t===void 0&&(t=2);var e=this.getScene(),i=e._getComponent(X.a.NAME_OCTREE);i||(i=new qt(e),e._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new _t(_t.CreationFuncForSubMeshes,n,t)),this.computeWorldMatrix(!0);var r=this.getBoundingInfo(),o=r.boundingBox;return this._submeshesOctree.update(o.minimumWorld,o.maximumWorld,this.subMeshes),this._submeshesOctree};var qt=function(){function n(t){this.name=X.a.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new Jt.a(l.e.Zero(),new l.e(1,1,1)),this.scene=t,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this)}return n.prototype.register=function(){var t=this;this.scene.onMeshRemovedObservable.add(function(e){var i=t.scene.selectionOctree;if(i!=null){var r=i.dynamicContent.indexOf(e);r!==-1&&i.dynamicContent.splice(r,1)}}),this.scene.onMeshImportedObservable.add(function(e){var i=t.scene.selectionOctree;i!=null&&i.addMesh(e)})},n.prototype.getActiveMeshCandidates=function(){if(this.scene._selectionOctree){var t=this.scene._selectionOctree.select(this.scene.frustumPlanes);return t}return this.scene._getDefaultMeshCandidates()},n.prototype.getActiveSubMeshCandidates=function(t){if(t._submeshesOctree&&t.useOctreeForRenderingSelection){var e=t._submeshesOctree.select(this.scene.frustumPlanes);return e}return this.scene._getDefaultSubMeshCandidates(t)},n.prototype.getIntersectingSubMeshCandidates=function(t,e){if(t._submeshesOctree&&t.useOctreeForPicking){Jt.a.TransformToRef(e,t.getWorldMatrix(),this._tempRay);var i=t._submeshesOctree.intersectsRay(this._tempRay);return i}return this.scene._getDefaultSubMeshCandidates(t)},n.prototype.getCollidingSubMeshCandidates=function(t,e){if(t._submeshesOctree&&t.useOctreeForCollisions){var i=e._velocityWorldLength+Math.max(e._radius.x,e._radius.y,e._radius.z),r=t._submeshesOctree.intersects(e._basePointWorld,i);return r}return this.scene._getDefaultSubMeshCandidates(t)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n}(),mi=u(678),wr=u(689),Ri=u(673),Pn=function(){function n(t,e,i){i===void 0&&(i=0),this.deviceType=e,this.deviceSlot=i,this.onInputChangedObservable=new g.c,this._deviceInputSystem=t}return n.prototype.getInput=function(t){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,t)},n}(),mp=function(){function n(t){var e=this;this.onDeviceConnectedObservable=new g.c(function(r){e.getDevices().forEach(function(o){e.onDeviceConnectedObservable.notifyObserver(r,o)})}),this.onDeviceDisconnectedObservable=new g.c;var i=Object.keys(Ri.a).length/2;this._devices=new Array(i),this._firstDevice=new Array(i),this._deviceInputSystem=wr.a.Create(t),this._deviceInputSystem.onDeviceConnected=function(r,o){e._addDevice(r,o),e.onDeviceConnectedObservable.notifyObservers(e.getDeviceSource(r,o))},this._deviceInputSystem.onDeviceDisconnected=function(r,o){var a=e.getDeviceSource(r,o);e._removeDevice(r,o),e.onDeviceDisconnectedObservable.notifyObservers(a)},this._deviceInputSystem.onInputChanged||(this._deviceInputSystem.onInputChanged=function(r,o,a,s,c){var _;(_=e.getDeviceSource(r,o))===null||_===void 0||_.onInputChangedObservable.notifyObservers({inputIndex:a,previousState:s,currentState:c})})}return n.prototype.getDeviceSource=function(t,e){if(e===void 0){if(this._firstDevice[t]===void 0)return null;e=this._firstDevice[t]}return!this._devices[t]||this._devices[t][e]===void 0?null:this._devices[t][e]},n.prototype.getDeviceSources=function(t){return this._devices[t].filter(function(e){return!!e})},n.prototype.getDevices=function(){var t=new Array;return this._devices.forEach(function(e){t.push.apply(t,e)}),t},n.prototype.dispose=function(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._deviceInputSystem.dispose()},n.prototype._addDevice=function(t,e){this._devices[t]||(this._devices[t]=new Array),this._devices[t][e]||(this._devices[t][e]=new Pn(this._deviceInputSystem,t,e),this._updateFirstDevices(t))},n.prototype._removeDevice=function(t,e){delete this._devices[t][e],this._updateFirstDevices(t)},n.prototype._updateFirstDevices=function(t){switch(t){case Ri.a.Keyboard:case Ri.a.Mouse:this._firstDevice[t]=0;break;case Ri.a.Touch:case Ri.a.DualShock:case Ri.a.Xbox:case Ri.a.Switch:case Ri.a.Generic:var e=this._devices[t];delete this._firstDevice[t];for(var i=0;i<e.length;i++)if(e[i]){this._firstDevice[t]=i;break}break}},n}(),gp=function(){function n(){}return n.ALPHA_DISABLE=0,n.ALPHA_ADD=1,n.ALPHA_COMBINE=2,n.ALPHA_SUBTRACT=3,n.ALPHA_MULTIPLY=4,n.ALPHA_MAXIMIZED=5,n.ALPHA_ONEONE=6,n.ALPHA_PREMULTIPLIED=7,n.ALPHA_PREMULTIPLIED_PORTERDUFF=8,n.ALPHA_INTERPOLATE=9,n.ALPHA_SCREENMODE=10,n.ALPHA_ONEONE_ONEONE=11,n.ALPHA_ALPHATOCOLOR=12,n.ALPHA_REVERSEONEMINUS=13,n.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,n.ALPHA_ONEONE_ONEZERO=15,n.ALPHA_EXCLUSION=16,n.ALPHA_EQUATION_ADD=0,n.ALPHA_EQUATION_SUBSTRACT=1,n.ALPHA_EQUATION_REVERSE_SUBTRACT=2,n.ALPHA_EQUATION_MAX=3,n.ALPHA_EQUATION_MIN=4,n.ALPHA_EQUATION_DARKEN=5,n.DELAYLOADSTATE_NONE=0,n.DELAYLOADSTATE_LOADED=1,n.DELAYLOADSTATE_LOADING=2,n.DELAYLOADSTATE_NOTLOADED=4,n.NEVER=512,n.ALWAYS=519,n.LESS=513,n.EQUAL=514,n.LEQUAL=515,n.GREATER=516,n.GEQUAL=518,n.NOTEQUAL=517,n.KEEP=7680,n.ZERO=0,n.REPLACE=7681,n.INCR=7682,n.DECR=7683,n.INVERT=5386,n.INCR_WRAP=34055,n.DECR_WRAP=34056,n.TEXTURE_CLAMP_ADDRESSMODE=0,n.TEXTURE_WRAP_ADDRESSMODE=1,n.TEXTURE_MIRROR_ADDRESSMODE=2,n.TEXTUREFORMAT_ALPHA=0,n.TEXTUREFORMAT_LUMINANCE=1,n.TEXTUREFORMAT_LUMINANCE_ALPHA=2,n.TEXTUREFORMAT_RGB=4,n.TEXTUREFORMAT_RGBA=5,n.TEXTUREFORMAT_RED=6,n.TEXTUREFORMAT_R=6,n.TEXTUREFORMAT_RG=7,n.TEXTUREFORMAT_RED_INTEGER=8,n.TEXTUREFORMAT_R_INTEGER=8,n.TEXTUREFORMAT_RG_INTEGER=9,n.TEXTUREFORMAT_RGB_INTEGER=10,n.TEXTUREFORMAT_RGBA_INTEGER=11,n.TEXTUREFORMAT_BGRA=12,n.TEXTUREFORMAT_DEPTH24_STENCIL8=13,n.TEXTUREFORMAT_DEPTH32_FLOAT=14,n.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,n.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,n.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,n.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,n.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,n.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,n.TEXTURETYPE_UNSIGNED_BYTE=0,n.TEXTURETYPE_UNSIGNED_INT=0,n.TEXTURETYPE_FLOAT=1,n.TEXTURETYPE_HALF_FLOAT=2,n.TEXTURETYPE_BYTE=3,n.TEXTURETYPE_SHORT=4,n.TEXTURETYPE_UNSIGNED_SHORT=5,n.TEXTURETYPE_INT=6,n.TEXTURETYPE_UNSIGNED_INTEGER=7,n.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,n.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,n.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,n.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,n.TEXTURETYPE_UNSIGNED_INT_24_8=12,n.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,n.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,n.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,n.TEXTURE_NEAREST_SAMPLINGMODE=1,n.TEXTURE_NEAREST_NEAREST=1,n.TEXTURE_BILINEAR_SAMPLINGMODE=2,n.TEXTURE_LINEAR_LINEAR=2,n.TEXTURE_TRILINEAR_SAMPLINGMODE=3,n.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,n.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,n.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,n.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,n.TEXTURE_NEAREST_LINEAR=7,n.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,n.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,n.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,n.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,n.TEXTURE_LINEAR_NEAREST=12,n.TEXTURE_EXPLICIT_MODE=0,n.TEXTURE_SPHERICAL_MODE=1,n.TEXTURE_PLANAR_MODE=2,n.TEXTURE_CUBIC_MODE=3,n.TEXTURE_PROJECTION_MODE=4,n.TEXTURE_SKYBOX_MODE=5,n.TEXTURE_INVCUBIC_MODE=6,n.TEXTURE_EQUIRECTANGULAR_MODE=7,n.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,n.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,n.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,n.TEXTURE_FILTERING_QUALITY_HIGH=64,n.TEXTURE_FILTERING_QUALITY_MEDIUM=16,n.TEXTURE_FILTERING_QUALITY_LOW=8,n.SCALEMODE_FLOOR=1,n.SCALEMODE_NEAREST=2,n.SCALEMODE_CEILING=3,n.MATERIAL_TextureDirtyFlag=1,n.MATERIAL_LightDirtyFlag=2,n.MATERIAL_FresnelDirtyFlag=4,n.MATERIAL_AttributesDirtyFlag=8,n.MATERIAL_MiscDirtyFlag=16,n.MATERIAL_PrePassDirtyFlag=32,n.MATERIAL_AllDirtyFlag=63,n.MATERIAL_TriangleFillMode=0,n.MATERIAL_WireFrameFillMode=1,n.MATERIAL_PointFillMode=2,n.MATERIAL_PointListDrawMode=3,n.MATERIAL_LineListDrawMode=4,n.MATERIAL_LineLoopDrawMode=5,n.MATERIAL_LineStripDrawMode=6,n.MATERIAL_TriangleStripDrawMode=7,n.MATERIAL_TriangleFanDrawMode=8,n.MATERIAL_ClockWiseSideOrientation=0,n.MATERIAL_CounterClockWiseSideOrientation=1,n.ACTION_NothingTrigger=0,n.ACTION_OnPickTrigger=1,n.ACTION_OnLeftPickTrigger=2,n.ACTION_OnRightPickTrigger=3,n.ACTION_OnCenterPickTrigger=4,n.ACTION_OnPickDownTrigger=5,n.ACTION_OnDoublePickTrigger=6,n.ACTION_OnPickUpTrigger=7,n.ACTION_OnPickOutTrigger=16,n.ACTION_OnLongPressTrigger=8,n.ACTION_OnPointerOverTrigger=9,n.ACTION_OnPointerOutTrigger=10,n.ACTION_OnEveryFrameTrigger=11,n.ACTION_OnIntersectionEnterTrigger=12,n.ACTION_OnIntersectionExitTrigger=13,n.ACTION_OnKeyDownTrigger=14,n.ACTION_OnKeyUpTrigger=15,n.PARTICLES_BILLBOARDMODE_Y=2,n.PARTICLES_BILLBOARDMODE_ALL=7,n.PARTICLES_BILLBOARDMODE_STRETCHED=8,n.MESHES_CULLINGSTRATEGY_STANDARD=0,n.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,n.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,n.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,n.SCENELOADER_NO_LOGGING=0,n.SCENELOADER_MINIMAL_LOGGING=1,n.SCENELOADER_SUMMARY_LOGGING=2,n.SCENELOADER_DETAILED_LOGGING=3,n.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,n.PREPASS_POSITION_TEXTURE_TYPE=1,n.PREPASS_VELOCITY_TEXTURE_TYPE=2,n.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,n.PREPASS_COLOR_TEXTURE_TYPE=4,n.PREPASS_DEPTH_TEXTURE_TYPE=5,n.PREPASS_NORMAL_TEXTURE_TYPE=6,n.PREPASS_ALBEDO_TEXTURE_TYPE=7,n.CUSTOMEFFECT_PREFIX_SHADOWGENERATOR="bjs_shadowgenerator_",n.INPUT_ALT_KEY=18,n.INPUT_CTRL_KEY=17,n.INPUT_META_KEY1=91,n.INPUT_META_KEY2=92,n.INPUT_META_KEY3=93,n.INPUT_SHIFT_KEY=16,n}(),fn=u(467),Qa=u(645),$v=u(621),Fl=function(){function n(){this._timeElapsedQueryEnded=!1}return n}(),Bl=function(){function n(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=Ae.a.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=Ae.a.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE}return n}();G.a.prototype.createQuery=function(){return this._gl.createQuery()},G.a.prototype.deleteQuery=function(n){return this._gl.deleteQuery(n),this},G.a.prototype.isQueryResultAvailable=function(n){return this._gl.getQueryParameter(n,this._gl.QUERY_RESULT_AVAILABLE)},G.a.prototype.getQueryResult=function(n){return this._gl.getQueryParameter(n,this._gl.QUERY_RESULT)},G.a.prototype.beginOcclusionQuery=function(n,t){var e=this._getGlAlgorithmType(n);return this._gl.beginQuery(e,t),this},G.a.prototype.endOcclusionQuery=function(n){var t=this._getGlAlgorithmType(n);return this._gl.endQuery(t),this},G.a.prototype._createTimeQuery=function(){var n=this.getCaps().timerQuery;return n.createQueryEXT?n.createQueryEXT():this.createQuery()},G.a.prototype._deleteTimeQuery=function(n){var t=this.getCaps().timerQuery;if(t.deleteQueryEXT){t.deleteQueryEXT(n);return}this.deleteQuery(n)},G.a.prototype._getTimeQueryResult=function(n){var t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(n,t.QUERY_RESULT_EXT):this.getQueryResult(n)},G.a.prototype._getTimeQueryAvailability=function(n){var t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(n,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(n)},G.a.prototype.startTimeQuery=function(){var n=this.getCaps(),t=n.timerQuery;if(!t)return null;var e=new Fl;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),n.canUseTimestampForTimerQuery)e._startTimeQuery=this._createTimeQuery(),t.queryCounterEXT(e._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;e._timeElapsedQuery=this._createTimeQuery(),t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,e._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,e._timeElapsedQuery),this._currentNonTimestampToken=e}return e},G.a.prototype.endTimeQuery=function(n){var t=this.getCaps(),e=t.timerQuery;if(!e||!n)return-1;if(t.canUseTimestampForTimerQuery){if(!n._startTimeQuery)return-1;n._endTimeQuery||(n._endTimeQuery=this._createTimeQuery(),e.queryCounterEXT(n._endTimeQuery,e.TIMESTAMP_EXT))}else if(!n._timeElapsedQueryEnded){if(!n._timeElapsedQuery)return-1;e.endQueryEXT?e.endQueryEXT(e.TIME_ELAPSED_EXT):this._gl.endQuery(e.TIME_ELAPSED_EXT),n._timeElapsedQueryEnded=!0}var i=this._gl.getParameter(e.GPU_DISJOINT_EXT),r=!1;if(n._endTimeQuery?r=this._getTimeQueryAvailability(n._endTimeQuery):n._timeElapsedQuery&&(r=this._getTimeQueryAvailability(n._timeElapsedQuery)),r&&!i){var o=0;if(t.canUseTimestampForTimerQuery){if(!n._startTimeQuery||!n._endTimeQuery)return-1;var a=this._getTimeQueryResult(n._startTimeQuery),s=this._getTimeQueryResult(n._endTimeQuery);o=s-a,this._deleteTimeQuery(n._startTimeQuery),this._deleteTimeQuery(n._endTimeQuery),n._startTimeQuery=null,n._endTimeQuery=null}else{if(!n._timeElapsedQuery)return-1;o=this._getTimeQueryResult(n._timeElapsedQuery),this._deleteTimeQuery(n._timeElapsedQuery),n._timeElapsedQuery=null,n._timeElapsedQueryEnded=!1,this._currentNonTimestampToken=null}return o}return-1},G.a.prototype._getGlAlgorithmType=function(n){return n===Ae.a.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},Object.defineProperty(Ae.a.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(n){this._occlusionDataStorage.isOcclusionQueryInProgress=n},enumerable:!1,configurable:!0}),Object.defineProperty(Ae.a.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new Bl),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(Ae.a.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(n){this._occlusionDataStorage.isOccluded=n},enumerable:!0,configurable:!0}),Object.defineProperty(Ae.a.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(n){this._occlusionDataStorage.occlusionQueryAlgorithmType=n},enumerable:!0,configurable:!0}),Object.defineProperty(Ae.a.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(n){this._occlusionDataStorage.occlusionType=n},enumerable:!0,configurable:!0}),Object.defineProperty(Ae.a.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(n){this._occlusionDataStorage.occlusionRetryCount=n},enumerable:!0,configurable:!0}),Ae.a.prototype._checkOcclusionQuery=function(){var n=this._occlusionDataStorage;if(n.occlusionType===Ae.a.OCCLUSION_TYPE_NONE)return n.isOccluded=!1,!1;var t=this.getEngine();if(t.webGLVersion<2||!t.isQueryResultAvailable)return n.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery){var e=t.isQueryResultAvailable(this._occlusionQuery);if(e){var i=t.getQueryResult(this._occlusionQuery);n.isOcclusionQueryInProgress=!1,n.occlusionInternalRetryCounter=0,n.isOccluded=i!==1}else if(n.occlusionInternalRetryCounter++,n.occlusionRetryCount!==-1&&n.occlusionInternalRetryCounter>n.occlusionRetryCount)n.isOcclusionQueryInProgress=!1,n.occlusionInternalRetryCounter=0,n.isOccluded=n.occlusionType===Ae.a.OCCLUSION_TYPE_OPTIMISTIC?!1:n.isOccluded;else return!1}var r=this.getScene();if(r.getBoundingBoxRenderer){var o=r.getBoundingBoxRenderer();this._occlusionQuery||(this._occlusionQuery=t.createQuery()),t.beginOcclusionQuery(n.occlusionQueryAlgorithmType,this._occlusionQuery),o.renderOcclusionBoundingBox(this),t.endOcclusionQuery(n.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0}return n.isOccluded};var vp=!0;G.a.prototype.createTransformFeedback=function(){return this._gl.createTransformFeedback()},G.a.prototype.deleteTransformFeedback=function(n){this._gl.deleteTransformFeedback(n)},G.a.prototype.bindTransformFeedback=function(n){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,n)},G.a.prototype.beginTransformFeedback=function(n){n===void 0&&(n=!0),this._gl.beginTransformFeedback(n?this._gl.POINTS:this._gl.TRIANGLES)},G.a.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},G.a.prototype.setTranformFeedbackVaryings=function(n,t){this._gl.transformFeedbackVaryings(n,t,this._gl.INTERLEAVED_ATTRIBS)},G.a.prototype.bindTransformFeedbackBuffer=function(n){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,n?n.underlyingResource:null)};var qv=u(492),e_=u(532),Nl=u(596);fn.a.prototype.updateVideoTexture=function(n,t,e){if(!(!n||n._isDisabled)){var i=this._bindTextureDirectly(this._gl.TEXTURE_2D,n,!0);this._unpackFlipY(!e);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t);else{if(!n._workingCanvas){n._workingCanvas=Nl.a.CreateCanvas(n.width,n.height);var r=n._workingCanvas.getContext("2d");if(!r)throw new Error("Unable to get 2d context");n._workingContext=r,n._workingCanvas.width=n.width,n._workingCanvas.height=n.height}n._workingContext.clearRect(0,0,n.width,n.height),n._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,n.width,n.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n._workingCanvas)}n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),i||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),n.isReady=!0}catch(o){n._isDisabled=!0}}};var t_=u(574),i_=u(565),r_=u(500),n_=u(522),o_=u(717),a_=u(622),_p=function(){function n(){}return n}();G.a.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},G.a.prototype.registerView=function(n,t){var e=this;this.views||(this.views=[]);for(var i=0,r=this.views;i<r.length;i++){var o=r[i];if(o.target===n)return o}var a=this.getRenderingCanvas();a&&(n.width=a.width,n.height=a.height);var s={target:n,camera:t};return this.views.push(s),t&&t.onDisposeObservable.add(function(){e.unRegisterView(n)}),s},G.a.prototype.unRegisterView=function(n){if(!this.views)return this;for(var t=0,e=this.views;t<e.length;t++){var i=e[t];if(i.target===n){var r=this.views.indexOf(i);r!==-1&&this.views.splice(r,1);break}}return this},G.a.prototype._renderViews=function(){if(!this.views)return!1;var n=this.getRenderingCanvas();if(!n)return!1;for(var t=0,e=this.views;t<e.length;t++){var i=e[t],r=i.target,o=r.getContext("2d");if(!!o){var a=i.camera,s=null,c=null;if(a){if(c=a.getScene(),c.activeCameras&&c.activeCameras.length)continue;this.activeView=i,s=c.activeCamera,c.activeCamera=a}var _=r.clientWidth!==r.width||n.width!==r.width||r.clientHeight!==r.height||n.height!==r.height;if(r.clientWidth&&r.clientHeight&&_&&(r.width=r.clientWidth,r.height=r.clientHeight,n.width=r.clientWidth,n.height=r.clientHeight,this.resize(!0)),!n.width||!n.height)return!1;this._renderFrame(),o.drawImage(n,0,0),s&&c&&(c.activeCamera=s)}}return this.activeView=null,!0};var s_=u(685);function yp(n){var t=function(o){var a="\\b"+o+"\\b";return n&&(n===o||n.match(new RegExp(a,"g")))};if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(t))return n;var e=n.lastIndexOf("."),i=n.lastIndexOf("?"),r=i>-1?n.substring(i,n.length):"";return(e>-1?n.substring(0,e):n)+this._textureFormatInUse+r}Object.defineProperty(G.a.prototype,"texturesSupported",{get:function(){var n=new Array;return this._caps.astc&&n.push("-astc.ktx"),this._caps.s3tc&&n.push("-dxt.ktx"),this._caps.pvrtc&&n.push("-pvrtc.ktx"),this._caps.etc2&&n.push("-etc2.ktx"),this._caps.etc1&&n.push("-etc1.ktx"),n},enumerable:!0,configurable:!0}),Object.defineProperty(G.a.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),G.a.prototype.setCompressedTextureExclusions=function(n){this._excludedCompressedTextures=n},G.a.prototype.setTextureFormatToUse=function(n){for(var t=this.texturesSupported,e=0,i=t.length;e<i;e++)for(var r=0,o=n.length;r<o;r++)if(t[e]===n[r].toLowerCase())return this._transformTextureUrl=yp.bind(this),this._textureFormatInUse=t[e];return this._textureFormatInUse="",this._transformTextureUrl=null,null};var bp=u(714),Za;(function(n){n.LowPower="low-power",n.HighPerformance="high-performance"})(Za||(Za={}));var io;(function(n){n.DepthClamping="depth-clamping",n.Depth24UnormStencil8="depth24unorm-stencil8",n.Depth32FloatStencil8="depth32float-stencil8",n.PipelineStatisticsQuery="pipeline-statistics-query",n.TextureCompressionBC="texture-compression-bc",n.TimestampQuery="timestamp-query"})(io||(io={}));var Fi;(function(n){n[n.MapRead=1]="MapRead",n[n.MapWrite=2]="MapWrite",n[n.CopySrc=4]="CopySrc",n[n.CopyDst=8]="CopyDst",n[n.Index=16]="Index",n[n.Vertex=32]="Vertex",n[n.Uniform=64]="Uniform",n[n.Storage=128]="Storage",n[n.Indirect=256]="Indirect",n[n.QueryResolve=512]="QueryResolve"})(Fi||(Fi={}));var Vo;(function(n){n[n.Read=1]="Read",n[n.Write=2]="Write"})(Vo||(Vo={}));var Vr;(function(n){n.E1d="1d",n.E2d="2d",n.E3d="3d"})(Vr||(Vr={}));var ei;(function(n){n[n.CopySrc=1]="CopySrc",n[n.CopyDst=2]="CopyDst",n[n.Sampled=4]="Sampled",n[n.Storage=8]="Storage",n[n.OutputAttachment=16]="OutputAttachment"})(ei||(ei={}));var Oi;(function(n){n.E1d="1d",n.E2d="2d",n.E2dArray="2d-array",n.Cube="cube",n.CubeArray="cube-array",n.E3d="3d"})(Oi||(Oi={}));var qr;(function(n){n.All="all",n.StencilOnly="stencil-only",n.DepthOnly="depth-only"})(qr||(qr={}));var De;(function(n){n.R8Unorm="r8unorm",n.R8Snorm="r8snorm",n.R8Uint="r8uint",n.R8Sint="r8sint",n.R16Uint="r16uint",n.R16Sint="r16sint",n.R16Float="r16float",n.RG8Unorm="rg8unorm",n.RG8Snorm="rg8snorm",n.RG8Uint="rg8uint",n.RG8Sint="rg8sint",n.R32Uint="r32uint",n.R32Sint="r32sint",n.R32Float="r32float",n.RG16Uint="rg16uint",n.RG16Sint="rg16sint",n.RG16Float="rg16float",n.RGBA8Unorm="rgba8unorm",n.RGBA8UnormSRGB="rgba8unorm-srgb",n.RGBA8Snorm="rgba8snorm",n.RGBA8Uint="rgba8uint",n.RGBA8Sint="rgba8sint",n.BGRA8Unorm="bgra8unorm",n.BGRA8UnormSRGB="bgra8unorm-srgb",n.RGB9E5UFloat="rgb9e5ufloat",n.RGB10A2Unorm="rgb10a2unorm",n.RG11B10UFloat="rg11b10ufloat",n.RG32Uint="rg32uint",n.RG32Sint="rg32sint",n.RG32Float="rg32float",n.RGBA16Uint="rgba16uint",n.RGBA16Sint="rgba16sint",n.RGBA16Float="rgba16float",n.RGBA32Uint="rgba32uint",n.RGBA32Sint="rgba32sint",n.RGBA32Float="rgba32float",n.Stencil8="stencil8",n.Depth16Unorm="depth16unorm",n.Depth24Plus="depth24plus",n.Depth24PlusStencil8="depth24plus-stencil8",n.Depth32Float="depth32float",n.BC1RGBAUNorm="bc1-rgba-unorm",n.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",n.BC2RGBAUnorm="bc2-rgba-unorm",n.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",n.BC3RGBAUnorm="bc3-rgba-unorm",n.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",n.BC4RUnorm="bc4-r-unorm",n.BC4RSnorm="bc4-r-snorm",n.BC5RGUnorm="bc5-rg-unorm",n.BC5RGSnorm="bc5-rg-snorm",n.BC6HRGBUFloat="bc6h-rgb-ufloat",n.BC6HRGBFloat="bc6h-rgb-float",n.BC7RGBAUnorm="bc7-rgba-unorm",n.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",n.Depth24UnormStencil8="depth24unorm-stencil8",n.Depth32FloatStencil8="depth32float-stencil8"})(De||(De={}));var hn;(function(n){n.ClampToEdge="clamp-to-edge",n.Repeat="repeat",n.MirrorRepeat="mirror-repeat"})(hn||(hn={}));var yt;(function(n){n.Nearest="nearest",n.Linear="linear"})(yt||(yt={}));var ti;(function(n){n.Never="never",n.Less="less",n.Equal="equal",n.LessEqual="less-equal",n.Greater="greater",n.NotEqual="not-equal",n.GreaterEqual="greater-equal",n.Always="always"})(ti||(ti={}));var ro;(function(n){n[n.Vertex=1]="Vertex",n[n.Fragment=2]="Fragment",n[n.Compute=4]="Compute"})(ro||(ro={}));var Uo;(function(n){n.Uniform="uniform",n.Storage="storage",n.ReadOnlyStorage="read-only-storage"})(Uo||(Uo={}));var no;(function(n){n.Filtering="filtering",n.NonFiltering="non-filtering",n.Comparison="comparison"})(no||(no={}));var dn;(function(n){n.Float="float",n.UnfilterableFloat="unfilterable-float",n.Depth="depth",n.Sint="sint",n.Uint="uint"})(dn||(dn={}));var Ja;(function(n){n.ReadOnly="read-only",n.WriteOnly="write-only"})(Ja||(Ja={}));var $a;(function(n){n.Error="error",n.Warning="warning",n.Info="info"})($a||($a={}));var ki;(function(n){n.PointList="point-list",n.LineList="line-list",n.LineStrip="line-strip",n.TriangleList="triangle-list",n.TriangleStrip="triangle-strip"})(ki||(ki={}));var oo;(function(n){n.CCW="ccw",n.CW="cw"})(oo||(oo={}));var Cn;(function(n){n.None="none",n.Front="front",n.Back="back"})(Cn||(Cn={}));var Go;(function(n){n[n.Red=1]="Red",n[n.Green=2]="Green",n[n.Blue=4]="Blue",n[n.Alpha=8]="Alpha",n[n.All=15]="All"})(Go||(Go={}));var Si;(function(n){n.Zero="zero",n.One="one",n.SrcColor="src-color",n.OneMinusSrcColor="one-minus-src-color",n.SrcAlpha="src-alpha",n.OneMinusSrcAlpha="one-minus-src-alpha",n.DstColor="dst-color",n.OneMinusDstColor="one-minus-dst-color",n.DstAlpha="dst-alpha",n.OneMinusDstAlpha="one-minus-dst-alpha",n.SrcAlphaSaturated="src-alpha-saturated",n.BlendColor="blend-color",n.OneMinusBlendColor="one-minus-blend-color"})(Si||(Si={}));var Ur;(function(n){n.Add="add",n.Subtract="subtract",n.ReverseSubtract="reverse-subtract",n.Min="min",n.Max="max"})(Ur||(Ur={}));var ir;(function(n){n.Keep="keep",n.Zero="zero",n.Replace="replace",n.Invert="invert",n.IncrementClamp="increment-clamp",n.DecrementClamp="decrement-clamp",n.IncrementWrap="increment-wrap",n.DecrementWrap="decrement-wrap"})(ir||(ir={}));var Gr;(function(n){n.Uint16="uint16",n.Uint32="uint32"})(Gr||(Gr={}));var jt;(function(n){n.Uchar2="uchar2",n.Uchar4="uchar4",n.Char2="char2",n.Char4="char4",n.Uchar2Norm="uchar2norm",n.Uchar4Norm="uchar4norm",n.Char2Norm="char2norm",n.Char4Norm="char4norm",n.Ushort2="ushort2",n.Ushort4="ushort4",n.Short2="short2",n.Short4="short4",n.Ushort2Norm="ushort2norm",n.Ushort4Norm="ushort4norm",n.Short2Norm="short2norm",n.Short4Norm="short4norm",n.Half2="half2",n.Half4="half4",n.Float="float",n.Float2="float2",n.Float3="float3",n.Float4="float4",n.Uint="uint",n.Uint2="uint2",n.Uint3="uint3",n.Uint4="uint4",n.Int="int",n.Int2="int2",n.Int3="int3",n.Int4="int4"})(jt||(jt={}));var ao;(function(n){n.Vertex="vertex",n.Instance="instance"})(ao||(ao={}));var Gi;(function(n){n.Load="load"})(Gi||(Gi={}));var Sr;(function(n){n.Store="store",n.Clear="clear"})(Sr||(Sr={}));var qa;(function(n){n.Occlusion="occlusion",n.PipelineStatistics="pipeline-statistics",n.Timestamp="timestamp"})(qa||(qa={}));var es;(function(n){n.VertexShaderInvocations="vertex-shader-invocations",n.ClipperInvocations="clipper-invocations",n.ClipperPrimitivesOut="clipper-primitives-out",n.FragmentShaderInvocations="fragment-shader-invocations",n.ComputeShaderInvocations="compute-shader-invocations"})(es||(es={}));var ts;(function(n){n.Destroyed="destroyed"})(ts||(ts={}));var is;(function(n){n.OutOfMemory="out-of-memory",n.Validation="validation"})(is||(is={}));var tt=u(475),wl=u(595),Be=u(447),Ep={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16},Vl=function(){function n(){this.values={}}return n}(),Pp=function(){function n(t,e){this.samplers={},this.textures={},this._name="unnamed",this.shaderProcessingContext=t,this.leftOverUniformsByName={},this.engine=e,this.bindGroupsCache=new Vl}return Object.defineProperty(n.prototype,"isAsync",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isReady",{get:function(){return!!this.stages},enumerable:!1,configurable:!0}),n.prototype._handlesSpectorRebuildCallback=function(t){},n.prototype._fillEffectInformation=function(t,e,i,r,o,a,s,c){var _=this.engine,b=_.getUniforms(this,i);b.forEach(function(me,xe){r[i[xe]]=me}),t._fragmentSourceCode="",t._vertexSourceCode="";var C=this.shaderProcessingContext.availableSamplers,x;for(x=0;x<o.length;x++){var V=o[x],D=C[o[x]];D==null||D==null?(o.splice(x,1),x--):a[V]=x}for(var z=0,q=_.getAttributes(this,s);z<q.length;z++){var ue=q[z];c.push(ue)}this.buildUniformLayout();var ge=[],Se=[];for(x=0;x<s.length;x++){var Pe=c[x];Pe>=0&&(ge.push(s[x]),Se.push(Pe))}this.shaderProcessingContext.attributeNamesFromEffect=ge,this.shaderProcessingContext.attributeLocationsFromEffect=Se},n.prototype.buildUniformLayout=function(){if(!!this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new Fr.a(this.engine,void 0,void 0,"leftOver-"+this._name);for(var t=0,e=this.shaderProcessingContext.leftOverUniforms;t<e.length;t++){var i=e[t],r=Ep[i.type];this.uniformBuffer.addUniform(i.name,r,i.length),this.leftOverUniformsByName[i.name]=i.type}this.uniformBuffer.create()}},n.prototype.dispose=function(){this.uniformBuffer&&this.uniformBuffer.dispose()},n.prototype.setInt=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateInt(t,e)},n.prototype.setInt2=function(t,e,i){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateInt2(t,e,i)},n.prototype.setInt3=function(t,e,i,r){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateInt3(t,e,i,r)},n.prototype.setInt4=function(t,e,i,r,o){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateInt4(t,e,i,r,o)},n.prototype.setIntArray=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateIntArray(t,e)},n.prototype.setIntArray2=function(t,e){this.setIntArray(t,e)},n.prototype.setIntArray3=function(t,e){this.setIntArray(t,e)},n.prototype.setIntArray4=function(t,e){this.setIntArray(t,e)},n.prototype.setArray=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateArray(t,e)},n.prototype.setArray2=function(t,e){this.setArray(t,e)},n.prototype.setArray3=function(t,e){this.setArray(t,e)},n.prototype.setArray4=function(t,e){this.setArray(t,e)},n.prototype.setMatrices=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateMatrices(t,e)},n.prototype.setMatrix=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateMatrix(t,e)},n.prototype.setMatrix3x3=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateMatrix3x3(t,e)},n.prototype.setMatrix2x2=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateMatrix2x2(t,e)},n.prototype.setFloat=function(t,e){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateFloat(t,e)},n.prototype.setVector2=function(t,e){this.setFloat2(t,e.x,e.y)},n.prototype.setFloat2=function(t,e,i){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateFloat2(t,e,i)},n.prototype.setVector3=function(t,e){this.setFloat3(t,e.x,e.y,e.z)},n.prototype.setFloat3=function(t,e,i,r){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateFloat3(t,e,i,r)},n.prototype.setVector4=function(t,e){this.setFloat4(t,e.x,e.y,e.z,e.w)},n.prototype.setFloat4=function(t,e,i,r,o){!this.uniformBuffer||!this.leftOverUniformsByName[t]||this.uniformBuffer.updateFloat4(t,e,i,r,o)},n.prototype.setColor3=function(t,e){this.setFloat3(t,e.r,e.g,e.b)},n.prototype.setColor4=function(t,e,i){this.setFloat4(t,e.r,e.g,e.b,i)},n.prototype.setDirectColor4=function(t,e){this.setFloat4(t,e.r,e.g,e.b,e.a)},n.prototype._getVertexShaderCode=function(){var t;return(t=this.sources)===null||t===void 0?void 0:t.vertex},n.prototype._getFragmentShaderCode=function(){var t;return(t=this.sources)===null||t===void 0?void 0:t.fragment},n}(),zo=u(554),Cp=!1,Sp={Scene:{setIndex:0,bindingIndex:0},Light0:{setIndex:0,bindingIndex:5},Light1:{setIndex:0,bindingIndex:6},Light2:{setIndex:0,bindingIndex:7},Light3:{setIndex:0,bindingIndex:8},Light4:{setIndex:0,bindingIndex:9},Light5:{setIndex:0,bindingIndex:10},Light6:{setIndex:0,bindingIndex:11},Light7:{setIndex:0,bindingIndex:12},Light8:{setIndex:0,bindingIndex:13},Material:{setIndex:1,bindingIndex:0},Mesh:{setIndex:1,bindingIndex:1}},Tp={environmentBrdfSampler:{sampler:{setIndex:0,bindingIndex:1},isTextureArray:!1,textures:[{setIndex:0,bindingIndex:2}]}},Ap={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube"},Rp={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray"},Op={textureCube:Oi.Cube,textureCubeArray:Oi.CubeArray,texture2D:Oi.E2d,texture2DArray:Oi.E2dArray},Mp={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},xp={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1},Dp=function(){function n(){this._missingVaryings=[],this._textureArrayProcessing=[]}return n.prototype._getArraySize=function(t,e){var i=0,r=t.indexOf("["),o=t.indexOf("]");if(r>0&&o>0){var a=t.substring(r+1,o);i=+a,isNaN(i)&&(i=+e[a.trim()]),t=t.substr(0,r)}return[t,i]},n.prototype.initializeShaders=function(t){this._missingVaryings.length=0,this._textureArrayProcessing.length=0},n.prototype.varyingProcessor=function(t,e,i,r){this._preProcessors=i;var o=r,a=new RegExp(/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm),s=a.exec(t);if(s!=null){var c=s[1],_=s[2],b;e?(b=o.availableVaryings[_],this._missingVaryings[b]="",b===void 0&&d.a.Warn('Invalid fragment shader: The varying named "'+_+'" is not declared in the vertex shader! This declaration will be ignored.')):(b=o.getVaryingNextLocation(c,this._getArraySize(_,i)[1]),o.availableVaryings[_]=b,this._missingVaryings[b]="layout(location = "+b+") in "+c+" "+_+";"),t=t.replace(s[0],b===void 0?"":"layout(location = "+b+") "+(e?"in":"out")+" "+c+" "+_+";")}return t},n.prototype.attributeProcessor=function(t,e,i){this._preProcessors=e;var r=i,o=new RegExp(/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm),a=o.exec(t);if(a!=null){var s=a[1],c=a[2],_=r.getAttributeNextLocation(s,this._getArraySize(c,e)[1]);r.availableAttributes[c]=_,r.orderedAttributes[_]=c,t=t.replace(a[0],"layout(location = "+_+") in "+s+" "+c+";")}return t},n.prototype.uniformProcessor=function(t,e,i,r){var o,a,s;this._preProcessors=i;var c=r,_=new RegExp(/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm),b=_.exec(t);if(b!=null){var C=b[1],x=b[2];if(C.indexOf("sampler")===0||C.indexOf("sampler")===1){var V=Tp[x],D=0;if(!V)if(o=this._getArraySize(x,i),x=o[0],D=o[1],V=c.availableSamplers[x],V)D=V.isTextureArray?V.textures.length:0;else{V={sampler:c.getNextFreeUBOBinding(),isTextureArray:D>0,textures:[]};for(var z=0;z<(D||1);++z)V.textures.push(c.getNextFreeUBOBinding())}var q=C.charAt(0)==="u"?"u":C.charAt(0)==="i"?"i":"";q&&(C=C.substr(1));var ue=D>0,ge=V.sampler.setIndex,Se=V.sampler.bindingIndex,Pe=Ap[C],me=(s=Mp[C])!==null&&s!==void 0?s:"sampler",xe=Rp[C],Fe=Op[xe],we=!!xp[me];if(!ue)D=1,t="layout(set = "+ge+", binding = "+Se+") uniform "+q+me+" "+x+`Sampler;
                        layout(set = `+V.textures[0].setIndex+", binding = "+V.textures[0].bindingIndex+") uniform "+xe+" "+x+`Texture;
                        #define `+x+" "+q+Pe+"("+x+"Texture, "+x+"Sampler)";else{var Ge=[];Ge.push("layout(set = "+ge+", binding = "+Se+") uniform "+q+me+" "+x+"Sampler;"),t=`\r
`;for(var z=0;z<D;++z){var Xe=V.textures[z].setIndex,Oe=V.textures[z].bindingIndex;Ge.push("layout(set = "+Xe+", binding = "+Oe+") uniform "+xe+" "+x+"Texture"+z+";"),t+=(z>0?`\r
`:"")+"#define "+x+z+" "+q+Pe+"("+x+"Texture"+z+", "+x+"Sampler)"}t=Ge.join(`\r
`)+t,this._textureArrayProcessing.push(x)}c.availableSamplers[x]=V,c.orderedUBOsAndSamplers[ge]||(c.orderedUBOsAndSamplers[ge]=[]),c.orderedUBOsAndSamplers[ge][Se]||(c.orderedUBOsAndSamplers[ge][Se]={isSampler:!0,isTexture:!1,isComparisonSampler:we,usedInVertex:!1,usedInFragment:!1,name:x}),e?c.orderedUBOsAndSamplers[ge][Se].usedInFragment=!0:c.orderedUBOsAndSamplers[ge][Se].usedInVertex=!0;for(var z=0;z<D;++z){var Xe=V.textures[z].setIndex,Oe=V.textures[z].bindingIndex;c.orderedUBOsAndSamplers[Xe]||(c.orderedUBOsAndSamplers[Xe]=[]),c.orderedUBOsAndSamplers[Xe][Oe]||(c.orderedUBOsAndSamplers[Xe][Oe]={isSampler:!1,isTexture:!0,sampleType:we?dn.Depth:q==="u"?dn.Uint:q==="i"?dn.Sint:dn.Float,textureDimension:Fe,usedInVertex:!1,usedInFragment:!1,name:ue?x+z.toString():x}),e?c.orderedUBOsAndSamplers[Xe][Oe].usedInFragment=!0:c.orderedUBOsAndSamplers[Xe][Oe].usedInVertex=!0}}else{var je=0;a=this._getArraySize(x,i),x=a[0],je=a[1];for(var z=0;z<c.leftOverUniforms.length;z++)if(c.leftOverUniforms[z].name===x)return"";c.leftOverUniforms.push({name:x,type:C,length:je}),t=""}}return t},n.prototype.uniformBufferProcessor=function(t,e,i){var r=i,o=new RegExp(/uniform\s+(\w+)/gm),a=o.exec(t);if(a!=null){var s=a[1],c=void 0,_=void 0,b=Sp[s];if(b)c=b.setIndex,_=b.bindingIndex;else if(e){var C=r.availableUBOs[s];if(C)c=C.setIndex,_=C.bindingIndex;else{var x=r.getNextFreeUBOBinding();c=x.setIndex,_=x.bindingIndex}}else{var x=r.getNextFreeUBOBinding();c=x.setIndex,_=x.bindingIndex}r.availableUBOs[s]={setIndex:c,bindingIndex:_},r.orderedUBOsAndSamplers[c]||(r.orderedUBOsAndSamplers[c]=[]),r.orderedUBOsAndSamplers[c][_]||(r.orderedUBOsAndSamplers[c][_]={isSampler:!1,isTexture:!1,name:s,usedInVertex:!1,usedInFragment:!1}),e?r.orderedUBOsAndSamplers[c][_].usedInFragment=!0:r.orderedUBOsAndSamplers[c][_].usedInVertex=!0,t=t.replace("uniform","layout(set = "+c+", binding = "+_+") uniform")}return t},n.prototype.postProcessor=function(t,e,i,r){var o=t.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,a=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(t=t.replace(a,""),t=t.replace(/texture2D\s*\(/g,"texture("),i)t=t.replace(/texture2DLodEXT\s*\(/g,"textureLod("),t=t.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),t=t.replace(/textureCube\s*\(/g,"texture("),t=t.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),t=t.replace(/gl_FragColor/g,"glFragColor"),t=t.replace(/gl_FragData/g,"glFragData"),t=t.replace(/void\s+?main\s*\(/g,(o?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else{t=t.replace(/gl_InstanceID/g,"gl_InstanceIndex"),t=t.replace(/gl_VertexID/g,"gl_VertexIndex");var s=e.indexOf("#define MULTIVIEW")!==-1;if(s)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+t}if(!i){var c=t.lastIndexOf("}");t=t.substring(0,c),t+=`gl_Position.y *= -1.;
gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0; }`}var _=new zo.a(t);return _.debug=Cp,_.processCode(),_.code},n.prototype._applyTextureArrayProcessing=function(t,e){for(var i=new RegExp(e+"\\s*\\[(.+)?\\]","gm"),r=i.exec(t);r!=null;){var o=r[1],a=+o;this._preProcessors&&isNaN(a)&&(a=+this._preProcessors[o.trim()]),t=t.replace(r[0],e+a),r=i.exec(t)}return t},n.prototype.finalizeShaders=function(t,e,i){for(var r=i,o=0;o<this._textureArrayProcessing.length;++o){var a=this._textureArrayProcessing[o];t=this._applyTextureArrayProcessing(t,a),e=this._applyTextureArrayProcessing(e,a)}for(var o=0;o<this._missingVaryings.length;++o){var s=this._missingVaryings[o];s&&s.length>0&&(e=s+`
`+e)}if(r.leftOverUniforms.length){var c="LeftOver",_=r.availableUBOs[c];_||(_=r.getNextFreeUBOBinding(),r.availableUBOs[c]=_,r.orderedUBOsAndSamplers[_.setIndex]||(r.orderedUBOsAndSamplers[_.setIndex]=[]),r.orderedUBOsAndSamplers[_.setIndex][_.bindingIndex]={isSampler:!1,isTexture:!1,usedInVertex:!0,usedInFragment:!0,name:c});for(var b="layout(set = "+_.setIndex+", binding = "+_.bindingIndex+") uniform "+c+` {
    `,C=0,x=r.leftOverUniforms;C<x.length;C++){var V=x[C];V.length>0?b+="    "+V.type+" "+V.name+"["+V.length+`];
`:b+="    "+V.type+" "+V.name+`;
`}b+=`};

`,t=b+t,e=b+e}for(var o=0;o<r.orderedUBOsAndSamplers.length;o++){var D=r.orderedUBOsAndSamplers[o];if(D!==void 0)for(var z=0;z<D.length;z++){var q=r.orderedUBOsAndSamplers[o][z];q&&!q.isSampler&&!q.isTexture&&r.uniformBufferNames.push(q.name)}}return this._preProcessors=null,{vertexCode:t,fragmentCode:e}},n}(),Ip=4,Lp=16,Ul={mat2:2,mat3:3,mat4:4},Fp=function(){function n(){this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeSetIndex=2,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableUBOs={},this.availableSamplers={},this.orderedAttributes=[],this.orderedUBOsAndSamplers=[],this.uniformBufferNames=[],this.leftOverUniforms=[]}return n.prototype.getAttributeNextLocation=function(t,e){var i;e===void 0&&(e=0);var r=this._attributeNextLocation;return this._attributeNextLocation+=((i=Ul[t])!==null&&i!==void 0?i:1)*(e||1),r},n.prototype.getVaryingNextLocation=function(t,e){var i;e===void 0&&(e=0);var r=this._varyingNextLocation;return this._varyingNextLocation+=((i=Ul[t])!==null&&i!==void 0?i:1)*(e||1),r},n.prototype.getNextFreeUBOBinding=function(){return this._getNextFreeBinding(1)},n.prototype._getNextFreeBinding=function(t){if(this.freeBindingIndex>Lp-t&&(this.freeSetIndex++,this.freeBindingIndex=0),this.freeSetIndex===Ip)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";var e={setIndex:this.freeSetIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=t,e},n}(),$e=u(450),rs=function(){function n(t){t===void 0&&(t=null),this.format=De.RGBA8Unorm,this.textureUsages=0,this._webgpuTexture=t,this._webgpuMSAATexture=null,this.view=null}return Object.defineProperty(n.prototype,"underlyingResource",{get:function(){return this._webgpuTexture},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"msaaTexture",{get:function(){return this._webgpuMSAATexture},set:function(t){this._webgpuMSAATexture=t},enumerable:!1,configurable:!0}),n.prototype.set=function(t){this._webgpuTexture=t},n.prototype.setMSAATexture=function(t){this._webgpuMSAATexture=t},n.prototype.setUsage=function(t,e,i,r,o){e=t===gt.b.RenderTarget?!1:e,this.createView({dimension:i?Oi.Cube:Oi.E2d,mipLevelCount:e?$e.a.ILog2(Math.max(r,o))+1:1,baseArrayLayer:0,baseMipLevel:0,aspect:qr.All})},n.prototype.createView=function(t){this.view=this._webgpuTexture.createView(t)},n.prototype.reset=function(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null},n.prototype.release=function(){var t,e;(t=this._webgpuTexture)===null||t===void 0||t.destroy(),(e=this._webgpuMSAATexture)===null||e===void 0||e.destroy(),this.reset()},n}(),Bp=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(location = 0) out vec2 vTex;

    void main() {
        vTex = tex[gl_VertexIndex];
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,Np=`
    layout(set = 0, binding = 0) uniform sampler imgSampler;
    layout(set = 0, binding = 1) uniform texture2D img;

    layout(location = 0) in vec2 vTex;
    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = texture(sampler2D(img, imgSampler), vTex);
    }
    `,wp=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(location = 0) out vec2 vTex;

    void main() {
        vTex = tex[gl_VertexIndex];
    #ifdef INVERTY
        vTex.y = 1.0 - vTex.y;
    #endif
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,Vp=`
    layout(set = 0, binding = 0) uniform sampler imgSampler;
    layout(set = 0, binding = 1) uniform texture2D img;

    layout(location = 0) in vec2 vTex;
    layout(location = 0) out vec4 outColor;

    void main() {
        vec4 color = texture(sampler2D(img, imgSampler), vTex);
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,Up=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));

    void main() {
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,Gp=`
    layout(set = 0, binding = 0) uniform Uniforms {
        uniform vec4 color;
    };

    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = color;
    }
    `,zr;(function(n){n[n.MipMap=0]="MipMap",n[n.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",n[n.Clear=2]="Clear"})(zr||(zr={}));var Gl=[{vertex:Bp,fragment:Np},{vertex:wp,fragment:Vp},{vertex:Up,fragment:Gp}],so=function(){function n(t,e,i){this._pipelines={},this._compiledShaders=[],this._deferredReleaseTextures=[],this._device=t,this._glslang=e,this._bufferManager=i,this._mipmapSampler=t.createSampler({minFilter:yt.Linear}),this._invertYPreMultiplyAlphaSampler=t.createSampler({minFilter:yt.Nearest,magFilter:yt.Nearest}),this._getPipeline(De.RGBA8Unorm)}return n.ComputeNumMipmapLevels=function(t,e){return $e.a.ILog2(Math.max(t,e))+1},n.prototype._getPipeline=function(t,e,i){e===void 0&&(e=zr.MipMap);var r=e===zr.MipMap?1<<0:e===zr.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):e===zr.Clear?1<<3:0;this._pipelines[t]||(this._pipelines[t]=[]);var o=this._pipelines[t][r];if(!o){var a=`#version 450\r
`;e===zr.InvertYPremultiplyAlpha&&(i.invertY&&(a+=`#define INVERTY\r
`),i.premultiplyAlpha&&(a+=`define PREMULTIPLYALPHA\r
`));var s=this._compiledShaders[r];if(!s){var c=this._device.createShaderModule({code:this._glslang.compileGLSL(a+Gl[e].vertex,"vertex")}),_=this._device.createShaderModule({code:this._glslang.compileGLSL(a+Gl[e].fragment,"fragment")});s=this._compiledShaders[r]=[c,_]}o=this._pipelines[t][r]=this._device.createRenderPipeline({vertexStage:{module:s[0],entryPoint:"main"},fragmentStage:{module:s[1],entryPoint:"main"},primitiveTopology:ki.TriangleStrip,vertexState:{indexFormat:Gr.Uint16},colorStates:[{format:t}]})}return o},n._GetTextureTypeFromFormat=function(t){switch(t){case De.R8Unorm:case De.R8Snorm:case De.R8Uint:case De.R8Sint:case De.RG8Unorm:case De.RG8Snorm:case De.RG8Uint:case De.RG8Sint:case De.RGBA8Unorm:case De.RGBA8UnormSRGB:case De.RGBA8Snorm:case De.RGBA8Uint:case De.RGBA8Sint:case De.BGRA8Unorm:case De.BGRA8UnormSRGB:case De.RGB10A2Unorm:case De.RGB9E5UFloat:case De.RG11B10UFloat:case De.Depth24UnormStencil8:case De.Depth32FloatStencil8:case De.BC7RGBAUnorm:case De.BC7RGBAUnormSRGB:case De.BC6HRGBUFloat:case De.BC6HRGBFloat:case De.BC5RGUnorm:case De.BC5RGSnorm:case De.BC3RGBAUnorm:case De.BC3RGBAUnormSRGB:case De.BC2RGBAUnorm:case De.BC2RGBAUnormSRGB:case De.BC4RUnorm:case De.BC4RSnorm:case De.BC1RGBAUNorm:case De.BC1RGBAUnormSRGB:return 0;case De.R16Uint:case De.R16Sint:case De.RG16Uint:case De.RG16Sint:case De.RGBA16Uint:case De.RGBA16Sint:case De.Depth16Unorm:return 5;case De.R16Float:case De.RG16Float:case De.RGBA16Float:return 2;case De.R32Uint:case De.R32Sint:case De.RG32Uint:case De.RG32Sint:case De.RGBA32Uint:case De.RGBA32Sint:return 7;case De.R32Float:case De.RG32Float:case De.RGBA32Float:case De.Depth32Float:return 1;case De.Stencil8:throw"No fixed size for Stencil8 format!";case De.Depth24Plus:throw"No fixed size for Depth24Plus format!";case De.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0},n._GetBlockInformationFromFormat=function(t){switch(t){case De.R8Unorm:case De.R8Snorm:case De.R8Uint:case De.R8Sint:return{width:1,height:1,length:1};case De.R16Uint:case De.R16Sint:case De.R16Float:case De.RG8Unorm:case De.RG8Snorm:case De.RG8Uint:case De.RG8Sint:return{width:1,height:1,length:2};case De.R32Uint:case De.R32Sint:case De.R32Float:case De.RG16Uint:case De.RG16Sint:case De.RG16Float:case De.RGBA8Unorm:case De.RGBA8UnormSRGB:case De.RGBA8Snorm:case De.RGBA8Uint:case De.RGBA8Sint:case De.BGRA8Unorm:case De.BGRA8UnormSRGB:case De.RGB9E5UFloat:case De.RGB10A2Unorm:case De.RG11B10UFloat:return{width:1,height:1,length:4};case De.RG32Uint:case De.RG32Sint:case De.RG32Float:case De.RGBA16Uint:case De.RGBA16Sint:case De.RGBA16Float:return{width:1,height:1,length:8};case De.RGBA32Uint:case De.RGBA32Sint:case De.RGBA32Float:return{width:1,height:1,length:16};case De.Stencil8:throw"No fixed size for Stencil8 format!";case De.Depth16Unorm:return{width:1,height:1,length:2};case De.Depth24Plus:throw"No fixed size for Depth24Plus format!";case De.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case De.Depth32Float:return{width:1,height:1,length:4};case De.Depth24UnormStencil8:return{width:1,height:1,length:4};case De.Depth32FloatStencil8:return{width:1,height:1,length:5};case De.BC7RGBAUnorm:case De.BC7RGBAUnormSRGB:case De.BC6HRGBUFloat:case De.BC6HRGBFloat:case De.BC5RGUnorm:case De.BC5RGSnorm:case De.BC3RGBAUnorm:case De.BC3RGBAUnormSRGB:case De.BC2RGBAUnorm:case De.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case De.BC4RUnorm:case De.BC4RSnorm:case De.BC1RGBAUNorm:case De.BC1RGBAUnormSRGB:return{width:4,height:4,length:8}}return{width:1,height:1,length:4}},n._IsHardwareTexture=function(t){return!!t.release},n._IsInternalTexture=function(t){return!!t.dispose},n.GetCompareFunction=function(t){switch(t){case 519:return ti.Always;case 514:return ti.Equal;case 516:return ti.Greater;case 518:return ti.GreaterEqual;case 513:return ti.Less;case 515:return ti.LessEqual;case 512:return ti.Never;case 517:return ti.NotEqual;default:return ti.Less}},n.IsImageBitmap=function(t){return t.close!==void 0},n.IsImageBitmapArray=function(t){return Array.isArray(t)&&t[0].close!==void 0},n.prototype.setCommandEncoder=function(t){this._commandEncoderForCreation=t},n.IsCompressedFormat=function(t){switch(t){case De.BC7RGBAUnormSRGB:case De.BC7RGBAUnorm:case De.BC6HRGBFloat:case De.BC6HRGBUFloat:case De.BC5RGSnorm:case De.BC5RGUnorm:case De.BC4RSnorm:case De.BC4RUnorm:case De.BC3RGBAUnormSRGB:case De.BC3RGBAUnorm:case De.BC2RGBAUnormSRGB:case De.BC2RGBAUnorm:case De.BC1RGBAUnormSRGB:case De.BC1RGBAUNorm:return!0}return!1},n.GetWebGPUTextureFormat=function(t,e){switch(e){case 13:return De.Depth24PlusStencil8;case 14:return De.Depth32Float;case 36492:return De.BC7RGBAUnorm;case 36495:return De.BC6HRGBUFloat;case 36494:return De.BC6HRGBFloat;case 33779:return De.BC3RGBAUnorm;case 33778:return De.BC2RGBAUnorm;case 33777:return De.BC1RGBAUNorm}switch(t){case 3:switch(e){case 6:return De.R8Snorm;case 7:return De.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return De.R8Sint;case 9:return De.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return De.RGBA8Sint;default:return De.RGBA8Snorm}case 0:switch(e){case 6:return De.R8Unorm;case 7:return De.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return De.RGBA8Unorm;case 12:return De.BGRA8Unorm;case 8:return De.R8Uint;case 9:return De.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return De.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return De.RGBA8Unorm}case 4:switch(e){case 8:return De.R16Sint;case 9:return De.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return De.RGBA16Sint;default:return De.RGBA16Sint}case 5:switch(e){case 8:return De.R16Uint;case 9:return De.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return De.RGBA16Uint;default:return De.RGBA16Uint}case 6:switch(e){case 8:return De.R32Sint;case 9:return De.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return De.RGBA32Sint;default:return De.RGBA32Sint}case 7:switch(e){case 8:return De.R32Uint;case 9:return De.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return De.RGBA32Uint;default:return De.RGBA32Uint}case 1:switch(e){case 6:return De.R32Float;case 7:return De.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return De.RGBA32Float;default:return De.RGBA32Float}case 2:switch(e){case 6:return De.R16Float;case 7:return De.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return De.RGBA16Float;default:return De.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(e){case 5:return De.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV";default:return De.RGB10A2Unorm}}return De.RGBA8Unorm},n.prototype.invertYPreMultiplyAlpha=function(t,e,i,r,o,a,s,c){o===void 0&&(o=!1),a===void 0&&(a=!1),s===void 0&&(s=0);var _=c===void 0,b=this._getPipeline(r,zr.InvertYPremultiplyAlpha,{invertY:o,premultiplyAlpha:a}),C=b.getBindGroupLayout(0);_&&(c=this._device.createCommandEncoder({})),c.pushDebugGroup("internal process texture - invertY="+o+" premultiplyAlpha="+a);var x=this.createTexture({width:e,height:i,layers:1},!1,!1,!1,!1,!1,r,1,c,ei.CopySrc|ei.OutputAttachment|ei.Sampled),V=c.beginRenderPass({colorAttachments:[{attachment:x.createView({dimension:Oi.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadValue:Gi.Load}]}),D=this._device.createBindGroup({layout:C,entries:[{binding:0,resource:this._invertYPreMultiplyAlphaSampler},{binding:1,resource:t.createView({dimension:Oi.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s})}]});V.setPipeline(b),V.setBindGroup(0,D),V.draw(4,1,0,0),V.endPass(),c.copyTextureToTexture({texture:x},{texture:t,origin:{x:0,y:0,z:Math.max(s,0)}},{width:e,height:i,depth:1}),this._deferredReleaseTextures.push([x,null,null]),c.popDebugGroup(),_&&(this._device.defaultQueue.submit([c.finish()]),c=null)},n.prototype.clear=function(t,e,i){var r=this._getPipeline(t,zr.Clear),o=r.getBindGroupLayout(0),a=this._bufferManager.createRawBuffer(4*4,Fi.CopySrc|Fi.Uniform,!0),s=this._device.createBindGroup({layout:o,entries:[{binding:0,resource:{buffer:a}}]});i.setPipeline(r),i.setBindGroup(0,s),i.draw(4,1,0,0),this._bufferManager.releaseBuffer(a)},n.prototype.createTexture=function(t,e,i,r,o,a,s,c,_,b){e===void 0&&(e=!1),i===void 0&&(i=!1),r===void 0&&(r=!1),o===void 0&&(o=!1),a===void 0&&(a=!1),s===void 0&&(s=De.RGBA8Unorm),c===void 0&&(c=1),b===void 0&&(b=-1),c>1&&(c=4);var C=t.layers||1,x={width:t.width,height:t.height,depth:C},V=e?n.ComputeNumMipmapLevels(t.width,t.height):1,D=b>=0?b:ei.CopySrc|ei.CopyDst|ei.Sampled,z=e&&!n.IsCompressedFormat(s)?ei.CopySrc|ei.OutputAttachment:0,q=this._device.createTexture({size:x,dimension:a?Vr.E3d:Vr.E2d,format:s,usage:D|z,sampleCount:c,mipLevelCount:V});return n.IsImageBitmap(t)&&(this.updateTexture(t,q,t.width,t.height,C,s,0,0,r,o,0,0,_),e&&i&&this.generateMipmaps(q,s,V,0,_)),q},n.prototype.createCubeTexture=function(t,e,i,r,o,a,s,c,_){e===void 0&&(e=!1),i===void 0&&(i=!1),r===void 0&&(r=!1),o===void 0&&(o=!1),a===void 0&&(a=De.RGBA8Unorm),s===void 0&&(s=1),_===void 0&&(_=-1),s>1&&(s=4);var b=n.IsImageBitmapArray(t)?t[0].width:t.width,C=n.IsImageBitmapArray(t)?t[0].height:t.height,x=e?n.ComputeNumMipmapLevels(b,C):1,V=_>=0?_:ei.CopySrc|ei.CopyDst|ei.Sampled,D=e&&!n.IsCompressedFormat(a)?ei.CopySrc|ei.OutputAttachment:0,z=this._device.createTexture({size:{width:b,height:C,depth:6},dimension:Vr.E2d,format:a,usage:V|D,sampleCount:s,mipLevelCount:x});return n.IsImageBitmapArray(t)&&(this.updateCubeTextures(t,z,b,C,a,r,o,0,0,c),e&&i&&this.generateCubeMipmaps(z,a,x,c)),z},n.prototype.generateCubeMipmaps=function(t,e,i,r){var o=r===void 0;o&&(r=this._device.createCommandEncoder({})),r.pushDebugGroup("create cube mipmaps - "+i+" levels");for(var a=0;a<6;++a)this.generateMipmaps(t,e,i,a,r);r.popDebugGroup(),o&&(this._device.defaultQueue.submit([r.finish()]),r=null)},n.prototype.generateMipmaps=function(t,e,i,r,o){r===void 0&&(r=0);var a=o===void 0,s=this._getPipeline(e),c=s.getBindGroupLayout(0);a&&(o=this._device.createCommandEncoder({})),o.pushDebugGroup("create mipmaps for face #"+r+" - "+i+" levels");for(var _=1;_<i;++_){var b=o.beginRenderPass({colorAttachments:[{attachment:t.createView({dimension:Oi.E2d,baseMipLevel:_,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadValue:Gi.Load}]}),C=this._device.createBindGroup({layout:c,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:t.createView({dimension:Oi.E2d,baseMipLevel:_-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})}]});b.setPipeline(s),b.setBindGroup(0,C),b.draw(4,1,0,0),b.endPass()}o.popDebugGroup(),a&&(this._device.defaultQueue.submit([o.finish()]),o=null)},n.prototype.createGPUTextureForInternalTexture=function(t,e,i,r){t._hardwareTexture||(t._hardwareTexture=new rs),e===void 0&&(e=t.width),i===void 0&&(i=t.height),r===void 0&&(r=t.depth);var o=t._hardwareTexture;o.format=n.GetWebGPUTextureFormat(t.type,t.format),o.textureUsages=t._source===gt.b.RenderTarget||t.source===gt.b.MultiRenderTarget?ei.Sampled|ei.CopySrc|ei.OutputAttachment:t._source===gt.b.Depth?ei.Sampled|ei.OutputAttachment:-1;var a=t.generateMipMaps,s=r||1;if(t.isCube){var c=this.createCubeTexture({width:e,height:i},t.generateMipMaps,t.generateMipMaps,t.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages);o.set(c),o.createView({dimension:Oi.Cube,mipLevelCount:a?n.ComputeNumMipmapLevels(e,i):1,baseArrayLayer:0,baseMipLevel:0,aspect:qr.All})}else{var c=this.createTexture({width:e,height:i,layers:s},t.generateMipMaps,t.generateMipMaps,t.invertY,!1,t.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages);o.set(c),o.createView({dimension:t.is2DArray?Oi.E2dArray:t.is3D?Vr.E3d:Oi.E2d,mipLevelCount:a?n.ComputeNumMipmapLevels(e,i):1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:s,aspect:qr.All})}return t.width=t.baseWidth=e,t.height=t.baseHeight=i,t.depth=t.baseDepth=r,this.createMSAATexture(t,t.samples),o},n.prototype.createMSAATexture=function(t,e){var i=t._hardwareTexture;if((i==null?void 0:i.msaaTexture)&&(this.releaseTexture(i.msaaTexture),i.msaaTexture=null),!(!i||(e!=null?e:1)<=1)){var r=t.width,o=t.height,a=t.depth||1;if(t.isCube){var s=this.createCubeTexture({width:r,height:o},!1,!1,t.invertY,!1,i.format,e,this._commandEncoderForCreation,i.textureUsages);i.setMSAATexture(s)}else{var s=this.createTexture({width:r,height:o,layers:a},!1,!1,t.invertY,!1,t.is3D,i.format,e,this._commandEncoderForCreation,i.textureUsages);i.setMSAATexture(s)}}},n.prototype.updateCubeTextures=function(t,e,i,r,o,a,s,c,_,b){a===void 0&&(a=!1),s===void 0&&(s=!1),c===void 0&&(c=0),_===void 0&&(_=0);for(var C=[0,3,1,4,2,5],x=0;x<C.length;++x){var V=t[C[x]];this.updateTexture(V,e,i,r,1,o,x,0,a,s,c,_,b)}},n.prototype.updateTexture=function(t,e,i,r,o,a,s,c,_,b,C,x,V){var D=this;s===void 0&&(s=0),c===void 0&&(c=0),_===void 0&&(_=!1),b===void 0&&(b=!1),C===void 0&&(C=0),x===void 0&&(x=0);var z=n._GetBlockInformationFromFormat(a),q={texture:e,origin:{x:C,y:x,z:Math.max(s,0)},mipLevel:c},ue={width:Math.ceil(i/z.width)*z.width,height:Math.ceil(r/z.height)*z.height,depth:o||1};if(t.byteLength!==void 0){t=t;var ge=Math.ceil(i/z.width)*z.length,Se=Math.ceil(ge/256)*256===ge;if(Se){var Pe=V===void 0;Pe&&(V=this._device.createCommandEncoder({}));var me=this._bufferManager.createRawBuffer(t.byteLength,Fi.MapWrite|Fi.CopySrc,!0),xe=me.getMappedRange();new Uint8Array(xe).set(t),me.unmap(),V.copyBufferToTexture({buffer:me,offset:0,bytesPerRow:ge,rowsPerImage:r},q,ue),Pe&&(this._device.defaultQueue.submit([V.finish()]),V=null),this._bufferManager.releaseBuffer(me)}else this._device.defaultQueue.writeTexture(q,t,{offset:0,bytesPerRow:ge,rowsPerImage:r},ue);(_||b)&&this.invertYPreMultiplyAlpha(e,i,r,a,_,b,s,V)}else t=t,_||b?createImageBitmap(t,{imageOrientation:_?"flipY":"none",premultiplyAlpha:b?"premultiply":"none"}).then(function(Fe){D._device.defaultQueue.copyImageBitmapToTexture({imageBitmap:Fe},q,ue)}):this._device.defaultQueue.copyImageBitmapToTexture({imageBitmap:t},q,ue)},n.prototype.readPixels=function(t,e,i,r,o,a,s,c,_){s===void 0&&(s=0),c===void 0&&(c=0),_===void 0&&(_=null);var b=n._GetBlockInformationFromFormat(a),C=Math.ceil(r/b.width)*b.length,x=Math.ceil(C/256)*256,V=x*o,D=this._bufferManager.createRawBuffer(V,Fi.MapRead|Fi.CopyDst),z=this._device.createCommandEncoder({});z.copyTextureToBuffer({texture:t,mipLevel:c,origin:{x:e,y:i,z:Math.max(s,0)}},{buffer:D,offset:0,bytesPerRow:x},{width:r,height:o,depth:1}),this._device.defaultQueue.submit([z.finish()]);var q=n._GetTextureTypeFromFormat(a),ue=q===1?2:q===2?1:0;return this._bufferManager.readDataFromBuffer(D,V,r,o,C,x,ue,0,_)},n.prototype.releaseTexture=function(t){if(n._IsInternalTexture(t)){var e=t._hardwareTexture,i=t._irradianceTexture,r=t._depthStencilTexture;this._deferredReleaseTextures.push([e,i,r])}else this._deferredReleaseTextures.push([t,null,null])},n.prototype.destroyDeferredTextures=function(){for(var t=0;t<this._deferredReleaseTextures.length;++t){var e=this._deferredReleaseTextures[t],i=e[0],r=e[1],o=e[2];i&&(n._IsHardwareTexture(i)?i.release():i.destroy()),r==null||r.dispose(),o==null||o.dispose()}this._deferredReleaseTextures.length=0},n}(),ns=u(563),zl=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this)||this;return i._buffer=e,i}return Object.defineProperty(t.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),t}(ns.a),zp=function(){function n(t){this._deferredReleaseBuffers=[],this._device=t}return n._IsGPUBuffer=function(t){return t.underlyingResource===void 0},n.prototype.createRawBuffer=function(t,e,i){i===void 0&&(i=!1);var r=t.byteLength!==void 0?t.byteLength+3&~3:t+3&~3,o={mappedAtCreation:i,size:r,usage:e};return this._device.createBuffer(o)},n.prototype.createBuffer=function(t,e){var i=t.byteLength!==void 0,r=this.createRawBuffer(t,e),o=new zl(r);return o.references=1,o.capacity=i?t.byteLength:t,i&&this.setSubData(o,0,t),o},n.prototype.setSubData=function(t,e,i,r,o){r===void 0&&(r=0),o===void 0&&(o=0);var a=t.underlyingResource;o=o||i.byteLength,o=Math.min(o,t.capacity-e);var s=i.byteOffset+r,c=s+o,_=o+3&~3;if(_!==o){var b=new Uint8Array(i.buffer.slice(s,c));i=new Uint8Array(_),i.set(b),r=0,s=0,c=_,o=_}for(var C=1024*1024*15,x=0;c-(s+x)>C;)this._device.defaultQueue.writeBuffer(a,e+x,i.buffer,s+x,C),x+=C;this._device.defaultQueue.writeBuffer(a,e+x,i.buffer,s+x,o-x)},n.prototype._FromHalfFloat=function(t){var e=(t&32768)>>15,i=(t&31744)>>10,r=t&1023;return i===0?(e?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):i==31?r?NaN:(e?-1:1)*Infinity:(e?-1:1)*Math.pow(2,i-15)*(1+r/Math.pow(2,10))},n.prototype._GetHalfFloatAsFloatRGBAArrayBuffer=function(t,e,i){i||(i=new Float32Array(t));for(var r=new Uint16Array(e);t--;)i[t]=this._FromHalfFloat(r[t]);return i},n.prototype.readDataFromBuffer=function(t,e,i,r,o,a,s,c,_,b){var C=this;return s===void 0&&(s=0),c===void 0&&(c=0),_===void 0&&(_=null),b===void 0&&(b=!0),new Promise(function(x,V){t.mapAsync(Vo.Read,c,e).then(function(){var D=t.getMappedRange(c,e),z=_;if(z===null)switch(s){case 0:z=new Uint8Array(e),z.set(new Uint8Array(D));break;case 1:z=C._GetHalfFloatAsFloatRGBAArrayBuffer(e/2,D);break;case 2:z=new Float32Array(e/4),z.set(new Float32Array(D));break}else switch(s){case 0:z=new Uint8Array(z.buffer),z.set(new Uint8Array(D));break;case 1:z=C._GetHalfFloatAsFloatRGBAArrayBuffer(e/2,D,_);break;case 2:z=new Float32Array(z.buffer),z.set(new Float32Array(D));break}if(o!==a){s===1&&(o*=2,a*=2);for(var q=new Uint8Array(z.buffer),ue=o,ge=0,Se=1;Se<r;++Se){ge=Se*a;for(var Pe=0;Pe<o;++Pe)q[ue++]=q[ge++]}s!==0?z=new Float32Array(q.buffer,0,ue/4):z=new Uint8Array(q.buffer,0,ue)}t.unmap(),b&&C.releaseBuffer(t),x(z)},function(D){return V(D)})})},n.prototype.releaseBuffer=function(t){return n._IsGPUBuffer(t)?(this._deferredReleaseBuffers.push(t),!0):(t.references--,t.references===0?(this._deferredReleaseBuffers.push(t.underlyingResource),!0):!1)},n.prototype.destroyDeferredBuffers=function(){for(var t=0;t<this._deferredReleaseBuffers.length;++t)this._deferredReleaseBuffers[t].destroy();this._deferredReleaseBuffers.length=0},n}(),jl=function(){function n(){this.colorAttachmentGPUTextures=[],this.reset()}return n.prototype.reset=function(t){t===void 0&&(t=!1),this.renderPass=null,t&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)},n}(),jp=[0|0<<1|0<<2,0|0<<1|0<<2,1|1<<1|0<<2,1|1<<1|1<<2,0|0<<1|0<<2,0|1<<1|0<<2,0|1<<1|1<<2,0|1<<1|0<<2,0|0<<1|1<<2,1|0<<1|0<<2,1|0<<1|1<<2,1|1<<1|0<<2,1|0<<1|0<<2],Wp=[0<<3|0<<4|0<<5|0<<6,0<<3|0<<4|0<<5|1<<6,0<<3|0<<4|1<<5|0<<6,0<<3|0<<4|1<<5|1<<6,0<<3|1<<4|0<<5|0<<6,0<<3|1<<4|0<<5|1<<6,0<<3|1<<4|1<<5|0<<6,0<<3|1<<4|1<<5|1<<6,1<<3|0<<4|0<<5|0<<6],Hp=[0<<7,1<<7,1<<7,0<<7,0<<7,0<<7,0<<7,1<<7,0<<7,0<<7,0<<7,0<<7,1<<7],kp=function(){function n(t){this._samplers={},this._device=t,this.disabled=!1}return n._GetSamplerHashCode=function(t){var e,i,r,o,a=jp[t.samplingMode]+Wp[(t._comparisonFunction||514)-512+1]+Hp[t.samplingMode]+(((e=t._cachedWrapU)!==null&&e!==void 0?e:1)<<8)+(((i=t._cachedWrapV)!==null&&i!==void 0?i:1)<<10)+(((r=t._cachedWrapR)!==null&&r!==void 0?r:1)<<12)+((t.generateMipMaps?1:0)<<14)+(((o=t._cachedAnisotropicFilteringLevel)!==null&&o!==void 0?o:1)<<15);return a},n._GetSamplerFilterDescriptor=function(t,e){var i,r,o,a,s,c=t.generateMipMaps;switch(t.samplingMode){case 11:i=yt.Linear,r=yt.Linear,o=yt.Nearest,c||(a=s=0);break;case 3:case 3:i=yt.Linear,r=yt.Linear,c?o=yt.Linear:(o=yt.Nearest,a=s=0);break;case 8:i=yt.Nearest,r=yt.Nearest,c?o=yt.Linear:(o=yt.Nearest,a=s=0);break;case 4:i=yt.Nearest,r=yt.Nearest,o=yt.Nearest,c||(a=s=0);break;case 5:i=yt.Nearest,r=yt.Linear,o=yt.Nearest,c||(a=s=0);break;case 6:i=yt.Nearest,r=yt.Linear,c?o=yt.Linear:(o=yt.Nearest,a=s=0);break;case 7:i=yt.Nearest,r=yt.Linear,o=yt.Nearest,a=s=0;break;case 1:case 1:i=yt.Nearest,r=yt.Nearest,o=yt.Nearest,a=s=0;break;case 9:i=yt.Linear,r=yt.Nearest,o=yt.Nearest,c||(a=s=0);break;case 10:i=yt.Linear,r=yt.Nearest,c?o=yt.Linear:(o=yt.Nearest,a=s=0);break;case 2:case 2:i=yt.Linear,r=yt.Linear,o=yt.Nearest,a=s=0;break;case 12:i=yt.Linear,r=yt.Nearest,o=yt.Nearest,a=s=0;break;default:i=yt.Nearest,r=yt.Nearest,o=yt.Nearest,a=s=0;break}return e>1&&(a!==0||s!==0)?{magFilter:yt.Linear,minFilter:yt.Linear,mipmapFilter:yt.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:o,lodMinClamp:a,lodMaxClamp:s}},n._GetWrappingMode=function(t){switch(t){case 1:return hn.Repeat;case 0:return hn.ClampToEdge;case 2:return hn.MirrorRepeat}return hn.Repeat},n._GetSamplerWrappingDescriptor=function(t){return{addressModeU:this._GetWrappingMode(t._cachedWrapU),addressModeV:this._GetWrappingMode(t._cachedWrapV),addressModeW:this._GetWrappingMode(t._cachedWrapR)}},n._GetSamplerDescriptor=function(t){var e,i=t.generateMipMaps&&(e=t._cachedAnisotropicFilteringLevel)!==null&&e!==void 0?e:1,r=this._GetSamplerFilterDescriptor(t,i);return Object(p.a)(Object(p.a)(Object(p.a)({},r),this._GetSamplerWrappingDescriptor(t)),{compare:t._comparisonFunction?so.GetCompareFunction(t._comparisonFunction):void 0,maxAnisotropy:r.anisotropyEnabled?i:1})},n.prototype.getSampler=function(t,e){if(e===void 0&&(e=!1),this.disabled)return this._device.createSampler(n._GetSamplerDescriptor(t));var i=e?0:n._GetSamplerHashCode(t),r=e?void 0:this._samplers[i];return r||(r=this._device.createSampler(n._GetSamplerDescriptor(t)),e||(this._samplers[i]=r)),r},n}(),Xp=function(){function n(t){this._shaders={},this._device=t}return n.prototype.getCompiledShaders=function(t){var e=this._shaders[t];return e||(e=this._shaders[t]={vertexStage:{module:this._device.createShaderModule({code:qe.a.ShadersStore[t+"VertexShader"]}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:qe.a.ShadersStore[t+"PixelShader"]}),entryPoint:"main"}}),e},n}(),ci;(function(n){n[n.StencilReadMask=0]="StencilReadMask",n[n.StencilWriteMask=1]="StencilWriteMask",n[n.DepthBiasSlopeScale=2]="DepthBiasSlopeScale",n[n.MRTAttachments1=3]="MRTAttachments1",n[n.MRTAttachments2=4]="MRTAttachments2",n[n.DepthStencilState=5]="DepthStencilState",n[n.RasterizationState=6]="RasterizationState",n[n.ColorStates=7]="ColorStates",n[n.ShaderStage=8]="ShaderStage",n[n.VertexState=9]="VertexState",n[n.NumStates=10]="NumStates"})(ci||(ci={}));var os={"":0,r8unorm:1,r8snorm:2,r8uint:3,r8sint:4,r16uint:5,r16sint:6,r16float:7,rg8unorm:8,rg8snorm:9,rg8uint:10,rg8sint:11,r32uint:12,r32sint:13,r32float:14,rg16uint:15,rg16sint:16,rg16float:17,rgba8unorm:18,"rgba8unorm-srgb":19,rgba8snorm:20,rgba8uint:21,rgba8sint:22,bgra8unorm:23,"bgra8unorm-srgb":24,rgb9e5ufloat:25,rgb10a2unorm:26,rg11b10ufloat:27,rg32uint:28,rg32sint:29,rg32float:30,rgba16uint:31,rgba16sint:32,rgba16float:33,rgba32uint:34,rgba32sint:35,rgba32float:36,stencil8:37,depth16unorm:38,depth24plus:39,"depth24plus-stencil8":40,depth32float:41,"bc1-rgba-unorm":42,"bc1-rgba-unorm-srgb":43,"bc2-rgba-unorm":44,"bc2-rgba-unorm-srgb":45,"bc3-rgba-unorm":46,"bc3-rgba-unorm-srgb":47,"bc4-r-unorm":48,"bc4-r-snorm":49,"bc5-rg-unorm":50,"bc5-rg-snorm":51,"bc6h-rgb-ufloat":52,"bc6h-rgb-float":53,"bc7-rgba-unorm":54,"bc7-rgba-unorm-srgb":55,"depth24unorm-stencil8":56,"depth32float-stencil8":57},jo={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},Sn={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},Wl=function(){function n(t,e){this._device=t,this._states=[],this._states.length=ci.NumStates,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=e,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.reset()}return n.prototype.reset=function(){this._isDirty=!0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setColorFormat(De.BGRA8Unorm),this.setMRTAttachments([],[]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(De.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null)},n.prototype.getRenderPipeline=function(t,e,i){if(this.disabled){var r=n._GetTopology(t);return this._parameter.pipeline=this._createRenderPipeline(e,r,i),n.NumCacheMiss++,n._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(e.uniqueId),this._setRasterizationState(t,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(e),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._states.length,n.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._states.length,this._parameter.pipeline)return n.NumCacheHitWithHash++,this._parameter.pipeline;var o=n._GetTopology(t);return this._parameter.pipeline=this._createRenderPipeline(e,o,i),this._setRenderPipeline(this._parameter),n.NumCacheMiss++,n._NumPipelineCreationCurrentFrame++,this._parameter.pipeline},n.prototype.endFrame=function(){n.NumPipelineCreationLastFrame=n._NumPipelineCreationCurrentFrame,n._NumPipelineCreationCurrentFrame=0},n.prototype.setAlphaToCoverage=function(t){this._alphaToCoverageEnabled=t},n.prototype.setFrontFace=function(t){this._frontFace=t},n.prototype.setCullEnabled=function(t){this._cullEnabled=t},n.prototype.setCullFace=function(t){this._cullFace=t},n.prototype.setClampDepth=function(t){this._clampDepth=t},n.prototype.resetDepthCullingState=function(){this.setDepthCullingState(!1,2,1,0,!0,!0,519)},n.prototype.setDepthCullingState=function(t,e,i,r,o,a,s){this._depthWriteEnabled=a,this._depthTestEnabled=o,this._depthCompare=(s!=null?s:519)-512,this._cullFace=i,this._cullEnabled=t,this._frontFace=e,this.setDepthBiasSlopeScale(r)},n.prototype.setDepthBiasSlopeScale=function(t){this._depthBiasSlopeScale!==t&&(this._depthBiasSlopeScale=t,this._states[ci.DepthBiasSlopeScale]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.DepthBiasSlopeScale))},n.prototype.setColorFormat=function(t){this._webgpuColorFormat=t,this._colorFormat=os[t]},n.prototype.setMRTAttachments=function(t,e){var i;if(t.length>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";var r=[0,0],o=0,a=0;this._mrtFormats.length=t.length;for(var s=0;s<t.length;++s){var c=t[s],_=e[c-1],b=_==null?void 0:_._hardwareTexture;this._mrtFormats[s]=(i=b==null?void 0:b.format)!==null&&i!==void 0?i:this._webgpuColorFormat,r[o]+=os[this._mrtFormats[s]]<<a,a+=6,a>=32&&(a=0,o++)}(this._mrtAttachments1!==r[0]||this._mrtAttachments2!==r[1])&&(this._mrtAttachments1=r[0],this._mrtAttachments2=r[1],this._states[ci.MRTAttachments1]=r[0],this._states[ci.MRTAttachments2]=r[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.MRTAttachments1))},n.prototype.setAlphaBlendEnabled=function(t){this._alphaBlendEnabled=t},n.prototype.setAlphaBlendFactors=function(t,e){this._alphaBlendFuncParams=t,this._alphaBlendEqParams=e},n.prototype.setWriteMask=function(t){this._writeMask=t},n.prototype.setDepthStencilFormat=function(t){this._webgpuDepthStencilFormat=t,this._depthStencilFormat=t===void 0?0:os[t]},n.prototype.setDepthTestEnabled=function(t){this._depthTestEnabled=t},n.prototype.setDepthWriteEnabled=function(t){this._depthWriteEnabled=t},n.prototype.setDepthCompare=function(t){this._depthCompare=(t!=null?t:519)-512},n.prototype.setStencilEnabled=function(t){this._stencilEnabled=t},n.prototype.setStencilCompare=function(t){this._stencilFrontCompare=(t!=null?t:519)-512},n.prototype.setStencilDepthFailOp=function(t){this._stencilFrontDepthFailOp=t===null?1:Sn[t]},n.prototype.setStencilPassOp=function(t){this._stencilFrontPassOp=t===null?2:Sn[t]},n.prototype.setStencilFailOp=function(t){this._stencilFrontFailOp=t===null?1:Sn[t]},n.prototype.setStencilReadMask=function(t){this._stencilReadMask!==t&&(this._stencilReadMask=t,this._states[ci.StencilReadMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.StencilReadMask))},n.prototype.setStencilWriteMask=function(t){this._stencilWriteMask!==t&&(this._stencilWriteMask=t,this._states[ci.StencilWriteMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.StencilWriteMask))},n.prototype.resetStencilState=function(){this.setStencilState(!1,519,7680,7681,7680,255,255)},n.prototype.setStencilState=function(t,e,i,r,o,a,s){this._stencilEnabled=t,this._stencilFrontCompare=(e!=null?e:519)-512,this._stencilFrontDepthFailOp=i===null?1:Sn[i],this._stencilFrontPassOp=r===null?2:Sn[r],this._stencilFrontFailOp=o===null?1:Sn[o],this.setStencilReadMask(a),this.setStencilWriteMask(s)},n.prototype.setBuffers=function(t,e,i){this._vertexBuffers=t,this._overrideVertexBuffers=i,this._indexBuffer=e},n._GetTopology=function(t){switch(t){case 0:return ki.TriangleList;case 2:return ki.PointList;case 1:return ki.LineList;case 3:return ki.PointList;case 4:return ki.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return ki.LineStrip;case 7:return ki.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return ki.TriangleList}},n._GetAphaBlendOperation=function(t){switch(t){case 32774:return Ur.Add;case 32778:return Ur.Subtract;case 32779:return Ur.ReverseSubtract;case 32775:return Ur.Min;case 32776:return Ur.Max;default:return Ur.Add}},n._GetAphaBlendFactor=function(t){switch(t){case 0:return Si.Zero;case 1:return Si.One;case 768:return Si.SrcColor;case 769:return Si.OneMinusSrcColor;case 770:return Si.SrcAlpha;case 771:return Si.OneMinusSrcAlpha;case 772:return Si.DstAlpha;case 773:return Si.OneMinusDstAlpha;case 774:return Si.DstColor;case 775:return Si.OneMinusDstColor;case 776:return Si.SrcAlphaSaturated;case 32769:return Si.BlendColor;case 32770:return Si.OneMinusBlendColor;case 32771:return Si.BlendColor;case 32772:return Si.OneMinusBlendColor;default:return Si.One}},n._GetCompareFunction=function(t){switch(t){case 0:return ti.Never;case 1:return ti.Less;case 2:return ti.Equal;case 3:return ti.LessEqual;case 4:return ti.Greater;case 5:return ti.NotEqual;case 6:return ti.GreaterEqual;case 7:return ti.Always}return ti.Never},n._GetStencilOpFunction=function(t){switch(t){case 0:return ir.Zero;case 1:return ir.Keep;case 2:return ir.Replace;case 3:return ir.IncrementClamp;case 4:return ir.DecrementClamp;case 5:return ir.Invert;case 6:return ir.IncrementWrap;case 7:return ir.DecrementWrap}return ir.Keep},n._GetVertexInputDescriptorFormat=function(t){var e=t.type,i=t.normalized,r=t.getSize();switch(e){case Be.b.BYTE:switch(r){case 1:case 2:return i?jt.Char2Norm:jt.Char2;case 3:case 4:return i?jt.Char4Norm:jt.Char4}break;case Be.b.UNSIGNED_BYTE:switch(r){case 1:case 2:return i?jt.Uchar2Norm:jt.Uchar2;case 3:case 4:return i?jt.Uchar4Norm:jt.Uchar4}break;case Be.b.SHORT:switch(r){case 1:case 2:return i?jt.Short2Norm:jt.Short2;case 3:case 4:return i?jt.Short4Norm:jt.Short4}break;case Be.b.UNSIGNED_SHORT:switch(r){case 1:case 2:return i?jt.Ushort2Norm:jt.Ushort2;case 3:case 4:return i?jt.Ushort4Norm:jt.Ushort4}break;case Be.b.INT:switch(r){case 1:return jt.Int;case 2:return jt.Int2;case 3:return jt.Int3;case 4:return jt.Int4}break;case Be.b.UNSIGNED_INT:switch(r){case 1:return jt.Uint;case 2:return jt.Uint2;case 3:return jt.Uint3;case 4:return jt.Uint4}break;case Be.b.FLOAT:switch(r){case 1:return jt.Float;case 2:return jt.Float2;case 3:return jt.Float3;case 4:return jt.Float4}break}throw new Error("Invalid Format '"+t.getKind()+"' - type="+e+", normalized="+i+", size="+r)},n.prototype._getAphaBlendState=function(){return this._alphaBlendEnabled?{srcFactor:n._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:n._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:n._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:{}},n.prototype._getColorBlendState=function(){return this._alphaBlendEnabled?{srcFactor:n._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:n._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:n._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:{}},n.prototype._setShaderStage=function(t){this._shaderId!==t&&(this._shaderId=t,this._states[ci.ShaderStage]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.ShaderStage))},n.prototype._setRasterizationState=function(t,e){var i=this._frontFace,r=this._cullEnabled?this._cullFace:0,o=this._clampDepth?1:0,a=this._alphaToCoverageEnabled?1:0,s=i-1+(r<<1)+(o<<3)+(a<<4)+(t<<5)+(e<<8);this._rasterizationState!==s&&(this._rasterizationState=s,this._states[ci.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.RasterizationState))},n.prototype._setColorStates=function(){var t=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(t+=((this._alphaBlendFuncParams[0]===null?2:jo[this._alphaBlendFuncParams[0]])<<0)+((this._alphaBlendFuncParams[1]===null?2:jo[this._alphaBlendFuncParams[1]])<<4)+((this._alphaBlendFuncParams[2]===null?2:jo[this._alphaBlendFuncParams[2]])<<8)+((this._alphaBlendFuncParams[3]===null?2:jo[this._alphaBlendFuncParams[3]])<<12)+((this._alphaBlendEqParams[0]===null?1:this._alphaBlendEqParams[0]-32773)<<16)+((this._alphaBlendEqParams[1]===null?1:this._alphaBlendEqParams[1]-32773)<<19)),t!==this._colorStates&&(this._colorStates=t,this._states[ci.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.ColorStates))},n.prototype._setDepthStencilState=function(){var t=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):7+(1<<3)+(1<<6)+(1<<9),e=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(t<<10);this._depthStencilState!==e&&(this._depthStencilState=e,this._states[ci.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.DepthStencilState))},n.prototype._setVertexState=function(t){for(var e,i=this._states.length,r=ci.VertexState,o=t._pipelineContext,a=o.shaderProcessingContext.attributeNamesFromEffect,s=o.shaderProcessingContext.attributeLocationsFromEffect,c=0;c<a.length;c++){var _=s[c],b=(e=this._overrideVertexBuffers&&this._overrideVertexBuffers[a[c]])!==null&&e!==void 0?e:this._vertexBuffers[a[c]];b||(b=this._emptyVertexBuffer);var C=b.hashCode+(_<<7);this._isDirty=this._isDirty||this._states[r]!==C,this._states[r++]=C}this._states.length=r,this._isDirty=this._isDirty||r!==i,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ci.VertexState))},n.prototype._createPipelineLayout=function(t){for(var e=[],i=0;i<t.shaderProcessingContext.orderedUBOsAndSamplers.length;i++){var r=t.shaderProcessingContext.orderedUBOsAndSamplers[i];if(r===void 0){var o=[],a=this._device.createBindGroupLayout({entries:o});e[i]=a;continue}for(var s=[],c=0;c<r.length;c++){var _=t.shaderProcessingContext.orderedUBOsAndSamplers[i][c];if(_!==void 0){var b=0;_.usedInVertex&&(b=b|ro.Vertex),_.usedInFragment&&(b=b|ro.Fragment);var C={binding:c,visibility:b};s.push(C),_.isSampler?C.sampler={type:_.isComparisonSampler?no.Comparison:no.Filtering}:_.isTexture?C.texture={sampleType:_.sampleType,viewDimension:_.textureDimension,multisampled:!1}:C.buffer={type:Uo.Uniform}}}if(s.length>0){var a=this._device.createBindGroupLayout({entries:s});e[i]=a}}return t.bindGroupLayouts=e,this._device.createPipelineLayout({bindGroupLayouts:e})},n.prototype._getVertexInputDescriptor=function(t,e){for(var i,r=[],o=t._pipelineContext,a=o.shaderProcessingContext.attributeNamesFromEffect,s=o.shaderProcessingContext.attributeLocationsFromEffect,c=0;c<a.length;c++){var _=s[c],b=(i=this._overrideVertexBuffers&&this._overrideVertexBuffers[a[c]])!==null&&i!==void 0?i:this._vertexBuffers[a[c]];b||(b=this._emptyVertexBuffer);var C={shaderLocation:_,offset:0,format:n._GetVertexInputDescriptorFormat(b)},x={arrayStride:b.byteStride,stepMode:b.getIsInstanced()?ao.Instance:ao.Vertex,attributes:[C]};r.push(x)}var V={vertexBuffers:r};return(e===ki.LineStrip||e===ki.TriangleStrip)&&(V.indexFormat=!this._indexBuffer||this._indexBuffer.is32Bits?Gr.Uint32:Gr.Uint16),V},n.prototype._createRenderPipeline=function(t,e,i,r){r===void 0&&(r=!0);var o=t._pipelineContext,a=this._getVertexInputDescriptor(t,e),s=r?this._createPipelineLayout(o):void 0,c=[],_=this._getAphaBlendState(),b=this._getColorBlendState();if(this._mrtAttachments1>0)for(var C=0;C<this._mrtFormats.length;++C)c.push({format:this._mrtFormats[C],alphaBlend:_,colorBlend:b,writeMask:this._writeMask});else c.push({format:this._webgpuColorFormat,alphaBlend:_,colorBlend:b,writeMask:this._writeMask});var x={compare:n._GetCompareFunction(this._stencilFrontCompare),depthFailOp:n._GetStencilOpFunction(this._stencilFrontDepthFailOp),failOp:n._GetStencilOpFunction(this._stencilFrontFailOp),passOp:n._GetStencilOpFunction(this._stencilFrontPassOp)};return this._device.createRenderPipeline(Object(p.a)(Object(p.a)({layout:s},o.stages),{primitiveTopology:e,rasterizationState:{frontFace:this._frontFace===1?oo.CCW:oo.CW,cullMode:this._cullEnabled?this._cullFace===2?Cn.Front:Cn.Back:Cn.None,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale},colorStates:c,sampleCount:i,depthStencilState:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?n._GetCompareFunction(this._depthCompare):ti.Always,format:this._webgpuDepthStencilFormat,stencilFront:x,stencilBack:x,stencilReadMask:this._stencilReadMask,stencilWriteMask:this._stencilWriteMask},vertexState:a}))},n.NumCacheHitWithoutHash=0,n.NumCacheHitWithHash=0,n.NumCacheMiss=0,n.NumPipelineCreationLastFrame=0,n._NumPipelineCreationCurrentFrame=0,n}(),Hl=function(){function n(){this.values={}}return n.prototype.count=function(){var t=0,e=this.pipeline?1:0;for(var i in this.values){var r=this.values[i],o=r.count(),a=o[0],s=o[1];t+=a,e+=s,t++}return[t,e]},n}(),kl=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r._nodeStack=[],r._nodeStack[0]=t._Cache,r}return t.GetNodeCounts=function(){var e=t._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}},t.prototype._getRenderPipeline=function(e){for(var i=this._nodeStack[this._stateDirtyLowestIndex],r=this._stateDirtyLowestIndex;r<this._states.length;++r){var o=i.values[this._states[r]];o||(o=new Hl,i.values[this._states[r]]=o),i=o,this._nodeStack[r+1]=i}e.token=i,e.pipeline=i.pipeline},t.prototype._setRenderPipeline=function(e){e.token.pipeline=e.pipeline},t._Cache=new Hl,t}(Wl),Xl=u(682),Yp=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,!1)||this;return i._cache=e,i.reset(),i}return Object.defineProperty(t.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(e){this._stencilFunc!==e&&(this._stencilFunc=e,this._isStencilFuncDirty=!0,this._cache.setStencilCompare(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(e){this._stencilFuncRef!==e&&(this._stencilFuncRef=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(e){this._stencilFuncMask!==e&&(this._stencilFuncMask=e,this._isStencilFuncDirty=!0,this._cache.setStencilReadMask(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(e){this._stencilOpStencilFail!==e&&(this._stencilOpStencilFail=e,this._isStencilOpDirty=!0,this._cache.setStencilFailOp(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(e){this._stencilOpDepthFail!==e&&(this._stencilOpDepthFail=e,this._isStencilOpDirty=!0,this._cache.setStencilDepthFailOp(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(e){this._stencilOpStencilDepthPass!==e&&(this._stencilOpStencilDepthPass=e,this._isStencilOpDirty=!0,this._cache.setStencilPassOp(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(e){this._stencilMask!==e&&(this._stencilMask=e,this._isStencilMaskDirty=!0,this._cache.setStencilWriteMask(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(e){this._stencilTest!==e&&(this._stencilTest=e,this._isStencilTestDirty=!0,this._cache.setStencilEnabled(e))},enumerable:!1,configurable:!0}),t.prototype.reset=function(){n.prototype.reset.call(this),this._cache.resetStencilState()},t.prototype.apply=function(e){},t}(Xl.a),Yl=u(681),Kp=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,!1)||this;return i._cache=e,i.reset(),i}return Object.defineProperty(t.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e!=null?e:1))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cull",{get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e!=null?e:2))},enumerable:!1,configurable:!0}),t.prototype.reset=function(){n.prototype.reset.call(this),this._cache.resetDepthCullingState()},t.prototype.apply=function(e){},t}(Yl.a),Kl="clearQuadVertexShader",Ql=`
const pos : array<vec2<f32>,4>
= array<vec2<f32>,4>(
vec2<f32>(-1.0,1.0),
vec2<f32>(1.0,1.0),
vec2<f32>(-1.0,-1.0),
vec2<f32>(1.0,-1.0)
);
[[builtin(position)]] var<out> position : vec4<f32>;
[[builtin(vertex_idx)]] var<in> vertexIndex : i32;
[[stage(vertex)]]
fn main() -> void {
position=vec4<f32>(pos[vertexIndex],0.0,1.0);
return;
}
`;qe.a.ShadersStore[Kl]=Ql;var l_={name:Kl,shader:Ql},Zl="clearQuadPixelShader",Jl=`[[block]] struct Uniforms {
[[offset(0)]] color : vec4<f32>;
};
[[binding(0),set(0)]] var<uniform> uniforms : Uniforms;
[[location(0)]] var<out> outColor : vec4<f32>;
[[stage(fragment)]]
fn main() -> void {
outColor=uniforms.color;
return;
}
`;qe.a.ShadersStore[Zl]=Jl;var u_={name:Zl,shader:Jl};function Qp(n,t){if(!n)throw new Error(t)}var as=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i={});var r,o,a=n.call(this,null)||this;return a._uploadEncoderDescriptor={label:"upload"},a._renderEncoderDescriptor={label:"render"},a._renderTargetEncoderDescriptor={label:"renderTarget"},a._clearDepthValue=1,a._clearReverseDepthValue=0,a._clearStencilValue=0,a._defaultSampleCount=4,a._glslang=null,a._counters={numBindGroupsCreation:0},a._commandBuffers=[null,null,null],a._currentRenderPass=null,a._mainRenderPassWrapper=new jl,a._rttRenderPassWrapper=new jl,a._pendingDebugCommands=[],a._currentVertexBuffers=null,a._currentOverrideVertexBuffers=null,a._currentIndexBuffer=null,a.__colorWrite=!0,a._uniformsBuffers={},a._forceEnableEffect=!1,a.dbgShowShaderCode=!1,a.dbgSanityChecks=!1,a.dbgGenerateLogs=!1,a.dbgVerboseLogsForFirstFrames=!1,a.dbgVerboseLogsNumFrames=10,a._viewportsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],a._scissorsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],a._scissorCached={x:0,y:0,z:0,w:0},i.deviceDescriptor=i.deviceDescriptor||{},i.swapChainFormat=i.swapChainFormat||De.BGRA8Unorm,i.antialiasing=i.antialiasing===void 0?!0:i.antialiasing,i.stencil=(r=i.stencil)!==null&&r!==void 0?r:!0,i.enableGPUDebugMarkers=(o=i.enableGPUDebugMarkers)!==null&&o!==void 0?o:!1,d.a.Log("Babylon.js v"+G.a.Version+" - "+a.description+" engine"),navigator.gpu?(a._isWebGPU=!0,a._shaderPlatformName="WEBGPU",i.deterministicLockstep===void 0&&(i.deterministicLockstep=!1),i.lockstepMaxSteps===void 0&&(i.lockstepMaxSteps=4),i.audioEngine===void 0&&(i.audioEngine=!0),a._deterministicLockstep=i.deterministicLockstep,a._lockstepMaxSteps=i.lockstepMaxSteps,a._timeStep=i.timeStep||1/60,a._doNotHandleContextLost=!1,a._canvas=e,a._options=i,a.premultipliedAlpha=!1,a._hardwareScalingLevel=1,a._mainPassSampleCount=i.antialiasing?a._defaultSampleCount:1,a._isStencilEnable=i.stencil,a._sharedInit(e,!!i.doNotHandleTouchAction,i.audioEngine),a._shaderProcessor=a._getShaderProcessor(),a._canvas.style.transform="scaleY(-1)",a):(d.a.Error("WebGPU is not supported by your browser."),a)}return Object.defineProperty(t.prototype,"disableCacheSamplers",{get:function(){return this._cacheSampler?this._cacheSampler.disabled:!1},set:function(e){this._cacheSampler&&(this._cacheSampler.disabled=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"disableCacheRenderPipelines",{get:function(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1},set:function(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t,"IsSupported",{get:function(){return!!navigator.gpu},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"supportsUniformBuffers",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"supportedExtensions",{get:function(){return this._adapterSupportedExtensions},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"enabledExtensions",{get:function(){return this._deviceEnabledExtensions},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return"WebGPU"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"description",{get:function(){var e=this.name+this.version;return e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return 1},enumerable:!1,configurable:!0}),t.CreateAsync=function(e,i){i===void 0&&(i={});var r=new t(e,i);return new Promise(function(o){r.initAsync(i.glslangOptions).then(function(){return o(r)})})},t.prototype.initAsync=function(e){var i=this,r;return this._initGlslang(e!=null?e:(r=this._options)===null||r===void 0?void 0:r.glslangOptions).then(function(o){return i._glslang=o,navigator.gpu.requestAdapter(i._options)}).then(function(o){i._adapter=o,i._adapterSupportedExtensions=i._adapter.extensions.slice(0);var a=i._options.deviceDescriptor;if(a==null?void 0:a.extensions){for(var s=a.extensions,c=[],_=s[Symbol.iterator]();;){var b=_.next(),C=b.done,x=b.value;if(C)break;i._adapterSupportedExtensions.indexOf(x)>=0&&c.push(x)}a.extensions=c}return i._adapter.requestDevice(i._options.deviceDescriptor)}).then(function(o){i._device=o,i._deviceEnabledExtensions=i._device.extensions.slice(0)}).then(function(){i._bufferManager=new zp(i._device),i._textureHelper=new so(i._device,i._glslang,i._bufferManager),i._shaderManager=new Xp(i._device),i._cacheSampler=new kp(i._device),i.dbgVerboseLogsForFirstFrames&&i._count===void 0&&(i._count=0,console.log("%c frame #"+i._count+" - begin","background: #ffff00")),i._uploadEncoder=i._device.createCommandEncoder(i._uploadEncoderDescriptor),i._renderEncoder=i._device.createCommandEncoder(i._renderEncoderDescriptor),i._renderTargetEncoder=i._device.createCommandEncoder(i._renderTargetEncoderDescriptor),i._emptyVertexBuffer=new Be.b(i,[0],"",!1,!1,1,!1,0,1),i._cacheRenderPipeline=new kl(i._device,i._emptyVertexBuffer),i._depthCullingState=new Kp(i._cacheRenderPipeline),i._stencilState=new Yp(i._cacheRenderPipeline),i._depthCullingState.depthTest=!0,i._depthCullingState.depthFunc=515,i._depthCullingState.depthMask=!0,i._textureHelper.setCommandEncoder(i._uploadEncoder),i._initializeLimits(),i._initializeContextAndSwapChain(),i._initializeMainAttachments(),i.resize()}).catch(function(o){d.a.Error("Can not create WebGPU Device and/or context."),d.a.Error(o),console.trace&&console.trace()})},t.prototype._initGlslang=function(e){return e=e||{},e=Object(p.a)(Object(p.a)({},t._glslangDefaultOptions),e),e.glslang?Promise.resolve(e.glslang):window.glslang?window.glslang(e.wasmPath):e.jsPath&&e.wasmPath?re.b.LoadScriptAsync(e.jsPath).then(function(){return window.glslang(e.wasmPath)}):Promise.reject("gslang is not available.")},t.prototype._initializeLimits=function(){this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:2048,maxCubemapTextureSize:2048,maxRenderTextureSize:2048,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:1024,maxVertexUniformVectors:1024,standardDerivatives:!0,astc:null,s3tc:this._deviceEnabledExtensions.indexOf(io.TextureCompressionBC)>=0?!0:void 0,pvrtc:null,etc1:null,etc2:null,bptc:this._deviceEnabledExtensions.indexOf(io.TextureCompressionBC)>=0?!0:void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,textureFloat:!0,textureFloatLinearFiltering:!0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:void 0,canUseTimestampForTimerQuery:!1,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0},this._caps.parallelShaderCompile=null,this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!0,allowTexturePrefiltering:!0,trackUbosInFrame:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,_collectUbosUpdatedInFrame:!0}},t.prototype._initializeContextAndSwapChain=function(){this._context=this._canvas.getContext("gpupresent"),this._swapChain=this._context.configureSwapChain({device:this._device,format:this._options.swapChainFormat,usage:ei.OutputAttachment|ei.CopySrc}),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new rs],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this.dbgGenerateLogs&&console.log("Swap chain preferred format:",this._context.getSwapChainPreferredFormat(this._adapter))},t.prototype._initializeMainAttachments=function(){this._mainTextureExtends={width:this.getRenderWidth(),height:this.getRenderHeight(),depth:1};var e;if(this._options.antialiasing){var i={size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Vr.E2d,format:this._options.swapChainFormat,usage:ei.OutputAttachment};this._mainTexture&&this._mainTexture.destroy(),this._mainTexture=this._device.createTexture(i),e=[{attachment:this._mainTexture.createView(),loadValue:new tt.f(0,0,0,1),storeOp:Sr.Store}]}else e=[{attachment:void 0,loadValue:new tt.f(0,0,0,1),storeOp:Sr.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?De.Depth24PlusStencil8:De.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper);var r={size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Vr.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:ei.OutputAttachment};this._depthTexture&&this._depthTexture.destroy(),this._depthTexture=this._device.createTexture(r);var o={attachment:this._depthTexture.createView(),depthLoadValue:this._clearDepthValue,depthStoreOp:Sr.Store,stencilLoadValue:this._clearStencilValue,stencilStoreOp:Sr.Store};this._mainRenderPassWrapper.renderPassDescriptor={colorAttachments:e,depthStencilAttachment:o},this._mainRenderPassWrapper.renderPass!==null&&this._endMainRenderPass()},t.prototype.setSize=function(e,i,r){return r===void 0&&(r=!1),n.prototype.setSize.call(this,e,i,r)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - setSize called -",e,i)),this._initializeMainAttachments(),!0):!1},t.prototype._getShaderProcessor=function(){return new Dp},t.prototype._getShaderProcessingContext=function(){return new Fp},t.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentVertexBuffers=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._currentProgram=null,this._stencilState.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},t.prototype.setColorWrite=function(e){this.__colorWrite=e,this._cacheRenderPipeline.setWriteMask(e?15:0)},t.prototype.getColorWrite=function(){return this.__colorWrite},t.prototype._resetCurrentViewport=function(e){this._viewportsCurrent[e].x=0,this._viewportsCurrent[e].y=0,this._viewportsCurrent[e].w=0,this._viewportsCurrent[e].h=0},t.prototype._applyViewport=function(e){var i=e===this._mainRenderPassWrapper.renderPass?0:1,r=this._viewportCached.x,o=this._viewportCached.y,a=this._viewportCached.z,s=this._viewportCached.w;(this._viewportsCurrent[i].x!==r||this._viewportsCurrent[i].y!==o||this._viewportsCurrent[i].w!==a||this._viewportsCurrent[i].h!==s)&&(this._viewportsCurrent[i].x=r,this._viewportsCurrent[i].y=o,this._viewportsCurrent[i].w=a,this._viewportsCurrent[i].h=s,e.setViewport(r,o,a,s,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - viewport applied - (",r,o,a,s,") current pass is main pass="+(e===this._mainRenderPassWrapper.renderPass))))},t.prototype._viewport=function(e,i,r,o){this._viewportCached.x=e,this._viewportCached.y=i,this._viewportCached.z=r,this._viewportCached.w=o},t.prototype._resetCurrentScissor=function(e){this._scissorsCurrent[e].x=0,this._scissorsCurrent[e].y=0,this._scissorsCurrent[e].w=0,this._scissorsCurrent[e].h=0},t.prototype._applyScissor=function(e){var i=e===this._mainRenderPassWrapper.renderPass?0:1,r=this._scissorCached.x,o=this._scissorCached.y,a=this._scissorCached.z,s=this._scissorCached.w;(this._scissorsCurrent[i].x!==r||this._scissorsCurrent[i].y!==o||this._scissorsCurrent[i].w!==a||this._scissorsCurrent[i].h!==s)&&(this._scissorsCurrent[i].x=r,this._scissorsCurrent[i].y=o,this._scissorsCurrent[i].w=a,this._scissorsCurrent[i].h=s,e.setScissorRect(r,o,a,s),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - scissor applied - (",r,o,a,s,") current pass is main pass="+(e===this._mainRenderPassWrapper.renderPass))))},t.prototype._scissorIsActive=function(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==this.getRenderWidth()&&this._scissorCached.z!==0||this._scissorCached.w!==this.getRenderHeight()&&this._scissorCached.w!==0},t.prototype.enableScissor=function(e,i,r,o){this._scissorCached.x=e,this._scissorCached.y=i,this._scissorCached.z=r,this._scissorCached.w=o},t.prototype.disableScissor=function(){this._scissorCached.x=0,this._scissorCached.y=0,this._scissorCached.z=this.getRenderWidth(),this._scissorCached.w=this.getRenderHeight()},t.prototype.clear=function(e,i,r,o){o===void 0&&(o=!1),e&&e.a===void 0&&(e.a=1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - clear called - backBuffer=",i," depth=",r," stencil=",o)),this._currentRenderTarget?(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,i?e:null,i?e:null,r,o)):this._startMainRenderPass(!0,i?e:null,r,o)},t.prototype.clearAttachments=function(e,i,r,o,a){e.length===0||!this._currentRenderTarget||(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,i,r,o,a))},t.prototype.createVertexBuffer=function(e){var i;e instanceof Array?i=new Float32Array(e):e instanceof ArrayBuffer?i=new Uint8Array(e):i=e;var r=this._bufferManager.createBuffer(i,Fi.Vertex|Fi.CopyDst);return r},t.prototype.createDynamicVertexBuffer=function(e){return this.createVertexBuffer(e)},t.prototype.updateDynamicVertexBuffer=function(e,i,r,o){var a=e;r===void 0&&(r=0);var s;o===void 0?(i instanceof Array?s=new Float32Array(i):i instanceof ArrayBuffer?s=new Uint8Array(i):s=i,o=s.byteLength):i instanceof Array?s=new Float32Array(i):i instanceof ArrayBuffer?s=new Uint8Array(i):s=i,this._bufferManager.setSubData(a,r,s,0,o)},t.prototype.createIndexBuffer=function(e,i){var r=!0,o;e instanceof Uint32Array||e instanceof Int32Array?o=e:e instanceof Uint16Array?(o=e,r=!1):e.length>65535?o=new Uint32Array(e):(o=new Uint16Array(e),r=!1);var a=this._bufferManager.createBuffer(o,Fi.Index|Fi.CopyDst);return a.is32Bits=r,a},t.prototype.updateDynamicIndexBuffer=function(e,i,r){r===void 0&&(r=0);var o=e,a;i instanceof Uint16Array?e.is32Bits?a=Uint32Array.from(i):a=i:i instanceof Uint32Array?e.is32Bits?a=i:a=Uint16Array.from(i):e.is32Bits?a=new Uint32Array(i):a=new Uint16Array(i),this._bufferManager.setSubData(o,r,a)},t.prototype.bindBuffersDirectly=function(e,i,r,o,a){throw"Not implemented on WebGPU so far."},t.prototype.updateAndBindInstancesBuffer=function(e,i,r){throw"Not implemented on WebGPU so far."},t.prototype.bindBuffers=function(e,i,r,o){this._currentIndexBuffer=i,this._currentVertexBuffers=e,this._currentOverrideVertexBuffers=o!=null?o:null,this._cacheRenderPipeline.setBuffers(e,i,this._currentOverrideVertexBuffers)},t.prototype._releaseBuffer=function(e){return this._bufferManager.releaseBuffer(e)},t.prototype.createUniformBuffer=function(e){var i;e instanceof Array?i=new Float32Array(e):i=e;var r=this._bufferManager.createBuffer(i,Fi.Uniform|Fi.CopyDst);return r},t.prototype.createDynamicUniformBuffer=function(e){return this.createUniformBuffer(e)},t.prototype.updateUniformBuffer=function(e,i,r,o){r===void 0&&(r=0);var a=e,s;o===void 0?(i instanceof Float32Array?s=i:s=new Float32Array(i),o=s.byteLength):i instanceof Float32Array?s=i:s=new Float32Array(i),this._bufferManager.setSubData(a,r,s,0,o)},t.prototype.bindUniformBufferBase=function(e,i,r){this._uniformsBuffers[r]=e},t.prototype.createEffect=function(e,i,r,o,a,s,c,_,b){var C=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,x=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,V=C+"+"+x+"@"+(a||i.defines);if(this._compiledEffects[V]){var D=this._compiledEffects[V];return c&&D.isReady()&&c(D),D}var z=new qe.a(e,i,r,o,this,a,s,c,_,b,V);return this._compiledEffects[V]=z,z},t.prototype._compileRawShaderToSpirV=function(e,i){return this._glslang.compileGLSL(e,i)},t.prototype._compileShaderToSpirV=function(e,i,r,o){return this._compileRawShaderToSpirV(o+(r?r+`
`:"")+e,i)},t.prototype._createPipelineStageDescriptor=function(e,i){return{vertexStage:{module:this._device.createShaderModule({code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:i}),entryPoint:"main"}}},t.prototype._compileRawPipelineStageDescriptor=function(e,i){var r=this._compileRawShaderToSpirV(e,"vertex"),o=this._compileRawShaderToSpirV(i,"fragment");return this._createPipelineStageDescriptor(r,o)},t.prototype._compilePipelineStageDescriptor=function(e,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);var o=`#version 450
`,a=this._compileShaderToSpirV(e,"vertex",r,o),s=this._compileShaderToSpirV(i,"fragment",r,o),c=this._createPipelineStageDescriptor(a,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),c},t.prototype.createRawShaderProgram=function(e,i,r,o,a){throw a===void 0&&(a=null),"Not available on WebGPU"},t.prototype.createShaderProgram=function(e,i,r,o,a,s){throw s===void 0&&(s=null),"Not available on WebGPU"},t.prototype.createPipelineContext=function(e){return new Pp(e,this)},t.prototype._preparePipelineContext=function(e,i,r,o,a,s,c,_,b,C){var x=e;this.dbgShowShaderCode&&(console.log(_),console.log(i),console.log(r)),x.sources={fragment:r,vertex:i,rawVertex:a,rawFragment:s},o?x.stages=this._compileRawPipelineStageDescriptor(i,r):x.stages=this._compilePipelineStageDescriptor(i,r,_)},t.prototype.getAttributes=function(e,i){for(var r=new Array(i.length),o=e,a=0;a<i.length;a++){var s=i[a],c=o.shaderProcessingContext.availableAttributes[s];c!==void 0&&(r[a]=c)}return r},t.prototype.enableEffect=function(e){!e||e===this._currentEffect&&!this._forceEnableEffect||(this._currentEffect=e,this._forceEnableEffect=!1,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))},t.prototype._releaseEffect=function(e){},t.prototype.releaseEffects=function(){},t.prototype._deletePipelineContext=function(e){var i=e;i&&e.dispose()},Object.defineProperty(t.prototype,"needPOTTextures",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype._createHardwareTexture=function(){return new rs},t.prototype._releaseTexture=function(e){var i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),this._textureHelper.releaseTexture(e)},t.prototype._getRGBABufferInternalSizedFormat=function(e,i){return 5},t.prototype.updateTextureComparisonFunction=function(e,i){e._comparisonFunction=i},t.prototype.createTexture=function(e,i,r,o,a,s,c,_,b,C,x,V,D){var z=this;return a===void 0&&(a=3),s===void 0&&(s=null),c===void 0&&(c=null),_===void 0&&(_=null),b===void 0&&(b=null),C===void 0&&(C=null),x===void 0&&(x=null),this._createTextureBase(e,i,r,o,a,s,c,function(q,ue,ge,Se,Pe,me,xe,Fe,we){var Ge,Xe=Se;if(q.baseWidth=Xe.width,q.baseHeight=Xe.height,q.width=Xe.width,q.height=Xe.height,q.format=C!=null?C:-1,Fe(q.width,q.height,Xe,ue,q,function(){}),(Ge=q._hardwareTexture)===null||Ge===void 0?void 0:Ge.underlyingResource)!me&&!xe&&z._generateMipmaps(q,z._uploadEncoder);else{var Oe=z._textureHelper.createGPUTextureForInternalTexture(q,Xe.width,Xe.height);so.IsImageBitmap(Xe)&&(z._textureHelper.updateTexture(Xe,Oe.underlyingResource,Xe.width,Xe.height,q.depth,Oe.format,0,0,Pe,!1,0,0,z._uploadEncoder),!me&&!xe&&z._generateMipmaps(q,z._uploadEncoder))}ge&&ge._removePendingData(q),q.isReady=!0,q.onLoadedObservable.notifyObservers(q),q.onLoadedObservable.clear()},function(){return!1},_,b,C,x,V,D)},t.prototype._setCubeMapTextureParams=function(e,i){e.samplingMode=i?G.a.TEXTURE_TRILINEAR_SAMPLINGMODE:G.a.TEXTURE_BILINEAR_SAMPLINGMODE,e._cachedWrapU=0,e._cachedWrapV=0},t.prototype.createCubeTexture=function(e,i,r,o,a,s,c,_,b,C,x,V){var D=this;return a===void 0&&(a=null),s===void 0&&(s=null),_===void 0&&(_=null),b===void 0&&(b=!1),C===void 0&&(C=0),x===void 0&&(x=0),V===void 0&&(V=null),this.createCubeTextureBase(e,i,r,!!o,a,s,c,_,b,C,x,V,null,function(z,q){var ue=q,ge=ue[0].width,Se=ge;D._setCubeMapTextureParams(z,!o),z.format=c!=null?c:-1;var Pe=D._textureHelper.createGPUTextureForInternalTexture(z,ge,Se);D._textureHelper.updateCubeTextures(ue,Pe.underlyingResource,ge,Se,Pe.format,!1,!1,0,0,D._uploadEncoder),o||D._generateMipmaps(z,D._uploadEncoder),z.isReady=!0,z.onLoadedObservable.notifyObservers(z),z.onLoadedObservable.clear(),a&&a()})},t.prototype.createRawTexture=function(e,i,r,o,a,s,c,_,b){_===void 0&&(_=null),b===void 0&&(b=0);var C=new gt.a(this,gt.b.Raw);return C.baseWidth=i,C.baseHeight=r,C.width=i,C.height=r,C.format=o,C.generateMipMaps=a,C.samplingMode=c,C.invertY=s,C._compression=_,C.type=b,this._doNotHandleContextLost||(C._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(C,i,r),this.updateRawTexture(C,e,o,s,_,b),this._internalTexturesCache.push(C),C},t.prototype.createRawCubeTexture=function(e,i,r,o,a,s,c,_){_===void 0&&(_=null);var b=new gt.a(this,gt.b.CubeRaw);return b.isCube=!0,b.format=r===4?5:r,b.type=o,b.generateMipMaps=a,b.width=i,b.height=i,b.samplingMode=c,this._doNotHandleContextLost||(b._bufferViewArray=e),this._textureHelper.createGPUTextureForInternalTexture(b),e&&this.updateRawCubeTexture(b,e,r,o,s,_),b},t.prototype.createRawCubeTextureFromUrl=function(e,i,r,o,a,s,c,_,b,C,x,V){var D=this;b===void 0&&(b=null),C===void 0&&(C=null),x===void 0&&(x=3),V===void 0&&(V=!1);var z=this.createRawCubeTexture(null,r,o,a,!s,V,x,null);i==null||i._addPendingData(z),z.url=e,this._internalTexturesCache.push(z);var q=function(ge,Se){i==null||i._removePendingData(z),C&&ge&&C(ge.status+" "+ge.statusText,Se)},ue=function(ge){var Se=z.width,Pe=c(ge);if(!!Pe){var me=[0,2,4,1,3,5];if(_)for(var xe=o===4,Fe=_(Pe),we=z._hardwareTexture,Ge=[0,1,2,3,4,5],Xe=0;Xe<Fe.length;Xe++){for(var Oe=Se>>Xe,je=[],ke=0;ke<6;ke++){var ze=Fe[Xe][Ge[ke]];xe&&(ze=lo(ze,Oe,Oe,a)),je.push(new Uint8Array(ze.buffer,ze.byteOffset,ze.byteLength))}D._textureHelper.updateCubeTextures(je,we.underlyingResource,Oe,Oe,we.format,V,!1,0,0,D._uploadEncoder)}else{for(var je=[],ke=0;ke<6;ke++)je.push(Pe[me[ke]]);D.updateRawCubeTexture(z,je,o,a,V)}z.isReady=!0,i==null||i._removePendingData(z),b&&b()}};return this._loadFile(e,function(ge){ue(ge)},void 0,i==null?void 0:i.offlineProvider,!0,q),z},t.prototype.createRawTexture2DArray=function(e,i,r,o,a,s,c,_,b,C){b===void 0&&(b=null),C===void 0&&(C=0);var x=gt.b.Raw2DArray,V=new gt.a(this,x);return V.baseWidth=i,V.baseHeight=r,V.baseDepth=o,V.width=i,V.height=r,V.depth=o,V.format=a,V.type=C,V.generateMipMaps=s,V.samplingMode=_,V.is2DArray=!0,this._doNotHandleContextLost||(V._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(V,i,r,o),this.updateRawTexture2DArray(V,e,a,c,b,C),this._internalTexturesCache.push(V),V},t.prototype.createRawTexture3D=function(e,i,r,o,a,s,c,_,b,C){b===void 0&&(b=null),C===void 0&&(C=0);var x=gt.b.Raw3D,V=new gt.a(this,x);return V.baseWidth=i,V.baseHeight=r,V.baseDepth=o,V.width=i,V.height=r,V.depth=o,V.format=a,V.type=C,V.generateMipMaps=s,V.samplingMode=_,V.is3D=!0,this._doNotHandleContextLost||(V._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(V,i,r),this.updateRawTexture3D(V,e,a,c,b,C),this._internalTexturesCache.push(V),V},t.prototype.generateMipMapsForCubemap=function(e,i){var r;if(i===void 0&&(i=!0),e.generateMipMaps){var o=(r=e._hardwareTexture)===null||r===void 0?void 0:r.underlyingResource;o||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e,e.source===gt.b.RenderTarget||e.source===gt.b.MultiRenderTarget?this._renderTargetEncoder:void 0)}},t.prototype.updateTextureSamplingMode=function(e,i,r){r===void 0&&(r=!1),r&&(i.generateMipMaps=!0,this._generateMipmaps(i)),i.samplingMode=e},t.prototype.updateTextureWrappingMode=function(e,i,r,o){r===void 0&&(r=null),o===void 0&&(o=null),i!==null&&(e._cachedWrapU=i,this._lastCachedWrapU=i),r!==null&&(e._cachedWrapV=r,this._lastCachedWrapV=r),(e.is2DArray||e.is3D)&&o!==null&&(e._cachedWrapR=o,this._lastCachedWrapR=o)},t.prototype.updateTextureDimensions=function(e,i,r,o){o===void 0&&(o=1),!!e._hardwareTexture&&(e.width===i&&e.height===r&&e.depth===o||(e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,i,r,o)))},t.prototype._setInternalTexture=function(e,i,r,o){if(o===void 0&&(o=0),r=r!=null?r:e,this._currentEffect){var a=this._currentEffect._pipelineContext;if(a.textures[e])a.textures[e].texture!==i&&(a.bindGroupsCache.values={}),a.textures[e].texture=i;else{var s=a.shaderProcessingContext.availableSamplers[r];s&&(a.samplers[r]={samplerBinding:s.sampler.bindingIndex,firstTextureName:e},a.textures[e]={textureBinding:s.textures[o].bindingIndex,texture:i})}}},t.prototype.setTexture=function(e,i,r,o){this._setTexture(e,r,!1,!1,o,o)},t.prototype.setTextureArray=function(e,i,r,o){for(var a=0;a<r.length;a++)this._setTexture(-1,r[a],!0,!1,o+a.toString(),o,a)},t.prototype._setTexture=function(e,i,r,o,a,s,c){if(r===void 0&&(r=!1),o===void 0&&(o=!1),a===void 0&&(a=""),c===void 0&&(c=0),s=s!=null?s:a,this._currentEffect){var _=this._currentEffect._pipelineContext;if(!i)return _.textures[a]&&_.textures[a].texture&&(_.bindGroupsCache.values={}),_.textures[a]=null,!1;if(i.video)i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;var b=null;if(o?b=i.depthStencilTexture:i.isReady()?b=i.getInternalTexture():i.isCube?b=this.emptyCubeTexture:i.is3D?b=this.emptyTexture3D:i.is2DArray?b=this.emptyTexture2DArray:b=this.emptyTexture,b&&!b.isMultiview){if(b.isCube&&b._cachedCoordinatesMode!==i.coordinatesMode){b._cachedCoordinatesMode=i.coordinatesMode;var C=i.coordinatesMode!==3&&i.coordinatesMode!==5?1:0;i.wrapU=C,i.wrapV=C}b._cachedWrapU=i.wrapU,this._lastCachedWrapU!==i.wrapU&&(this._lastCachedWrapU=i.wrapU),b._cachedWrapV=i.wrapV,this._lastCachedWrapV!==i.wrapV&&(this._lastCachedWrapV=i.wrapV),b._cachedWrapR=i.wrapR,b.is3D&&this._lastCachedWrapR!==i.wrapR&&(this._lastCachedWrapR=i.wrapR),this._setAnisotropicLevel(0,b,i.anisotropicFilteringLevel)}this._setInternalTexture(a,b,s,c)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",i));return!0},t.prototype._setAnisotropicLevel=function(e,i,r){i._cachedAnisotropicFilteringLevel!==r&&(i._cachedAnisotropicFilteringLevel=Math.min(r,this._caps.maxAnisotropy))},t.prototype._bindTexture=function(e,i,r){e!==void 0&&(i&&(this._lastCachedWrapU!==null&&(i._cachedWrapU=this._lastCachedWrapU),this._lastCachedWrapV!==null&&(i._cachedWrapV=this._lastCachedWrapV),this._lastCachedWrapR!==null&&(i._cachedWrapR=this._lastCachedWrapR)),this._setInternalTexture(r,i))},t.prototype._generateMipmaps=function(e,i){var r,o=(r=e._hardwareTexture)===null||r===void 0?void 0:r.underlyingResource;if(!!o){i=i!=null?i:this._currentRenderTarget&&!this._currentRenderPass?this._renderTargetEncoder:this._currentRenderPass?this._uploadEncoder:this._renderEncoder;var a=e._hardwareTexture.format,s=so.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - generate mipmaps called - width=",e.width,"height=",e.height,"isCube=",e.isCube)),e.isCube?this._textureHelper.generateCubeMipmaps(o,a,s,i):this._textureHelper.generateMipmaps(o,a,s,0,i)}},t.prototype.updateDynamicTexture=function(e,i,r,o,a,s){var c=this,_;if(o===void 0&&(o=!1),!!e){var b=i.width,C=i.height,x=e._hardwareTexture;((_=e._hardwareTexture)===null||_===void 0?void 0:_.underlyingResource)||(x=this._textureHelper.createGPUTextureForInternalTexture(e,b,C)),createImageBitmap(i).then(function(V){c._textureHelper.updateTexture(V,x.underlyingResource,b,C,e.depth,x.format,0,0,r,o,0,0,c._uploadEncoder),e.generateMipMaps&&c._generateMipmaps(e,c._uploadEncoder),e.isReady=!0})}},t.prototype.updateTextureData=function(e,i,r,o,a,s,c,_){var b;c===void 0&&(c=0),_===void 0&&(_=0);var C=e._hardwareTexture;((b=e._hardwareTexture)===null||b===void 0?void 0:b.underlyingResource)||(C=this._textureHelper.createGPUTextureForInternalTexture(e));var x=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(x,C.underlyingResource,a,s,e.depth,C.format,c,_,e.invertY,!1,r,o,this._uploadEncoder)},t.prototype.updateVideoTexture=function(e,i,r){var o=this,a;if(!(!e||e._isDisabled)){this._videoTextureSupported===void 0&&(this._videoTextureSupported=!0);var s=e._hardwareTexture;((a=e._hardwareTexture)===null||a===void 0?void 0:a.underlyingResource)||(s=this._textureHelper.createGPUTextureForInternalTexture(e)),createImageBitmap(i).then(function(c){o._textureHelper.updateTexture(c,s.underlyingResource,e.width,e.height,e.depth,s.format,0,0,!r,!1,0,0,o._uploadEncoder),e.generateMipMaps&&o._generateMipmaps(e,o._uploadEncoder),e.isReady=!0}).catch(function(c){e.isReady=!0})}},t.prototype._uploadCompressedDataToTextureDirectly=function(e,i,r,o,a,s,c){var _;s===void 0&&(s=0),c===void 0&&(c=0);var b=e._hardwareTexture;((_=e._hardwareTexture)===null||_===void 0?void 0:_.underlyingResource)||(e.format=i,b=this._textureHelper.createGPUTextureForInternalTexture(e,r,o));var C=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);this._textureHelper.updateTexture(C,b.underlyingResource,r,o,e.depth,b.format,s,c,!1,!1,0,0,this._uploadEncoder)},t.prototype._uploadDataToTextureDirectly=function(e,i,r,o,a,s){var c;r===void 0&&(r=0),o===void 0&&(o=0),s===void 0&&(s=!1);var _=Math.round(Math.log(e.width)*Math.LOG2E),b=Math.round(Math.log(e.height)*Math.LOG2E),C=s?e.width:Math.pow(2,Math.max(_-o,0)),x=s?e.height:Math.pow(2,Math.max(b-o,0)),V=e._hardwareTexture;((c=e._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource)||(V=this._textureHelper.createGPUTextureForInternalTexture(e,C,x));var D=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(D,V.underlyingResource,C,x,e.depth,V.format,r,o,e.invertY,!1,0,0,this._uploadEncoder)},t.prototype._uploadArrayBufferViewToTexture=function(e,i,r,o){r===void 0&&(r=0),o===void 0&&(o=0),this._uploadDataToTextureDirectly(e,i,r,o)},t.prototype._uploadImageToTexture=function(e,i,r,o){var a;r===void 0&&(r=0),o===void 0&&(o=0);var s=e._hardwareTexture;((a=e._hardwareTexture)===null||a===void 0?void 0:a.underlyingResource)||(s=this._textureHelper.createGPUTextureForInternalTexture(e));var c=i,_=Math.ceil(e.width/(1<<o)),b=Math.ceil(e.height/(1<<o));this._textureHelper.updateTexture(c,s.underlyingResource,_,b,e.depth,s.format,r,o,e.invertY,!1,0,0,this._uploadEncoder)},t.prototype.updateRawTexture=function(e,i,r,o,a,s){if(a===void 0&&(a=null),s===void 0&&(s=0),!!e){if(this._doNotHandleContextLost||(e._bufferView=i,e.invertY=o,e._compression=a),i){var c=e._hardwareTexture,_=r===4;_&&(i=lo(i,e.width,e.height,s));var b=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(b,c.underlyingResource,e.width,e.height,e.depth,c.format,0,0,o,!1,0,0,this._uploadEncoder),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},t.prototype.updateRawCubeTexture=function(e,i,r,o,a,s,c){s===void 0&&(s=null),c===void 0&&(c=0),e._bufferViewArray=i,e.invertY=a,e._compression=s;for(var _=e._hardwareTexture,b=r===4,C=[],x=0;x<i.length;++x){var V=i[x];b&&(V=lo(i[x],e.width,e.height,o)),C.push(new Uint8Array(V.buffer,V.byteOffset,V.byteLength))}this._textureHelper.updateCubeTextures(C,_.underlyingResource,e.width,e.height,_.format,a,!1,0,0,this._uploadEncoder),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0},t.prototype.updateRawTexture2DArray=function(e,i,r,o,a,s){if(a===void 0&&(a=null),s===void 0&&(s=0),this._doNotHandleContextLost||(e._bufferView=i,e.format=r,e.invertY=o,e._compression=a),i){var c=e._hardwareTexture,_=r===4;_&&(i=lo(i,e.width,e.height,s));var b=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(b,c.underlyingResource,e.width,e.height,e.depth,c.format,0,0,o,!1,0,0,this._uploadEncoder),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},t.prototype.updateRawTexture3D=function(e,i,r,o,a,s){if(a===void 0&&(a=null),s===void 0&&(s=0),this._doNotHandleContextLost||(e._bufferView=i,e.format=r,e.invertY=o,e._compression=a),i){var c=e._hardwareTexture,_=r===4;_&&(i=lo(i,e.width,e.height,s));var b=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(b,c.underlyingResource,e.width,e.height,e.depth,c.format,0,0,o,!1,0,0,this._uploadEncoder),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},t.prototype.readPixels=function(e,i,r,o,a,s){a===void 0&&(a=!0),s===void 0&&(s=!0);var c=this._rttRenderPassWrapper.renderPass?this._rttRenderPassWrapper:this._mainRenderPassWrapper,_=c.colorAttachmentGPUTextures[0].underlyingResource,b=c.colorAttachmentGPUTextures[0].format;return _?(s&&this.flushFramebuffer(),this._textureHelper.readPixels(_,e,i,r,o,b)):Promise.resolve(new Uint8Array(0))},t.prototype._readTexturePixels=function(e,i,r,o,a,s,c){o===void 0&&(o=-1),a===void 0&&(a=0),s===void 0&&(s=null),c===void 0&&(c=!0);var _=e._hardwareTexture;return c&&this.flushFramebuffer(),this._textureHelper.readPixels(_.underlyingResource,0,0,i,r,_.format,o,a,s)},t.prototype._readTexturePixelsSync=function(e,i,r,o,a,s,c){throw o===void 0&&(o=-1),a===void 0&&(a=0),s===void 0&&(s=null),c===void 0&&(c=!0),"_readTexturePixelsSync is unsupported in WebGPU!"},t.prototype.createRenderTargetTexture=function(e,i){var r,o=new wl.a;i!==void 0&&typeof i=="object"?(o.generateMipMaps=i.generateMipMaps,o.generateDepthBuffer=i.generateDepthBuffer===void 0?!0:i.generateDepthBuffer,o.generateStencilBuffer=o.generateDepthBuffer&&i.generateStencilBuffer,o.type=i.type===void 0?0:i.type,o.samplingMode=i.samplingMode===void 0?3:i.samplingMode,o.format=i.format===void 0?5:i.format,o.samples=(r=i.samples)!==null&&r!==void 0?r:1):(o.generateMipMaps=i,o.generateDepthBuffer=!0,o.generateStencilBuffer=!1,o.type=0,o.samplingMode=3,o.format=5,o.samples=1);var a=new gt.a(this,gt.b.RenderTarget),s=e.width||e,c=e.height||e,_=e.layers||0;return a._depthStencilBuffer={},a._framebuffer={},a.baseWidth=s,a.baseHeight=c,a.width=s,a.height=c,a.depth=_,a.isReady=!0,a.samples=o.samples,a.generateMipMaps=!!o.generateMipMaps,a.samplingMode=o.samplingMode,a.type=o.type,a.format=o.format,a._generateDepthBuffer=o.generateDepthBuffer,a._generateStencilBuffer=!!o.generateStencilBuffer,a.is2DArray=_>0,this._internalTexturesCache.push(a),(a._generateDepthBuffer||a._generateStencilBuffer)&&(a._depthStencilTexture=this.createDepthStencilTexture({width:s,height:c,layers:_},{bilinearFiltering:o.samplingMode===void 0||o.samplingMode===2||o.samplingMode===2||o.samplingMode===3||o.samplingMode===3||o.samplingMode===5||o.samplingMode===6||o.samplingMode===7||o.samplingMode===11,comparisonFunction:0,generateStencil:a._generateStencilBuffer,isCube:a.isCube,samples:a.samples})),i!==void 0&&typeof i=="object"&&i.createMipMaps&&!o.generateMipMaps&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a),i!==void 0&&typeof i=="object"&&i.createMipMaps&&!o.generateMipMaps&&(a.generateMipMaps=!1),a},t.prototype.createMultipleRenderTarget=function(e,i){var r=!1,o=!0,a=!1,s=!1,c=1,_=0,b=3,C=new Array,x=new Array;i!==void 0&&(r=i.generateMipMaps===void 0?!1:i.generateMipMaps,o=i.generateDepthBuffer===void 0?!0:i.generateDepthBuffer,a=i.generateStencilBuffer===void 0?!1:i.generateStencilBuffer,s=i.generateDepthTexture===void 0?!1:i.generateDepthTexture,c=i.textureCount||1,i.types&&(C=i.types),i.samplingModes&&(x=i.samplingModes));var V=e.width||e,D=e.height||e,z=null;(o||a||s)&&(z=this.createDepthStencilTexture({width:V,height:D},{bilinearFiltering:!1,comparisonFunction:0,generateStencil:a,isCube:!1,samples:1}));for(var q=[],ue=[],ge=0;ge<c;ge++){var Se=x[ge]||b,Pe=C[ge]||_;(Pe===1&&!this._caps.textureFloatLinearFiltering||Pe===2&&!this._caps.textureHalfFloatLinearFiltering)&&(Se=1),Pe===1&&!this._caps.textureFloat&&(Pe=0,d.a.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var me=new gt.a(this,gt.b.MultiRenderTarget);q.push(me),ue.push(ge+1),me._depthStencilTexture=ge===0?z:null,me._framebuffer={},me._depthStencilBuffer={},me.baseWidth=V,me.baseHeight=D,me.width=V,me.height=D,me.isReady=!0,me.samples=1,me.generateMipMaps=r,me.samplingMode=Se,me.type=Pe,me._generateDepthBuffer=o,me._generateStencilBuffer=!!a,me._attachments=ue,me._textureArray=q,this._internalTexturesCache.push(me),this._textureHelper.createGPUTextureForInternalTexture(me)}return z&&(q.push(z),this._internalTexturesCache.push(z)),q},t.prototype.createRenderTargetCubeTexture=function(e,i){var r=Object(p.a)({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1},i);r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer;var o=new gt.a(this,gt.b.RenderTarget);return o.width=e,o.height=e,o.depth=0,o.isReady=!0,o.isCube=!0,o.samples=r.samples,o.generateMipMaps=r.generateMipMaps,o.samplingMode=r.samplingMode,o.type=r.type,o.format=r.format,o._generateDepthBuffer=r.generateDepthBuffer,o._generateStencilBuffer=r.generateStencilBuffer,this._internalTexturesCache.push(o),(o._generateDepthBuffer||o._generateStencilBuffer)&&(o._depthStencilTexture=this.createDepthStencilTexture({width:o.width,height:o.height,layers:o.depth},{bilinearFiltering:r.samplingMode===void 0||r.samplingMode===2||r.samplingMode===2||r.samplingMode===3||r.samplingMode===3||r.samplingMode===5||r.samplingMode===6||r.samplingMode===7||r.samplingMode===11,comparisonFunction:0,generateStencil:o._generateStencilBuffer,isCube:o.isCube,samples:o.samples})),i&&i.createMipMaps&&!r.generateMipMaps&&(o.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(o),i&&i.createMipMaps&&!r.generateMipMaps&&(o.generateMipMaps=!1),o},t.prototype._setupDepthStencilTexture=function(e,i,r,o,a,s){s===void 0&&(s=1);var c=i.width||i,_=i.height||i,b=i.layers||0;e.baseWidth=c,e.baseHeight=_,e.width=c,e.height=_,e.is2DArray=b>0,e.depth=b,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e._generateDepthBuffer=!0,e._generateStencilBuffer=r,e.samplingMode=o?2:1,e.type=0,e._comparisonFunction=a},t.prototype._createDepthStencilTexture=function(e,i){var r=new gt.a(this,gt.b.Depth),o=Object(p.a)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1},i);return r.format=o.generateStencil?13:14,this._setupDepthStencilTexture(r,e,o.generateStencil,o.bilinearFiltering,o.comparisonFunction,o.samples),this._textureHelper.createGPUTextureForInternalTexture(r),r},t.prototype._createDepthStencilCubeTexture=function(e,i){var r=new gt.a(this,gt.b.Depth);r.isCube=!0;var o=Object(p.a)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1},i);return r.format=o.generateStencil?13:14,this._setupDepthStencilTexture(r,e,o.generateStencil,o.bilinearFiltering,o.comparisonFunction,o.samples),this._textureHelper.createGPUTextureForInternalTexture(r),r},t.prototype.updateRenderTargetTextureSampleCount=function(e,i){return!e||e.samples===i||(i=Math.min(i,this.getCaps().maxMSAASamples),i>1&&(i=4),this._textureHelper.createMSAATexture(e,i),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,i),e._depthStencilTexture.samples=i),e.samples=i),i},t.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,i){if(!e||e[0].samples===i)return i;i=Math.min(i,this.getCaps().maxMSAASamples),i>1&&(i=4);for(var r=0;r<e.length;++r){var o=e[r];this._textureHelper.createMSAATexture(o,i),o.samples=i}return i},t.prototype.beginFrame=function(){n.prototype.beginFrame.call(this)},t.prototype.endFrame=function(){if(this._endMainRenderPass(),this.flushFramebuffer(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - counters - numBindGroupsCreation=",this._counters.numBindGroupsCreation)),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){var e=[];for(var i in Fr.a._updatedUbosInFrame)e.push(i+":"+Fr.a._updatedUbosInFrame[i]);console.log("frame #"+this._count+" - updated ubos -",e.join(", "))}Fr.a._updatedUbosInFrame={}}this._counters.numBindGroupsCreation=0,this._cacheRenderPipeline.endFrame(),this._pendingDebugCommands.length=0,n.prototype.endFrame.call(this),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - end","background: #ffff00"),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - begin","background: #ffff00")))},t.prototype.flushFramebuffer=function(){var e=0;this._currentRenderPass&&(this._currentRenderTarget?this._currentRenderPass&&(e=1,this._endRenderTargetRenderPass()):(e=2,this._endMainRenderPass())),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderTargetEncoder.finish(),this._commandBuffers[2]=this._renderEncoder.finish(),this._device.defaultQueue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._textureHelper.setCommandEncoder(this._uploadEncoder),e===1?this._startRenderTargetRenderPass(this._currentRenderTarget,null,null,!1,!1):e===2&&this._startMainRenderPass(!1)},t.prototype._startRenderTargetRenderPass=function(e,i,r,o,a){var s=e._hardwareTexture,c=s.underlyingResource,_=e._depthStencilTexture,b=_==null?void 0:_._hardwareTexture,C=b==null?void 0:b.underlyingResource,x=b==null?void 0:b.msaaTexture,V=C==null?void 0:C.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),D=x==null?void 0:x.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),z=[];if(e._attachments&&e._textureArray){for(var q=0;q<e._attachments.length;++q){var ue=e._attachments[q],ge=e._textureArray[ue-1],Se=ge==null?void 0:ge._hardwareTexture,Pe=Se==null?void 0:Se.underlyingResource;if(Se&&Pe){var me=Object(p.a)(Object(p.a)({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{format:Se.format}),xe=Se.msaaTexture,Fe=Pe.createView(me),we=xe==null?void 0:xe.createView(me),Ge=q===0?i||Gi.Load:r||Gi.Load;z.push({attachment:we||Fe,resolveTarget:xe?Fe:void 0,loadValue:Ge,storeOp:Sr.Store})}}this._mrtAttachments=e._attachments,this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments,e._textureArray)}else{var xe=s.msaaTexture,Fe=c.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),we=xe==null?void 0:xe.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor);z.push({attachment:we||Fe,resolveTarget:xe?Fe:void 0,loadValue:i!==null?i:Gi.Load,storeOp:Sr.Store})}this._debugPushGroup("render target pass",1),this._rttRenderPassWrapper.renderPassDescriptor={colorAttachments:z,depthStencilAttachment:_&&C?{attachment:D||V,depthLoadValue:o&&_._generateDepthBuffer?this._clearDepthValue:Gi.Load,depthStoreOp:Sr.Store,stencilLoadValue:a&&_._generateStencilBuffer?this._clearStencilValue:Gi.Load,stencilStoreOp:Sr.Store}:void 0},this._rttRenderPassWrapper.renderPass=this._renderTargetEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target begin pass - internalTexture.uniqueId=",e.uniqueId,this._rttRenderPassWrapper.renderPassDescriptor)),this._currentRenderPass=this._rttRenderPassWrapper.renderPass,this._debugFlushPendingCommands(),this._resetCurrentViewport(1),this._resetCurrentScissor(1)},t.prototype._endRenderTargetRenderPass=function(){var e;this._currentRenderPass&&(this._currentRenderPass.endPass(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target end pass - internalTexture.uniqueId=",(e=this._currentRenderTarget)===null||e===void 0?void 0:e.uniqueId)),this._debugPopGroup(1),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._currentRenderPass=null,this._rttRenderPassWrapper.reset())},t.prototype._getCurrentRenderPass=function(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,null,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass},t.prototype._startMainRenderPass=function(e,i,r,o){this._mainRenderPassWrapper.renderPass&&this._endMainRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreater();var a=this._scissorIsActive();if(e){var s=a?Gi.Load:i||Gi.Load,c=a?Gi.Load:r?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:Gi.Load,_=a?Gi.Load:o?this._clearStencilValue:Gi.Load;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadValue=s,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadValue=c,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadValue=_}if(this._swapChainTexture=this._swapChain.getCurrentTexture(),this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(this._swapChainTexture),this._options.antialiasing?this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=this._swapChainTexture.createView():this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].attachment=this._swapChainTexture.createView(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height,this._mainRenderPassWrapper.renderPassDescriptor)),this._debugPushGroup("main pass",0),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._mainRenderPassWrapper.renderPass=this._currentRenderPass,this._debugFlushPendingCommands(),this._resetCurrentViewport(0),this._resetCurrentScissor(0),e&&a){this._applyScissor(this._currentRenderPass);var b=this._device.createRenderPipeline(Object(p.a)({sampleCount:this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount,primitiveTopology:ki.TriangleStrip,vertexState:{indexFormat:Gr.Uint16},depthStencilState:this._depthTextureFormat===void 0?void 0:{depthWriteEnabled:r,depthCompare:ti.Always,format:this._depthTextureFormat,stencilFront:{compare:o?ti.Always:ti.Never,passOp:o?ir.Replace:ir.Keep},stencilReadMask:255,stencilWriteMask:o?255:0},colorStates:[{format:this._colorFormat,writeMask:i?Go.All:0}]},this._shaderManager.getCompiledShaders("clearQuad"))),C=b.getBindGroupLayout(0),x=this._bufferManager.createBuffer(4*4,Fi.CopyDst|Fi.Uniform);if(i){var V=new Float32Array([i.r,i.g,i.b,i.a]);this._bufferManager.setSubData(x,0,V)}var D=this._device.createBindGroup({layout:C,entries:[{binding:0,resource:{buffer:x.underlyingResource}}]});this._currentRenderPass.setStencilReference(this._clearStencilValue),this._currentRenderPass.setPipeline(b),this._currentRenderPass.setBindGroup(0,D),this._currentRenderPass.draw(4,1,0,0),this._stencilState.stencilTest&&this._getCurrentRenderPass().setStencilReference(this._stencilState.stencilFuncRef),this._bufferManager.releaseBuffer(x)}},t.prototype._endMainRenderPass=function(){this._mainRenderPassWrapper.renderPass!==null&&(this._mainRenderPassWrapper.renderPass.endPass(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main end pass")),this._debugPopGroup(0),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._mainRenderPassWrapper.renderPass===this._currentRenderPass&&(this._currentRenderPass=null),this._mainRenderPassWrapper.reset(!1))},t.prototype.restoreSingleAttachment=function(){},t.prototype.buildTextureLayout=function(e){for(var i=[],r=0;r<e.length;r++)e[r]?i.push(r+1):i.push(0);return i},t.prototype.bindAttachments=function(e){},t.prototype.bindFramebuffer=function(e,i,r,o,a,s,c){i===void 0&&(i=0),s===void 0&&(s=0),c===void 0&&(c=0);var _=e._hardwareTexture,b=_==null?void 0:_.underlyingResource;if(!_||!b){this.dbgSanityChecks&&console.error("bindFramebuffer: Trying to bind a texture that does not have a hardware texture or that has a webgpu texture empty!",e,_,b);return}this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=_,this._rttRenderPassWrapper.depthTextureFormat=this._currentRenderTarget._depthStencilTexture?so.GetWebGPUTextureFormat(-1,this._currentRenderTarget._depthStencilTexture.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:Oi.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?c*6+i:c,baseMipLevel:s,arrayLayerCount:1,aspect:qr.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:Oi.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?c*6+i:c,baseMipLevel:0,arrayLayerCount:1,aspect:qr.All},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - bindFramebuffer called - face=",i,"lodLevel=",s,"layer=",c,this._rttRenderPassWrapper.colorAttachmentViewDescriptor,this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),this._currentRenderPass=null,this._cachedViewport&&!a?this.setViewport(this._cachedViewport,r,o):(r||(r=e.width,s&&(r=r/Math.pow(2,s))),o||(o=e.height,s&&(o=o/Math.pow(2,s))),this._viewport(0,0,r,o)),this.wipeCaches()},t.prototype.unBindFramebuffer=function(e,i,r){i===void 0&&(i=!1),Qp(this._currentRenderTarget===null||this._currentRenderTarget!==null&&e===this._currentRenderTarget,"unBindFramebuffer - the texture we want to unbind is not the same than the currentRenderTarget! texture="+e+", this._currentRenderTarget="+this._currentRenderTarget);var o=this._currentRenderTarget;this._currentRenderTarget=null,r&&r(),this._currentRenderTarget=o,this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass(),e.generateMipMaps&&!i&&!e.isCube&&this._generateMipmaps(e),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments,[]),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)},t.prototype.unBindMultiColorAttachmentFramebuffer=function(e,i,r){i===void 0&&(i=!1),r&&r();var o=e[0]._attachments,a=o.length;this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass();for(var s=0;s<a;s++){var c=e[s];c.generateMipMaps&&!i&&!c.isCube&&this._generateMipmaps(c)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments,[]),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)},t.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):(this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)),this._currentRenderPass&&this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},t.prototype._setColorFormat=function(e){var i=e.colorAttachmentGPUTextures[0].format;this._cacheRenderPipeline.setColorFormat(i),this._colorFormat!==i&&(this._colorFormat=i)},t.prototype._setDepthTextureFormat=function(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)},t.prototype.setDitheringState=function(e){},t.prototype.setRasterizerState=function(e){},t.prototype.setState=function(e,i,r,o){i===void 0&&(i=0),o===void 0&&(o=!1),(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e);var a=this.cullBackFaces?1:2;(this._depthCullingState.cullFace!==a||r)&&(this._depthCullingState.cullFace=a),this.setZOffset(i);var s=o?1:2;(this._depthCullingState.frontFace!==s||r)&&(this._depthCullingState.frontFace=s)},t.prototype.setAlphaMode=function(e,i){if(i===void 0&&(i=!1),this._alphaMode!==e){switch(e){case G.a.ALPHA_DISABLE:this._alphaState.alphaBlend=!1;break;case G.a.ALPHA_PREMULTIPLIED:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_PREMULTIPLIED_PORTERDUFF:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_COMBINE:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_ONEONE:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_ADD:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_SUBTRACT:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_MULTIPLY:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_MAXIMIZED:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_INTERPOLATE:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case G.a.ALPHA_SCREENMODE:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break}i||(this.setDepthWrite(e===G.a.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(e===G.a.ALPHA_DISABLE)),this._alphaMode=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}},t.prototype.setAlphaEquation=function(e){n.prototype.setAlphaEquation.call(this,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)},t.prototype._getBindGroupsToRender=function(){var e,i=this._currentEffect._pipelineContext;i.uniformBuffer&&(this.bindUniformBufferBase(i.uniformBuffer.getBuffer(),0,"LeftOver"),i.uniformBuffer.update());for(var r=i.bindGroupsCache,o=0;o<i.shaderProcessingContext.uniformBufferNames.length;++o){var a=i.shaderProcessingContext.uniformBufferNames[o],s=this._uniformsBuffers[a].uniqueId,c=r.values[s];c||(c=new Vl,r.values[s]=c),r=c}var _=r.bindGroups;if(_)return _;_=[],r.bindGroups=_,this._counters.numBindGroupsCreation++;for(var b=i.bindGroupLayouts,o=0;o<i.shaderProcessingContext.orderedUBOsAndSamplers.length;o++){var C=i.shaderProcessingContext.orderedUBOsAndSamplers[o];if(C===void 0){var x=b[o];_[o]=this._device.createBindGroup({layout:x,entries:[]});continue}for(var V=[],D=0;D<C.length;D++){var z=i.shaderProcessingContext.orderedUBOsAndSamplers[o][D];if(z!==void 0)if(z.isSampler){var q=i.samplers[z.name];if(q){var ue=(e=i.textures[q.firstTextureName])===null||e===void 0?void 0:e.texture;if(!ue){d.a.Error('Could not create the gpu sampler "'+z.name+'" because no texture can be looked up for the name "'+q.firstTextureName+'". bindingInfo='+JSON.stringify(q)+", webgpuPipelineContext.textures="+i.textures,50);continue}V.push({binding:q.samplerBinding,resource:this._cacheSampler.getSampler(ue)})}else d.a.Error('Sampler "'+z.name+'" could not be bound. bindingDefinition='+JSON.stringify(z)+", webgpuPipelineContext.samplers="+JSON.stringify(i.samplers),50)}else if(z.isTexture){var q=i.textures[z.name];if(q){if(this.dbgSanityChecks&&q.texture===null){d.a.Error("Trying to bind a null texture! bindingDefinition="+JSON.stringify(z)+", bindingInfo="+JSON.stringify(q,function(Fe,we){return Fe==="texture"?"<no dump>":we}),50);continue}var ge=q.texture._hardwareTexture;if(this.dbgSanityChecks&&!ge.view){d.a.Error("Trying to bind a null gpu texture! bindingDefinition="+JSON.stringify(z)+", bindingInfo="+JSON.stringify(q,function(Fe,we){return Fe==="texture"?"<no dump>":we})+", isReady="+q.texture.isReady,50);continue}V.push({binding:q.textureBinding,resource:ge.view})}else d.a.Error('Texture "'+z.name+'" could not be bound. bindingDefinition='+JSON.stringify(z)+", webgpuPipelineContext.textures="+JSON.stringify(i.textures,function(Fe,we){return Fe==="texture"?"<no dump>":we}),50)}else{var Se=this._uniformsBuffers[z.name];if(Se){var Pe=Se.underlyingResource;V.push({binding:D,resource:{buffer:Pe,offset:0,size:Se.capacity}})}else d.a.Error('UBO "'+z.name+". bindingDefinition="+JSON.stringify(z)+", _uniformsBuffers="+JSON.stringify(this._uniformsBuffers),50)}}if(V.length>0){var x=b[o];_[o]=this._device.createBindGroup({layout:x,entries:V})}}return _},t.prototype._bindVertexInputs=function(){var e,i=this._bundleEncoder||this._getCurrentRenderPass();this._currentIndexBuffer&&i.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?Gr.Uint32:Gr.Uint16,0);for(var r=this._currentEffect._pipelineContext,o=r.shaderProcessingContext.attributeNamesFromEffect,a=0;a<o.length;a++){var s=(e=this._currentOverrideVertexBuffers&&this._currentOverrideVertexBuffers[o[a]])!==null&&e!==void 0?e:this._currentVertexBuffers[o[a]];s||(s=this._emptyVertexBuffer);var c=s.getBuffer();c&&i.setVertexBuffer(a,c.underlyingResource,s.byteOffset)}},t.prototype._setRenderBindGroups=function(e){for(var i=this._bundleEncoder||this._getCurrentRenderPass(),r=0;r<e.length;r++)i.setBindGroup(r,e[r])},t.prototype._setRenderPipeline=function(e){var i=this._bundleEncoder||this._getCurrentRenderPass(),r=this._cacheRenderPipeline.getRenderPipeline(e,this._currentEffect,this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount);i.setPipeline(r),this._bindVertexInputs();var o=this._getBindGroupsToRender();this._setRenderBindGroups(o),this._stencilState.stencilTest&&i!==this._bundleEncoder&&this._getCurrentRenderPass().setStencilReference(this._stencilState.stencilFuncRef),this._alphaState.alphaBlend&&i!==this._bundleEncoder&&this._getCurrentRenderPass().setBlendColor(this._alphaState._blendConstants),i!==this._bundleEncoder&&(this._applyViewport(i),this._applyScissor(i))},t.prototype.drawElementsType=function(e,i,r,o){o===void 0&&(o=1);var a=this._bundleEncoder||this._getCurrentRenderPass();this._setRenderPipeline(e),a.drawIndexed(r,o||1,i,0,0),this._reportDrawCall()},t.prototype.drawArraysType=function(e,i,r,o){o===void 0&&(o=1);var a=this._bundleEncoder||this._getCurrentRenderPass();this._currentIndexBuffer=null,this._setRenderPipeline(e),a.draw(r,o||1,i,0),this._reportDrawCall()},t.prototype.startRecordBundle=function(){this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:[De.BGRA8Unorm],depthStencilFormat:De.Depth24PlusStencil8,sampleCount:this._mainPassSampleCount})},t.prototype.stopRecordBundle=function(){var e=this._bundleEncoder.finish();return this._bundleEncoder=null,e},t.prototype.executeBundles=function(e){var i=this._getCurrentRenderPass();i.executeBundles(e)},t.prototype.dispose=function(){this._mainTexture&&this._mainTexture.destroy(),this._depthTexture&&this._depthTexture.destroy(),n.prototype.dispose.call(this)},t.prototype.getRenderWidth=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._canvas.width},t.prototype.getRenderHeight=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._canvas.height},t.prototype.getRenderingCanvas=function(){return this._canvas},t.prototype._debugPushGroup=function(e,i){if(!!this._options.enableGPUDebugMarkers)if(i===0||i===1){var r=i===0?this._renderEncoder:this._renderTargetEncoder;r.pushDebugGroup(e)}else this._currentRenderPass?this._currentRenderPass.pushDebugGroup(e):this._pendingDebugCommands.push(["push",e])},t.prototype._debugPopGroup=function(e){if(!!this._options.enableGPUDebugMarkers)if(e===0||e===1){var i=e===0?this._renderEncoder:this._renderTargetEncoder;i.popDebugGroup()}else this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null])},t.prototype._debugInsertMarker=function(e,i){if(!!this._options.enableGPUDebugMarkers)if(i===0||i===1){var r=i===0?this._renderEncoder:this._renderTargetEncoder;r.insertDebugMarker(e)}else this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e])},t.prototype._debugFlushPendingCommands=function(){for(var e=0;e<this._pendingDebugCommands.length;++e){var i=this._pendingDebugCommands[e],r=i[0],o=i[1];switch(r){case"push":this._debugPushGroup(o);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(o);break}}this._pendingDebugCommands.length=0},t.prototype.getError=function(){return 0},t.prototype.bindSamplers=function(e){},t.prototype._bindTextureDirectly=function(e,i,r,o){return r===void 0&&(r=!1),o===void 0&&(o=!1),!1},t.prototype._releaseFramebufferObjects=function(e){},t.prototype.applyStates=function(){},t.prototype.areAllEffectsReady=function(){return!0},t.prototype._executeWhenRenderingStateIsCompiled=function(e,i){i()},t.prototype._isRenderingStateCompiled=function(e){return!0},t.prototype._getUnpackAlignement=function(){return 1},t.prototype._unpackFlipY=function(e){},t.prototype._getSamplingParameters=function(e,i){throw"_getSamplingParameters is not available in WebGPU"},t.prototype.bindUniformBlock=function(e,i,r){},t.prototype.getUniforms=function(e,i){return[]},t.prototype.setIntArray=function(e,i){return!1},t.prototype.setIntArray2=function(e,i){return!1},t.prototype.setIntArray3=function(e,i){return!1},t.prototype.setIntArray4=function(e,i){return!1},t.prototype.setArray=function(e,i){return!1},t.prototype.setArray2=function(e,i){return!1},t.prototype.setArray3=function(e,i){return!1},t.prototype.setArray4=function(e,i){return!1},t.prototype.setMatrices=function(e,i){return!1},t.prototype.setMatrix3x3=function(e,i){return!1},t.prototype.setMatrix2x2=function(e,i){return!1},t.prototype.setFloat=function(e,i){return!1},t.prototype.setFloat2=function(e,i,r){return!1},t.prototype.setFloat3=function(e,i,r,o){return!1},t.prototype.setFloat4=function(e,i,r,o,a){return!1},t._glslangDefaultOptions={jsPath:"https://preview.babylonjs.com/glslang/glslang.js",wasmPath:"https://preview.babylonjs.com/glslang/glslang.wasm"},t}(G.a);function lo(n,t,e,i){var r;i===1?r=new Float32Array(t*e*4):r=new Uint32Array(t*e*4);for(var o=0;o<t;o++)for(var a=0;a<e;a++){var s=(a*t+o)*3,c=(a*t+o)*4;r[c+0]=n[s+0],r[c+1]=n[s+1],r[c+2]=n[s+2],r[c+3]=1}return r}var $l=u(683),uo=u(513),jr=u(477),c_=u(523),f_=u(457),ql="rgbdEncodePixelShader",eu=`
varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
void main(void)
{
gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);
}`;qe.a.ShadersStore[ql]=eu;var h_={name:ql,shader:eu},d_=u(625),tu=u(545),Wr=function(){function n(){}return n.GetEnvInfo=function(t){for(var e=new DataView(t.buffer,t.byteOffset,t.byteLength),i=0,r=0;r<n._MagicBytes.length;r++)if(e.getUint8(i++)!==n._MagicBytes[r])return d.a.Error("Not a babylon environment map"),null;for(var o="",a=0;a=e.getUint8(i++);)o+=String.fromCharCode(a);var s=JSON.parse(o);return s.specular&&(s.specular.specularDataPosition=i,s.specular.lodGenerationScale=s.specular.lodGenerationScale||.8),s},n.CreateEnvTextureAsync=function(t){return Object(p.b)(this,void 0,void 0,function(){var e,i,r,o,a,s,c,_,b,C,x,V,D,z,q,ue,ge,Se,_,C,Pe,me,xe,Fe,_,we,Ge,Xe,Oe,je,ke,_,_,C,ze;return Object(p.e)(this,function(Je){switch(Je.label){case 0:if(e=t.getInternalTexture(),!e)return[2,Promise.reject("The cube texture is invalid.")];if(i=e.getEngine(),t.textureType!==2&&t.textureType!==1&&t.textureType!==0&&t.textureType!==0&&t.textureType!==7&&t.textureType!==-1)return[2,Promise.reject("The cube texture should allow HDR (Full Float or Half Float).")];if(r=1,!i.getCaps().textureFloatRender&&(r=2,!i.getCaps().textureHalfFloatRender))return[2,Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.")];o=e.width,a=new ae.a(i),s={},i.flushFramebuffer(),c=$e.a.ILog2(e.width),_=0,Je.label=1;case 1:if(!(_<=c))return[3,9];b=Math.pow(2,c-_),C=0,Je.label=2;case 2:return C<6?[4,t.readPixels(C,_,void 0,!1)]:[3,8];case 3:if(x=Je.sent(),x&&x.byteLength===x.length){for(V=new Float32Array(x.byteLength*4),D=0;D<x.byteLength;D++)V[D]=x[D]/255,V[D]=Math.pow(V[D],2.2);x=V}return z=i.createRawTexture(x,b,b,5,!1,!0,1,null,r),[4,tu.a.EncodeTextureToRGBD(z,a,r)];case 4:return Je.sent(),[4,i._readTexturePixels(z,b,b)];case 5:return q=Je.sent(),[4,re.b.DumpDataAsync(b,b,q,"image/png",void 0,!1,!0)];case 6:ue=Je.sent(),s[_*6+C]=ue,z.dispose(),Je.label=7;case 7:return C++,[3,2];case 8:return _++,[3,1];case 9:for(a.dispose(),ge={version:1,width:o,irradiance:this._CreateEnvTextureIrradiance(t),specular:{mipmaps:[],lodGenerationScale:t.lodGenerationScale}},Se=0,_=0;_<=c;_++)for(C=0;C<6;C++)Pe=s[_*6+C].byteLength,ge.specular.mipmaps.push({length:Pe,position:Se}),Se+=Pe;for(me=JSON.stringify(ge),xe=new ArrayBuffer(me.length+1),Fe=new Uint8Array(xe),_=0,we=me.length;_<we;_++)Fe[_]=me.charCodeAt(_);for(Fe[me.length]=0,Ge=n._MagicBytes.length+Se+xe.byteLength,Xe=new ArrayBuffer(Ge),Oe=new Uint8Array(Xe),je=new DataView(Xe),ke=0,_=0;_<n._MagicBytes.length;_++)je.setUint8(ke++,n._MagicBytes[_]);for(Oe.set(new Uint8Array(xe),ke),ke+=xe.byteLength,_=0;_<=c;_++)for(C=0;C<6;C++)ze=s[_*6+C],Oe.set(new Uint8Array(ze),ke),ke+=ze.byteLength;return[2,Xe]}})})},n._CreateEnvTextureIrradiance=function(t){var e=t.sphericalPolynomial;return e==null?null:{x:[e.x.x,e.x.y,e.x.z],y:[e.y.x,e.y.y,e.y.z],z:[e.z.x,e.z.y,e.z.z],xx:[e.xx.x,e.xx.y,e.xx.z],yy:[e.yy.x,e.yy.y,e.yy.z],zz:[e.zz.x,e.zz.y,e.zz.z],yz:[e.yz.x,e.yz.y,e.yz.z],zx:[e.zx.x,e.zx.y,e.zx.z],xy:[e.xy.x,e.xy.y,e.xy.z]}},n.CreateImageDataArrayBufferViews=function(t,e){if(e.version!==1)throw new Error('Unsupported babylon environment map version "'+e.version+'"');var i=e.specular,r=$e.a.Log2(e.width);if(r=Math.round(r)+1,i.mipmaps.length!==6*r)throw new Error('Unsupported specular mipmaps number "'+i.mipmaps.length+'"');for(var o=new Array(r),a=0;a<r;a++){o[a]=new Array(6);for(var s=0;s<6;s++){var c=i.mipmaps[a*6+s];o[a][s]=new Uint8Array(t.buffer,t.byteOffset+i.specularDataPosition+c.position,c.length)}}return o},n.UploadEnvLevelsAsync=function(t,e,i){if(i.version!==1)throw new Error('Unsupported babylon environment map version "'+i.version+'"');var r=i.specular;if(!r)return Promise.resolve();t._lodGenerationScale=r.lodGenerationScale;var o=n.CreateImageDataArrayBufferViews(e,i);return n.UploadLevelsAsync(t,o)},n._OnImageReadyAsync=function(t,e,i,r,o,a,s,c,_,b,C){return new Promise(function(x,V){if(i){var D=e.createTexture(null,!0,!0,null,1,null,function(q){V(q)},t);r.getEffect().executeWhenCompiled(function(){r.onApply=function(q){q._bindTexture("textureSampler",D),q.setFloat2("scale",1,e._features.needsInvertingBitmap&&t instanceof ImageBitmap?-1:1)},!!e.scenes.length&&(e.scenes[0].postProcessManager.directRender([r],b,!0,a,s),e.restoreDefaultFramebuffer(),D.dispose(),URL.revokeObjectURL(o),x())})}else{if(e._uploadImageToTexture(C,t,a,s),c){var z=_[s];z&&e._uploadImageToTexture(z._texture,t,a,0)}x()}})},n.UploadLevelsAsync=function(t,e){var i=this;if(!re.b.IsExponentOfTwo(t.width))throw new Error("Texture size must be a power of two");var r=$e.a.ILog2(t.width)+1,o=t.getEngine(),a=!1,s=!1,c=null,_=null,b=null,C=o.getCaps();if(t.format=5,t.type=0,t.generateMipMaps=!0,t._cachedAnisotropicFilteringLevel=null,o.updateTextureSamplingMode(3,t),C.textureLOD?o._features.supportRenderAndCopyToLodForFloatTextures?C.textureHalfFloatRender&&C.textureHalfFloatLinearFiltering?(a=!0,t.type=2):C.textureFloatRender&&C.textureFloatLinearFiltering&&(a=!0,t.type=1):a=!1:(a=!1,s=!0,b={}),a)c=new ii.a("rgbdDecode","rgbdDecode",null,null,1,null,3,o,!1,void 0,t.type,void 0,null,!1),t._isRGBD=!1,t.invertY=!1,_=o.createRenderTargetCubeTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:t.type,format:5});else if(t._isRGBD=!0,t.invertY=!0,s)for(var x=3,V=t._lodGenerationScale,D=t._lodGenerationOffset,z=0;z<x;z++){var q=z/(x-1),ue=1-q,ge=D,Se=(r-1)*V+D,Pe=ge+(Se-ge)*ue,me=Math.round(Math.min(Math.max(Pe,0),Se)),xe=new gt.a(o,gt.b.Temp);xe.isCube=!0,xe.invertY=!0,xe.generateMipMaps=!1,o.updateTextureSamplingMode(2,xe);var Fe=new jr.a(null);switch(Fe.isCube=!0,Fe._texture=xe,b[me]=Fe,z){case 0:t._lodTextureLow=Fe;break;case 1:t._lodTextureMid=Fe;break;case 2:t._lodTextureHigh=Fe;break}}for(var we=[],Ge=function(ze){for(var Je=function(Ke){var St=e[ze][Ke],Mt=new Blob([St],{type:"image/png"}),Rt=URL.createObjectURL(Mt),at=void 0;if(typeof Image=="undefined"||o._features.forceBitmapOverHTMLImageElement)at=createImageBitmap(Mt,{premultiplyAlpha:"none"}).then(function(Wt){return i._OnImageReadyAsync(Wt,o,a,c,Rt,Ke,ze,s,b,_,t)});else{var Bt=new Image;Bt.src=Rt,at=new Promise(function(Wt,lt){Bt.onload=function(){i._OnImageReadyAsync(Bt,o,a,c,Rt,Ke,ze,s,b,_,t).then(function(){return Wt()}).catch(function(Ft){lt(Ft)})},Bt.onerror=function(Ft){lt(Ft)}})}we.push(at)},it=0;it<6;it++)Je(it)},z=0;z<e.length;z++)Ge(z);if(e.length<r){var Xe=void 0,Oe=Math.pow(2,r-1-e.length),je=Oe*Oe*4;switch(t.type){case 0:{Xe=new Uint8Array(je);break}case 2:{Xe=new Uint16Array(je);break}case 1:{Xe=new Float32Array(je);break}}for(var z=e.length;z<r;z++)for(var ke=0;ke<6;ke++)o._uploadArrayBufferViewToTexture(t,Xe,ke,z)}return Promise.all(we).then(function(){_&&(o._releaseFramebufferObjects(_),o._releaseTexture(t),_._swapAndDie(t)),c&&c.dispose(),s&&(t._lodTextureHigh&&t._lodTextureHigh._texture&&(t._lodTextureHigh._texture.isReady=!0),t._lodTextureMid&&t._lodTextureMid._texture&&(t._lodTextureMid._texture.isReady=!0),t._lodTextureLow&&t._lodTextureLow._texture&&(t._lodTextureLow._texture.isReady=!0))})},n.UploadEnvSpherical=function(t,e){e.version!==1&&d.a.Warn('Unsupported babylon environment map version "'+e.version+'"');var i=e.irradiance;if(!!i){var r=new uo.b;l.e.FromArrayToRef(i.x,0,r.x),l.e.FromArrayToRef(i.y,0,r.y),l.e.FromArrayToRef(i.z,0,r.z),l.e.FromArrayToRef(i.xx,0,r.xx),l.e.FromArrayToRef(i.yy,0,r.yy),l.e.FromArrayToRef(i.zz,0,r.zz),l.e.FromArrayToRef(i.yz,0,r.yz),l.e.FromArrayToRef(i.zx,0,r.zx),l.e.FromArrayToRef(i.xy,0,r.xy),t._sphericalPolynomial=r}},n._UpdateRGBDAsync=function(t,e,i,r,o){return t._source=gt.b.CubeRawRGBD,t._bufferViewArrayArray=e,t._lodGenerationScale=r,t._lodGenerationOffset=o,t._sphericalPolynomial=i,n.UploadLevelsAsync(t,e).then(function(){t.isReady=!0})},n._MagicBytes=[134,22,135,150,246,214,150,54],n}();gt.a._UpdateRGBDAsync=Wr._UpdateRGBDAsync;var Zp=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.postProcessor=function(e,i,r,o,a){if(e=n.prototype.postProcessor.call(this,e,i,r,o,a),!r&&!a.homogeneousDepth){var s=e.lastIndexOf("}");e=e.substring(0,s),e+="gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0; }"}return e},t}($l.a),Jp=function(){function n(t){this.isAsync=!1,this.isReady=!1,this._valueCache={},this.engine=t}return n.prototype._getVertexShaderCode=function(){return null},n.prototype._getFragmentShaderCode=function(){return null},n.prototype._handlesSpectorRebuildCallback=function(t){throw new Error("Not implemented")},n.prototype._fillEffectInformation=function(t,e,i,r,o,a,s,c){var _=this.engine;if(_.supportsUniformBuffers)for(var b in e)t.bindUniformBlock(b,e[b]);var C=this.engine.getUniforms(this,i);C.forEach(function(D,z){r[i[z]]=D}),this._uniforms=r;var x;for(x=0;x<o.length;x++){var V=t.getUniform(o[x]);V==null&&(o.splice(x,1),x--)}o.forEach(function(D,z){a[D]=z}),c.push.apply(c,_.getAttributes(this,s))},n.prototype.dispose=function(){this._uniforms={}},n.prototype._cacheMatrix=function(t,e){var i=this._valueCache[t],r=e.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[t]=r,!0)},n.prototype._cacheFloat2=function(t,e,i){var r=this._valueCache[t];if(!r)return r=[e,i],this._valueCache[t]=r,!0;var o=!1;return r[0]!==e&&(r[0]=e,o=!0),r[1]!==i&&(r[1]=i,o=!0),o},n.prototype._cacheFloat3=function(t,e,i,r){var o=this._valueCache[t];if(!o)return o=[e,i,r],this._valueCache[t]=o,!0;var a=!1;return o[0]!==e&&(o[0]=e,a=!0),o[1]!==i&&(o[1]=i,a=!0),o[2]!==r&&(o[2]=r,a=!0),a},n.prototype._cacheFloat4=function(t,e,i,r,o){var a=this._valueCache[t];if(!a)return a=[e,i,r,o],this._valueCache[t]=a,!0;var s=!1;return a[0]!==e&&(a[0]=e,s=!0),a[1]!==i&&(a[1]=i,s=!0),a[2]!==r&&(a[2]=r,s=!0),a[3]!==o&&(a[3]=o,s=!0),s},n.prototype.setInt=function(t,e){var i=this._valueCache[t];i!==void 0&&i===e||this.engine.setInt(this._uniforms[t],e)&&(this._valueCache[t]=e)},n.prototype.setInt2=function(t,e,i){this._cacheFloat2(t,e,i)&&(this.engine.setInt2(this._uniforms[t],e,i)||(this._valueCache[t]=null))},n.prototype.setInt3=function(t,e,i,r){this._cacheFloat3(t,e,i,r)&&(this.engine.setInt3(this._uniforms[t],e,i,r)||(this._valueCache[t]=null))},n.prototype.setInt4=function(t,e,i,r,o){this._cacheFloat4(t,e,i,r,o)&&(this.engine.setInt4(this._uniforms[t],e,i,r,o)||(this._valueCache[t]=null))},n.prototype.setIntArray=function(t,e){this._valueCache[t]=null,this.engine.setIntArray(this._uniforms[t],e)},n.prototype.setIntArray2=function(t,e){this._valueCache[t]=null,this.engine.setIntArray2(this._uniforms[t],e)},n.prototype.setIntArray3=function(t,e){this._valueCache[t]=null,this.engine.setIntArray3(this._uniforms[t],e)},n.prototype.setIntArray4=function(t,e){this._valueCache[t]=null,this.engine.setIntArray4(this._uniforms[t],e)},n.prototype.setFloatArray=function(t,e){this._valueCache[t]=null,this.engine.setFloatArray(this._uniforms[t],e)},n.prototype.setFloatArray2=function(t,e){this._valueCache[t]=null,this.engine.setFloatArray2(this._uniforms[t],e)},n.prototype.setFloatArray3=function(t,e){this._valueCache[t]=null,this.engine.setFloatArray3(this._uniforms[t],e)},n.prototype.setFloatArray4=function(t,e){this._valueCache[t]=null,this.engine.setFloatArray4(this._uniforms[t],e)},n.prototype.setArray=function(t,e){this._valueCache[t]=null,this.engine.setArray(this._uniforms[t],e)},n.prototype.setArray2=function(t,e){this._valueCache[t]=null,this.engine.setArray2(this._uniforms[t],e)},n.prototype.setArray3=function(t,e){this._valueCache[t]=null,this.engine.setArray3(this._uniforms[t],e)},n.prototype.setArray4=function(t,e){this._valueCache[t]=null,this.engine.setArray4(this._uniforms[t],e)},n.prototype.setMatrices=function(t,e){!e||(this._valueCache[t]=null,this.engine.setMatrices(this._uniforms[t],e))},n.prototype.setMatrix=function(t,e){this._cacheMatrix(t,e)&&(this.engine.setMatrices(this._uniforms[t],e.toArray())||(this._valueCache[t]=null))},n.prototype.setMatrix3x3=function(t,e){this._valueCache[t]=null,this.engine.setMatrix3x3(this._uniforms[t],e)},n.prototype.setMatrix2x2=function(t,e){this._valueCache[t]=null,this.engine.setMatrix2x2(this._uniforms[t],e)},n.prototype.setFloat=function(t,e){var i=this._valueCache[t];i!==void 0&&i===e||this.engine.setFloat(this._uniforms[t],e)&&(this._valueCache[t]=e)},n.prototype.setBool=function(t,e){var i=this._valueCache[t];i!==void 0&&i===e||this.engine.setInt(this._uniforms[t],e?1:0)&&(this._valueCache[t]=e?1:0)},n.prototype.setVector2=function(t,e){this._cacheFloat2(t,e.x,e.y)&&(this.engine.setFloat2(this._uniforms[t],e.x,e.y)||(this._valueCache[t]=null))},n.prototype.setFloat2=function(t,e,i){this._cacheFloat2(t,e,i)&&(this.engine.setFloat2(this._uniforms[t],e,i)||(this._valueCache[t]=null))},n.prototype.setVector3=function(t,e){this._cacheFloat3(t,e.x,e.y,e.z)&&(this.engine.setFloat3(this._uniforms[t],e.x,e.y,e.z)||(this._valueCache[t]=null))},n.prototype.setFloat3=function(t,e,i,r){this._cacheFloat3(t,e,i,r)&&(this.engine.setFloat3(this._uniforms[t],e,i,r)||(this._valueCache[t]=null))},n.prototype.setVector4=function(t,e){this._cacheFloat4(t,e.x,e.y,e.z,e.w)&&(this.engine.setFloat4(this._uniforms[t],e.x,e.y,e.z,e.w)||(this._valueCache[t]=null))},n.prototype.setFloat4=function(t,e,i,r,o){this._cacheFloat4(t,e,i,r,o)&&(this.engine.setFloat4(this._uniforms[t],e,i,r,o)||(this._valueCache[t]=null))},n.prototype.setColor3=function(t,e){this._cacheFloat3(t,e.r,e.g,e.b)&&(this.engine.setFloat3(this._uniforms[t],e.r,e.g,e.b)||(this._valueCache[t]=null))},n.prototype.setColor4=function(t,e,i){this._cacheFloat4(t,e.r,e.g,e.b,i)&&(this.engine.setFloat4(this._uniforms[t],e.r,e.g,e.b,i)||(this._valueCache[t]=null))},n.prototype.setDirectColor4=function(t,e){this._cacheFloat4(t,e.r,e.g,e.b,e.a)&&(this.engine.setFloat4(this._uniforms[t],e.r,e.g,e.b,e.a)||(this._valueCache[t]=null))},n}(),iu=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t}(ns.a),ru=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getInternalTexture=function(){return this},t.prototype.getViewCount=function(){return 1},t}(gt.a),$p=function(n){Object(p.d)(t,n);function t(){var e=n.call(this,null)||this;return e._native=new _native.Engine,e.INVALID_HANDLE=65535,e._boundBuffersVertexArray=null,e._currentDepthTest=e._native.DEPTH_TEST_LEQUAL,e.homogeneousDepth=e._native.homogeneousDepth,e._webGLVersion=2,e.disableUniformBuffers=!0,e._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:512,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!0,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:1,canUseGLInstanceID:!0,canUseGLVertexID:!0},e._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,_collectUbosUpdatedInFrame:!1},re.b.Log("Babylon Native (v"+G.a.Version+") launched"),re.b.LoadScript=function(i,r,o,a){re.b.LoadFile(i,function(s){Function(s).apply(null),r&&r()},void 0,void 0,!1,function(s,c){o&&o("LoadScript Error",c)})},typeof URL=="undefined"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob=="undefined"&&(window.Blob=function(){}),e._shaderProcessor=new Zp,e}return t.prototype.getHardwareScalingLevel=function(){return this._native.getHardwareScalingLevel()},t.prototype.setHardwareScalingLevel=function(e){this._native.setHardwareScalingLevel(e)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._boundBuffersVertexArray&&this._native.deleteVertexArray(this._boundBuffersVertexArray),this._native.dispose()},t.prototype._queueNewFrame=function(e,i){return i.requestAnimationFrame&&i!==window?i.requestAnimationFrame(e):this._native.requestAnimationFrame(e),0},t.prototype._bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&this._native.unbindFramebuffer(this._currentFramebuffer),e&&this._native.bindFramebuffer(e),this._currentFramebuffer=e)},t.prototype.getHostDocument=function(){return null},t.prototype.clear=function(e,i,r,o){if(o===void 0&&(o=!1),this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._native.clear(i?e:null,r?1:void 0,o?0:void 0)},t.prototype.createIndexBuffer=function(e,i){var r=this._normalizeIndexData(e),o=new iu;if(o.references=1,o.is32Bits=r.BYTES_PER_ELEMENT===4,r.length){if(o.nativeIndexBuffer=this._native.createIndexBuffer(r,i!=null?i:!1),o.nativeVertexBuffer===this.INVALID_HANDLE)throw new Error("Could not create a native index buffer.")}else o.nativeVertexBuffer=this.INVALID_HANDLE;return o},t.prototype.createVertexBuffer=function(e,i){var r=new iu;if(r.references=1,r.nativeVertexBuffer=this._native.createVertexBuffer(ArrayBuffer.isView(e)?e:new Float32Array(e),i!=null?i:!1),r.nativeVertexBuffer===this.INVALID_HANDLE)throw new Error("Could not create a native vertex buffer.");return r},t.prototype._recordVertexArrayObject=function(e,i,r,o){r&&this._native.recordIndexBuffer(e,r.nativeIndexBuffer);for(var a=o.getAttributesNames(),s=0;s<a.length;s++){var c=o.getAttributeLocation(s);if(c>=0){var _=a[s],b=i[_];if(b){var C=b.getBuffer();C&&this._native.recordVertexBuffer(e,C.nativeVertexBuffer,c,b.byteOffset,b.byteStride,b.getSize(),this._getNativeAttribType(b.type),b.normalized)}}}},t.prototype.bindBuffers=function(e,i,r){this._boundBuffersVertexArray&&this._native.deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._native.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,i,r),this._native.bindVertexArray(this._boundBuffersVertexArray)},t.prototype.recordVertexArrayObject=function(e,i,r){var o=this._native.createVertexArray();return this._recordVertexArrayObject(o,e,i,r),o},t.prototype.bindVertexArrayObject=function(e){this._native.bindVertexArray(e)},t.prototype.releaseVertexArrayObject=function(e){this._native.deleteVertexArray(e)},t.prototype.getAttributes=function(e,i){var r=e;return this._native.getAttributes(r.nativeProgram,i)},t.prototype.drawElementsType=function(e,i,r,o){this._drawCalls.addCount(1,!1),this._native.drawIndexed(e,i,r)},t.prototype.drawArraysType=function(e,i,r,o){this._drawCalls.addCount(1,!1),this._native.draw(e,i,r)},t.prototype.createPipelineContext=function(){return new Jp(this)},t.prototype._preparePipelineContext=function(e,i,r,o,a,s,c,_,b){var C=e;o?C.nativeProgram=this.createRawShaderProgram(e,i,r,void 0,b):C.nativeProgram=this.createShaderProgram(e,i,r,_,void 0,b)},t.prototype._isRenderingStateCompiled=function(e){return!0},t.prototype._executeWhenRenderingStateIsCompiled=function(e,i){i()},t.prototype.createRawShaderProgram=function(e,i,r,o,a){throw a===void 0&&(a=null),new Error("Not Supported")},t.prototype.createShaderProgram=function(e,i,r,o,a,s){s===void 0&&(s=null),this.onBeforeShaderCompilationObservable.notifyObservers(this);var c=new zo.a(i);c.processCode(),i=c.code;var _=new zo.a(r);_.processCode(),r=_.code,i=fn.a._ConcatenateShader(i,o),r=fn.a._ConcatenateShader(r,o);var b=this._native.createProgram(i,r);return this.onAfterShaderCompilationObservable.notifyObservers(this),b},t.prototype._setProgram=function(e){this._currentProgram!==e&&(this._native.setProgram(e),this._currentProgram=e)},t.prototype._releaseEffect=function(e){},t.prototype._deletePipelineContext=function(e){},t.prototype.getUniforms=function(e,i){var r=e;return this._native.getUniforms(r.nativeProgram,i)},t.prototype.bindUniformBlock=function(e,i,r){throw new Error("Not Implemented")},t.prototype.bindSamplers=function(e){var i=e.getPipelineContext();this._setProgram(i.nativeProgram);for(var r=e.getSamplers(),o=0;o<r.length;o++){var a=e.getUniform(r[o]);a&&(this._boundUniforms[o]=a)}this._currentEffect=null},t.prototype.setMatrix=function(e,i){!e||this._native.setMatrix(e,i.toArray())},t.prototype.getRenderWidth=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._native.getRenderWidth()},t.prototype.getRenderHeight=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._native.getRenderHeight()},t.prototype.setViewport=function(e,i,r){this._cachedViewport=e,this._native.setViewPort(e.x,e.y,e.width,e.height)},t.prototype.setState=function(e,i,r,o){i===void 0&&(i=0),o===void 0&&(o=!1),this._native.setState(e,i,this.cullBackFaces,o)},t.prototype.getInputElementClientRect=function(){var e={bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth()};return e},t.prototype.setZOffset=function(e){this._native.setZOffset(e)},t.prototype.getZOffset=function(){return this._native.getZOffset()},t.prototype.setDepthBuffer=function(e){this._native.setDepthTest(e?this._currentDepthTest:this._native.DEPTH_TEST_ALWAYS)},t.prototype.getDepthWrite=function(){return this._native.getDepthWrite()},t.prototype.setDepthFunctionToGreater=function(){this._currentDepthTest=this._native.DEPTH_TEST_GREATER,this._native.setDepthTest(this._currentDepthTest)},t.prototype.setDepthFunctionToGreaterOrEqual=function(){this._currentDepthTest=this._native.DEPTH_TEST_GEQUAL,this._native.setDepthTest(this._currentDepthTest)},t.prototype.setDepthFunctionToLess=function(){this._currentDepthTest=this._native.DEPTH_TEST_LESS,this._native.setDepthTest(this._currentDepthTest)},t.prototype.setDepthFunctionToLessOrEqual=function(){this._currentDepthTest=this._native.DEPTH_TEST_LEQUAL,this._native.setDepthTest(this._currentDepthTest)},t.prototype.setDepthWrite=function(e){this._native.setDepthWrite(e)},t.prototype.setColorWrite=function(e){this._native.setColorWrite(e),this._colorWrite=e},t.prototype.getColorWrite=function(){return this._colorWrite},t.prototype.setAlphaConstants=function(e,i,r,o){throw new Error("Setting alpha blend constant color not yet implemented.")},t.prototype.setAlphaMode=function(e,i){i===void 0&&(i=!1),this._alphaMode!==e&&(e=this._getNativeAlphaMode(e),this._native.setBlendMode(e),i||this.setDepthWrite(e===0),this._alphaMode=e)},t.prototype.getAlphaMode=function(){return this._alphaMode},t.prototype.setInt=function(e,i){return e?(this._native.setInt(e,i),!0):!1},t.prototype.setIntArray=function(e,i){return e?(this._native.setIntArray(e,i),!0):!1},t.prototype.setIntArray2=function(e,i){return e?(this._native.setIntArray2(e,i),!0):!1},t.prototype.setIntArray3=function(e,i){return e?(this._native.setIntArray3(e,i),!0):!1},t.prototype.setIntArray4=function(e,i){return e?(this._native.setIntArray4(e,i),!0):!1},t.prototype.setFloatArray=function(e,i){return e?(this._native.setFloatArray(e,i),!0):!1},t.prototype.setFloatArray2=function(e,i){return e?(this._native.setFloatArray2(e,i),!0):!1},t.prototype.setFloatArray3=function(e,i){return e?(this._native.setFloatArray3(e,i),!0):!1},t.prototype.setFloatArray4=function(e,i){return e?(this._native.setFloatArray4(e,i),!0):!1},t.prototype.setArray=function(e,i){return e?(this._native.setFloatArray(e,i),!0):!1},t.prototype.setArray2=function(e,i){return e?(this._native.setFloatArray2(e,i),!0):!1},t.prototype.setArray3=function(e,i){return e?(this._native.setFloatArray3(e,i),!0):!1},t.prototype.setArray4=function(e,i){return e?(this._native.setFloatArray4(e,i),!0):!1},t.prototype.setMatrices=function(e,i){return e?(this._native.setMatrices(e,i),!0):!1},t.prototype.setMatrix3x3=function(e,i){return e?(this._native.setMatrix3x3(e,i),!0):!1},t.prototype.setMatrix2x2=function(e,i){return e?(this._native.setMatrix2x2(e,i),!0):!1},t.prototype.setFloat=function(e,i){return e?(this._native.setFloat(e,i),!0):!1},t.prototype.setFloat2=function(e,i,r){return e?(this._native.setFloat2(e,i,r),!0):!1},t.prototype.setFloat3=function(e,i,r,o){return e?(this._native.setFloat3(e,i,r,o),!0):!1},t.prototype.setFloat4=function(e,i,r,o,a){return e?(this._native.setFloat4(e,i,r,o,a),!0):!1},t.prototype.setColor3=function(e,i){return e?(this._native.setFloat3(e,i.r,i.g,i.b),!0):!1},t.prototype.setColor4=function(e,i,r){return e?(this._native.setFloat4(e,i.r,i.g,i.b,r),!0):!1},t.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilState.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},t.prototype._createTexture=function(){return this._native.createTexture()},t.prototype._deleteTexture=function(e){e&&this._native.deleteTexture(e)},t.prototype.updateDynamicTexture=function(e,i,r,o,a){o===void 0&&(o=!1);var s="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYSURBVChTY/z//z8DPsAEpXGC4aCAgQEAGGMDDWwwgqsAAAAASUVORK5CYII=";this.createTexture("data:my_image_name",!0,r,null,Ze.a.BILINEAR_SAMPLINGMODE,void 0,void 0,s,e,t.TEXTUREFORMAT_RGBA,null,void 0)},t.prototype.createRawTexture=function(e,i,r,o,a,s,c,_,b){_===void 0&&(_=null),b===void 0&&(b=0);var C=new gt.a(this,gt.b.Raw);if(C.generateMipMaps=a,C.samplingMode=c,C.invertY=s,C.baseWidth=i,C.baseHeight=r,C.width=C.baseWidth,C.height=C.baseHeight,C._compression=_,C.type=b,this.updateRawTexture(C,e,o,s,_,b),C._hardwareTexture){var x=C._hardwareTexture.underlyingResource,V=this._getNativeSamplingMode(c);this._native.setTextureSampling(x,V)}return this._internalTexturesCache.push(C),C},t.prototype.updateRawTexture=function(e,i,r,o,a,s){if(a===void 0&&(a=null),s===void 0&&(s=0),!!e){if(i&&e._hardwareTexture){var c=e._hardwareTexture.underlyingResource;this._native.loadRawTexture(c,i,e.width,e.height,this._getNativeTextureFormat(r,s),e.generateMipMaps,e.invertY)}e.isReady=!0}},t.prototype.createTexture=function(e,i,r,o,a,s,c,_,b,C,x,V,D){var z=this;a===void 0&&(a=3),s===void 0&&(s=null),c===void 0&&(c=null),_===void 0&&(_=null),b===void 0&&(b=null),C===void 0&&(C=null),x===void 0&&(x=null),e=e||"";var q=e.substr(0,5)==="data:",ue=q&&e.indexOf(";base64,")!==-1,ge=b||new gt.a(this,gt.b.Url),Se=e;this._transformTextureUrl&&!ue&&!b&&!_&&(e=this._transformTextureUrl(e));for(var Pe=e.lastIndexOf("."),me=x||(Pe>-1?e.substring(Pe).toLowerCase():""),xe=null,Fe=0,we=G.a._TextureLoaders;Fe<we.length;Fe++){var Ge=we[Fe];if(Ge.canLoad(me)){xe=Ge;break}}o&&o._addPendingData(ge),ge.url=e,ge.generateMipMaps=!i,ge.samplingMode=a,ge.invertY=r,this.doNotHandleContextLost||(ge._buffer=_);var Xe=null;s&&!b&&(Xe=ge.onLoadedObservable.add(s)),b||this._internalTexturesCache.push(ge);var Oe=function(ke,ze){o&&o._removePendingData(ge),e===Se?(Xe&&ge.onLoadedObservable.remove(Xe),Kt.a.UseFallbackTexture&&z.createTexture(Kt.a.FallbackTexture,i,ge.invertY,o,a,null,c,_,ge),c&&c((ke||"Unknown error")+(Kt.a.UseFallbackTexture?" - Fallback texture was used":""),ze)):(d.a.Warn("Failed to load "+e+", falling back to "+Se),z.createTexture(Se,i,ge.invertY,o,a,s,c,_,ge,C,x,V,D))};if(xe)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");var je=function(ke){if(!ge._hardwareTexture){o&&o._removePendingData(ge);return}var ze=ge._hardwareTexture.underlyingResource;z._native.loadTexture(ze,ke,!i,r,function(){ge.baseWidth=z._native.getTextureWidth(ze),ge.baseHeight=z._native.getTextureHeight(ze),ge.width=ge.baseWidth,ge.height=ge.baseHeight,ge.isReady=!0;var Je=z._getNativeSamplingMode(a);z._native.setTextureSampling(ze,Je),o&&o._removePendingData(ge),ge.onLoadedObservable.notifyObservers(ge),ge.onLoadedObservable.clear()},function(){throw new Error("Could not load a native texture.")})};if(q&&_)if(_ instanceof ArrayBuffer)je(new Uint8Array(_));else if(ArrayBuffer.isView(_))je(_);else if(typeof _=="string")je(new Uint8Array(re.b.DecodeBase64(_)));else throw new Error("Unsupported buffer type");else ue?je(new Uint8Array(re.b.DecodeBase64(e))):this._loadFile(e,function(ke){return je(new Uint8Array(ke))},void 0,void 0,!0,function(ke,ze){Oe("Unable to load "+(ke&&ke.responseURL,ze))});return ge},t.prototype._createDepthStencilTexture=function(e,i){var r=new ru(this,gt.b.Depth),o=e.width||e,a=e.height||e,s=this._native.createFramebuffer(r._hardwareTexture.underlyingResource,o,a,this._native.TEXTURE_FORMAT_RGBA8,this._native.TEXTURE_LINEAR_LINEAR,!1,!0,!1);return r._framebuffer=s,r},t.prototype._releaseFramebufferObjects=function(e){e._framebuffer&&(this._native.deleteFramebuffer(e._framebuffer),e._framebuffer=null)},t.prototype.createCubeTexture=function(e,i,r,o,a,s,c,_,b,C,x,V){var D=this;a===void 0&&(a=null),s===void 0&&(s=null),_===void 0&&(_=null),b===void 0&&(b=!1),C===void 0&&(C=0),x===void 0&&(x=0),V===void 0&&(V=null);var z=V||new gt.a(this,gt.b.Cube);z.isCube=!0,z.url=e,z.generateMipMaps=!o,z._lodGenerationScale=C,z._lodGenerationOffset=x,this._doNotHandleContextLost||(z._extension=_,z._files=r);var q=e.lastIndexOf("."),ue=_||(q>-1?e.substring(q).toLowerCase():"");if(ue===".env"){var ge=function(me){var xe=Wr.GetEnvInfo(me);if(z.width=xe.width,z.height=xe.width,Wr.UploadEnvSpherical(z,xe),xe.version!==1)throw new Error('Unsupported babylon environment map version "'+xe.version+'"');var Fe=xe.specular;if(!Fe)throw new Error("Nothing else parsed so far");z._lodGenerationScale=Fe.lodGenerationScale;var we=Wr.CreateImageDataArrayBufferViews(me,xe);z.format=5,z.type=0,z.generateMipMaps=!0,z.getEngine().updateTextureSamplingMode(Ze.a.TRILINEAR_SAMPLINGMODE,z),z._isRGBD=!0,z.invertY=!0,D._native.loadCubeTextureWithMips(z._hardwareTexture.underlyingResource,we,function(){z.isReady=!0,a&&a()},function(){throw new Error("Could not load a native cube texture.")})};if(r&&r.length===6)throw new Error("Multi-file loading not allowed on env files.");var Se=function(me,xe){s&&me&&s(me.status+" "+me.statusText,xe)};this._loadFile(e,function(me){return ge(new Uint8Array(me))},void 0,void 0,!0,Se)}else{if(!r||r.length!==6)throw new Error("Cannot load cubemap because 6 files were not defined");var Pe=[r[0],r[3],r[1],r[4],r[2],r[5]];Promise.all(Pe.map(function(me){return re.b.LoadFileAsync(me).then(function(xe){return new Uint8Array(xe)})})).then(function(me){return new Promise(function(xe,Fe){D._native.loadCubeTexture(z._hardwareTexture.underlyingResource,me,!o,xe,Fe)})}).then(function(){z.isReady=!0,a&&a()},function(me){s&&s("Failed to load cubemap: "+me.message,me)})}return this._internalTexturesCache.push(z),z},t.prototype.createRenderTargetTexture=function(e,i){var r=new wl.a;i!==void 0&&typeof i=="object"?(r.generateMipMaps=i.generateMipMaps,r.generateDepthBuffer=i.generateDepthBuffer===void 0?!0:i.generateDepthBuffer,r.generateStencilBuffer=r.generateDepthBuffer&&i.generateStencilBuffer,r.type=i.type===void 0?0:i.type,r.samplingMode=i.samplingMode===void 0?3:i.samplingMode,r.format=i.format===void 0?5:i.format):(r.generateMipMaps=i,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.type=0,r.samplingMode=3,r.format=5),(r.type===1&&!this._caps.textureFloatLinearFiltering||r.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(r.samplingMode=1);var o=new ru(this,gt.b.RenderTarget),a=e.width||e,s=e.height||e;r.type===1&&!this._caps.textureFloat&&(r.type=0,d.a.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var c=this._native.createFramebuffer(o._hardwareTexture.underlyingResource,a,s,this._getNativeTextureFormat(r.format,r.type),r.samplingMode,!!r.generateStencilBuffer,r.generateDepthBuffer,!!r.generateMipMaps);return o._framebuffer=c,o.baseWidth=a,o.baseHeight=s,o.width=a,o.height=s,o.isReady=!0,o.samples=1,o.generateMipMaps=!!r.generateMipMaps,o.samplingMode=r.samplingMode,o.type=r.type,o.format=r.format,o._generateDepthBuffer=r.generateDepthBuffer,o._generateStencilBuffer=!!r.generateStencilBuffer,this._internalTexturesCache.push(o),o},t.prototype.updateTextureSamplingMode=function(e,i){if(i._hardwareTexture){var r=this._getNativeSamplingMode(e);this._native.setTextureSampling(i._hardwareTexture.underlyingResource,r)}i.samplingMode=e},t.prototype.bindFramebuffer=function(e,i,r,o,a){if(i)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(r||o)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");e._depthStencilTexture?this._bindUnboundFramebuffer(e._depthStencilTexture._framebuffer):this._bindUnboundFramebuffer(e._framebuffer)},t.prototype.unBindFramebuffer=function(e,i,r){i===void 0&&(i=!1),i&&d.a.Warn("Disabling mipmap generation not yet supported in NativeEngine. Ignoring."),r&&r(),this._bindUnboundFramebuffer(null)},t.prototype.createDynamicVertexBuffer=function(e){return this.createVertexBuffer(e,!0)},t.prototype.updateDynamicIndexBuffer=function(e,i,r){r===void 0&&(r=0);var o=e,a=this._normalizeIndexData(i);o.is32Bits=a.BYTES_PER_ELEMENT===4,this._native.updateDynamicIndexBuffer(o.nativeIndexBuffer,a,r)},t.prototype.updateDynamicVertexBuffer=function(e,i,r,o){var a=e,s=ArrayBuffer.isView(i)?i:new Float32Array(i);this._native.updateDynamicVertexBuffer(a.nativeVertexBuffer,s,r!=null?r:0,o!=null?o:s.byteLength)},t.prototype._setTexture=function(e,i,r,o){r===void 0&&(r=!1),o===void 0&&(o=!1);var a=this._boundUniforms[e];if(!a)return!1;if(!i)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._native.setTexture(a,null)),!1;if(i.video)this._activeChannel=e,i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;var s;return o?s=i.depthStencilTexture:i.isReady()?s=i.getInternalTexture():i.isCube?s=this.emptyCubeTexture:i.is3D?s=this.emptyTexture3D:i.is2DArray?s=this.emptyTexture2DArray:s=this.emptyTexture,this._activeChannel=e,!s||!s._hardwareTexture?!1:(this._native.setTextureWrapMode(s._hardwareTexture.underlyingResource,this._getAddressMode(i.wrapU),this._getAddressMode(i.wrapV),this._getAddressMode(i.wrapR)),this._updateAnisotropicLevel(i),this._native.setTexture(a,s._hardwareTexture.underlyingResource),!0)},t.prototype._updateAnisotropicLevel=function(e){var i=e.getInternalTexture(),r=e.anisotropicFilteringLevel;!i||!i._hardwareTexture||i._cachedAnisotropicFilteringLevel!==r&&(this._native.setTextureAnisotropicLevel(i._hardwareTexture.underlyingResource,r),i._cachedAnisotropicFilteringLevel=r)},t.prototype._getAddressMode=function(e){switch(e){case 1:return this._native.ADDRESS_MODE_WRAP;case 0:return this._native.ADDRESS_MODE_CLAMP;case 2:return this._native.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+e+".")}},t.prototype._bindTexture=function(e,i){var r=this._boundUniforms[e];if(!!r&&i&&i._hardwareTexture){var o=i._hardwareTexture.underlyingResource;this._native.setTexture(r,o)}},t.prototype._deleteBuffer=function(e){e.nativeIndexBuffer&&(this._native.deleteIndexBuffer(e.nativeIndexBuffer),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._native.deleteVertexBuffer(e.nativeVertexBuffer),delete e.nativeVertexBuffer)},t.prototype.releaseEffects=function(){},t.prototype._uploadCompressedDataToTextureDirectly=function(e,i,r,o,a,s,c){throw s===void 0&&(s=0),c===void 0&&(c=0),new Error("_uploadCompressedDataToTextureDirectly not implemented.")},t.prototype._uploadDataToTextureDirectly=function(e,i,r,o){throw r===void 0&&(r=0),o===void 0&&(o=0),new Error("_uploadDataToTextureDirectly not implemented.")},t.prototype._uploadArrayBufferViewToTexture=function(e,i,r,o){throw r===void 0&&(r=0),o===void 0&&(o=0),new Error("_uploadArrayBufferViewToTexture not implemented.")},t.prototype._uploadImageToTexture=function(e,i,r,o){throw r===void 0&&(r=0),o===void 0&&(o=0),new Error("_uploadArrayBufferViewToTexture not implemented.")},t.prototype._getNativeSamplingMode=function(e){switch(e){case 1:return this._native.TEXTURE_NEAREST_NEAREST;case 2:return this._native.TEXTURE_LINEAR_LINEAR;case 3:return this._native.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return this._native.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return this._native.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return this._native.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return this._native.TEXTURE_NEAREST_LINEAR;case 8:return this._native.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return this._native.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return this._native.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return this._native.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return this._native.TEXTURE_LINEAR_NEAREST;default:throw new Error("Unsupported sampling mode: "+e+".")}},t.prototype._getNativeTextureFormat=function(e,i){if(e==4&&i==0)return this._native.TEXTURE_FORMAT_RGB8;if(e==5&&i==0)return this._native.TEXTURE_FORMAT_RGBA8;if(e==5&&i==1)return this._native.TEXTURE_FORMAT_RGBA32F;throw new Error("Unsupported texture format or type: format "+e+", type "+i+".")},t.prototype._getNativeAlphaMode=function(e){switch(e){case 0:return this._native.ALPHA_DISABLE;case 1:return this._native.ALPHA_ADD;case 2:return this._native.ALPHA_COMBINE;case 3:return this._native.ALPHA_SUBTRACT;case 4:return this._native.ALPHA_MULTIPLY;case 5:return this._native.ALPHA_MAXIMIZED;case 6:return this._native.ALPHA_ONEONE;case 7:return this._native.ALPHA_PREMULTIPLIED;case 8:return this._native.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return this._native.ALPHA_INTERPOLATE;case 10:return this._native.ALPHA_SCREENMODE;default:throw new Error("Unsupported alpha mode: "+e+".")}},t.prototype._getNativeAttribType=function(e){switch(e){case Be.b.UNSIGNED_BYTE:return this._native.ATTRIB_TYPE_UINT8;case Be.b.SHORT:return this._native.ATTRIB_TYPE_INT16;case Be.b.FLOAT:return this._native.ATTRIB_TYPE_FLOAT;default:throw new Error("Unsupported attribute type: "+e+".")}},t}(G.a),qp=u(670),em=function(){function n(){}return n.CreateAsync=function(t,e){return as.IsSupported?as.CreateAsync(t,e):G.a.IsSupported?new Promise(function(i){i(new G.a(t,void 0,e))}):new Promise(function(i){i(new Qa.a(e))})},n}(),Wo=function(){function n(){}return n.COPY=1,n.CUT=2,n.PASTE=3,n}(),tm=function(){function n(t,e){this.type=t,this.event=e}return n.GetTypeFromCharacter=function(t){var e=t;switch(e){case 67:return Wo.COPY;case 86:return Wo.PASTE;case 88:return Wo.CUT;default:return-1}},n}(),nu=u(688),Mi=u(463),ss=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.controllerType=Li.DAYDREAM,i}return t.prototype.initControllerMesh=function(e,i){var r=this;Mi.a.ImportMesh("",t.MODEL_BASE_URL,t.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},t.prototype._handleButtonChange=function(e,i,r){if(e===0){var o=this.onTriggerStateChangedObservable;o&&o.notifyObservers(i)}else d.a.Warn("Unrecognized Daydream button index: "+e)},t.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",t.MODEL_FILENAME="generic.babylon",t.GAMEPAD_ID_PREFIX="Daydream",t}(Br);Ui._ControllerFactories.push({canCreate:function(n){return n.id.indexOf(ss.GAMEPAD_ID_PREFIX)===0},create:function(n){return new ss(n)}});var ls=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i._buttonIndexToObservableNameMap=["onPadStateChangedObservable","onTriggerStateChangedObservable"],i.controllerType=Li.GEAR_VR,i._calculatedPosition=new l.e(i.hand=="left"?-.15:.15,-.5,.25),i._disableTrackPosition(i._calculatedPosition),i}return t.prototype.initControllerMesh=function(e,i){var r=this;Mi.a.ImportMesh("",t.MODEL_BASE_URL,t.MODEL_FILENAME,e,function(o){var a=new st.a("",e);o[1].parent=a,o[1].position.z=-.15,r._defaultModel=a,r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},t.prototype._handleButtonChange=function(e,i,r){if(e<this._buttonIndexToObservableNameMap.length){var o=this._buttonIndexToObservableNameMap[e],a=this[o];a&&a.notifyObservers(i)}},t.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",t.MODEL_FILENAME="generic.babylon",t.GAMEPAD_ID_PREFIX="Gear VR",t}(Br);Ui._ControllerFactories.push({canCreate:function(n){return n.id.indexOf(ls.GAMEPAD_ID_PREFIX)===0||n.id.indexOf("Oculus Go")!==-1||n.id.indexOf("Vive Focus")!==-1},create:function(n){return new ls(n)}});var Ho=function(n){Object(p.d)(t,n);function t(e){return n.call(this,e)||this}return t.prototype.initControllerMesh=function(e,i){var r=this;Mi.a.ImportMesh("",t.MODEL_BASE_URL,t.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},t.prototype._handleButtonChange=function(e,i,r){console.log("Button id: "+e+"state: "),console.dir(i)},t.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",t.MODEL_FILENAME="generic.babylon",t}(Br);Ui._DefaultControllerFactory=function(n){return new Ho(n)};var us=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.onSecondaryTriggerStateChangedObservable=new g.c,i.onThumbRestChangedObservable=new g.c,i.controllerType=Li.OCULUS,i}return t.prototype.initControllerMesh=function(e,i){var r=this,o;this.hand==="left"?o=t.MODEL_LEFT_FILENAME:o=t.MODEL_RIGHT_FILENAME,Mi.a.ImportMesh("",t._IsQuest?t.QUEST_MODEL_BASE_URL:t.MODEL_BASE_URL,o,e,function(a){r._defaultModel=t._IsQuest?a[0]:a[1],r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},Object.defineProperty(t.prototype,"onAButtonStateChangedObservable",{get:function(){if(this.hand==="right")return this.onMainButtonStateChangedObservable;throw new Error("No A button on left hand")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBButtonStateChangedObservable",{get:function(){if(this.hand==="right")return this.onSecondaryButtonStateChangedObservable;throw new Error("No B button on left hand")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onXButtonStateChangedObservable",{get:function(){if(this.hand==="left")return this.onMainButtonStateChangedObservable;throw new Error("No X button on right hand")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onYButtonStateChangedObservable",{get:function(){if(this.hand==="left")return this.onSecondaryButtonStateChangedObservable;throw new Error("No Y button on right hand")},enumerable:!1,configurable:!0}),t.prototype._handleButtonChange=function(e,i,r){var o=i,a=this.hand==="right"?-1:1;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(o);return;case 1:!t._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[3].rotation.x=-o.value*.2,this._defaultModel.getChildren()[3].position.y=-o.value*.005,this._defaultModel.getChildren()[3].position.z=-o.value*.005),this.onTriggerStateChangedObservable.notifyObservers(o);return;case 2:!t._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[4].position.x=a*o.value*.0035),this.onSecondaryTriggerStateChangedObservable.notifyObservers(o);return;case 3:!t._IsQuest&&this._defaultModel&&(o.pressed?this._defaultModel.getChildren()[1].position.y=-.001:this._defaultModel.getChildren()[1].position.y=0),this.onMainButtonStateChangedObservable.notifyObservers(o);return;case 4:!t._IsQuest&&this._defaultModel&&(o.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),this.onSecondaryButtonStateChangedObservable.notifyObservers(o);return;case 5:this.onThumbRestChangedObservable.notifyObservers(o);return}},t.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",t.MODEL_LEFT_FILENAME="left.babylon",t.MODEL_RIGHT_FILENAME="right.babylon",t.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",t._IsQuest=!1,t}(Br);Ui._ControllerFactories.push({canCreate:function(n){return G.a.LastCreatedEngine&&G.a.LastCreatedEngine._vrDisplay&&G.a.LastCreatedEngine._vrDisplay.displayName==="Oculus Quest"&&(us._IsQuest=!0),n.id.indexOf("Oculus Touch")!==-1},create:function(n){return new us(n)}});var ou=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.controllerType=Li.VIVE,i._invertLeftStickY=!0,i}return t.prototype.initControllerMesh=function(e,i){var r=this;Mi.a.ImportMesh("",t.MODEL_BASE_URL,t.MODEL_FILENAME,e,function(o){r._defaultModel=o[1],r.attachToMesh(r._defaultModel),i&&i(r._defaultModel)})},Object.defineProperty(t.prototype,"onLeftButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRightButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMenuButtonStateChangedObservable",{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:!1,configurable:!0}),t.prototype._handleButtonChange=function(e,i,r){var o=i;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(o);return;case 1:this._defaultModel&&(this._defaultModel.getChildren()[6].rotation.x=-o.value*.15),this.onTriggerStateChangedObservable.notifyObservers(o);return;case 2:this.onMainButtonStateChangedObservable.notifyObservers(o);return;case 3:this._defaultModel&&(o.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),this.onSecondaryButtonStateChangedObservable.notifyObservers(o);return}},t.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",t.MODEL_FILENAME="wand.babylon",t}(Br);Ui._ControllerFactories.push({canCreate:function(n){return n.id.toLowerCase().indexOf("openvr")!==-1},create:function(n){return new ou(n)}});var im=function(){function n(){this.buttonMeshes={},this.axisMeshes={}}return n}(),ko=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i._mapping={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:qi.POINTING_POSE},i.onTrackpadChangedObservable=new g.c,i.onTrackpadValuesChangedObservable=new g.c,i.trackpad={x:0,y:0},i.controllerType=Li.WINDOWS,i._loadedMeshInfo=null,i}return Object.defineProperty(t.prototype,"onTriggerButtonStateChangedObservable",{get:function(){return this.onTriggerStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMenuButtonStateChangedObservable",{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onGripButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onThumbstickButtonStateChangedObservable",{get:function(){return this.onPadStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTouchpadButtonStateChangedObservable",{get:function(){return this.onTrackpadChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTouchpadValuesChangedObservable",{get:function(){return this.onTrackpadValuesChangedObservable},enumerable:!1,configurable:!0}),t.prototype._updateTrackpad=function(){this.browserGamepad.axes&&(this.browserGamepad.axes[2]!=this.trackpad.x||this.browserGamepad.axes[3]!=this.trackpad.y)&&(this.trackpad.x=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_X")],this.trackpad.y=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_Y")],this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad))},t.prototype.update=function(){if(n.prototype.update.call(this),this.browserGamepad.axes&&(this._updateTrackpad(),this._loadedMeshInfo))for(var e=0;e<this._mapping.axisMeshNames.length;e++)this._lerpAxisTransform(e,this.browserGamepad.axes[e])},t.prototype._handleButtonChange=function(e,i,r){var o=this._mapping.buttons[e];if(!!o){this._updateTrackpad();var a=this[this._mapping.buttonObservableNames[o]];a&&a.notifyObservers(i),this._lerpButtonTransform(o,i.value)}},t.prototype._lerpButtonTransform=function(e,i){if(!!this._loadedMeshInfo){var r=this._loadedMeshInfo.buttonMeshes[e];!r||!r.unpressed.rotationQuaternion||!r.pressed.rotationQuaternion||!r.value.rotationQuaternion||(l.b.SlerpToRef(r.unpressed.rotationQuaternion,r.pressed.rotationQuaternion,i,r.value.rotationQuaternion),l.e.LerpToRef(r.unpressed.position,r.pressed.position,i,r.value.position))}},t.prototype._lerpAxisTransform=function(e,i){if(!!this._loadedMeshInfo){var r=this._loadedMeshInfo.axisMeshes[e];if(!!r&&!(!r.min.rotationQuaternion||!r.max.rotationQuaternion||!r.value.rotationQuaternion)){var o=i*.5+.5;l.b.SlerpToRef(r.min.rotationQuaternion,r.max.rotationQuaternion,o,r.value.rotationQuaternion),l.e.LerpToRef(r.min.position,r.max.position,o,r.value.position)}}},t.prototype.initControllerMesh=function(e,i,r){var o=this;r===void 0&&(r=!1);var a,s;if(Mi.a.IsPluginForExtensionAvailable(".glb")){var c="default";if(this.id&&!r){var _=this.id.match(t.GAMEPAD_ID_PATTERN);c=_&&_[0]||c}this.hand==="left"?s=t.MODEL_LEFT_FILENAME:s=t.MODEL_RIGHT_FILENAME,a=t.MODEL_BASE_URL+c+"/"}else d.a.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models"),a=Ho.MODEL_BASE_URL,s=Ho.MODEL_FILENAME;Mi.a.ImportMesh("",a,s,e,function(b){o._loadedMeshInfo=o.processModel(e,b),!!o._loadedMeshInfo&&(o._defaultModel=o._loadedMeshInfo.rootNode,o.attachToMesh(o._defaultModel),i&&i(o._defaultModel))},null,function(b,C){d.a.Log(C),d.a.Warn("Failed to retrieve controller model from the remote server: "+a+s),r||o.initControllerMesh(b,i,!0)})},t.prototype.processModel=function(e,i){for(var r=null,o=new st.a(this.id+" "+this.hand,e),a=null,s=0;s<i.length;s++){var c=i[s];if(!c.parent){c.isPickable=!1,a=c;break}}return a?(a.setParent(o),r=this.createMeshInfo(o)):d.a.Warn("Could not find root node in model file."),r},t.prototype.createMeshInfo=function(e){var i=new im,r;for(i.rootNode=e,i.buttonMeshes={},i.axisMeshes={},r=0;r<this._mapping.buttons.length;r++){var o=this._mapping.buttonMeshNames[this._mapping.buttons[r]];if(!o){d.a.Log("Skipping unknown button at index: "+r+" with mapped name: "+this._mapping.buttons[r]);continue}var a=C(e,o);if(!a){d.a.Warn("Missing button mesh with name: "+o);continue}var s={index:r,value:x(a,"VALUE"),pressed:x(a,"PRESSED"),unpressed:x(a,"UNPRESSED")};s.value&&s.pressed&&s.unpressed?i.buttonMeshes[this._mapping.buttons[r]]=s:d.a.Warn("Missing button submesh under mesh with name: "+o+"(VALUE: "+!!s.value+", PRESSED: "+!!s.pressed+", UNPRESSED:"+!!s.unpressed+")")}for(r=0;r<this._mapping.axisMeshNames.length;r++){var c=this._mapping.axisMeshNames[r];if(!c){d.a.Log("Skipping unknown axis at index: "+r);continue}var _=C(e,c);if(!_){d.a.Warn("Missing axis mesh with name: "+c);continue}var b={index:r,value:x(_,"VALUE"),min:x(_,"MIN"),max:x(_,"MAX")};b.value&&b.min&&b.max?i.axisMeshes[r]=b:d.a.Warn("Missing axis submesh under mesh with name: "+c+"(VALUE: "+!!b.value+", MIN: "+!!b.min+", MAX:"+!!b.max+")")}return i.pointingPoseNode=C(e,this._mapping.pointingPoseMeshName),i.pointingPoseNode?this._pointingPoseNode=i.pointingPoseNode:d.a.Warn("Missing pointing pose mesh with name: "+this._mapping.pointingPoseMeshName),i;function C(V,D){return V.getChildren(function(z){return z.name===D},!1)[0]}function x(V,D){return V.getChildren(function(z){return z.name==D},!0)[0]}},t.prototype.getForwardRay=function(e){if(e===void 0&&(e=100),!(this._loadedMeshInfo&&this._loadedMeshInfo.pointingPoseNode))return n.prototype.getForwardRay.call(this,e);var i=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix(),r=i.getTranslation(),o=new l.e(0,0,-1),a=l.e.TransformNormal(o,i),s=l.e.Normalize(a);return new Jt.a(r,s,e)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onTrackpadChangedObservable.clear(),this.onTrackpadValuesChangedObservable.clear()},t.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",t.MODEL_LEFT_FILENAME="left.glb",t.MODEL_RIGHT_FILENAME="right.glb",t.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ",t.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/,t}(Br),rm=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i._mapping={buttons:["trigger","grip","trackpad","thumbstick","menu"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onThumbstickStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y","THUMBSTICK_X","THUMBSTICK_Y"],pointingPoseMeshName:qi.POINTING_POSE},i.thumbstickValues={x:0,y:0},i.onThumbstickStateChangedObservable=new g.c,i.onThumbstickValuesChangedObservable=new g.c,i.onTrackpadChangedObservable=i.onPadStateChangedObservable,i.onTrackpadValuesChangedObservable=i.onPadValuesChangedObservable,i}return Object.defineProperty(t.prototype,"onThumbstickButtonStateChangedObservable",{get:function(){return this.onThumbstickStateChangedObservable},enumerable:!1,configurable:!0}),t.prototype._updateTrackpad=function(){this.browserGamepad.axes&&(this.browserGamepad.axes[2]!=this.thumbstickValues.x||this.browserGamepad.axes[3]!=this.thumbstickValues.y)&&(this.trackpad.x=this.browserGamepad.axes[2],this.trackpad.y=this.browserGamepad.axes[3],this.onThumbstickValuesChangedObservable.notifyObservers(this.trackpad))},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onThumbstickStateChangedObservable.clear(),this.onThumbstickValuesChangedObservable.clear()},t}(ko);Ui._ControllerFactories.push({canCreate:function(n){return n.id.indexOf(ko.GAMEPAD_ID_PREFIX)===0},create:function(n){return new ko(n)}});var Xo=u(573),co=u(495),rr=u(471),Xi=u(461),fo=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){i===void 0&&(i=v.a.Gray()),r===void 0&&(r=Xi.a.DefaultUtilityLayer),o===void 0&&(o=null),a===void 0&&(a=1);var s,c,_,b,C,x,V,D=n.call(this,r)||this;D._pointerObserver=null,D.snapDistance=0,D.onSnapObservable=new g.c,D.uniformScaling=!1,D.sensitivity=1,D._isEnabled=!0,D._parent=null,D._dragging=!1,D._tmpVector=new l.e,D._tmpMatrix=new l.a,D._tmpMatrix2=new l.a,D._parent=o,D._coloredMaterial=new zt.a("",r.utilityLayerScene),D._coloredMaterial.diffuseColor=i,D._coloredMaterial.specularColor=i.subtract(new v.a(.1,.1,.1)),D._hoverMaterial=new zt.a("",r.utilityLayerScene),D._hoverMaterial.diffuseColor=v.a.Yellow(),D._disableMaterial=new zt.a("",r.utilityLayerScene),D._disableMaterial.diffuseColor=v.a.Gray(),D._disableMaterial.alpha=.4,D._gizmoMesh=new st.a("axis",r.utilityLayerScene);var z=D._createGizmoMesh(D._gizmoMesh,a),q=z.arrowMesh,ue=z.arrowTail,ge=D._createGizmoMesh(D._gizmoMesh,a+4,!0);D._gizmoMesh.lookAt(D._rootMesh.position.add(e)),D._rootMesh.addChild(D._gizmoMesh),D._gizmoMesh.scaling.scaleInPlace(1/3);var Se=q.position.clone(),Pe=ue.position.clone(),me=ue.scaling.clone(),xe=function(ke){var ze=ke*(3/D._rootMesh.scaling.length())*6;q.position.z+=ze/3.5,ue.scaling.y+=ze,ue.position.z=q.position.z/2},Fe=function(){q.position.set(Se.x,Se.y,Se.z),ue.position.set(Pe.x,Pe.y,Pe.z),ue.scaling.set(me.x,me.y,me.z),D._dragging=!1};D.dragBehavior=new Me.a({dragAxis:e}),D.dragBehavior.moveAttached=!1,D._rootMesh.addBehavior(D.dragBehavior);var we=0,Ge=new l.e,Xe={snapDistance:0};D.dragBehavior.onDragObservable.add(function(ke){if(D.attachedNode){var ze=D.sensitivity*ke.dragDistance*(D.scaleRatio*3/D._rootMesh.scaling.length()),Je=!1,it=0;D.uniformScaling?(D.attachedNode.getWorldMatrix().decompose(Ge),Ge.normalize(),Ge.y<0&&Ge.scaleInPlace(-1)):Ge.copyFrom(e),D.snapDistance==0?Ge.scaleToRef(ze,Ge):(we+=ze,Math.abs(we)>D.snapDistance?(it=Math.floor(Math.abs(we)/D.snapDistance),we<0&&(it*=-1),we=we%D.snapDistance,Ge.scaleToRef(D.snapDistance*it,Ge),Je=!0):Ge.scaleInPlace(0)),l.a.ScalingToRef(1+Ge.x,1+Ge.y,1+Ge.z,D._tmpMatrix2),D._tmpMatrix2.multiplyToRef(D.attachedNode.getWorldMatrix(),D._tmpMatrix),D._tmpMatrix.decompose(D._tmpVector);var Ke=1e5;Math.abs(D._tmpVector.x)<Ke&&Math.abs(D._tmpVector.y)<Ke&&Math.abs(D._tmpVector.z)<Ke&&D.attachedNode.getWorldMatrix().copyFrom(D._tmpMatrix),Je&&(Xe.snapDistance=D.snapDistance*it,D.onSnapObservable.notifyObservers(Xe)),D._matrixChanged()}}),D.dragBehavior.onDragStartObservable.add(function(){D._dragging=!0}),D.dragBehavior.onDragObservable.add(function(ke){return xe(ke.dragDistance)}),D.dragBehavior.onDragEndObservable.add(Fe),(_=(c=(s=o==null?void 0:o.uniformScaleGizmo)===null||s===void 0?void 0:s.dragBehavior)===null||c===void 0?void 0:c.onDragObservable)===null||_===void 0||_.add(function(ke){return xe(ke.delta.y)}),(x=(C=(b=o==null?void 0:o.uniformScaleGizmo)===null||b===void 0?void 0:b.dragBehavior)===null||C===void 0?void 0:C.onDragEndObservable)===null||x===void 0||x.add(Fe);var Oe={gizmoMeshes:[q,ue],colliderMeshes:[ge.arrowMesh,ge.arrowTail],material:D._coloredMaterial,hoverMaterial:D._hoverMaterial,disableMaterial:D._disableMaterial,active:!1};(V=D._parent)===null||V===void 0||V.addToAxisCache(D._gizmoMesh,Oe),D._pointerObserver=r.utilityLayerScene.onPointerObservable.add(function(ke){var ze;if(!D._customMeshSet&&(D._isHovered=Oe.colliderMeshes.indexOf((ze=ke==null?void 0:ke.pickInfo)===null||ze===void 0?void 0:ze.pickedMesh)!=-1,!D._parent)){var Je=D._isHovered||D._dragging?D._hoverMaterial:D._coloredMaterial;Oe.gizmoMeshes.forEach(function(it){it.material=Je,it.color&&(it.color=Je.diffuseColor)})}});var je=r._getSharedGizmoLight();return je.includedOnlyMeshes=je.includedOnlyMeshes.concat(D._rootMesh.getChildMeshes()),D}return t.prototype._createGizmoMesh=function(e,i,r){r===void 0&&(r=!1);var o=co.a.CreateBox("yPosMesh",{size:.4*(1+(i-1)/4)},this.gizmoLayer.utilityLayerScene),a=Tr.a.CreateCylinder("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},this.gizmoLayer.utilityLayerScene);return o.scaling.scaleInPlace(.1),o.material=this._coloredMaterial,o.rotation.x=Math.PI/2,o.position.z+=.3,a.material=this._coloredMaterial,a.position.z+=.275/2,a.rotation.x=Math.PI/2,r&&(o.visibility=0,a.visibility=0),e.addChild(o),e.addChild(a),{arrowMesh:o,arrowTail:a}},t.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()}),n.prototype.dispose.call(this)},t.prototype.setCustomMesh=function(e,i){var r=this;i===void 0&&(i=!1),n.prototype.setCustomMesh.call(this,e),i&&(this._rootMesh.getChildMeshes().forEach(function(o){o.material=r._coloredMaterial,o.color&&(o.color=r._coloredMaterial.diffuseColor)}),this._customMeshSet=!1)},t}(rr.a),nr=u(470),Bi=u(493),ho=u(515),au=function(n){Object(p.d)(t,n);function t(e,i){e===void 0&&(e=v.a.Gray()),i===void 0&&(i=Xi.a.DefaultKeepDepthUtilityLayer);var r=n.call(this,i)||this;r._boundingDimensions=new l.e(1,1,1),r._renderObserver=null,r._pointerObserver=null,r._scaleDragSpeed=.2,r._tmpQuaternion=new l.b,r._tmpVector=new l.e(0,0,0),r._tmpRotationMatrix=new l.a,r.ignoreChildren=!1,r.includeChildPredicate=null,r.rotationSphereSize=.1,r.scaleBoxSize=.1,r.fixedDragMeshScreenSize=!1,r.fixedDragMeshBoundsSize=!1,r.fixedDragMeshScreenSizeDistanceFactor=10,r.onDragStartObservable=new g.c,r.onScaleBoxDragObservable=new g.c,r.onScaleBoxDragEndObservable=new g.c,r.onRotationSphereDragObservable=new g.c,r.onRotationSphereDragEndObservable=new g.c,r.scalePivot=null,r._axisFactor=new l.e(1,1,1),r._existingMeshScale=new l.e,r._dragMesh=null,r.pointerDragBehavior=new Me.a,r.updateScale=!1,r._anchorMesh=new Ae.a("anchor",i.utilityLayerScene),r.coloredMaterial=new zt.a("",i.utilityLayerScene),r.coloredMaterial.disableLighting=!0,r.hoverColoredMaterial=new zt.a("",i.utilityLayerScene),r.hoverColoredMaterial.disableLighting=!0,r._lineBoundingBox=new Ae.a("",i.utilityLayerScene),r._lineBoundingBox.rotationQuaternion=new l.b;var o=[];o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,0),new l.e(r._boundingDimensions.x,0,0)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,0),new l.e(0,r._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,0),new l.e(0,0,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,0,0),new l.e(r._boundingDimensions.x,r._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,0,0),new l.e(r._boundingDimensions.x,0,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,r._boundingDimensions.y,0),new l.e(r._boundingDimensions.x,r._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,r._boundingDimensions.y,0),new l.e(0,r._boundingDimensions.y,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,r._boundingDimensions.z),new l.e(r._boundingDimensions.x,0,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(0,0,r._boundingDimensions.z),new l.e(0,r._boundingDimensions.y,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,r._boundingDimensions.y,r._boundingDimensions.z),new l.e(0,r._boundingDimensions.y,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,r._boundingDimensions.y,r._boundingDimensions.z),new l.e(r._boundingDimensions.x,0,r._boundingDimensions.z)]},i.utilityLayerScene)),o.push(Bi.a.CreateLines("lines",{points:[new l.e(r._boundingDimensions.x,r._boundingDimensions.y,r._boundingDimensions.z),new l.e(r._boundingDimensions.x,r._boundingDimensions.y,0)]},i.utilityLayerScene)),o.forEach(function(q){q.color=e,q.position.addInPlace(new l.e(-r._boundingDimensions.x/2,-r._boundingDimensions.y/2,-r._boundingDimensions.z/2)),q.isPickable=!1,r._lineBoundingBox.addChild(q)}),r._rootMesh.addChild(r._lineBoundingBox),r.setColor(e),r._rotateSpheresParent=new Ae.a("",i.utilityLayerScene),r._rotateSpheresParent.rotationQuaternion=new l.b;for(var a=function(q){var ue=nr.a.CreateSphere("",{diameter:1},i.utilityLayerScene);ue.rotationQuaternion=new l.b,ue.material=s.coloredMaterial,c=new Me.a({}),c.moveAttached=!1,c.updateDragPlane=!1,ue.addBehavior(c);var ge=new l.e(1,0,0),Se=0;c.onDragStartObservable.add(function(){ge.copyFrom(ue.forward),Se=0}),c.onDragObservable.add(function(Pe){if(r.onRotationSphereDragObservable.notifyObservers({}),r.attachedMesh){var me=r.attachedMesh.parent;if(me&&me.scaling&&me.scaling.isNonUniformWithinEpsilon(.001)){d.a.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");return}he.a._RemoveAndStorePivotPoint(r.attachedMesh);var xe=ge,Fe=Pe.dragPlaneNormal.scale(l.e.Dot(Pe.dragPlaneNormal,xe)),we=xe.subtract(Fe).normalizeToNew(),Ge=l.e.Dot(we,Pe.delta)<0?Math.abs(Pe.delta.length()):-Math.abs(Pe.delta.length());Ge=Ge/r._boundingDimensions.length()*r._anchorMesh.scaling.length(),r.attachedMesh.rotationQuaternion||(r.attachedMesh.rotationQuaternion=l.b.RotationYawPitchRoll(r.attachedMesh.rotation.y,r.attachedMesh.rotation.x,r.attachedMesh.rotation.z)),r._anchorMesh.rotationQuaternion||(r._anchorMesh.rotationQuaternion=l.b.RotationYawPitchRoll(r._anchorMesh.rotation.y,r._anchorMesh.rotation.x,r._anchorMesh.rotation.z)),Se+=Ge,Math.abs(Se)<=2*Math.PI&&(q>=8?l.b.RotationYawPitchRollToRef(0,0,Ge,r._tmpQuaternion):q>=4?l.b.RotationYawPitchRollToRef(Ge,0,0,r._tmpQuaternion):l.b.RotationYawPitchRollToRef(0,Ge,0,r._tmpQuaternion),r._anchorMesh.addChild(r.attachedMesh),r._anchorMesh.rotationQuaternion.multiplyToRef(r._tmpQuaternion,r._anchorMesh.rotationQuaternion),r._anchorMesh.removeChild(r.attachedMesh),r.attachedMesh.setParent(me)),r.updateBoundingBox(),he.a._RestorePivotPoint(r.attachedMesh)}r._updateDummy()}),c.onDragStartObservable.add(function(){r.onDragStartObservable.notifyObservers({}),r._selectNode(ue)}),c.onDragEndObservable.add(function(){r.onRotationSphereDragEndObservable.notifyObservers({}),r._selectNode(null),r._updateDummy()}),s._rotateSpheresParent.addChild(ue)},s=this,c,_=0;_<12;_++)a(_);r._rootMesh.addChild(r._rotateSpheresParent),r._scaleBoxesParent=new Ae.a("",i.utilityLayerScene),r._scaleBoxesParent.rotationQuaternion=new l.b;for(var b=0;b<3;b++)for(var C=0;C<3;C++)for(var x=function(){var ue=(b===1?1:0)+(C===1?1:0)+(D===1?1:0);if(ue===1||ue===3)return"continue";var ge=co.a.CreateBox("",{size:1},i.utilityLayerScene);ge.material=V.coloredMaterial,ge.metadata=ue===2;var Se=new l.e(b-1,C-1,D-1).normalize();c=new Me.a({dragAxis:Se}),c.updateDragPlane=!1,c.moveAttached=!1,ge.addBehavior(c),c.onDragObservable.add(function(Pe){if(r.onScaleBoxDragObservable.notifyObservers({}),r.attachedMesh){var me=r.attachedMesh.parent;if(me&&me.scaling&&me.scaling.isNonUniformWithinEpsilon(.001)){d.a.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");return}he.a._RemoveAndStorePivotPoint(r.attachedMesh);var xe=Pe.dragDistance/r._boundingDimensions.length()*r._anchorMesh.scaling.length(),Fe=new l.e(xe,xe,xe);ue===2&&(Fe.x*=Math.abs(Se.x),Fe.y*=Math.abs(Se.y),Fe.z*=Math.abs(Se.z)),Fe.scaleInPlace(r._scaleDragSpeed),Fe.multiplyInPlace(r._axisFactor),r.updateBoundingBox(),r.scalePivot?(r.attachedMesh.getWorldMatrix().getRotationMatrixToRef(r._tmpRotationMatrix),r._boundingDimensions.scaleToRef(.5,r._tmpVector),l.e.TransformCoordinatesToRef(r._tmpVector,r._tmpRotationMatrix,r._tmpVector),r._anchorMesh.position.subtractInPlace(r._tmpVector),r._boundingDimensions.multiplyToRef(r.scalePivot,r._tmpVector),l.e.TransformCoordinatesToRef(r._tmpVector,r._tmpRotationMatrix,r._tmpVector),r._anchorMesh.position.addInPlace(r._tmpVector)):(ge.absolutePosition.subtractToRef(r._anchorMesh.position,r._tmpVector),r._anchorMesh.position.subtractInPlace(r._tmpVector)),r._anchorMesh.addChild(r.attachedMesh),r._anchorMesh.scaling.addInPlace(Fe),(r._anchorMesh.scaling.x<0||r._anchorMesh.scaling.y<0||r._anchorMesh.scaling.z<0)&&r._anchorMesh.scaling.subtractInPlace(Fe),r._anchorMesh.removeChild(r.attachedMesh),r.attachedMesh.setParent(me),he.a._RestorePivotPoint(r.attachedMesh)}r._updateDummy()}),c.onDragStartObservable.add(function(){r.onDragStartObservable.notifyObservers({}),r._selectNode(ge)}),c.onDragEndObservable.add(function(){r.onScaleBoxDragEndObservable.notifyObservers({}),r._selectNode(null),r._updateDummy()}),V._scaleBoxesParent.addChild(ge)},V=this,c,D=0;D<3;D++)x();r._rootMesh.addChild(r._scaleBoxesParent);var z=new Array;return r._pointerObserver=i.utilityLayerScene.onPointerObservable.add(function(q){z[q.event.pointerId]?q.pickInfo&&q.pickInfo.pickedMesh!=z[q.event.pointerId]&&(z[q.event.pointerId].material=r.coloredMaterial,delete z[q.event.pointerId]):r._rotateSpheresParent.getChildMeshes().concat(r._scaleBoxesParent.getChildMeshes()).forEach(function(ue){q.pickInfo&&q.pickInfo.pickedMesh==ue&&(z[q.event.pointerId]=ue,ue.material=r.hoverColoredMaterial)})}),r._renderObserver=r.gizmoLayer.originalScene.onBeforeRenderObservable.add(function(){r.attachedMesh&&!r._existingMeshScale.equals(r.attachedMesh.scaling)?r.updateBoundingBox():(r.fixedDragMeshScreenSize||r.fixedDragMeshBoundsSize)&&(r._updateRotationSpheres(),r._updateScaleBoxes()),r._dragMesh&&r.attachedMesh&&r.pointerDragBehavior.dragging&&(r._lineBoundingBox.position.rotateByQuaternionToRef(r._rootMesh.rotationQuaternion,r._tmpVector),r.attachedMesh.setAbsolutePosition(r._dragMesh.position.add(r._tmpVector.scale(-1))))}),r.updateBoundingBox(),r}return Object.defineProperty(t.prototype,"axisFactor",{get:function(){return this._axisFactor},set:function(e){this._axisFactor=e;for(var i=this._scaleBoxesParent.getChildMeshes(),r=0,o=0;o<3;o++)for(var a=0;a<3;a++)for(var s=0;s<3;s++){var c=(o===1?1:0)+(a===1?1:0)+(s===1?1:0);if(!(c===1||c===3)){if(i[r]){var _=new l.e(o-1,a-1,s-1);_.multiplyInPlace(this._axisFactor),i[r].setEnabled(_.lengthSquared()>ho.a)}r++}}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaleDragSpeed",{get:function(){return this._scaleDragSpeed},set:function(e){this._scaleDragSpeed=e},enumerable:!1,configurable:!0}),t.prototype.setColor=function(e){this.coloredMaterial.emissiveColor=e,this.hoverColoredMaterial.emissiveColor=e.clone().add(new v.a(.3,.3,.3)),this._lineBoundingBox.getChildren().forEach(function(i){i.color&&(i.color=e)})},t.prototype._attachedNodeChanged=function(e){var i=this;if(e){this._anchorMesh.scaling.setAll(1),he.a._RemoveAndStorePivotPoint(e);var r=e.parent;this._anchorMesh.addChild(e),this._anchorMesh.removeChild(e),e.setParent(r),he.a._RestorePivotPoint(e),this.updateBoundingBox(),e.getChildMeshes(!1).forEach(function(o){o.markAsDirty("scaling")}),this.gizmoLayer.utilityLayerScene.onAfterRenderObservable.addOnce(function(){i._updateDummy()})}},t.prototype._selectNode=function(e){this._rotateSpheresParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach(function(i){i.isVisible=!e||i==e})},t.prototype.updateBoundingBox=function(){if(this.attachedMesh){he.a._RemoveAndStorePivotPoint(this.attachedMesh);var e=this.attachedMesh.parent;this.attachedMesh.setParent(null);var i=null;this.attachedMesh.skeleton&&(i=this.attachedMesh.skeleton.overrideMesh,this.attachedMesh.skeleton.overrideMesh=null),this._update(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=l.b.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=l.b.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),this._anchorMesh.rotationQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpVector.copyFrom(this.attachedMesh.position),this.attachedMesh.rotationQuaternion.set(0,0,0,1),this.attachedMesh.position.set(0,0,0);var r=this.attachedMesh.getHierarchyBoundingVectors(!this.ignoreChildren,this.includeChildPredicate);r.max.subtractToRef(r.min,this._boundingDimensions),this._lineBoundingBox.scaling.copyFrom(this._boundingDimensions),this._lineBoundingBox.position.set((r.max.x+r.min.x)/2,(r.max.y+r.min.y)/2,(r.max.z+r.min.z)/2),this._rotateSpheresParent.position.copyFrom(this._lineBoundingBox.position),this._scaleBoxesParent.position.copyFrom(this._lineBoundingBox.position),this._lineBoundingBox.computeWorldMatrix(),this._anchorMesh.position.copyFrom(this._lineBoundingBox.absolutePosition),this.attachedMesh.rotationQuaternion.copyFrom(this._tmpQuaternion),this.attachedMesh.position.copyFrom(this._tmpVector),this.attachedMesh.setParent(e),this.attachedMesh.skeleton&&(this.attachedMesh.skeleton.overrideMesh=i)}this._updateRotationSpheres(),this._updateScaleBoxes(),this.attachedMesh&&(this._existingMeshScale.copyFrom(this.attachedMesh.scaling),he.a._RestorePivotPoint(this.attachedMesh))},t.prototype._updateRotationSpheres=function(){for(var e=this._rotateSpheresParent.getChildMeshes(),i=0;i<3;i++)for(var r=0;r<2;r++)for(var o=0;o<2;o++){var a=i*4+r*2+o;if(i==0&&(e[a].position.set(this._boundingDimensions.x/2,this._boundingDimensions.y*r,this._boundingDimensions.z*o),e[a].position.addInPlace(new l.e(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[a].lookAt(l.e.Cross(e[a].position.normalizeToNew(),l.e.Right()).normalizeToNew().add(e[a].position))),i==1&&(e[a].position.set(this._boundingDimensions.x*r,this._boundingDimensions.y/2,this._boundingDimensions.z*o),e[a].position.addInPlace(new l.e(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[a].lookAt(l.e.Cross(e[a].position.normalizeToNew(),l.e.Up()).normalizeToNew().add(e[a].position))),i==2&&(e[a].position.set(this._boundingDimensions.x*r,this._boundingDimensions.y*o,this._boundingDimensions.z/2),e[a].position.addInPlace(new l.e(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[a].lookAt(l.e.Cross(e[a].position.normalizeToNew(),l.e.Forward()).normalizeToNew().add(e[a].position))),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[a].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);var s=this.rotationSphereSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[a].scaling.set(s,s,s)}else this.fixedDragMeshBoundsSize?e[a].scaling.set(this.rotationSphereSize*this._boundingDimensions.x,this.rotationSphereSize*this._boundingDimensions.y,this.rotationSphereSize*this._boundingDimensions.z):e[a].scaling.set(this.rotationSphereSize,this.rotationSphereSize,this.rotationSphereSize)}},t.prototype._updateScaleBoxes=function(){for(var e=this._scaleBoxesParent.getChildMeshes(),i=0,r=0;r<3;r++)for(var o=0;o<3;o++)for(var a=0;a<3;a++){var s=(r===1?1:0)+(o===1?1:0)+(a===1?1:0);if(!(s===1||s===3)){if(e[i])if(e[i].position.set(this._boundingDimensions.x*(r/2),this._boundingDimensions.y*(o/2),this._boundingDimensions.z*(a/2)),e[i].position.addInPlace(new l.e(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[i].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);var c=this.scaleBoxSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[i].scaling.set(c,c,c)}else this.fixedDragMeshBoundsSize?e[i].scaling.set(this.scaleBoxSize*this._boundingDimensions.x,this.scaleBoxSize*this._boundingDimensions.y,this.scaleBoxSize*this._boundingDimensions.z):e[i].scaling.set(this.scaleBoxSize,this.scaleBoxSize,this.scaleBoxSize);i++}}},t.prototype.setEnabledRotationAxis=function(e){this._rotateSpheresParent.getChildMeshes().forEach(function(i,r){r<4?i.setEnabled(e.indexOf("x")!=-1):r<8?i.setEnabled(e.indexOf("y")!=-1):i.setEnabled(e.indexOf("z")!=-1)})},t.prototype.setEnabledScaling=function(e,i){i===void 0&&(i=!1),this._scaleBoxesParent.getChildMeshes().forEach(function(r,o){var a=e;i&&r.metadata===!0&&(a=!1),r.setEnabled(a)})},t.prototype._updateDummy=function(){this._dragMesh&&(this._dragMesh.position.copyFrom(this._lineBoundingBox.getAbsolutePosition()),this._dragMesh.scaling.copyFrom(this._lineBoundingBox.scaling),this._dragMesh.rotationQuaternion.copyFrom(this._rootMesh.rotationQuaternion))},t.prototype.enableDragBehavior=function(){this._dragMesh=st.a.CreateBox("dummy",1,this.gizmoLayer.utilityLayerScene),this._dragMesh.visibility=0,this._dragMesh.rotationQuaternion=new l.b,this.pointerDragBehavior.useObjectOrientationForDragging=!1,this._dragMesh.addBehavior(this.pointerDragBehavior)},t.prototype.dispose=function(){this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.gizmoLayer.originalScene.onBeforeRenderObservable.remove(this._renderObserver),this._lineBoundingBox.dispose(),this._rotateSpheresParent.dispose(),this._scaleBoxesParent.dispose(),this._dragMesh&&this._dragMesh.dispose(),n.prototype.dispose.call(this)},t.MakeNotPickableAndWrapInBoundingBox=function(e){var i=function(c){c.isPickable=!1,c.getChildMeshes().forEach(function(_){i(_)})};i(e),e.rotationQuaternion||(e.rotationQuaternion=l.b.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z));var r=e.position.clone(),o=e.rotationQuaternion.clone();e.rotationQuaternion.set(0,0,0,1),e.position.set(0,0,0);var a=co.a.CreateBox("box",{size:1},e.getScene()),s=e.getHierarchyBoundingVectors();return s.max.subtractToRef(s.min,a.scaling),a.scaling.y===0&&(a.scaling.y=ho.a),a.scaling.x===0&&(a.scaling.x=ho.a),a.scaling.z===0&&(a.scaling.z=ho.a),a.position.set((s.max.x+s.min.x)/2,(s.max.y+s.min.y)/2,(s.max.z+s.min.z)/2),e.addChild(a),e.rotationQuaternion.copyFrom(o),e.position.copyFrom(r),e.removeChild(a),a.addChild(e),a.visibility=0,a},t.prototype.setCustomMesh=function(e){d.a.Error("Custom meshes are not supported on this gizmo")},t}(rr.a),Tn=u(509),Yo=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){i===void 0&&(i=v.a.Gray()),r===void 0&&(r=Xi.a.DefaultUtilityLayer),o===void 0&&(o=32),a===void 0&&(a=null),s===void 0&&(s=!1),c===void 0&&(c=1);var _,b=n.call(this,r)||this;b._pointerObserver=null,b.snapDistance=0,b.onSnapObservable=new g.c,b._isEnabled=!0,b._parent=null,b._dragging=!1,b._angles=new l.e,b._parent=a,b._coloredMaterial=new zt.a("",r.utilityLayerScene),b._coloredMaterial.diffuseColor=i,b._coloredMaterial.specularColor=i.subtract(new v.a(.1,.1,.1)),b._hoverMaterial=new zt.a("",r.utilityLayerScene),b._hoverMaterial.diffuseColor=v.a.Yellow(),b._disableMaterial=new zt.a("",r.utilityLayerScene),b._disableMaterial.diffuseColor=v.a.Gray(),b._disableMaterial.alpha=.4,b._gizmoMesh=new st.a("",r.utilityLayerScene);var C=b._createGizmoMesh(b._gizmoMesh,c,o),x=C.rotationMesh,V=C.collider;b._rotationDisplayPlane=st.a.CreatePlane("rotationDisplay",.6,b.gizmoLayer.utilityLayerScene,!1),b._rotationDisplayPlane.rotation.z=Math.PI*.5,b._rotationDisplayPlane.parent=b._gizmoMesh,b._rotationDisplayPlane.setEnabled(!1),qe.a.ShadersStore.rotationGizmoVertexShader=t._rotationGizmoVertexShader,qe.a.ShadersStore.rotationGizmoFragmentShader=t._rotationGizmoFragmentShader,b._rotationShaderMaterial=new Tn.a("shader",b.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles"]}),b._rotationShaderMaterial.backFaceCulling=!1,b._rotationDisplayPlane.material=b._rotationShaderMaterial,b._rotationDisplayPlane.visibility=.999,b._gizmoMesh.lookAt(b._rootMesh.position.add(e)),b._rootMesh.addChild(b._gizmoMesh),b._gizmoMesh.scaling.scaleInPlace(1/3),b.dragBehavior=new Me.a({dragPlaneNormal:e}),b.dragBehavior.moveAttached=!1,b.dragBehavior.maxDragAngle=Math.PI*9/20,b.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,b._rootMesh.addBehavior(b.dragBehavior);var D=new l.e,z=new l.a,q=new l.e,ue=new l.e;b.dragBehavior.onDragStartObservable.add(function(we){b.attachedNode&&(D.copyFrom(we.dragPlanePoint),b._rotationDisplayPlane.setEnabled(!0),b._rotationDisplayPlane.getWorldMatrix().invertToRef(z),l.e.TransformCoordinatesToRef(we.dragPlanePoint,z,D),b._angles.x=Math.atan2(D.y,D.x)+Math.PI,b._angles.y=0,b._angles.z=b.updateGizmoRotationToMatchAttachedMesh?1:0,b._dragging=!0,D.copyFrom(we.dragPlanePoint),b._rotationShaderMaterial.setVector3("angles",b._angles))}),b.dragBehavior.onDragEndObservable.add(function(){b._dragging=!1,b._rotationDisplayPlane.setEnabled(!1)});var ge={snapDistance:0},Se=0,Pe=new l.a,me=new l.b;b.dragBehavior.onDragObservable.add(function(we){if(b.attachedNode){var Ge=new l.e(1,1,1),Xe=new l.b(0,0,0,1),Oe=new l.e(0,0,0);b.attachedNode.getWorldMatrix().decompose(Ge,Xe,Oe);var je=we.dragPlanePoint.subtract(Oe).normalize(),ke=D.subtract(Oe).normalize(),ze=l.e.Cross(je,ke),Je=l.e.Dot(je,ke),it=Math.atan2(ze.length(),Je);if(q.copyFrom(e),ue.copyFrom(e),b.updateGizmoRotationToMatchAttachedMesh&&(Xe.toRotationMatrix(z),ue=l.e.TransformCoordinates(q,z)),r.utilityLayerScene.activeCamera){var Ke=r.utilityLayerScene.activeCamera.position.subtract(Oe).normalize();l.e.Dot(Ke,ue)>0&&(q.scaleInPlace(-1),ue.scaleInPlace(-1))}var St=l.e.Dot(ue,ze)>0;St&&(it=-it);var Mt=!1;if(b.snapDistance!=0)if(Se+=it,Math.abs(Se)>b.snapDistance){var Rt=Math.floor(Math.abs(Se)/b.snapDistance);Se<0&&(Rt*=-1),Se=Se%b.snapDistance,it=b.snapDistance*Rt,Mt=!0}else it=0;var at=Math.sin(it/2);if(me.set(q.x*at,q.y*at,q.z*at,Math.cos(it/2)),Pe.determinant()>0){var Bt=new l.e;me.toEulerAnglesToRef(Bt),l.b.RotationYawPitchRollToRef(Bt.y,-Bt.x,-Bt.z,me)}b.updateGizmoRotationToMatchAttachedMesh?Xe.multiplyToRef(me,Xe):me.multiplyToRef(Xe,Xe),b.attachedNode.getWorldMatrix().copyFrom(l.a.Compose(Ge,Xe,Oe)),D.copyFrom(we.dragPlanePoint),Mt&&(ge.snapDistance=it,b.onSnapObservable.notifyObservers(ge)),b._angles.y+=it,b._rotationShaderMaterial.setVector3("angles",b._angles),b._matrixChanged()}});var xe=r._getSharedGizmoLight();xe.includedOnlyMeshes=xe.includedOnlyMeshes.concat(b._rootMesh.getChildMeshes(!1));var Fe={colliderMeshes:[V],gizmoMeshes:[x],material:b._coloredMaterial,hoverMaterial:b._hoverMaterial,disableMaterial:b._disableMaterial,active:!1};return(_=b._parent)===null||_===void 0||_.addToAxisCache(b._gizmoMesh,Fe),b._pointerObserver=r.utilityLayerScene.onPointerObservable.add(function(we){var Ge;if(!b._customMeshSet&&(b._isHovered=Fe.colliderMeshes.indexOf((Ge=we==null?void 0:we.pickInfo)===null||Ge===void 0?void 0:Ge.pickedMesh)!=-1,!b._parent)){var Xe=b._isHovered||b._dragging?b._hoverMaterial:b._coloredMaterial;Fe.gizmoMeshes.forEach(function(Oe){Oe.material=Xe,Oe.color&&(Oe.color=Xe.diffuseColor)})}}),b}return t.prototype._createGizmoMesh=function(e,i,r){var o=st.a.CreateTorus("ignore",.6,.03*i,r,this.gizmoLayer.utilityLayerScene);o.visibility=0;var a=st.a.CreateTorus("",.6,.005*i,r,this.gizmoLayer.utilityLayerScene);return a.material=this._coloredMaterial,a.rotation.x=Math.PI/2,o.rotation.x=Math.PI/2,e.addChild(a),e.addChild(o),{rotationMesh:a,collider:o}},t.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()}),n.prototype.dispose.call(this)},t._rotationGizmoVertexShader=`
        precision highp float;
        attribute vec3 position;
        attribute vec2 uv;
        uniform mat4 worldViewProjection;
        varying vec3 vPosition;
        varying vec2 vUV;
        void main(void) {
            gl_Position = worldViewProjection * vec4(position, 1.0);
            vUV = uv;
        }`,t._rotationGizmoFragmentShader=`
        precision highp float;
        varying vec2 vUV;
        varying vec3 vPosition;
        uniform vec3 angles;
        #define twopi 6.283185307
        void main(void) {
            vec2 uv = vUV - vec2(0.5);
            float angle = atan(uv.y, uv.x) + 3.141592;
            float delta = gl_FrontFacing ? angles.y : -angles.y;
            float begin = angles.x - delta * angles.z;
            float start = (begin < (begin + delta)) ? begin : (begin + delta);
            float end = (begin > (begin + delta)) ? begin : (begin + delta);
            float len = sqrt(dot(uv,uv));
            float opacity = 1. - step(0.5, len);

            float base = abs(floor(start / twopi)) * twopi;
            start += base;
            end += base;

            float intensity = 0.;
            for (int i = 0; i < 5; i++)
            {
                intensity += max(step(start, angle) - step(end, angle), 0.);
                angle += twopi;
            }
            gl_FragColor = vec4(1.,1.,0., min(intensity * 0.25, 0.8)) * opacity;
        }`,t}(rr.a),su=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){e===void 0&&(e=Xi.a.DefaultUtilityLayer),i===void 0&&(i=32),r===void 0&&(r=!1),o===void 0&&(o=1);var s=n.call(this,e)||this;return s.onDragStartObservable=new g.c,s.onDragEndObservable=new g.c,s._observables=[],s._gizmoAxisCache=new Map,s.xGizmo=new Yo(new l.e(1,0,0),v.a.Red().scale(.5),e,i,s,r,o),s.yGizmo=new Yo(new l.e(0,1,0),v.a.Green().scale(.5),e,i,s,r,o),s.zGizmo=new Yo(new l.e(0,0,1),v.a.Blue().scale(.5),e,i,s,r,o),[s.xGizmo,s.yGizmo,s.zGizmo].forEach(function(c){c.dragBehavior.onDragStartObservable.add(function(){s.onDragStartObservable.notifyObservers({})}),c.dragBehavior.onDragEndObservable.add(function(){s.onDragEndObservable.notifyObservers({})})}),s.attachedMesh=null,s.attachedNode=null,a?a.addToAxisCache(s._gizmoAxisCache):rr.a.GizmoAxisPointerObserver(e,s._gizmoAxisCache),s}return Object.defineProperty(t.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),t.prototype._checkBillboardTransform=function(){this._nodeAttached&&this._nodeAttached.billboardMode&&console.log("Rotation Gizmo will not work with transforms in billboard mode.")},Object.defineProperty(t.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh},set:function(e){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"snapDistance",{get:function(){return this.xGizmo.snapDistance},set:function(e){this.xGizmo&&(this.xGizmo.snapDistance=e,this.yGizmo.snapDistance=e,this.zGizmo.snapDistance=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaleRatio",{get:function(){return this.xGizmo.scaleRatio},set:function(e){this.xGizmo&&(this.xGizmo.scaleRatio=e,this.yGizmo.scaleRatio=e,this.zGizmo.scaleRatio=e)},enumerable:!1,configurable:!0}),t.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},t.prototype.dispose=function(){var e=this;this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)})},t.prototype.setCustomMesh=function(e){d.a.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")},t}(rr.a),po=u(499),lu=u(526),Ko=function(n){Object(p.d)(t,n);function t(e,i,r,o){i===void 0&&(i=v.a.Gray()),r===void 0&&(r=Xi.a.DefaultUtilityLayer),o===void 0&&(o=null);var a,s=n.call(this,r)||this;s._pointerObserver=null,s.snapDistance=0,s.onSnapObservable=new g.c,s._isEnabled=!1,s._parent=null,s._dragging=!1,s._parent=o,s._coloredMaterial=new zt.a("",r.utilityLayerScene),s._coloredMaterial.diffuseColor=i,s._coloredMaterial.specularColor=i.subtract(new v.a(.1,.1,.1)),s._hoverMaterial=new zt.a("",r.utilityLayerScene),s._hoverMaterial.diffuseColor=v.a.Yellow(),s._disableMaterial=new zt.a("",r.utilityLayerScene),s._disableMaterial.diffuseColor=v.a.Gray(),s._disableMaterial.alpha=.4,s._gizmoMesh=t._CreatePlane(r.utilityLayerScene,s._coloredMaterial),s._gizmoMesh.lookAt(s._rootMesh.position.add(e)),s._gizmoMesh.scaling.scaleInPlace(1/3),s._gizmoMesh.parent=s._rootMesh;var c=0,_=new l.e,b={snapDistance:0};s.dragBehavior=new Me.a({dragPlaneNormal:e}),s.dragBehavior.moveAttached=!1,s._rootMesh.addBehavior(s.dragBehavior),s.dragBehavior.onDragObservable.add(function(V){if(s.attachedNode){if(s.snapDistance==0)s.attachedNode.getWorldMatrix().addTranslationFromFloats(V.delta.x,V.delta.y,V.delta.z);else if(c+=V.dragDistance,Math.abs(c)>s.snapDistance){var D=Math.floor(Math.abs(c)/s.snapDistance);c=c%s.snapDistance,V.delta.normalizeToRef(_),_.scaleInPlace(s.snapDistance*D),s.attachedNode.getWorldMatrix().addTranslationFromFloats(_.x,_.y,_.z),b.snapDistance=s.snapDistance*D,s.onSnapObservable.notifyObservers(b)}s._matrixChanged()}}),s.dragBehavior.onDragStartObservable.add(function(){s._dragging=!0}),s.dragBehavior.onDragEndObservable.add(function(){s._dragging=!1});var C=r._getSharedGizmoLight();C.includedOnlyMeshes=C.includedOnlyMeshes.concat(s._rootMesh.getChildMeshes(!1));var x={gizmoMeshes:s._gizmoMesh.getChildMeshes(),colliderMeshes:s._gizmoMesh.getChildMeshes(),material:s._coloredMaterial,hoverMaterial:s._hoverMaterial,disableMaterial:s._disableMaterial,active:!1};return(a=s._parent)===null||a===void 0||a.addToAxisCache(s._gizmoMesh,x),s._pointerObserver=r.utilityLayerScene.onPointerObservable.add(function(V){var D;if(!s._customMeshSet&&(s._isHovered=x.colliderMeshes.indexOf((D=V==null?void 0:V.pickInfo)===null||D===void 0?void 0:D.pickedMesh)!=-1,!s._parent)){var z=s._isHovered||s._dragging?s._hoverMaterial:s._coloredMaterial;x.gizmoMeshes.forEach(function(q){q.material=z})}}),s}return t._CreatePlane=function(e,i){var r=new po.a("plane",e),o=lu.a.CreatePlane("dragPlane",{width:.1375,height:.1375,sideOrientation:2},e);return o.material=i,o.parent=r,r},t.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),n.prototype.dispose.call(this),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()})},t}(rr.a),uu=function(n){Object(p.d)(t,n);function t(e,i,r){e===void 0&&(e=Xi.a.DefaultUtilityLayer),i===void 0&&(i=1);var o=n.call(this,e)||this;return o._meshAttached=null,o._nodeAttached=null,o._observables=[],o._gizmoAxisCache=new Map,o.onDragStartObservable=new g.c,o.onDragEndObservable=new g.c,o._planarGizmoEnabled=!1,o.xGizmo=new Xo.a(new l.e(1,0,0),v.a.Red().scale(.5),e,o,i),o.yGizmo=new Xo.a(new l.e(0,1,0),v.a.Green().scale(.5),e,o,i),o.zGizmo=new Xo.a(new l.e(0,0,1),v.a.Blue().scale(.5),e,o,i),o.xPlaneGizmo=new Ko(new l.e(1,0,0),v.a.Red().scale(.5),o.gizmoLayer,o),o.yPlaneGizmo=new Ko(new l.e(0,1,0),v.a.Green().scale(.5),o.gizmoLayer,o),o.zPlaneGizmo=new Ko(new l.e(0,0,1),v.a.Blue().scale(.5),o.gizmoLayer,o),[o.xGizmo,o.yGizmo,o.zGizmo,o.xPlaneGizmo,o.yPlaneGizmo,o.zPlaneGizmo].forEach(function(a){a.dragBehavior.onDragStartObservable.add(function(){o.onDragStartObservable.notifyObservers({})}),a.dragBehavior.onDragEndObservable.add(function(){o.onDragEndObservable.notifyObservers({})})}),o.attachedMesh=null,r?r.addToAxisCache(o._gizmoAxisCache):rr.a.GizmoAxisPointerObserver(e,o._gizmoAxisCache),o}return Object.defineProperty(t.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=null,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"planarGizmoEnabled",{get:function(){return this._planarGizmoEnabled},set:function(e){var i=this;this._planarGizmoEnabled=e,[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(r){r&&(r.isEnabled=e,e&&(r.attachedMesh?r.attachedMesh=i.attachedMesh:r.attachedNode=i.attachedNode))},this)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(e){this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.updateGizmoRotationToMatchAttachedMesh=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"snapDistance",{get:function(){return this._snapDistance},set:function(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.snapDistance=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.scaleRatio=e)})},enumerable:!1,configurable:!0}),t.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},t.prototype.dispose=function(){var e=this;[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&i.dispose()}),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)}),this.onDragStartObservable.clear(),this.onDragEndObservable.clear()},t.prototype.setCustomMesh=function(e){d.a.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")},t}(rr.a),cs=u(693),cu=function(n){Object(p.d)(t,n);function t(e,i,r){e===void 0&&(e=Xi.a.DefaultUtilityLayer),i===void 0&&(i=1);var o=n.call(this,e)||this;return o._meshAttached=null,o._nodeAttached=null,o._sensitivity=1,o._observables=[],o._gizmoAxisCache=new Map,o.onDragStartObservable=new g.c,o.onDragEndObservable=new g.c,o.uniformScaleGizmo=o._createUniformScaleMesh(),o.xGizmo=new fo(new l.e(1,0,0),v.a.Red().scale(.5),e,o,i),o.yGizmo=new fo(new l.e(0,1,0),v.a.Green().scale(.5),e,o,i),o.zGizmo=new fo(new l.e(0,0,1),v.a.Blue().scale(.5),e,o,i),[o.xGizmo,o.yGizmo,o.zGizmo,o.uniformScaleGizmo].forEach(function(a){a.dragBehavior.onDragStartObservable.add(function(){o.onDragStartObservable.notifyObservers({})}),a.dragBehavior.onDragEndObservable.add(function(){o.onDragEndObservable.notifyObservers({})})}),o.attachedMesh=null,o.attachedNode=null,r?r.addToAxisCache(o._gizmoAxisCache):rr.a.GizmoAxisPointerObserver(e,o._gizmoAxisCache),o}return Object.defineProperty(t.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),t.prototype._createUniformScaleMesh=function(){this._coloredMaterial=new zt.a("",this.gizmoLayer.utilityLayerScene),this._coloredMaterial.diffuseColor=v.a.Gray(),this._hoverMaterial=new zt.a("",this.gizmoLayer.utilityLayerScene),this._hoverMaterial.diffuseColor=v.a.Yellow(),this._disableMaterial=new zt.a("",this.gizmoLayer.utilityLayerScene),this._disableMaterial.diffuseColor=v.a.Gray(),this._disableMaterial.alpha=.4;var e=new fo(new l.e(0,1,0),v.a.Gray().scale(.5),this.gizmoLayer,this);e.updateGizmoRotationToMatchAttachedMesh=!1,e.uniformScaling=!0,this._uniformScalingMesh=cs.a.CreatePolyhedron("uniform",{type:1},e.gizmoLayer.utilityLayerScene),this._uniformScalingMesh.scaling.scaleInPlace(.01),this._uniformScalingMesh.visibility=0,this._octahedron=cs.a.CreatePolyhedron("",{type:1},e.gizmoLayer.utilityLayerScene),this._octahedron.scaling.scaleInPlace(.007),this._uniformScalingMesh.addChild(this._octahedron),e.setCustomMesh(this._uniformScalingMesh,!0);var i=this.gizmoLayer._getSharedGizmoLight();i.includedOnlyMeshes=i.includedOnlyMeshes.concat(this._octahedron);var r={gizmoMeshes:[this._octahedron,this._uniformScalingMesh],colliderMeshes:[this._uniformScalingMesh],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1};return this.addToAxisCache(e._rootMesh,r),e},Object.defineProperty(t.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(e){e?(this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.updateGizmoRotationToMatchAttachedMesh=e)})):d.a.Warn("Setting updateGizmoRotationToMatchAttachedMesh = false on scaling gizmo is not supported.")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"snapDistance",{get:function(){return this._snapDistance},set:function(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.snapDistance=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.scaleRatio=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sensitivity",{get:function(){return this._sensitivity},set:function(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.sensitivity=e)})},enumerable:!1,configurable:!0}),t.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},t.prototype.dispose=function(){var e=this;[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&i.dispose()}),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)}),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),[this._uniformScalingMesh,this._octahedron].forEach(function(i){i&&i.dispose()}),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(i){i&&i.dispose()})},t}(rr.a),nm=function(){function n(t,e,i,r){e===void 0&&(e=1),i===void 0&&(i=Xi.a.DefaultUtilityLayer),r===void 0&&(r=Xi.a.DefaultKeepDepthUtilityLayer),this.scene=t,this.clearGizmoOnEmptyPointerEvent=!1,this.onAttachedToMeshObservable=new g.c,this.onAttachedToNodeObservable=new g.c,this._gizmosEnabled={positionGizmo:!1,rotationGizmo:!1,scaleGizmo:!1,boundingBoxGizmo:!1},this._pointerObservers=[],this._attachedMesh=null,this._attachedNode=null,this._boundingBoxColor=v.a.FromHexString("#0984e3"),this._thickness=1,this._gizmoAxisCache=new Map,this.boundingBoxDragBehavior=new de,this.attachableMeshes=null,this.attachableNodes=null,this.usePointerToAttachGizmos=!0,this._defaultUtilityLayer=i,this._defaultKeepDepthUtilityLayer=r,this._defaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,this._thickness=e,this.gizmos={positionGizmo:null,rotationGizmo:null,scaleGizmo:null,boundingBoxGizmo:null};var o=this._attachToMeshPointerObserver(t),a=rr.a.GizmoAxisPointerObserver(this._defaultUtilityLayer,this._gizmoAxisCache);this._pointerObservers=[o,a]}return Object.defineProperty(n.prototype,"keepDepthUtilityLayer",{get:function(){return this._defaultKeepDepthUtilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"utilityLayer",{get:function(){return this._defaultUtilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isHovered",{get:function(){var t=!1;for(var e in this.gizmos){var i=this.gizmos[e];if(i&&i.isHovered){t=!0;break}}return t},enumerable:!1,configurable:!0}),n.prototype._attachToMeshPointerObserver=function(t){var e=this,i=t.onPointerObservable.add(function(r){if(!!e.usePointerToAttachGizmos&&r.type==se.a.POINTERDOWN)if(r.pickInfo&&r.pickInfo.pickedMesh){var o=r.pickInfo.pickedMesh;if(e.attachableMeshes==null)for(;o&&o.parent!=null;)o=o.parent;else{var a=!1;e.attachableMeshes.forEach(function(s){o&&(o==s||o.isDescendantOf(s))&&(o=s,a=!0)}),a||(o=null)}o instanceof Ae.a?e._attachedMesh!=o&&e.attachToMesh(o):e.clearGizmoOnEmptyPointerEvent&&e.attachToMesh(null)}else e.clearGizmoOnEmptyPointerEvent&&e.attachToMesh(null)});return i},n.prototype.attachToMesh=function(t){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=t,this._attachedNode=null;for(var e in this.gizmos){var i=this.gizmos[e];i&&this._gizmosEnabled[e]&&(i.attachedMesh=t)}this.boundingBoxGizmoEnabled&&this._attachedMesh&&this._attachedMesh.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToMeshObservable.notifyObservers(t)},n.prototype.attachToNode=function(t){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=null,this._attachedNode=t;for(var e in this.gizmos){var i=this.gizmos[e];i&&this._gizmosEnabled[e]&&(i.attachedNode=t)}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(t)},Object.defineProperty(n.prototype,"positionGizmoEnabled",{get:function(){return this._gizmosEnabled.positionGizmo},set:function(t){t?(this.gizmos.positionGizmo||(this.gizmos.positionGizmo=new uu(this._defaultUtilityLayer,this._thickness,this)),this._attachedNode?this.gizmos.positionGizmo.attachedNode=this._attachedNode:this.gizmos.positionGizmo.attachedMesh=this._attachedMesh):this.gizmos.positionGizmo&&(this.gizmos.positionGizmo.attachedNode=null),this._gizmosEnabled.positionGizmo=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rotationGizmoEnabled",{get:function(){return this._gizmosEnabled.rotationGizmo},set:function(t){t?(this.gizmos.rotationGizmo||(this.gizmos.rotationGizmo=new su(this._defaultUtilityLayer,32,!1,this._thickness,this)),this._attachedNode?this.gizmos.rotationGizmo.attachedNode=this._attachedNode:this.gizmos.rotationGizmo.attachedMesh=this._attachedMesh):this.gizmos.rotationGizmo&&(this.gizmos.rotationGizmo.attachedNode=null),this._gizmosEnabled.rotationGizmo=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"scaleGizmoEnabled",{get:function(){return this._gizmosEnabled.scaleGizmo},set:function(t){t?(this.gizmos.scaleGizmo=this.gizmos.scaleGizmo||new cu(this._defaultUtilityLayer,this._thickness,this),this._attachedNode?this.gizmos.scaleGizmo.attachedNode=this._attachedNode:this.gizmos.scaleGizmo.attachedMesh=this._attachedMesh):this.gizmos.scaleGizmo&&(this.gizmos.scaleGizmo.attachedNode=null),this._gizmosEnabled.scaleGizmo=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"boundingBoxGizmoEnabled",{get:function(){return this._gizmosEnabled.boundingBoxGizmo},set:function(t){t?(this.gizmos.boundingBoxGizmo=this.gizmos.boundingBoxGizmo||new au(this._boundingBoxColor,this._defaultKeepDepthUtilityLayer),this._attachedMesh?this.gizmos.boundingBoxGizmo.attachedMesh=this._attachedMesh:this.gizmos.boundingBoxGizmo.attachedNode=this._attachedNode,this._attachedMesh?(this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh.addBehavior(this.boundingBoxDragBehavior)):this._attachedNode&&(this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode.addBehavior(this.boundingBoxDragBehavior))):this.gizmos.boundingBoxGizmo&&(this._attachedMesh?this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior):this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this.gizmos.boundingBoxGizmo.attachedNode=null),this._gizmosEnabled.boundingBoxGizmo=t},enumerable:!1,configurable:!0}),n.prototype.addToAxisCache=function(t){var e=this;t.size>0&&t.forEach(function(i,r){e._gizmoAxisCache.set(r,i)})},n.prototype.dispose=function(){var t=this;this._pointerObservers.forEach(function(r){t.scene.onPointerObservable.remove(r)});for(var e in this.gizmos){var i=this.gizmos[e];i&&i.dispose()}this._defaultKeepDepthUtilityLayer.dispose(),this._defaultUtilityLayer.dispose(),this.boundingBoxDragBehavior.detach(),this.onAttachedToMeshObservable.clear()},n}(),fu=u(599);st.a.CreateHemisphere=function(n,t,e,i){var r={segments:t,diameter:e};return Qo.CreateHemisphere(n,r,i)};var Qo=function(){function n(){}return n.CreateHemisphere=function(t,e,i){e.diameter||(e.diameter=1),e.segments||(e.segments=16);var r=nr.a.CreateSphere("",{slice:.5,diameter:e.diameter,segments:e.segments},i),o=st.a.CreateDisc("",e.diameter/2,e.segments*3+(4-e.segments),i);o.rotation.x=-Math.PI/2,o.parent=r;var a=st.a.MergeMeshes([o,r],!0);return a.name=t,a},n}(),Zo=u(484),fs=u(537);Nt.a.AddNodeConstructor("Light_Type_2",function(n,t){return function(){return new hs(n,l.e.Zero(),l.e.Zero(),0,0,t)}});var hs=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,s)||this;return c._innerAngle=0,c._projectionTextureMatrix=l.a.Zero(),c._projectionTextureLightNear=1e-6,c._projectionTextureLightFar=1e3,c._projectionTextureUpDirection=l.e.Up(),c._projectionTextureViewLightDirty=!0,c._projectionTextureProjectionLightDirty=!0,c._projectionTextureDirty=!0,c._projectionTextureViewTargetVector=l.e.Zero(),c._projectionTextureViewLightMatrix=l.a.Zero(),c._projectionTextureProjectionLightMatrix=l.a.Zero(),c._projectionTextureScalingMatrix=l.a.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),c.position=i,c.direction=r,c.angle=o,c.exponent=a,c}return Object.defineProperty(t.prototype,"angle",{get:function(){return this._angle},set:function(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"innerAngle",{get:function(){return this._innerAngle},set:function(e){this._innerAngle=e,this._computeAngleValues()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowAngleScale",{get:function(){return this._shadowAngleScale},set:function(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureMatrix",{get:function(){return this._projectionTextureMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureLightNear",{get:function(){return this._projectionTextureLightNear},set:function(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureLightFar",{get:function(){return this._projectionTextureLightFar},set:function(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureUpDirection",{get:function(){return this._projectionTextureUpDirection},set:function(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTexture",{get:function(){return this._projectionTexture},set:function(e){var i=this;this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(t._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(function(){i._markMeshesAsLightDirty()}):t._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(function(){i._markMeshesAsLightDirty()})))},enumerable:!1,configurable:!0}),t._IsProceduralTexture=function(e){return e.onGeneratedObservable!==void 0},t._IsTexture=function(e){return e.onLoadObservable!==void 0},t.prototype.getClassName=function(){return"SpotLight"},t.prototype.getTypeID=function(){return Zo.a.LIGHTTYPEID_SPOTLIGHT},t.prototype._setDirection=function(e){n.prototype._setDirection.call(this,e),this._projectionTextureViewLightDirty=!0},t.prototype._setPosition=function(e){n.prototype._setPosition.call(this,e),this._projectionTextureViewLightDirty=!0},t.prototype._setDefaultShadowProjectionMatrix=function(e,i,r){var o=this.getScene().activeCamera;if(!!o){this._shadowAngleScale=this._shadowAngleScale||1;var a=this._shadowAngleScale*this._angle;l.a.PerspectiveFovLHToRef(a,1,this.getDepthMinZ(o),this.getDepthMaxZ(o),e)}},t.prototype._computeProjectionTextureViewLightMatrix=function(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),l.a.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)},t.prototype._computeProjectionTextureProjectionLightMatrix=function(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;var e=this.projectionTextureLightFar,i=this.projectionTextureLightNear,r=e/(e-i),o=-r*i,a=1/Math.tan(this._angle/2),s=1;l.a.FromValuesToRef(a/s,0,0,0,0,a,0,0,0,0,r,1,0,0,o,0,this._projectionTextureProjectionLightMatrix)},t.prototype._computeProjectionTextureMatrix=function(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Ze.a){var e=this._projectionTexture.uScale/2,i=this._projectionTexture.vScale/2;l.a.FromValuesToRef(e,0,0,0,0,i,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)},t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype._computeAngleValues=function(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale},t.prototype.transferTexturesToEffect=function(e,i){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+i,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+i,this.projectionTexture)),this},t.prototype.transferToEffect=function(e,i){var r;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,i),r=l.e.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,i),r=l.e.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",r.x,r.y,r.z,this._cosHalfAngle,i),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,i),this},t.prototype.transferToNodeMaterialEffect=function(e,i){var r;return this.computeTransformedInformation()?r=l.e.Normalize(this.transformedDirection):r=l.e.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(i,-r.x,-r.y,-r.z):e.setFloat3(i,r.x,r.y,r.z),this},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._projectionTexture&&this._projectionTexture.dispose()},t.prototype.prepareLightSpecificDefines=function(e,i){e["SPOTLIGHT"+i]=!0,e["PROJECTEDLIGHTTEXTURE"+i]=!!(this.projectionTexture&&this.projectionTexture.isReady())},Object(p.c)([Object(Ee.c)()],t.prototype,"angle",null),Object(p.c)([Object(Ee.c)()],t.prototype,"innerAngle",null),Object(p.c)([Object(Ee.c)()],t.prototype,"shadowAngleScale",null),Object(p.c)([Object(Ee.c)()],t.prototype,"exponent",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"projectionTextureLightNear",null),Object(p.c)([Object(Ee.c)()],t.prototype,"projectionTextureLightFar",null),Object(p.c)([Object(Ee.c)()],t.prototype,"projectionTextureUpDirection",null),Object(p.c)([Object(Ee.m)("projectedLightTexture")],t.prototype,"_projectionTexture",void 0),t}(fs.a),om=function(n){Object(p.d)(t,n);function t(e){e===void 0&&(e=Xi.a.DefaultUtilityLayer);var i=n.call(this,e)||this;return i._cachedPosition=new l.e,i._cachedForward=new l.e(0,0,1),i._pointerObserver=null,i.onClickedObservable=new g.c,i._light=null,i.attachedMesh=new Ae.a("",i.gizmoLayer.utilityLayerScene),i._attachedMeshParent=new po.a("parent",i.gizmoLayer.utilityLayerScene),i.attachedMesh.parent=i._attachedMeshParent,i._material=new zt.a("light",i.gizmoLayer.utilityLayerScene),i._material.diffuseColor=new v.a(.5,.5,.5),i._material.specularColor=new v.a(.1,.1,.1),i._pointerObserver=e.utilityLayerScene.onPointerObservable.add(function(r){!i._light||(i._isHovered=!!(r.pickInfo&&i._rootMesh.getChildMeshes().indexOf(r.pickInfo.pickedMesh)!=-1),i._isHovered&&r.event.button===0&&i.onClickedObservable.notifyObservers(i._light))},se.a.POINTERDOWN),i}return Object.defineProperty(t.prototype,"light",{get:function(){return this._light},set:function(e){var i=this;if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),e instanceof $n.a?this._lightMesh=t._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof fu.a?this._lightMesh=t._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof hs?this._lightMesh=t._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):this._lightMesh=t._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach(function(o){o.material=i._material}),this._lightMesh.parent=this._rootMesh;var r=this.gizmoLayer._getSharedGizmoLight();r.includedOnlyMeshes=r.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new l.b,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction&&(this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(this.attachedMesh.forward)),this._update()}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),t.prototype._update=function(){n.prototype._update.call(this),!!this._light&&(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position&&(this.attachedMesh.position.equals(this._cachedPosition)?(this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)):(this._light.position.copyFrom(this.attachedMesh.position),this._cachedPosition.copyFrom(this.attachedMesh.position))),this._light.direction&&(l.e.DistanceSquared(this.attachedMesh.forward,this._cachedForward)>1e-4?(this._light.direction.copyFrom(this.attachedMesh.forward),this._cachedForward.copyFrom(this.attachedMesh.forward)):l.e.DistanceSquared(this.attachedMesh.forward,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(this.attachedMesh.forward))))},t.prototype.dispose=function(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),n.prototype.dispose.call(this),this._attachedMeshParent.dispose()},t._CreateHemisphericLightMesh=function(e){var i=new st.a("hemisphereLight",e),r=Qo.CreateHemisphere(i.name,{segments:10,diameter:1},e);r.position.z=-.15,r.rotation.x=Math.PI/2,r.parent=i;var o=this._CreateLightLines(3,e);return o.parent=i,i.scaling.scaleInPlace(t._Scale),i.rotation.x=Math.PI/2,i},t._CreatePointLightMesh=function(e){var i=new st.a("pointLight",e),r=nr.a.CreateSphere(i.name,{segments:10,diameter:1},e);r.rotation.x=Math.PI/2,r.parent=i;var o=this._CreateLightLines(5,e);return o.parent=i,i.scaling.scaleInPlace(t._Scale),i.rotation.x=Math.PI/2,i},t._CreateSpotLightMesh=function(e){var i=new st.a("spotLight",e),r=nr.a.CreateSphere(i.name,{segments:10,diameter:1},e);r.parent=i;var o=Qo.CreateHemisphere(i.name,{segments:10,diameter:2},e);o.parent=i,o.rotation.x=-Math.PI/2;var a=this._CreateLightLines(2,e);return a.parent=i,i.scaling.scaleInPlace(t._Scale),i.rotation.x=Math.PI/2,i},t._CreateDirectionalLightMesh=function(e){var i=new st.a("directionalLight",e),r=new st.a(i.name,e);r.parent=i;var o=nr.a.CreateSphere(i.name,{diameter:1.2,segments:10},e);o.parent=r;var a=st.a.CreateCylinder(i.name,6,.3,.3,6,1,e);a.parent=r;var s=a.clone(i.name);s.scaling.y=.5,s.position.x+=1.25;var c=a.clone(i.name);c.scaling.y=.5,c.position.x+=-1.25;var _=st.a.CreateCylinder(i.name,1,0,.6,6,1,e);_.position.y+=3,_.parent=r;var s=_.clone(i.name);s.position.y=1.5,s.position.x+=1.25;var c=_.clone(i.name);return c.position.y=1.5,c.position.x+=-1.25,r.scaling.scaleInPlace(t._Scale),r.rotation.z=Math.PI/2,r.rotation.y=Math.PI/2,i},t._Scale=.007,t._CreateLightLines=function(e,i){var r=1.2,o=new st.a("root",i);o.rotation.x=Math.PI/2;var a=new st.a("linePivot",i);a.parent=o;var s=st.a.CreateCylinder("line",2,.2,.3,6,1,i);if(s.position.y=s.scaling.y/2+r,s.parent=a,e<2)return a;for(var c=0;c<4;c++){var _=a.clone("lineParentClone");_.rotation.z=Math.PI/4,_.rotation.y=Math.PI/2+Math.PI/2*c,_.getChildMeshes()[0].scaling.y=.5,_.getChildMeshes()[0].scaling.x=_.getChildMeshes()[0].scaling.z=.8,_.getChildMeshes()[0].position.y=_.getChildMeshes()[0].scaling.y/2+r}if(e<3)return o;for(var c=0;c<4;c++){var _=a.clone("linePivotClone");_.rotation.z=Math.PI/2,_.rotation.y=Math.PI/2*c}if(e<4)return o;for(var c=0;c<4;c++){var _=a.clone("linePivotClone");_.rotation.z=Math.PI+Math.PI/4,_.rotation.y=Math.PI/2+Math.PI/2*c,_.getChildMeshes()[0].scaling.y=.5,_.getChildMeshes()[0].scaling.x=_.getChildMeshes()[0].scaling.z=.8,_.getChildMeshes()[0].position.y=_.getChildMeshes()[0].scaling.y/2+r}if(e<5)return o;var _=a.clone("linePivotClone");return _.rotation.z=Math.PI,o},t}(rr.a),am=function(n){Object(p.d)(t,n);function t(e){e===void 0&&(e=Xi.a.DefaultUtilityLayer);var i=n.call(this,e)||this;return i._pointerObserver=null,i.onClickedObservable=new g.c,i._camera=null,i._invProjection=new tt.k,i._material=new zt.a("cameraGizmoMaterial",i.gizmoLayer.utilityLayerScene),i._material.diffuseColor=new v.a(.5,.5,.5),i._material.specularColor=new v.a(.1,.1,.1),i._pointerObserver=e.utilityLayerScene.onPointerObservable.add(function(r){!i._camera||(i._isHovered=!!(r.pickInfo&&i._rootMesh.getChildMeshes().indexOf(r.pickInfo.pickedMesh)!=-1),i._isHovered&&r.event.button===0&&i.onClickedObservable.notifyObservers(i._camera))},se.a.POINTERDOWN),i}return Object.defineProperty(t.prototype,"displayFrustum",{get:function(){return this._cameraLinesMesh.isEnabled()},set:function(e){this._cameraLinesMesh.setEnabled(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"camera",{get:function(){return this._camera},set:function(e){var i=this;if(this._camera=e,this.attachedNode=e,e){this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._cameraMesh=t._CreateCameraMesh(this.gizmoLayer.utilityLayerScene),this._cameraLinesMesh=t._CreateCameraFrustum(this.gizmoLayer.utilityLayerScene),this._cameraMesh.getChildMeshes(!1).forEach(function(o){o.material=i._material}),this._cameraMesh.parent=this._rootMesh,this._cameraLinesMesh.parent=this._rootMesh,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<e.maxZ*1.5&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=e.maxZ*1.5),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;var r=this.gizmoLayer._getSharedGizmoLight();r.includedOnlyMeshes=r.includedOnlyMeshes.concat(this._cameraMesh.getChildMeshes(!1)),this._update()}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),t.prototype._update=function(){n.prototype._update.call(this),!!this._camera&&(this._camera.getProjectionMatrix().invertToRef(this._invProjection),this._cameraLinesMesh.setPivotMatrix(this._invProjection,!1),this._cameraLinesMesh.scaling.x=1/this._rootMesh.scaling.x,this._cameraLinesMesh.scaling.y=1/this._rootMesh.scaling.y,this._cameraLinesMesh.scaling.z=1/this._rootMesh.scaling.z,this._cameraMesh.parent=null,this._cameraMesh.rotation.y=Math.PI*.5*(this._camera.getScene().useRightHandedSystem?1:-1),this._cameraMesh.parent=this._rootMesh)},t.prototype.dispose=function(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._material.dispose(),n.prototype.dispose.call(this)},t._CreateCameraMesh=function(e){var i=new st.a("rootCameraGizmo",e),r=new st.a(i.name,e);r.parent=i;var o=co.a.CreateBox(i.name,{width:1,height:.8,depth:.5},e);o.parent=r;var a=Tr.a.CreateCylinder(i.name,{height:.5,diameterTop:.8,diameterBottom:.8},e);a.parent=r,a.position.y=.3,a.position.x=-.6,a.rotation.x=Math.PI*.5;var s=Tr.a.CreateCylinder(i.name,{height:.5,diameterTop:.6,diameterBottom:.6},e);s.parent=r,s.position.y=.5,s.position.x=.4,s.rotation.x=Math.PI*.5;var c=Tr.a.CreateCylinder(i.name,{height:.5,diameterTop:.5,diameterBottom:.5},e);return c.parent=r,c.position.y=0,c.position.x=.6,c.rotation.z=Math.PI*.5,i.scaling.scaleInPlace(t._Scale),r.position.x=-.9,i},t._CreateCameraFrustum=function(e){var i=new st.a("rootCameraGizmo",e),r=new st.a(i.name,e);r.parent=i;for(var o=0;o<4;o+=2)for(var a=0;a<4;a+=2){var s=Bi.a.CreateLines("lines",{points:[new l.e(-1+a,-1+o,-1),new l.e(-1+a,-1+o,1)]},e);s.parent=r,s.alwaysSelectAsActiveMesh=!0,s.isPickable=!1;var s=Bi.a.CreateLines("lines",{points:[new l.e(-1,-1+a,-1+o),new l.e(1,-1+a,-1+o)]},e);s.parent=r,s.alwaysSelectAsActiveMesh=!0,s.isPickable=!1;var s=Bi.a.CreateLines("lines",{points:[new l.e(-1+a,-1,-1+o),new l.e(-1+a,1,-1+o)]},e);s.parent=r,s.alwaysSelectAsActiveMesh=!0,s.isPickable=!1}return i},t._Scale=.05,t}(rr.a),mo=u(472),ds=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){a===void 0&&(a=0),s===void 0&&(s=Ze.a.BILINEAR_SAMPLINGMODE),c===void 0&&(c=!0);var _=n.call(this,e,i,r,o,!0,a,!1,s,c)||this;_.scene=r,_.mirrorPlane=new ye.a(0,1,0,1),_._transformMatrix=l.a.Zero(),_._mirrorMatrix=l.a.Zero(),_._adaptiveBlurKernel=0,_._blurKernelX=0,_._blurKernelY=0,_._blurRatio=1,_.ignoreCameraViewport=!0,_._updateGammaSpace(),_._imageProcessingConfigChangeObserver=r.imageProcessingConfiguration.onUpdateParameters.add(function(){_._updateGammaSpace()});var b=_.getScene().getEngine();_.onBeforeBindObservable.add(function(){b._debugPushGroup("mirror generation for "+e,1)}),_.onAfterUnbindObservable.add(function(){b._debugPopGroup(1)});var C;return _.onBeforeRenderObservable.add(function(){l.a.ReflectionToRef(_.mirrorPlane,_._mirrorMatrix),_._mirrorMatrix.multiplyToRef(r.getViewMatrix(),_._transformMatrix),r.setTransformMatrix(_._transformMatrix,r.getProjectionMatrix()),C=r.clipPlane,r.clipPlane=_.mirrorPlane,r.getEngine().cullBackFaces=!1,r._mirroredCameraPosition=l.e.TransformCoordinates(r.activeCamera.globalPosition,_._mirrorMatrix)}),_.onAfterRenderObservable.add(function(){r.updateTransformMatrix(),r.getEngine().cullBackFaces=!0,r._mirroredCameraPosition=null,r.clipPlane=C}),_}return Object.defineProperty(t.prototype,"blurRatio",{get:function(){return this._blurRatio},set:function(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"adaptiveBlurKernel",{set:function(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurKernel",{set:function(e){this.blurKernelX=e,this.blurKernelY=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurKernelX",{get:function(){return this._blurKernelX},set:function(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurKernelY",{get:function(){return this._blurKernelY},set:function(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),t.prototype._autoComputeBlurKernel=function(){var e=this.getScene().getEngine(),i=this.getRenderWidth()/e.getRenderWidth(),r=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*i,this.blurKernelY=this._adaptiveBlurKernel*r},t.prototype._onRatioRescale=function(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()},t.prototype._updateGammaSpace=function(){this.gammaSpace=!this.scene.imageProcessingConfiguration.isEnabled||!this.scene.imageProcessingConfiguration.applyByPostProcess},t.prototype._preparePostProcesses=function(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){var e=this.getScene().getEngine(),i=e.getCaps().textureFloatRender?1:2;this._blurX=new mo.a("horizontal blur",new l.d(1,0),this._blurKernelX,this._blurRatio,null,Ze.a.BILINEAR_SAMPLINGMODE,e,!1,i),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._texture:this._blurX.alwaysForcePOT=!0,this._blurY=new mo.a("vertical blur",new l.d(0,1),this._blurKernelY,this._blurRatio,null,Ze.a.BILINEAR_SAMPLINGMODE,e,!1,i),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)},t.prototype.clone=function(){var e=this.getScene();if(!e)return this;var i=this.getSize(),r=new t(this.name,i.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return r.hasAlpha=this.hasAlpha,r.level=this.level,r.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(r.renderList=this.renderList.slice(0)),r},t.prototype.serialize=function(){if(!this.name)return null;var e=n.prototype.serialize.call(this);return e.mirrorPlane=this.mirrorPlane.asArray(),e},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver)},t}(Cr.a);Ze.a._CreateMirror=function(n,t,e,i){return new ds(n,t,e,i)};var pn=u(504),xt=u(454),ps=u(552),ms=u(553),en=u(480),hu="backgroundFragmentDeclaration",du=` uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;
uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif`;qe.a.IncludesShadersStore[hu]=du;var p_={name:hu,shader:du},pu="backgroundUboDeclaration",mu=`layout(std140,column_major) uniform;
uniform Material
{
uniform vec4 vPrimaryColor;
uniform vec4 vPrimaryColorShadow;
uniform vec2 vDiffuseInfos;
uniform vec2 vReflectionInfos;
uniform mat4 diffuseMatrix;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
uniform float pointSize;
uniform float shadowLevel;
uniform float alpha;
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
};
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif
mat4 view;
vec4 viewPosition;
};`;qe.a.IncludesShadersStore[pu]=mu;var m_={name:pu,shader:mu},g_=u(653),v_=u(524),__=u(650),y_=u(651),b_=u(729),E_=u(652),P_=u(525),C_=u(592),S_=u(597),T_=u(550),A_=u(654),R_=u(655),gu="backgroundPixelShader",vu=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#define RECIPROCAL_PI2 0.15915494

uniform vec4 vEyePosition;

varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV == 1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV == 2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif

#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif

#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif

#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>

#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<helperFunctions>
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<clipPlaneFragmentDeclaration>

#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{

float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
void main(void) {
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);

#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif

float shadow=1.;
float globalShadow=0.;
float shadowLightCount=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY

vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif

#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT

reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);
if(lodReflectionNormalizedDoubled<1.0){
reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);
} else {
reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);
reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif

reflectionColor.rgb*=vReflectionInfos.x;
#endif

vec3 diffuseColor=vec3(1.,1.,1.);
float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif

diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif

#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);

#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif

#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;
vec3 reflectionReflectance0=vReflectionControl.yyy;
vec3 reflectionReflectance90=vReflectionControl.zzz;
float VdotN=dot(normalize(vEyePosition.xyz),normalW);
vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);
reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);
reflectionDistanceFalloff*=reflectionDistanceFalloff;
reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));

const float startAngle=0.1;
float fadeFactor=saturate(viewAngleToFloor/startAngle);
finalAlpha*=fadeFactor*fadeFactor;
#endif

#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif

vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS


color.rgb=clamp(color.rgb,0.,30.0);
#else

color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA

color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);
color=max(color,0.0);
#endif
gl_FragColor=color;
}
`;qe.a.ShadersStore[gu]=vu;var O_={name:gu,shader:vu},_u="backgroundVertexDeclaration",yu=`uniform mat4 view;
uniform mat4 viewProjection;
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif`;qe.a.IncludesShadersStore[_u]=yu;var M_={name:_u,shader:yu},x_=u(487),D_=u(501),I_=u(593),L_=u(656),F_=u(657),B_=u(658),N_=u(488),w_=u(489),V_=u(551),U_=u(702),G_=u(659),bu="backgroundVertexShader",Eu=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>

attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>

#include<instancesDeclaration>

varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
void main(void) {
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#ifdef MULTIVIEW
if (gl_ViewID_OVR == 0u) {
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
} else {
gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);
}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);
vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));
vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));
if (fFovMultiplier<=1.0) {
vDirectionW=normalize(segment);
} else {
vDirectionW=normalize(vDirectionW+(vDirectionW-segment));
}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0
if (vDiffuseInfos.x == 0.)
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));
}
else
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
}
#endif

#include<clipPlaneVertex>

#include<fogVertex>

#include<shadowsVertex>[0..maxSimultaneousLights]

#ifdef VERTEXCOLOR
vColor=color;
#endif

#ifdef POINTSIZE
gl_PointSize=pointSize;
#endif
}
`;qe.a.ShadersStore[bu]=Eu;var z_={name:bu,shader:Eu},gs=u(512),sm=function(n){Object(p.d)(t,n);function t(){var e=n.call(this)||this;return e.DIFFUSE=!1,e.DIFFUSEDIRECTUV=0,e.GAMMADIFFUSE=!1,e.DIFFUSEHASALPHA=!1,e.OPACITYFRESNEL=!1,e.REFLECTIONBLUR=!1,e.REFLECTIONFRESNEL=!1,e.REFLECTIONFALLOFF=!1,e.TEXTURELODSUPPORT=!1,e.PREMULTIPLYALPHA=!1,e.USERGBCOLOR=!1,e.USEHIGHLIGHTANDSHADOWCOLORS=!1,e.BACKMAT_SHADOWONLY=!1,e.NOISE=!1,e.REFLECTIONBGR=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.EXPOSURE=!1,e.MULTIVIEW=!1,e.REFLECTION=!1,e.REFLECTIONMAP_3D=!1,e.REFLECTIONMAP_SPHERICAL=!1,e.REFLECTIONMAP_PLANAR=!1,e.REFLECTIONMAP_CUBIC=!1,e.REFLECTIONMAP_PROJECTION=!1,e.REFLECTIONMAP_SKYBOX=!1,e.REFLECTIONMAP_EXPLICIT=!1,e.REFLECTIONMAP_EQUIRECTANGULAR=!1,e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.INVERTCUBICMAP=!1,e.REFLECTIONMAP_OPPOSITEZ=!1,e.LODINREFLECTIONALPHA=!1,e.GAMMAREFLECTION=!1,e.RGBDREFLECTION=!1,e.EQUIRECTANGULAR_RELFECTION_FOV=!1,e.MAINUV1=!1,e.MAINUV2=!1,e.UV1=!1,e.UV2=!1,e.CLIPPLANE=!1,e.CLIPPLANE2=!1,e.CLIPPLANE3=!1,e.CLIPPLANE4=!1,e.CLIPPLANE5=!1,e.CLIPPLANE6=!1,e.POINTSIZE=!1,e.FOG=!1,e.NORMAL=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.INSTANCES=!1,e.SHADOWFLOAT=!1,e.rebuild(),e}return t}(ps.a),go=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r.primaryColor=v.a.White(),r._primaryColorShadowLevel=0,r._primaryColorHighlightLevel=0,r.reflectionTexture=null,r.reflectionBlur=0,r.diffuseTexture=null,r._shadowLights=null,r.shadowLights=null,r.shadowLevel=0,r.sceneCenter=l.e.Zero(),r.opacityFresnel=!0,r.reflectionFresnel=!1,r.reflectionFalloffDistance=0,r.reflectionAmount=1,r.reflectionReflectance0=.05,r.reflectionReflectance90=.5,r.useRGBColor=!0,r.enableNoise=!1,r._fovMultiplier=1,r.useEquirectangularFOV=!1,r._maxSimultaneousLights=4,r.maxSimultaneousLights=4,r._shadowOnly=!1,r.shadowOnly=!1,r._imageProcessingObserver=null,r.switchToBGR=!1,r._renderTargets=new Ct.a(16),r._reflectionControls=l.f.Zero(),r._white=v.a.White(),r._primaryShadowColor=v.a.Black(),r._primaryHighlightColor=v.a.Black(),r._attachImageProcessingConfiguration(null),r.getRenderTargetTextures=function(){return r._renderTargets.reset(),r._diffuseTexture&&r._diffuseTexture.isRenderTarget&&r._renderTargets.push(r._diffuseTexture),r._reflectionTexture&&r._reflectionTexture.isRenderTarget&&r._renderTargets.push(r._reflectionTexture),r._renderTargets},r}return Object.defineProperty(t.prototype,"_perceptualColor",{get:function(){return this.__perceptualColor},set:function(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"primaryColorShadowLevel",{get:function(){return this._primaryColorShadowLevel},set:function(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"primaryColorHighlightLevel",{get:function(){return this._primaryColorHighlightLevel},set:function(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflectionStandardFresnelWeight",{set:function(e){var i=e;i<.5?(i=i*2,this.reflectionReflectance0=t.StandardReflectance0*i,this.reflectionReflectance90=t.StandardReflectance90*i):(i=i*2-1,this.reflectionReflectance0=t.StandardReflectance0+(1-t.StandardReflectance0)*i,this.reflectionReflectance90=t.StandardReflectance90+(1-t.StandardReflectance90)*i)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fovMultiplier",{get:function(){return this._fovMultiplier},set:function(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))},enumerable:!1,configurable:!0}),t.prototype._attachImageProcessingConfiguration=function(e){var i=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){i._computePrimaryColorFromPerceptualColor(),i._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(t.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this.imageProcessingConfiguration.colorGradingTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraColorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(e){this.imageProcessingConfiguration.colorCurves=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasRenderTargetTextures",{get:function(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)},enumerable:!1,configurable:!0}),t.prototype.needAlphaTesting=function(){return!0},t.prototype.needAlphaBlending=function(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly},t.prototype.isReadyForSubMesh=function(e,i,r){var o=this;if(r===void 0&&(r=!1),i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady)return!0;i._materialDefines||(i._materialDefines=new sm);var a=this.getScene(),s=i._materialDefines;if(this._isReadyForSubMesh(i))return!0;var c=a.getEngine();if(xt.a.PrepareDefinesForLights(a,e,s,!1,this._maxSimultaneousLights),s._needNormals=!0,xt.a.PrepareDefinesForMultiview(a,s),s._areTexturesDirty){if(s._needUVs=!1,a.texturesEnabled){if(a.getEngine().getCaps().textureLOD&&(s.TEXTURELODSUPPORT=!0),this._diffuseTexture&&en.a.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;xt.a.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE"),s.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,s.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,s.OPACITYFRESNEL=this._opacityFresnel}else s.DIFFUSE=!1,s.DIFFUSEHASALPHA=!1,s.GAMMADIFFUSE=!1,s.OPACITYFRESNEL=!1;var _=this._reflectionTexture;if(_&&en.a.ReflectionTextureEnabled){if(!_.isReadyOrNotBlocking())return!1;switch(s.REFLECTION=!0,s.GAMMAREFLECTION=_.gammaSpace,s.RGBDREFLECTION=_.isRGBD,s.REFLECTIONBLUR=this._reflectionBlur>0,s.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!_.invertZ:_.invertZ,s.LODINREFLECTIONALPHA=_.lodLevelInAlpha,s.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,s.REFLECTIONBGR=this.switchToBGR,_.coordinatesMode===Ze.a.INVCUBIC_MODE&&(s.INVERTCUBICMAP=!0),s.REFLECTIONMAP_3D=_.isCube,_.coordinatesMode){case Ze.a.EXPLICIT_MODE:s.REFLECTIONMAP_EXPLICIT=!0;break;case Ze.a.PLANAR_MODE:s.REFLECTIONMAP_PLANAR=!0;break;case Ze.a.PROJECTION_MODE:s.REFLECTIONMAP_PROJECTION=!0;break;case Ze.a.SKYBOX_MODE:s.REFLECTIONMAP_SKYBOX=!0;break;case Ze.a.SPHERICAL_MODE:s.REFLECTIONMAP_SPHERICAL=!0;break;case Ze.a.EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Ze.a.FIXED_EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Ze.a.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Ze.a.CUBIC_MODE:case Ze.a.INVCUBIC_MODE:default:s.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(s.REFLECTIONFRESNEL=!0,s.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1)}else s.REFLECTION=!1,s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1,s.REFLECTIONBLUR=!1,s.REFLECTIONMAP_3D=!1,s.REFLECTIONMAP_SPHERICAL=!1,s.REFLECTIONMAP_PLANAR=!1,s.REFLECTIONMAP_CUBIC=!1,s.REFLECTIONMAP_PROJECTION=!1,s.REFLECTIONMAP_SKYBOX=!1,s.REFLECTIONMAP_EXPLICIT=!1,s.REFLECTIONMAP_EQUIRECTANGULAR=!1,s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,s.INVERTCUBICMAP=!1,s.REFLECTIONMAP_OPPOSITEZ=!1,s.LODINREFLECTIONALPHA=!1,s.GAMMAREFLECTION=!1,s.RGBDREFLECTION=!1}s.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,s.USERGBCOLOR=this._useRGBColor,s.NOISE=this._enableNoise}if(s._areLightsDirty&&(s.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),s.BACKMAT_SHADOWONLY=this._shadowOnly),s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s)}if(xt.a.PrepareDefinesForMisc(e,a,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),s),xt.a.PrepareDefinesForFrameBoundValues(a,c,s,r,null,i.getRenderingMesh().hasThinInstances),xt.a.PrepareDefinesForAttributes(e,s,!1,!0,!1)&&e&&!a.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(Be.b.NormalKind)&&(e.createNormals(!0),d.a.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),s.isDirty){s.markAsProcessed(),a.resetCachedMaterial();var b=new gs.a;s.FOG&&b.addFallback(0,"FOG"),s.POINTSIZE&&b.addFallback(1,"POINTSIZE"),s.MULTIVIEW&&b.addFallback(0,"MULTIVIEW"),xt.a.HandleFallbacksForShadows(s,b,this._maxSimultaneousLights);var C=[Be.b.PositionKind];s.NORMAL&&C.push(Be.b.NormalKind),s.UV1&&C.push(Be.b.UVKind),s.UV2&&C.push(Be.b.UV2Kind),xt.a.PrepareAttributesForBones(C,e,s,b),xt.a.PrepareAttributesForInstances(C,s);var x=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"],V=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],D=["Material","Scene"];gr.a&&(gr.a.PrepareUniforms(x,s),gr.a.PrepareSamplers(V,s)),xt.a.PrepareUniformsAndSamplersList({uniformsNames:x,uniformBuffersNames:D,samplers:V,defines:s,maxSimultaneousLights:this._maxSimultaneousLights});var z=function(ue){o.onCompiled&&o.onCompiled(ue),xt.a.BindSceneUniformBuffer(ue,a.getSceneUniformBuffer())},q=s.toString();i.setEffect(a.getEngine().createEffect("background",{attributes:C,uniformsNames:x,uniformBuffersNames:D,samplers:V,defines:q,fallbacks:b,onCompiled:z,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},c),s),this.buildUniformLayout()}return!i.effect||!i.effect.isReady()?!1:(s._renderId=a.getRenderId(),i.effect._wasPreviouslyReady=!0,!0)},t.prototype._computePrimaryColorFromPerceptualColor=function(){!this.__perceptualColor||(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())},t.prototype._computePrimaryColors=function(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))},t.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()},t.prototype.unbind=function(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),n.prototype.unbind.call(this)},t.prototype.bindOnlyWorldMatrix=function(e){this._activeEffect.setMatrix("world",e)},t.prototype.bindForSubMesh=function(e,i,r){var o=this.getScene(),a=r._materialDefines;if(!!a){var s=r.effect;if(!!s){this._activeEffect=s,this.bindOnlyWorldMatrix(e),xt.a.BindBonesParameters(i,this._activeEffect);var c=this._mustRebind(o,s,i.visibility);if(c){this._uniformBuffer.bindToEffect(s,"Material"),this.bindViewProjection(s);var _=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(o.texturesEnabled&&(this._diffuseTexture&&en.a.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),xt.a.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),_&&en.a.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",_.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",_.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",_.getSize().width,_.lodGenerationScale,_.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),a.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),o.texturesEnabled&&(this._diffuseTexture&&en.a.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),_&&en.a.ReflectionTextureEnabled&&(a.REFLECTIONBLUR&&a.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",_):a.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",_._lodTextureMid||_),this._uniformBuffer.setTexture("reflectionSamplerLow",_._lodTextureLow||_),this._uniformBuffer.setTexture("reflectionSamplerHigh",_._lodTextureHigh||_)):this._uniformBuffer.setTexture("reflectionSampler",_),a.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),xt.a.BindClipPlane(this._activeEffect,o),xt.a.BindEyePosition(s,o)}(c||!this.isFrozen)&&(o.lightsEnabled&&xt.a.BindLights(o,i,this._activeEffect,a,this._maxSimultaneousLights,!1),this.bindView(s),xt.a.BindFogParameters(o,i,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(i,this._activeEffect),this._uniformBuffer.update()}}},t.prototype.hasTexture=function(e){return!!(n.prototype.hasTexture.call(this,e)||this._reflectionTexture===e||this._diffuseTexture===e)},t.prototype.dispose=function(e,i){e===void 0&&(e=!1),i===void 0&&(i=!1),i&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),n.prototype.dispose.call(this,e)},t.prototype.clone=function(e){var i=this;return Ee.a.Clone(function(){return new t(e,i.getScene())},this)},t.prototype.serialize=function(){var e=Ee.a.Serialize(this);return e.customType="BABYLON.BackgroundMaterial",e},t.prototype.getClassName=function(){return"BackgroundMaterial"},t.Parse=function(e,i,r){return Ee.a.Parse(function(){return new t(e.name,i)},e,i,r)},t.StandardReflectance0=.05,t.StandardReflectance90=.5,Object(p.c)([Object(Ee.e)()],t.prototype,"_primaryColor",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"primaryColor",void 0),Object(p.c)([Object(Ee.e)()],t.prototype,"__perceptualColor",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_primaryColorShadowLevel",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_primaryColorHighlightLevel",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"primaryColorHighlightLevel",null),Object(p.c)([Object(Ee.m)()],t.prototype,"_reflectionTexture",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionTexture",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_reflectionBlur",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionBlur",void 0),Object(p.c)([Object(Ee.m)()],t.prototype,"_diffuseTexture",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"diffuseTexture",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"shadowLights",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_shadowLevel",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"shadowLevel",void 0),Object(p.c)([Object(Ee.o)()],t.prototype,"_sceneCenter",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"sceneCenter",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_opacityFresnel",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"opacityFresnel",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_reflectionFresnel",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionFresnel",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_reflectionFalloffDistance",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionFalloffDistance",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_reflectionAmount",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionAmount",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_reflectionReflectance0",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionReflectance0",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_reflectionReflectance90",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"reflectionReflectance90",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_useRGBColor",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"useRGBColor",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_enableNoise",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"enableNoise",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_maxSimultaneousLights",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"maxSimultaneousLights",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_shadowOnly",void 0),Object(p.c)([Object(Ee.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"shadowOnly",void 0),Object(p.c)([Object(Ee.i)()],t.prototype,"_imageProcessingConfiguration",void 0),t}(ms.a);f.a.RegisteredTypes["BABYLON.BackgroundMaterial"]=go;var vs=function(){function n(t,e){var i=this;this._errorHandler=function(r,o){i.onErrorObservable.notifyObservers({message:r,exception:o})},this._options=Object(p.a)(Object(p.a)({},n._getDefaultOptions()),t),this._scene=e,this.onErrorObservable=new g.c,this._setupBackground(),this._setupImageProcessing()}return n._getDefaultOptions=function(){return{createGround:!0,groundSize:15,groundTexture:this._groundTextureCDNUrl,groundColor:new v.a(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._skyboxTextureCDNUrl,skyboxColor:new v.a(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:l.e.Zero(),setupImageProcessing:!0,environmentTexture:this._environmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}},Object.defineProperty(n.prototype,"rootMesh",{get:function(){return this._rootMesh},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"skybox",{get:function(){return this._skybox},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"skyboxTexture",{get:function(){return this._skyboxTexture},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"skyboxMaterial",{get:function(){return this._skyboxMaterial},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ground",{get:function(){return this._ground},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"groundTexture",{get:function(){return this._groundTexture},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"groundMirror",{get:function(){return this._groundMirror},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"groundMirrorRenderList",{get:function(){return this._groundMirror?this._groundMirror.renderList:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"groundMaterial",{get:function(){return this._groundMaterial},enumerable:!1,configurable:!0}),n.prototype.updateOptions=function(t){var e=Object(p.a)(Object(p.a)({},this._options),t);this._ground&&!e.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!e.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=e.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!e.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!e.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=e.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!e.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=e.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=e,this._setupBackground(),this._setupImageProcessing()},n.prototype.setMainColor=function(t){this.groundMaterial&&(this.groundMaterial.primaryColor=t),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=t),this.groundMirror&&(this.groundMirror.clearColor=new v.b(t.r,t.g,t.b,1))},n.prototype._setupImageProcessing=function(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())},n.prototype._setupEnvironmentTexture=function(){if(!this._scene.environmentTexture){if(this._options.environmentTexture instanceof jr.a){this._scene.environmentTexture=this._options.environmentTexture;return}var t=pn.a.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=t}},n.prototype._setupBackground=function(){this._rootMesh||(this._rootMesh=new st.a("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;var t=this._getSceneSize();this._options.createGround&&(this._setupGround(t),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(t),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(t),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=t.rootPosition.x,this._rootMesh.position.z=t.rootPosition.z,this._rootMesh.position.y=t.rootPosition.y},n.prototype._getSceneSize=function(){var t=this,e=this._options.groundSize,i=this._options.skyboxSize,r=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:e,skyboxSize:i,rootPosition:r};var o=this._scene.getWorldExtends(function(c){return c!==t._ground&&c!==t._rootMesh&&c!==t._skybox}),a=o.max.subtract(o.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Ai.a&&this._scene.activeCamera.upperRadiusLimit&&(e=this._scene.activeCamera.upperRadiusLimit*2,i=e);var s=a.length();s>e&&(e=s*2,i=e),e*=1.1,i*=1.5,r=o.min.add(a.scale(.5)),r.y=o.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:i,rootPosition:r}},n.prototype._setupGround=function(t){var e=this;(!this._ground||this._ground.isDisposed())&&(this._ground=st.a.CreatePlane("BackgroundPlane",t.groundSize,this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(function(){e._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow},n.prototype._setupGroundMaterial=function(){this._groundMaterial||(this._groundMaterial=new go("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)},n.prototype._setupGroundDiffuseTexture=function(){if(!!this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof jr.a){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new Ze.a(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}},n.prototype._setupGroundMirrorTexture=function(t){var e=Ze.a.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new ds("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,Ze.a.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new ye.a(0,-1,0,t.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=e,this._groundMirror.wrapV=e,this._groundMirror.gammaSpace=!1,this._groundMirror.renderList))for(var i=0;i<this._scene.meshes.length;i++){var r=this._scene.meshes[i];r!==this._ground&&r!==this._skybox&&r!==this._rootMesh&&this._groundMirror.renderList.push(r)}this._groundMirror.clearColor=new v.b(this._options.groundColor.r,this._options.groundColor.g,this._options.groundColor.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel},n.prototype._setupMirrorInGroundMaterial=function(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)},n.prototype._setupSkybox=function(t){var e=this;(!this._skybox||this._skybox.isDisposed())&&(this._skybox=st.a.CreateBox("BackgroundSkybox",t.skyboxSize,this._scene,void 0,st.a.BACKSIDE),this._skybox.onDisposeObservable.add(function(){e._skybox=null})),this._skybox.parent=this._rootMesh},n.prototype._setupSkyboxMaterial=function(){!this._skybox||(this._skyboxMaterial||(this._skyboxMaterial=new go("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)},n.prototype._setupSkyboxReflectionTexture=function(){if(!!this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof jr.a){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new pn.a(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=Ze.a.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}},n.prototype.dispose=function(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)},n._groundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",n._skyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",n._environmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env",n}(),tn=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){a===void 0&&(a=null);var s=n.call(this,e,o)||this;s.onError=a,s._halfDome=!1,s._crossEye=!1,s._useDirectMapping=!1,s._textureMode=t.MODE_MONOSCOPIC,s._onBeforeCameraRenderObserver=null,s.onLoadErrorObservable=new g.c,s.onLoadObservable=new g.c,o=s.getScene(),e=e||"textureDome",r.resolution=Math.abs(r.resolution)|0||32,r.clickToPlay=Boolean(r.clickToPlay),r.autoPlay=r.autoPlay===void 0?!0:Boolean(r.autoPlay),r.loop=r.loop===void 0?!0:Boolean(r.loop),r.size=Math.abs(r.size)||(o.activeCamera?o.activeCamera.maxZ*.48:1e3),r.useDirectMapping===void 0?s._useDirectMapping=!0:s._useDirectMapping=r.useDirectMapping,r.faceForward===void 0&&(r.faceForward=!0),s._setReady(!1),r.mesh?s._mesh=r.mesh:s._mesh=st.a.CreateSphere(e+"_mesh",r.resolution,r.size,o,!1,st.a.BACKSIDE);var c=s._material=new go(e+"_material",o);c.useEquirectangularFOV=!0,c.fovMultiplier=1,c.opacityFresnel=!1;var _=s._initTexture(i,o,r);if(s.texture=_,s._mesh.material=c,s._mesh.parent=s,s._halfDomeMask=nr.a.CreateSphere("",{slice:.5,diameter:r.size*.98,segments:r.resolution*2,sideOrientation:st.a.BACKSIDE},o),s._halfDomeMask.rotate(tt.c.X,-Math.PI/2),s._halfDomeMask.parent=s._mesh,s._halfDome=!!r.halfDomeMode,s._halfDomeMask.setEnabled(s._halfDome),s._crossEye=!!r.crossEyeMode,s._texture.anisotropicFilteringLevel=1,s._texture.onLoadObservable.addOnce(function(){s._setReady(!0)}),r.faceForward&&o.activeCamera){var b=o.activeCamera,C=l.e.Forward(),x=l.e.TransformNormal(C,b.getViewMatrix());x.normalize(),s.rotation.y=Math.acos(l.e.Dot(C,x))}return s._changeTextureMode(s._textureMode),s}return Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=Ze.a.CLAMP_ADDRESSMODE,this._texture.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=Ze.a.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fovMultiplier",{get:function(){return this._material.fovMultiplier},set:function(e){this._material.fovMultiplier=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textureMode",{get:function(){return this._textureMode},set:function(e){this._textureMode!==e&&this._changeTextureMode(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"halfDome",{get:function(){return this._halfDome},set:function(e){this._halfDome=e,this._halfDomeMask.setEnabled(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"crossEye",{get:function(){return this._crossEye},set:function(e){this._crossEye=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),t.prototype._changeTextureMode=function(e){var i=this;switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case t.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case t.MODE_SIDEBYSIDE:this._texture.uScale=this._halfDome?.99999:.5;var r=this._halfDome?0:.5,o=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(function(a){var s=a.isRightCamera;i._crossEye&&(s=!s),s?i._texture.uOffset=r:i._texture.uOffset=o});break;case t.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(function(a){var s=a.isRightCamera;i._crossEye&&(s=!s),i._texture.vOffset=s?.5:0});break}},t.prototype.dispose=function(e,i){i===void 0&&(i=!1),this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),n.prototype.dispose.call(this,e,i)},t.MODE_MONOSCOPIC=0,t.MODE_TOPBOTTOM=1,t.MODE_SIDEBYSIDE=2,t}(po.a),lm=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return Object.defineProperty(t.prototype,"photoTexture",{get:function(){return this.texture},set:function(e){this.texture=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"imageMode",{get:function(){return this.textureMode},set:function(e){this.textureMode=e},enumerable:!1,configurable:!0}),t.prototype._initTexture=function(e,i,r){var o=this;return new Ze.a(e,i,!r.generateMipMaps,!this._useDirectMapping,void 0,function(){o.onLoadObservable.notifyObservers()},function(a,s){o.onLoadErrorObservable.notifyObservers(a||"Unknown error occured"),o.onError&&o.onError(a,s)})},t.MODE_MONOSCOPIC=tn.MODE_MONOSCOPIC,t.MODE_TOPBOTTOM=tn.MODE_TOPBOTTOM,t.MODE_SIDEBYSIDE=tn.MODE_SIDEBYSIDE,t}(tn),Pu=u(533),Cu=u(521),um=542327876,Su=131072,Tu=512,Au=4,Ru=64,Ou=131072;function Jo(n){return n.charCodeAt(0)+(n.charCodeAt(1)<<8)+(n.charCodeAt(2)<<16)+(n.charCodeAt(3)<<24)}function cm(n){return String.fromCharCode(n&255,n>>8&255,n>>16&255,n>>24&255)}var Mu=Jo("DXT1"),xu=Jo("DXT3"),Du=Jo("DXT5"),_s=Jo("DX10"),Iu=113,Lu=116,Fu=2,Bu=10,fm=88,ys=31,hm=0,dm=1,Nu=2,wu=3,bs=4,Vu=7,Es=20,Uu=21,pm=22,mm=23,gm=24,vm=25,_m=26,ym=28,bm=32,rn=function(){function n(){}return n.GetDDSInfo=function(t){var e=new Int32Array(t.buffer,t.byteOffset,ys),i=new Int32Array(t.buffer,t.byteOffset,ys+4),r=1;e[Nu]&Su&&(r=Math.max(1,e[Vu]));var o=e[Uu],a=o===_s?i[bm]:0,s=0;switch(o){case Iu:s=2;break;case Lu:s=1;break;case _s:if(a===Bu){s=2;break}if(a===Fu){s=1;break}}return{width:e[bs],height:e[wu],mipmapCount:r,isFourCC:(e[Es]&Au)===Au,isRGB:(e[Es]&Ru)===Ru,isLuminance:(e[Es]&Ou)===Ou,isCube:(e[ym]&Tu)===Tu,isCompressed:o===Mu||o===xu||o===Du,dxgiFormat:a,textureType:s}},n._ToHalfFloat=function(t){n._FloatView||(n._FloatView=new Float32Array(1),n._Int32View=new Int32Array(n._FloatView.buffer)),n._FloatView[0]=t;var e=n._Int32View[0],i=e>>16&32768,r=e>>12&2047,o=e>>23&255;return o<103?i:o>142?(i|=31744,i|=(o==255?0:1)&&e&8388607,i):o<113?(r|=2048,i|=(r>>114-o)+(r>>113-o&1),i):(i|=o-112<<10|r>>1,i+=r&1,i)},n._FromHalfFloat=function(t){var e=(t&32768)>>15,i=(t&31744)>>10,r=t&1023;return i===0?(e?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):i==31?r?NaN:(e?-1:1)*Infinity:(e?-1:1)*Math.pow(2,i-15)*(1+r/Math.pow(2,10))},n._GetHalfFloatAsFloatRGBAArrayBuffer=function(t,e,i,r,o,a){for(var s=new Float32Array(r),c=new Uint16Array(o,i),_=0,b=0;b<e;b++)for(var C=0;C<t;C++){var x=(C+b*t)*4;s[_]=n._FromHalfFloat(c[x]),s[_+1]=n._FromHalfFloat(c[x+1]),s[_+2]=n._FromHalfFloat(c[x+2]),n.StoreLODInAlphaChannel?s[_+3]=a:s[_+3]=n._FromHalfFloat(c[x+3]),_+=4}return s},n._GetHalfFloatRGBAArrayBuffer=function(t,e,i,r,o,a){if(n.StoreLODInAlphaChannel){for(var s=new Uint16Array(r),c=new Uint16Array(o,i),_=0,b=0;b<e;b++)for(var C=0;C<t;C++){var x=(C+b*t)*4;s[_]=c[x],s[_+1]=c[x+1],s[_+2]=c[x+2],s[_+3]=n._ToHalfFloat(a),_+=4}return s}return new Uint16Array(o,i,r)},n._GetFloatRGBAArrayBuffer=function(t,e,i,r,o,a){if(n.StoreLODInAlphaChannel){for(var s=new Float32Array(r),c=new Float32Array(o,i),_=0,b=0;b<e;b++)for(var C=0;C<t;C++){var x=(C+b*t)*4;s[_]=c[x],s[_+1]=c[x+1],s[_+2]=c[x+2],s[_+3]=a,_+=4}return s}return new Float32Array(o,i,r)},n._GetFloatAsUIntRGBAArrayBuffer=function(t,e,i,r,o,a){for(var s=new Uint8Array(r),c=new Float32Array(o,i),_=0,b=0;b<e;b++)for(var C=0;C<t;C++){var x=(C+b*t)*4;s[_]=$e.a.Clamp(c[x])*255,s[_+1]=$e.a.Clamp(c[x+1])*255,s[_+2]=$e.a.Clamp(c[x+2])*255,n.StoreLODInAlphaChannel?s[_+3]=a:s[_+3]=$e.a.Clamp(c[x+3])*255,_+=4}return s},n._GetHalfFloatAsUIntRGBAArrayBuffer=function(t,e,i,r,o,a){for(var s=new Uint8Array(r),c=new Uint16Array(o,i),_=0,b=0;b<e;b++)for(var C=0;C<t;C++){var x=(C+b*t)*4;s[_]=$e.a.Clamp(n._FromHalfFloat(c[x]))*255,s[_+1]=$e.a.Clamp(n._FromHalfFloat(c[x+1]))*255,s[_+2]=$e.a.Clamp(n._FromHalfFloat(c[x+2]))*255,n.StoreLODInAlphaChannel?s[_+3]=a:s[_+3]=$e.a.Clamp(n._FromHalfFloat(c[x+3]))*255,_+=4}return s},n._GetRGBAArrayBuffer=function(t,e,i,r,o,a,s,c,_){for(var b=new Uint8Array(r),C=new Uint8Array(o,i),x=0,V=0;V<e;V++)for(var D=0;D<t;D++){var z=(D+V*t)*4;b[x]=C[z+a],b[x+1]=C[z+s],b[x+2]=C[z+c],b[x+3]=C[z+_],x+=4}return b},n._ExtractLongWordOrder=function(t){return t===0||t===255||t===-16777216?0:1+n._ExtractLongWordOrder(t>>8)},n._GetRGBArrayBuffer=function(t,e,i,r,o,a,s,c){for(var _=new Uint8Array(r),b=new Uint8Array(o,i),C=0,x=0;x<e;x++)for(var V=0;V<t;V++){var D=(V+x*t)*3;_[C]=b[D+a],_[C+1]=b[D+s],_[C+2]=b[D+c],C+=3}return _},n._GetLuminanceArrayBuffer=function(t,e,i,r,o){for(var a=new Uint8Array(r),s=new Uint8Array(o,i),c=0,_=0;_<e;_++)for(var b=0;b<t;b++){var C=b+_*t;a[c]=s[C],c++}return a},n.UploadDDSLevels=function(t,e,i,r,o,a,s,c){s===void 0&&(s=-1);var _=null;r.sphericalPolynomial&&(_=new Array);var b=!!t.getCaps().s3tc;e.generateMipMaps=o;var C=new Int32Array(i.buffer,i.byteOffset,ys),x,V,D,z=0,q,ue,ge,Se,Pe=0,me=1;if(C[hm]!==um){d.a.Error("Invalid magic number in DDS header");return}if(!r.isFourCC&&!r.isRGB&&!r.isLuminance){d.a.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(r.isCompressed&&!b){d.a.Error("Compressed textures are not supported on this platform.");return}var xe=C[pm];q=C[dm]+4;var Fe=!1;if(r.isFourCC)switch(x=C[Uu],x){case Mu:me=8,Pe=33777;break;case xu:me=16,Pe=33778;break;case Du:me=16,Pe=33779;break;case Iu:Fe=!0;break;case Lu:Fe=!0;break;case _s:q+=5*4;var we=!1;switch(r.dxgiFormat){case Bu:case Fu:Fe=!0,we=!0;break;case fm:r.isRGB=!0,r.isFourCC=!1,xe=32,we=!0;break}if(we)break;default:console.error("Unsupported FourCC code:",cm(x));return}var Ge=n._ExtractLongWordOrder(C[mm]),Xe=n._ExtractLongWordOrder(C[gm]),Oe=n._ExtractLongWordOrder(C[vm]),je=n._ExtractLongWordOrder(C[_m]);Fe&&(Pe=t._getRGBABufferInternalSizedFormat(r.textureType)),ge=1,C[Nu]&Su&&o!==!1&&(ge=Math.max(1,C[Vu]));for(var ke=c||0,ze=ke;ze<a;ze++){for(V=C[bs],D=C[wu],Se=0;Se<ge;++Se){if(s===-1||s===Se){var Je=s===-1?Se:0;if(!r.isCompressed&&r.isFourCC){e.format=5,z=V*D*4;var it=null;t._badOS||t._badDesktopOS||!t.getCaps().textureHalfFloat&&!t.getCaps().textureFloat?(xe===128?(it=n._GetFloatAsUIntRGBAArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Je),_&&Je==0&&_.push(n._GetFloatRGBAArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Je))):xe===64&&(it=n._GetHalfFloatAsUIntRGBAArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Je),_&&Je==0&&_.push(n._GetHalfFloatAsFloatRGBAArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Je))),e.type=0):xe===128?(e.type=1,it=n._GetFloatRGBAArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Je),_&&Je==0&&_.push(it)):xe===64&&!t.getCaps().textureHalfFloat?(e.type=1,it=n._GetHalfFloatAsFloatRGBAArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Je),_&&Je==0&&_.push(it)):(e.type=2,it=n._GetHalfFloatRGBAArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Je),_&&Je==0&&_.push(n._GetHalfFloatAsFloatRGBAArrayBuffer(V,D,q,z,i.buffer,Je))),it&&t._uploadDataToTextureDirectly(e,it,ze,Je)}else if(r.isRGB)e.type=0,xe===24?(e.format=4,z=V*D*3,ue=n._GetRGBArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Ge,Xe,Oe),t._uploadDataToTextureDirectly(e,ue,ze,Je)):(e.format=5,z=V*D*4,ue=n._GetRGBAArrayBuffer(V,D,i.byteOffset+q,z,i.buffer,Ge,Xe,Oe,je),t._uploadDataToTextureDirectly(e,ue,ze,Je));else if(r.isLuminance){var Ke=t._getUnpackAlignement(),St=V,Mt=Math.floor((V+Ke-1)/Ke)*Ke;z=Mt*(D-1)+St,ue=n._GetLuminanceArrayBuffer(V,D,i.byteOffset+q,z,i.buffer),e.format=1,e.type=0,t._uploadDataToTextureDirectly(e,ue,ze,Je)}else z=Math.max(4,V)/4*Math.max(4,D)/4*me,ue=new Uint8Array(i.buffer,i.byteOffset+q,z),e.type=0,t._uploadCompressedDataToTextureDirectly(e,Pe,V,D,ue,ze,Je)}q+=xe?V*D*(xe/8):z,V*=.5,D*=.5,V=Math.max(1,V),D=Math.max(1,D)}if(c!==void 0)break}_&&_.length>0?r.sphericalPolynomial=Cu.a.ConvertCubeMapToSphericalPolynomial({size:C[bs],right:_[0],left:_[1],up:_[2],down:_[3],front:_[4],back:_[5],format:5,type:1,gammaSpace:!1}):r.sphericalPolynomial=void 0},n.StoreLODInAlphaChannel=!1,n}();fn.a.prototype.createPrefilteredCubeTexture=function(n,t,e,i,r,o,a,s,c){var _=this;r===void 0&&(r=null),o===void 0&&(o=null),s===void 0&&(s=null),c===void 0&&(c=!0);var b=function(C){if(!C){r&&r(null);return}var x=C.texture;if(c?C.info.sphericalPolynomial&&(x._sphericalPolynomial=C.info.sphericalPolynomial):x._sphericalPolynomial=new uo.b,x._source=gt.b.CubePrefiltered,_.getCaps().textureLOD){r&&r(x);return}var V=3,D=_._gl,z=C.width;if(!!z){for(var q=[],ue=0;ue<V;ue++){var ge=ue/(V-1),Se=1-ge,Pe=i,me=$e.a.Log2(z)*e+i,xe=Pe+(me-Pe)*Se,Fe=Math.round(Math.min(Math.max(xe,0),me)),we=new gt.a(_,gt.b.Temp);if(we.type=x.type,we.format=x.format,we.width=Math.pow(2,Math.max($e.a.Log2(z)-Fe,0)),we.height=we.width,we.isCube=!0,_._bindTextureDirectly(D.TEXTURE_CUBE_MAP,we,!0),we.samplingMode=2,D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MAG_FILTER,D.LINEAR),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MIN_FILTER,D.LINEAR),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),C.isDDS){var Ge=C.info,Xe=C.data;_._unpackFlipY(Ge.isCompressed),rn.UploadDDSLevels(_,we,Xe,Ge,!0,6,Fe)}else d.a.Warn("DDS is the only prefiltered cube map supported so far.");_._bindTextureDirectly(D.TEXTURE_CUBE_MAP,null);var Oe=new jr.a(t);Oe.isCube=!0,Oe._texture=we,we.isReady=!0,q.push(Oe)}x._lodTextureHigh=q[2],x._lodTextureMid=q[1],x._lodTextureLow=q[0],r&&r(x)}};return this.createCubeTexture(n,t,null,!1,b,o,a,s,c,e,i)};var Ar=u(473),Gu=function(){function n(){this.supportCascades=!0}return n.prototype.canLoad=function(t){return Ar.a.EndsWith(t,".dds")},n.prototype.loadCubeData=function(t,e,i,r,o){var a=e.getEngine(),s,c=!1;if(Array.isArray(t))for(var _=0;_<t.length;_++){var b=t[_];s=rn.GetDDSInfo(b),e.width=s.width,e.height=s.height,c=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&e.generateMipMaps,a._unpackFlipY(s.isCompressed),rn.UploadDDSLevels(a,e,b,s,c,6,-1,_),!s.isFourCC&&s.mipmapCount===1&&a.generateMipMapsForCubemap(e)}else{var C=t;s=rn.GetDDSInfo(C),e.width=s.width,e.height=s.height,i&&(s.sphericalPolynomial=new uo.b),c=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&e.generateMipMaps,a._unpackFlipY(s.isCompressed),rn.UploadDDSLevels(a,e,C,s,c,6),!s.isFourCC&&s.mipmapCount===1&&a.generateMipMapsForCubemap(e,!1)}a._setCubeMapTextureParams(e,c),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r({isDDS:!0,width:e.width,info:s,data:t,texture:e})},n.prototype.loadData=function(t,e,i){var r=rn.GetDDSInfo(t),o=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&e.generateMipMaps&&r.width>>r.mipmapCount-1==1;i(r.width,r.height,o,r.isFourCC,function(){rn.UploadDDSLevels(e.getEngine(),e,t,r,o,1)})},n}();G.a._TextureLoaders.push(new Gu);var zu=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t){return Ar.a.EndsWith(t,".env")},n.prototype.loadCubeData=function(t,e,i,r,o){if(!Array.isArray(t)){var a=Wr.GetEnvInfo(t);if(a){e.width=a.width,e.height=a.width;try{Wr.UploadEnvSpherical(e,a),Wr.UploadEnvLevelsAsync(e,t,a).then(function(){e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()},function(s){o==null||o("Can not upload environment levels",s)})}catch(s){o==null||o("Can not upload environment file",s)}}else o&&o("Can not parse the environment file",null)}},n.prototype.loadData=function(t,e,i){throw".env not supported in 2d."},n}();G.a._TextureLoaders.push(new zu);var $o=function(){function n(t,e,i,r){if(this.data=t,this.isInvalid=!1,!n.IsValid(t)){this.isInvalid=!0,d.a.Error("texture missing KTX identifier");return}var o=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(this.data.buffer,this.data.byteOffset+12,13*o),s=a.getUint32(0,!0),c=s===67305985;if(this.glType=a.getUint32(1*o,c),this.glTypeSize=a.getUint32(2*o,c),this.glFormat=a.getUint32(3*o,c),this.glInternalFormat=a.getUint32(4*o,c),this.glBaseInternalFormat=a.getUint32(5*o,c),this.pixelWidth=a.getUint32(6*o,c),this.pixelHeight=a.getUint32(7*o,c),this.pixelDepth=a.getUint32(8*o,c),this.numberOfArrayElements=a.getUint32(9*o,c),this.numberOfFaces=a.getUint32(10*o,c),this.numberOfMipmapLevels=a.getUint32(11*o,c),this.bytesOfKeyValueData=a.getUint32(12*o,c),this.glType!==0){d.a.Error("only compressed formats currently supported");return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){d.a.Error("only 2D textures currently supported");return}if(this.numberOfArrayElements!==0){d.a.Error("texture arrays not currently supported");return}if(this.numberOfFaces!==e){d.a.Error("number of faces expected"+e+", but found "+this.numberOfFaces);return}this.loadType=n.COMPRESSED_2D}return n.prototype.uploadLevels=function(t,e){switch(this.loadType){case n.COMPRESSED_2D:this._upload2DCompressedLevels(t,e);break;case n.TEX_2D:case n.COMPRESSED_3D:case n.TEX_3D:}},n.prototype._upload2DCompressedLevels=function(t,e){for(var i=n.HEADER_LEN+this.bytesOfKeyValueData,r=this.pixelWidth,o=this.pixelHeight,a=e?this.numberOfMipmapLevels:1,s=0;s<a;s++){var c=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(var _=0;_<this.numberOfFaces;_++){var b=new Uint8Array(this.data.buffer,this.data.byteOffset+i,c),C=t.getEngine();C._uploadCompressedDataToTextureDirectly(t,this.glInternalFormat,r,o,b,_,s),i+=c,i+=3-(c+3)%4}r=Math.max(1,r*.5),o=Math.max(1,o*.5)}},n.IsValid=function(t){if(t.byteLength>=12){var e=new Uint8Array(t.buffer,t.byteOffset,12);if(e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===49&&e[6]===49&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10)return!0}return!1},n.HEADER_LEN=12+13*4,n.COMPRESSED_2D=0,n.COMPRESSED_3D=1,n.TEX_2D=2,n.TEX_3D=3,n}(),ju=u(575),Ps=function(){function n(t,e){e===void 0&&(e=n.DefaultNumWorkers),this._engine=t,n._Initialized||n._CreateWorkerPool(e)}return n.GetDefaultNumWorkers=function(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)},n._CreateWorkerPool=function(t){this._Initialized=!0,t&&typeof Worker=="function"?n._WorkerPoolPromise=new Promise(function(e){for(var i="("+Em+")()",r=URL.createObjectURL(new Blob([i],{type:"application/javascript"})),o=new Array(t),a=0;a<o.length;a++)o[a]=new Promise(function(s,c){var _=new Worker(r),b=function(x){_.removeEventListener("error",b),_.removeEventListener("message",C),c(x)},C=function(x){x.data.action==="init"&&(_.removeEventListener("error",b),_.removeEventListener("message",C),s(_))};_.addEventListener("error",b),_.addEventListener("message",C),_.postMessage({action:"init",urls:n.URLConfig})});Promise.all(o).then(function(s){e(new ju.a(s))})}):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0)},n.prototype.uploadAsync=function(t,e,i){var r=this,o=this._engine.getCaps(),a={astc:!!o.astc,bptc:!!o.bptc,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,etc1:!!o.etc1};return n._WorkerPoolPromise?n._WorkerPoolPromise.then(function(s){return new Promise(function(c,_){s.push(function(b,C){var x=function(D){b.removeEventListener("error",x),b.removeEventListener("message",V),_(D),C()},V=function(D){if(D.data.action==="decoded"){if(b.removeEventListener("error",x),b.removeEventListener("message",V),!D.data.success)_({message:D.data.msg});else try{r._createTexture(D.data.decodedData,e,i),c()}catch(z){_({message:z})}C()}};b.addEventListener("error",x),b.addEventListener("message",V),b.postMessage({action:"decode",data:t,caps:a,options:i})})})}):new Promise(function(s,c){n._Ktx2Decoder||(n._Ktx2Decoder=new KTX2DECODER.KTX2Decoder),n._Ktx2Decoder.decode(t,o).then(function(_){r._createTexture(_,e),s()}).catch(function(_){c({message:_})})})},n.prototype.dispose=function(){n._WorkerPoolPromise&&n._WorkerPoolPromise.then(function(t){t.dispose()}),delete n._WorkerPoolPromise},n.prototype._createTexture=function(t,e,i){var r=3553;if(this._engine._bindTextureDirectly(r,e),i&&(i.transcodedFormat=t.transcodedFormat,i.isInGammaSpace=t.isInGammaSpace,i.hasAlpha=t.hasAlpha,i.transcoderName=t.transcoderName),t.transcodedFormat===32856?(e.type=0,e.format=5):e.format=t.transcodedFormat,e._gammaSpace=t.isInGammaSpace,e.generateMipMaps=t.mipmaps.length>1,t.errors)throw new Error("KTX2 container - could not transcode the data. "+t.errors);for(var o=0;o<t.mipmaps.length;++o){var a=t.mipmaps[o];if(!a||!a.data)throw new Error("KTX2 container - could not transcode one of the image");t.transcodedFormat===32856?(e.width=a.width,e.height=a.height,this._engine._uploadDataToTextureDirectly(e,a.data,0,o,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(e,t.transcodedFormat,a.width,a.height,a.data,0,o)}e.width=t.mipmaps[0].width,e.height=t.mipmaps[0].height,e.isReady=!0,this._engine._bindTextureDirectly(r,null)},n.IsValid=function(t){if(t.byteLength>=12){var e=new Uint8Array(t.buffer,t.byteOffset,12);if(e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===50&&e[6]===48&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10)return!0}return!1},n.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},n.DefaultNumWorkers=n.GetDefaultNumWorkers(),n}();function Em(){var n;onmessage=function(t){switch(t.data.action){case"init":var e=t.data.urls;importScripts(e.jsDecoderModule),e.wasmUASTCToASTC!==null&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7!==null&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.jsMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder!==null&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder),n=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break;case"decode":n.decode(t.data.data,t.data.caps,t.data.options).then(function(i){for(var r=[],o=0;o<i.mipmaps.length;++o){var a=i.mipmaps[o];a&&a.data&&r.push(a.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:i},r)}).catch(function(i){postMessage({action:"decoded",success:!1,msg:i})});break}}}var Wu=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t,e){return Ar.a.EndsWith(t,".ktx")||Ar.a.EndsWith(t,".ktx2")||e==="image/ktx"||e==="image/ktx2"},n.prototype.loadCubeData=function(t,e,i,r,o){if(!Array.isArray(t)){e._invertVScale=!e.invertY;var a=e.getEngine(),s=new $o(t,6),c=s.numberOfMipmapLevels>1&&e.generateMipMaps;a._unpackFlipY(!0),s.uploadLevels(e,e.generateMipMaps),e.width=s.pixelWidth,e.height=s.pixelHeight,a._setCubeMapTextureParams(e,c),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()}},n.prototype.loadData=function(t,e,i,r){if($o.IsValid(t)){e._invertVScale=!e.invertY;var o=new $o(t,1);i(o.pixelWidth,o.pixelHeight,e.generateMipMaps,!0,function(){o.uploadLevels(e,e.generateMipMaps)},o.isInvalid)}else if(Ps.IsValid(t)){var a=new Ps(e.getEngine());a.uploadAsync(t,e,r).then(function(){i(e.width,e.height,e.generateMipMaps,!0,function(){},!1)},function(s){d.a.Warn("Failed to load KTX2 texture data: "+s.message),i(0,0,!1,!1,function(){},!0)})}else d.a.Error("texture missing KTX identifier"),i(0,0,!1,!1,function(){},!0)},n}();G.a._TextureLoaders.unshift(new Wu);var Hu=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,l.e.Zero(),i)||this;return o._xrSessionManager=r,o._firstFrame=!1,o._referenceQuaternion=l.b.Identity(),o._referencedPosition=new l.e,o._xrInvPositionCache=new l.e,o._xrInvQuaternionCache=l.b.Identity(),o._trackingState=Nr.NOT_TRACKING,o.onBeforeCameraTeleport=new g.c,o.onAfterCameraTeleport=new g.c,o.onTrackingStateChanged=new g.c,o.compensateOnFirstFrame=!0,o._rotate180=new l.b(0,1,0,0),o.minZ=.1,o.rotationQuaternion=new l.b,o.cameraRigMode=te.a.RIG_MODE_CUSTOM,o.updateUpVectorFromRotation=!0,o._updateNumberOfRigCameras(1),o.freezeProjectionMatrix(),o._xrSessionManager.onXRSessionInit.add(function(){o._referencedPosition.copyFromFloats(0,0,0),o._referenceQuaternion.copyFromFloats(0,0,0,1),o._firstFrame=o.compensateOnFirstFrame}),o._xrSessionManager.onXRFrameObservable.add(function(a){o._firstFrame&&o._updateFromXRSession(),o._updateReferenceSpace(),o._updateFromXRSession()},void 0,!0),o}return Object.defineProperty(t.prototype,"trackingState",{get:function(){return this._trackingState},enumerable:!1,configurable:!0}),t.prototype._setTrackingState=function(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))},Object.defineProperty(t.prototype,"realWorldHeight",{get:function(){var e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0},enumerable:!1,configurable:!0}),t.prototype._updateForDualEyeDebugging=function(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new lr.a(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new lr.a(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null},t.prototype.setTransformationFromNonVRCamera=function(e,i){if(e===void 0&&(e=this.getScene().activeCamera),i===void 0&&(i=!0),!(!e||e===this)){var r=e.computeWorldMatrix();r.decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,l.b.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,i&&this._xrSessionManager.resetReferenceSpace()}},t.prototype.getClassName=function(){return"WebXRCamera"},t.prototype._updateFromXRSession=function(){var e=this,i=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(!i){this._setTrackingState(Nr.NOT_TRACKING);return}var r=i.emulatedPosition?Nr.TRACKING_LOST:Nr.TRACKING;if(this._setTrackingState(r),i.transform){var o=i.transform.position;this._referencedPosition.set(o.x,o.y,o.z);var a=i.transform.orientation;this._referenceQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==i.views.length&&this._updateNumberOfRigCameras(i.views.length),i.views.forEach(function(s,c){var _=e.rigCameras[c];!_.isLeftCamera&&!_.isRightCamera&&(s.eye==="right"?_._isRightCamera=!0:s.eye==="left"&&(_._isLeftCamera=!0));var b=s.transform.position,C=s.transform.orientation;if(_.position.set(b.x,b.y,b.z),_.rotationQuaternion.set(C.x,C.y,C.z,C.w),e._scene.useRightHandedSystem?_.rotationQuaternion.multiplyInPlace(e._rotate180):(_.position.z*=-1,_.rotationQuaternion.z*=-1,_.rotationQuaternion.w*=-1),l.a.FromFloat32ArrayToRefScaled(s.projectionMatrix,0,1,_._projectionMatrix),e._scene.useRightHandedSystem||_._projectionMatrix.toggleProjectionMatrixHandInPlace(),c===0&&e._projectionMatrix.copyFrom(_._projectionMatrix),e._xrSessionManager.session.renderState.baseLayer){var x=e._xrSessionManager.session.renderState.baseLayer.getViewport(s),V=e._xrSessionManager.session.renderState.baseLayer.framebufferWidth,D=e._xrSessionManager.session.renderState.baseLayer.framebufferHeight;_.viewport.width=x.width/V,_.viewport.height=x.height/D,_.viewport.x=x.x/V,_.viewport.y=x.y/D}_.outputRenderTarget=e._xrSessionManager.getRenderTargetTextureForEye(s.eye)})},t.prototype._updateNumberOfRigCameras=function(e){for(e===void 0&&(e=1);this.rigCameras.length<e;){var i=new Ii.a("XR-RigCamera: "+this.rigCameras.length,l.e.Zero(),this.getScene());i.minZ=.1,i.rotationQuaternion=new l.b,i.updateUpVectorFromRotation=!0,i.isRigCamera=!0,i.rigParent=this,i.freezeProjectionMatrix(),this.rigCameras.push(i)}for(;this.rigCameras.length>e;){var r=this.rigCameras.pop();r&&r.dispose()}},t.prototype._updateReferenceSpace=function(){(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion))&&(this.position.subtractToRef(this._referencedPosition,this._referencedPosition),this._referenceQuaternion.conjugateInPlace(),this._referenceQuaternion.multiplyToRef(this.rotationQuaternion,this._referenceQuaternion),this._updateReferenceSpaceOffset(this._referencedPosition,this._referenceQuaternion.normalize()))},t.prototype._updateReferenceSpaceOffset=function(e,i,r){if(r===void 0&&(r=!1),!(!this._xrSessionManager.referenceSpace||!this._xrSessionManager.currentFrame)){this._xrInvPositionCache.copyFrom(e),i?this._xrInvQuaternionCache.copyFrom(i):this._xrInvQuaternionCache.copyFromFloats(0,0,0,1),this._scene.useRightHandedSystem||(this._xrInvPositionCache.z*=-1,this._xrInvQuaternionCache.z*=-1,this._xrInvQuaternionCache.w*=-1),this._xrInvPositionCache.negateInPlace(),this._xrInvQuaternionCache.conjugateInPlace(),this._xrInvPositionCache.rotateByQuaternionToRef(this._xrInvQuaternionCache,this._xrInvPositionCache),r&&(this._xrInvPositionCache.y=0);var o=new XRRigidTransform({x:this._xrInvPositionCache.x,y:this._xrInvPositionCache.y,z:this._xrInvPositionCache.z},{x:this._xrInvQuaternionCache.x,y:this._xrInvQuaternionCache.y,z:this._xrInvQuaternionCache.z,w:this._xrInvQuaternionCache.w}),a=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(o),s=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(a);if(s){var c=new l.e(s.transform.position.x,s.transform.position.y,s.transform.position.z);this._scene.useRightHandedSystem||(c.z*=-1),this.position.subtractToRef(c,c),this._scene.useRightHandedSystem||(c.z*=-1),c.negateInPlace();var _=new XRRigidTransform({x:c.x,y:c.y,z:c.z});this._xrSessionManager.referenceSpace=a.getOffsetReferenceSpace(_)}}},t}(kt.a),ur=function(){function n(){}return n.ANCHOR_SYSTEM="xr-anchor-system",n.BACKGROUND_REMOVER="xr-background-remover",n.HIT_TEST="xr-hit-test",n.MESH_DETECTION="xr-mesh-detection",n.PHYSICS_CONTROLLERS="xr-physics-controller",n.PLANE_DETECTION="xr-plane-detection",n.POINTER_SELECTION="xr-controller-pointer-selection",n.TELEPORTATION="xr-controller-teleportation",n.FEATURE_POINTS="xr-feature-points",n.HAND_TRACKING="xr-hand-tracking",n.IMAGE_TRACKING="xr-image-tracking",n}(),or=function(){function n(t){var e=this;this._xrSessionManager=t,this._features={},this._xrSessionManager.onXRSessionInit.add(function(){e.getEnabledFeatures().forEach(function(i){var r=e._features[i];r.enabled&&!r.featureImplementation.attached&&!r.featureImplementation.disableAutoAttach&&e.attachFeature(i)})}),this._xrSessionManager.onXRSessionEnded.add(function(){e.getEnabledFeatures().forEach(function(i){var r=e._features[i];r.enabled&&r.featureImplementation.attached&&e.detachFeature(i)})})}return n.AddWebXRFeature=function(t,e,i,r){i===void 0&&(i=1),r===void 0&&(r=!1),this._AvailableFeatures[t]=this._AvailableFeatures[t]||{latest:i},i>this._AvailableFeatures[t].latest&&(this._AvailableFeatures[t].latest=i),r&&(this._AvailableFeatures[t].stable=i),this._AvailableFeatures[t][i]=e},n.ConstructFeature=function(t,e,i,r){e===void 0&&(e=1);var o=this._AvailableFeatures[t][e];if(!o)throw new Error("feature not found");return o(i,r)},n.GetAvailableFeatures=function(){return Object.keys(this._AvailableFeatures)},n.GetAvailableVersions=function(t){return Object.keys(this._AvailableFeatures[t])},n.GetLatestVersionOfFeature=function(t){return this._AvailableFeatures[t]&&this._AvailableFeatures[t].latest||-1},n.GetStableVersionOfFeature=function(t){return this._AvailableFeatures[t]&&this._AvailableFeatures[t].stable||-1},n.prototype.attachFeature=function(t){var e=this._features[t];e&&e.enabled&&!e.featureImplementation.attached&&e.featureImplementation.attach()},n.prototype.detachFeature=function(t){var e=this._features[t];e&&e.featureImplementation.attached&&e.featureImplementation.detach()},n.prototype.disableFeature=function(t){var e=typeof t=="string"?t:t.Name,i=this._features[e];return i&&i.enabled?(i.enabled=!1,this.detachFeature(e),i.featureImplementation.dispose(),!0):!1},n.prototype.dispose=function(){var t=this;this.getEnabledFeatures().forEach(function(e){t.disableFeature(e),t._features[e].featureImplementation.dispose()})},n.prototype.enableFeature=function(t,e,i,r,o){var a=this;e===void 0&&(e="latest"),i===void 0&&(i={}),r===void 0&&(r=!0),o===void 0&&(o=!0);var s=typeof t=="string"?t:t.Name,c=0;if(typeof e=="string"){if(!e)throw new Error("Error in provided version - "+s+" ("+e+")");if(e==="stable"?c=n.GetStableVersionOfFeature(s):e==="latest"?c=n.GetLatestVersionOfFeature(s):c=+e,c===-1||isNaN(c))throw new Error("feature not found - "+s+" ("+e+")")}else c=e;var _=this._features[s],b=n.ConstructFeature(s,c,this._xrSessionManager,i);if(!b)throw new Error("feature not found - "+s);_&&this.disableFeature(s);var C=b();if(C.dependsOn){var x=C.dependsOn.every(function(V){return!!a._features[V]});if(!x)throw new Error("Dependant features missing. Make sure the following features are enabled - "+C.dependsOn.join(", "))}if(C.isCompatible())return this._features[s]={featureImplementation:C,enabled:!0,version:c,required:o},r?this._xrSessionManager.session&&!this._features[s].featureImplementation.attached&&this.attachFeature(s):this._features[s].featureImplementation.disableAutoAttach=!0,this._features[s].featureImplementation;if(o)throw new Error("required feature not compatible");return re.b.Warn("Feature "+s+" not compatible with the current environment/browser and was not enabled."),C},n.prototype.getEnabledFeature=function(t){return this._features[t]&&this._features[t].featureImplementation},n.prototype.getEnabledFeatures=function(){return Object.keys(this._features)},n.prototype._extendXRSessionInitObject=function(t){return Object(p.b)(this,void 0,void 0,function(){var e,i,r,o,a,s,c;return Object(p.e)(this,function(_){switch(_.label){case 0:e=this.getEnabledFeatures(),i=0,r=e,_.label=1;case 1:return i<r.length?(o=r[i],a=this._features[o],s=a.featureImplementation.xrNativeFeatureName,s&&(a.required?(t.requiredFeatures=t.requiredFeatures||[],t.requiredFeatures.indexOf(s)===-1&&t.requiredFeatures.push(s)):(t.optionalFeatures=t.optionalFeatures||[],t.optionalFeatures.indexOf(s)===-1&&t.optionalFeatures.push(s))),a.featureImplementation.getXRSessionInitExtension?[4,a.featureImplementation.getXRSessionInitExtension()]:[3,3]):[3,4];case 2:c=_.sent(),t=Object(p.a)(Object(p.a)({},t),c),_.label=3;case 3:return i++,[3,1];case 4:return[2,t]}})})},n._AvailableFeatures={},n}(),ku=function(){function n(t){var e=this;this.scene=t,this._nonVRCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this.onInitialXRPoseSetObservable=new g.c,this.onStateChangedObservable=new g.c,this.state=pi.NOT_IN_XR,this.sessionManager=new bn(t),this.camera=new Hu("",t,this.sessionManager),this.featuresManager=new or(this.sessionManager),t.onDisposeObservable.add(function(){e.exitXRAsync()})}return n.CreateAsync=function(t){var e=new n(t);return e.sessionManager.initializeAsync().then(function(){return e._supported=!0,e}).catch(function(i){throw e._setState(pi.NOT_IN_XR),e.dispose(),i})},n.prototype.dispose=function(){this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._nonVRCamera&&(this.scene.activeCamera=this._nonVRCamera)},n.prototype.enterXRAsync=function(t,e,i,r){return i===void 0&&(i=this.sessionManager.getWebXRRenderTarget()),r===void 0&&(r={}),Object(p.b)(this,void 0,void 0,function(){var o,a=this;return Object(p.e)(this,function(s){switch(s.label){case 0:if(!this._supported)throw"WebXR not supported in this browser or environment";return this._setState(pi.ENTERING_XR),e!=="viewer"&&e!=="local"&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(e)),[4,this.featuresManager._extendXRSessionInitObject(r)];case 1:r=s.sent(),t==="immersive-ar"&&e!=="unbounded"&&d.a.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode"),s.label=2;case 2:return s.trys.push([2,7,,8]),[4,this.sessionManager.initializeSessionAsync(t,r)];case 3:return s.sent(),[4,this.sessionManager.setReferenceSpaceTypeAsync(e)];case 4:return s.sent(),[4,i.initializeXRLayerAsync(this.sessionManager.session)];case 5:return s.sent(),[4,this.sessionManager.updateRenderStateAsync({depthFar:this.camera.maxZ,depthNear:this.camera.minZ,baseLayer:i.xrLayer})];case 6:return s.sent(),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this.scene.autoClear,this._nonVRCamera=this.scene.activeCamera,this.scene.activeCamera=this.camera,t!=="immersive-ar"?this._nonXRToXRCamera():(this.scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1),this.sessionManager.onXRSessionEnded.addOnce(function(){a.camera.rigCameras.forEach(function(c){c.outputRenderTarget=null}),a.scene.autoClear=a._originalSceneAutoClear,a.scene.activeCamera=a._nonVRCamera,t!=="immersive-ar"&&a.camera.compensateOnFirstFrame&&(a._nonVRCamera.setPosition?a._nonVRCamera.setPosition(a.camera.position):a._nonVRCamera.position.copyFrom(a.camera.position)),a._setState(pi.NOT_IN_XR)}),this.sessionManager.onXRFrameObservable.addOnce(function(){a._setState(pi.IN_XR)}),[2,this.sessionManager];case 7:throw o=s.sent(),console.log(o),console.log(o.message),this._setState(pi.NOT_IN_XR),o;case 8:return[2]}})})},n.prototype.exitXRAsync=function(){return this.state!==pi.IN_XR?Promise.resolve():(this._setState(pi.EXITING_XR),this.sessionManager.exitXRAsync())},n.prototype._nonXRToXRCamera=function(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)},n.prototype._setState=function(t){this.state!==t&&(this.state=t,this.onStateChangedObservable.notifyObservers(this.state))},n}(),An=function(){function n(t,e,i,r){i===void 0&&(i=-1),r===void 0&&(r=[]),this.id=t,this.type=e,this._buttonIndex=i,this._axesIndices=r,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new g.c,this.onButtonStateChangedObservable=new g.c}return Object.defineProperty(n.prototype,"axes",{get:function(){return this._axes},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"changes",{get:function(){return this._changes},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasChanges",{get:function(){return this._hasChanges},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"pressed",{get:function(){return this._pressed},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"touched",{get:function(){return this._touched},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"value",{get:function(){return this._currentValue},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()},n.prototype.isAxes=function(){return this._axesIndices.length!==0},n.prototype.isButton=function(){return this._buttonIndex!==-1},n.prototype.update=function(t){var e=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){var r=t.buttons[this._buttonIndex];if(!r)return;this._currentValue!==r.value&&(this.changes.value={current:r.value,previous:this._currentValue},e=!0,this._currentValue=r.value),this._touched!==r.touched&&(this.changes.touched={current:r.touched,previous:this._touched},e=!0,this._touched=r.touched),this._pressed!==r.pressed&&(this.changes.pressed={current:r.pressed,previous:this._pressed},e=!0,this._pressed=r.pressed)}this.isAxes()&&(this._axes.x!==t.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:t.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=t.axes[this._axesIndices[0]],i=!0),this._axes.y!==t.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=t.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:t.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=t.axes[this._axesIndices[1]],i=!0)),e&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))},n.BUTTON_TYPE="button",n.SQUEEZE_TYPE="squeeze",n.THUMBSTICK_TYPE="thumbstick",n.TOUCHPAD_TYPE="touchpad",n.TRIGGER_TYPE="trigger",n}(),Rn=function(){function n(t,e,i,r,o){var a=this;o===void 0&&(o=!1),this.scene=t,this.layout=e,this.gamepadObject=i,this.handedness=r,this._initComponent=function(s){if(!!s){var c=a.layout.components[s],_=c.type,b=c.gamepadIndices.button,C=[];c.gamepadIndices.xAxis!==void 0&&c.gamepadIndices.yAxis!==void 0&&C.push(c.gamepadIndices.xAxis,c.gamepadIndices.yAxis),a.components[s]=new An(s,_,b,C)}},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new g.c,e.components&&Object.keys(e.components).forEach(this._initComponent)}return n.prototype.dispose=function(){var t=this;this.getComponentIds().forEach(function(e){return t.getComponent(e).dispose()}),this.rootMesh&&this.rootMesh.dispose()},n.prototype.getAllComponentsOfType=function(t){var e=this;return this.getComponentIds().map(function(i){return e.components[i]}).filter(function(i){return i.type===t})},n.prototype.getComponent=function(t){return this.components[t]},n.prototype.getComponentIds=function(){return Object.keys(this.components)},n.prototype.getComponentOfType=function(t){return this.getAllComponentsOfType(t)[0]||null},n.prototype.getMainComponent=function(){return this.getComponent(this.layout.selectComponentId)},n.prototype.loadModel=function(){return Object(p.b)(this,void 0,void 0,function(){var t,e,i=this;return Object(p.e)(this,function(r){return t=!this._getModelLoadingConstraints(),e=this._getGenericFilenameAndPath(),t?d.a.Warn("Falling back to generic models"):e=this._getFilenameAndPath(),[2,new Promise(function(o,a){Mi.a.ImportMesh("",e.path,e.filename,i.scene,function(s){t?i._getGenericParentMesh(s):i._setRootMesh(s),i._processLoadedModel(s),i._modelReady=!0,i.onModelLoadedObservable.notifyObservers(i),o(!0)},null,function(s,c){d.a.Log(c),d.a.Warn("Failed to retrieve controller model of type "+i.profileId+" from the remote server: "+e.path+e.filename),a(c)})})]})})},n.prototype.updateFromXRFrame=function(t){var e=this;this.getComponentIds().forEach(function(i){return e.getComponent(i).update(e.gamepadObject)}),this.updateModel(t)},Object.defineProperty(n.prototype,"handness",{get:function(){return this.handedness},enumerable:!1,configurable:!0}),n.prototype.pulse=function(t,e,i){return i===void 0&&(i=0),this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(t,e):Promise.resolve(!1)},n.prototype._getChildByName=function(t,e){return t.getChildren(function(i){return i.name===e},!1)[0]},n.prototype._getImmediateChildByName=function(t,e){return t.getChildren(function(i){return i.name==e},!0)[0]},n.prototype._lerpTransform=function(t,e,i){if(!(!t.minMesh||!t.maxMesh||!t.valueMesh)&&!(!t.minMesh.rotationQuaternion||!t.maxMesh.rotationQuaternion||!t.valueMesh.rotationQuaternion)){var r=i?e*.5+.5:e;l.b.SlerpToRef(t.minMesh.rotationQuaternion,t.maxMesh.rotationQuaternion,r,t.valueMesh.rotationQuaternion),l.e.LerpToRef(t.minMesh.position,t.maxMesh.position,r,t.valueMesh.position)}},n.prototype.updateModel=function(t){!this._modelReady||this._updateModel(t)},n.prototype._getGenericFilenameAndPath=function(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}},n.prototype._getGenericParentMesh=function(t){var e=this;this.rootMesh=new st.a(this.profileId+" "+this.handedness,this.scene),t.forEach(function(i){i.parent||(i.isPickable=!1,i.setParent(e.rootMesh))}),this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0)},n}(),Cs=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,Pm[r],i,r)||this;return o.profileId=t.ProfileId,o}return t.prototype._getFilenameAndPath=function(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}},t.prototype._getModelLoadingConstraints=function(){return!0},t.prototype._processLoadedModel=function(e){},t.prototype._setRootMesh=function(e){var i=this;this.rootMesh=new st.a(this.profileId+" "+this.handedness,this.scene),e.forEach(function(r){r.isPickable=!1,r.parent||r.setParent(i.rootMesh)}),this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0)},t.prototype._updateModel=function(){},t.ProfileId="generic-trigger",t}(Rn),Pm={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}},Xu=function(n){Object(p.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,r.layouts[i.handedness||"none"],i.gamepad,i.handedness)||this;return a._repositoryUrl=o,a._buttonMeshMapping={},a._touchDots={},a.profileId=r.profileId,a}return t.prototype.dispose=function(){var e=this;n.prototype.dispose.call(this),Object.keys(this._touchDots).forEach(function(i){e._touchDots[i].dispose()})},t.prototype._getFilenameAndPath=function(){return{filename:this.layout.assetPath,path:this._repositoryUrl+"/profiles/"+this.profileId+"/"}},t.prototype._getModelLoadingConstraints=function(){var e=Mi.a.IsPluginForExtensionAvailable(".glb");return e||d.a.Warn("glTF / glb loader was not registered, using generic controller instead"),e},t.prototype._processLoadedModel=function(e){var i=this;this.getComponentIds().forEach(function(r){var o=i.layout.components[r];i._buttonMeshMapping[r]={mainMesh:i._getChildByName(i.rootMesh,o.rootNodeName),states:{}},Object.keys(o.visualResponses).forEach(function(a){var s=o.visualResponses[a];if(s.valueNodeProperty==="transform")i._buttonMeshMapping[r].states[a]={valueMesh:i._getChildByName(i.rootMesh,s.valueNodeName),minMesh:i._getChildByName(i.rootMesh,s.minNodeName),maxMesh:i._getChildByName(i.rootMesh,s.maxNodeName)};else{var c=o.type===An.TOUCHPAD_TYPE&&o.touchPointNodeName?o.touchPointNodeName:s.valueNodeName;if(i._buttonMeshMapping[r].states[a]={valueMesh:i._getChildByName(i.rootMesh,c)},o.type===An.TOUCHPAD_TYPE&&!i._touchDots[a]){var _=nr.a.CreateSphere(a+"dot",{diameter:.0015,segments:8},i.scene);_.material=new zt.a(a+"mat",i.scene),_.material.diffuseColor=v.a.Red(),_.parent=i._buttonMeshMapping[r].states[a].valueMesh||null,_.isVisible=!1,i._touchDots[a]=_}}})})},t.prototype._setRootMesh=function(e){this.rootMesh=new st.a(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(var i,r=0;r<e.length;r++){var o=e[r];o.isPickable=!1,o.parent||(i=o)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(Le.a.Y,Math.PI,Le.c.WORLD)},t.prototype._updateModel=function(e){var i=this;this.disableAnimation||this.getComponentIds().forEach(function(r){var o=i.getComponent(r);if(!!o.hasChanges){var a=i._buttonMeshMapping[r],s=i.layout.components[r];Object.keys(s.visualResponses).forEach(function(c){var _=s.visualResponses[c],b=o.value;if(_.componentProperty==="xAxis"?b=o.axes.x:_.componentProperty==="yAxis"&&(b=o.axes.y),_.valueNodeProperty==="transform")i._lerpTransform(a.states[c],b,_.componentProperty!=="button");else{var C=a.states[c].valueMesh;C&&(C.isVisible=o.touched||o.pressed),i._touchDots[c]&&(i._touchDots[c].isVisible=o.touched||o.pressed)}})}})},t}(Rn),ar=function(){function n(){}return n.ClearProfilesCache=function(){this._ProfilesList=null,this._ProfileLoadingPromises={}},n.DefaultFallbacks=function(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"])},n.FindFallbackWithProfileId=function(t){var e=this._Fallbacks[t]||[];return e.unshift(t),e},n.GetMotionControllerWithXRInput=function(t,e,i){var r=this,o=[];if(i&&o.push(i),o.push.apply(o,t.profiles||[]),o.length&&!o[0]&&o.pop(),t.gamepad&&t.gamepad.id)switch(t.gamepad.id){case(t.gamepad.id.match(/oculus touch/gi)?t.gamepad.id:void 0):o.push("oculus-touch-v2");break}var a=o.indexOf("windows-mixed-reality");if(a!==-1&&o.splice(a,0,"microsoft-mixed-reality"),o.length||o.push("generic-trigger"),this.UseOnlineRepository){var s=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,c=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return s.call(this,o,t,e).catch(function(){return c.call(r,o,t,e)})}else return this._LoadProfilesFromAvailableControllers(o,t,e)},n.RegisterController=function(t,e){this._AvailableControllers[t]=e},n.RegisterFallbacksForProfileId=function(t,e){var i;this._Fallbacks[t]?(i=this._Fallbacks[t]).push.apply(i,e):this._Fallbacks[t]=e},n.UpdateProfilesList=function(){return this._ProfilesList=re.b.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(function(t){return JSON.parse(t.toString())}),this._ProfilesList},n._LoadProfileFromRepository=function(t,e,i){var r=this;return Promise.resolve().then(function(){return r._ProfilesList?r._ProfilesList:r.UpdateProfilesList()}).then(function(o){for(var a=0;a<t.length;++a)if(!!t[a]&&o[t[a]])return t[a];throw new Error("neither controller "+t[0]+" nor all fallbacks were found in the repository,")}).then(function(o){return r._ProfileLoadingPromises[o]||(r._ProfileLoadingPromises[o]=re.b.LoadFileAsync(r.BaseRepositoryUrl+"/profiles/"+o+"/profile.json",!1).then(function(a){return JSON.parse(a)})),r._ProfileLoadingPromises[o]}).then(function(o){return new Xu(i,e,o,r.BaseRepositoryUrl)})},n._LoadProfilesFromAvailableControllers=function(t,e,i){for(var r=0;r<t.length;++r)if(!!t[r])for(var o=this.FindFallbackWithProfileId(t[r]),a=0;a<o.length;++a){var s=this._AvailableControllers[o[a]];if(s)return Promise.resolve(s(e,i))}throw new Error("no controller requested was found in the available controllers list")},n._AvailableControllers={},n._Fallbacks={},n._ProfileLoadingPromises={},n.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",n.PrioritizeOnlineRepository=!0,n.UseOnlineRepository=!0,n}();ar.RegisterController(Cs.ProfileId,function(n,t){return new Cs(t,n.gamepad,n.handedness)}),ar.DefaultFallbacks();var Cm=0,Yu=function(){function n(t,e,i){var r=this;i===void 0&&(i={}),this._scene=t,this.inputSource=e,this._options=i,this._tmpVector=new l.e,this._disposed=!1,this.onDisposeObservable=new g.c,this.onMeshLoadedObservable=new g.c,this.onMotionControllerInitObservable=new g.c,this._uniqueId="controller-"+Cm+++"-"+e.targetRayMode+"-"+e.handedness,this.pointer=new Ae.a(this._uniqueId+"-pointer",t),this.pointer.rotationQuaternion=new l.b,this.inputSource.gripSpace&&(this.grip=new Ae.a(this._uniqueId+"-grip",this._scene),this.grip.rotationQuaternion=new l.b),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&ar.GetMotionControllerWithXRInput(e,t,this._options.forceControllerProfile).then(function(o){r.motionController=o,r.onMotionControllerInitObservable.notifyObservers(o),r._options.doNotLoadControllerMesh||r.motionController.loadModel().then(function(a){var s;a&&r.motionController&&r.motionController.rootMesh&&(r._options.renderingGroupId&&(r.motionController.rootMesh.renderingGroupId=r._options.renderingGroupId,r.motionController.rootMesh.getChildMeshes(!1).forEach(function(c){return c.renderingGroupId=r._options.renderingGroupId})),r.onMeshLoadedObservable.notifyObservers(r.motionController.rootMesh),r.motionController.rootMesh.parent=r.grip||r.pointer,r.motionController.disableAnimation=!!r._options.disableMotionControllerAnimation),r._disposed&&((s=r.motionController)===null||s===void 0||s.dispose())})},function(){re.b.Warn("Could not find a matching motion controller for the registered input source")})}return Object.defineProperty(n.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this.grip&&this.grip.dispose(),this.motionController&&this.motionController.dispose(),this.pointer.dispose(),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0},n.prototype.getWorldPointerRayToRef=function(t,e){e===void 0&&(e=!1);var i=e&&this.grip?this.grip:this.pointer;l.e.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),t.direction),t.direction.normalize(),t.origin.copyFrom(i.absolutePosition),t.length=1e3},n.prototype.updateFromXRFrame=function(t,e){var i=t.getPose(this.inputSource.targetRaySpace,e);if(i){var r=i.transform.position;this.pointer.position.set(r.x,r.y,r.z);var o=i.transform.orientation;this.pointer.rotationQuaternion.set(o.x,o.y,o.z,o.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1)}if(this.inputSource.gripSpace&&this.grip){var a=t.getPose(this.inputSource.gripSpace,e);if(a){var r=a.transform.position,s=a.transform.orientation;this.grip.position.set(r.x,r.y,r.z),this.grip.rotationQuaternion.set(s.x,s.y,s.z,s.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}}this.motionController&&this.motionController.updateFromXRFrame(t)},n}(),Ku=function(){function n(t,e,i){var r=this;if(i===void 0&&(i={}),this.xrSessionManager=t,this.xrCamera=e,this.options=i,this.controllers=[],this.onControllerAddedObservable=new g.c,this.onControllerRemovedObservable=new g.c,this._onInputSourcesChange=function(o){r._addAndRemoveControllers(o.added,o.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(function(){r._addAndRemoveControllers([],r.controllers.map(function(o){return o.inputSource}))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(function(o){o.addEventListener("inputsourceschange",r._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(function(o){r.controllers.forEach(function(a){a.updateFromXRFrame(o,r.xrSessionManager.referenceSpace)})}),this.options.customControllersRepositoryURL&&(ar.BaseRepositoryUrl=this.options.customControllersRepositoryURL),ar.UseOnlineRepository=!this.options.disableOnlineControllerRepository,ar.UseOnlineRepository)try{ar.UpdateProfilesList().catch(function(){ar.UseOnlineRepository=!1})}catch(o){ar.UseOnlineRepository=!1}}return n.prototype._addAndRemoveControllers=function(t,e){for(var i=this,r=this.controllers.map(function(C){return C.inputSource}),o=0,a=t;o<a.length;o++){var s=a[o];if(r.indexOf(s)===-1){var c=new Yu(this.xrSessionManager.scene,s,Object(p.a)(Object(p.a)({},this.options.controllerOptions||{}),{forceControllerProfile:this.options.forceInputProfile,doNotLoadControllerMesh:this.options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this.options.disableControllerAnimation}));this.controllers.push(c),this.onControllerAddedObservable.notifyObservers(c)}}var _=[],b=[];this.controllers.forEach(function(C){e.indexOf(C.inputSource)===-1?_.push(C):b.push(C)}),this.controllers=_,b.forEach(function(C){i.onControllerRemovedObservable.notifyObservers(C),C.dispose()})},n.prototype.dispose=function(){this.controllers.forEach(function(t){t.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear()},n}(),cr=function(){function n(t){this._xrSessionManager=t,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}return Object.defineProperty(n.prototype,"attached",{get:function(){return this._attached},enumerable:!1,configurable:!0}),n.prototype.attach=function(t){var e=this;if(this.isDisposed)return!1;if(t)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,function(i){return e._onXRFrame(i)}),!0},n.prototype.detach=function(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(function(t){t.observable.remove(t.observer)}),!0):(this.disableAutoAttach=!0,!1)},n.prototype.dispose=function(){this.detach(),this.isDisposed=!0},n.prototype.isCompatible=function(){return!0},n.prototype._addNewAttachObserver=function(t,e){this._removeOnDetach.push({observable:t,observer:t.add(e)})},n}(),vo=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r._options=i,r._attachController=function(o){if(!r._controllers[o.uniqueId]){var a=r._generateNewMeshPair(o.pointer),s=a.laserPointer,c=a.selectionMesh;switch(r._controllers[o.uniqueId]={xrController:o,laserPointer:s,selectionMesh:c,meshUnderPointer:null,pick:null,tmpRay:new Jt.a(new l.e,new l.e),id:t._idCounter++},r._attachedController?!r._options.enablePointerSelectionOnAllControllers&&r._options.preferredHandedness&&o.inputSource.handedness===r._options.preferredHandedness&&(r._attachedController=o.uniqueId):r._options.enablePointerSelectionOnAllControllers||(r._attachedController=o.uniqueId),o.inputSource.targetRayMode){case"tracked-pointer":return r._attachTrackedPointerRayMode(o);case"gaze":return r._attachGazeMode(o);case"screen":return r._attachScreenRayMode(o)}}},r._controllers={},r._tmpVectorForPickCompare=new l.e,r.disablePointerLighting=!0,r.disableSelectionMeshLighting=!0,r.displayLaserPointer=!0,r.displaySelectionMesh=!0,r.laserPointerPickedColor=new v.a(.9,.9,.9),r.laserPointerDefaultColor=new v.a(.7,.7,.7),r.selectionMeshDefaultColor=new v.a(.8,.8,.8),r.selectionMeshPickedColor=new v.a(.3,.3,1),r._identityMatrix=l.a.Identity(),r._screenCoordinatesRef=l.e.Zero(),r._viewportRef=new lr.a(0,0,0,0),r._scene=r._xrSessionManager.scene,r}return t.prototype.attach=function(){var e=this;if(!n.prototype.attach.call(this))return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(s){e._detachController(s.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){var i=this._options.gazeCamera,r=this._generateNewMeshPair(i),o=r.laserPointer,a=r.selectionMesh;this._controllers.camera={webXRCamera:i,laserPointer:o,selectionMesh:a,meshUnderPointer:null,pick:null,tmpRay:new Jt.a(new l.e,new l.e),id:t._idCounter++},this._attachGazeMode()}return!0},t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(i){e._detachController(i)}),!0):!1},t.prototype.getMeshUnderPointer=function(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null},t.prototype.getXRControllerByPointerId=function(e){for(var i=Object.keys(this._controllers),r=0;r<i.length;++r)if(this._controllers[i[r]].id===e)return this._controllers[i[r]].xrController||null;return null},t.prototype._onXRFrame=function(e){var i=this;Object.keys(this._controllers).forEach(function(r){var o=i._controllers[r];if(!i._options.enablePointerSelectionOnAllControllers&&r!==i._attachedController){o.selectionMesh.isVisible=!1,o.laserPointer.isVisible=!1,o.pick=null;return}o.laserPointer.isVisible=i.displayLaserPointer;var a;if(o.xrController)a=o.xrController.pointer.position,o.xrController.getWorldPointerRayToRef(o.tmpRay);else if(o.webXRCamera)a=o.webXRCamera.position,o.webXRCamera.getForwardRayToRef(o.tmpRay);else return;if(i._options.maxPointerDistance&&(o.tmpRay.length=i._options.maxPointerDistance),!i._options.disableScenePointerVectorUpdate&&a){var s=i._xrSessionManager.scene,c=i._options.xrInput.xrCamera;c&&(c.viewport.toGlobalToRef(s.getEngine().getRenderWidth(),s.getEngine().getRenderHeight(),i._viewportRef),l.e.ProjectToRef(a,i._identityMatrix,s.getTransformMatrix(),i._viewportRef,i._screenCoordinatesRef),s.pointerX=i._screenCoordinatesRef.x,s.pointerY=i._screenCoordinatesRef.y)}o.pick=i._scene.pickWithRay(o.tmpRay,i._scene.pointerMovePredicate||i.raySelectionPredicate);var _=o.pick;if(_&&_.pickedPoint&&_.hit){i._updatePointerDistance(o.laserPointer,_.distance),o.selectionMesh.position.copyFrom(_.pickedPoint),o.selectionMesh.scaling.x=Math.sqrt(_.distance),o.selectionMesh.scaling.y=Math.sqrt(_.distance),o.selectionMesh.scaling.z=Math.sqrt(_.distance);var b=i._convertNormalToDirectionOfRay(_.getNormal(!0),o.tmpRay),C=.001;if(o.selectionMesh.position.copyFrom(_.pickedPoint),b){var x=l.e.Cross(Le.a.Y,b),V=l.e.Cross(b,x);l.e.RotationFromAxisToRef(V,b,x,o.selectionMesh.rotation),o.selectionMesh.position.addInPlace(b.scale(C))}o.selectionMesh.isVisible=i.displaySelectionMesh,o.meshUnderPointer=_.pickedMesh}else o.selectionMesh.isVisible=!1,i._updatePointerDistance(o.laserPointer,1),o.meshUnderPointer=null})},t.prototype._attachGazeMode=function(e){var i=this,r=this._controllers[e&&e.uniqueId||"camera"],o=this._options.timeToSelect||3e3,a=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xi.a.DefaultUtilityLayer.utilityLayerScene:this._scene,s=new vt.a,c=eo.a.CreateTorus("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},a);c.isVisible=!1,c.isPickable=!1,c.parent=r.selectionMesh;var _=0,b=!1,C={pointerId:r.id,pointerType:"xr"};r.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){if(!!r.pick){if(r.laserPointer.material.alpha=0,c.isVisible=!1,r.pick.hit)if(i._pickingMoved(s,r.pick))b&&(i._options.disablePointerUpOnTouchOut||i._scene.simulatePointerUp(r.pick,C)),b=!1,_=0;else if(_>o/10&&(c.isVisible=!0),_+=i._scene.getEngine().getDeltaTime(),_>=o)i._scene.simulatePointerDown(r.pick,C),b=!0,i._options.disablePointerUpOnTouchOut&&i._scene.simulatePointerUp(r.pick,C),c.isVisible=!1;else{var x=1-_/o;c.scaling.set(x,x,x)}else b=!1,_=0;i._scene.simulatePointerMove(r.pick,C),s=r.pick}}),this._options.renderingGroupId!==void 0&&(c.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(function(){r.pick&&!i._options.disablePointerUpOnTouchOut&&b&&i._scene.simulatePointerUp(r.pick,C),c.dispose()})},t.prototype._attachScreenRayMode=function(e){var i=this,r=this._controllers[e.uniqueId],o=!1,a={pointerId:r.id,pointerType:"xr"};r.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){!r.pick||i._options.disablePointerUpOnTouchOut&&o||(o?i._scene.simulatePointerMove(r.pick,a):(i._scene.simulatePointerDown(r.pick,a),o=!0,i._options.disablePointerUpOnTouchOut&&i._scene.simulatePointerUp(r.pick,a)))}),e.onDisposeObservable.addOnce(function(){r.pick&&o&&!i._options.disablePointerUpOnTouchOut&&i._scene.simulatePointerUp(r.pick,a)})},t.prototype._attachTrackedPointerRayMode=function(e){var i=this,r=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);var o={pointerId:r.id,pointerType:"xr"};if(r.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){r.laserPointer.material.disableLighting=i.disablePointerLighting,r.selectionMesh.material.disableLighting=i.disableSelectionMeshLighting,r.pick&&i._scene.simulatePointerMove(r.pick,o)}),e.inputSource.gamepad){var a=function(_){i._options.overrideButtonId&&(r.selectionComponent=_.getComponent(i._options.overrideButtonId)),r.selectionComponent||(r.selectionComponent=_.getMainComponent()),r.onButtonChangedObserver=r.selectionComponent.onButtonStateChangedObservable.add(function(b){if(b.changes.pressed){var C=b.changes.pressed.current;r.pick?(i._options.enablePointerSelectionOnAllControllers||e.uniqueId===i._attachedController)&&(C?(i._scene.simulatePointerDown(r.pick,o),r.selectionMesh.material.emissiveColor=i.selectionMeshPickedColor,r.laserPointer.material.emissiveColor=i.laserPointerPickedColor):(i._scene.simulatePointerUp(r.pick,o),r.selectionMesh.material.emissiveColor=i.selectionMeshDefaultColor,r.laserPointer.material.emissiveColor=i.laserPointerDefaultColor)):C&&!i._options.enablePointerSelectionOnAllControllers&&!i._options.disableSwitchOnClick&&(i._attachedController=e.uniqueId)}})};e.motionController?a(e.motionController):e.onMotionControllerInitObservable.add(a)}else{var s=function(_){r.xrController&&_.inputSource===r.xrController.inputSource&&r.pick&&(i._scene.simulatePointerDown(r.pick,o),r.selectionMesh.material.emissiveColor=i.selectionMeshPickedColor,r.laserPointer.material.emissiveColor=i.laserPointerPickedColor)},c=function(_){r.xrController&&_.inputSource===r.xrController.inputSource&&r.pick&&(i._scene.simulatePointerUp(r.pick,o),r.selectionMesh.material.emissiveColor=i.selectionMeshDefaultColor,r.laserPointer.material.emissiveColor=i.laserPointerDefaultColor)};r.eventListeners={selectend:c,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",c)}},t.prototype._convertNormalToDirectionOfRay=function(e,i){if(e){var r=Math.acos(l.e.Dot(e,i.direction));r<Math.PI/2&&e.scaleInPlace(-1)}return e},t.prototype._detachController=function(e){var i=this,r=this._controllers[e];if(!!r&&(r.selectionComponent&&r.onButtonChangedObserver&&r.selectionComponent.onButtonStateChangedObservable.remove(r.onButtonChangedObserver),r.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(r.onFrameObserver),r.eventListeners&&Object.keys(r.eventListeners).forEach(function(a){var s=r.eventListeners&&r.eventListeners[a];s&&i._xrSessionManager.session.removeEventListener(a,s)}),r.selectionMesh.dispose(),r.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e)){var o=Object.keys(this._controllers);o.length?this._attachedController=o[0]:this._attachedController=""}},t.prototype._generateNewMeshPair=function(e){var i=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xi.a.DefaultUtilityLayer.utilityLayerScene:this._scene,r=Tr.a.CreateCylinder("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},i);r.parent=e;var o=new zt.a("laserPointerMat",i);o.emissiveColor=this.laserPointerDefaultColor,o.alpha=.7,r.material=o,r.rotation.x=Math.PI/2,this._updatePointerDistance(r,1),r.isPickable=!1;var a=eo.a.CreateTorus("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},i);a.bakeCurrentTransformIntoVertices(),a.isPickable=!1,a.isVisible=!1;var s=new zt.a("targetMat",i);return s.specularColor=v.a.Black(),s.emissiveColor=this.selectionMeshDefaultColor,s.backFaceCulling=!1,a.material=s,this._options.renderingGroupId!==void 0&&(r.renderingGroupId=this._options.renderingGroupId,a.renderingGroupId=this._options.renderingGroupId),{laserPointer:r,selectionMesh:a}},t.prototype._pickingMoved=function(e,i){var r;if(!e.hit||!i.hit||!e.pickedMesh||!e.pickedPoint||!i.pickedMesh||!i.pickedPoint||e.pickedMesh!==i.pickedMesh)return!0;(r=e.pickedPoint)===null||r===void 0||r.subtractToRef(i.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));var o=(this._options.gazeModePointerMovedFactor||1)*.01*i.distance,a=this._tmpVectorForPickCompare.length();return a>o},t.prototype._updatePointerDistance=function(e,i){i===void 0&&(i=100),e.scaling.y=i,this._scene.useRightHandedSystem&&(i*=-1),e.position.z=i/2+.05},Object.defineProperty(t.prototype,"lasterPointerDefaultColor",{get:function(){return this.laserPointerDefaultColor},enumerable:!1,configurable:!0}),t._idCounter=200,t.Name=ur.POINTER_SELECTION,t.Version=1,t}(cr);or.AddWebXRFeature(vo.Name,function(n,t){return function(){return new vo(n,t)}},vo.Version,!0);var Qu=function(){function n(t,e,i){this.element=t,this.sessionMode=e,this.referenceSpaceType=i}return n.prototype.update=function(t){},n}(),Sm=function(){function n(){}return n}(),Zu=function(){function n(t,e){var i=this;if(this.scene=t,this.options=e,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new g.c,this._onSessionGranted=function(C){i._helper&&i._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;",e.ignoreSessionGrantedEvent||navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window!="undefined"&&window.location&&window.location.protocol==="http:"){re.b.Warn("WebXR can only be served over HTTPS");return}if(e.customButtons)this._buttons=e.customButtons;else{var r=e.sessionMode||"immersive-vr",o=e.referenceSpaceType||"local-floor",a=typeof SVGSVGElement=="undefined"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A",s=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+a+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';var c=document.createElement("style");c.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(c);var _=document.createElement("button");_.className="babylonVRicon",_.title=r+" - "+o,this._buttons.push(new Qu(_,r,o)),this._buttons[this._buttons.length-1].update=function(C){this.element.style.display=C===null||C===this?"":"none",_.className="babylonVRicon"+(C===this?" vrdisplaypresenting":"")},this._updateButtons(null)}var b=t.getEngine().getInputElement();b&&b.parentNode&&(b.parentNode.appendChild(this.overlay),t.onDisposeObservable.addOnce(function(){i.dispose()}))}return n.prototype.setHelperAsync=function(t,e){return Object(p.b)(this,void 0,void 0,function(){var i,r,o=this;return Object(p.e)(this,function(a){switch(a.label){case 0:return this._helper=t,this._renderTarget=e,i=this._buttons.map(function(s){return t.sessionManager.isSessionSupportedAsync(s.sessionMode)}),t.onStateChangedObservable.add(function(s){s==pi.NOT_IN_XR&&o._updateButtons(null)}),[4,Promise.all(i)];case 1:return r=a.sent(),r.forEach(function(s,c){s?(o.overlay.appendChild(o._buttons[c].element),o._buttons[c].element.onclick=o._enterXRWithButtonIndex.bind(o,c)):re.b.Warn('Session mode "'+o._buttons[c].sessionMode+'" not supported in browser')}),[2]}})})},n.CreateAsync=function(t,e,i){return Object(p.b)(this,void 0,void 0,function(){var r;return Object(p.e)(this,function(o){switch(o.label){case 0:return r=new n(t,i),[4,r.setHelperAsync(e,i.renderTarget||void 0)];case 1:return o.sent(),[2,r]}})})},n.prototype._enterXRWithButtonIndex=function(t){return t===void 0&&(t=0),Object(p.b)(this,void 0,void 0,function(){var e,i,r;return Object(p.e)(this,function(o){switch(o.label){case 0:return this._helper.state!=pi.IN_XR?[3,2]:[4,this._helper.exitXRAsync()];case 1:return o.sent(),this._updateButtons(null),[3,6];case 2:if(this._helper.state!=pi.NOT_IN_XR)return[3,6];o.label=3;case 3:return o.trys.push([3,5,,6]),[4,this._helper.enterXRAsync(this._buttons[t].sessionMode,this._buttons[t].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures})];case 4:return o.sent(),this._updateButtons(this._buttons[t]),[3,6];case 5:return e=o.sent(),this._updateButtons(null),i=this._buttons[t].element,r=i.title,i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(e),[3,6];case 6:return[2]}})})},n.prototype.dispose=function(){var t=this.scene.getEngine().getInputElement();t&&t.parentNode&&t.parentNode.contains(this.overlay)&&t.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)},n.prototype._updateButtons=function(t){var e=this;this._activeButton=t,this._buttons.forEach(function(i){i.update(e._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)},n}(),Tm=u(756),nn;(function(n){n[n.INIT=0]="INIT",n[n.STARTED=1]="STARTED",n[n.ENDED=2]="ENDED"})(nn||(nn={}));function Ss(n){var t,e=0,i=Date.now();n.observableParameters=(t=n.observableParameters)!==null&&t!==void 0?t:{};var r=n.contextObservable.add(function(o){var a=Date.now();e=a-i;var s={startTime:i,currentTime:a,deltaTime:e,completeRate:e/n.timeout,payload:o};n.onTick&&n.onTick(s),n.breakCondition&&n.breakCondition()&&(n.contextObservable.remove(r),n.onAborted&&n.onAborted(s)),e>=n.timeout&&(n.contextObservable.remove(r),n.onEnded&&n.onEnded(s))},n.observableParameters.mask,n.observableParameters.insertFirst,n.observableParameters.scope);return r}var Am=function(){function n(t){var e=this,i,r;this.onEachCountObservable=new g.c,this.onTimerAbortedObservable=new g.c,this.onTimerEndedObservable=new g.c,this.onStateChangedObservable=new g.c,this._observer=null,this._breakOnNextTick=!1,this._tick=function(o){var a=Date.now();e._timer=a-e._startTime;var s={startTime:e._startTime,currentTime:a,deltaTime:e._timer,completeRate:e._timer/e._timeToEnd,payload:o},c=e._breakOnNextTick||e._breakCondition(s);c||e._timer>=e._timeToEnd?e._stop(s,c):e.onEachCountObservable.notifyObservers(s)},this._setState(nn.INIT),this._contextObservable=t.contextObservable,this._observableParameters=(i=t.observableParameters)!==null&&i!==void 0?i:{},this._breakCondition=(r=t.breakCondition)!==null&&r!==void 0?r:function(){return!1},t.onEnded&&this.onTimerEndedObservable.add(t.onEnded),t.onTick&&this.onEachCountObservable.add(t.onTick),t.onAborted&&this.onTimerAbortedObservable.add(t.onAborted)}return Object.defineProperty(n.prototype,"breakCondition",{set:function(t){this._breakCondition=t},enumerable:!1,configurable:!0}),n.prototype.clearObservables=function(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()},n.prototype.start=function(t){if(t===void 0&&(t=this._timeToEnd),this._state===nn.STARTED)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=t,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(nn.STARTED)},n.prototype.stop=function(){this._state===nn.STARTED&&(this._breakOnNextTick=!0)},n.prototype.dispose=function(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()},n.prototype._setState=function(t){this._state=t,this.onStateChangedObservable.notifyObservers(this._state)},n.prototype._stop=function(t,e){e===void 0&&(e=!1),this._contextObservable.remove(this._observer),this._setState(nn.ENDED),e?this.onTimerAbortedObservable.notifyObservers(t):this.onTimerEndedObservable.notifyObservers(t)},n}(),_o=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r._options=i,r._controllers={},r._snappedToPoint=!1,r._tmpRay=new Jt.a(new l.e,new l.e),r._tmpVector=new l.e,r._tmpQuaternion=new l.b,r.backwardsMovementEnabled=!0,r.backwardsTeleportationDistance=.7,r.parabolicCheckRadius=5,r.parabolicRayEnabled=!0,r.straightRayEnabled=!0,r.rotationAngle=Math.PI/8,r._rotationEnabled=!0,r._attachController=function(o){if(!(r._controllers[o.uniqueId]||r._options.forceHandedness&&o.inputSource.handedness!==r._options.forceHandedness)){r._controllers[o.uniqueId]={xrController:o,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0}};var a=r._controllers[o.uniqueId];if(a.xrController.inputSource.targetRayMode==="tracked-pointer"&&a.xrController.inputSource.gamepad){var s=function(){if(o.motionController){var c=o.motionController.getComponentOfType(An.THUMBSTICK_TYPE)||o.motionController.getComponentOfType(An.TOUCHPAD_TYPE);if(!c||r._options.useMainComponentOnly){var _=o.motionController.getMainComponent();if(!_)return;a.teleportationComponent=_,a.onButtonChangedObserver=_.onButtonStateChangedObservable.add(function(){if(_.changes.pressed)if(_.changes.pressed.current){a.teleportationState.forward=!0,r._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=r._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,a.teleportationState.currentRotation=0;var b=r._options.timeToTeleport||3e3;Ss({timeout:b,contextObservable:r._xrSessionManager.onXRFrameObservable,breakCondition:function(){return!_.pressed},onEnded:function(){r._currentTeleportationControllerId===a.xrController.uniqueId&&a.teleportationState.forward&&r._teleportForward(o.uniqueId)}})}else a.teleportationState.forward=!1,r._currentTeleportationControllerId=""})}else a.teleportationComponent=c,a.onAxisChangedObserver=c.onAxisValueChangedObservable.add(function(b){if(b.y<=.7&&a.teleportationState.backwards&&(a.teleportationState.backwards=!1),b.y>.7&&!a.teleportationState.forward&&r.backwardsMovementEnabled&&!r.snapPointsOnly&&!a.teleportationState.backwards){a.teleportationState.backwards=!0,r._tmpQuaternion.copyFrom(r._options.xrInput.xrCamera.rotationQuaternion),r._tmpQuaternion.toEulerAnglesToRef(r._tmpVector),r._tmpVector.x=0,r._tmpVector.z=0,l.b.FromEulerVectorToRef(r._tmpVector,r._tmpQuaternion),r._tmpVector.set(0,0,r.backwardsTeleportationDistance*(r._xrSessionManager.scene.useRightHandedSystem?1:-1)),r._tmpVector.rotateByQuaternionToRef(r._tmpQuaternion,r._tmpVector),r._tmpVector.addInPlace(r._options.xrInput.xrCamera.position),r._tmpRay.origin.copyFrom(r._tmpVector),r._tmpRay.length=r._options.xrInput.xrCamera.realWorldHeight+.1,r._tmpRay.direction.set(0,-1,0);var C=r._xrSessionManager.scene.pickWithRay(r._tmpRay,function(V){return r._floorMeshes.indexOf(V)!==-1});C&&C.pickedPoint&&(r._options.xrInput.xrCamera.position.x=C.pickedPoint.x,r._options.xrInput.xrCamera.position.z=C.pickedPoint.z)}if(b.y<-.7&&!r._currentTeleportationControllerId&&!a.teleportationState.rotating&&(a.teleportationState.forward=!0,r._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=r._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),b.x){if(a.teleportationState.forward)r._currentTeleportationControllerId===a.xrController.uniqueId&&(r.rotationEnabled?setTimeout(function(){a.teleportationState.currentRotation=Math.atan2(b.x,b.y*(r._xrSessionManager.scene.useRightHandedSystem?1:-1))}):a.teleportationState.currentRotation=0);else if(!a.teleportationState.rotating&&Math.abs(b.x)>.7){a.teleportationState.rotating=!0;var x=r.rotationAngle*(b.x>0?1:-1)*(r._xrSessionManager.scene.useRightHandedSystem?-1:1);r._options.xrInput.xrCamera.rotationQuaternion.multiplyInPlace(l.b.FromEulerAngles(0,x,0))}}else a.teleportationState.rotating=!1;b.x===0&&b.y===0&&a.teleportationState.forward&&r._teleportForward(o.uniqueId)})}};o.motionController?s():o.onMotionControllerInitObservable.addOnce(function(){s()})}else r._xrSessionManager.scene.onPointerObservable.add(function(c){if(c.type===se.a.POINTERDOWN){a.teleportationState.forward=!0,r._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=r._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,a.teleportationState.currentRotation=0;var _=r._options.timeToTeleport||3e3;Ss({timeout:_,contextObservable:r._xrSessionManager.onXRFrameObservable,onEnded:function(){r._currentTeleportationControllerId===a.xrController.uniqueId&&a.teleportationState.forward&&r._teleportForward(o.uniqueId)}})}else c.type===se.a.POINTERUP&&(a.teleportationState.forward=!1,r._currentTeleportationControllerId="")})}},r._options.teleportationTargetMesh||r._createDefaultTargetMesh(),r._floorMeshes=r._options.floorMeshes||[],r._snapToPositions=r._options.snapPositions||[],r._setTargetMeshVisibility(!1),r}return Object.defineProperty(t.prototype,"rotationEnabled",{get:function(){return this._rotationEnabled},set:function(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){var i=this._options.teleportationTargetMesh.getChildMeshes(!1,function(r){return r.name==="rotationCone"});i[0]&&i[0].setEnabled(e)}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"teleportationTargetMesh",{get:function(){return this._options.teleportationTargetMesh||null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"snapPointsOnly",{get:function(){return!!this._options.snapPointsOnly},set:function(e){this._options.snapPointsOnly=e},enumerable:!1,configurable:!0}),t.prototype.addFloorMesh=function(e){this._floorMeshes.push(e)},t.prototype.addSnapPoint=function(e){this._snapToPositions.push(e)},t.prototype.attach=function(){var e=this;return n.prototype.attach.call(this)?(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(i){e._detachController(i.uniqueId)}),!0):!1},t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(i){e._detachController(i)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)},t.prototype.removeFloorMesh=function(e){var i=this._floorMeshes.indexOf(e);i!==-1&&this._floorMeshes.splice(i,1)},t.prototype.removeFloorMeshByName=function(e){var i=this._xrSessionManager.scene.getMeshByName(e);i&&this.removeFloorMesh(i)},t.prototype.removeSnapPoint=function(e){var i=this._snapToPositions.indexOf(e);if(i===-1){for(var r=0;r<this._snapToPositions.length;++r)if(this._snapToPositions[r].equals(e)){i=r;break}}return i!==-1?(this._snapToPositions.splice(i,1),!0):!1},t.prototype.setSelectionFeature=function(e){this._selectionFeature=e},t.prototype._onXRFrame=function(e){var i=this,r=this._xrSessionManager.currentFrame,o=this._xrSessionManager.scene;if(!(!this.attach||!r)){var a=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!a)return;a.rotationQuaternion=a.rotationQuaternion||new l.b;var s=this._controllers[this._currentTeleportationControllerId];if(s&&s.teleportationState.forward){l.b.RotationYawPitchRollToRef(s.teleportationState.currentRotation+s.teleportationState.baseRotation,0,0,a.rotationQuaternion);var c=!1;if(s.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){var _=o.pickWithRay(this._tmpRay,function(V){if(i._options.pickBlockerMeshes&&i._options.pickBlockerMeshes.indexOf(V)!==-1)return!0;var D=i._floorMeshes.indexOf(V);return D===-1?!1:i._floorMeshes[D].absolutePosition.y<i._options.xrInput.xrCamera.position.y});if(_&&_.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(_.pickedMesh)!==-1)return;_&&_.pickedPoint&&(c=!0,this._setTargetMeshPosition(_.pickedPoint),this._setTargetMeshVisibility(!0),this._showParabolicPath(_))}if(this.parabolicRayEnabled&&!c){var b=s.xrController.pointer.rotationQuaternion.toEulerAngles().x,C=1+(Math.PI/2-Math.abs(b)),x=this.parabolicCheckRadius*C;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(x*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(x)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();var _=o.pickWithRay(this._tmpRay,function(D){return i._options.pickBlockerMeshes&&i._options.pickBlockerMeshes.indexOf(D)!==-1?!0:i._floorMeshes.indexOf(D)!==-1});if(_&&_.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(_.pickedMesh)!==-1)return;_&&_.pickedPoint&&(c=!0,this._setTargetMeshPosition(_.pickedPoint),this._setTargetMeshVisibility(!0),this._showParabolicPath(_))}this._setTargetMeshVisibility(c)}else this._setTargetMeshVisibility(!1)}else this._setTargetMeshVisibility(!1)}},t.prototype._createDefaultTargetMesh=function(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};var e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Xi.a.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=Ya.a.CreateGround("teleportationTarget",{width:2,height:2,subdivisions:2},e);i.isPickable=!1;var r=512,o=new un.a("teleportationPlaneDynamicTexture",r,e,!0);o.hasAlpha=!0;var a=o.getContext(),s=r/2,c=r/2,_=200;a.beginPath(),a.arc(s,c,_,0,2*Math.PI,!1),a.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",a.fill(),a.lineWidth=10,a.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",a.stroke(),a.closePath(),o.update();var b=new zt.a("teleportationPlaneMaterial",e);b.diffuseTexture=o,i.material=b;var C=eo.a.CreateTorus("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(C.isPickable=!1,C.parent=i,!this._options.defaultTargetMeshOptions.disableAnimation){var x=new y.a("animationInnerCircle","position.y",30,y.a.ANIMATIONTYPE_FLOAT,y.a.ANIMATIONLOOPMODE_CYCLE),V=[];V.push({frame:0,value:0}),V.push({frame:30,value:.4}),V.push({frame:60,value:0}),x.setKeys(V);var D=new L.m;D.setEasingMode(L.f.EASINGMODE_EASEINOUT),x.setEasingFunction(D),C.animations=[],C.animations.push(x),e.beginAnimation(C,0,60,!0)}var z=Tr.a.CreateCylinder("rotationCone",{diameterTop:0,tessellation:4},e);if(z.isPickable=!1,z.scaling.set(.5,.12,.2),z.rotate(Le.a.X,Math.PI/2),z.position.z=.6,z.parent=C,this._options.defaultTargetMeshOptions.torusArrowMaterial)C.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,z.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{var q=new zt.a("torusConsMat",e);q.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,q.disableLighting?q.emissiveColor=new v.a(.3,.3,1):q.diffuseColor=new v.a(.3,.3,1),q.alpha=.9,C.material=q,z.material=q,this._teleportationRingMaterial=q}this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,C.renderingGroupId=this._options.renderingGroupId,z.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=i},t.prototype._detachController=function(e){var i=this._controllers[e];!i||(i.teleportationComponent&&(i.onAxisChangedObserver&&i.teleportationComponent.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.teleportationComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver)),delete this._controllers[e])},t.prototype._findClosestSnapPointWithRadius=function(e,i){i===void 0&&(i=this._options.snapToPositionRadius||.8);var r=null,o=Number.MAX_VALUE;if(this._snapToPositions.length){var a=i*i;this._snapToPositions.forEach(function(s){var c=l.e.DistanceSquared(s,e);c<=a&&c<o&&(o=c,r=s)})}return r},t.prototype._setTargetMeshPosition=function(e){if(!!this._options.teleportationTargetMesh){var i=this._findClosestSnapPointWithRadius(e);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||e),this._options.teleportationTargetMesh.position.y+=.01}},t.prototype._setTargetMeshVisibility=function(e){!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible!==e&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(function(i){i.isVisible=e}),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))},t.prototype._showParabolicPath=function(e){if(!!e.pickedPoint){var i=this._controllers[this._currentTeleportationControllerId],r=Tm.d.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25);this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints()):this._quadraticBezierCurve=Bi.a.CreateLines("teleportation path line",{points:r.getPoints(),instance:this._quadraticBezierCurve,updatable:!0}),this._quadraticBezierCurve.isPickable=!1}},t.prototype._teleportForward=function(e){var i=this._controllers[e];if(!(!i||!i.teleportationState.forward)&&(i.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint)&&this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible)){var r=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=r,this._options.xrInput.xrCamera.rotationQuaternion.multiplyInPlace(l.b.FromEulerAngles(0,i.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0)),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}},t.Name=ur.TELEPORTATION,t.Version=1,t}(cr);or.AddWebXRFeature(_o.Name,function(n,t){return function(){return new _o(n,t)}},_o.Version,!0);var Rm=function(){function n(){}return n}(),Ju=function(){function n(){}return n.CreateAsync=function(t,e){e===void 0&&(e={});var i=new n;if(!e.disableDefaultUI){var r=Object(p.a)({renderTarget:i.renderTarget},e.uiOptions||{});e.optionalFeatures&&(typeof e.optionalFeatures=="boolean"?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=e.optionalFeatures),i.enterExitUI=new Zu(t,r)}return ku.CreateAsync(t).then(function(o){if(i.baseExperience=o,e.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new Ku(o.sessionManager,o.camera,Object(p.a)({controllerOptions:{renderingGroupId:e.renderingGroupId}},e.inputOptions||{})),e.disablePointerSelection||(i.pointerSelection=i.baseExperience.featuresManager.enableFeature(vo.Name,e.useStablePlugins?"stable":"latest",{xrInput:i.input,renderingGroupId:e.renderingGroupId}),e.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(_o.Name,e.useStablePlugins?"stable":"latest",{floorMeshes:e.floorMeshes,xrInput:i.input,renderingGroupId:e.renderingGroupId}),i.teleportation.setSelectionFeature(i.pointerSelection))),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(e.outputCanvasOptions),!e.disableDefaultUI)return i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)}).then(function(){return i}).catch(function(o){return d.a.Error("Error initializing XR"),d.a.Error(o),i})},n.prototype.dispose=function(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()},n}(),Om=!0;ae.a.prototype.createDefaultLight=function(n){if(n===void 0&&(n=!1),n&&this.lights)for(var t=0;t<this.lights.length;t++)this.lights[t].dispose();this.lights.length===0&&new $n.a("default light",l.e.Up(),this)},ae.a.prototype.createDefaultCamera=function(n,t,e){if(n===void 0&&(n=!1),t===void 0&&(t=!1),e===void 0&&(e=!1),t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){var i=this.getWorldExtends(function(C){return C.isVisible&&C.isEnabled()}),r=i.max.subtract(i.min),o=i.min.add(r.scale(.5)),a,s=r.length()*1.5;if(isFinite(s)||(s=1,o.copyFromFloats(0,0,0)),n){var c=new Ai.a("default camera",-(Math.PI/2),Math.PI/2,s,o,this);c.lowerRadiusLimit=s*.01,c.wheelPrecision=100/s,a=c}else{var _=new kt.a("default camera",new l.e(o.x,o.y,-s),this);_.setTarget(o),a=_}a.minZ=s*.01,a.maxZ=s*1e3,a.speed=s*.2,this.activeCamera=a;var b=this.getEngine().getInputElement();e&&b&&a.attachControl()}},ae.a.prototype.createDefaultCameraOrLight=function(n,t,e){n===void 0&&(n=!1),t===void 0&&(t=!1),e===void 0&&(e=!1),this.createDefaultLight(t),this.createDefaultCamera(n,t,e)},ae.a.prototype.createDefaultSkybox=function(n,t,e,i,r){if(t===void 0&&(t=!1),e===void 0&&(e=1e3),i===void 0&&(i=0),r===void 0&&(r=!0),!n)return d.a.Warn("Can not create default skybox without environment texture."),null;r&&n&&(this.environmentTexture=n);var o=st.a.CreateBox("hdrSkyBox",e,this);if(t){var a=new Pu.a("skyBox",this);a.backFaceCulling=!1,a.reflectionTexture=n.clone(),a.reflectionTexture&&(a.reflectionTexture.coordinatesMode=Ze.a.SKYBOX_MODE),a.microSurface=1-i,a.disableLighting=!0,a.twoSidedLighting=!0,o.material=a}else{var s=new zt.a("skyBox",this);s.backFaceCulling=!1,s.reflectionTexture=n.clone(),s.reflectionTexture&&(s.reflectionTexture.coordinatesMode=Ze.a.SKYBOX_MODE),s.disableLighting=!0,o.material=s}return o.isPickable=!1,o.infiniteDistance=!0,o.ignoreCameraMaxZ=!0,o},ae.a.prototype.createDefaultEnvironment=function(n){return vs?new vs(n,this):null},ae.a.prototype.createDefaultVRExperience=function(n){return n===void 0&&(n={}),new We(this,n)},ae.a.prototype.createDefaultXRExperienceAsync=function(n){return n===void 0&&(n={}),Ju.CreateAsync(this,n).then(function(t){return t})};var $u=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){o===void 0&&(o=!1),a===void 0&&(a=!1),s===void 0&&(s=Ze.a.TRILINEAR_SAMPLINGMODE),c===void 0&&(c={autoPlay:!0,loop:!0,autoUpdateTexture:!0});var _=n.call(this,null,r,!o,a)||this;_._onUserActionRequestedObservable=null,_._stillImageCaptured=!1,_._displayingPosterTexture=!1,_._frameId=-1,_._currentSrc=null,_._createInternalTexture=function(){if(_._texture!=null)if(_._displayingPosterTexture)_._texture.dispose(),_._displayingPosterTexture=!1;else return;if(!_._getEngine().needPOTTextures||re.b.IsExponentOfTwo(_.video.videoWidth)&&re.b.IsExponentOfTwo(_.video.videoHeight)?(_.wrapU=Ze.a.WRAP_ADDRESSMODE,_.wrapV=Ze.a.WRAP_ADDRESSMODE):(_.wrapU=Ze.a.CLAMP_ADDRESSMODE,_.wrapV=Ze.a.CLAMP_ADDRESSMODE,_._generateMipMaps=!1),_._texture=_._getEngine().createDynamicTexture(_.video.videoWidth,_.video.videoHeight,_._generateMipMaps,_.samplingMode),!_.video.autoplay&&!_._settings.poster){var C=_.video.onplaying,x=!1,V=_.video.muted;_.video.muted=!0,_.video.onplaying=function(){_.video.muted=V,_.video.onplaying=C,_._updateInternalTexture(),x||_.video.pause(),_.onLoadObservable.hasObservers()&&_.onLoadObservable.notifyObservers(_)};var D=_.video.play();D?D.then(function(){}).catch(function(){x=!0,_._onUserActionRequestedObservable&&_._onUserActionRequestedObservable.hasObservers()&&_._onUserActionRequestedObservable.notifyObservers(_)}):(_.video.onplaying=C,_._updateInternalTexture(),_.onLoadObservable.hasObservers()&&_.onLoadObservable.notifyObservers(_))}else _._updateInternalTexture(),_.onLoadObservable.hasObservers()&&_.onLoadObservable.notifyObservers(_)},_.reset=function(){_._texture!=null&&(_._displayingPosterTexture||(_._texture.dispose(),_._texture=null))},_._updateInternalTexture=function(){if(_._texture!=null&&!(_.video.readyState<_.video.HAVE_CURRENT_DATA)&&!_._displayingPosterTexture){var C=_.getScene().getFrameId();_._frameId!==C&&(_._frameId=C,_._getEngine().updateVideoTexture(_._texture,_.video,_._invertY))}},_._generateMipMaps=o,_._initialSamplingMode=s,_.autoUpdateTexture=c.autoUpdateTexture,_._currentSrc=i,_.name=e||_._getName(i),_.video=_._getVideo(i),_._settings=c,c.poster&&(_.video.poster=c.poster),c.autoPlay!==void 0&&(_.video.autoplay=c.autoPlay),c.loop!==void 0&&(_.video.loop=c.loop),c.muted!==void 0&&(_.video.muted=c.muted),_.video.setAttribute("playsinline",""),_.video.addEventListener("paused",_._updateInternalTexture),_.video.addEventListener("seeked",_._updateInternalTexture),_.video.addEventListener("emptied",_.reset),_._createInternalTextureOnEvent=c.poster&&!c.autoPlay?"play":"canplay",_.video.addEventListener(_._createInternalTextureOnEvent,_._createInternalTexture),c.autoPlay&&_.video.play();var b=_.video.readyState>=_.video.HAVE_CURRENT_DATA;return c.poster&&(!c.autoPlay||!b)?(_._texture=_._getEngine().createTexture(c.poster,!1,!_.invertY,r),_._displayingPosterTexture=!0):b&&_._createInternalTexture(),_}return Object.defineProperty(t.prototype,"onUserActionRequestedObservable",{get:function(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new g.c),this._onUserActionRequestedObservable},enumerable:!1,configurable:!0}),t.prototype._getName=function(e){return e instanceof HTMLVideoElement?e.currentSrc:typeof e=="object"?e.toString():e},t.prototype._getVideo=function(e){if(e instanceof HTMLVideoElement)return re.b.SetCorsBehavior(e.currentSrc,e),e;var i=document.createElement("video");return typeof e=="string"?(re.b.SetCorsBehavior(e,i),i.src=e):(re.b.SetCorsBehavior(e[0],i),e.forEach(function(r){var o=document.createElement("source");o.src=r,i.appendChild(o)})),i},t.prototype._rebuild=function(){this.update()},t.prototype.update=function(){!this.autoUpdateTexture||this.updateTexture(!0)},t.prototype.updateTexture=function(e){!e||this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture())},t.prototype.updateURL=function(e){this.video.src=e,this._currentSrc=e},t.prototype.clone=function(){return new t(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this.reset),this.video.pause()},t.CreateFromStreamAsync=function(e,i){var r=document.createElement("video");return e.getEngine()._badOS&&(document.body.appendChild(r),r.style.transform="scale(0.0001, 0.0001)",r.style.opacity="0",r.style.position="fixed",r.style.bottom="0px",r.style.right="0px"),r.setAttribute("autoplay",""),r.setAttribute("muted","true"),r.setAttribute("playsinline",""),r.muted=!0,r.mozSrcObject!==void 0?r.mozSrcObject=i:typeof r.srcObject=="object"?r.srcObject=i:(window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,r.src=window.URL&&window.URL.createObjectURL(i)),new Promise(function(o){var a=function(){o(new t("video",r,e,!0,!0)),r.removeEventListener("playing",a)};r.addEventListener("playing",a),r.play()})},t.CreateFromWebCamAsync=function(e,i,r){var o=this;r===void 0&&(r=!1);var a;return i&&i.deviceId&&(a={exact:i.deviceId}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia({video:i,audio:r}).then(function(s){return o.CreateFromStreamAsync(e,s)}):(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia&&navigator.getUserMedia({video:{deviceId:a,width:{min:i&&i.minWidth||256,max:i&&i.maxWidth||640},height:{min:i&&i.minHeight||256,max:i&&i.maxHeight||480}},audio:r},function(s){return o.CreateFromStreamAsync(e,s)},function(s){d.a.Error(s.name)}),Promise.reject("No support for userMedia on this device"))},t.CreateFromWebCam=function(e,i,r,o){o===void 0&&(o=!1),this.CreateFromWebCamAsync(e,r,o).then(function(a){i&&i(a)}).catch(function(a){d.a.Error(a.name)})},t}(Ze.a),Mm=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return Object.defineProperty(t.prototype,"videoTexture",{get:function(){return this._texture},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"videoMode",{get:function(){return this.textureMode},set:function(e){this.textureMode=e},enumerable:!1,configurable:!0}),t.prototype._initTexture=function(e,i,r){var o=this,a={loop:r.loop,autoPlay:r.autoPlay,autoUpdateTexture:!0,poster:r.poster},s=new $u((this.name||"videoDome")+"_texture",e,i,r.generateMipMaps,this._useDirectMapping,Ze.a.TRILINEAR_SAMPLINGMODE,a);return r.clickToPlay&&(i.onPointerUp=function(){o._texture.video.play()}),s.onLoadObservable.add(function(){o.onLoadObservable.notifyObservers()}),s},t.MODE_MONOSCOPIC=tn.MODE_MONOSCOPIC,t.MODE_TOPBOTTOM=tn.MODE_TOPBOTTOM,t.MODE_SIDEBYSIDE=tn.MODE_SIDEBYSIDE,t}(tn),fr=u(612),xm=function(){function n(t){this.engine=t,this._captureGPUFrameTime=!1,this._gpuFrameTime=new fr.a,this._captureShaderCompilationTime=!1,this._shaderCompilationTime=new fr.a,this._onBeginFrameObserver=null,this._onEndFrameObserver=null,this._onBeforeShaderCompilationObserver=null,this._onAfterShaderCompilationObserver=null}return Object.defineProperty(n.prototype,"gpuFrameTimeCounter",{get:function(){return this._gpuFrameTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureGPUFrameTime",{get:function(){return this._captureGPUFrameTime},set:function(t){var e=this;t!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=t,t?(this._onBeginFrameObserver=this.engine.onBeginFrameObservable.add(function(){e._gpuFrameTimeToken||(e._gpuFrameTimeToken=e.engine.startTimeQuery())}),this._onEndFrameObserver=this.engine.onEndFrameObservable.add(function(){if(!!e._gpuFrameTimeToken){var i=e.engine.endTimeQuery(e._gpuFrameTimeToken);i>-1&&(e._gpuFrameTimeToken=null,e._gpuFrameTime.fetchNewFrame(),e._gpuFrameTime.addCount(i,!0))}})):(this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shaderCompilationTimeCounter",{get:function(){return this._shaderCompilationTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureShaderCompilationTime",{get:function(){return this._captureShaderCompilationTime},set:function(t){var e=this;t!==this._captureShaderCompilationTime&&(this._captureShaderCompilationTime=t,t?(this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add(function(){e._shaderCompilationTime.fetchNewFrame(),e._shaderCompilationTime.beginMonitoring()}),this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add(function(){e._shaderCompilationTime.endMonitoring()})):(this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null))},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null,this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null,this.engine=null},n}(),Dm=function(){function n(t){var e=this;this.scene=t,this._captureActiveMeshesEvaluationTime=!1,this._activeMeshesEvaluationTime=new fr.a,this._captureRenderTargetsRenderTime=!1,this._renderTargetsRenderTime=new fr.a,this._captureFrameTime=!1,this._frameTime=new fr.a,this._captureRenderTime=!1,this._renderTime=new fr.a,this._captureInterFrameTime=!1,this._interFrameTime=new fr.a,this._captureParticlesRenderTime=!1,this._particlesRenderTime=new fr.a,this._captureSpritesRenderTime=!1,this._spritesRenderTime=new fr.a,this._capturePhysicsTime=!1,this._physicsTime=new fr.a,this._captureAnimationsTime=!1,this._animationsTime=new fr.a,this._captureCameraRenderTime=!1,this._cameraRenderTime=new fr.a,this._onBeforeActiveMeshesEvaluationObserver=null,this._onAfterActiveMeshesEvaluationObserver=null,this._onBeforeRenderTargetsRenderObserver=null,this._onAfterRenderTargetsRenderObserver=null,this._onAfterRenderObserver=null,this._onBeforeDrawPhaseObserver=null,this._onAfterDrawPhaseObserver=null,this._onBeforeAnimationsObserver=null,this._onBeforeParticlesRenderingObserver=null,this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver=null,this._onAfterSpritesRenderingObserver=null,this._onBeforePhysicsObserver=null,this._onAfterPhysicsObserver=null,this._onAfterAnimationsObserver=null,this._onBeforeCameraRenderObserver=null,this._onAfterCameraRenderObserver=null,this._onBeforeAnimationsObserver=t.onBeforeAnimationsObservable.add(function(){e._captureActiveMeshesEvaluationTime&&e._activeMeshesEvaluationTime.fetchNewFrame(),e._captureRenderTargetsRenderTime&&e._renderTargetsRenderTime.fetchNewFrame(),e._captureFrameTime&&(re.b.StartPerformanceCounter("Scene rendering"),e._frameTime.beginMonitoring()),e._captureInterFrameTime&&e._interFrameTime.endMonitoring(),e._captureParticlesRenderTime&&e._particlesRenderTime.fetchNewFrame(),e._captureSpritesRenderTime&&e._spritesRenderTime.fetchNewFrame(),e._captureAnimationsTime&&e._animationsTime.beginMonitoring(),e.scene.getEngine()._drawCalls.fetchNewFrame()}),this._onAfterRenderObserver=t.onAfterRenderObservable.add(function(){e._captureFrameTime&&(re.b.EndPerformanceCounter("Scene rendering"),e._frameTime.endMonitoring()),e._captureRenderTime&&e._renderTime.endMonitoring(!1),e._captureInterFrameTime&&e._interFrameTime.beginMonitoring()})}return Object.defineProperty(n.prototype,"activeMeshesEvaluationTimeCounter",{get:function(){return this._activeMeshesEvaluationTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureActiveMeshesEvaluationTime",{get:function(){return this._captureActiveMeshesEvaluationTime},set:function(t){var e=this;t!==this._captureActiveMeshesEvaluationTime&&(this._captureActiveMeshesEvaluationTime=t,t?(this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add(function(){re.b.StartPerformanceCounter("Active meshes evaluation"),e._activeMeshesEvaluationTime.beginMonitoring()}),this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add(function(){re.b.EndPerformanceCounter("Active meshes evaluation"),e._activeMeshesEvaluationTime.endMonitoring()})):(this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"renderTargetsRenderTimeCounter",{get:function(){return this._renderTargetsRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureRenderTargetsRenderTime",{get:function(){return this._captureRenderTargetsRenderTime},set:function(t){var e=this;t!==this._captureRenderTargetsRenderTime&&(this._captureRenderTargetsRenderTime=t,t?(this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add(function(){re.b.StartPerformanceCounter("Render targets rendering"),e._renderTargetsRenderTime.beginMonitoring()}),this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add(function(){re.b.EndPerformanceCounter("Render targets rendering"),e._renderTargetsRenderTime.endMonitoring(!1)})):(this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"particlesRenderTimeCounter",{get:function(){return this._particlesRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureParticlesRenderTime",{get:function(){return this._captureParticlesRenderTime},set:function(t){var e=this;t!==this._captureParticlesRenderTime&&(this._captureParticlesRenderTime=t,t?(this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add(function(){re.b.StartPerformanceCounter("Particles"),e._particlesRenderTime.beginMonitoring()}),this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add(function(){re.b.EndPerformanceCounter("Particles"),e._particlesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"spritesRenderTimeCounter",{get:function(){return this._spritesRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureSpritesRenderTime",{get:function(){return this._captureSpritesRenderTime},set:function(t){var e=this;t!==this._captureSpritesRenderTime&&(this._captureSpritesRenderTime=t,!!this.scene.spriteManagers&&(t?(this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add(function(){re.b.StartPerformanceCounter("Sprites"),e._spritesRenderTime.beginMonitoring()}),this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add(function(){re.b.EndPerformanceCounter("Sprites"),e._spritesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null)))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"physicsTimeCounter",{get:function(){return this._physicsTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"capturePhysicsTime",{get:function(){return this._capturePhysicsTime},set:function(t){var e=this;t!==this._capturePhysicsTime&&(!this.scene.onBeforePhysicsObservable||(this._capturePhysicsTime=t,t?(this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add(function(){re.b.StartPerformanceCounter("Physics"),e._physicsTime.beginMonitoring()}),this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add(function(){re.b.EndPerformanceCounter("Physics"),e._physicsTime.endMonitoring()})):(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null)))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"animationsTimeCounter",{get:function(){return this._animationsTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureAnimationsTime",{get:function(){return this._captureAnimationsTime},set:function(t){var e=this;t!==this._captureAnimationsTime&&(this._captureAnimationsTime=t,t?this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add(function(){e._animationsTime.endMonitoring()}):(this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"frameTimeCounter",{get:function(){return this._frameTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureFrameTime",{get:function(){return this._captureFrameTime},set:function(t){this._captureFrameTime=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"interFrameTimeCounter",{get:function(){return this._interFrameTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureInterFrameTime",{get:function(){return this._captureInterFrameTime},set:function(t){this._captureInterFrameTime=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"renderTimeCounter",{get:function(){return this._renderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureRenderTime",{get:function(){return this._captureRenderTime},set:function(t){var e=this;t!==this._captureRenderTime&&(this._captureRenderTime=t,t?(this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add(function(){e._renderTime.beginMonitoring(),re.b.StartPerformanceCounter("Main render")}),this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add(function(){e._renderTime.endMonitoring(!1),re.b.EndPerformanceCounter("Main render")})):(this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraRenderTimeCounter",{get:function(){return this._cameraRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"captureCameraRenderTime",{get:function(){return this._captureCameraRenderTime},set:function(t){var e=this;t!==this._captureCameraRenderTime&&(this._captureCameraRenderTime=t,t?(this._onBeforeCameraRenderObserver=this.scene.onBeforeCameraRenderObservable.add(function(i){e._cameraRenderTime.beginMonitoring(),re.b.StartPerformanceCounter("Rendering camera "+i.name)}),this._onAfterCameraRenderObserver=this.scene.onAfterCameraRenderObservable.add(function(i){e._cameraRenderTime.endMonitoring(!1),re.b.EndPerformanceCounter("Rendering camera "+i.name)})):(this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"drawCallsCounter",{get:function(){return this.scene.getEngine()._drawCalls},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=null,this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null,this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null,this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver&&(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null),this._onAfterSpritesRenderingObserver&&(this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null),this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null,this._onBeforePhysicsObserver&&(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null),this._onAfterPhysicsObserver&&(this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null),this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null,this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null,this.scene=null},n}(),qu=u(516),Im=u(576),Lm=u(577),Yi=u(459),j_=u(646),W_=u(647),ec="glowBlurPostProcessPixelShader",tc=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform vec2 screenSize;
uniform vec2 direction;
uniform float blurWidth;

float getLuminance(vec3 color)
{
return dot(color,vec3(0.2126,0.7152,0.0722));
}
void main(void)
{
float weights[7];
weights[0]=0.05;
weights[1]=0.1;
weights[2]=0.2;
weights[3]=0.3;
weights[4]=0.2;
weights[5]=0.1;
weights[6]=0.05;
vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);
vec2 texelStep=texelSize*direction*blurWidth;
vec2 start=vUV-3.0*texelStep;
vec4 baseColor=vec4(0.,0.,0.,0.);
vec2 texelOffset=vec2(0.,0.);
for (int i=0; i<7; i++)
{

vec4 texel=texture2D(textureSampler,start+texelOffset);
baseColor.a+=texel.a*weights[i];

float luminance=getLuminance(baseColor.rgb);
float luminanceTexel=getLuminance(texel.rgb);
float choice=step(luminanceTexel,luminance);
baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;
texelOffset+=texelStep;
}
gl_FragColor=baseColor;
}`;qe.a.ShadersStore[ec]=tc;var H_={name:ec,shader:tc};T.a.prototype.getHighlightLayerByName=function(n){for(var t=0;t<this.effectLayers.length;t++)if(this.effectLayers[t].name===n&&this.effectLayers[t].getEffectName()===Ts.EffectName)return this.effectLayers[t];return null};var ic=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_){s===void 0&&(s=Ze.a.BILINEAR_SAMPLINGMODE);var b=n.call(this,e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,o,a,s,c,_)||this;return b.direction=i,b.kernel=r,b.onApplyObservable.add(function(C){C.setFloat2("screenSize",b.width,b.height),C.setVector2("direction",b.direction),C.setFloat("blurWidth",b.kernel)}),b}return t}(ii.a),Ts=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,i)||this;return o.name=e,o.innerGlow=!0,o.outerGlow=!0,o.onBeforeBlurObservable=new g.c,o.onAfterBlurObservable=new g.c,o._instanceGlowingMeshStencilReference=t.GlowingMeshStencilReference++,o._meshes={},o._excludedMeshes={},o.neutralColor=t.NeutralColor,o._engine.isStencilEnable||d.a.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),o._options=Object(p.a)({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1},r),o._init({alphaBlendingMode:o._options.alphaBlendingMode,camera:o._options.camera,mainTextureFixedSize:o._options.mainTextureFixedSize,mainTextureRatio:o._options.mainTextureRatio,renderingGroupId:o._options.renderingGroupId}),o._shouldRender=!1,o}return Object.defineProperty(t.prototype,"blurHorizontalSize",{get:function(){return this._horizontalBlurPostprocess.kernel},set:function(e){this._horizontalBlurPostprocess.kernel=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurVerticalSize",{get:function(){return this._verticalBlurPostprocess.kernel},set:function(e){this._verticalBlurPostprocess.kernel=e},enumerable:!1,configurable:!0}),t.prototype.getEffectName=function(){return t.EffectName},t.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[Be.b.PositionKind],["offset"],["textureSampler"],this._options.isStroke?`#define STROKE 
`:void 0)},t.prototype._createTextureAndPostProcesses=function(){var e=this,i=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,r=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;i=this._engine.needPOTTextures?G.a.GetExponentOfTwo(i,this._maxSize):i,r=this._engine.needPOTTextures?G.a.GetExponentOfTwo(r,this._maxSize):r;var o=0;this._engine.getCaps().textureHalfFloatRender?o=2:o=0,this._blurTexture=new Cr.a("HighlightLayerBlurRTT",{width:i,height:r},this._scene,!1,!0,o),this._blurTexture.wrapU=Ze.a.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(Ze.a.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._options.alphaBlendingMode===2?(this._downSamplePostprocess=new yn.b("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.onApplyObservable.add(function(a){a.setTexture("textureSampler",e._mainTexture)}),this._horizontalBlurPostprocess=new ic("HighlightLayerHBP",new l.d(1,0),this._options.blurHorizontalSize,1,null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(a){a.setFloat2("screenSize",i,r)}),this._verticalBlurPostprocess=new ic("HighlightLayerVBP",new l.d(0,1),this._options.blurVerticalSize,1,null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(a){a.setFloat2("screenSize",i,r)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new mo.a("HighlightLayerHBP",new l.d(1,0),this._options.blurHorizontalSize/2,{width:i,height:r},null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,o),this._horizontalBlurPostprocess.width=i,this._horizontalBlurPostprocess.height=r,this._horizontalBlurPostprocess.onApplyObservable.add(function(a){a.setTexture("textureSampler",e._mainTexture)}),this._verticalBlurPostprocess=new mo.a("HighlightLayerVBP",new l.d(0,1),this._options.blurVerticalSize/2,{width:i,height:r},null,Ze.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,o),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(function(){e.onBeforeBlurObservable.notifyObservers(e);var a=e._blurTexture.getInternalTexture();a&&(e._scene.postProcessManager.directRender(e._postProcesses,a,!0),e._engine.unBindFramebuffer(a,!0)),e.onAfterBlurObservable.notifyObservers(e)}),this._postProcesses.map(function(a){a.autoClear=!1})},t.prototype.needStencil=function(){return!0},t.prototype.isReady=function(e,i){var r=e.getMaterial(),o=e.getRenderingMesh();if(!r||!o||!this._meshes)return!1;var a=null,s=this._meshes[o.uniqueId];return s&&s.glowEmissiveOnly&&r&&(a=r.emissiveTexture),n.prototype._isReady.call(this,e,i,a)},t.prototype._internalRender=function(e){e.setTexture("textureSampler",this._blurTexture);var i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(Yi.a.TriangleFillMode,0,6)),this.innerGlow&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(Yi.a.TriangleFillMode,0,6)),i.restoreStencilState()},t.prototype.shouldRender=function(){return n.prototype.shouldRender.call(this)?!!this._meshes:!1},t.prototype._shouldRenderMesh=function(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!n.prototype.hasMesh.call(this,e))},t.prototype._canRenderMesh=function(e,i){return!0},t.prototype._addCustomEffectDefines=function(e){e.push("#define HIGHLIGHT")},t.prototype._setEmissiveTextureAndColor=function(e,i,r){var o=this._meshes[e.uniqueId];o?this._emissiveTextureAndColor.color.set(o.color.r,o.color.g,o.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),o&&o.glowEmissiveOnly&&r?(this._emissiveTextureAndColor.texture=r.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null},t.prototype.addExcludedMesh=function(e){if(!!this._excludedMeshes){var i=this._excludedMeshes[e.uniqueId];i||(this._excludedMeshes[e.uniqueId]={mesh:e,beforeBind:e.onBeforeBindObservable.add(function(r){r.getEngine().setStencilBuffer(!1)}),afterRender:e.onAfterRenderObservable.add(function(r){r.getEngine().setStencilBuffer(!0)})})}},t.prototype.removeExcludedMesh=function(e){if(!!this._excludedMeshes){var i=this._excludedMeshes[e.uniqueId];i&&(i.beforeBind&&e.onBeforeBindObservable.remove(i.beforeBind),i.afterRender&&e.onAfterRenderObservable.remove(i.afterRender)),this._excludedMeshes[e.uniqueId]=null}},t.prototype.hasMesh=function(e){return!this._meshes||!n.prototype.hasMesh.call(this,e)?!1:this._meshes[e.uniqueId]!==void 0&&this._meshes[e.uniqueId]!==null},t.prototype.addMesh=function(e,i,r){var o=this;if(r===void 0&&(r=!1),!!this._meshes){var a=this._meshes[e.uniqueId];a?a.color=i:(this._meshes[e.uniqueId]={mesh:e,color:i,observerHighlight:e.onBeforeBindObservable.add(function(s){o.isEnabled&&(o._excludedMeshes&&o._excludedMeshes[s.uniqueId]?o._defaultStencilReference(s):s.getScene().getEngine().setStencilFunctionReference(o._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(function(s){o.isEnabled&&o._defaultStencilReference(s)}),glowEmissiveOnly:r},e.onDisposeObservable.add(function(){o._disposeMesh(e)})),this._shouldRender=!0}},t.prototype.removeMesh=function(e){if(!!this._meshes){var i=this._meshes[e.uniqueId];i&&(i.observerHighlight&&e.onBeforeBindObservable.remove(i.observerHighlight),i.observerDefault&&e.onAfterRenderObservable.remove(i.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(var r in this._meshes)if(this._meshes[r]){this._shouldRender=!0;break}}},t.prototype.removeAllMeshes=function(){if(!!this._meshes){for(var e in this._meshes)if(this._meshes.hasOwnProperty(e)){var i=this._meshes[e];i&&this.removeMesh(i.mesh)}}},t.prototype._defaultStencilReference=function(e){e.getScene().getEngine().setStencilFunctionReference(t.NormalMeshStencilReference)},t.prototype._disposeMesh=function(e){this.removeMesh(e),this.removeExcludedMesh(e)},t.prototype.dispose=function(){if(this._meshes){for(var e in this._meshes){var i=this._meshes[e];i&&i.mesh&&(i.observerHighlight&&i.mesh.onBeforeBindObservable.remove(i.observerHighlight),i.observerDefault&&i.mesh.onAfterRenderObservable.remove(i.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(var e in this._excludedMeshes){var i=this._excludedMeshes[e];i&&(i.beforeBind&&i.mesh.onBeforeBindObservable.remove(i.beforeBind),i.afterRender&&i.mesh.onAfterRenderObservable.remove(i.afterRender))}this._excludedMeshes=null}n.prototype.dispose.call(this)},t.prototype.getClassName=function(){return"HighlightLayer"},t.prototype.serialize=function(){var e=Ee.a.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(var i in this._meshes){var r=this._meshes[i];r&&e.meshes.push({glowEmissiveOnly:r.glowEmissiveOnly,color:r.color.asArray(),meshId:r.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(var o in this._excludedMeshes){var a=this._excludedMeshes[o];a&&e.excludedMeshes.push(a.mesh.id)}return e},t.Parse=function(e,i,r){var o=Ee.a.Parse(function(){return new t(e.name,i,e.options)},e,i,r),a;for(a=0;a<e.excludedMeshes.length;a++){var s=i.getMeshByID(e.excludedMeshes[a]);s&&o.addExcludedMesh(s)}for(a=0;a<e.meshes.length;a++){var c=e.meshes[a],s=i.getMeshByID(c.meshId);s&&o.addMesh(s,v.a.FromArray(c.color),c.glowEmissiveOnly)}return o},t.EffectName="HighlightLayer",t.NeutralColor=new v.b(0,0,0,0),t.GlowingMeshStencilReference=2,t.NormalMeshStencilReference=1,Object(p.c)([Object(Ee.c)()],t.prototype,"innerGlow",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"outerGlow",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"blurHorizontalSize",null),Object(p.c)([Object(Ee.c)()],t.prototype,"blurVerticalSize",null),Object(p.c)([Object(Ee.c)("options")],t.prototype,"_options",void 0),t}(qu.a);f.a.RegisteredTypes["BABYLON.HighlightLayer"]=Ts;var rc=function(){function n(t){this.name=X.a.NAME_LAYER,this.scene=t,this._engine=t.getEngine(),t.layers=new Array}return n.prototype.register=function(){this.scene._beforeCameraDrawStage.registerStep(X.a.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(X.a.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForeground),this.scene._beforeRenderTargetDrawStage.registerStep(X.a.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(X.a.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForeground)},n.prototype.rebuild=function(){for(var t=this.scene.layers,e=0,i=t;e<i.length;e++){var r=i[e];r._rebuild()}},n.prototype.dispose=function(){for(var t=this.scene.layers;t.length;)t[0].dispose()},n.prototype._draw=function(t){var e=this.scene.layers;if(e.length){this._engine.setDepthBuffer(!1);for(var i=0,r=e;i<r.length;i++){var o=r[i];t(o)&&o.render()}this._engine.setDepthBuffer(!0)}},n.prototype._drawCameraPredicate=function(t,e,i){return!t.renderOnlyInRenderTargetTextures&&t.isBackground===e&&(t.layerMask&i)!=0},n.prototype._drawCameraBackground=function(t){var e=this;this._draw(function(i){return e._drawCameraPredicate(i,!0,t.layerMask)})},n.prototype._drawCameraForeground=function(t){var e=this;this._draw(function(i){return e._drawCameraPredicate(i,!1,t.layerMask)})},n.prototype._drawRenderTargetPredicate=function(t,e,i,r){return t.renderTargetTextures.length>0&&t.isBackground===e&&t.renderTargetTextures.indexOf(r)>-1&&(t.layerMask&i)!=0},n.prototype._drawRenderTargetBackground=function(t){var e=this;this._draw(function(i){return e._drawRenderTargetPredicate(i,!0,e.scene.activeCamera.layerMask,t)})},n.prototype._drawRenderTargetForeground=function(t){var e=this;this._draw(function(i){return e._drawRenderTargetPredicate(i,!1,e.scene.activeCamera.layerMask,t)})},n.prototype.addFromContainer=function(t){var e=this;!t.layers||t.layers.forEach(function(i){e.scene.layers.push(i)})},n.prototype.removeFromContainer=function(t,e){var i=this;e===void 0&&(e=!1),!!t.layers&&t.layers.forEach(function(r){var o=i.scene.layers.indexOf(r);o!==-1&&i.scene.layers.splice(o,1),e&&r.dispose()})},n}(),nc="layerPixelShader",oc=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform vec4 color;

#include<helperFunctions>
void main(void) {
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef LINEAR
baseColor.rgb=toGammaSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
}`;qe.a.ShadersStore[nc]=oc;var k_={name:nc,shader:oc},ac="layerVertexShader",sc=`
attribute vec2 position;

uniform vec2 scale;
uniform vec2 offset;
uniform mat4 textureMatrix;

varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vec2 shiftedPosition=position*scale+offset;
vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));
gl_Position=vec4(shiftedPosition,0.0,1.0);
}`;qe.a.ShadersStore[ac]=sc;var X_={name:ac,shader:sc},Fm=function(){function n(t,e,i,r,o){this.name=t,this.scale=new l.d(1,1),this.offset=new l.d(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this._vertexBuffers={},this.onDisposeObservable=new g.c,this.onBeforeRenderObservable=new g.c,this.onAfterRenderObservable=new g.c,this.texture=e?new Ze.a(e,i,!0):null,this.isBackground=r===void 0?!0:r,this.color=o===void 0?new v.b(1,1,1,1):o,this._scene=i||Kt.a.LastCreatedScene;var a=this._scene._getComponent(X.a.NAME_LAYER);a||(a=new rc(this._scene),this._scene._addComponent(a)),this._scene.layers.push(this);var s=this._scene.getEngine(),c=[];c.push(1,1),c.push(-1,1),c.push(-1,-1),c.push(1,-1);var _=new Be.b(s,c,Be.b.PositionKind,!1,!1,2);this._vertexBuffers[Be.b.PositionKind]=_,this._createIndexBuffer()}return Object.defineProperty(n.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onBeforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onAfterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!1,configurable:!0}),n.prototype._createIndexBuffer=function(){var t=this._scene.getEngine(),e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=t.createIndexBuffer(e)},n.prototype._rebuild=function(){var t=this._vertexBuffers[Be.b.PositionKind];t&&t._rebuild(),this._createIndexBuffer()},n.prototype.render=function(){var t=this._scene.getEngine(),e="";this.alphaTest&&(e="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(e+=`\r
#define LINEAR`),this._previousDefines!==e&&(this._previousDefines=e,this._effect=t.createEffect("layer",[Be.b.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],e));var i=this._effect;if(!(!i||!i.isReady()||!this.texture||!this.texture.isReady())){var t=this._scene.getEngine();this.onBeforeRenderObservable.notifyObservers(this),t.enableEffect(i),t.setState(!1),i.setTexture("textureSampler",this.texture),i.setMatrix("textureMatrix",this.texture.getTextureMatrix()),i.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),i.setVector2("offset",this.offset),i.setVector2("scale",this.scale),t.bindBuffers(this._vertexBuffers,this._indexBuffer,i),this.alphaTest?t.drawElementsType(Yi.a.TriangleFillMode,0,6):(t.setAlphaMode(this.alphaBlendingMode),t.drawElementsType(Yi.a.TriangleFillMode,0,6),t.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}},n.prototype.dispose=function(){var t=this._vertexBuffers[Be.b.PositionKind];t&&(t.dispose(),this._vertexBuffers[Be.b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];var e=this._scene.layers.indexOf(this);this._scene.layers.splice(e,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()},n}(),lc=function(){function n(t,e,i,r,o){this.size=t,this.position=e,this.alphaMode=6,this.color=i||new v.a(1,1,1),this.texture=r?new Ze.a(r,o.getScene(),!0):null,this._system=o,o.lensFlares.push(this)}return n.AddFlare=function(t,e,i,r,o){return new n(t,e,i,r,o)},n.prototype.dispose=function(){this.texture&&this.texture.dispose();var t=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(t,1)},n}(),uc="lensFlarePixelShader",cc=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform vec4 color;
void main(void) {
vec4 baseColor=texture2D(textureSampler,vUV);
gl_FragColor=baseColor*color;
}`;qe.a.ShadersStore[uc]=cc;var Y_={name:uc,shader:cc},fc="lensFlareVertexShader",hc=`
attribute vec2 position;

uniform mat4 viewportMatrix;

varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vUV=position*madd+madd;
gl_Position=viewportMatrix*vec4(position,0.0,1.0);
}`;qe.a.ShadersStore[fc]=hc;var K_={name:fc,shader:hc},As=function(){function n(t,e,i){this.name=t,this.lensFlares=new Array,this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=i||Kt.a.LastCreatedScene,n._SceneComponentInitialization(this._scene),this._emitter=e,this.id=t,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=function(s){return i.activeCamera&&s.material&&s.isVisible&&s.isEnabled()&&s.isBlocker&&(s.layerMask&i.activeCamera.layerMask)!=0};var r=i.getEngine(),o=[];o.push(1,1),o.push(-1,1),o.push(-1,-1),o.push(1,-1),this._vertexBuffers[Be.b.PositionKind]=new Be.b(r,o,Be.b.PositionKind,!1,!1,2);var a=[];a.push(0),a.push(1),a.push(2),a.push(0),a.push(2),a.push(3),this._indexBuffer=r.createIndexBuffer(a),this._effect=r.createEffect("lensFlare",[Be.b.PositionKind],["color","viewportMatrix"],["textureSampler"],"")}return Object.defineProperty(n.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(t){this._isEnabled=t},enumerable:!1,configurable:!0}),n.prototype.getScene=function(){return this._scene},n.prototype.getEmitter=function(){return this._emitter},n.prototype.setEmitter=function(t){this._emitter=t},n.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},n.prototype.computeEffectivePosition=function(t){var e=this.getEmitterPosition();e=l.e.Project(e,l.a.Identity(),this._scene.getTransformMatrix(),t),this._positionX=e.x,this._positionY=e.y,e=l.e.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(t.x-=this.viewportBorder,t.y-=this.viewportBorder,t.width+=this.viewportBorder*2,t.height+=this.viewportBorder*2,e.x+=this.viewportBorder,e.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);var i=this._scene.useRightHandedSystem,r=e.z>0&&!i||e.z<0&&i;return r?(this._positionX>t.x&&this._positionX<t.x+t.width&&this._positionY>t.y&&this._positionY<t.y+t.height,!0):!1},n.prototype._isVisible=function(){if(!this._isEnabled||!this._scene.activeCamera)return!1;var t=this.getEmitterPosition(),e=t.subtract(this._scene.activeCamera.globalPosition),i=e.length();e.normalize();var r=new Jt.a(this._scene.activeCamera.globalPosition,e),o=this._scene.pickWithRay(r,this.meshesSelectionPredicate,!0);return!o||!o.hit||o.distance>i},n.prototype.render=function(){if(!this._effect.isReady()||!this._scene.activeCamera)return!1;var t=this._scene.getEngine(),e=this._scene.activeCamera.viewport,i=e.toGlobal(t.getRenderWidth(!0),t.getRenderHeight(!0));if(!this.computeEffectivePosition(i)||!this._isVisible())return!1;var r,o;this._positionX<this.borderLimit+i.x?r=this.borderLimit+i.x-this._positionX:this._positionX>i.x+i.width-this.borderLimit?r=this._positionX-i.x-i.width+this.borderLimit:r=0,this._positionY<this.borderLimit+i.y?o=this.borderLimit+i.y-this._positionY:this._positionY>i.y+i.height-this.borderLimit?o=this._positionY-i.y-i.height+this.borderLimit:o=0;var a=r>o?r:o;a-=this.viewportBorder,a>this.borderLimit&&(a=this.borderLimit);var s=1-$e.a.Clamp(a/this.borderLimit,0,1);if(s<0)return!1;s>1&&(s=1),this.viewportBorder>0&&(i.x+=this.viewportBorder,i.y+=this.viewportBorder,i.width-=this.viewportBorder*2,i.height-=this.viewportBorder*2,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);var c=i.x+i.width/2,_=i.y+i.height/2,b=c-this._positionX,C=_-this._positionY;t.enableEffect(this._effect),t.setState(!1),t.setDepthBuffer(!1),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);for(var x=0;x<this.lensFlares.length;x++){var V=this.lensFlares[x];if(!(V.texture&&!V.texture.isReady())){t.setAlphaMode(V.alphaMode);var D=c-b*V.position,z=_-C*V.position,q=V.size,ue=V.size*t.getAspectRatio(this._scene.activeCamera,!0),ge=2*(D/(i.width+i.x*2))-1,Se=1-2*(z/(i.height+i.y*2)),Pe=l.a.FromValues(q/2,0,0,0,0,ue/2,0,0,0,0,1,0,ge,Se,0,1);this._effect.setMatrix("viewportMatrix",Pe),this._effect.setTexture("textureSampler",V.texture),this._effect.setFloat4("color",V.color.r*s,V.color.g*s,V.color.b*s,1),t.drawElementsType(Yi.a.TriangleFillMode,0,6)}}return t.setDepthBuffer(!0),t.setAlphaMode(0),!0},n.prototype.dispose=function(){var t=this._vertexBuffers[Be.b.PositionKind];for(t&&(t.dispose(),this._vertexBuffers[Be.b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();var e=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(e,1)},n.Parse=function(t,e,i){var r=e.getLastEntryByID(t.emitterId),o=t.name||"lensFlareSystem#"+t.emitterId,a=new n(o,r,e);a.id=t.id||o,a.borderLimit=t.borderLimit;for(var s=0;s<t.flares.length;s++){var c=t.flares[s];lc.AddFlare(c.size,c.position,v.a.FromArray(c.color),c.textureName?i+c.textureName:"",a)}return a},n.prototype.serialize=function(){var t={};t.id=this.id,t.name=this.name,t.emitterId=this.getEmitter().id,t.borderLimit=this.borderLimit,t.flares=[];for(var e=0;e<this.lensFlares.length;e++){var i=this.lensFlares[e];t.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:re.b.GetFilename(i.texture?i.texture.name:"")})}return t},n._SceneComponentInitialization=function(t){throw Re.a.WarnImport("LensFlareSystemSceneComponent")},n}();T.a.AddParser(X.a.NAME_LENSFLARESYSTEM,function(n,t,e,i){if(n.lensFlareSystems!==void 0&&n.lensFlareSystems!==null){e.lensFlareSystems||(e.lensFlareSystems=new Array);for(var r=0,o=n.lensFlareSystems.length;r<o;r++){var a=n.lensFlareSystems[r],s=As.Parse(a,t,i);e.lensFlareSystems.push(s)}}}),T.a.prototype.getLensFlareSystemByName=function(n){for(var t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===n)return this.lensFlareSystems[t];return null},T.a.prototype.getLensFlareSystemByID=function(n){for(var t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===n)return this.lensFlareSystems[t];return null},T.a.prototype.removeLensFlareSystem=function(n){var t=this.lensFlareSystems.indexOf(n);return t!==-1&&this.lensFlareSystems.splice(t,1),t},T.a.prototype.addLensFlareSystem=function(n){this.lensFlareSystems.push(n)};var dc=function(){function n(t){this.name=X.a.NAME_LENSFLARESYSTEM,this.scene=t,t.lensFlareSystems=new Array}return n.prototype.register=function(){this.scene._afterCameraDrawStage.registerStep(X.a.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)},n.prototype.rebuild=function(){},n.prototype.addFromContainer=function(t){var e=this;!t.lensFlareSystems||t.lensFlareSystems.forEach(function(i){e.scene.addLensFlareSystem(i)})},n.prototype.removeFromContainer=function(t,e){var i=this;!t.lensFlareSystems||t.lensFlareSystems.forEach(function(r){i.scene.removeLensFlareSystem(r),e&&r.dispose()})},n.prototype.serialize=function(t){t.lensFlareSystems=[];for(var e=this.scene.lensFlareSystems,i=0,r=e;i<r.length;i++){var o=r[i];t.lensFlareSystems.push(o.serialize())}},n.prototype.dispose=function(){for(var t=this.scene.lensFlareSystems;t.length;)t[0].dispose()},n.prototype._draw=function(t){if(this.scene.lensFlaresEnabled){var e=this.scene.lensFlareSystems;re.b.StartPerformanceCounter("Lens flares",e.length>0);for(var i=0,r=e;i<r.length;i++){var o=r[i];(t.layerMask&o.layerMask)!=0&&o.render()}re.b.EndPerformanceCounter("Lens flares",e.length>0)}},n}();As._SceneComponentInitialization=function(n){var t=n._getComponent(X.a.NAME_LENSFLARESYSTEM);t||(t=new dc(n),n._addComponent(t))};var pc=u(541),Bm=u(628),Nm=u(694);Nt.a.AddNodeConstructor("Light_Type_0",function(n,t){return function(){return new Rs(n,l.e.Zero(),t)}});var Rs=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,r)||this;return o._shadowAngle=Math.PI/2,o.position=i,o}return Object.defineProperty(t.prototype,"shadowAngle",{get:function(){return this._shadowAngle},set:function(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},set:function(e){var i=this.needCube();this._direction=e,this.needCube()!==i&&this._shadowGenerator&&this._shadowGenerator.recreateShadowMap()},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PointLight"},t.prototype.getTypeID=function(){return Zo.a.LIGHTTYPEID_POINTLIGHT},t.prototype.needCube=function(){return!this.direction},t.prototype.getShadowDirection=function(e){if(this.direction)return n.prototype.getShadowDirection.call(this,e);switch(e){case 0:return new l.e(1,0,0);case 1:return new l.e(-1,0,0);case 2:return new l.e(0,-1,0);case 3:return new l.e(0,1,0);case 4:return new l.e(0,0,1);case 5:return new l.e(0,0,-1)}return l.e.Zero()},t.prototype._setDefaultShadowProjectionMatrix=function(e,i,r){var o=this.getScene().activeCamera;!o||l.a.PerspectiveFovLHToRef(this.shadowAngle,1,this.getDepthMinZ(o),this.getDepthMaxZ(o),e)},t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype.transferToEffect=function(e,i){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,i):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,i),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,i),this},t.prototype.transferToNodeMaterialEffect=function(e,i){return this.computeTransformedInformation()?e.setFloat3(i,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(i,this.position.x,this.position.y,this.position.z),this},t.prototype.prepareLightSpecificDefines=function(e,i){e["POINTLIGHT"+i]=!0},Object(p.c)([Object(Ee.c)()],t.prototype,"shadowAngle",null),t}(fs.a),wm=u(695),mc=u(677),Vm=u(668),Um=u(719),vr=u(474),gc=function(){function n(t){t===void 0&&(t={}),this._isEnabled=!0,this.bias=t.bias===void 0?0:t.bias,this.power=t.power===void 0?1:t.power,this.leftColor=t.leftColor||v.a.White(),this.rightColor=t.rightColor||v.a.Black(),t.isEnabled===!1&&(this.isEnabled=!1)}return Object.defineProperty(n.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(t){this._isEnabled!==t&&(this._isEnabled=t,G.a.MarkAllMaterialsAsDirty(4|16))},enumerable:!1,configurable:!0}),n.prototype.clone=function(){var t=new n;return vr.a.DeepCopy(this,t),t},n.prototype.equals=function(t){return t&&this.bias===t.bias&&this.power===t.power&&this.leftColor.equals(t.leftColor)&&this.rightColor.equals(t.rightColor)&&this.isEnabled===t.isEnabled},n.prototype.serialize=function(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}},n.Parse=function(t){return new n({isEnabled:t.isEnabled,leftColor:v.a.FromArray(t.leftColor),rightColor:v.a.FromArray(t.rightColor),bias:t.bias,power:t.power||1})},n}();Ee.a._FresnelParametersParser=gc.Parse;var vc=u(690),yo=u(543),Q_=u(732),Z_=u(733),Gm=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e,i,"color",{attributes:["position"],uniforms:["world","viewProjection","color"]})||this;return r.disableColorWrite=!0,r.forceDepthWrite=!0,r.setColor4("color",new v.b(0,0,0,1)),r}return t}(Tn.a),Hr=u(529),Os=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r.maxSimultaneousLights=4,r.disableLighting=!1,r.invertNormalMapX=!1,r.invertNormalMapY=!1,r.emissiveColor=new v.a(0,0,0),r.occlusionStrength=1,r.useLightmapAsShadowmap=!1,r._useAlphaFromAlbedoTexture=!0,r._useAmbientInGrayScale=!0,r}return Object.defineProperty(t.prototype,"doubleSided",{get:function(){return this._twoSidedLighting},set:function(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PBRBaseSimpleMaterial"},Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"maxSimultaneousLights",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsLightsDirty")],t.prototype,"disableLighting",void 0),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],t.prototype,"environmentTexture",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"invertNormalMapX",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"invertNormalMapY",void 0),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],t.prototype,"normalTexture",void 0),Object(p.c)([Object(Ee.e)("emissive"),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"emissiveColor",void 0),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"emissiveTexture",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],t.prototype,"occlusionStrength",void 0),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],t.prototype,"occlusionTexture",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],t.prototype,"alphaCutOff",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"doubleSided",null),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty",null)],t.prototype,"lightmapTexture",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"useLightmapAsShadowmap",void 0),t}(Hr.a),_c=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r._useRoughnessFromMetallicTextureAlpha=!1,r._useRoughnessFromMetallicTextureGreen=!0,r._useMetallnessFromMetallicTextureBlue=!0,r.metallic=1,r.roughness=1,r}return t.prototype.getClassName=function(){return"PBRMetallicRoughnessMaterial"},t.prototype.clone=function(e){var i=this,r=Ee.a.Clone(function(){return new t(e,i.getScene())},this);return r.id=e,r.name=e,this.clearCoat.copyTo(r.clearCoat),this.anisotropy.copyTo(r.anisotropy),this.brdf.copyTo(r.brdf),this.sheen.copyTo(r.sheen),this.subSurface.copyTo(r.subSurface),r},t.prototype.serialize=function(){var e=Ee.a.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e},t.Parse=function(e,i,r){var o=Ee.a.Parse(function(){return new t(e.name,i)},e,i,r);return e.clearCoat&&o.clearCoat.parse(e.clearCoat,i,r),e.anisotropy&&o.anisotropy.parse(e.anisotropy,i,r),e.brdf&&o.brdf.parse(e.brdf,i,r),e.sheen&&o.sheen.parse(e.sheen,i,r),e.subSurface&&o.subSurface.parse(e.subSurface,i,r),o},Object(p.c)([Object(Ee.e)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],t.prototype,"baseColor",void 0),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],t.prototype,"baseTexture",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"metallic",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty")],t.prototype,"roughness",void 0),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],t.prototype,"metallicRoughnessTexture",void 0),t}(Os);f.a.RegisteredTypes["BABYLON.PBRMetallicRoughnessMaterial"]=_c;var yc=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e,i)||this;return r._useMicroSurfaceFromReflectivityMapAlpha=!0,r}return Object.defineProperty(t.prototype,"useMicroSurfaceFromReflectivityMapAlpha",{get:function(){return this._useMicroSurfaceFromReflectivityMapAlpha},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PBRSpecularGlossinessMaterial"},t.prototype.clone=function(e){var i=this,r=Ee.a.Clone(function(){return new t(e,i.getScene())},this);return r.id=e,r.name=e,this.clearCoat.copyTo(r.clearCoat),this.anisotropy.copyTo(r.anisotropy),this.brdf.copyTo(r.brdf),this.sheen.copyTo(r.sheen),this.subSurface.copyTo(r.subSurface),r},t.prototype.serialize=function(){var e=Ee.a.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e},t.Parse=function(e,i,r){var o=Ee.a.Parse(function(){return new t(e.name,i)},e,i,r);return e.clearCoat&&o.clearCoat.parse(e.clearCoat,i,r),e.anisotropy&&o.anisotropy.parse(e.anisotropy,i,r),e.brdf&&o.brdf.parse(e.brdf,i,r),e.sheen&&o.sheen.parse(e.sheen,i,r),e.subSurface&&o.subSurface.parse(e.subSurface,i,r),o},Object(p.c)([Object(Ee.e)("diffuse"),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],t.prototype,"diffuseColor",void 0),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],t.prototype,"diffuseTexture",void 0),Object(p.c)([Object(Ee.e)("specular"),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],t.prototype,"specularColor",void 0),Object(p.c)([Object(Ee.c)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_microSurface")],t.prototype,"glossiness",void 0),Object(p.c)([Object(Ee.m)(),Object(Ee.b)("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],t.prototype,"specularGlossinessTexture",void 0),t}(Os);f.a.RegisteredTypes["BABYLON.PBRSpecularGlossinessMaterial"]=yc;var bc=function(n){Object(p.d)(t,n);function t(e,i,r){r===void 0&&(r=null);var o=n.call(this,i)||this;if(!e)return o;if(o._textureMatrix=l.a.Identity(),o.name=e,o.url=e,o._onLoad=r,o._texture=o._getFromCache(e,!0),o._texture)o._triggerOnLoad();else{var a=o.getScene();a&&a.useDelayedTextureLoading?o.delayLoadState=4:o.loadTexture()}return o}return t.prototype._triggerOnLoad=function(){this._onLoad&&this._onLoad()},t.prototype.getTextureMatrix=function(){return this._textureMatrix},t.prototype.load3dlTexture=function(){var e=this,i=this._getEngine(),r;i._features.support3DTextures?r=i.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):r=i.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=r,this._texture.isReady=!1,this.isCube=!1,this.is3D=i._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;var o=function(s){if(typeof s=="string"){for(var c=null,_=null,b,C=s.split(`
`),x=0,V=0,D=0,z=0,q=0,ue=0;ue<C.length;ue++)if(b=C[ue],!!t._noneEmptyLineRegex.test(b)&&b.indexOf("#")!==0){var ge=b.split(" ");if(x===0){x=ge.length,c=new Uint8Array(x*x*x*4),_=new Float32Array(x*x*x*4);continue}if(x!=0){var Se=Math.max(parseInt(ge[0]),0),Pe=Math.max(parseInt(ge[1]),0),me=Math.max(parseInt(ge[2]),0);q=Math.max(Se,q),q=Math.max(Pe,q),q=Math.max(me,q);var xe=(V+z*x+D*x*x)*4;_&&(_[xe+0]=Se,_[xe+1]=Pe,_[xe+2]=me),D++,D%x==0&&(z++,D=0,z%x==0&&(V++,z=0))}}if(_&&c)for(var ue=0;ue<_.length;ue++)if(ue>0&&(ue+1)%4==0)c[ue]=255;else{var Fe=_[ue];c[ue]=Fe/q*255}r.is3D?(r.updateSize(x,x,x),i.updateRawTexture3D(r,c,5,!1)):(r.updateSize(x*x,x),i.updateRawTexture(r,c,5,!1)),r.isReady=!0,e._triggerOnLoad()}},a=this.getScene();return a?a._loadFile(this.url,o):i._loadFile(this.url,o),this._texture},t.prototype.loadTexture=function(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this.load3dlTexture()},t.prototype.clone=function(){var e=new t(this.url,this.getScene()||this._getEngine());return e.level=this.level,e},t.prototype.delayLoad=function(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this.loadTexture())},t.Parse=function(e,i){var r=null;return e.name&&!e.isRenderTarget&&(r=new t(e.name,i),r.name=e.name,r.level=e.level),r},t.prototype.serialize=function(){if(!this.name)return null;var e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e},t._noneEmptyLineRegex=/\S+/,t}(jr.a);f.a.RegisteredTypes["BABYLON.ColorGradingTexture"]=bc;var Ec=u(569),Pc=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){o===void 0&&(o=!1),a===void 0&&(a=!0),s===void 0&&(s=null),c===void 0&&(c=null);var _=n.call(this,i)||this;if(_._onLoad=null,_._onError=null,!e)throw new Error("Image url is not set");return _._coordinatesMode=Ze.a.CUBIC_MODE,_.name=e,_.url=e,_._size=r,_._noMipmap=o,_.gammaSpace=a,_._onLoad=s,_._onError=c,_.hasAlpha=!1,_.isCube=!0,_._texture=_._getFromCache(e,_._noMipmap),_._texture?s&&(_._texture.isReady?re.b.SetImmediate(function(){return s()}):_._texture.onLoadedObservable.add(s)):i.useDelayedTextureLoading?_.delayLoadState=4:_.loadImage(_.loadTexture.bind(_),_._onError),_}return t.prototype.loadImage=function(e,i){var r=this,o=document.createElement("canvas"),a=new Image;a.addEventListener("load",function(){r._width=a.width,r._height=a.height,o.width=r._width,o.height=r._height;var s=o.getContext("2d");s.drawImage(a,0,0);var c=s.getImageData(0,0,a.width,a.height);r._buffer=c.data.buffer,o.remove(),e()}),a.addEventListener("error",function(s){i&&i(r.getClassName()+" could not be loaded",s)}),a.src=this.url},t.prototype.loadTexture=function(){var e=this,i=this.getScene(),r=function(){for(var o=e.getFloat32ArrayFromArrayBuffer(e._buffer),a=Ec.a.ConvertPanoramaToCubemap(o,e._width,e._height,e._size),s=[],c=0;c<6;c++){var _=a[t._FacesMapping[c]];s.push(_)}return s};!i||(this._texture=i.getEngine().createRawCubeTextureFromUrl(this.url,i,this._size,4,i.getEngine().getCaps().textureFloat?1:7,this._noMipmap,r,null,this._onLoad,this._onError))},t.prototype.getFloat32ArrayFromArrayBuffer=function(e){for(var i=new DataView(e),r=new Float32Array(e.byteLength*3/4),o=0,a=0;a<e.byteLength;a++)(a+1)%4!=0&&(r[o++]=i.getUint8(a)/255);return r},t.prototype.getClassName=function(){return"EquiRectangularCubeTexture"},t.prototype.clone=function(){var e=this.getScene();if(!e)return this;var i=new t(this.url,e,this._size,this._noMipmap,this.gammaSpace);return i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i.coordinatesIndex=this.coordinatesIndex,i.coordinatesMode=this.coordinatesMode,i},t._FacesMapping=["right","left","up","down","front","back"],t}(jr.a),zm=u(637),Cc=u(567),jm=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,r.scene||r.engine)||this;return!i||!r.engine&&!r.scene||(r=Object(p.a)(Object(p.a)({},t.DefaultOptions),r),o._generateMipMaps=r.generateMipMaps,o._samplingMode=r.samplingMode,o._textureMatrix=l.a.Identity(),o.name=e,o.element=i,o._isVideo=i instanceof HTMLVideoElement,o.anisotropicFilteringLevel=1,o._createInternalTexture()),o}return t.prototype._createInternalTexture=function(){var e=0,i=0;this._isVideo?(e=this.element.videoWidth,i=this.element.videoHeight):(e=this.element.width,i=this.element.height);var r=this._getEngine();r&&(this._texture=r.createDynamicTexture(e,i,this._generateMipMaps,this._samplingMode)),this.update()},t.prototype.getTextureMatrix=function(){return this._textureMatrix},t.prototype.update=function(e){e===void 0&&(e=null);var i=this._getEngine();if(!(this._texture==null||i==null))if(this._isVideo){var r=this.element;if(r.readyState<r.HAVE_CURRENT_DATA)return;i.updateVideoTexture(this._texture,r,e===null?!0:e)}else{var o=this.element;i.updateDynamicTexture(this._texture,o,e===null?!0:e,!1)}},t.DefaultOptions={generateMipMaps:!1,samplingMode:2,engine:null,scene:null},t}(jr.a),qo=function(){function n(){}return n.GetTGAHeader=function(t){var e=0,i={id_length:t[e++],colormap_type:t[e++],image_type:t[e++],colormap_index:t[e++]|t[e++]<<8,colormap_length:t[e++]|t[e++]<<8,colormap_size:t[e++],origin:[t[e++]|t[e++]<<8,t[e++]|t[e++]<<8],width:t[e++]|t[e++]<<8,height:t[e++]|t[e++]<<8,pixel_size:t[e++],flags:t[e++]};return i},n.UploadContent=function(t,e){if(e.length<19){d.a.Error("Unable to load TGA file - Not enough data to contain header");return}var i=18,r=n.GetTGAHeader(e);if(r.id_length+i>e.length){d.a.Error("Unable to load TGA file - Not enough data");return}i+=r.id_length;var o=!1,a=!1,s=!1;switch(r.image_type){case n._TYPE_RLE_INDEXED:o=!0;case n._TYPE_INDEXED:a=!0;break;case n._TYPE_RLE_RGB:o=!0;case n._TYPE_RGB:break;case n._TYPE_RLE_GREY:o=!0;case n._TYPE_GREY:s=!0;break}var c,_=r.pixel_size>>3,b=r.width*r.height*_,C;if(a&&(C=e.subarray(i,i+=r.colormap_length*(r.colormap_size>>3))),o){c=new Uint8Array(b);for(var x,V,D,z=0,q=new Uint8Array(_);i<b&&z<b;)if(x=e[i++],V=(x&127)+1,x&128){for(D=0;D<_;++D)q[D]=e[i++];for(D=0;D<V;++D)c.set(q,z+D*_);z+=_*V}else{for(V*=_,D=0;D<V;++D)c[z+D]=e[i++];z+=V}}else c=e.subarray(i,i+=a?r.width*r.height:b);var ue,ge,Se,Pe,me,xe;switch((r.flags&n._ORIGIN_MASK)>>n._ORIGIN_SHIFT){default:case n._ORIGIN_UL:ue=0,Se=1,xe=r.width,ge=0,Pe=1,me=r.height;break;case n._ORIGIN_BL:ue=0,Se=1,xe=r.width,ge=r.height-1,Pe=-1,me=-1;break;case n._ORIGIN_UR:ue=r.width-1,Se=-1,xe=-1,ge=0,Pe=1,me=r.height;break;case n._ORIGIN_BR:ue=r.width-1,Se=-1,xe=-1,ge=r.height-1,Pe=-1,me=-1;break}var Fe="_getImageData"+(s?"Grey":"")+r.pixel_size+"bits",we=n[Fe](r,C,c,ge,Pe,me,ue,Se,xe),Ge=t.getEngine();Ge._uploadDataToTextureDirectly(t,we)},n._getImageData8bits=function(t,e,i,r,o,a,s,c,_){var b=i,C=e,x=t.width,V=t.height,D,z=0,q,ue,ge=new Uint8Array(x*V*4);for(ue=r;ue!==a;ue+=o)for(q=s;q!==_;q+=c,z++)D=b[z],ge[(q+x*ue)*4+3]=255,ge[(q+x*ue)*4+2]=C[D*3+0],ge[(q+x*ue)*4+1]=C[D*3+1],ge[(q+x*ue)*4+0]=C[D*3+2];return ge},n._getImageData16bits=function(t,e,i,r,o,a,s,c,_){var b=i,C=t.width,x=t.height,V,D=0,z,q,ue=new Uint8Array(C*x*4);for(q=r;q!==a;q+=o)for(z=s;z!==_;z+=c,D+=2){V=b[D+0]+(b[D+1]<<8);var ge=((V&31744)>>10)*255/31|0,Se=((V&992)>>5)*255/31|0,Pe=(V&31)*255/31|0;ue[(z+C*q)*4+0]=ge,ue[(z+C*q)*4+1]=Se,ue[(z+C*q)*4+2]=Pe,ue[(z+C*q)*4+3]=V&32768?0:255}return ue},n._getImageData24bits=function(t,e,i,r,o,a,s,c,_){var b=i,C=t.width,x=t.height,V=0,D,z,q=new Uint8Array(C*x*4);for(z=r;z!==a;z+=o)for(D=s;D!==_;D+=c,V+=3)q[(D+C*z)*4+3]=255,q[(D+C*z)*4+2]=b[V+0],q[(D+C*z)*4+1]=b[V+1],q[(D+C*z)*4+0]=b[V+2];return q},n._getImageData32bits=function(t,e,i,r,o,a,s,c,_){var b=i,C=t.width,x=t.height,V=0,D,z,q=new Uint8Array(C*x*4);for(z=r;z!==a;z+=o)for(D=s;D!==_;D+=c,V+=4)q[(D+C*z)*4+2]=b[V+0],q[(D+C*z)*4+1]=b[V+1],q[(D+C*z)*4+0]=b[V+2],q[(D+C*z)*4+3]=b[V+3];return q},n._getImageDataGrey8bits=function(t,e,i,r,o,a,s,c,_){var b=i,C=t.width,x=t.height,V,D=0,z,q,ue=new Uint8Array(C*x*4);for(q=r;q!==a;q+=o)for(z=s;z!==_;z+=c,D++)V=b[D],ue[(z+C*q)*4+0]=V,ue[(z+C*q)*4+1]=V,ue[(z+C*q)*4+2]=V,ue[(z+C*q)*4+3]=255;return ue},n._getImageDataGrey16bits=function(t,e,i,r,o,a,s,c,_){var b=i,C=t.width,x=t.height,V=0,D,z,q=new Uint8Array(C*x*4);for(z=r;z!==a;z+=o)for(D=s;D!==_;D+=c,V+=2)q[(D+C*z)*4+0]=b[V+0],q[(D+C*z)*4+1]=b[V+0],q[(D+C*z)*4+2]=b[V+0],q[(D+C*z)*4+3]=b[V+1];return q},n._TYPE_INDEXED=1,n._TYPE_RGB=2,n._TYPE_GREY=3,n._TYPE_RLE_INDEXED=9,n._TYPE_RLE_RGB=10,n._TYPE_RLE_GREY=11,n._ORIGIN_MASK=48,n._ORIGIN_SHIFT=4,n._ORIGIN_BL=0,n._ORIGIN_BR=1,n._ORIGIN_UL=2,n._ORIGIN_UR=3,n}(),Sc=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t){return Ar.a.EndsWith(t,".tga")},n.prototype.loadCubeData=function(t,e,i,r,o){throw".env not supported in Cube."},n.prototype.loadData=function(t,e,i){var r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),o=qo.GetTGAHeader(r);i(o.width,o.height,e.generateMipMaps,!1,function(){qo.UploadContent(e,r)})},n}();G.a._TextureLoaders.push(new Sc);var Ms=u(568),Tc=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t){return Ar.a.EndsWith(t,".hdr")},n.prototype.loadCubeData=function(t,e,i,r,o){throw".env not supported in Cube."},n.prototype.loadData=function(t,e,i){for(var r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),o=Ms.a.RGBE_ReadHeader(r),a=Ms.a.RGBE_ReadPixels(r,o),s=o.width*o.height,c=new Float32Array(s*4),_=0;_<s;_+=1)c[_*4]=a[_*3],c[_*4+1]=a[_*3+1],c[_*4+2]=a[_*3+2],c[_*4+3]=1;i(o.width,o.height,e.generateMipMaps,!1,function(){var b=e.getEngine();e.type=1,e.format=5,e._gammaSpace=!1,b._uploadDataToTextureDirectly(e,c)})},n}();G.a._TextureLoaders.push(new Tc);var J_=function(){function n(){}return n}(),$_=function(){function n(){}return n}(),Wm=function(){function n(){}return n}(),bo;(function(n){n[n.cTFETC1=0]="cTFETC1",n[n.cTFBC1=1]="cTFBC1",n[n.cTFBC4=2]="cTFBC4",n[n.cTFPVRTC1_4_OPAQUE_ONLY=3]="cTFPVRTC1_4_OPAQUE_ONLY",n[n.cTFBC7_M6_OPAQUE_ONLY=4]="cTFBC7_M6_OPAQUE_ONLY",n[n.cTFETC2=5]="cTFETC2",n[n.cTFBC3=6]="cTFBC3",n[n.cTFBC5=7]="cTFBC5"})(bo||(bo={}));var Eo=function(){function n(){}return n.GetInternalFormatFromBasisFormat=function(t){var e=33777,i=33779,r=36196;if(t===bo.cTFETC1)return r;if(t===bo.cTFBC1)return e;if(t===bo.cTFBC3)return i;throw"The chosen Basis transcoder format is not currently supported"},n._CreateWorkerAsync=function(){var t=this;return this._WorkerPromise||(this._WorkerPromise=new Promise(function(e){t._Worker?e(t._Worker):re.b.LoadFileAsync(n.WasmModuleURL).then(function(i){var r=URL.createObjectURL(new Blob(["("+Hm+")()"],{type:"application/javascript"}));t._Worker=new Worker(r);var o=function(a){a.data.action==="init"&&(t._Worker.removeEventListener("message",o),e(t._Worker))};t._Worker.addEventListener("message",o),t._Worker.postMessage({action:"init",url:n.JSModuleURL,wasmBinary:i})})})),this._WorkerPromise},n.TranscodeAsync=function(t,e){var i=this,r=t instanceof ArrayBuffer?new Uint8Array(t):t;return new Promise(function(o,a){i._CreateWorkerAsync().then(function(){var s=i._actionId++,c=function(b){b.data.action==="transcode"&&b.data.id===s&&(i._Worker.removeEventListener("message",c),b.data.success?o(b.data):a("Transcode is not supported on this device"))};i._Worker.addEventListener("message",c);var _=new Uint8Array(r.byteLength);_.set(new Uint8Array(r.buffer,r.byteOffset,r.byteLength)),i._Worker.postMessage({action:"transcode",id:s,imageData:_,config:e,ignoreSupportedFormats:i._IgnoreSupportedFormats},[_.buffer])})})},n.LoadTextureFromTranscodeResult=function(t,e){for(var i=t.getEngine(),r=function(){if(o=e.fileInfo.images[a].levels[0],t._invertVScale=t.invertY,e.format===-1)if(t.type=10,t.format=4,i._features.basisNeedsPOT&&($e.a.Log2(o.width)%1!=0||$e.a.Log2(o.height)%1!=0)){var s=new gt.a(i,gt.b.Temp);t._invertVScale=t.invertY,s.type=10,s.format=4,s.width=o.width+3&~3,s.height=o.height+3&~3,i._bindTextureDirectly(i._gl.TEXTURE_2D,s,!0),i._uploadDataToTextureDirectly(s,o.transcodedPixels,a,0,4,!0),i._rescaleTexture(s,t,i.scenes[0],i._getInternalFormat(4),function(){i._releaseTexture(s),i._bindTextureDirectly(i._gl.TEXTURE_2D,t,!0)})}else t._invertVScale=!t.invertY,t.width=o.width+3&~3,t.height=o.height+3&~3,i._uploadDataToTextureDirectly(t,o.transcodedPixels,a,0,4,!0);else t.width=o.width,t.height=o.height,e.fileInfo.images[a].levels.forEach(function(c,_){i._uploadCompressedDataToTextureDirectly(t,n.GetInternalFormatFromBasisFormat(e.format),c.width,c.height,c.transcodedPixels,a,_)}),i._features.basisNeedsPOT&&($e.a.Log2(t.width)%1!=0||$e.a.Log2(t.height)%1!=0)&&(re.b.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),t._cachedWrapU=Ze.a.CLAMP_ADDRESSMODE,t._cachedWrapV=Ze.a.CLAMP_ADDRESSMODE)},o,a=0;a<e.fileInfo.images.length;a++)r()},n._IgnoreSupportedFormats=!1,n.JSModuleURL="https://preview.babylonjs.com/basisTranscoder/basis_transcoder.js",n.WasmModuleURL="https://preview.babylonjs.com/basisTranscoder/basis_transcoder.wasm",n._WorkerPromise=null,n._Worker=null,n._actionId=0,n}();function Hm(){var n={cTFETC1:0,cTFBC1:1,cTFBC4:2,cTFPVRTC1_4_OPAQUE_ONLY:3,cTFBC7_M6_OPAQUE_ONLY:4,cTFETC2:5,cTFBC3:6,cTFBC5:7},t=null;onmessage=function(a){if(a.data.action==="init")t||(Module={wasmBinary:a.data.wasmBinary},importScripts(a.data.url),t=new Promise(function(me){Module.onRuntimeInitialized=function(){Module.initializeBasis(),me()}})),t.then(function(){postMessage({action:"init"})});else if(a.data.action==="transcode"){var s=a.data.config,c=a.data.imageData,_=new Module.BasisFile(c),b=i(_),C=a.data.ignoreSupportedFormats?null:e(a.data.config,b),x=!1;C===null&&(x=!0,C=b.hasAlpha?n.cTFBC3:n.cTFBC1);var V=!0;_.startTranscoding()||(V=!1);for(var D=[],z=0;z<b.images.length&&V;z++){var q=b.images[z];if(s.loadSingleImage===void 0||s.loadSingleImage===z){var ue=q.levels.length;s.loadMipmapLevels===!1&&(ue=1);for(var ge=0;ge<ue;ge++){var Se=q.levels[ge],Pe=r(_,z,ge,C,x);if(!Pe){V=!1;break}Se.transcodedPixels=Pe,D.push(Se.transcodedPixels.buffer)}}}_.close(),_.delete(),x&&(C=-1),V?postMessage({action:"transcode",success:V,id:a.data.id,fileInfo:b,format:C},D):postMessage({action:"transcode",success:V,id:a.data.id})}};function e(a,s){var c=null;return a.supportedCompressionFormats&&(a.supportedCompressionFormats.etc1?c=n.cTFETC1:a.supportedCompressionFormats.s3tc?c=s.hasAlpha?n.cTFBC3:n.cTFBC1:a.supportedCompressionFormats.pvrtc||a.supportedCompressionFormats.etc2&&(c=n.cTFETC2)),c}function i(a){for(var s=a.getHasAlpha(),c=a.getNumImages(),_=[],b=0;b<c;b++){for(var C={levels:[]},x=a.getNumLevels(b),V=0;V<x;V++){var D={width:a.getImageWidth(b,V),height:a.getImageHeight(b,V)};C.levels.push(D)}_.push(C)}var z={hasAlpha:s,images:_};return z}function r(a,s,c,_,b){var C=a.getImageTranscodedSizeInBytes(s,c,_),x=new Uint8Array(C);if(!a.transcodeImage(x,s,c,_,1,0))return null;if(b){var V=a.getImageWidth(s,c)+3&~3,D=a.getImageHeight(s,c)+3&~3;x=o(x,0,V,D)}return x}function o(a,s,c,_){for(var b=new Uint16Array(4),C=new Uint16Array(c*_),x=c/4,V=_/4,D=0;D<V;D++)for(var z=0;z<x;z++){var q=s+8*(D*x+z);b[0]=a[q]|a[q+1]<<8,b[1]=a[q+2]|a[q+3]<<8,b[2]=(2*(b[0]&31)+1*(b[1]&31))/3|(2*(b[0]&2016)+1*(b[1]&2016))/3&2016|(2*(b[0]&63488)+1*(b[1]&63488))/3&63488,b[3]=(2*(b[1]&31)+1*(b[0]&31))/3|(2*(b[1]&2016)+1*(b[0]&2016))/3&2016|(2*(b[1]&63488)+1*(b[0]&63488))/3&63488;for(var ue=0;ue<4;ue++){var ge=a[q+4+ue],Se=(D*4+ue)*c+z*4;C[Se++]=b[ge&3],C[Se++]=b[ge>>2&3],C[Se++]=b[ge>>4&3],C[Se++]=b[ge>>6&3]}}return C}}var Ac=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(t){return Ar.a.EndsWith(t,".basis")},n.prototype.loadCubeData=function(t,e,i,r,o){if(!Array.isArray(t)){var a=e.getEngine().getCaps(),s={supportedCompressionFormats:{etc1:!!a.etc1,s3tc:!!a.s3tc,pvrtc:!!a.pvrtc,etc2:!!a.etc2}};Eo.TranscodeAsync(t,s).then(function(c){var _=c.fileInfo.images[0].levels.length>1&&e.generateMipMaps;Eo.LoadTextureFromTranscodeResult(e,c),e.getEngine()._setCubeMapTextureParams(e,_),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()}).catch(function(c){re.b.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),e.isReady=!0})}},n.prototype.loadData=function(t,e,i){var r=e.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2}};Eo.TranscodeAsync(t,o).then(function(a){var s=a.fileInfo.images[0].levels[0],c=a.fileInfo.images[0].levels.length>1&&e.generateMipMaps;i(s.width,s.height,c,a.format!==-1,function(){Eo.LoadTextureFromTranscodeResult(e,a)})}).catch(function(a){re.b.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),i(0,0,!1,!1,function(){})})},n}();G.a._TextureLoaders.push(new Ac);var km=u(538),xs=function(){function n(t,e,i){this.id=t,this.scale=e,this.offset=i}return n}(),Xm=function(){function n(t,e,i,r){var o,a,s,c,_,b,C,x,V,D,z,q,ue;return this.name=t,this.meshes=e,this.scene=r,this.options=i,this.options.map=(o=this.options.map)!==null&&o!==void 0?o:["ambientTexture","bumpTexture","diffuseTexture","emissiveTexture","lightmapTexture","opacityTexture","reflectionTexture","refractionTexture","specularTexture"],this.options.uvsIn=(a=this.options.uvsIn)!==null&&a!==void 0?a:Be.b.UVKind,this.options.uvsOut=(s=this.options.uvsOut)!==null&&s!==void 0?s:Be.b.UVKind,this.options.layout=(c=this.options.layout)!==null&&c!==void 0?c:n.LAYOUT_STRIP,this.options.layout===n.LAYOUT_COLNUM&&(this.options.colnum=(_=this.options.colnum)!==null&&_!==void 0?_:8),this.options.updateInputMeshes=(b=this.options.updateInputMeshes)!==null&&b!==void 0?b:!0,this.options.disposeSources=(C=this.options.disposeSources)!==null&&C!==void 0?C:!0,this._expecting=0,this.options.fillBlanks=(x=this.options.fillBlanks)!==null&&x!==void 0?x:!0,this.options.fillBlanks===!0&&(this.options.customFillColor=(V=this.options.customFillColor)!==null&&V!==void 0?V:"black"),this.options.frameSize=(D=this.options.frameSize)!==null&&D!==void 0?D:256,this.options.paddingRatio=(z=this.options.paddingRatio)!==null&&z!==void 0?z:.0115,this._paddingValue=Math.ceil(this.options.frameSize*this.options.paddingRatio),this._paddingValue%2!=0&&this._paddingValue++,this.options.paddingMode=(q=this.options.paddingMode)!==null&&q!==void 0?q:n.SUBUV_WRAP,this.options.paddingMode===n.SUBUV_COLOR&&(this.options.paddingColor=(ue=this.options.paddingColor)!==null&&ue!==void 0?ue:new v.b(0,0,0,1)),this.sets={},this.frames=[],this}return n.prototype._createFrames=function(t){for(var e=this,i=this._calculateSize(),r=new l.d(1,1).divide(i),o=0,a=this._expecting,s=this.meshes.length,c=Object.keys(this.sets),_=0;_<c.length;_++){var b=c[_],C=new un.a(this.name+".TexturePack."+b+"Set",{width:i.x,height:i.y},this.scene,!0,Ze.a.TRILINEAR_SAMPLINGMODE,G.a.TEXTUREFORMAT_RGBA),x=C.getContext();x.fillStyle="rgba(0,0,0,0)",x.fillRect(0,0,i.x,i.y),C.update(!1),this.sets[b]=C}for(var V=this.options.frameSize||256,D=this._paddingValue,z=V+2*D,q=function(){e._calculateMeshUVFrames(V,D,i,r,e.options.updateInputMeshes||!1)},_=0;_<s;_++)for(var ue=this.meshes[_],ge=ue.material,Se=function(Fe){var we=new un.a("temp",z,Pe.scene,!0),Ge=we.getContext(),Xe=Pe._getFrameOffset(_),Oe=function(){o++,we.update(!1);var Je=Ge.getImageData(0,0,z,z),it=e.sets[je],Ke=it.getContext();if(Ke.putImageData(Je,i.x*Xe.x,i.y*Xe.y),we.dispose(),it.update(!1),o==a){q(),t();return}},je=c[Fe]||"_blank";if(!ge||ge[je]===null)Ge.fillStyle="rgba(0,0,0,0)",Pe.options.fillBlanks&&(Ge.fillStyle=Pe.options.customFillColor),Ge.fillRect(0,0,z,z),Oe();else{var ke=ge[je],ze=new Image;ke instanceof un.a?ze.src=ke.getContext().canvas.toDataURL("image/png"):ze.src=ke.url,re.b.SetCorsBehavior(ze.src,ze),ze.onload=function(){Ge.fillStyle="rgba(0,0,0,0)",Ge.fillRect(0,0,z,z),we.update(!1),Ge.setTransform(1,0,0,-1,0,0);var Je=[0,0,1,0,1,1,0,1,-1,1,-1,0,-1-1,0,-1,1,-1];switch(e.options.paddingMode){case 0:for(var it=0;it<9;it++)Ge.drawImage(ze,0,0,ze.width,ze.height,D+V*Je[it],D+V*Je[it+1]-z,V,V);break;case 1:for(var Ke=0;Ke<D;Ke++)Ge.drawImage(ze,0,0,ze.width,ze.height,Ke+V*Je[0],D-z,V,V),Ge.drawImage(ze,0,0,ze.width,ze.height,D*2-Ke,D-z,V,V),Ge.drawImage(ze,0,0,ze.width,ze.height,D,Ke-z,V,V),Ge.drawImage(ze,0,0,ze.width,ze.height,D,D*2-Ke-z,V,V);Ge.drawImage(ze,0,0,ze.width,ze.height,D+V*Je[0],D+V*Je[1]-z,V,V);break;case 2:Ge.fillStyle=(e.options.paddingColor||v.a.Black()).toHexString(),Ge.fillRect(0,0,z,-z),Ge.clearRect(D,D,V,V),Ge.drawImage(ze,0,0,ze.width,ze.height,D+V*Je[0],D+V*Je[1]-z,V,V);break}Ge.setTransform(1,0,0,1,0,0),Oe()}}},Pe=this,me=0;me<c.length;me++)Se(me)},n.prototype._calculateSize=function(){var t=this.meshes.length||0,e=this.options.frameSize||0,i=this._paddingValue||0;switch(this.options.layout){case 0:return new l.d(e*t+2*i*t,e+2*i);case 1:var r=Math.max(2,Math.ceil(Math.sqrt(t))),o=e*r+2*i*r;return new l.d(o,o);case 2:var a=this.options.colnum||1,s=Math.max(1,Math.ceil(t/a));return new l.d(e*a+2*i*a,e*s+2*i*s)}return l.d.Zero()},n.prototype._calculateMeshUVFrames=function(t,e,i,r,o){for(var a=this.meshes.length,s=0;s<a;s++){var c=this.meshes[s],_=new l.d(t/i.x,t/i.y),b=r.clone().scale(e),C=this._getFrameOffset(s),x=C.add(b),V=new xs(s,_,x);this.frames.push(V),o&&(this._updateMeshUV(c,s),this._updateTextureReferences(c))}},n.prototype._getFrameOffset=function(t){var e=this.meshes.length,i,r,o;switch(this.options.layout){case 0:return i=1/e,new l.d(t*i,0);break;case 1:var a=Math.max(2,Math.ceil(Math.sqrt(e)));return r=Math.floor(t/a),o=t-r*a,i=1/a,new l.d(o*i,r*i);break;case 2:var s=this.options.colnum||1,c=Math.max(1,Math.ceil(e/s));return o=Math.floor(t/c),r=t-o*c,i=new l.d(1/s,1/c),new l.d(o*i.x,r*i.y);break}return l.d.Zero()},n.prototype._updateMeshUV=function(t,e){var i=this.frames[e],r=t.getVerticesData(this.options.uvsIn||Be.b.UVKind),o=[],a=0;r.length&&(a=r.length||0);for(var s=0;s<a;s+=2)o.push(r[s]*i.scale.x+i.offset.x,r[s+1]*i.scale.y+i.offset.y);t.setVerticesData(this.options.uvsOut||Be.b.UVKind,o)},n.prototype._updateTextureReferences=function(t,e){e===void 0&&(e=!1);for(var i=t.material,r=Object.keys(this.sets),o=function(c){c.dispose&&c.dispose()},a=0;a<r.length;a++){var s=r[a];if(e)i[s]!==null&&o(i[s]),i[s]=this.sets[s];else{if(!i)return;i[s]!==null&&(o(i[s]),i[s]=this.sets[s])}}},n.prototype.setMeshToFrame=function(t,e,i){i===void 0&&(i=!1),this._updateMeshUV(t,e),i&&this._updateTextureReferences(t,!0)},n.prototype.processAsync=function(){var t=this;return new Promise(function(e,i){try{if(t.meshes.length===0){e();return}for(var r=0,o=function(_){if(r++,t.options.map){for(var b=0;b<t.options.map.length;b++){var C=t.options.map[b],x=_[C];x!==null&&(t.sets[t.options.map[b]]||(t.sets[t.options.map[b]]=!0),t._expecting++)}r===t.meshes.length&&t._createFrames(e)}},a=function(_){var b=t.meshes[_],C=b.material;if(!C)return r++,r===t.meshes.length?{value:t._createFrames(e)}:"continue";C.forceCompilationAsync(b).then(function(){o(C)})},s=0;s<t.meshes.length;s++){var c=a(s);if(typeof c=="object")return c.value}}catch(_){return i(_)}})},n.prototype.dispose=function(){for(var t=Object.keys(this.sets),e=0;e<t.length;e++){var i=t[e];this.sets[i].dispose()}},n.prototype.download=function(t,e){var i=this;t===void 0&&(t="png"),e===void 0&&(e=1),setTimeout(function(){var r={name:i.name,sets:{},options:{},frames:[]},o=Object.keys(i.sets),a=Object.keys(i.options);try{for(var s=0;s<o.length;s++){var c=o[s],_=i.sets[c];r.sets[c]=_.getContext().canvas.toDataURL("image/"+t,e)}for(var s=0;s<a.length;s++){var b=a[s];r.options[b]=i.options[b]}for(var s=0;s<i.frames.length;s++){var C=i.frames[s];r.frames.push(C.scale.x,C.scale.y,C.offset.x,C.offset.y)}}catch(D){d.a.Warn("Unable to download: "+D);return}var x="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(r,null,4)),V=document.createElement("a");V.setAttribute("href",x),V.setAttribute("download",i.name+"_texurePackage.json"),document.body.appendChild(V),V.click(),V.remove()},0)},n.prototype.updateFromJSON=function(t){try{var e=JSON.parse(t);this.name=e.name;for(var i=Object.keys(e.options),r=0;r<i.length;r++)this.options[i[r]]=e.options[i[r]];for(var r=0;r<e.frames.length;r+=4){var o=new xs(r/4,new l.d(e.frames[r],e.frames[r+1]),new l.d(e.frames[r+2],e.frames[r+3]));this.frames.push(o)}for(var a=Object.keys(e.sets),r=0;r<a.length;r++){var s=new Ze.a(e.sets[a[r]],this.scene,!1,!1);this.sets[a[r]]=s}}catch(c){d.a.Warn("Unable to update from JSON: "+c)}},n.LAYOUT_STRIP=0,n.LAYOUT_POWER2=1,n.LAYOUT_COLNUM=2,n.SUBUV_WRAP=0,n.SUBUV_EXTEND=1,n.SUBUV_COLOR=2,n}(),Rc=function(){function n(t){this.name=X.a.NAME_PROCEDURALTEXTURE,this.scene=t,this.scene.proceduralTextures=new Array}return n.prototype.register=function(){this.scene._beforeClearStage.registerStep(X.a.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n.prototype._beforeClear=function(){if(this.scene.proceduralTexturesEnabled){re.b.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(var t=0;t<this.scene.proceduralTextures.length;t++){var e=this.scene.proceduralTextures[t];e._shouldRender()&&e.render()}re.b.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}},n}(),Oc="proceduralVertexShader",Mc=`
attribute vec2 position;

varying vec2 vPosition;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
void main(void) {
vPosition=position;
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
}`;qe.a.ShadersStore[Oc]=Mc;var q_={name:Oc,shader:Mc},Po=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_){a===void 0&&(a=null),s===void 0&&(s=!0),c===void 0&&(c=!1),_===void 0&&(_=0);var b=n.call(this,null,o,!s)||this;b.isEnabled=!0,b.autoClear=!0,b.onGeneratedObservable=new g.c,b.onBeforeGenerationObservable=new g.c,b.nodeMaterialSource=null,b._textures={},b._currentRefreshId=-1,b._frameId=-1,b._refreshRate=1,b._vertexBuffers={},b._uniforms=new Array,b._samplers=new Array,b._floats={},b._ints={},b._floatsArrays={},b._colors3={},b._colors4={},b._vectors2={},b._vectors3={},b._matrices={},b._fallbackTextureUsed=!1,b._cachedDefines=null,b._contentUpdateId=-1,o=b.getScene()||Kt.a.LastCreatedScene;var C=o._getComponent(X.a.NAME_PROCEDURALTEXTURE);C||(C=new Rc(o),o._addComponent(C)),o.proceduralTextures.push(b),b._fullEngine=o.getEngine(),b.name=e,b.isRenderTarget=!0,b._size=i,b._textureType=_,b._generateMipMaps=s,b.setFragment(r),b._fallbackTexture=a,c?(b._texture=b._fullEngine.createRenderTargetCubeTexture(i,{generateMipMaps:s,generateDepthBuffer:!1,generateStencilBuffer:!1,type:_}),b.setFloat("face",0)):b._texture=b._fullEngine.createRenderTargetTexture(i,{generateMipMaps:s,generateDepthBuffer:!1,generateStencilBuffer:!1,type:_});var x=[];return x.push(1,1),x.push(-1,1),x.push(-1,-1),x.push(1,-1),b._vertexBuffers[Be.b.PositionKind]=new Be.b(b._fullEngine,x,Be.b.PositionKind,!1,!1,2),b._createIndexBuffer(),b}return t.prototype.getEffect=function(){return this._effect},t.prototype.getContent=function(){var e=this;return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(function(i){e._contentData=e.readPixels(0,0,i),e._contentUpdateId=e._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)},t.prototype._createIndexBuffer=function(){var e=this._fullEngine,i=[];i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),this._indexBuffer=e.createIndexBuffer(i)},t.prototype._rebuild=function(){var e=this._vertexBuffers[Be.b.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Cr.a.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Cr.a.REFRESHRATE_RENDER_ONCE)},t.prototype.reset=function(){this._effect!==void 0&&this._effect.dispose()},t.prototype._getDefines=function(){return""},t.prototype.isReady=function(){var e=this,i=this._fullEngine,r;if(this.nodeMaterialSource)return this._effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;var o=this._getDefines();return this._effect&&o===this._cachedDefines&&this._effect.isReady()?!0:(this._fragment.fragmentElement!==void 0?r={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:r={vertex:"procedural",fragment:this._fragment},this._cachedDefines!==o&&(this._cachedDefines=o,this._effect=i.createEffect(r,[Be.b.PositionKind],this._uniforms,this._samplers,o,void 0,void 0,function(){e.releaseInternalTexture(),e._fallbackTexture&&(e._texture=e._fallbackTexture._texture,e._texture&&e._texture.incrementReferences()),e._fallbackTextureUsed=!0})),this._effect.isReady())},t.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},t.prototype.setFragment=function(e){this._fragment=e},Object.defineProperty(t.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(e){this._refreshRate=e,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),t.prototype._shouldRender=function(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)},t.prototype.getRenderSize=function(){return this._size},t.prototype.resize=function(e,i){this._fallbackTextureUsed||(this.releaseInternalTexture(),this._texture=this._fullEngine.createRenderTargetTexture(e,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:this._textureType}),this._size=e,this._generateMipMaps=i)},t.prototype._checkUniform=function(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)},t.prototype.setTexture=function(e,i){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=i,this},t.prototype.setFloat=function(e,i){return this._checkUniform(e),this._floats[e]=i,this},t.prototype.setInt=function(e,i){return this._checkUniform(e),this._ints[e]=i,this},t.prototype.setFloats=function(e,i){return this._checkUniform(e),this._floatsArrays[e]=i,this},t.prototype.setColor3=function(e,i){return this._checkUniform(e),this._colors3[e]=i,this},t.prototype.setColor4=function(e,i){return this._checkUniform(e),this._colors4[e]=i,this},t.prototype.setVector2=function(e,i){return this._checkUniform(e),this._vectors2[e]=i,this},t.prototype.setVector3=function(e,i){return this._checkUniform(e),this._vectors3[e]=i,this},t.prototype.setMatrix=function(e,i){return this._checkUniform(e),this._matrices[e]=i,this},t.prototype.render=function(e){var i=this.getScene();if(!!i){var r=this._fullEngine;if(r.enableEffect(this._effect),this.onBeforeGenerationObservable.notifyObservers(this),r.setState(!1),!this.nodeMaterialSource){for(var o in this._textures)this._effect.setTexture(o,this._textures[o]);for(o in this._ints)this._effect.setInt(o,this._ints[o]);for(o in this._floats)this._effect.setFloat(o,this._floats[o]);for(o in this._floatsArrays)this._effect.setArray(o,this._floatsArrays[o]);for(o in this._colors3)this._effect.setColor3(o,this._colors3[o]);for(o in this._colors4){var a=this._colors4[o];this._effect.setFloat4(o,a.r,a.g,a.b,a.a)}for(o in this._vectors2)this._effect.setVector2(o,this._vectors2[o]);for(o in this._vectors3)this._effect.setVector3(o,this._vectors3[o]);for(o in this._matrices)this._effect.setMatrix(o,this._matrices[o])}if(!!this._texture){if(r._debugPushGroup("procedural texture generation for "+this.name,1),this.isCube)for(var s=0;s<6;s++)r.bindFramebuffer(this._texture,s,void 0,void 0,!0),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),this._effect.setFloat("face",s),this.autoClear&&r.clear(i.clearColor,!0,!1,!1),r.drawElementsType(Yi.a.TriangleFillMode,0,6);else r.bindFramebuffer(this._texture,0,void 0,void 0,!0),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),this.autoClear&&r.clear(i.clearColor,!0,!1,!1),r.drawElementsType(Yi.a.TriangleFillMode,0,6);r.unBindFramebuffer(this._texture,this.isCube),this.isCube&&r.generateMipMapsForCubemap(this._texture),r._debugPopGroup(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}}},t.prototype.clone=function(){var e=this.getSize(),i=new t(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,i},t.prototype.dispose=function(){var e=this.getScene();if(!!e){var i=e.proceduralTextures.indexOf(this);i>=0&&e.proceduralTextures.splice(i,1);var r=this._vertexBuffers[Be.b.PositionKind];r&&(r.dispose(),this._vertexBuffers[Be.b.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),n.prototype.dispose.call(this)}},Object(p.c)([Object(Ee.c)()],t.prototype,"isEnabled",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"autoClear",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_generateMipMaps",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"_size",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"refreshRate",null),t}(Ze.a);f.a.RegisteredTypes["BABYLON.ProceduralTexture"]=Po;var Rr=u(519),Ym=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,r,null,o,a,s)||this;return c._animate=!0,c._time=0,c._texturePath=i,c._loadJson(i),c.refreshRate=1,c}return t.prototype._loadJson=function(e){var i=this,r=function(){try{i.setFragment(i._texturePath)}catch(s){d.a.Error("No json or ShaderStore or DOM element found for CustomProceduralTexture")}},o=e+"/config.json",a=new Rr.a;a.open("GET",o),a.addEventListener("load",function(){if(a.status===200||a.responseText&&a.responseText.length>0)try{i._config=JSON.parse(a.response),i.updateShaderUniforms(),i.updateTextures(),i.setFragment(i._texturePath+"/custom"),i._animate=i._config.animate,i.refreshRate=i._config.refreshrate}catch(s){r()}else r()},!1),a.addEventListener("error",function(){r()},!1);try{a.send()}catch(s){d.a.Error("CustomProceduralTexture: Error on XHR send request.")}},t.prototype.isReady=function(){if(!n.prototype.isReady.call(this))return!1;for(var e in this._textures){var i=this._textures[e];if(!i.isReady())return!1}return!0},t.prototype.render=function(e){var i=this.getScene();this._animate&&i&&(this._time+=i.getAnimationRatio()*.03,this.updateShaderUniforms()),n.prototype.render.call(this,e)},t.prototype.updateTextures=function(){for(var e=0;e<this._config.sampler2Ds.length;e++)this.setTexture(this._config.sampler2Ds[e].sample2Dname,new Ze.a(this._texturePath+"/"+this._config.sampler2Ds[e].textureRelativeUrl,this.getScene()))},t.prototype.updateShaderUniforms=function(){if(this._config)for(var e=0;e<this._config.uniforms.length;e++){var i=this._config.uniforms[e];switch(i.type){case"float":this.setFloat(i.name,i.value);break;case"color3":this.setColor3(i.name,new v.a(i.r,i.g,i.b));break;case"color4":this.setColor4(i.name,new v.b(i.r,i.g,i.b,i.a));break;case"vector2":this.setVector2(i.name,new l.d(i.x,i.y));break;case"vector3":this.setVector3(i.name,new l.e(i.x,i.y,i.z));break}}this.setFloat("time",this._time)},Object.defineProperty(t.prototype,"animate",{get:function(){return this._animate},set:function(e){this._animate=e},enumerable:!1,configurable:!0}),t}(Po),xc="noisePixelShader",Dc=`

uniform float brightness;
uniform float persistence;
uniform float timeScale;

varying vec2 vUV;

vec2 hash22(vec2 p)
{
p=p*mat2(127.1,311.7,269.5,183.3);
p=-1.0+2.0*fract(sin(p)*43758.5453123);
return sin(p*6.283+timeScale);
}
float interpolationNoise(vec2 p)
{
vec2 pi=floor(p);
vec2 pf=p-pi;
vec2 w=pf*pf*(3.-2.*pf);
float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));
float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));
float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));
float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));
float xm1=mix(f00,f10,w.x);
float xm2=mix(f01,f11,w.x);
float ym=mix(xm1,xm2,w.y);
return ym;
}
float perlinNoise2D(float x,float y)
{
float sum=0.0;
float frequency=0.0;
float amplitude=0.0;
for(int i=0; i<OCTAVES; i++)
{
frequency=pow(2.0,float(i));
amplitude=pow(persistence,float(i));
sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;
}
return sum;
}

void main(void)
{
float x=abs(vUV.x);
float y=abs(vUV.y);
float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);
gl_FragColor=vec4(noise,noise,noise,1.0);
}
`;qe.a.ShadersStore[xc]=Dc;var ey={name:xc,shader:Dc},Ic=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){i===void 0&&(i=256),r===void 0&&(r=Kt.a.LastCreatedScene);var s=n.call(this,e,i,"noise",r,o,a)||this;return s.time=0,s.brightness=.2,s.octaves=3,s.persistence=.8,s.animationSpeedFactor=1,s.autoClear=!1,s._updateShaderUniforms(),s}return t.prototype._updateShaderUniforms=function(){var e=this.getScene();!e||(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))},t.prototype._getDefines=function(){return"#define OCTAVES "+(this.octaves|0)},t.prototype.render=function(e){this._updateShaderUniforms(),n.prototype.render.call(this,e)},t.prototype.serialize=function(){var e={};return e.customType="BABYLON.NoiseProceduralTexture",e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e},t.prototype.clone=function(){var e=this.getSize(),i=new t(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,i.brightness=this.brightness,i.octaves=this.octaves,i.persistence=this.persistence,i.animationSpeedFactor=this.animationSpeedFactor,i.time=this.time,i},t.Parse=function(e,i){var r,o=new t(e.name,e.size,i,void 0,e.generateMipMaps);return o.brightness=e.brightness,o.octaves=e.octaves,o.persistence=e.persistence,o.animationSpeedFactor=e.animationSpeedFactor,o.time=(r=e.time)!==null&&r!==void 0?r:0,o},t}(Po);f.a.RegisteredTypes["BABYLON.NoiseProceduralTexture"]=Ic;var Km=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_,b){o===void 0&&(o=5),a===void 0&&(a=0),s===void 0&&(s=!1),c===void 0&&(c=!1),_===void 0&&(_=3),b===void 0&&(b=null);var C=n.call(this,"",e)||this;return C._texture=e.getEngine().createRawCubeTexture(i,r,o,a,s,c,_,b),C}return t.prototype.update=function(e,i,r,o,a){a===void 0&&(a=null),this._texture.getEngine().updateRawCubeTexture(this._texture,e,i,r,o,a)},t.prototype.updateRGBDAsync=function(e,i,r,o){return i===void 0&&(i=null),r===void 0&&(r=.8),o===void 0&&(o=0),t._UpdateRGBDAsync(this._texture,e,i,r,o)},t.prototype.clone=function(){var e=this;return Ee.a.Clone(function(){var i=e.getScene(),r=e._texture,o=new t(i,r._bufferViewArray,r.width,r.format,r.type,r.generateMipMaps,r.invertY,r.samplingMode,r._compression);return r.source===gt.b.CubeRawRGBD&&o.updateRGBDAsync(r._bufferViewArrayArray,r._sphericalPolynomial,r._lodGenerationScale,r._lodGenerationOffset),o},this)},t._UpdateRGBDAsync=function(e,i,r,o,a){return e._source=gt.b.CubeRawRGBD,e._bufferViewArrayArray=i,e._lodGenerationScale=o,e._lodGenerationOffset=a,e._sphericalPolynomial=r,Wr.UploadLevelsAsync(e,i).then(function(){e.isReady=!0})},t}(pn.a),kr=u(527),Qm=u(631),Zm=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_,b,C){c===void 0&&(c=!0),_===void 0&&(_=!1),b===void 0&&(b=Ze.a.TRILINEAR_SAMPLINGMODE),C===void 0&&(C=0);var x=n.call(this,null,s,!c,_)||this;return x.format=a,x._texture=s.getEngine().createRawTexture3D(e,i,r,o,a,c,_,b,null,C),x.is3D=!0,x}return t.prototype.update=function(e){!this._texture||this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)},t}(Ze.a),Jm=function(n){Object(p.d)(t,n);function t(e,i,r,o){var a=n.call(this,e,i,r,o,!0)||this;return a.refractionPlane=new ye.a(0,1,0,1),a.depth=2,a.onBeforeRenderObservable.add(function(){r.clipPlane=a.refractionPlane}),a.onAfterRenderObservable.add(function(){r.clipPlane=null}),a}return t.prototype.clone=function(){var e=this.getScene();if(!e)return this;var i=this.getSize(),r=new t(this.name,i.width,e,this._generateMipMaps);return r.hasAlpha=this.hasAlpha,r.level=this.level,r.refractionPlane=this.refractionPlane.clone(),this.renderList&&(r.renderList=this.renderList.slice(0)),r.depth=this.depth,r},t.prototype.serialize=function(){if(!this.name)return null;var e=n.prototype.serialize.call(this);return e.mirrorPlane=this.refractionPlane.asArray(),e.depth=this.depth,e},t}(Cr.a),ve;(function(n){n[n.Vertex=1]="Vertex",n[n.Fragment=2]="Fragment",n[n.Neutral=4]="Neutral",n[n.VertexAndFragment=3]="VertexAndFragment"})(ve||(ve={}));var ie;(function(n){n[n.Float=1]="Float",n[n.Int=2]="Int",n[n.Vector2=4]="Vector2",n[n.Vector3=8]="Vector3",n[n.Vector4=16]="Vector4",n[n.Color3=32]="Color3",n[n.Color4=64]="Color4",n[n.Matrix=128]="Matrix",n[n.Object=256]="Object",n[n.AutoDetect=1024]="AutoDetect",n[n.BasedOnInput=2048]="BasedOnInput"})(ie||(ie={}));var Ti;(function(n){n[n.Uniform=0]="Uniform",n[n.Attribute=1]="Attribute",n[n.Varying=2]="Varying",n[n.Undefined=3]="Undefined"})(Ti||(Ti={}));var mt;(function(n){n[n.World=1]="World",n[n.View=2]="View",n[n.Projection=3]="Projection",n[n.ViewProjection=4]="ViewProjection",n[n.WorldView=5]="WorldView",n[n.WorldViewProjection=6]="WorldViewProjection",n[n.CameraPosition=7]="CameraPosition",n[n.FogColor=8]="FogColor",n[n.DeltaTime=9]="DeltaTime"})(mt||(mt={}));var Ki;(function(n){n[n.Material=0]="Material",n[n.PostProcess=1]="PostProcess",n[n.Particle=2]="Particle",n[n.ProceduralTexture=3]="ProceduralTexture"})(Ki||(Ki={}));var _r;(function(n){n[n.Compatible=0]="Compatible",n[n.TypeIncompatible=1]="TypeIncompatible",n[n.TargetIncompatible=2]="TargetIncompatible"})(_r||(_r={}));var Ni;(function(n){n[n.Input=0]="Input",n[n.Output=1]="Output"})(Ni||(Ni={}));var ea=function(){function n(t,e,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=ie.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new g.c,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=ve.VertexAndFragment,this._ownerBlock=e,this.name=t,this._direction=i}return n.AreEquivalentTypes=function(t,e){switch(t){case ie.Vector3:{if(e===ie.Color3)return!0;break}case ie.Vector4:{if(e===ie.Color4)return!0;break}case ie.Color3:{if(e===ie.Vector3)return!0;break}case ie.Color4:{if(e===ie.Vector4)return!0;break}}return!1},Object.defineProperty(n.prototype,"direction",{get:function(){return this._direction},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"associatedVariableName",{get:function(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName},set:function(t){this._associatedVariableName=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"innerType",{get:function(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"type",{get:function(){if(this._type===ie.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}return this._type===ie.BasedOnInput&&this._typeConnectionSource?this._typeConnectionSource.type:this._type},set:function(t){this._type=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==ve.VertexAndFragment?this._target:this._ownerBlock.target===ve.Fragment?ve.Fragment:ve.Vertex},set:function(t){this._target=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnected",{get:function(){return this.connectedPoint!==null||this.hasEndpoints},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedToInputBlock",{get:function(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectInputBlock",{get:function(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectedPoint",{get:function(){return this._connectedPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ownerBlock",{get:function(){return this._ownerBlock},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sourceBlock",{get:function(){return this._connectedPoint?this._connectedPoint.ownerBlock:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectedBlocks",{get:function(){return this._endpoints.length===0?[]:this._endpoints.map(function(t){return t.ownerBlock})},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"endpoints",{get:function(){return this._endpoints},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasEndpoints",{get:function(){return this._endpoints&&this._endpoints.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedInVertexShader",{get:function(){if(this.target===ve.Vertex)return!0;if(!this.hasEndpoints)return!1;for(var t=0,e=this._endpoints;t<e.length;t++){var i=e[t];if(i.ownerBlock.target===ve.Vertex||i.target===ve.Vertex||(i.ownerBlock.target===ve.Neutral||i.ownerBlock.target===ve.VertexAndFragment)&&i.ownerBlock.outputs.some(function(r){return r.isConnectedInVertexShader}))return!0}return!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedInFragmentShader",{get:function(){if(this.target===ve.Fragment)return!0;if(!this.hasEndpoints)return!1;for(var t=0,e=this._endpoints;t<e.length;t++){var i=e[t];if(i.ownerBlock.target===ve.Fragment||(i.ownerBlock.target===ve.Neutral||i.ownerBlock.target===ve.VertexAndFragment)&&i.ownerBlock.outputs.some(function(r){return r.isConnectedInFragmentShader}))return!0}return!1},enumerable:!1,configurable:!0}),n.prototype.createCustomInputBlock=function(){return null},n.prototype.getClassName=function(){return"NodeMaterialConnectionPoint"},n.prototype.canConnectTo=function(t){return this.checkCompatibilityState(t)===_r.Compatible},n.prototype.checkCompatibilityState=function(t){var e=this._ownerBlock;if(e.target===ve.Fragment){var i=t.ownerBlock;if(i.target===ve.Vertex)return _r.TargetIncompatible;for(var r=0,o=i.outputs;r<o.length;r++){var a=o[r];if(a.isConnectedInVertexShader)return _r.TargetIncompatible}}return this.type!==t.type&&t.innerType!==ie.AutoDetect?n.AreEquivalentTypes(this.type,t.type)||t.acceptedConnectionPointTypes&&t.acceptedConnectionPointTypes.indexOf(this.type)!==-1||t._acceptedConnectionPointType&&n.AreEquivalentTypes(t._acceptedConnectionPointType.type,this.type)?_r.Compatible:_r.TypeIncompatible:t.excludedConnectionPointTypes&&t.excludedConnectionPointTypes.indexOf(this.type)!==-1?1:_r.Compatible},n.prototype.connectTo=function(t,e){if(e===void 0&&(e=!1),!e&&!this.canConnectTo(t))throw"Cannot connect these two connectors.";return this._endpoints.push(t),t._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(t),t.onConnectionObservable.notifyObservers(this),this},n.prototype.disconnectFrom=function(t){var e=this._endpoints.indexOf(t);return e===-1?this:(this._endpoints.splice(e,1),t._connectedPoint=null,this._enforceAssociatedVariableName=!1,t._enforceAssociatedVariableName=!1,this)},n.prototype.serialize=function(t){t===void 0&&(t=!0);var e={};return e.name=this.name,e.displayName=this.displayName,t&&this.connectedPoint&&(e.inputName=this.name,e.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,e.targetConnectionName=this.connectedPoint.name,e.isExposedOnFrame=!0,e.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(e.isExposedOnFrame=!0,e.exposedPortPosition=this.exposedPortPosition),e},n.prototype.dispose=function(){this.onConnectionObservable.clear()},n}(),$m=u(761),nt=function(){function n(t,e,i,r){e===void 0&&(e=ve.Vertex),i===void 0&&(i=!1),r===void 0&&(r=!1),this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=e,this._originalTargetIsNeutral=e===ve.Neutral,this._isFinalMerger=i,this._isInput=r,this._name=t,this.uniqueId=$m.a.UniqueId}return Object.defineProperty(n.prototype,"name",{get:function(){return this._name},set:function(t){!this.validateBlockName(t)||(this._name=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isUnique",{get:function(){return this._isUnique},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isFinalMerger",{get:function(){return this._isFinalMerger},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isInput",{get:function(){return this._isInput},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buildId",{get:function(){return this._buildId},set:function(t){this._buildId=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return this._target},set:function(t){(this._target&t)==0&&(this._target=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"inputs",{get:function(){return this._inputs},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"outputs",{get:function(){return this._outputs},enumerable:!1,configurable:!0}),n.prototype.getInputByName=function(t){var e=this._inputs.filter(function(i){return i.name===t});return e.length?e[0]:null},n.prototype.getOutputByName=function(t){var e=this._outputs.filter(function(i){return i.name===t});return e.length?e[0]:null},n.prototype.initialize=function(t){},n.prototype.bind=function(t,e,i,r){},n.prototype._declareOutput=function(t,e){return e._getGLType(t.type)+" "+t.associatedVariableName},n.prototype._writeVariable=function(t){var e=t.connectedPoint;return e?""+t.associatedVariableName:"0."},n.prototype._writeFloat=function(t){var e=t.toString();return e.indexOf(".")===-1&&(e+=".0"),""+e},n.prototype.getClassName=function(){return"NodeMaterialBlock"},n.prototype.registerInput=function(t,e,i,r,o){return i===void 0&&(i=!1),o=o!=null?o:new ea(t,this,Ni.Input),o.type=e,o.isOptional=i,r&&(o.target=r),this._inputs.push(o),this},n.prototype.registerOutput=function(t,e,i,r){return r=r!=null?r:new ea(t,this,Ni.Output),r.type=e,i&&(r.target=i),this._outputs.push(r),this},n.prototype.getFirstAvailableInput=function(t){t===void 0&&(t=null);for(var e=0,i=this._inputs;e<i.length;e++){var r=i[e];if(!r.connectedPoint&&(!t||t.type===r.type||r.type===ie.AutoDetect))return r}return null},n.prototype.getFirstAvailableOutput=function(t){t===void 0&&(t=null);for(var e=0,i=this._outputs;e<i.length;e++){var r=i[e];if(!t||!t.target||t.target===ve.Neutral||(t.target&r.target)!=0)return r}return null},n.prototype.getSiblingOutput=function(t){var e=this._outputs.indexOf(t);return e===-1||e>=this._outputs.length?null:this._outputs[e+1]},n.prototype.connectTo=function(t,e){if(this._outputs.length!==0){for(var i=e&&e.output?this.getOutputByName(e.output):this.getFirstAvailableOutput(t),r=!0;r;){var o=e&&e.input?t.getInputByName(e.input):t.getFirstAvailableInput(i);if(i&&o&&i.canConnectTo(o))i.connectTo(o),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}},n.prototype._buildBlock=function(t){},n.prototype.updateUniformsAndSamples=function(t,e,i,r){},n.prototype.provideFallbacks=function(t,e){},n.prototype.initializeDefines=function(t,e,i,r){r===void 0&&(r=!1)},n.prototype.prepareDefines=function(t,e,i,r,o){r===void 0&&(r=!1)},n.prototype.autoConfigure=function(t){},n.prototype.replaceRepeatableContent=function(t,e,i,r){},n.prototype.isReady=function(t,e,i,r){return r===void 0&&(r=!1),!0},n.prototype._linkConnectionTypes=function(t,e,i){i===void 0&&(i=!1),i?this._inputs[e]._acceptedConnectionPointType=this._inputs[t]:this._inputs[t]._linkedConnectionSource=this._inputs[e],this._inputs[e]._linkedConnectionSource=this._inputs[t]},n.prototype._processBuild=function(t,e,i,r){t.build(e,r);var o=e._vertexState!=null,a=t._buildTarget===ve.Vertex&&t.target!==ve.VertexAndFragment;if(o&&((t.target&t._buildTarget)==0||(t.target&i.target)==0||this.target!==ve.VertexAndFragment&&a)&&(!t.isInput&&e.target!==t._buildTarget||t.isInput&&t.isAttribute&&!t._noContextSwitch)){var s=i.connectedPoint;e._vertexState._emitVaryingFromString("v_"+s.associatedVariableName,e._getGLType(s.type))&&(e._vertexState.compilationString+="v_"+s.associatedVariableName+" = "+s.associatedVariableName+`;\r
`),i.associatedVariableName="v_"+s.associatedVariableName,i._enforceAssociatedVariableName=!0}},n.prototype.validateBlockName=function(t){for(var e=["position","normal","tangent","particle_positionw","uv","uv2","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"],i=0,r=e;i<r.length;i++){var o=r[i];if(t===o)return!1}return!0},n.prototype.build=function(t,e){if(this._buildId===t.sharedData.buildId)return!0;if(!this.isInput)for(var i=0,r=this._outputs;i<r.length;i++){var o=r[i];o.associatedVariableName||(o.associatedVariableName=t._getFreeVariableName(o.name))}for(var a=0,s=this._inputs;a<s.length;a++){var c=s[a];if(!c.connectedPoint){c.isOptional||t.sharedData.checks.notConnectedNonOptionalInputs.push(c);continue}if(!(this.target!==ve.Neutral&&((c.target&this.target)==0||(c.target&t.target)==0))){var _=c.connectedPoint.ownerBlock;_&&_!==this&&this._processBuild(_,t,c,e)}}if(this._buildId===t.sharedData.buildId)return!0;if(t.sharedData.verbose&&console.log((t.target===ve.Vertex?"Vertex shader":"Fragment shader")+": Building "+this.name+" ["+this.getClassName()+"]"),this.isFinalMerger)switch(t.target){case ve.Vertex:t.sharedData.checks.emitVertex=!0;break;case ve.Fragment:t.sharedData.checks.emitFragment=!0;break}!this.isInput&&t.sharedData.emitComments&&(t.compilationString+=`\r
//`+this.name+`\r
`),this._buildBlock(t),this._buildId=t.sharedData.buildId,this._buildTarget=t.target;for(var b=0,C=this._outputs;b<C.length;b++){var o=C[b];if((o.target&t.target)!=0)for(var x=0,V=o.endpoints;x<V.length;x++){var D=V[x],_=D.ownerBlock;_&&(_.target&t.target)!=0&&e.indexOf(_)!==-1&&this._processBuild(_,t,D,e)}}return!1},n.prototype._inputRename=function(t){return t},n.prototype._outputRename=function(t){return t},n.prototype._dumpPropertiesCode=function(){var t=this._codeVariableName;return t+".visibleInInspector = "+this.visibleInInspector+`;\r
 `+t+".visibleOnFrame = "+this.visibleOnFrame+`;\r
`},n.prototype._dumpCode=function(t,e){e.push(this);var i,r=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=r||this.getClassName()+"_"+this.uniqueId,t.indexOf(this._codeVariableName)!==-1){var o=0;do o++,this._codeVariableName=r+o;while(t.indexOf(this._codeVariableName)!==-1)}t.push(this._codeVariableName),i=`\r
// `+this.getClassName()+`\r
`,this.comments&&(i+="// "+this.comments+`\r
`),i+="var "+this._codeVariableName+" = new BABYLON."+this.getClassName()+'("'+this.name+`");\r
`,i+=this._dumpPropertiesCode();for(var a=0,s=this.inputs;a<s.length;a++){var c=s[a];if(!!c.isConnected){var _=c.connectedPoint,b=_.ownerBlock;e.indexOf(b)===-1&&(i+=b._dumpCode(t,e))}}for(var C=0,x=this.outputs;C<x.length;C++){var V=x[C];if(!!V.hasEndpoints)for(var D=0,z=V.endpoints;D<z.length;D++){var q=z[D],b=q.ownerBlock;b&&e.indexOf(b)===-1&&(i+=b._dumpCode(t,e))}}return i},n.prototype._dumpCodeForOutputConnections=function(t){var e="";if(t.indexOf(this)!==-1)return e;t.push(this);for(var i=0,r=this.inputs;i<r.length;i++){var o=r[i];if(!!o.isConnected){var a=o.connectedPoint,s=a.ownerBlock;e+=s._dumpCodeForOutputConnections(t),e+=s._codeVariableName+"."+s._outputRename(a.name)+".connectTo("+this._codeVariableName+"."+this._inputRename(o.name)+`);\r
`}}return e},n.prototype.clone=function(t,e){e===void 0&&(e="");var i=this.serialize(),r=f.a.GetClass(i.customType);if(r){var o=new r;return o._deserialize(i,t,e),o}return null},n.prototype.serialize=function(){var t={};t.customType="BABYLON."+this.getClassName(),t.id=this.uniqueId,t.name=this.name,t.comments=this.comments,t.visibleInInspector=this.visibleInInspector,t.visibleOnFrame=this.visibleOnFrame,t.target=this.target,t.inputs=[],t.outputs=[];for(var e=0,i=this.inputs;e<i.length;e++){var r=i[e];t.inputs.push(r.serialize())}for(var o=0,a=this.outputs;o<a.length;o++){var s=a[o];t.outputs.push(s.serialize(!1))}return t},n.prototype._deserialize=function(t,e,i){var r;this.name=t.name,this.comments=t.comments,this.visibleInInspector=!!t.visibleInInspector,this.visibleOnFrame=!!t.visibleOnFrame,this._target=(r=t.target)!==null&&r!==void 0?r:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(t)},n.prototype._deserializePortDisplayNamesAndExposedOnFrame=function(t){var e=this,i=t.inputs,r=t.outputs;i&&i.forEach(function(o,a){o.displayName&&(e.inputs[a].displayName=o.displayName),o.isExposedOnFrame&&(e.inputs[a].isExposedOnFrame=o.isExposedOnFrame,e.inputs[a].exposedPortPosition=o.exposedPortPosition)}),r&&r.forEach(function(o,a){o.displayName&&(e.outputs[a].displayName=o.displayName),o.isExposedOnFrame&&(e.outputs[a].isExposedOnFrame=o.isExposedOnFrame,e.outputs[a].exposedPortPosition=o.exposedPortPosition)})},n.prototype.dispose=function(){for(var t=0,e=this.inputs;t<e.length;t++){var i=e[t];i.dispose()}for(var r=0,o=this.outputs;r<o.length;r++){var a=o[r];a.dispose()}},n}(),Lc=function(){function n(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}return n.prototype.finalize=function(t){var e=t.sharedData.emitComments,i=this.target===ve.Fragment;this.compilationString=`\r
`+(e?`//Entry point\r
`:"")+`void main(void) {\r
`+this.compilationString,this._constantDeclaration&&(this.compilationString=`\r
`+(e?`//Constants\r
`:"")+this._constantDeclaration+`\r
`+this.compilationString);var r="";for(var o in this.functions)r+=this.functions[o]+`\r
`;this.compilationString=`\r
`+r+`\r
`+this.compilationString,!i&&this._varyingTransfer&&(this.compilationString=this.compilationString+`\r
`+this._varyingTransfer),this._injectAtEnd&&(this.compilationString=this.compilationString+`\r
`+this._injectAtEnd),this.compilationString=this.compilationString+`\r
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r
`+(e?`//Varyings\r
`:"")+this.sharedData.varyingDeclaration+`\r
`+this.compilationString),this._samplerDeclaration&&(this.compilationString=`\r
`+(e?`//Samplers\r
`:"")+this._samplerDeclaration+`\r
`+this.compilationString),this._uniformDeclaration&&(this.compilationString=`\r
`+(e?`//Uniforms\r
`:"")+this._uniformDeclaration+`\r
`+this.compilationString),this._attributeDeclaration&&!i&&(this.compilationString=`\r
`+(e?`//Attributes\r
`:"")+this._attributeDeclaration+`\r
`+this.compilationString),this.compilationString=`precision highp float;\r
`+this.compilationString;for(var a in this.extensions){var s=this.extensions[a];this.compilationString=`\r
`+s+`\r
`+this.compilationString}this._builtCompilationString=this.compilationString},Object.defineProperty(n.prototype,"_repeatableContentAnchor",{get:function(){return"###___ANCHOR"+this._repeatableContentAnchorIndex+++"___###"},enumerable:!1,configurable:!0}),n.prototype._getFreeVariableName=function(t){return t=t.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[t]===void 0?(this.sharedData.variableNames[t]=0,t==="output"||t==="texture"?t+this.sharedData.variableNames[t]:t):(this.sharedData.variableNames[t]++,t+this.sharedData.variableNames[t])},n.prototype._getFreeDefineName=function(t){return this.sharedData.defineNames[t]===void 0?this.sharedData.defineNames[t]=0:this.sharedData.defineNames[t]++,t+this.sharedData.defineNames[t]},n.prototype._excludeVariableName=function(t){this.sharedData.variableNames[t]=0},n.prototype._emit2DSampler=function(t){this.samplers.indexOf(t)<0&&(this._samplerDeclaration+="uniform sampler2D "+t+`;\r
`,this.samplers.push(t))},n.prototype._getGLType=function(t){switch(t){case ie.Float:return"float";case ie.Int:return"int";case ie.Vector2:return"vec2";case ie.Color3:case ie.Vector3:return"vec3";case ie.Color4:case ie.Vector4:return"vec4";case ie.Matrix:return"mat4"}return""},n.prototype._emitExtension=function(t,e,i){i===void 0&&(i=""),!this.extensions[t]&&(i&&(e="#if "+i+`\r
`+e+`\r
#endif`),this.extensions[t]=e)},n.prototype._emitFunction=function(t,e,i){this.functions[t]||(this.sharedData.emitComments&&(e=i+`\r
`+e),this.functions[t]=e)},n.prototype._emitCodeFromInclude=function(t,e,i){if(i&&i.repeatKey)return"#include<"+t+">[0.."+i.repeatKey+`]\r
`;var r=qe.a.IncludesShadersStore[t]+`\r
`;if(this.sharedData.emitComments&&(r=e+`\r
`+r),!i)return r;if(i.replaceStrings)for(var o=0;o<i.replaceStrings.length;o++){var a=i.replaceStrings[o];r=r.replace(a.search,a.replace)}return r},n.prototype._emitFunctionFromInclude=function(t,e,i,r){r===void 0&&(r="");var o=t+r;if(!this.functions[o]){if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[o]="#include<"+t+">[0.."+i.repeatKey+`]\r
`:this.functions[o]="#include<"+t+`>\r
`,this.sharedData.emitComments&&(this.functions[o]=e+`\r
`+this.functions[o]);return}if(this.functions[o]=qe.a.IncludesShadersStore[t],this.sharedData.emitComments&&(this.functions[o]=e+`\r
`+this.functions[o]),i.removeIfDef&&(this.functions[o]=this.functions[o].replace(/^\s*?#ifdef.+$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#endif.*$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#else.*$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[o]=this.functions[o].replace(/^\s*?attribute.+$/gm,"")),i.removeUniforms&&(this.functions[o]=this.functions[o].replace(/^\s*?uniform.+$/gm,"")),i.removeVaryings&&(this.functions[o]=this.functions[o].replace(/^\s*?varying.+$/gm,"")),i.replaceStrings)for(var a=0;a<i.replaceStrings.length;a++){var s=i.replaceStrings[a];this.functions[o]=this.functions[o].replace(s.search,s.replace)}}},n.prototype._registerTempVariable=function(t){return this.sharedData.temps.indexOf(t)!==-1?!1:(this.sharedData.temps.push(t),!0)},n.prototype._emitVaryingFromString=function(t,e,i,r){return i===void 0&&(i=""),r===void 0&&(r=!1),this.sharedData.varyings.indexOf(t)!==-1?!1:(this.sharedData.varyings.push(t),i&&(Ar.a.StartsWith(i,"defined(")?this.sharedData.varyingDeclaration+="#if "+i+`\r
`:this.sharedData.varyingDeclaration+=(r?"#ifndef":"#ifdef")+" "+i+`\r
`),this.sharedData.varyingDeclaration+="varying "+e+" "+t+`;\r
`,i&&(this.sharedData.varyingDeclaration+=`#endif\r
`),!0)},n.prototype._emitUniformFromString=function(t,e,i,r){i===void 0&&(i=""),r===void 0&&(r=!1),this.uniforms.indexOf(t)===-1&&(this.uniforms.push(t),i&&(Ar.a.StartsWith(i,"defined(")?this._uniformDeclaration+="#if "+i+`\r
`:this._uniformDeclaration+=(r?"#ifndef":"#ifdef")+" "+i+`\r
`),this._uniformDeclaration+="uniform "+e+" "+t+`;\r
`,i&&(this._uniformDeclaration+=`#endif\r
`))},n.prototype._emitFloat=function(t){return t.toString()===t.toFixed(0)?t+".0":t.toString()},n}(),qm=function(){function n(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}return n.prototype.emitErrors=function(){var t="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(t+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r
`),this.checks.emitFragment||(t+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r
`);for(var e=0,i=this.checks.notConnectedNonOptionalInputs;e<i.length;e++){var r=i[e];t+="input "+r.name+" from block "+r.ownerBlock.name+"["+r.ownerBlock.getClassName()+`] is not connected and is not optional.\r
`}if(t)throw`Build of NodeMaterial failed:\r
`+t},n}(),ta=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Vertex)||this;return i.complementW=1,i.complementZ=0,i.registerInput("vector",ie.AutoDetect),i.registerInput("transform",ie.Matrix),i.registerOutput("output",ie.Vector4),i.registerOutput("xyz",ie.Vector3),i._inputs[0].onConnectionObservable.add(function(r){if(r.ownerBlock.isInput){var o=r.ownerBlock;(o.name==="normal"||o.name==="tangent")&&(i.complementW=0)}}),i}return t.prototype.getClassName=function(){return"TransformBlock"},Object.defineProperty(t.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyz",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"transform",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.vector,r=this.transform;if(i.connectedPoint){if(this.complementW===0){var o="//"+this.name;e._emitFunctionFromInclude("helperFunctions",o),e.sharedData.blocksWithDefines.push(this);var a=e._getFreeVariableName(r.associatedVariableName+"_NUS");switch(e.compilationString+="mat3 "+a+" = mat3("+r.associatedVariableName+`);\r
`,e.compilationString+=`#ifdef NONUNIFORMSCALING\r
`,e.compilationString+=a+" = transposeMat3(inverseMat3("+a+`));\r
`,e.compilationString+=`#endif\r
`,i.connectedPoint.type){case ie.Vector2:e.compilationString+=this._declareOutput(this.output,e)+(" = vec4("+a+" * vec3("+i.associatedVariableName+", "+this._writeFloat(this.complementZ)+"), "+this._writeFloat(this.complementW)+`);\r
`);break;case ie.Vector3:case ie.Color3:e.compilationString+=this._declareOutput(this.output,e)+(" = vec4("+a+" * "+i.associatedVariableName+", "+this._writeFloat(this.complementW)+`);\r
`);break;default:e.compilationString+=this._declareOutput(this.output,e)+(" = vec4("+a+" * "+i.associatedVariableName+".xyz, "+this._writeFloat(this.complementW)+`);\r
`);break}}else{var a=r.associatedVariableName;switch(i.connectedPoint.type){case ie.Vector2:e.compilationString+=this._declareOutput(this.output,e)+(" = "+a+" * vec4("+i.associatedVariableName+", "+this._writeFloat(this.complementZ)+", "+this._writeFloat(this.complementW)+`);\r
`);break;case ie.Vector3:case ie.Color3:e.compilationString+=this._declareOutput(this.output,e)+(" = "+a+" * vec4("+i.associatedVariableName+", "+this._writeFloat(this.complementW)+`);\r
`);break;default:e.compilationString+=this._declareOutput(this.output,e)+(" = "+a+" * "+i.associatedVariableName+`;\r
`);break}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+(" = "+this.output.associatedVariableName+`.xyz;\r
`))}return this},t.prototype.prepareDefines=function(e,i,r,o,a){o===void 0&&(o=!1),e.nonUniformScaling&&r.setValue("NONUNIFORMSCALING",!0)},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.complementZ=this.complementZ,e.complementW=this.complementW,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".complementZ = "+this.complementZ+`;\r
`;return e+=this._codeVariableName+".complementW = "+this.complementW+`;\r
`,e},t}(nt);f.a.RegisteredTypes["BABYLON.TransformBlock"]=ta;var Co=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Vertex,!0)||this;return i.registerInput("vector",ie.Vector4),i}return t.prototype.getClassName=function(){return"VertexOutputBlock"},Object.defineProperty(t.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.vector;return e.compilationString+="gl_Position = "+i.associatedVariableName+`;\r
`,this},t}(nt);f.a.RegisteredTypes["BABYLON.VertexOutputBlock"]=Co;var Dt;(function(n){n[n.Boolean=0]="Boolean",n[n.Float=1]="Float",n[n.Vector2=2]="Vector2",n[n.List=3]="List"})(Dt||(Dt={}));function Lt(n,t,e,i){return t===void 0&&(t=Dt.Boolean),e===void 0&&(e="PROPERTIES"),function(r,o){var a=r._propStore;a||(a=[],r._propStore=a),a.push({propertyName:o,displayName:n,type:t,groupName:e,options:i!=null?i:{}})}}var On=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment,!0)||this;return i.convertToGammaSpace=!1,i.convertToLinearSpace=!1,i.registerInput("rgba",ie.Color4,!0),i.registerInput("rgb",ie.Color3,!0),i.registerInput("a",ie.Float,!0),i.rgb.acceptedConnectionPointTypes.push(ie.Float),i}return t.prototype.getClassName=function(){return"FragmentOutputBlock"},Object.defineProperty(t.prototype,"rgba",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),t.prototype.prepareDefines=function(e,i,r){r.setValue(this._linearDefineName,this.convertToLinearSpace,!0),r.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.rgba,r=this.rgb,o=this.a;e.sharedData.hints.needAlphaBlending=i.isConnected||o.isConnected,e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");var a="//"+this.name;if(e._emitFunctionFromInclude("helperFunctions",a),i.connectedPoint)o.isConnected?e.compilationString+="gl_FragColor = vec4("+i.associatedVariableName+".rgb, "+o.associatedVariableName+`);\r
`:e.compilationString+="gl_FragColor = "+i.associatedVariableName+`;\r
`;else if(r.connectedPoint){var s="1.0";o.connectedPoint&&(s=o.associatedVariableName),r.connectedPoint.type===ie.Float?e.compilationString+="gl_FragColor = vec4("+r.associatedVariableName+", "+r.associatedVariableName+", "+r.associatedVariableName+", "+s+`);\r
`:e.compilationString+="gl_FragColor = vec4("+r.associatedVariableName+", "+s+`);\r
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(i);return e.compilationString+="#ifdef "+this._linearDefineName+`\r
`,e.compilationString+=`gl_FragColor = toLinearSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef "+this._gammaDefineName+`\r
`,e.compilationString+=`gl_FragColor = toGammaSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,this},t.prototype._dumpPropertiesCode=function(){var e="";return e+=this._codeVariableName+".convertToGammaSpace = "+this.convertToGammaSpace+`;\r
`,e+=this._codeVariableName+".convertToLinearSpace = "+this.convertToLinearSpace+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace},Object(p.c)([Lt("Convert to gamma space",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],t.prototype,"convertToGammaSpace",void 0),Object(p.c)([Lt("Convert to linear space",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],t.prototype,"convertToLinearSpace",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.FragmentOutputBlock"]=On;var on;(function(n){n[n.None=0]="None",n[n.Time=1]="Time"})(on||(on={}));var eg={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Ds={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},Fc={particle_texturemask:!0},bt=function(n){Object(p.d)(t,n);function t(e,i,r){i===void 0&&(i=ve.Vertex),r===void 0&&(r=ie.AutoDetect);var o=n.call(this,e,i,!1,!0)||this;return o._mode=Ti.Undefined,o._animationType=on.None,o.min=0,o.max=0,o.isBoolean=!1,o.matrixMode=0,o._systemValue=null,o.isConstant=!1,o.groupInInspector="",o.onValueChangedObservable=new g.c,o.convertToGammaSpace=!1,o.convertToLinearSpace=!1,o._type=r,o.setDefaultValue(),o.registerOutput("output",r),o}return Object.defineProperty(t.prototype,"type",{get:function(){if(this._type===ie.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=ie.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=ie.Vector2,this._type;case"Vector3":return this._type=ie.Vector3,this._type;case"Vector4":return this._type=ie.Vector4,this._type;case"Color3":return this._type=ie.Color3,this._type;case"Color4":return this._type=ie.Color4,this._type;case"Matrix":return this._type=ie.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"tangent":case"particle_positionw":return this._type=ie.Vector3,this._type;case"uv":case"uv2":case"position2d":case"particle_uv":return this._type=ie.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"world0":case"world1":case"world2":case"world3":return this._type=ie.Vector4,this._type;case"color":case"particle_color":case"particle_texturemask":return this._type=ie.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case mt.World:case mt.WorldView:case mt.WorldViewProjection:case mt.View:case mt.ViewProjection:case mt.Projection:return this._type=ie.Matrix,this._type;case mt.CameraPosition:return this._type=ie.Vector3,this._type;case mt.FogColor:return this._type=ie.Color3,this._type;case mt.DeltaTime:return this._type=ie.Float,this._type}}return this._type},enumerable:!1,configurable:!0}),t.prototype.validateBlockName=function(e){return this.isAttribute?!0:n.prototype.validateBlockName.call(this,e)},Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.setAsAttribute=function(e){return this._mode=Ti.Attribute,e&&(this.name=e),this},t.prototype.setAsSystemValue=function(e){return this.systemValue=e,this},Object.defineProperty(t.prototype,"value",{get:function(){return this._storedValue},set:function(e){this.type===ie.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=Ti.Uniform,this.onValueChangedObservable.notifyObservers(this)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"valueCallback",{get:function(){return this._valueCallback},set:function(e){this._valueCallback=e,this._mode=Ti.Uniform},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"associatedVariableName",{get:function(){return this._associatedVariableName},set:function(e){this._associatedVariableName=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"animationType",{get:function(){return this._animationType},set:function(e){this._animationType=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isUndefined",{get:function(){return this._mode===Ti.Undefined},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isUniform",{get:function(){return this._mode===Ti.Uniform},set:function(e){this._mode=e?Ti.Uniform:Ti.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isAttribute",{get:function(){return this._mode===Ti.Attribute},set:function(e){this._mode=e?Ti.Attribute:Ti.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isVarying",{get:function(){return this._mode===Ti.Varying},set:function(e){this._mode=e?Ti.Varying:Ti.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isSystemValue",{get:function(){return this._systemValue!=null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"systemValue",{get:function(){return this._systemValue},set:function(e){this._mode=Ti.Uniform,this.associatedVariableName="",this._systemValue=e},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"InputBlock"},t.prototype.animate=function(e){switch(this._animationType){case on.Time:{this.type===ie.Float&&(this.value+=e.getAnimationRatio()*.01);break}}},t.prototype._emitDefine=function(e){return e[0]==="!"?"#ifndef "+e.substring(1)+`\r
`:"#ifdef "+e+`\r
`},t.prototype.initialize=function(e){this.associatedVariableName=""},t.prototype.setDefaultValue=function(){switch(this.type){case ie.Float:this.value=0;break;case ie.Vector2:this.value=l.d.Zero();break;case ie.Vector3:this.value=l.e.Zero();break;case ie.Vector4:this.value=l.f.Zero();break;case ie.Color3:this.value=tt.e.White();break;case ie.Color4:this.value=new tt.f(1,1,1,1);break;case ie.Matrix:this.value=l.a.Identity();break}},t.prototype._emitConstant=function(e){switch(this.type){case ie.Float:return""+e._emitFloat(this.value);case ie.Vector2:return"vec2("+this.value.x+", "+this.value.y+")";case ie.Vector3:return"vec3("+this.value.x+", "+this.value.y+", "+this.value.z+")";case ie.Vector4:return"vec4("+this.value.x+", "+this.value.y+", "+this.value.z+", "+this.value.w+")";case ie.Color3:return tt.u.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&tt.u.Color3[0].toGammaSpaceToRef(tt.u.Color3[0]),this.convertToLinearSpace&&tt.u.Color3[0].toLinearSpaceToRef(tt.u.Color3[0]),"vec3("+tt.u.Color3[0].r+", "+tt.u.Color3[0].g+", "+tt.u.Color3[0].b+")";case ie.Color4:return tt.u.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&tt.u.Color4[0].toGammaSpaceToRef(tt.u.Color4[0]),this.convertToLinearSpace&&tt.u.Color4[0].toLinearSpaceToRef(tt.u.Color4[0]),"vec4("+tt.u.Color4[0].r+", "+tt.u.Color4[0].g+", "+tt.u.Color4[0].b+", "+tt.u.Color4[0].a+")"}return""},Object.defineProperty(t.prototype,"_noContextSwitch",{get:function(){return Ds[this.name]},enumerable:!1,configurable:!0}),t.prototype._emit=function(e,i){var r;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=this._declareOutput(this.output,e)+(" = "+this._emitConstant(e)+`;\r
`);return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),i&&(e._uniformDeclaration+=this._emitDefine(i)),e._uniformDeclaration+="uniform "+e._getGLType(this.type)+" "+this.associatedVariableName+`;\r
`,i&&(e._uniformDeclaration+=`#endif\r
`);var o=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case mt.WorldView:o.needWorldViewMatrix=!0;break;case mt.WorldViewProjection:o.needWorldViewProjectionMatrix=!0;break}else this._animationType!==on.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=(r=eg[this.name])!==null&&r!==void 0?r:this.name,this.target===ve.Vertex&&e._vertexState){Ds[this.name]?Fc[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),i):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),i):this._emit(e._vertexState,i);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),Ds[this.name]?Fc[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),i):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),i):(i&&(e._attributeDeclaration+=this._emitDefine(i)),e._attributeDeclaration+="attribute "+e._getGLType(this.type)+" "+this.associatedVariableName+`;\r
`,i&&(e._attributeDeclaration+=`#endif\r
`))}},t.prototype._transmitWorld=function(e,i,r,o){if(!!this._systemValue){var a=this.associatedVariableName;switch(this._systemValue){case mt.World:e.setMatrix(a,i);break;case mt.WorldView:e.setMatrix(a,r);break;case mt.WorldViewProjection:e.setMatrix(a,o);break}}},t.prototype._transmit=function(e,i){if(!this.isAttribute){var r=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case mt.World:case mt.WorldView:case mt.WorldViewProjection:return;case mt.View:e.setMatrix(r,i.getViewMatrix());break;case mt.Projection:e.setMatrix(r,i.getProjectionMatrix());break;case mt.ViewProjection:e.setMatrix(r,i.getTransformMatrix());break;case mt.CameraPosition:xt.a.BindEyePosition(e,i,r,!0);break;case mt.FogColor:e.setColor3(r,i.fogColor);break;case mt.DeltaTime:e.setFloat(r,i.deltaTime/1e3)}return}var o=this._valueCallback?this._valueCallback():this._storedValue;if(o!==null)switch(this.type){case ie.Float:e.setFloat(r,o);break;case ie.Int:e.setInt(r,o);break;case ie.Color3:tt.u.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&tt.u.Color3[0].toGammaSpaceToRef(tt.u.Color3[0]),this.convertToLinearSpace&&tt.u.Color3[0].toLinearSpaceToRef(tt.u.Color3[0]),e.setColor3(r,tt.u.Color3[0]);break;case ie.Color4:tt.u.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&tt.u.Color4[0].toGammaSpaceToRef(tt.u.Color4[0]),this.convertToLinearSpace&&tt.u.Color4[0].toLinearSpaceToRef(tt.u.Color4[0]),e.setDirectColor4(r,tt.u.Color4[0]);break;case ie.Vector2:e.setVector2(r,o);break;case ie.Vector3:e.setVector3(r,o);break;case ie.Vector4:e.setVector4(r,o);break;case ie.Matrix:e.setMatrix(r,o);break}}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName;if(this.isAttribute)return e+'.setAsAttribute("'+this.name+`");\r
`;if(this.isSystemValue)return e+".setAsSystemValue(BABYLON.NodeMaterialSystemValues."+mt[this._systemValue]+`);\r
`;if(this.isUniform){var i=[],r="";switch(this.type){case ie.Float:r=""+this.value;break;case ie.Vector2:r="new BABYLON.Vector2("+this.value.x+", "+this.value.y+")";break;case ie.Vector3:r="new BABYLON.Vector3("+this.value.x+", "+this.value.y+", "+this.value.z+")";break;case ie.Vector4:r="new BABYLON.Vector4("+this.value.x+", "+this.value.y+", "+this.value.z+", "+this.value.w+")";break;case ie.Color3:r="new BABYLON.Color3("+this.value.r+", "+this.value.g+", "+this.value.b+")",this.convertToGammaSpace&&(r+=".toGammaSpace()"),this.convertToLinearSpace&&(r+=".toLinearSpace()");break;case ie.Color4:r="new BABYLON.Color4("+this.value.r+", "+this.value.g+", "+this.value.b+", "+this.value.a+")",this.convertToGammaSpace&&(r+=".toGammaSpace()"),this.convertToLinearSpace&&(r+=".toLinearSpace()");break;case ie.Matrix:r="BABYLON.Matrix.FromArray(["+this.value.m+"])";break}return i.push(e+".value = "+r),this.type===ie.Float&&i.push(e+".min = "+this.min,e+".max = "+this.max,e+".isBoolean = "+this.isBoolean,e+".matrixMode = "+this.matrixMode,e+".animationType = BABYLON.AnimatedInputBlockTypes."+on[this.animationType]),i.push(e+".isConstant = "+this.isConstant),i.push(""),i.join(`;\r
`)}return""},t.prototype.dispose=function(){this.onValueChangedObservable.clear(),n.prototype.dispose.call(this)},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===Ti.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e},t.prototype._deserialize=function(e,i,r){if(this._mode=e.mode,n.prototype._deserialize.call(this,e,i,r),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{var o=f.a.GetClass(e.valueType);o&&(this._storedValue=o.FromArray(e.value))}},t}(nt);f.a.RegisteredTypes["BABYLON.InputBlock"]=bt;var Is=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.VertexAndFragment)||this;return i._samplerName="textureSampler",i.convertToGammaSpace=!1,i.convertToLinearSpace=!1,i._isUnique=!1,i.registerInput("uv",ie.Vector2,!1,ve.VertexAndFragment),i.registerOutput("rgba",ie.Color4,ve.Neutral),i.registerOutput("rgb",ie.Color3,ve.Neutral),i.registerOutput("r",ie.Float,ve.Neutral),i.registerOutput("g",ie.Float,ve.Neutral),i.registerOutput("b",ie.Float,ve.Neutral),i.registerOutput("a",ie.Float,ve.Neutral),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),i._inputs[0]._prioritizeVertex=!1,i}return t.prototype.getClassName=function(){return"CurrentScreenBlock"},Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("textureSampler")},Object.defineProperty(t.prototype,"target",{get:function(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?ve.VertexAndFragment:ve.Fragment},enumerable:!1,configurable:!0}),t.prototype.prepareDefines=function(e,i,r){r.setValue(this._linearDefineName,this.convertToGammaSpace,!0),r.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)},t.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},t.prototype._injectVertexCode=function(e){var i=this.uv;if(i.connectedPoint.ownerBlock.isInput){var r=i.connectedPoint.ownerBlock;r.isAttribute||e._emitUniformFromString(i.associatedVariableName,"vec2")}if(this._mainUVName="vMain"+i.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=this._mainUVName+" = "+i.associatedVariableName+`.xy;\r
`,!!this._outputs.some(function(c){return c.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&this._writeOutput(e,s,s.name,!0)}}},t.prototype._writeTextureRead=function(e,i){i===void 0&&(i=!1);var r=this.uv;if(i){if(e.target===ve.Fragment)return;e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+r.associatedVariableName+`);\r
`;return}if(this.uv.ownerBlock.target===ve.Fragment){e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+r.associatedVariableName+`);\r
`;return}e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+this._mainUVName+`);\r
`},t.prototype._writeOutput=function(e,i,r,o){if(o===void 0&&(o=!1),o){if(e.target===ve.Fragment)return;e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`;return}if(this.uv.ownerBlock.target===ve.Fragment){e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`;return}e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`,e.compilationString+="#ifdef "+this._linearDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toGammaSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef "+this._gammaDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toLinearSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==ve.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!!this._outputs.some(function(s){return s.isConnectedInFragmentShader})){e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");var i="//"+this.name;e._emitFunctionFromInclude("helperFunctions",i),this._writeTextureRead(e);for(var r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&this._writeOutput(e,a,a.name)}return this}},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(r=e.texture.url.indexOf("data:")===0?"":r,this.texture=Ze.a.Parse(e.texture,i,r))},t}(nt);f.a.RegisteredTypes["BABYLON.CurrentScreenBlock"]=Is;var Ls=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i._samplerName="diffuseSampler",i.convertToGammaSpace=!1,i.convertToLinearSpace=!1,i._isUnique=!1,i.registerInput("uv",ie.Vector2,!1,ve.VertexAndFragment),i.registerOutput("rgba",ie.Color4,ve.Neutral),i.registerOutput("rgb",ie.Color3,ve.Neutral),i.registerOutput("r",ie.Float,ve.Neutral),i.registerOutput("g",ie.Float,ve.Neutral),i.registerOutput("b",ie.Float,ve.Neutral),i.registerOutput("a",ie.Float,ve.Neutral),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),i}return t.prototype.getClassName=function(){return"ParticleTextureBlock"},Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("diffuseSampler")},t.prototype.autoConfigure=function(e){if(!this.uv.isConnected){var i=e.getInputBlockByPredicate(function(r){return r.isAttribute&&r.name==="particle_uv"});i||(i=new bt("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}},t.prototype.prepareDefines=function(e,i,r){r.setValue(this._linearDefineName,this.convertToGammaSpace,!0),r.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)},t.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},t.prototype._writeOutput=function(e,i,r){e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`,e.compilationString+="#ifdef "+this._linearDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toGammaSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef "+this._gammaDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toLinearSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==ve.Vertex){this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");var i="//"+this.name;e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+this.uv.associatedVariableName+`);\r
`;for(var r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&this._writeOutput(e,a,a.name)}return this}},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(r=e.texture.url.indexOf("data:")===0?"":r,this.texture=Ze.a.Parse(e.texture,i,r))},t}(nt);f.a.RegisteredTypes["BABYLON.ParticleTextureBlock"]=Ls;var Fs=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i._isUnique=!0,i.registerInput("color",ie.Color4,!1,ve.Fragment),i.registerOutput("rampColor",ie.Color4,ve.Fragment),i}return t.prototype.getClassName=function(){return"ParticleRampGradientBlock"},Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rampColor",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==ve.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                vec4 baseColor = `+this.color.associatedVariableName+`;
                float alpha = `+this.color.associatedVariableName+`.a;

                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));
                baseColor.rgb *= rampColor.rgb;

                // Remapped alpha
                float finalAlpha = baseColor.a;
                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);

                `+this._declareOutput(this.rampColor,e)+` = baseColor;
            #else
                `+this._declareOutput(this.rampColor,e)+" = "+this.color.associatedVariableName+`;
            #endif
        `,this},t}(nt);f.a.RegisteredTypes["BABYLON.ParticleRampGradientBlock"]=Fs;var Bs=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i._isUnique=!0,i.registerInput("color",ie.Color4,!1,ve.Fragment),i.registerInput("alphaTexture",ie.Float,!1,ve.Fragment),i.registerInput("alphaColor",ie.Float,!1,ve.Fragment),i.registerOutput("blendColor",ie.Color4,ve.Fragment),i}return t.prototype.getClassName=function(){return"ParticleBlendMultiplyBlock"},Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"alphaTexture",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"alphaColor",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blendColor",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("sourceAlpha")},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==ve.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                `+this._declareOutput(this.blendColor,e)+`;
                float sourceAlpha = `+this.alphaColor.associatedVariableName+" * "+this.alphaTexture.associatedVariableName+`;
                `+this.blendColor.associatedVariableName+".rgb = "+this.color.associatedVariableName+`.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);
                `+this.blendColor.associatedVariableName+".a = "+this.color.associatedVariableName+`.a;
            #else
                `+this._declareOutput(this.blendColor,e)+" = "+this.color.associatedVariableName+`;
            #endif
        `,this},t}(nt);f.a.RegisteredTypes["BABYLON.ParticleBlendMultiplyBlock"]=Bs;var So=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("xyz ",ie.Vector3,!0),i.registerInput("xy ",ie.Vector2,!0),i.registerInput("x",ie.Float,!0),i.registerInput("y",ie.Float,!0),i.registerInput("z",ie.Float,!0),i.registerInput("w",ie.Float,!0),i.registerOutput("xyzw",ie.Vector4),i.registerOutput("xyz",ie.Vector3),i.registerOutput("xy",ie.Vector2),i}return t.prototype.getClassName=function(){return"VectorMergerBlock"},Object.defineProperty(t.prototype,"xyzIn",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"w",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzw",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyOut",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xy",{get:function(){return this.xyOut},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyz",{get:function(){return this.xyzOut},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.x,r=this.y,o=this.z,a=this.w,s=this.xyIn,c=this.xyzIn,_=this._outputs[0],b=this._outputs[1],C=this._outputs[2];return c.isConnected?_.hasEndpoints?e.compilationString+=this._declareOutput(_,e)+(" = vec4("+c.associatedVariableName+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):b.hasEndpoints?e.compilationString+=this._declareOutput(b,e)+(" = "+c.associatedVariableName+`;\r
`):C.hasEndpoints&&(e.compilationString+=this._declareOutput(C,e)+(" = "+c.associatedVariableName+`.xy;\r
`)):s.isConnected?_.hasEndpoints?e.compilationString+=this._declareOutput(_,e)+(" = vec4("+s.associatedVariableName+", "+(o.isConnected?this._writeVariable(o):"0.0")+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):b.hasEndpoints?e.compilationString+=this._declareOutput(b,e)+(" = vec3("+s.associatedVariableName+", "+(o.isConnected?this._writeVariable(o):"0.0")+`);\r
`):C.hasEndpoints&&(e.compilationString+=this._declareOutput(C,e)+(" = "+s.associatedVariableName+`;\r
`)):_.hasEndpoints?e.compilationString+=this._declareOutput(_,e)+(" = vec4("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+", "+(o.isConnected?this._writeVariable(o):"0.0")+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):b.hasEndpoints?e.compilationString+=this._declareOutput(b,e)+(" = vec3("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+", "+(o.isConnected?this._writeVariable(o):"0.0")+`);\r
`):C.hasEndpoints&&(e.compilationString+=this._declareOutput(C,e)+(" = vec2("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+`);\r
`)),this},t}(nt);f.a.RegisteredTypes["BABYLON.VectorMergerBlock"]=So;var Ns=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.sourceRange=new l.d(-1,1),i.targetRange=new l.d(0,1),i.registerInput("input",ie.AutoDetect),i.registerInput("sourceMin",ie.Float,!0),i.registerInput("sourceMax",ie.Float,!0),i.registerInput("targetMin",ie.Float,!0),i.registerInput("targetMax",ie.Float,!0),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"RemapBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sourceMin",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sourceMax",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"targetMin",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"targetMax",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),o=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),a=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),s=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(i,e)+(" = "+a+" + ("+this._inputs[0].associatedVariableName+" - "+r+") * ("+s+" - "+a+") / ("+o+" - "+r+`);\r
`),this},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".sourceRange = new BABYLON.Vector2("+this.sourceRange.x+", "+this.sourceRange.y+`);\r
`;return e+=this._codeVariableName+".targetRange = new BABYLON.Vector2("+this.targetRange.x+", "+this.targetRange.y+`);\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.sourceRange=l.d.FromArray(e.sourceRange),this.targetRange=l.d.FromArray(e.targetRange)},Object(p.c)([Lt("From",Dt.Vector2)],t.prototype,"sourceRange",void 0),Object(p.c)([Lt("To",Dt.Vector2)],t.prototype,"targetRange",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.RemapBlock"]=Ns;var ia=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"MultiplyBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.left.associatedVariableName+" * "+this.right.associatedVariableName+`;\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.MultiplyBlock"]=ia;var Mn=function(){function n(){this.direction1=new l.e(0,1,0),this.direction2=new l.e(0,1,0),this.minEmitBox=new l.e(-.5,-.5,-.5),this.maxEmitBox=new l.e(.5,.5,.5)}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);if(r){e.x=o,e.y=a,e.z=s;return}l.e.TransformNormalFromFloatsToRef(o,a,s,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=$e.a.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),a=$e.a.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),s=$e.a.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(r){e.x=o,e.y=a,e.z=s;return}l.e.TransformCoordinatesFromFloatsToRef(o,a,s,t,e)},n.prototype.clone=function(){var t=new n;return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2),t.setVector3("minEmitBox",this.minEmitBox),t.setVector3("maxEmitBox",this.maxEmitBox)},n.prototype.getEffectDefines=function(){return"#define BOXEMITTER"},n.prototype.getClassName=function(){return"BoxParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.minEmitBox=this.minEmitBox.asArray(),t.maxEmitBox=this.maxEmitBox.asArray(),t},n.prototype.parse=function(t){l.e.FromArrayToRef(t.direction1,0,this.direction1),l.e.FromArrayToRef(t.direction2,0,this.direction2),l.e.FromArrayToRef(t.minEmitBox,0,this.minEmitBox),l.e.FromArrayToRef(t.maxEmitBox,0,this.maxEmitBox)},n}(),ws=function(){function n(t,e,i){t===void 0&&(t=1),e===void 0&&(e=Math.PI),i===void 0&&(i=0),this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=e,this.radius=t}return Object.defineProperty(n.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this._buildHeight()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t,this._buildHeight()},enumerable:!1,configurable:!0}),n.prototype._buildHeight=function(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1},n.prototype.startDirectionFunction=function(t,e,i,r){r?l.c.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(t.getTranslation(),l.c.Vector3[0]).normalize();var o=$e.a.RandomRange(0,this.directionRandomizer),a=$e.a.RandomRange(0,this.directionRandomizer),s=$e.a.RandomRange(0,this.directionRandomizer);e.x=l.c.Vector3[0].x+o,e.y=l.c.Vector3[0].y+a,e.z=l.c.Vector3[0].z+s,e.normalize()},n.prototype.startPositionFunction=function(t,e,i,r){var o=$e.a.RandomRange(0,Math.PI*2),a;this.emitFromSpawnPointOnly?a=1e-4:(a=$e.a.RandomRange(0,this.heightRange),a=1-a*a);var s=this._radius-$e.a.RandomRange(0,this._radius*this.radiusRange);s=s*a;var c=s*Math.sin(o),_=s*Math.cos(o),b=a*this._height;if(r){e.x=c,e.y=b,e.z=_;return}l.e.TransformCoordinatesFromFloatsToRef(c,b,_,t,e)},n.prototype.clone=function(){var t=new n(this._radius,this._angle,this.directionRandomizer);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setFloat2("radius",this._radius,this.radiusRange),t.setFloat("coneAngle",this._angle),t.setFloat2("height",this._height,this.heightRange),t.setFloat("directionRandomizer",this.directionRandomizer)},n.prototype.getEffectDefines=function(){var t="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(t+=`
#define CONEEMITTERSPAWNPOINT`),t},n.prototype.getClassName=function(){return"ConeParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this._radius,t.angle=this._angle,t.directionRandomizer=this.directionRandomizer,t.radiusRange=this.radiusRange,t.heightRange=this.heightRange,t.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,t},n.prototype.parse=function(t){this.radius=t.radius,this.angle=t.angle,this.directionRandomizer=t.directionRandomizer,this.radiusRange=t.radiusRange!==void 0?t.radiusRange:1,this.heightRange=t.radiusRange!==void 0?t.heightRange:1,this.emitFromSpawnPointOnly=t.emitFromSpawnPointOnly!==void 0?t.emitFromSpawnPointOnly:!1},n}(),ra=function(){function n(t,e,i,r){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=0),this.radius=t,this.height=e,this.radiusRange=i,this.directionRandomizer=r}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=i.position.subtract(t.getTranslation()).normalize(),a=$e.a.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2),s=Math.atan2(o.x,o.z);if(s+=$e.a.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,o.y=a,o.x=Math.sin(s),o.z=Math.cos(s),o.normalize(),r){e.copyFrom(o);return}l.e.TransformNormalFromFloatsToRef(o.x,o.y,o.z,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=$e.a.RandomRange(-this.height/2,this.height/2),a=$e.a.RandomRange(0,2*Math.PI),s=$e.a.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),c=Math.sqrt(s)*this.radius,_=c*Math.cos(a),b=c*Math.sin(a);if(r){e.copyFromFloats(_,o,b);return}l.e.TransformCoordinatesFromFloatsToRef(_,o,b,t,e)},n.prototype.clone=function(){var t=new n(this.radius,this.directionRandomizer);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},n.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER"},n.prototype.getClassName=function(){return"CylinderParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.height=this.height,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},n.prototype.parse=function(t){this.radius=t.radius,this.height=t.height,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},n}(),Vs=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=1),o===void 0&&(o=new l.e(0,1,0)),a===void 0&&(a=new l.e(0,1,0));var s=n.call(this,e,i,r)||this;return s.direction1=o,s.direction2=a,s}return t.prototype.startDirectionFunction=function(e,i,r){var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);l.e.TransformNormalFromFloatsToRef(o,a,s,e,i)},t.prototype.clone=function(){var e=new t(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return vr.a.DeepCopy(this,e),e},t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},t.prototype.getEffectDefines=function(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`},t.prototype.getClassName=function(){return"CylinderDirectedParticleEmitter"},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},t.prototype.parse=function(e){n.prototype.parse.call(this,e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)},t}(ra),Us=function(){function n(t,e,i){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=0),this.radius=t,this.radiusRange=e,this.directionRandomizer=i}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=i.position.subtract(t.getTranslation()).normalize(),a=$e.a.RandomRange(0,this.directionRandomizer),s=$e.a.RandomRange(0,this.directionRandomizer),c=$e.a.RandomRange(0,this.directionRandomizer);if(o.x+=a,o.y+=s,o.z+=c,o.normalize(),r){e.copyFrom(o);return}l.e.TransformNormalFromFloatsToRef(o.x,o.y,o.z,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=this.radius-$e.a.RandomRange(0,this.radius*this.radiusRange),a=$e.a.RandomRange(0,1),s=$e.a.RandomRange(0,2*Math.PI),c=Math.acos(2*a-1),_=o*Math.cos(s)*Math.sin(c),b=o*Math.cos(c),C=o*Math.sin(s)*Math.sin(c);if(r){e.copyFromFloats(_,Math.abs(b),C);return}l.e.TransformCoordinatesFromFloatsToRef(_,Math.abs(b),C,t,e)},n.prototype.clone=function(){var t=new n(this.radius,this.directionRandomizer);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},n.prototype.getEffectDefines=function(){return"#define HEMISPHERICEMITTER"},n.prototype.getClassName=function(){return"HemisphericParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},n.prototype.parse=function(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},n}(),Gs=function(){function n(){this.direction1=new l.e(0,1,0),this.direction2=new l.e(0,1,0)}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);if(r){e.copyFromFloats(o,a,s);return}l.e.TransformNormalFromFloatsToRef(o,a,s,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){if(r){e.copyFromFloats(0,0,0);return}l.e.TransformCoordinatesFromFloatsToRef(0,0,0,t,e)},n.prototype.clone=function(){var t=new n;return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},n.prototype.getEffectDefines=function(){return"#define POINTEMITTER"},n.prototype.getClassName=function(){return"PointParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},n.prototype.parse=function(t){l.e.FromArrayToRef(t.direction1,0,this.direction1),l.e.FromArrayToRef(t.direction2,0,this.direction2)},n}(),na=function(){function n(t,e,i){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=0),this.radius=t,this.radiusRange=e,this.directionRandomizer=i}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=i.position.subtract(t.getTranslation()).normalize(),a=$e.a.RandomRange(0,this.directionRandomizer),s=$e.a.RandomRange(0,this.directionRandomizer),c=$e.a.RandomRange(0,this.directionRandomizer);if(o.x+=a,o.y+=s,o.z+=c,o.normalize(),r){e.copyFrom(o);return}l.e.TransformNormalFromFloatsToRef(o.x,o.y,o.z,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=this.radius-$e.a.RandomRange(0,this.radius*this.radiusRange),a=$e.a.RandomRange(0,1),s=$e.a.RandomRange(0,2*Math.PI),c=Math.acos(2*a-1),_=o*Math.cos(s)*Math.sin(c),b=o*Math.cos(c),C=o*Math.sin(s)*Math.sin(c);if(r){e.copyFromFloats(_,b,C);return}l.e.TransformCoordinatesFromFloatsToRef(_,b,C,t,e)},n.prototype.clone=function(){var t=new n(this.radius,this.directionRandomizer);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},n.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER"},n.prototype.getClassName=function(){return"SphereParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},n.prototype.parse=function(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},n}(),zs=function(n){Object(p.d)(t,n);function t(e,i,r){e===void 0&&(e=1),i===void 0&&(i=new l.e(0,1,0)),r===void 0&&(r=new l.e(0,1,0));var o=n.call(this,e)||this;return o.direction1=i,o.direction2=r,o}return t.prototype.startDirectionFunction=function(e,i,r){var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);l.e.TransformNormalFromFloatsToRef(o,a,s,e,i)},t.prototype.clone=function(){var e=new t(this.radius,this.direction1,this.direction2);return vr.a.DeepCopy(this,e),e},t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},t.prototype.getEffectDefines=function(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`},t.prototype.getClassName=function(){return"SphereDirectedParticleEmitter"},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},t.prototype.parse=function(e){n.prototype.parse.call(this,e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)},t}(na),xn=function(){function n(){this.particlePositionGenerator=function(){},this.particleDestinationGenerator=function(){}}return n.prototype.startDirectionFunction=function(t,e,i,r){var o=l.c.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,o);var a=l.c.Vector3[1];o.subtractToRef(i.position,a),a.scaleToRef(1/i.lifeTime,o)}else o.set(0,0,0);if(r){e.copyFrom(o);return}l.e.TransformNormalToRef(o,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){var o=l.c.Vector3[0];if(this.particlePositionGenerator?this.particlePositionGenerator(-1,i,o):o.set(0,0,0),r){e.copyFrom(o);return}l.e.TransformCoordinatesToRef(o,t,e)},n.prototype.clone=function(){var t=new n;return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){},n.prototype.getEffectDefines=function(){return"#define CUSTOMEMITTER"},n.prototype.getClassName=function(){return"CustomParticleEmitter"},n.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t},n.prototype.parse=function(t){},n}(),Bc=function(){function n(t){t===void 0&&(t=null),this._indices=null,this._positions=null,this._normals=null,this._storedNormal=l.e.Zero(),this._mesh=null,this.direction1=new l.e(0,1,0),this.direction2=new l.e(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=t}return Object.defineProperty(n.prototype,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh!==t&&(this._mesh=t,t?(this._indices=t.getIndices(),this._positions=t.getVerticesData(Be.b.PositionKind),this._normals=t.getVerticesData(Be.b.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))},enumerable:!1,configurable:!0}),n.prototype.startDirectionFunction=function(t,e,i,r){if(this.useMeshNormalsForDirection&&this._normals){l.e.TransformNormalToRef(this._storedNormal,t,e);return}var o=$e.a.RandomRange(this.direction1.x,this.direction2.x),a=$e.a.RandomRange(this.direction1.y,this.direction2.y),s=$e.a.RandomRange(this.direction1.z,this.direction2.z);if(r){e.copyFromFloats(o,a,s);return}l.e.TransformNormalFromFloatsToRef(o,a,s,t,e)},n.prototype.startPositionFunction=function(t,e,i,r){if(!(!this._indices||!this._positions)){var o=3*Math.random()*(this._indices.length/3)|0,a=Math.random(),s=Math.random()*(1-a),c=1-a-s,_=this._indices[o],b=this._indices[o+1],C=this._indices[o+2],x=l.c.Vector3[0],V=l.c.Vector3[1],D=l.c.Vector3[2],z=l.c.Vector3[3];l.e.FromArrayToRef(this._positions,_*3,x),l.e.FromArrayToRef(this._positions,b*3,V),l.e.FromArrayToRef(this._positions,C*3,D),z.x=a*x.x+s*V.x+c*D.x,z.y=a*x.y+s*V.y+c*D.y,z.z=a*x.z+s*V.z+c*D.z,r?e.copyFromFloats(z.x,z.y,z.z):l.e.TransformCoordinatesFromFloatsToRef(z.x,z.y,z.z,t,e),this.useMeshNormalsForDirection&&this._normals&&(l.e.FromArrayToRef(this._normals,_*3,x),l.e.FromArrayToRef(this._normals,b*3,V),l.e.FromArrayToRef(this._normals,C*3,D),this._storedNormal.x=a*x.x+s*V.x+c*D.x,this._storedNormal.y=a*x.y+s*V.y+c*D.y,this._storedNormal.z=a*x.z+s*V.z+c*D.z)}},n.prototype.clone=function(){var t=new n(this.mesh);return vr.a.DeepCopy(this,t),t},n.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},n.prototype.getEffectDefines=function(){return""},n.prototype.getClassName=function(){return"MeshParticleEmitter"},n.prototype.serialize=function(){var t,e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=(t=this.mesh)===null||t===void 0?void 0:t.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e},n.prototype.parse=function(t,e){l.e.FromArrayToRef(t.direction1,0,this.direction1),l.e.FromArrayToRef(t.direction2,0,this.direction2),t.meshId&&e&&(this.mesh=e.getLastMeshByID(t.meshId)),this.useMeshNormalsForDirection=t.useMeshNormalsForDirection},n}(),To=function(){function n(t){this.animations=[],this.renderingGroupId=0,this.emitter=l.e.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._rootUrl="",this.noiseStrength=new l.e(10,10,10),this.onAnimationEnd=null,this.blendMode=n.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteRandomStartCell=!1,this.translationPivot=new l.d(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new l.e(0,0,0),this.gravity=l.e.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new v.b(1,1,1,1),this.color2=new v.b(1,1,1,1),this.colorDead=new v.b(0,0,0,1),this.textureMask=new v.b(1,1,1,1),this._isSubEmitter=!1,this.billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new gr.b,this.id=t,this.name=t}return Object.defineProperty(n.prototype,"noiseTexture",{get:function(){return this._noiseTexture},set:function(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},set:function(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())},enumerable:!1,configurable:!0}),n.prototype.getScene=function(){return this._scene},n.prototype._hasTargetStopDurationDependantGradient=function(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0},n.prototype.getDragGradients=function(){return this._dragGradients},n.prototype.getLimitVelocityGradients=function(){return this._limitVelocityGradients},n.prototype.getColorGradients=function(){return this._colorGradients},n.prototype.getSizeGradients=function(){return this._sizeGradients},n.prototype.getColorRemapGradients=function(){return this._colorRemapGradients},n.prototype.getAlphaRemapGradients=function(){return this._alphaRemapGradients},n.prototype.getLifeTimeGradients=function(){return this._lifeTimeGradients},n.prototype.getAngularSpeedGradients=function(){return this._angularSpeedGradients},n.prototype.getVelocityGradients=function(){return this._velocityGradients},n.prototype.getStartSizeGradients=function(){return this._startSizeGradients},n.prototype.getEmitRateGradients=function(){return this._emitRateGradients},Object.defineProperty(n.prototype,"direction1",{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:l.e.Zero()},set:function(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"direction2",{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:l.e.Zero()},set:function(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"minEmitBox",{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:l.e.Zero()},set:function(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"maxEmitBox",{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:l.e.Zero()},set:function(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isBillboardBased",{get:function(){return this._isBillboardBased},set:function(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t)},enumerable:!1,configurable:!0}),n.prototype._attachImageProcessingConfiguration=function(t){t!==this._imageProcessingConfiguration&&(!t&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=t)},n.prototype._reset=function(){},n.prototype._removeGradientAndTexture=function(t,e,i){if(!e)return this;for(var r=0,o=0,a=e;o<a.length;o++){var s=a[o];if(s.gradient===t){e.splice(r,1);break}r++}return i&&i.dispose(),this},n.prototype.createPointEmitter=function(t,e){var i=new Gs;return i.direction1=t,i.direction2=e,this.particleEmitterType=i,i},n.prototype.createHemisphericEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=1);var i=new Us(t,e);return this.particleEmitterType=i,i},n.prototype.createSphereEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=1);var i=new na(t,e);return this.particleEmitterType=i,i},n.prototype.createDirectedSphereEmitter=function(t,e,i){t===void 0&&(t=1),e===void 0&&(e=new l.e(0,1,0)),i===void 0&&(i=new l.e(0,1,0));var r=new zs(t,e,i);return this.particleEmitterType=r,r},n.prototype.createCylinderEmitter=function(t,e,i,r){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=0);var o=new ra(t,e,i,r);return this.particleEmitterType=o,o},n.prototype.createDirectedCylinderEmitter=function(t,e,i,r,o){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=new l.e(0,1,0)),o===void 0&&(o=new l.e(0,1,0));var a=new Vs(t,e,i,r,o);return this.particleEmitterType=a,a},n.prototype.createConeEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=Math.PI/4);var i=new ws(t,e);return this.particleEmitterType=i,i},n.prototype.createBoxEmitter=function(t,e,i,r){var o=new Mn;return this.particleEmitterType=o,this.direction1=t,this.direction2=e,this.minEmitBox=i,this.maxEmitBox=r,o},n.BLENDMODE_ONEONE=0,n.BLENDMODE_STANDARD=1,n.BLENDMODE_ADD=2,n.BLENDMODE_MULTIPLY=3,n.BLENDMODE_MULTIPLYADD=4,n}(),js=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("rgba",ie.Color4,!0),i.registerInput("rgb ",ie.Color3,!0),i.registerOutput("rgb",ie.Color3),i.registerOutput("r",ie.Float),i.registerOutput("g",ie.Float),i.registerOutput("b",ie.Float),i.registerOutput("a",ie.Float),i.inputsAreExclusive=!0,i}return t.prototype.getClassName=function(){return"ColorSplitterBlock"},Object.defineProperty(t.prototype,"rgba",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgbIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgbOut",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),t.prototype._inputRename=function(e){return e==="rgb "?"rgbIn":e},t.prototype._outputRename=function(e){return e==="rgb"?"rgbOut":e},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.rgba.isConnected?this.rgba:this.rgbIn;if(!!i.isConnected){var r=this._outputs[0],o=this._outputs[1],a=this._outputs[2],s=this._outputs[3],c=this._outputs[4];return r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+(" = "+i.associatedVariableName+`.rgb;\r
`)),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+(" = "+i.associatedVariableName+`.r;\r
`)),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+(" = "+i.associatedVariableName+`.g;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+(" = "+i.associatedVariableName+`.b;\r
`)),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+(" = "+i.associatedVariableName+`.a;\r
`)),this}},t}(nt);f.a.RegisteredTypes["BABYLON.ColorSplitterBlock"]=js;var Nc=u(760),ni;(function(n){n[n.Cos=0]="Cos",n[n.Sin=1]="Sin",n[n.Abs=2]="Abs",n[n.Exp=3]="Exp",n[n.Exp2=4]="Exp2",n[n.Round=5]="Round",n[n.Floor=6]="Floor",n[n.Ceiling=7]="Ceiling",n[n.Sqrt=8]="Sqrt",n[n.Log=9]="Log",n[n.Tan=10]="Tan",n[n.ArcTan=11]="ArcTan",n[n.ArcCos=12]="ArcCos",n[n.ArcSin=13]="ArcSin",n[n.Fract=14]="Fract",n[n.Sign=15]="Sign",n[n.Radians=16]="Radians",n[n.Degrees=17]="Degrees"})(ni||(ni={}));var Ws=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.operation=ni.Cos,i.registerInput("input",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"TrigonometryBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r="";switch(this.operation){case ni.Cos:{r="cos";break}case ni.Sin:{r="sin";break}case ni.Abs:{r="abs";break}case ni.Exp:{r="exp";break}case ni.Exp2:{r="exp2";break}case ni.Round:{r="round";break}case ni.Floor:{r="floor";break}case ni.Ceiling:{r="ceil";break}case ni.Sqrt:{r="sqrt";break}case ni.Log:{r="log";break}case ni.Tan:{r="tan";break}case ni.ArcTan:{r="atan";break}case ni.ArcCos:{r="acos";break}case ni.ArcSin:{r="asin";break}case ni.Fract:{r="fract";break}case ni.Sign:{r="sign";break}case ni.Radians:{r="radians";break}case ni.Degrees:{r="degrees";break}}return e.compilationString+=this._declareOutput(i,e)+(" = "+r+"("+this.input.associatedVariableName+`);\r
`),this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.operation=this.operation,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.operation=e.operation},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".operation = BABYLON.TrigonometryBlockOperations."+ni[this.operation]+`;\r
`;return e},t}(nt);f.a.RegisteredTypes["BABYLON.TrigonometryBlock"]=Ws;var Hs={effect:null,subMesh:null},Ao=function(n){Object(p.d)(t,n);function t(){var e=n.call(this)||this;return e.NORMAL=!1,e.TANGENT=!1,e.UV1=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.BONETEXTURE=!1,e.MORPHTARGETS=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_UV=!1,e.NUM_MORPH_INFLUENCERS=0,e.MORPHTARGETS_TEXTURE=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.BUMPDIRECTUV=0,e.rebuild(),e}return t.prototype.setValue=function(e,i,r){r===void 0&&(r=!1),this[e]===void 0&&this._keys.push(e),r&&this[e]!==i&&this.markAsUnprocessed(),this[e]=i},t}(ps.a),oa=function(n){Object(p.d)(t,n);function t(e,i,r){r===void 0&&(r={});var o=n.call(this,e,i||G.a.LastCreatedScene)||this;return o._buildId=t._BuildIdGenerator++,o._buildWasSuccessful=!1,o._cachedWorldViewMatrix=new l.a,o._cachedWorldViewProjectionMatrix=new l.a,o._optimizers=new Array,o._animationFrame=-1,o.BJSNODEMATERIALEDITOR=o._getGlobalNodeMaterialEditor(),o.editorData=null,o.ignoreAlpha=!1,o.maxSimultaneousLights=4,o.onBuildObservable=new g.c,o._vertexOutputNodes=new Array,o._fragmentOutputNodes=new Array,o.attachedBlocks=new Array,o._mode=Ki.Material,o._options=Object(p.a)({emitComments:!1},r),o._attachImageProcessingConfiguration(null),o}return t.prototype._getGlobalNodeMaterialEditor=function(){if(typeof NODEEDITOR!="undefined")return NODEEDITOR;if(typeof BABYLON!="undefined"&&typeof BABYLON.NodeEditor!="undefined")return BABYLON},Object.defineProperty(t.prototype,"options",{get:function(){return this._options},set:function(e){this._options=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){return this._mode},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"NodeMaterial"},t.prototype._attachImageProcessingConfiguration=function(e){var i=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){i._markAllSubMeshesAsImageProcessingDirty()})))},t.prototype.getBlockByName=function(e){for(var i=null,r=0,o=this.attachedBlocks;r<o.length;r++){var a=o[r];if(a.name===e)if(!i)i=a;else return re.b.Warn("More than one block was found with the name `"+e+"`"),i}return i},t.prototype.getBlockByPredicate=function(e){for(var i=0,r=this.attachedBlocks;i<r.length;i++){var o=r[i];if(e(o))return o}return null},t.prototype.getInputBlockByPredicate=function(e){for(var i=0,r=this.attachedBlocks;i<r.length;i++){var o=r[i];if(o.isInput&&e(o))return o}return null},t.prototype.getInputBlocks=function(){for(var e=[],i=0,r=this.attachedBlocks;i<r.length;i++){var o=r[i];o.isInput&&e.push(o)}return e},t.prototype.registerOptimizer=function(e){var i=this._optimizers.indexOf(e);if(!(i>-1))return this._optimizers.push(e),this},t.prototype.unregisterOptimizer=function(e){var i=this._optimizers.indexOf(e);if(i!==-1)return this._optimizers.splice(i,1),this},t.prototype.addOutputNode=function(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&ve.Vertex)!=0&&this._addVertexOutputNode(e),(e.target&ve.Fragment)!=0&&this._addFragmentOutputNode(e),this},t.prototype.removeOutputNode=function(e){return e.target===null?this:((e.target&ve.Vertex)!=0&&this._removeVertexOutputNode(e),(e.target&ve.Fragment)!=0&&this._removeFragmentOutputNode(e),this)},t.prototype._addVertexOutputNode=function(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=ve.Vertex,this._vertexOutputNodes.push(e),this},t.prototype._removeVertexOutputNode=function(e){var i=this._vertexOutputNodes.indexOf(e);if(i!==-1)return this._vertexOutputNodes.splice(i,1),this},t.prototype._addFragmentOutputNode=function(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=ve.Fragment,this._fragmentOutputNodes.push(e),this},t.prototype._removeFragmentOutputNode=function(e){var i=this._fragmentOutputNodes.indexOf(e);if(i!==-1)return this._fragmentOutputNodes.splice(i,1),this},t.prototype.needAlphaBlending=function(){return this.ignoreAlpha?!1:this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending},t.prototype.needAlphaTesting=function(){return this._sharedData&&this._sharedData.hints.needAlphaTesting},t.prototype._initializeBlock=function(e,i,r){if(e.initialize(i),e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique)for(var o=e.getClassName(),a=0,s=this.attachedBlocks;a<s.length;a++){var c=s[a];if(c.getClassName()===o)throw"Cannot have multiple blocks of type "+o+" in the same NodeMaterial"}this.attachedBlocks.push(e)}for(var _=0,b=e.inputs;_<b.length;_++){var C=b[_];C.associatedVariableName="";var x=C.connectedPoint;if(x){var V=x.ownerBlock;V!==e&&((V.target===ve.VertexAndFragment||i.target===ve.Fragment&&V.target===ve.Vertex&&V._preparationId!==this._buildId)&&r.push(V),this._initializeBlock(V,i,r))}}for(var D=0,z=e.outputs;D<z.length;D++){var q=z[D];q.associatedVariableName=""}},t.prototype._resetDualBlocks=function(e,i){e.target===ve.VertexAndFragment&&(e.buildId=i);for(var r=0,o=e.inputs;r<o.length;r++){var a=o[r],s=a.connectedPoint;if(s){var c=s.ownerBlock;c!==e&&this._resetDualBlocks(c,i)}}},t.prototype.removeBlock=function(e){var i=this.attachedBlocks.indexOf(e);i>-1&&this.attachedBlocks.splice(i,1),e.isFinalMerger&&this.removeOutputNode(e)},t.prototype.build=function(e){e===void 0&&(e=!1),this._buildWasSuccessful=!1;var i=this.getScene().getEngine(),r=this._mode===Ki.Particle;if(this._vertexOutputNodes.length===0&&!r)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Lc,this._vertexCompilationState.supportUniformBuffers=i.supportsUniformBuffers,this._vertexCompilationState.target=ve.Vertex,this._fragmentCompilationState=new Lc,this._fragmentCompilationState.supportUniformBuffers=i.supportsUniformBuffers,this._fragmentCompilationState.target=ve.Fragment,this._sharedData=new qm,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=r;for(var o=[],a=[],s=0,c=this._vertexOutputNodes;s<c.length;s++){var _=c[s];o.push(_),this._initializeBlock(_,this._vertexCompilationState,a)}for(var b=0,C=this._fragmentOutputNodes;b<C.length;b++){var x=C[b];a.push(x),this._initializeBlock(x,this._fragmentCompilationState,o)}this.optimize();for(var V=0,D=o;V<D.length;V++){var _=D[V];_.build(this._vertexCompilationState,o)}this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(var z=0,q=a;z<q.length;z++){var x=q[z];this._resetDualBlocks(x,this._buildId-1)}for(var ue=0,ge=a;ue<ge.length;ue++){var x=ge[ue];x.build(this._fragmentCompilationState,a)}this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),this._buildId=t._BuildIdGenerator++,this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);for(var Se=this.getScene().meshes,Pe=0,me=Se;Pe<me.length;Pe++){var xe=me[Pe];if(!!xe.subMeshes)for(var Fe=0,we=xe.subMeshes;Fe<we.length;Fe++){var Ge=we[Fe];if(Ge.getMaterial()===this&&!!Ge._materialDefines){var Xe=Ge._materialDefines;Xe.markAllAsDirty(),Xe.reset()}}}},t.prototype.optimize=function(){for(var e=0,i=this._optimizers;e<i.length;e++){var r=i[e];r.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}},t.prototype._prepareDefinesForAttributes=function(e,i){var r=i.NORMAL,o=i.TANGENT,a=i.UV1;i.NORMAL=e.isVerticesDataPresent(Be.b.NormalKind),i.TANGENT=e.isVerticesDataPresent(Be.b.TangentKind),i.UV1=e.isVerticesDataPresent(Be.b.UVKind),(r!==i.NORMAL||o!==i.TANGENT||a!==i.UV1)&&i.markAsAttributesDirty()},t.prototype.createPostProcess=function(e,i,r,o,a,s,c){return i===void 0&&(i=1),r===void 0&&(r=1),s===void 0&&(s=0),c===void 0&&(c=5),this.mode!==Ki.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,i,r,o,a,s,c)},t.prototype.createEffectForPostProcess=function(e){this._createEffectForPostProcess(e)},t.prototype._createEffectForPostProcess=function(e,i,r,o,a,s,c,_){var b=this;r===void 0&&(r=1),o===void 0&&(o=1),c===void 0&&(c=0),_===void 0&&(_=5);var C=this.name+this._buildId,x=new Ao,V=new Ae.a(C+"PostProcess",this.getScene()),D=this._buildId;return this._processDefines(V,x),qe.a.RegisterShader(C,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(x.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,C,C):e=new ii.a(this.name+"PostProcess",C,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,r,i,o,a,s,x.toString(),c,C,{maxSimultaneousLights:this.maxSimultaneousLights},!1,_),e.nodeMaterialSource=this,e.onApplyObservable.add(function(z){D!==b._buildId&&(delete qe.a.ShadersStore[C+"VertexShader"],delete qe.a.ShadersStore[C+"PixelShader"],C=b.name+b._buildId,x.markAsUnprocessed(),D=b._buildId);var q=b._processDefines(V,x);q&&(qe.a.RegisterShader(C,b._fragmentCompilationState._builtCompilationString,b._vertexCompilationState._builtCompilationString),Nc.a.SetImmediate(function(){return e.updateEffect(x.toString(),b._fragmentCompilationState.uniforms,b._fragmentCompilationState.samplers,{maxSimultaneousLights:b.maxSimultaneousLights},void 0,void 0,C,C)})),b._checkInternals(z)}),e},t.prototype.createProceduralTexture=function(e,i){var r=this;if(this.mode!==Ki.ProceduralTexture)return console.log("Incompatible material mode"),null;var o=this.name+this._buildId,a=new Po(o,e,null,i),s=new Ae.a(o+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};var c=new Ao,_=this._processDefines(s,c);qe.a.RegisterShader(o,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);var b=this.getScene().getEngine().createEffect({vertexElement:o,fragmentElement:o},[Be.b.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,c.toString(),_==null?void 0:_.fallbacks,void 0);a.nodeMaterialSource=this,a._effect=b;var C=this._buildId;return a.onBeforeGenerationObservable.add(function(){C!==r._buildId&&(delete qe.a.ShadersStore[o+"VertexShader"],delete qe.a.ShadersStore[o+"PixelShader"],o=r.name+r._buildId,c.markAsUnprocessed(),C=r._buildId);var x=r._processDefines(s,c);x&&(qe.a.RegisterShader(o,r._fragmentCompilationState._builtCompilationString,r._vertexCompilationState._builtCompilationString),Nc.a.SetImmediate(function(){b=r.getScene().getEngine().createEffect({vertexElement:o,fragmentElement:o},[Be.b.PositionKind],r._fragmentCompilationState.uniforms,r._fragmentCompilationState.samplers,c.toString(),x==null?void 0:x.fallbacks,void 0),a._effect=b})),r._checkInternals(b)}),a},t.prototype._createEffectForParticles=function(e,i,r,o,a,s,c,_){var b=this;_===void 0&&(_="");var C=this.name+this._buildId+"_"+i;s||(s=new Ao),c||(c=this.getScene().getMeshByName(this.name+"Particle"),c||(c=new Ae.a(this.name+"Particle",this.getScene()),c.reservedDataStore={hidden:!0}));var x=this._buildId,V=[],D=_;if(!a){var z=this._processDefines(c,s);qe.a.RegisterShader(C,this._fragmentCompilationState._builtCompilationString),e.fillDefines(V,i),D=V.join(`
`),a=this.getScene().getEngine().createEffectForParticles(C,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString()+`
`+D,z==null?void 0:z.fallbacks,r,o,e),e.setCustomEffect(a,i)}a.onBindObservable.add(function(q){x!==b._buildId&&(delete qe.a.ShadersStore[C+"PixelShader"],C=b.name+b._buildId+"_"+i,s.markAsUnprocessed(),x=b._buildId),V.length=0,e.fillDefines(V,i);var ue=V.join(`
`);ue!==D&&(s.markAsUnprocessed(),D=ue);var ge=b._processDefines(c,s);if(ge){qe.a.RegisterShader(C,b._fragmentCompilationState._builtCompilationString),q=b.getScene().getEngine().createEffectForParticles(C,b._fragmentCompilationState.uniforms,b._fragmentCompilationState.samplers,s.toString()+`
`+D,ge==null?void 0:ge.fallbacks,r,o,e),e.setCustomEffect(q,i),b._createEffectForParticles(e,i,r,o,q,s,c,D);return}b._checkInternals(q)})},t.prototype._checkInternals=function(e){if(this._sharedData.animatedInputs){var i=this.getScene(),r=i.getFrameId();if(this._animationFrame!==r){for(var o=0,a=this._sharedData.animatedInputs;o<a.length;o++){var s=a[o];s.animate(i)}this._animationFrame=r}}for(var c=0,_=this._sharedData.bindableBlocks;c<_.length;c++){var b=_[c];b.bind(e,this)}for(var C=0,x=this._sharedData.inputBlocks;C<x.length;C++){var V=x[C];V._transmit(e,this.getScene())}},t.prototype.createEffectForParticles=function(e,i,r){if(this.mode!==Ki.Particle){console.log("Incompatible material mode");return}this._createEffectForParticles(e,To.BLENDMODE_ONEONE,i,r),this._createEffectForParticles(e,To.BLENDMODE_MULTIPLY,i,r)},t.prototype._processDefines=function(e,i,r,o){var a=this;r===void 0&&(r=!1);var s=null;if(this._sharedData.blocksWithDefines.forEach(function(V){V.initializeDefines(e,a,i,r)}),this._sharedData.blocksWithDefines.forEach(function(V){V.prepareDefines(e,a,i,r,o)}),i.isDirty){var c=i._areLightsDisposed;i.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(function(V){V.replaceRepeatableContent(a._vertexCompilationState,a._fragmentCompilationState,e,i)});var _=[];this._sharedData.dynamicUniformBlocks.forEach(function(V){V.updateUniformsAndSamples(a._vertexCompilationState,a,i,_)});var b=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(function(V){var D=b.indexOf(V);D===-1&&b.push(V)});var C=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(function(V){var D=C.indexOf(V);D===-1&&C.push(V)});var x=new gs.a;this._sharedData.blocksWithFallbacks.forEach(function(V){V.provideFallbacks(e,x)}),s={lightDisposed:c,uniformBuffers:_,mergedUniforms:b,mergedSamplers:C,fallbacks:x}}return s},t.prototype.isReadyForSubMesh=function(e,i,r){var o=this;if(r===void 0&&(r=!1),!this._buildWasSuccessful)return!1;var a=this.getScene();if(this._sharedData.animatedInputs){var s=a.getFrameId();if(this._animationFrame!==s){for(var c=0,_=this._sharedData.animatedInputs;c<_.length;c++){var b=_[c];b.animate(a)}this._animationFrame=s}}if(i.effect&&this.isFrozen&&i.effect._wasPreviouslyReady)return!0;i._materialDefines||(i._materialDefines=new Ao);var C=i._materialDefines;if(this._isReadyForSubMesh(i))return!0;var x=a.getEngine();if(this._prepareDefinesForAttributes(e,C),this._sharedData.blockingBlocks.some(function(ue){return!ue.isReady(e,o,C,r)}))return!1;var V=this._processDefines(e,C,r,i);if(V){var D=i.effect,z=C.toString(),q=x.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:V.mergedUniforms,uniformBuffersNames:V.uniformBuffers,samplers:V.mergedSamplers,defines:z,fallbacks:V.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:C.NUM_MORPH_INFLUENCERS}},x);if(q)if(this._onEffectCreatedObservable&&(Hs.effect=q,Hs.subMesh=i,this._onEffectCreatedObservable.notifyObservers(Hs)),this.allowShaderHotSwapping&&D&&!q.isReady()){if(q=D,C.markAsUnprocessed(),V.lightDisposed)return C._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),i.setEffect(q,C)}return!i.effect||!i.effect.isReady()?!1:(C._renderId=a.getRenderId(),i.effect._wasPreviouslyReady=!0,!0)},Object.defineProperty(t.prototype,"compiledShaders",{get:function(){return`// Vertex shader\r
`+this._vertexCompilationState.compilationString+`\r
\r
// Fragment shader\r
`+this._fragmentCompilationState.compilationString},enumerable:!1,configurable:!0}),t.prototype.bindOnlyWorldMatrix=function(e){var i=this.getScene();if(!!this._activeEffect){var r=this._sharedData.hints;r.needWorldViewMatrix&&e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),r.needWorldViewProjectionMatrix&&e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(var o=0,a=this._sharedData.inputBlocks;o<a.length;o++){var s=a[o];s._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}}},t.prototype.bindForSubMesh=function(e,i,r){var o=this.getScene(),a=r.effect;if(!!a){this._activeEffect=a,this.bindOnlyWorldMatrix(e);var s=this._mustRebind(o,a,i.visibility);if(s){var c=this._sharedData;if(a&&o.getCachedEffect()!==a){for(var _=0,b=c.bindableBlocks;_<b.length;_++){var C=b[_];C.bind(a,this,i,r)}for(var x=0,V=c.inputBlocks;x<V.length;x++){var D=V[x];D._transmit(a,o)}}}this._afterBind(i,this._activeEffect)}},t.prototype.getActiveTextures=function(){var e=n.prototype.getActiveTextures.call(this);return this._sharedData&&e.push.apply(e,this._sharedData.textureBlocks.filter(function(i){return i.texture}).map(function(i){return i.texture})),e},t.prototype.getTextureBlocks=function(){return this._sharedData?this._sharedData.textureBlocks:[]},t.prototype.hasTexture=function(e){if(n.prototype.hasTexture.call(this,e))return!0;if(!this._sharedData)return!1;for(var i=0,r=this._sharedData.textureBlocks;i<r.length;i++){var o=r[i];if(o.texture===e)return!0}return!1},t.prototype.dispose=function(e,i,r){if(i)for(var o=0,a=this._sharedData.textureBlocks.filter(function(C){return C.texture}).map(function(C){return C.texture});o<a.length;o++){var s=a[o];s.dispose()}for(var c=0,_=this.attachedBlocks;c<_.length;c++){var b=_[c];b.dispose()}this.onBuildObservable.clear(),n.prototype.dispose.call(this,e,i,r)},t.prototype._createNodeEditor=function(){this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})},t.prototype.edit=function(e){var i=this;return new Promise(function(r,o){if(typeof i.BJSNODEMATERIALEDITOR=="undefined"){var a=e&&e.editorURL?e.editorURL:t.EditorURL;re.b.LoadScript(a,function(){i._createNodeEditor(),r()})}else i._createNodeEditor(),r()})},t.prototype.clear=function(){this._vertexOutputNodes=[],this._fragmentOutputNodes=[],this.attachedBlocks=[]},t.prototype.setToDefault=function(){this.clear(),this.editorData=null;var e=new bt("Position");e.setAsAttribute("position");var i=new bt("World");i.setAsSystemValue(BABYLON.NodeMaterialSystemValues.World);var r=new ta("WorldPos");e.connectTo(r),i.connectTo(r);var o=new bt("ViewProjection");o.setAsSystemValue(BABYLON.NodeMaterialSystemValues.ViewProjection);var a=new ta("WorldPos * ViewProjectionTransform");r.connectTo(a),o.connectTo(a);var s=new Co("VertexOutput");a.connectTo(s);var c=new bt("color");c.value=new v.b(.8,.8,.8,1);var _=new On("FragmentOutput");c.connectTo(_),this.addOutputNode(s),this.addOutputNode(_),this._mode=Ki.Material},t.prototype.setToDefaultPostProcess=function(){this.clear(),this.editorData=null;var e=new bt("Position");e.setAsAttribute("position2d");var i=new bt("Constant1");i.isConstant=!0,i.value=1;var r=new So("Position3D");e.connectTo(r),i.connectTo(r,{input:"w"});var o=new Co("VertexOutput");r.connectTo(o);var a=new bt("Scale");a.visibleInInspector=!0,a.value=new l.d(1,1);var s=new Ns("uv0");e.connectTo(s);var c=new ia("UV scale");s.connectTo(c),a.connectTo(c);var _=new Is("CurrentScreen");c.connectTo(_),_.texture=new Ze.a("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());var b=new On("FragmentOutput");_.connectTo(b,{output:"rgba"}),this.addOutputNode(o),this.addOutputNode(b),this._mode=Ki.PostProcess},t.prototype.setToDefaultProceduralTexture=function(){this.clear(),this.editorData=null;var e=new bt("Position");e.setAsAttribute("position2d");var i=new bt("Constant1");i.isConstant=!0,i.value=1;var r=new So("Position3D");e.connectTo(r),i.connectTo(r,{input:"w"});var o=new Co("VertexOutput");r.connectTo(o);var a=new bt("Time");a.value=0,a.min=0,a.max=0,a.isBoolean=!1,a.matrixMode=0,a.animationType=on.Time,a.isConstant=!1;var s=new bt("Color3");s.value=new v.a(1,1,1),s.isConstant=!1;var c=new On("FragmentOutput"),_=new So("VectorMerger");_.visibleInInspector=!1;var b=new Ws("Cos");b.operation=ni.Cos,e.connectTo(_),a.output.connectTo(b.input),b.output.connectTo(_.z),_.xyzOut.connectTo(c.rgb),this.addOutputNode(o),this.addOutputNode(c),this._mode=Ki.ProceduralTexture},t.prototype.setToDefaultParticle=function(){this.clear(),this.editorData=null;var e=new bt("uv");e.setAsAttribute("particle_uv");var i=new Ls("ParticleTexture");e.connectTo(i);var r=new bt("Color");r.setAsAttribute("particle_color");var o=new ia("Texture * Color");i.connectTo(o),r.connectTo(o);var a=new Fs("ParticleRampGradient");o.connectTo(a);var s=new js("ColorSplitter");r.connectTo(s);var c=new Bs("ParticleBlendMultiply");a.connectTo(c),i.connectTo(c,{output:"a"}),s.connectTo(c,{output:"a"});var _=new On("FragmentOutput");c.connectTo(_),this.addOutputNode(_),this._mode=Ki.Particle},t.prototype.loadAsync=function(e){var i=this;return this.getScene()._loadFileAsync(e).then(function(r){var o=JSON.parse(r);i.loadFromSerialization(o,"")})},t.prototype._gatherBlocks=function(e,i){if(i.indexOf(e)===-1){i.push(e);for(var r=0,o=e.inputs;r<o.length;r++){var a=o[r],s=a.connectedPoint;if(s){var c=s.ownerBlock;c!==e&&this._gatherBlocks(c,i)}}}},t.prototype.generateCode=function(){for(var e=[],i=[],r=[],o=0,a=this._vertexOutputNodes;o<a.length;o++){var s=a[o];this._gatherBlocks(s,i)}for(var c=[],_=0,b=this._fragmentOutputNodes;_<b.length;_++){var s=b[_];this._gatherBlocks(s,c)}for(var C='var nodeMaterial = new BABYLON.NodeMaterial("'+(this.name||"node material")+`");\r
`,x=0,V=i;x<V.length;x++){var D=V[x];D.isInput&&e.indexOf(D)===-1&&(C+=D._dumpCode(r,e))}for(var z=0,q=c;z<q.length;z++){var D=q[z];D.isInput&&e.indexOf(D)===-1&&(C+=D._dumpCode(r,e))}e=[],C+=`\r
// Connections\r
`;for(var ue=0,ge=this._vertexOutputNodes;ue<ge.length;ue++){var D=ge[ue];C+=D._dumpCodeForOutputConnections(e)}for(var Se=0,Pe=this._fragmentOutputNodes;Se<Pe.length;Se++){var D=Pe[Se];C+=D._dumpCodeForOutputConnections(e)}C+=`\r
// Output nodes\r
`;for(var me=0,xe=this._vertexOutputNodes;me<xe.length;me++){var D=xe[me];C+="nodeMaterial.addOutputNode("+D._codeVariableName+`);\r
`}for(var Fe=0,we=this._fragmentOutputNodes;Fe<we.length;Fe++){var D=we[Fe];C+="nodeMaterial.addOutputNode("+D._codeVariableName+`);\r
`}return C+=`nodeMaterial.build();\r
`,C},t.prototype.serialize=function(e){var i=e?{}:Ee.a.Serialize(this);i.editorData=JSON.parse(JSON.stringify(this.editorData));var r=[];if(e)r=e;else{i.customType="BABYLON.NodeMaterial",i.outputNodes=[];for(var o=0,a=this._vertexOutputNodes;o<a.length;o++){var s=a[o];this._gatherBlocks(s,r),i.outputNodes.push(s.uniqueId)}for(var c=0,_=this._fragmentOutputNodes;c<_.length;c++){var s=_[c];this._gatherBlocks(s,r),i.outputNodes.indexOf(s.uniqueId)===-1&&i.outputNodes.push(s.uniqueId)}}i.blocks=[];for(var b=0,C=r;b<C.length;b++){var x=C[b];i.blocks.push(x.serialize())}if(!e)for(var V=0,D=this.attachedBlocks;V<D.length;V++){var x=D[V];r.indexOf(x)===-1&&i.blocks.push(x.serialize())}return i},t.prototype._restoreConnections=function(e,i,r){for(var o=0,a=e.outputs;o<a.length;o++)for(var s=a[o],c=0,_=i.blocks;c<_.length;c++){var b=_[c],C=r[b.id];if(!!C)for(var x=0,V=b.inputs;x<V.length;x++){var D=V[x];if(r[D.targetBlockId]===e&&D.targetConnectionName===s.name){var z=C.getInputByName(D.inputName);if(!z||z.isConnected)continue;s.connectTo(z,!0),this._restoreConnections(C,i,r);continue}}}},t.prototype.loadFromSerialization=function(e,i,r){var o;i===void 0&&(i=""),r===void 0&&(r=!1),r||this.clear();for(var a={},s=0,c=e.blocks;s<c.length;s++){var _=c[s],b=f.a.GetClass(_.customType);if(b){var C=new b;C._deserialize(_,this.getScene(),i),a[_.id]=C,this.attachedBlocks.push(C)}}for(var x=0;x<e.blocks.length;x++){var V=e.blocks[x],C=a[V.id];!C||C.inputs.length&&!r||this._restoreConnections(C,e,a)}if(e.outputNodes)for(var D=0,z=e.outputNodes;D<z.length;D++){var q=z[D];this.addOutputNode(a[q])}if(e.locations||e.editorData&&e.editorData.locations){for(var ue=e.locations||e.editorData.locations,ge=0,Se=ue;ge<Se.length;ge++){var Pe=Se[ge];a[Pe.blockId]&&(Pe.blockId=a[Pe.blockId].uniqueId)}r&&this.editorData&&this.editorData.locations&&ue.concat(this.editorData.locations),e.locations?this.editorData={locations:ue}:(this.editorData=e.editorData,this.editorData.locations=ue);var me=[];for(var xe in a)me[xe]=a[xe].uniqueId;this.editorData.map=me}this.comment=e.comment,r||(this._mode=(o=e.mode)!==null&&o!==void 0?o:Ki.Material)},t.prototype.clone=function(e){var i=this,r=this.serialize(),o=Ee.a.Clone(function(){return new t(e,i.getScene(),i.options)},this);return o.id=e,o.name=e,o.loadFromSerialization(r),o.build(),o},t.Parse=function(e,i,r){r===void 0&&(r="");var o=Ee.a.Parse(function(){return new t(e.name,i)},e,i,r);return o.loadFromSerialization(e,r),o.build(),o},t.ParseFromFileAsync=function(e,i,r){var o=new t(e,r);return new Promise(function(a,s){return o.loadAsync(i).then(function(){o.build(),a(o)}).catch(s)})},t.ParseFromSnippetAsync=function(e,i,r,o){var a=this;return r===void 0&&(r=""),e==="_BLANK"?Promise.resolve(this.CreateDefault("blank",i)):new Promise(function(s,c){var _=new Rr.a;_.addEventListener("readystatechange",function(){if(_.readyState==4)if(_.status==200){var b=JSON.parse(JSON.parse(_.responseText).jsonPayload),C=JSON.parse(b.nodeMaterial);o||(o=Ee.a.Parse(function(){return new t(e,i)},C,i,r),o.uniqueId=i.getUniqueId()),o.loadFromSerialization(C),o.snippetId=e;try{o.build(),s(o)}catch(x){c(x)}}else c("Unable to load the snippet "+e)}),_.open("GET",a.SnippetUrl+"/"+e.replace(/#/g,"/")),_.send()})},t.CreateDefault=function(e,i){var r=new t(e,i);return r.setToDefault(),r.build(),r},t._BuildIdGenerator=0,t.EditorURL="https://unpkg.com/babylonjs-node-editor@"+G.a.Version+"/babylon.nodeEditor.js",t.SnippetUrl="https://snippet.babylonjs.com",t.IgnoreTexturesAtLoadTime=!1,Object(p.c)([Object(Ee.c)("mode")],t.prototype,"_mode",void 0),Object(p.c)([Object(Ee.c)("comment")],t.prototype,"comment",void 0),t}(ms.a);f.a.RegisteredTypes["BABYLON.NodeMaterial"]=oa;var wc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Vertex)||this;return i.registerInput("matricesIndices",ie.Vector4),i.registerInput("matricesWeights",ie.Vector4),i.registerInput("matricesIndicesExtra",ie.Vector4,!0),i.registerInput("matricesWeightsExtra",ie.Vector4,!0),i.registerInput("world",ie.Matrix),i.registerOutput("output",ie.Matrix),i}return t.prototype.initialize=function(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")},t.prototype.getClassName=function(){return"BonesBlock"},Object.defineProperty(t.prototype,"matricesIndices",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"matricesWeights",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"matricesIndicesExtra",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"matricesWeightsExtra",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.matricesIndices.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="matricesIndices"});i||(i=new bt("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){var r=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="matricesWeights"});r||(r=new bt("matricesWeights"),r.setAsAttribute("matricesWeights")),r.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){var o=e.getInputBlockByPredicate(function(a){return a.systemValue===mt.World});o||(o=new bt("world"),o.setAsSystemValue(mt.World)),o.output.connectTo(this.world)}},t.prototype.provideFallbacks=function(e,i){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&i.addCPUSkinningFallback(0,e)},t.prototype.bind=function(e,i,r){xt.a.BindBonesParameters(r,e)},t.prototype.prepareDefines=function(e,i,r){!r._areAttributesDirty||xt.a.PrepareDefinesForBones(e,r)},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");var i="//"+this.name;e._emitFunctionFromInclude("bonesDeclaration",i,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});var r=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",i,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:r}]});var o=this._outputs[0],a=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0\r
`,e.compilationString+=this._declareOutput(o,e)+(" = "+a.associatedVariableName+" * "+r+`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(o,e)+(" = "+a.associatedVariableName+`;\r
`),e.compilationString+=`#endif\r
`,this},t}(nt);f.a.RegisteredTypes["BABYLON.BonesBlock"]=wc;var Vc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Vertex)||this;return i.registerInput("world0",ie.Vector4),i.registerInput("world1",ie.Vector4),i.registerInput("world2",ie.Vector4),i.registerInput("world3",ie.Vector4),i.registerInput("world",ie.Matrix,!0),i.registerOutput("output",ie.Matrix),i.registerOutput("instanceID",ie.Float),i}return t.prototype.getClassName=function(){return"InstancesBlock"},Object.defineProperty(t.prototype,"world0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world2",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world3",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"instanceID",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.world0.connectedPoint){var i=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world0"});i||(i=new bt("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){var r=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world1"});r||(r=new bt("world1"),r.setAsAttribute("world1")),r.output.connectTo(this.world1)}if(!this.world2.connectedPoint){var o=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world2"});o||(o=new bt("world2"),o.setAsAttribute("world2")),o.output.connectTo(this.world2)}if(!this.world3.connectedPoint){var a=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world3"});a||(a=new bt("world3"),a.setAsAttribute("world3")),a.output.connectTo(this.world3)}if(!this.world.connectedPoint){var s=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world"});s||(s=new bt("world"),s.setAsSystemValue(mt.World)),s.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"},t.prototype.prepareDefines=function(e,i,r,o,a){o===void 0&&(o=!1);var s=!1;r.INSTANCES!==o&&(r.setValue("INSTANCES",o),s=!0),a&&r.THIN_INSTANCES!==!!(a==null?void 0:a.getRenderingMesh().hasThinInstances)&&(r.setValue("THIN_INSTANCES",!!(a==null?void 0:a.getRenderingMesh().hasThinInstances)),s=!0),s&&r.markAsUnprocessed()},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);var r=this._outputs[0],o=this._outputs[1],a=this.world0,s=this.world1,c=this.world2,_=this.world3;return e.compilationString+=`#ifdef INSTANCES\r
`,e.compilationString+=this._declareOutput(r,e)+(" = mat4("+a.associatedVariableName+", "+s.associatedVariableName+", "+c.associatedVariableName+", "+_.associatedVariableName+`);\r
`),e.compilationString+=`#ifdef THIN_INSTANCES\r
`,e.compilationString+=r.associatedVariableName+" = "+this.world.associatedVariableName+" * "+r.associatedVariableName+`;\r
`,e.compilationString+=`#endif\r
`,i._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(o,e)+` = 0.0;\r
`:e.compilationString+=this._declareOutput(o,e)+` = float(gl_InstanceID);\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(r,e)+(" = "+this.world.associatedVariableName+`;\r
`),e.compilationString+=this._declareOutput(o,e)+` = 0.0;\r
`,e.compilationString+=`#endif\r
`,this},t}(nt);f.a.RegisteredTypes["BABYLON.InstancesBlock"]=Vc;var ty=u(497),iy=u(496),Uc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Vertex)||this;return i.registerInput("position",ie.Vector3),i.registerInput("normal",ie.Vector3),i.registerInput("tangent",ie.Vector3),i.registerInput("uv",ie.Vector2),i.registerOutput("positionOutput",ie.Vector3),i.registerOutput("normalOutput",ie.Vector3),i.registerOutput("tangentOutput",ie.Vector3),i.registerOutput("uvOutput",ie.Vector2),i}return t.prototype.getClassName=function(){return"MorphTargetsBlock"},Object.defineProperty(t.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tangent",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"positionOutput",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalOutput",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tangentOutput",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uvOutput",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("morphTargetInfluences")},t.prototype.autoConfigure=function(e){if(!this.position.isConnected){var i=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="position"});i||(i=new bt("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){var r=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="normal"});r||(r=new bt("normal"),r.setAsAttribute("normal")),r.output.connectTo(this.normal)}if(!this.tangent.isConnected){var o=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="tangent"});o||(o=new bt("tangent"),o.setAsAttribute("tangent")),o.output.connectTo(this.tangent)}if(!this.uv.isConnected){var a=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="uv"});a||(a=new bt("uv"),a.setAsAttribute("uv")),a.output.connectTo(this.uv)}},t.prototype.prepareDefines=function(e,i,r){if(e.morphTargetManager){var o=e.morphTargetManager;(o==null?void 0:o.isUsingTextureForTargets)&&o.numInfluencers!==r.NUM_MORPH_INFLUENCERS&&r.markAsAttributesDirty()}!r._areAttributesDirty||xt.a.PrepareDefinesForMorphTargets(e,r)},t.prototype.bind=function(e,i,r){r&&r.morphTargetManager&&r.morphTargetManager.numInfluencers>0&&(xt.a.BindMorphTargetParameters(r,e),r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(e))},t.prototype.replaceRepeatableContent=function(e,i,r,o){var a=this.position,s=this.normal,c=this.tangent,_=this.uv,b=this.positionOutput,C=this.normalOutput,x=this.tangentOutput,V=this.uvOutput,D=e,z=o.NUM_MORPH_INFLUENCERS,q=r.morphTargetManager,ue=q&&q.supportsNormals&&o.NORMAL,ge=q&&q.supportsTangents&&o.TANGENT,Se=q&&q.supportsUVs&&o.UV1,Pe="";(q==null?void 0:q.isUsingTextureForTargets)&&z>0&&(Pe+=`float vertexID;\r
`);for(var me=0;me<z;me++)Pe+=`#ifdef MORPHTARGETS\r
`,(q==null?void 0:q.isUsingTextureForTargets)?(Pe+=`vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r
`,Pe+=b.associatedVariableName+" += (readVector3FromRawSampler("+me+", vertexID) - "+a.associatedVariableName+") * morphTargetInfluences["+me+`];\r
`,Pe+=`vertexID += 1.0;\r
`):Pe+=b.associatedVariableName+" += (position"+me+" - "+a.associatedVariableName+") * morphTargetInfluences["+me+`];\r
`,ue&&(Pe+=`#ifdef MORPHTARGETS_NORMAL\r
`,(q==null?void 0:q.isUsingTextureForTargets)?(Pe+=C.associatedVariableName+" += (readVector3FromRawSampler("+me+", vertexID) - "+s.associatedVariableName+") * morphTargetInfluences["+me+`];\r
`,Pe+=`vertexID += 1.0;\r
`):Pe+=C.associatedVariableName+" += (normal"+me+" - "+s.associatedVariableName+") * morphTargetInfluences["+me+`];\r
`,Pe+=`#endif\r
`),Se&&(Pe+=`#ifdef MORPHTARGETS_UV\r
`,(q==null?void 0:q.isUsingTextureForTargets)?(Pe+=V.associatedVariableName+" += (readVector3FromRawSampler("+me+", vertexID).xy - "+_.associatedVariableName+") * morphTargetInfluences["+me+`];\r
`,Pe+=`vertexID += 1.0;\r
`):Pe+=V.associatedVariableName+".xy += (uv_"+me+" - "+_.associatedVariableName+".xy) * morphTargetInfluences["+me+`];\r
`,Pe+=`#endif\r
`),ge&&(Pe+=`#ifdef MORPHTARGETS_TANGENT\r
`,(q==null?void 0:q.isUsingTextureForTargets)?Pe+=x.associatedVariableName+" += (readVector3FromRawSampler("+me+", vertexID) - "+c.associatedVariableName+") * morphTargetInfluences["+me+`];\r
`:Pe+=x.associatedVariableName+".xyz += (tangent"+me+" - "+c.associatedVariableName+".xyz) * morphTargetInfluences["+me+`];\r
`,Pe+=`#endif\r
`),Pe+=`#endif\r
`;if(D.compilationString=D.compilationString.replace(this._repeatableContentAnchor,Pe),z>0)for(var me=0;me<z;me++)D.attributes.push(Be.b.PositionKind+me),ue&&D.attributes.push(Be.b.NormalKind+me),ge&&D.attributes.push(Be.b.TangentKind+me),Se&&D.attributes.push(Be.b.UVKind+"_"+me)},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);var i=this.position,r=this.normal,o=this.tangent,a=this.uv,s=this.positionOutput,c=this.normalOutput,_=this.tangentOutput,b=this.uvOutput,C="//"+this.name;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",C),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",C,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=this._declareOutput(s,e)+" = "+i.associatedVariableName+`;\r
`,e.compilationString+=`#ifdef NORMAL\r
`,e.compilationString+=this._declareOutput(c,e)+" = "+r.associatedVariableName+`;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(c,e)+` = vec3(0., 0., 0.);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef TANGENT\r
`,e.compilationString+=this._declareOutput(_,e)+" = "+o.associatedVariableName+`;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(_,e)+` = vec3(0., 0., 0.);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef UV1\r
`,e.compilationString+=this._declareOutput(b,e)+" = "+a.associatedVariableName+`;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(b,e)+` = vec2(0., 0.);\r
`,e.compilationString+=`#endif\r
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this},t}(nt);f.a.RegisteredTypes["BABYLON.MorphTargetsBlock"]=Uc;var Gc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Vertex)||this;return i.registerInput("worldPosition",ie.Vector4,!1,ve.Vertex),i.registerOutput("direction",ie.Vector3),i.registerOutput("color",ie.Color3),i.registerOutput("intensity",ie.Float),i}return t.prototype.getClassName=function(){return"LightInformationBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"intensity",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),t.prototype.bind=function(e,i,r){if(!!r){this.light&&this.light.isDisposed&&(this.light=null);var o=this.light,a=i.getScene();if(!o&&a.lights.length&&(o=a.lights[0]),!o||!o.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}o.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,o.diffuse,o.intensity)}},t.prototype.prepareDefines=function(e,i,r){if(!!r._areLightsDirty){var o=this.light;r.setValue(this._lightTypeDefineName,!!(o&&o instanceof Rs))}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);var i=this.direction,r=this.color,o=this.intensity;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+="#ifdef "+this._lightTypeDefineName+`\r
`,e.compilationString+=this._declareOutput(i,e)+(" = normalize("+this.worldPosition.associatedVariableName+".xyz - "+this._lightDataUniformName+`);\r
`),e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(i,e)+(" = "+this._lightDataUniformName+`;\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=this._declareOutput(r,e)+(" = "+this._lightColorUniformName+`.rgb;\r
`),e.compilationString+=this._declareOutput(o,e)+(" = "+this._lightColorUniformName+`.a;\r
`),this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),e.lightId&&(this.light=i.getLightByID(e.lightId))},t}(nt);f.a.RegisteredTypes["BABYLON.LightInformationBlock"]=Gc;var zc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i.registerInput("color",ie.Color4),i.registerOutput("output",ie.Color4),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color3),i}return t.prototype.getClassName=function(){return"ImageProcessingBlock"},Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings")},t.prototype.isReady=function(e,i,r){return!(r._areImageProcessingDirty&&i.imageProcessingConfiguration&&!i.imageProcessingConfiguration.isReady())},t.prototype.prepareDefines=function(e,i,r){r._areImageProcessingDirty&&i.imageProcessingConfiguration&&i.imageProcessingConfiguration.prepareDefines(r)},t.prototype.bind=function(e,i,r){!r||!i.imageProcessingConfiguration||i.imageProcessingConfiguration.bind(e)},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings");var i=this.color,r=this._outputs[0],o="//"+this.name;return e._emitFunctionFromInclude("helperFunctions",o),e._emitFunctionFromInclude("imageProcessingDeclaration",o),e._emitFunctionFromInclude("imageProcessingFunctions",o),i.connectedPoint.type===ie.Color4||i.connectedPoint.type===ie.Vector4?e.compilationString+=this._declareOutput(r,e)+" = "+i.associatedVariableName+`;\r
`:e.compilationString+=this._declareOutput(r,e)+" = vec4("+i.associatedVariableName+`, 1.0);\r
`,e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS\r
`,e.compilationString+=r.associatedVariableName+".rgb = toLinearSpace("+i.associatedVariableName+`.rgb);\r
`,e.compilationString+=`#else\r
`,e.compilationString+=`#ifdef IMAGEPROCESSING\r
`,e.compilationString+=r.associatedVariableName+".rgb = toLinearSpace("+i.associatedVariableName+`.rgb);\r
`,e.compilationString+=r.associatedVariableName+" = applyImageProcessing("+r.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this},t}(nt);f.a.RegisteredTypes["BABYLON.ImageProcessingBlock"]=zc;var ry=u(614),ny=u(615),oy=u(616),jc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i._tangentSpaceParameterName="",i.invertX=!1,i.invertY=!1,i.registerInput("worldPosition",ie.Vector4,!1),i.registerInput("worldNormal",ie.Vector4,!1),i.registerInput("worldTangent",ie.Vector4,!0),i.registerInput("uv",ie.Vector2,!1),i.registerInput("normalMapColor",ie.Color3,!1),i.registerInput("strength",ie.Float,!1),i.registerOutput("output",ie.Vector4),i}return t.prototype.getClassName=function(){return"PerturbNormalBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldTangent",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalMapColor",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"strength",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.prepareDefines=function(e,i,r){r.setValue("BUMP",!0)},t.prototype.bind=function(e,i,r){i.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1)},t.prototype.autoConfigure=function(e){if(!this.uv.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name==="uv"});i||(i=new bt("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){var r=new bt("strength");r.value=1,r.output.connectTo(this.strength)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i="//"+this.name,r=this.uv,o=this.worldPosition,a=this.worldNormal,s=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2");var c=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?""+e._emitFloat(1/this.strength.connectInputBlock.value):"1.0 / "+this.strength.associatedVariableName;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var _={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"};return s.isConnected&&(e.compilationString+="vec3 tbnNormal = normalize("+a.associatedVariableName+`.xyz);\r
`,e.compilationString+="vec3 tbnTangent = normalize("+s.associatedVariableName+`.xyz);\r
`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,e.compilationString+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[_]}),e._emitFunctionFromInclude("bumpFragmentFunctions",i,{replaceStrings:[{search:/vBumpInfos.y/g,replace:c},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vPositionW/g,replace:o.associatedVariableName+".xyz"},{search:/varying vec2 vBumpUV;/g,replace:""},{search:/uniform sampler2D bumpSampler;[\s\S]*?\}/g,replace:""}]}),e.compilationString+=this._declareOutput(this.output,e)+` = vec4(0.);\r
`,e.compilationString+=e._emitCodeFromInclude("bumpFragment",i,{replaceStrings:[{search:/perturbNormal\(TBN,vBumpUV\+uvOffset\)/g,replace:"perturbNormal(TBN, "+this.normalMapColor.associatedVariableName+")"},{search:/vBumpInfos.y/g,replace:c},{search:/vBumpUV/g,replace:r.associatedVariableName},{search:/vPositionW/g,replace:o.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:a.associatedVariableName+".xyz"},_]}),this},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".invertX = "+this.invertX+`;\r
`;return e+=this._codeVariableName+".invertY = "+this.invertY+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.invertX=this.invertX,e.invertY=this.invertY,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.invertX=e.invertX,this.invertY=e.invertY},Object(p.c)([Lt("Invert X axis",Dt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],t.prototype,"invertX",void 0),Object(p.c)([Lt("Invert Y axis",Dt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],t.prototype,"invertY",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.PerturbNormalBlock"]=jc;var Wc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment,!0)||this;return i.registerInput("value",ie.Float,!0),i.registerInput("cutoff",ie.Float,!0),i}return t.prototype.getClassName=function(){return"DiscardBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cutoff",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+="if ("+this.value.associatedVariableName+" < "+this.cutoff.associatedVariableName+`) discard;\r
`,this},t}(nt);f.a.RegisteredTypes["BABYLON.DiscardBlock"]=Wc;var Hc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i.registerOutput("output",ie.Float,ve.Fragment),i}return t.prototype.getClassName=function(){return"FrontFacingBlock"},Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===ve.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+` = gl_FrontFacing ? 1.0 : 0.0;\r
`,this},t}(nt);f.a.RegisteredTypes["BABYLON.FrontFacingBlock"]=Hc;var kc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i.registerInput("input",ie.AutoDetect,!1),i.registerOutput("dx",ie.BasedOnInput),i.registerOutput("dy",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._outputs[1]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"DerivativeBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dx",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dy",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+(" = dFdx("+this.input.associatedVariableName+`);\r
`)),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+(" = dFdy("+this.input.associatedVariableName+`);\r
`)),this},t}(nt);f.a.RegisteredTypes["BABYLON.DerivativeBlock"]=kc;var Xc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i.registerOutput("xy",ie.Vector2,ve.Fragment),i.registerOutput("xyz",ie.Vector3,ve.Fragment),i.registerOutput("xyzw",ie.Vector4,ve.Fragment),i.registerOutput("x",ie.Float,ve.Fragment),i.registerOutput("y",ie.Float,ve.Fragment),i.registerOutput("z",ie.Float,ve.Fragment),i.registerOutput("w",ie.Float,ve.Fragment),i}return t.prototype.getClassName=function(){return"FragCoordBlock"},Object.defineProperty(t.prototype,"xy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyz",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzw",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),t.prototype.writeOutputs=function(e){for(var i="",r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&(i+=this._declareOutput(a,e)+" = gl_FragCoord."+a.name+`;\r
`)}return i},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===ve.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this},t}(nt);f.a.RegisteredTypes["BABYLON.FragCoordBlock"]=Xc;var Yc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i.registerOutput("xy",ie.Vector2,ve.Fragment),i.registerOutput("x",ie.Float,ve.Fragment),i.registerOutput("y",ie.Float,ve.Fragment),i}return t.prototype.getClassName=function(){return"ScreenSizeBlock"},Object.defineProperty(t.prototype,"xy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),t.prototype.bind=function(e,i,r){var o=this._scene.getEngine();e.setFloat2(this._varName,o.getRenderWidth(),o.getRenderWidth())},t.prototype.writeOutputs=function(e,i){for(var r="",o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&(r+=this._declareOutput(s,e)+" = "+i+"."+s.name+`;\r
`)}return r},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),this._scene=e.sharedData.scene,e.target===ve.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this},t}(nt);f.a.RegisteredTypes["BABYLON.ScreenSizeBlock"]=Yc;var Kc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.VertexAndFragment,!1)||this;return i.registerInput("worldPosition",ie.Vector4,!1,ve.Vertex),i.registerInput("view",ie.Matrix,!1,ve.Vertex),i.registerInput("input",ie.Color3,!1,ve.Fragment),i.registerInput("fogColor",ie.Color3,!1,ve.Fragment),i.registerOutput("output",ie.Color3,ve.Fragment),i.input.acceptedConnectionPointTypes.push(ie.Color4),i.fogColor.acceptedConnectionPointTypes.push(ie.Color4),i}return t.prototype.getClassName=function(){return"FogBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fogColor",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.view.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.systemValue===mt.View});i||(i=new bt("view"),i.setAsSystemValue(mt.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){var r=e.getInputBlockByPredicate(function(o){return o.systemValue===mt.FogColor});r||(r=new bt("fogColor",void 0,ie.Color3),r.setAsSystemValue(mt.FogColor)),r.output.connectTo(this.fogColor)}},t.prototype.prepareDefines=function(e,i,r){var o=e.getScene();r.setValue("FOG",i.fogEnabled&&xt.a.GetFogState(e,o))},t.prototype.bind=function(e,i,r){if(!!r){var o=r.getScene();e.setFloat4(this._fogParameters,o.fogMode,o.fogStart,o.fogEnd,o.fogDensity)}},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===ve.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration","//"+this.name,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});var i=e._getFreeVariableName("fog"),r=this.input,o=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");var a=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+=`#ifdef FOG\r
`,e.compilationString+="float "+i+" = CalcFogFactor("+this._fogDistanceName+", "+this._fogParameters+`);\r
`,e.compilationString+=this._declareOutput(a,e)+(" = "+i+" * "+r.associatedVariableName+".rgb + (1.0 - "+i+") * "+o.associatedVariableName+`.rgb;\r
`),e.compilationString+=`#else\r
`+this._declareOutput(a,e)+" =  "+r.associatedVariableName+`.rgb;\r
`,e.compilationString+=`#endif\r
`}else{var s=this.worldPosition,c=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=this._fogDistanceName+" = ("+c.associatedVariableName+" * "+s.associatedVariableName+`).xyz;\r
`}return this},t}(nt);f.a.RegisteredTypes["BABYLON.FogBlock"]=Kc;var Qc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.VertexAndFragment)||this;return i._isUnique=!0,i.registerInput("worldPosition",ie.Vector4,!1,ve.Vertex),i.registerInput("worldNormal",ie.Vector4,!1,ve.Fragment),i.registerInput("cameraPosition",ie.Vector3,!1,ve.Fragment),i.registerInput("glossiness",ie.Float,!0,ve.Fragment),i.registerInput("glossPower",ie.Float,!0,ve.Fragment),i.registerInput("diffuseColor",ie.Color3,!0,ve.Fragment),i.registerInput("specularColor",ie.Color3,!0,ve.Fragment),i.registerInput("view",ie.Matrix,!0),i.registerOutput("diffuseOutput",ie.Color3,ve.Fragment),i.registerOutput("specularOutput",ie.Color3,ve.Fragment),i.registerOutput("shadow",ie.Float,ve.Fragment),i}return t.prototype.getClassName=function(){return"LightBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glossiness",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glossPower",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"specularColor",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseOutput",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"specularOutput",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var i=e.getInputBlockByPredicate(function(r){return r.systemValue===mt.CameraPosition});i||(i=new bt("cameraPosition"),i.setAsSystemValue(mt.CameraPosition)),i.output.connectTo(this.cameraPosition)}},t.prototype.prepareDefines=function(e,i,r){if(!!r._areLightsDirty){var o=e.getScene();if(!this.light)xt.a.PrepareDefinesForLights(o,e,r,!0,i.maxSimultaneousLights);else{var a={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};xt.a.PrepareDefinesForLight(o,e,this.light,this._lightId,r,!0,a),a.needRebuild&&r.rebuild()}}},t.prototype.updateUniformsAndSamples=function(e,i,r,o){for(var a=0;a<i.maxSimultaneousLights&&r["LIGHT"+a];a++){var s=e.uniforms.indexOf("vLightData"+a)>=0;xt.a.PrepareUniformsAndSamplersForLight(a,e.uniforms,e.samplers,r["PROJECTEDLIGHTTEXTURE"+a],o,s)}},t.prototype.bind=function(e,i,r){if(!!r){var o=r.getScene();this.light?xt.a.BindLight(this.light,this._lightId,o,e,!0):xt.a.BindLights(o,r,e,!0,i.maxSimultaneousLights)}},t.prototype._injectVertexCode=function(e){var i=this.worldPosition,r="//"+this.name;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));var o="v_"+i.associatedVariableName;e._emitVaryingFromString(o,"vec4")&&(e.compilationString+=o+" = "+i.associatedVariableName+`;\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:i.associatedVariableName}]}):(e.compilationString+="vec4 worldPos = "+i.associatedVariableName+`;\r
`,this.view.isConnected&&(e.compilationString+="mat4 view = "+this.view.associatedVariableName+`;\r
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==ve.Fragment){this._injectVertexCode(e);return}e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);var i="//"+this.name,r=this.worldPosition;e._emitFunctionFromInclude("helperFunctions",i),e._emitFunctionFromInclude("lightsFragmentFunctions",i,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+r.associatedVariableName+".xyz"}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",i,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+r.associatedVariableName+".xyz"}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+="vec3 viewDirectionW = normalize("+this.cameraPosition.associatedVariableName+" - "+("v_"+r.associatedVariableName)+`.xyz);\r
`),e.compilationString+=`lightingInfo info;\r
`,e.compilationString+=`float shadow = 1.;\r
`,e.compilationString+="float glossiness = "+(this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0")+" * "+(this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0")+`;\r
`,e.compilationString+=`vec3 diffuseBase = vec3(0., 0., 0.);\r
`,e.compilationString+=`vec3 specularBase = vec3(0., 0., 0.);\r
`,e.compilationString+="vec3 normalW = "+this.worldNormal.associatedVariableName+`.xyz;\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",i,{repeatKey:"maxSimultaneousLights"});var o=this.diffuseOutput,a=this.specularOutput;return e.compilationString+=this._declareOutput(o,e)+(" = diffuseBase"+(this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:"")+`;\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+(" = specularBase"+(this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:"")+`;\r
`)),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+` = shadow;\r
`),this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),e.lightId&&(this.light=i.getLightByID(e.lightId))},t}(nt);f.a.RegisteredTypes["BABYLON.LightBlock"]=Qc;var Zc=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i=!1);var r=n.call(this,e,i?ve.Fragment:ve.VertexAndFragment)||this;return r.convertToGammaSpace=!1,r.convertToLinearSpace=!1,r._fragmentOnly=i,r.registerInput("uv",ie.Vector2,!1,ve.VertexAndFragment),r.registerOutput("rgba",ie.Color4,ve.Neutral),r.registerOutput("rgb",ie.Color3,ve.Neutral),r.registerOutput("r",ie.Float,ve.Neutral),r.registerOutput("g",ie.Float,ve.Neutral),r.registerOutput("b",ie.Float,ve.Neutral),r.registerOutput("a",ie.Float,ve.Neutral),r._inputs[0].acceptedConnectionPointTypes.push(ie.Vector3),r._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),r._inputs[0]._prioritizeVertex=!i,r}return Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},set:function(e){var i=this,r;if(this._texture!==e){var o=(r=e==null?void 0:e.getScene())!==null&&r!==void 0?r:G.a.LastCreatedScene;!e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(i._texture)}),this._texture=e,e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(e)})}},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"TextureBlock"},Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){if(this._fragmentOnly)return ve.Fragment;if(!this.uv.isConnected||this.uv.sourceBlock.isInput)return ve.VertexAndFragment;for(var e=this.uv.connectedPoint;e;){if(e.target===ve.Fragment)return ve.Fragment;if(e.target===ve.Vertex)return ve.VertexAndFragment;if(e.target===ve.Neutral||e.target===ve.VertexAndFragment){var i=e.ownerBlock;if(i.target===ve.Fragment)return ve.Fragment;e=null;for(var r=0,o=i.inputs;r<o.length;r++){var a=o[r];if(a.connectedPoint){e=a.connectedPoint;break}}}}return ve.VertexAndFragment},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.uv.isConnected)if(e.mode===Ki.PostProcess){var i=e.getBlockByPredicate(function(o){return o.name==="uv"});i&&i.connectTo(this)}else{var r=e.mode===Ki.Particle?"particle_uv":"uv",i=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name===r});i||(i=new bt("uv"),i.setAsAttribute(r)),i.output.connectTo(this.uv)}},t.prototype.initializeDefines=function(e,i,r,o){o===void 0&&(o=!1),!!r._areTexturesDirty&&r.setValue(this._mainUVDefineName,!1)},t.prototype.prepareDefines=function(e,i,r){if(!!r._areTexturesDirty){if(!this.texture||!this.texture.getTextureMatrix){r.setValue(this._defineName,!1),r.setValue(this._mainUVDefineName,!0);return}r.setValue(this._linearDefineName,this.convertToGammaSpace),r.setValue(this._gammaDefineName,this.convertToLinearSpace),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(r.setValue(this._defineName,!1),r.setValue(this._mainUVDefineName,!0)):r.setValue(this._defineName,!0))}},t.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},t.prototype.bind=function(e,i,r){!this.texture||(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),e.setTexture(this._samplerName,this.texture))},Object.defineProperty(t.prototype,"_isMixed",{get:function(){return this.target!==ve.Fragment},enumerable:!1,configurable:!0}),t.prototype._injectVertexCode=function(e){var i=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+i.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+i.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+="#ifdef "+this._defineName+`\r
`,e.compilationString+=this._transformedUVName+" = vec2("+this._textureTransformName+" * vec4("+i.associatedVariableName+`.xy, 1.0, 0.0));\r
`,e.compilationString+="#elif defined("+this._mainUVDefineName+`)\r
`,e.compilationString+=this._mainUVName+" = "+i.associatedVariableName+`.xy;\r
`,e.compilationString+=`#endif\r
`,!!this._outputs.some(function(s){return s.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&this._writeOutput(e,a,a.name,!0)}}},t.prototype._writeTextureRead=function(e,i){i===void 0&&(i=!1);var r=this.uv;if(i){if(e.target===ve.Fragment)return;e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+r.associatedVariableName+`);\r
`;return}if(this.uv.ownerBlock.target===ve.Fragment){e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+r.associatedVariableName+`);\r
`;return}e.compilationString+="#ifdef "+this._defineName+`\r
`,e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+this._transformedUVName+`);\r
`,e.compilationString+="#elif defined("+this._mainUVDefineName+`)\r
`,e.compilationString+="vec4 "+this._tempTextureRead+" = texture2D("+this._samplerName+", "+this._mainUVName+`);\r
`,e.compilationString+=`#endif\r
`},t.prototype._generateConversionCode=function(e,i,r){r!=="a"&&(e.compilationString+="#ifdef "+this._linearDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toGammaSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef "+this._gammaDefineName+`\r
`,e.compilationString+=i.associatedVariableName+" = toLinearSpace("+i.associatedVariableName+`);\r
`,e.compilationString+=`#endif\r
`)},t.prototype._writeOutput=function(e,i,r,o){if(o===void 0&&(o=!1),o){if(e.target===ve.Fragment)return;e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`,this._generateConversionCode(e,i,r);return}if(this.uv.ownerBlock.target===ve.Fragment){e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+`;\r
`,this._generateConversionCode(e,i,r);return}var a=" * "+this._textureInfoName;e.compilationString+=this._declareOutput(i,e)+" = "+this._tempTextureRead+"."+r+a+`;\r
`,this._generateConversionCode(e,i,r)},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),(e.target===ve.Vertex||this._fragmentOnly||e.target===ve.Fragment&&this._tempTextureRead===void 0)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===ve.Fragment||this._isMixed&&e.target===ve.Vertex)&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==ve.Fragment){this._injectVertexCode(e);return}if(!!this._outputs.some(function(s){return s.isConnectedInFragmentShader})){this._isMixed&&e._emit2DSampler(this._samplerName);var i="//"+this.name;e._emitFunctionFromInclude("helperFunctions",i),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(var r=0,o=this._outputs;r<o.length;r++){var a=o[r];a.hasEndpoints&&this._writeOutput(e,a,a.name)}return this}},t.prototype._dumpPropertiesCode=function(){if(!this.texture)return"";var e=this._codeVariableName+'.texture = new BABYLON.Texture("'+this.texture.name+'", null, '+this.texture.noMipmap+", "+this.texture.invertY+`);\r
`;return e+=this._codeVariableName+".texture.wrapU = "+this.texture.wrapU+`;\r
`,e+=this._codeVariableName+".texture.wrapV = "+this.texture.wrapV+`;\r
`,e+=this._codeVariableName+".texture.uAng = "+this.texture.uAng+`;\r
`,e+=this._codeVariableName+".texture.vAng = "+this.texture.vAng+`;\r
`,e+=this._codeVariableName+".texture.wAng = "+this.texture.wAng+`;\r
`,e+=this._codeVariableName+".texture.uOffset = "+this.texture.uOffset+`;\r
`,e+=this._codeVariableName+".texture.vOffset = "+this.texture.vOffset+`;\r
`,e+=this._codeVariableName+".texture.uScale = "+this.texture.uScale+`;\r
`,e+=this._codeVariableName+".texture.vScale = "+this.texture.vScale+`;\r
`,e+=this._codeVariableName+".texture.coordinatesMode = "+this.texture.coordinatesMode+`;\r
`,e+=this._codeVariableName+".convertToGammaSpace = "+this.convertToGammaSpace+`;\r
`,e+=this._codeVariableName+".convertToLinearSpace = "+this.convertToLinearSpace+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,e.texture&&!oa.IgnoreTexturesAtLoadTime&&(r=e.texture.url.indexOf("data:")===0?"":r,this.texture=Ze.a.Parse(e.texture,i,r))},t}(nt);f.a.RegisteredTypes["BABYLON.TextureBlock"]=Zc;var ks=function(n){Object(p.d)(t,n);function t(e){return n.call(this,e,ve.VertexAndFragment)||this}return Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},set:function(e){var i=this,r;if(this._texture!==e){var o=(r=e==null?void 0:e.getScene())!==null&&r!==void 0?r:G.a.LastCreatedScene;!e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(i._texture)}),this._texture=e,e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(e)})}},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"ReflectionTextureBaseBlock"},t.prototype._getTexture=function(){return this.texture},t.prototype.autoConfigure=function(e){if(!this.position.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="position"});i||(i=new bt("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){var r=e.getInputBlockByPredicate(function(a){return a.systemValue===mt.World});r||(r=new bt("world"),r.setAsSystemValue(mt.World)),r.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){var o=e.getInputBlockByPredicate(function(a){return a.systemValue===mt.View});o||(o=new bt("view"),o.setAsSystemValue(mt.View)),o.output.connectTo(this.view)}},t.prototype.prepareDefines=function(e,i,r){if(!!r._areTexturesDirty){var o=this._getTexture();!o||!o.getTextureMatrix||(r.setValue(this._define3DName,o.isCube,!0),r.setValue(this._defineLocalCubicName,!!o.boundingBoxSize,!0),r.setValue(this._defineExplicitName,o.coordinatesMode===0,!0),r.setValue(this._defineSkyboxName,o.coordinatesMode===5,!0),r.setValue(this._defineCubicName,o.coordinatesMode===3||o.coordinatesMode===6,!0),r.setValue("INVERTCUBICMAP",o.coordinatesMode===6,!0),r.setValue(this._defineSphericalName,o.coordinatesMode===1,!0),r.setValue(this._definePlanarName,o.coordinatesMode===2,!0),r.setValue(this._defineProjectionName,o.coordinatesMode===4,!0),r.setValue(this._defineEquirectangularName,o.coordinatesMode===7,!0),r.setValue(this._defineEquirectangularFixedName,o.coordinatesMode===8,!0),r.setValue(this._defineMirroredEquirectangularFixedName,o.coordinatesMode===9,!0))}},t.prototype.isReady=function(){var e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())},t.prototype.bind=function(e,i,r){var o=this._getTexture();!r||!o||(e.setMatrix(this._reflectionMatrixName,o.getReflectionTextureMatrix()),o.isCube?e.setTexture(this._cubeSamplerName,o):e.setTexture(this._2DSamplerName,o))},t.prototype.handleVertexSide=function(e){this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");var i="",r="v_"+this.worldPosition.associatedVariableName;return e._emitVaryingFromString(r,"vec4")&&(i+=r+" = "+this.worldPosition.associatedVariableName+`;\r
`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName)&&(i+="#ifdef "+this._defineSkyboxName+`\r
`,i+=this._positionUVWName+" = "+this.position.associatedVariableName+`.xyz;\r
`,i+=`#endif\r
`),e._emitVaryingFromString(this._directionWName,"vec3","defined("+this._defineEquirectangularFixedName+") || defined("+this._defineMirroredEquirectangularFixedName+")")&&(i+="#if defined("+this._defineEquirectangularFixedName+") || defined("+this._defineMirroredEquirectangularFixedName+`)\r
`,i+=this._directionWName+" = normalize(vec3("+this.world.associatedVariableName+" * vec4("+this.position.associatedVariableName+`.xyz, 0.0)));\r
`,i+=`#endif\r
`),i},t.prototype.handleFragmentSideInits=function(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+="#ifdef "+this._define3DName+`\r
`,e._samplerDeclaration+="uniform samplerCube "+this._cubeSamplerName+`;\r
`,e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+="uniform sampler2D "+this._2DSamplerName+`;\r
`,e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);var i="//"+this.name;e._emitFunction("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),e._emitFunctionFromInclude("reflectionFunction",i,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords")},t.prototype.handleFragmentSideCodeReflectionCoords=function(e,i,r){r===void 0&&(r=!1),i||(i="v_"+this.worldPosition.associatedVariableName);var o=this._reflectionMatrixName,a="normalize("+this._directionWName+")",s=""+this._positionUVWName,c=""+this.cameraPosition.associatedVariableName,_=""+this.view.associatedVariableName;e+=".xyz";var b=`
            #ifdef `+this._defineMirroredEquirectangularFixedName+`
                vec3 `+this._reflectionVectorName+" = computeMirroredFixedEquirectangularCoords("+i+", "+e+", "+a+`);
            #endif

            #ifdef `+this._defineEquirectangularFixedName+`
                vec3 `+this._reflectionVectorName+" = computeFixedEquirectangularCoords("+i+", "+e+", "+a+`);
            #endif

            #ifdef `+this._defineEquirectangularName+`
                vec3 `+this._reflectionVectorName+" = computeEquirectangularCoords("+i+", "+e+", "+c+".xyz, "+o+`);
            #endif

            #ifdef `+this._defineSphericalName+`
                vec3 `+this._reflectionVectorName+" = computeSphericalCoords("+i+", "+e+", "+_+", "+o+`);
            #endif

            #ifdef `+this._definePlanarName+`
                vec3 `+this._reflectionVectorName+" = computePlanarCoords("+i+", "+e+", "+c+".xyz, "+o+`);
            #endif

            #ifdef `+this._defineCubicName+`
                #ifdef `+this._defineLocalCubicName+`
                    vec3 `+this._reflectionVectorName+" = computeCubicLocalCoords("+i+", "+e+", "+c+".xyz, "+o+`, vReflectionSize, vReflectionPosition);
                #else
                vec3 `+this._reflectionVectorName+" = computeCubicCoords("+i+", "+e+", "+c+".xyz, "+o+`);
                #endif
            #endif

            #ifdef `+this._defineProjectionName+`
                vec3 `+this._reflectionVectorName+" = computeProjectionCoords("+i+", "+_+", "+o+`);
            #endif

            #ifdef `+this._defineSkyboxName+`
                vec3 `+this._reflectionVectorName+" = computeSkyBoxCoords("+s+", "+o+`);
            #endif

            #ifdef `+this._defineExplicitName+`
                vec3 `+this._reflectionVectorName+` = vec3(0, 0, 0);
            #endif

            #ifdef `+this._defineOppositeZ+`
                `+this._reflectionVectorName+`.z *= -1.0;
            #endif\r
`;return r||(b+=`
                #ifdef `+this._define3DName+`
                    vec3 `+this._reflectionCoordsName+" = "+this._reflectionVectorName+`;
                #else
                    vec2 `+this._reflectionCoordsName+" = "+this._reflectionVectorName+`.xy;
                    #ifdef `+this._defineProjectionName+`
                        `+this._reflectionCoordsName+" /= "+this._reflectionVectorName+`.z;
                    #endif
                    `+this._reflectionCoordsName+".y = 1.0 - "+this._reflectionCoordsName+`.y;
                #endif\r
`),b},t.prototype.handleFragmentSideCodeReflectionColor=function(e,i){i===void 0&&(i=".rgb");var r="vec"+(i.length===0?"4":i.length-1),o=r+" "+this._reflectionColorName+`;
            #ifdef `+this._define3DName+`\r
`;return e?o+=this._reflectionColorName+" = textureCubeLodEXT("+this._cubeSamplerName+", "+this._reflectionVectorName+", "+e+")"+i+`;\r
`:o+=this._reflectionColorName+" = textureCube("+this._cubeSamplerName+", "+this._reflectionVectorName+")"+i+`;\r
`,o+=`
            #else\r
`,e?o+=this._reflectionColorName+" = texture2DLodEXT("+this._2DSamplerName+", "+this._reflectionCoordsName+", "+e+")"+i+`;\r
`:o+=this._reflectionColorName+" = texture2D("+this._2DSamplerName+", "+this._reflectionCoordsName+")"+i+`;\r
`,o+=`#endif\r
`,o},t.prototype.writeOutputs=function(e,i){var r="";if(e.target===ve.Fragment)for(var o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&(r+=this._declareOutput(s,e)+" = "+i+"."+s.name+`;\r
`)}return r},t.prototype._buildBlock=function(e){return n.prototype._buildBlock.call(this,e),this},t.prototype._dumpPropertiesCode=function(){if(!this.texture)return"";var e;if(this.texture.isCube){var i=this.texture.forcedExtension;e=this._codeVariableName+'.texture = new BABYLON.CubeTexture("'+this.texture.name+'", undefined, undefined, '+this.texture.noMipmap+", null, undefined, undefined, undefined, "+this.texture._prefiltered+", "+(i?'"'+i+'"':"null")+`);\r
`}else e=this._codeVariableName+'.texture = new BABYLON.Texture("'+this.texture.name+`", null);\r
`;return e+=this._codeVariableName+".texture.coordinatesMode = "+this.texture.coordinatesMode+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),e.texture&&(r=e.texture.url.indexOf("data:")===0?"":r,e.texture.isCube?this.texture=pn.a.Parse(e.texture,i,r):this.texture=Ze.a.Parse(e.texture,i,r))},t}(nt);f.a.RegisteredTypes["BABYLON.ReflectionTextureBaseBlock"]=ks;var Jc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.registerInput("position",ie.Vector3,!1,ve.Vertex),i.registerInput("worldPosition",ie.Vector4,!1,ve.Vertex),i.registerInput("worldNormal",ie.Vector4,!1,ve.Fragment),i.registerInput("world",ie.Matrix,!1,ve.Vertex),i.registerInput("cameraPosition",ie.Vector3,!1,ve.Fragment),i.registerInput("view",ie.Matrix,!1,ve.Fragment),i.registerOutput("rgb",ie.Color3,ve.Fragment),i.registerOutput("rgba",ie.Color4,ve.Fragment),i.registerOutput("r",ie.Float,ve.Fragment),i.registerOutput("g",ie.Float,ve.Fragment),i.registerOutput("b",ie.Float,ve.Fragment),i.registerOutput("a",ie.Float,ve.Fragment),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),i}return t.prototype.getClassName=function(){return"ReflectionTextureBlock"},Object.defineProperty(t.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(n.prototype.autoConfigure.call(this,e),!this.cameraPosition.isConnected){var i=e.getInputBlockByPredicate(function(r){return r.systemValue===mt.CameraPosition});i||(i=new bt("cameraPosition"),i.setAsSystemValue(mt.CameraPosition)),i.output.connectTo(this.cameraPosition)}},t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec3(0.)"),this;if(e.target!==ve.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.handleFragmentSideInits(e);var i=e._getFreeVariableName("normalWUnit");return e.compilationString+="vec4 "+i+" = normalize("+this.worldNormal.associatedVariableName+`);\r
`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(i),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this},t}(ks);f.a.RegisteredTypes["BABYLON.ReflectionTextureBlock"]=Jc;var $c=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"AddBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.left.associatedVariableName+" + "+this.right.associatedVariableName+`;\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.AddBlock"]=$c;var qc=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("input",ie.AutoDetect),i.registerInput("factor",ie.Float),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"ScaleBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"factor",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.input.associatedVariableName+" * "+this.factor.associatedVariableName+`;\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.ScaleBlock"]=qc;var ef=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.minimum=0,i.maximum=1,i.registerInput("value",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"ClampBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = clamp("+this.value.associatedVariableName+", "+this._writeFloat(this.minimum)+", "+this._writeFloat(this.maximum)+`);\r
`),this},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".minimum = "+this.minimum+`;\r
`;return e+=this._codeVariableName+".maximum = "+this.maximum+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.minimum=this.minimum,e.maximum=this.maximum,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.minimum=e.minimum,this.maximum=e.maximum},Object(p.c)([Lt("Minimum",Dt.Float)],t.prototype,"minimum",void 0),Object(p.c)([Lt("Maximum",Dt.Float)],t.prototype,"maximum",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.ClampBlock"]=ef;var tf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.Vector3),i._linkConnectionTypes(0,1),i._inputs[0].excludedConnectionPointTypes.push(ie.Float),i._inputs[0].excludedConnectionPointTypes.push(ie.Matrix),i._inputs[0].excludedConnectionPointTypes.push(ie.Vector2),i._inputs[1].excludedConnectionPointTypes.push(ie.Float),i._inputs[1].excludedConnectionPointTypes.push(ie.Matrix),i._inputs[1].excludedConnectionPointTypes.push(ie.Vector2),i}return t.prototype.getClassName=function(){return"CrossBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = cross("+this.left.associatedVariableName+".xyz, "+this.right.associatedVariableName+`.xyz);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.CrossBlock"]=tf;var rf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.Float),i._linkConnectionTypes(0,1),i._inputs[0].excludedConnectionPointTypes.push(ie.Float),i._inputs[0].excludedConnectionPointTypes.push(ie.Matrix),i._inputs[1].excludedConnectionPointTypes.push(ie.Float),i._inputs[1].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"DotBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = dot("+this.left.associatedVariableName+", "+this.right.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.DotBlock"]=rf;var nf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("input",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._inputs[0].excludedConnectionPointTypes.push(ie.Float),i._inputs[0].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"NormalizeBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this._inputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = normalize("+r.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.NormalizeBlock"]=nf;var of=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("rgb ",ie.Color3,!0),i.registerInput("r",ie.Float,!0),i.registerInput("g",ie.Float,!0),i.registerInput("b",ie.Float,!0),i.registerInput("a",ie.Float,!0),i.registerOutput("rgba",ie.Color4),i.registerOutput("rgb",ie.Color3),i}return t.prototype.getClassName=function(){return"ColorMergerBlock"},Object.defineProperty(t.prototype,"rgbIn",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgbOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rgb",{get:function(){return this.rgbOut},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.r,r=this.g,o=this.b,a=this.a,s=this.rgbIn,c=this._outputs[0],_=this._outputs[1];return s.isConnected?c.hasEndpoints?e.compilationString+=this._declareOutput(c,e)+(" = vec4("+s.associatedVariableName+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):_.hasEndpoints&&(e.compilationString+=this._declareOutput(_,e)+(" = "+s.associatedVariableName+`;\r
`)):c.hasEndpoints?e.compilationString+=this._declareOutput(c,e)+(" = vec4("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+", "+(o.isConnected?this._writeVariable(o):"0.0")+", "+(a.isConnected?this._writeVariable(a):"0.0")+`);\r
`):_.hasEndpoints&&(e.compilationString+=this._declareOutput(_,e)+(" = vec3("+(i.isConnected?this._writeVariable(i):"0.0")+", "+(r.isConnected?this._writeVariable(r):"0.0")+", "+(o.isConnected?this._writeVariable(o):"0.0")+`);\r
`)),this},t}(nt);f.a.RegisteredTypes["BABYLON.ColorMergerBlock"]=of;var af=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("xyzw",ie.Vector4,!0),i.registerInput("xyz ",ie.Vector3,!0),i.registerInput("xy ",ie.Vector2,!0),i.registerOutput("xyz",ie.Vector3),i.registerOutput("xy",ie.Vector2),i.registerOutput("x",ie.Float),i.registerOutput("y",ie.Float),i.registerOutput("z",ie.Float),i.registerOutput("w",ie.Float),i.inputsAreExclusive=!0,i}return t.prototype.getClassName=function(){return"VectorSplitterBlock"},Object.defineProperty(t.prototype,"xyzw",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyIn",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyzOut",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xyOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"w",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),t.prototype._inputRename=function(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}},t.prototype._outputRename=function(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,r=this._outputs[0],o=this._outputs[1],a=this._outputs[2],s=this._outputs[3],c=this._outputs[4],_=this._outputs[5];return r.hasEndpoints&&(i===this.xyIn?e.compilationString+=this._declareOutput(r,e)+(" = vec3("+i.associatedVariableName+`, 0.0);\r
`):e.compilationString+=this._declareOutput(r,e)+(" = "+i.associatedVariableName+`.xyz;\r
`)),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+(" = "+i.associatedVariableName+`.xy;\r
`)),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+(" = "+i.associatedVariableName+`.x;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+(" = "+i.associatedVariableName+`.y;\r
`)),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+(" = "+i.associatedVariableName+`.z;\r
`)),_.hasEndpoints&&(e.compilationString+=this._declareOutput(_,e)+(" = "+i.associatedVariableName+`.w;\r
`)),this},t}(nt);f.a.RegisteredTypes["BABYLON.VectorSplitterBlock"]=af;var sf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerInput("gradient",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i._linkConnectionTypes(1,2,!0),i._inputs[2].acceptedConnectionPointTypes.push(ie.Float),i}return t.prototype.getClassName=function(){return"LerpBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gradient",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = mix("+this.left.associatedVariableName+" , "+this.right.associatedVariableName+", "+this.gradient.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.LerpBlock"]=sf;var lf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"DivideBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.left.associatedVariableName+" / "+this.right.associatedVariableName+`;\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.DivideBlock"]=lf;var uf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"SubtractBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = "+this.left.associatedVariableName+" - "+this.right.associatedVariableName+`;\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.SubtractBlock"]=uf;var cf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("value",ie.Float),i.registerInput("edge",ie.Float),i.registerOutput("output",ie.Float),i}return t.prototype.getClassName=function(){return"StepBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"edge",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = step("+this.edge.associatedVariableName+", "+this.value.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.StepBlock"]=cf;var Xs=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("input",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._outputs[0].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"OneMinusBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = 1. - "+this.input.associatedVariableName+`;\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.OneMinusBlock"]=Xs,f.a.RegisteredTypes["BABYLON.OppositeBlock"]=Xs;var Ys=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("worldPosition",ie.Vector4),i.registerInput("cameraPosition",ie.Vector3),i.registerOutput("output",ie.Vector3),i}return t.prototype.getClassName=function(){return"ViewDirectionBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var i=e.getInputBlockByPredicate(function(r){return r.systemValue===mt.CameraPosition});i||(i=new bt("cameraPosition"),i.setAsSystemValue(mt.CameraPosition)),i.output.connectTo(this.cameraPosition)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = normalize("+this.cameraPosition.associatedVariableName+" - "+this.worldPosition.associatedVariableName+`.xyz);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.ViewDirectionBlock"]=Ys;var ay=u(762),ff=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("worldNormal",ie.Vector4),i.registerInput("viewDirection",ie.Vector3),i.registerInput("bias",ie.Float),i.registerInput("power",ie.Float),i.registerOutput("fresnel",ie.Float),i}return t.prototype.getClassName=function(){return"FresnelBlock"},Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"viewDirection",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bias",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"power",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fresnel",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.viewDirection.isConnected){var i=new Ys("View direction");i.output.connectTo(this.viewDirection),i.autoConfigure(e)}if(!this.bias.isConnected){var r=new bt("bias");r.value=0,r.output.connectTo(this.bias)}if(!this.power.isConnected){var o=new bt("power");o.value=1,o.output.connectTo(this.power)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i="//"+this.name;return e._emitFunctionFromInclude("fresnelFunction",i,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+(" = computeFresnelTerm("+this.viewDirection.associatedVariableName+".xyz, "+this.worldNormal.associatedVariableName+".xyz, "+this.bias.associatedVariableName+", "+this.power.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.FresnelBlock"]=ff;var hf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"MaxBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = max("+this.left.associatedVariableName+", "+this.right.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.MaxBlock"]=hf;var df=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"MinBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = min("+this.left.associatedVariableName+", "+this.right.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.MinBlock"]=df;var pf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.Float),i._linkConnectionTypes(0,1),i._inputs[0].excludedConnectionPointTypes.push(ie.Float),i._inputs[0].excludedConnectionPointTypes.push(ie.Matrix),i._inputs[1].excludedConnectionPointTypes.push(ie.Float),i._inputs[1].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"DistanceBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = length("+this.left.associatedVariableName+" - "+this.right.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.DistanceBlock"]=pf;var mf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("value",ie.AutoDetect),i.registerOutput("output",ie.Float),i._inputs[0].excludedConnectionPointTypes.push(ie.Float),i._inputs[0].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"LengthBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = length("+this.value.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.LengthBlock"]=mf;var gf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("value",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"NegateBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = -1.0 * "+this.value.associatedVariableName+`;\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.NegateBlock"]=gf;var vf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("value",ie.AutoDetect),i.registerInput("power",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"PowBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"power",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = pow("+this.value.associatedVariableName+", "+this.power.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.PowBlock"]=vf;var _f=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("seed",ie.Vector2),i.registerOutput("output",ie.Float),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color4),i}return t.prototype.getClassName=function(){return"RandomNumberBlock"},Object.defineProperty(t.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r="//"+this.name;return e._emitFunctionFromInclude("helperFunctions",r),e.compilationString+=this._declareOutput(i,e)+(" = getRand("+this.seed.associatedVariableName+`.xy);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.RandomNumberBlock"]=_f;var yf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("x",ie.Float),i.registerInput("y",ie.Float),i.registerOutput("output",ie.Float),i}return t.prototype.getClassName=function(){return"ArcTan2Block"},Object.defineProperty(t.prototype,"x",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = atan("+this.x.associatedVariableName+", "+this.y.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.ArcTan2Block"]=yf;var bf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("value",ie.AutoDetect),i.registerInput("edge0",ie.Float),i.registerInput("edge1",ie.Float),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i}return t.prototype.getClassName=function(){return"SmoothStepBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"edge0",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"edge1",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = smoothstep("+this.edge0.associatedVariableName+", "+this.edge1.associatedVariableName+", "+this.value.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.SmoothStepBlock"]=bf;var Ef=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("input",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._outputs[0].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"ReciprocalBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = 1. / "+this.input.associatedVariableName+`;\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.ReciprocalBlock"]=Ef;var Pf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("value",ie.AutoDetect),i.registerInput("reference",ie.AutoDetect),i.registerInput("distance",ie.Float),i.registerInput("replacement",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i._linkConnectionTypes(0,3),i._inputs[0].excludedConnectionPointTypes.push(ie.Float),i._inputs[0].excludedConnectionPointTypes.push(ie.Matrix),i._inputs[1].excludedConnectionPointTypes.push(ie.Float),i._inputs[1].excludedConnectionPointTypes.push(ie.Matrix),i._inputs[3].excludedConnectionPointTypes.push(ie.Float),i._inputs[3].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"ReplaceColorBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reference",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"distance",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"replacement",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+`;\r
`,e.compilationString+="if (length("+this.value.associatedVariableName+" - "+this.reference.associatedVariableName+") < "+this.distance.associatedVariableName+`) {\r
`,e.compilationString+=i.associatedVariableName+" = "+this.replacement.associatedVariableName+`;\r
`,e.compilationString+=`} else {\r
`,e.compilationString+=i.associatedVariableName+" = "+this.value.associatedVariableName+`;\r
`,e.compilationString+=`}\r
`,this},t}(nt);f.a.RegisteredTypes["BABYLON.ReplaceColorBlock"]=Pf;var Cf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("value",ie.AutoDetect),i.registerInput("steps",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i._inputs[0].excludedConnectionPointTypes.push(ie.Matrix),i._inputs[1].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"PosterizeBlock"},Object.defineProperty(t.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"steps",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = floor("+this.value.associatedVariableName+" / (1.0 / "+this.steps.associatedVariableName+")) * (1.0 / "+this.steps.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.PosterizeBlock"]=Cf;var mn;(function(n){n[n.SawTooth=0]="SawTooth",n[n.Square=1]="Square",n[n.Triangle=2]="Triangle"})(mn||(mn={}));var Sf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.kind=mn.SawTooth,i.registerInput("input",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._inputs[0].excludedConnectionPointTypes.push(ie.Matrix),i}return t.prototype.getClassName=function(){return"WaveBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];switch(this.kind){case mn.SawTooth:{e.compilationString+=this._declareOutput(i,e)+(" = "+this.input.associatedVariableName+" - floor(0.5 + "+this.input.associatedVariableName+`);\r
`);break}case mn.Square:{e.compilationString+=this._declareOutput(i,e)+(" = 1.0 - 2.0 * round(fract("+this.input.associatedVariableName+`));\r
`);break}case mn.Triangle:{e.compilationString+=this._declareOutput(i,e)+(" = 2.0 * abs(2.0 * ("+this.input.associatedVariableName+" - floor(0.5 + "+this.input.associatedVariableName+`))) - 1.0;\r
`);break}}return this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.kind=this.kind,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.kind=e.kind},t}(nt);f.a.RegisteredTypes["BABYLON.WaveBlock"]=Sf;var aa=function(){function n(t,e){this.step=t,this.color=e}return Object.defineProperty(n.prototype,"step",{get:function(){return this._step},set:function(t){this._step=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!1,configurable:!0}),n}(),Tf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.colorSteps=[new aa(0,v.a.Black()),new aa(1,v.a.White())],i.onValueChangedObservable=new g.c,i.registerInput("gradient",ie.Float),i.registerOutput("output",ie.Color3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector2),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color4),i}return t.prototype.colorStepsUpdated=function(){this.onValueChangedObservable.notifyObservers(this)},t.prototype.getClassName=function(){return"GradientBlock"},Object.defineProperty(t.prototype,"gradient",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._writeColorConstant=function(e){var i=this.colorSteps[e];return"vec3("+i.color.r+", "+i.color.g+", "+i.color.b+")"},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=this._declareOutput(i,e)+` = vec3(0., 0., 0.);\r
`;return}var r=e._getFreeVariableName("gradientTempColor"),o=e._getFreeVariableName("gradientTempPosition");e.compilationString+="vec3 "+r+" = "+this._writeColorConstant(0)+`;\r
`,e.compilationString+="float "+o+`;\r
`;var a=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==ie.Float&&(a+=".x");for(var s=1;s<this.colorSteps.length;s++){var c=this.colorSteps[s],_=this.colorSteps[s-1];e.compilationString+=o+" = clamp(("+a+" - "+e._emitFloat(_.step)+") / ("+e._emitFloat(c.step)+" -  "+e._emitFloat(_.step)+"), 0.0, 1.0) * step("+e._emitFloat(s)+", "+e._emitFloat(this.colorSteps.length-1)+`);\r
`,e.compilationString+=r+" = mix("+r+", "+this._writeColorConstant(s)+", "+o+`);\r
`}return e.compilationString+=this._declareOutput(i,e)+(" = "+r+`;\r
`),this},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);e.colorSteps=[];for(var i=0,r=this.colorSteps;i<r.length;i++){var o=r[i];e.colorSteps.push({step:o.step,color:{r:o.color.r,g:o.color.g,b:o.color.b}})}return e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.colorSteps=[];for(var o=0,a=e.colorSteps;o<a.length;o++){var s=a[o];this.colorSteps.push(new aa(s.step,new v.a(s.color.r,s.color.g,s.color.b)))}},t.prototype._dumpPropertiesCode=function(){var e="";e+=this._codeVariableName+`.colorSteps = [];\r
`;for(var i=0,r=this.colorSteps;i<r.length;i++){var o=r[i];e+=this._codeVariableName+".colorSteps.push(new BABYLON.GradientBlockColorStep("+o.step+", new BABYLON.Color3("+o.color.r+", "+o.color.g+", "+o.color.b+`)));\r
`}return e},t}(nt);f.a.RegisteredTypes["BABYLON.GradientBlock"]=Tf;var Af=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerInput("gradient",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i._linkConnectionTypes(1,2,!0),i._inputs[2].acceptedConnectionPointTypes.push(ie.Float),i}return t.prototype.getClassName=function(){return"NLerpBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gradient",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = normalize(mix("+this.left.associatedVariableName+" , "+this.right.associatedVariableName+", "+this.gradient.associatedVariableName+`));\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.NLerpBlock"]=Af;var Rf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.manhattanDistance=!1,i.registerInput("seed",ie.Vector3),i.registerInput("jitter",ie.Float),i.registerOutput("output",ie.Vector2),i}return t.prototype.getClassName=function(){return"WorleyNoise3DBlock"},Object.defineProperty(t.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"jitter",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!!this._outputs[0].hasEndpoints){var i=`vec3 permute(vec3 x){\r
`;return i+=`    return mod((34.0 * x + 1.0) * x, 289.0);\r
`,i+=`}\r
\r
`,i+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r
`,i+=`    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r
`,i+=`}\r
\r
`,i+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r
`,i+=`    float K = 0.142857142857; // 1/7\r
`,i+=`    float Ko = 0.428571428571; // 1/2-K/2\r
`,i+=`    float  K2 = 0.020408163265306; // 1/(7*7)\r
`,i+=`    float Kz = 0.166666666667; // 1/6\r
`,i+=`    float Kzo = 0.416666666667; // 1/2-1/6*2\r
`,i+=`\r
`,i+=`    vec3 Pi = mod(floor(P), 289.0);\r
`,i+=`    vec3 Pf = fract(P) - 0.5;\r
`,i+=`\r
`,i+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r
`,i+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r
`,i+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r
`,i+=`\r
`,i+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r
`,i+=`    vec3 p1 = permute(p + Pi.y - 1.0);\r
`,i+=`    vec3 p2 = permute(p + Pi.y);\r
`,i+=`    vec3 p3 = permute(p + Pi.y + 1.0);\r
`,i+=`\r
`,i+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);\r
`,i+=`    vec3 p12 = permute(p1 + Pi.z);\r
`,i+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);\r
`,i+=`\r
`,i+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);\r
`,i+=`    vec3 p22 = permute(p2 + Pi.z);\r
`,i+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);\r
`,i+=`\r
`,i+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);\r
`,i+=`    vec3 p32 = permute(p3 + Pi.z);\r
`,i+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);\r
`,i+=`\r
`,i+=`    vec3 ox11 = fract(p11*K) - Ko;\r
`,i+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r
`,i+=`\r
`,i+=`    vec3 ox12 = fract(p12*K) - Ko;\r
`,i+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox13 = fract(p13*K) - Ko;\r
`,i+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox21 = fract(p21*K) - Ko;\r
`,i+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox22 = fract(p22*K) - Ko;\r
`,i+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox23 = fract(p23*K) - Ko;\r
`,i+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox31 = fract(p31*K) - Ko;\r
`,i+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox32 = fract(p32*K) - Ko;\r
`,i+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 ox33 = fract(p33*K) - Ko;\r
`,i+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r
`,i+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r
`,i+=`\r
`,i+=`    vec3 dx11 = Pfx + jitter*ox11;\r
`,i+=`    vec3 dy11 = Pfy.x + jitter*oy11;\r
`,i+=`    vec3 dz11 = Pfz.x + jitter*oz11;\r
`,i+=`\r
`,i+=`    vec3 dx12 = Pfx + jitter*ox12;\r
`,i+=`    vec3 dy12 = Pfy.x + jitter*oy12;\r
`,i+=`    vec3 dz12 = Pfz.y + jitter*oz12;\r
`,i+=`\r
`,i+=`    vec3 dx13 = Pfx + jitter*ox13;\r
`,i+=`    vec3 dy13 = Pfy.x + jitter*oy13;\r
`,i+=`    vec3 dz13 = Pfz.z + jitter*oz13;\r
`,i+=`\r
`,i+=`    vec3 dx21 = Pfx + jitter*ox21;\r
`,i+=`    vec3 dy21 = Pfy.y + jitter*oy21;\r
`,i+=`    vec3 dz21 = Pfz.x + jitter*oz21;\r
`,i+=`\r
`,i+=`    vec3 dx22 = Pfx + jitter*ox22;\r
`,i+=`    vec3 dy22 = Pfy.y + jitter*oy22;\r
`,i+=`    vec3 dz22 = Pfz.y + jitter*oz22;\r
`,i+=`\r
`,i+=`    vec3 dx23 = Pfx + jitter*ox23;\r
`,i+=`    vec3 dy23 = Pfy.y + jitter*oy23;\r
`,i+=`    vec3 dz23 = Pfz.z + jitter*oz23;\r
`,i+=`\r
`,i+=`    vec3 dx31 = Pfx + jitter*ox31;\r
`,i+=`    vec3 dy31 = Pfy.z + jitter*oy31;\r
`,i+=`    vec3 dz31 = Pfz.x + jitter*oz31;\r
`,i+=`\r
`,i+=`    vec3 dx32 = Pfx + jitter*ox32;\r
`,i+=`    vec3 dy32 = Pfy.z + jitter*oy32;\r
`,i+=`    vec3 dz32 = Pfz.y + jitter*oz32;\r
`,i+=`\r
`,i+=`    vec3 dx33 = Pfx + jitter*ox33;\r
`,i+=`    vec3 dy33 = Pfy.z + jitter*oy33;\r
`,i+=`    vec3 dz33 = Pfz.z + jitter*oz33;\r
`,i+=`\r
`,i+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r
`,i+=`    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r
`,i+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r
`,i+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r
`,i+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r
`,i+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r
`,i+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r
`,i+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r
`,i+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r
`,i+=`\r
`,i+=`    vec3 d1a = min(d11, d12);\r
`,i+=`    d12 = max(d11, d12);\r
`,i+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r
`,i+=`    d13 = max(d1a, d13);\r
`,i+=`    d12 = min(d12, d13); // 2nd smallest now not in d13\r
`,i+=`    vec3 d2a = min(d21, d22);\r
`,i+=`    d22 = max(d21, d22);\r
`,i+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r
`,i+=`    d23 = max(d2a, d23);\r
`,i+=`    d22 = min(d22, d23); // 2nd smallest now not in d23\r
`,i+=`    vec3 d3a = min(d31, d32);\r
`,i+=`    d32 = max(d31, d32);\r
`,i+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r
`,i+=`    d33 = max(d3a, d33);\r
`,i+=`    d32 = min(d32, d33); // 2nd smallest now not in d33\r
`,i+=`    vec3 da = min(d11, d21);\r
`,i+=`    d21 = max(d11, d21);\r
`,i+=`    d11 = min(da, d31); // Smallest now in d11\r
`,i+=`    d31 = max(da, d31); // 2nd smallest now not in d31\r
`,i+=`    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r
`,i+=`    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r
`,i+=`    d12 = min(d12, d21); // 2nd smallest now not in d21\r
`,i+=`    d12 = min(d12, d22); // nor in d22\r
`,i+=`    d12 = min(d12, d31); // nor in d31\r
`,i+=`    d12 = min(d12, d32); // nor in d32\r
`,i+=`    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r
`,i+=`    d11.y = min(d11.y,d12.z); // Only two more to go\r
`,i+=`    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r
`,i+=`    return sqrt(d11.xy); // F1, F2\r
`,i+=`}\r
\r
`,e._emitFunction("worley3D",i,"// Worley3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+(" = worley("+this.seed.associatedVariableName+", "+this.jitter.associatedVariableName+", "+this.manhattanDistance+`);\r
`),this}},t.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName+".manhattanDistance = "+this.manhattanDistance+`;\r
`;return e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.manhattanDistance=this.manhattanDistance,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.manhattanDistance=e.manhattanDistance},Object(p.c)([Lt("Use Manhattan Distance",Dt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],t.prototype,"manhattanDistance",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.WorleyNoise3DBlock"]=Rf;var Of=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("seed",ie.Vector3),i.registerOutput("output",ie.Float),i}return t.prototype.getClassName=function(){return"SimplexPerlin3DBlock"},Object.defineProperty(t.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!!this._outputs[0].hasEndpoints){var i=`const float SKEWFACTOR = 1.0/3.0;\r
`;return i+=`const float UNSKEWFACTOR = 1.0/6.0;\r
`,i+=`const float SIMPLEX_CORNER_POS = 0.5;\r
`,i+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r
`,i+=`float SimplexPerlin3D( vec3 P ){\r
`,i+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r
`,i+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",i+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r
`,i+=`    vec3 g = step(x0.yzx, x0.xyz);\r
`,i+=`    vec3 l = 1.0 - g;\r
`,i+=`    vec3 Pi_1 = min( g.xyz, l.zxy );\r
`,i+=`    vec3 Pi_2 = max( g.xyz, l.zxy );\r
`,i+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r
`,i+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r
`,i+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r
`,i+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r
`,i+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r
`,i+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r
`,i+=`    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r
`,i+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r
`,i+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r
`,i+=`    Pt *= Pt;\r
`,i+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r
`,i+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r
`,i+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r
`,i+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r
`,i+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r
`,i+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r
`,i+=`    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,i+=`    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,i+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r
`,i+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r
`,i+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r
`,i+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r
`,i+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r
`,i+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r
`,i+=`    kernel_weights = max(0.5 - kernel_weights, 0.0);\r
`,i+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r
`,i+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r
`,i+=`}\r
`,e._emitFunction("SimplexPerlin3D",i,"// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+(" = SimplexPerlin3D("+this.seed.associatedVariableName+`);\r
`),this}},t}(nt);f.a.RegisteredTypes["BABYLON.SimplexPerlin3DBlock"]=Of;var Mf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("normalMap0",ie.Vector3),i.registerInput("normalMap1",ie.Vector3),i.registerOutput("output",ie.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color4),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),i._inputs[1].acceptedConnectionPointTypes.push(ie.Color3),i._inputs[1].acceptedConnectionPointTypes.push(ie.Color4),i._inputs[1].acceptedConnectionPointTypes.push(ie.Vector4),i}return t.prototype.getClassName=function(){return"NormalBlendBlock"},Object.defineProperty(t.prototype,"normalMap0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalMap1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this._inputs[0],o=this._inputs[1],a=e._getFreeVariableName("stepR"),s=e._getFreeVariableName("stepG");return e.compilationString+="float "+a+" = step(0.5, "+r.associatedVariableName+`.r);\r
`,e.compilationString+="float "+s+" = step(0.5, "+r.associatedVariableName+`.g);\r
`,e.compilationString+=this._declareOutput(i,e)+`;\r
`,e.compilationString+=i.associatedVariableName+".r = (1.0 - "+a+") * "+r.associatedVariableName+".r * "+o.associatedVariableName+".r * 2.0 + "+a+" * (1.0 - "+r.associatedVariableName+".r) * (1.0 - "+o.associatedVariableName+`.r) * 2.0;\r
`,e.compilationString+=i.associatedVariableName+".g = (1.0 - "+s+") * "+r.associatedVariableName+".g * "+o.associatedVariableName+".g * 2.0 + "+s+" * (1.0 - "+r.associatedVariableName+".g) * (1.0 - "+o.associatedVariableName+`.g) * 2.0;\r
`,e.compilationString+=i.associatedVariableName+".b = "+r.associatedVariableName+".b * "+o.associatedVariableName+`.b;\r
`,this},t}(nt);f.a.RegisteredTypes["BABYLON.NormalBlendBlock"]=Mf;var xf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("input",ie.Vector2),i.registerInput("angle",ie.Float),i.registerOutput("output",ie.Vector2),i}return t.prototype.getClassName=function(){return"Rotate2dBlock"},Object.defineProperty(t.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"angle",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.angle.isConnected){var i=new bt("angle");i.value=0,i.output.connectTo(this.angle)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this.angle,o=this.input;return e.compilationString+=this._declareOutput(i,e)+(" = vec2(cos("+r.associatedVariableName+") * "+o.associatedVariableName+".x - sin("+r.associatedVariableName+") * "+o.associatedVariableName+".y, sin("+r.associatedVariableName+") * "+o.associatedVariableName+".x + cos("+r.associatedVariableName+") * "+o.associatedVariableName+`.y);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.Rotate2dBlock"]=xf;var Df=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("incident",ie.Vector3),i.registerInput("normal",ie.Vector3),i.registerOutput("output",ie.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color4),i._inputs[1].acceptedConnectionPointTypes.push(ie.Vector4),i._inputs[1].acceptedConnectionPointTypes.push(ie.Color3),i._inputs[1].acceptedConnectionPointTypes.push(ie.Color4),i}return t.prototype.getClassName=function(){return"ReflectBlock"},Object.defineProperty(t.prototype,"incident",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = reflect("+this.incident.associatedVariableName+".xyz, "+this.normal.associatedVariableName+`.xyz);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.ReflectBlock"]=Df;var If=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("incident",ie.Vector3),i.registerInput("normal",ie.Vector3),i.registerInput("ior",ie.Float),i.registerOutput("output",ie.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Vector4),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color3),i._inputs[0].acceptedConnectionPointTypes.push(ie.Color4),i._inputs[1].acceptedConnectionPointTypes.push(ie.Vector4),i._inputs[1].acceptedConnectionPointTypes.push(ie.Color3),i._inputs[1].acceptedConnectionPointTypes.push(ie.Color4),i}return t.prototype.getClassName=function(){return"RefractBlock"},Object.defineProperty(t.prototype,"incident",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ior",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = refract("+this.incident.associatedVariableName+".xyz, "+this.normal.associatedVariableName+".xyz, "+this.ior.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.RefractBlock"]=If;var Lf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("color",ie.Color3),i.registerInput("level",ie.Float),i.registerOutput("output",ie.Color3),i}return t.prototype.getClassName=function(){return"DesaturateBlock"},Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"level",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this.color,o=r.associatedVariableName,a=e._getFreeVariableName("colorMin"),s=e._getFreeVariableName("colorMax"),c=e._getFreeVariableName("colorMerge");return e.compilationString+="float "+a+" = min(min("+o+".x, "+o+".y), "+o+`.z);\r
`,e.compilationString+="float "+s+" = max(max("+o+".x, "+o+".y), "+o+`.z);\r
`,e.compilationString+="float "+c+" = 0.5 * ("+a+" + "+s+`);\r
`,e.compilationString+=this._declareOutput(i,e)+(" = mix("+o+", vec3("+c+", "+c+", "+c+"), "+this.level.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.DesaturateBlock"]=Lf;var yr=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,i,r)||this;return c._blockType=o,c._blockName=a,c._nameForCheking=s,c._nameForCheking||(c._nameForCheking=e),c.needDualDirectionValidation=!0,c}return t.prototype.checkCompatibilityState=function(e){return e instanceof t&&e.name===this._nameForCheking?_r.Compatible:_r.TypeIncompatible},t.prototype.createCustomInputBlock=function(){return[new this._blockType(this._blockName),this.name]},t}(ea),Ks=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i.albedoScaling=!1,i.linkSheenWithAlbedo=!1,i._isUnique=!0,i.registerInput("intensity",ie.Float,!0,ve.Fragment),i.registerInput("color",ie.Color3,!0,ve.Fragment),i.registerInput("roughness",ie.Float,!0,ve.Fragment),i.registerOutput("sheen",ie.Object,ve.Fragment,new yr("sheen",i,Ni.Output,t,"SheenBlock")),i}return t.prototype.initialize=function(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")},t.prototype.getClassName=function(){return"SheenBlock"},Object.defineProperty(t.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"roughness",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sheen",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r),r.setValue("SHEEN",!0),r.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),r.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),r.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),r.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)},t.prototype.getCode=function(e){var i="",r=this.color.isConnected?this.color.associatedVariableName:"vec3(1.)",o=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",a=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",s="vec4(0.)";return i=`#ifdef SHEEN
            sheenOutParams sheenOut;

            vec4 vSheenColor = vec4(`+r+", "+o+`);

            sheenBlock(
                vSheenColor,
            #ifdef SHEEN_ROUGHNESS
                `+a+`,
            #endif
                roughness,
            #ifdef SHEEN_TEXTURE
                `+s+`,
            #endif
                reflectance,
            #ifdef SHEEN_LINKWITHALBEDO
                baseColor,
                surfaceAlbedo,
            #endif
            #ifdef ENVIRONMENTBRDF
                NdotV,
                environmentBrdf,
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                AARoughnessFactors,
                `+(e==null?void 0:e._vReflectionMicrosurfaceInfosName)+`,
                `+(e==null?void 0:e._vReflectionInfosName)+`,
                `+(e==null?void 0:e.reflectionColor)+`,
                vLightingIntensity,
                #ifdef `+(e==null?void 0:e._define3DName)+`
                    `+(e==null?void 0:e._cubeSamplerName)+`,
                #else
                    `+(e==null?void 0:e._2DSamplerName)+`,
                #endif
                reflectionOut.reflectionCoords,
                NdotVUnclamped,
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `+(e==null?void 0:e._define3DName)+`
                        `+(e==null?void 0:e._cubeSamplerName)+`,
                        `+(e==null?void 0:e._cubeSamplerName)+`,
                    #else
                        `+(e==null?void 0:e._2DSamplerName)+`,
                        `+(e==null?void 0:e._2DSamplerName)+`,
                    #endif
                #endif
                #if !defined(`+(e==null?void 0:e._defineSkyboxName)+`) && defined(RADIANCEOCCLUSION)
                    seo,
                #endif
                #if !defined(`+(e==null?void 0:e._defineSkyboxName)+") && defined(HORIZONOCCLUSION) && defined(BUMP) && defined("+(e==null?void 0:e._define3DName)+`)
                    eho,
                #endif
            #endif
                sheenOut
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif\r
`,i},t.prototype._buildBlock=function(e){return e.target===ve.Fragment&&e.sharedData.blocksWithDefines.push(this),this},t.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+=this._codeVariableName+".albedoScaling = "+this.albedoScaling+`;\r
`,e+=this._codeVariableName+".linkSheenWithAlbedo = "+this.linkSheenWithAlbedo+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo},Object(p.c)([Lt("Albedo scaling",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],t.prototype,"albedoScaling",void 0),Object(p.c)([Lt("Link sheen with albedo",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],t.prototype,"linkSheenWithAlbedo",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.SheenBlock"]=Ks;var Ff=u(514),Qs=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i._isUnique=!0,i.registerInput("intensity",ie.Float,!0,ve.Fragment),i.registerInput("direction",ie.Vector2,!0,ve.Fragment),i.registerInput("uv",ie.Vector2,!0),i.registerInput("worldTangent",ie.Vector4,!0),i.registerOutput("anisotropy",ie.Object,ve.Fragment,new yr("anisotropy",i,Ni.Output,t,"AnisotropyBlock")),i}return t.prototype.initialize=function(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")},t.prototype.getClassName=function(){return"AnisotropyBlock"},Object.defineProperty(t.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldTangent",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"anisotropy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._generateTBNSpace=function(e){var i="",r="//"+this.name,o=this.uv,a=this.worldPositionConnectionPoint,s=this.worldNormalConnectionPoint,c=this.worldTangent;o.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var _={search:/defined\(TANGENT\)/g,replace:c.isConnected?"defined(TANGENT)":"defined(IGNORE)"};return c.isConnected&&(i+="vec3 tbnNormal = normalize("+s.associatedVariableName+`.xyz);\r
`,i+="vec3 tbnTangent = normalize("+c.associatedVariableName+`.xyz);\r
`,i+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,i+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),i+=`
            #if defined(`+(c.isConnected?"TANGENT":"IGNORE")+`) && defined(NORMAL)
                mat3 TBN = vTBN;
            #else
                mat3 TBN = cotangent_frame(`+(s.associatedVariableName+".xyz")+", "+("v_"+a.associatedVariableName+".xyz")+", "+(o.isConnected?o.associatedVariableName:"vec2(0.)")+`, vec2(1., 1.));
            #endif\r
`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",r,{replaceStrings:[_]}),i},t.prototype.getCode=function(e,i){i===void 0&&(i=!1);var r="";i&&(r+=this._generateTBNSpace(e));var o=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",a=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)";return r+=`anisotropicOutParams anisotropicOut;
            anisotropicBlock(
                vec3(`+a+", "+o+`),
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW,
                anisotropicOut
            );\r
`,r},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r),r.setValue("ANISOTROPIC",!0),r.setValue("ANISOTROPIC_TEXTURE",!1,!0)},t.prototype._buildBlock=function(e){return e.target===ve.Fragment&&e.sharedData.blocksWithDefines.push(this),this},t}(nt);f.a.RegisteredTypes["BABYLON.AnisotropyBlock"]=Qs;var Zs=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i.useSphericalHarmonics=!0,i.forceIrradianceInFragment=!1,i._isUnique=!0,i.registerInput("position",ie.Vector3,!1,ve.Vertex),i.registerInput("world",ie.Matrix,!1,ve.Vertex),i.registerInput("color",ie.Color3,!0,ve.Fragment),i.registerOutput("reflection",ie.Object,ve.Fragment,new yr("reflection",i,Ni.Output,t,"ReflectionBlock")),i}return t.prototype.getClassName=function(){return"ReflectionBlock"},Object.defineProperty(t.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this.worldPositionConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this.worldNormalConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"world",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this.cameraPositionConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this.viewConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflection",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasTexture",{get:function(){return!!this._getTexture()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflectionColor",{get:function(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"},enumerable:!1,configurable:!0}),t.prototype._getTexture=function(){return this.texture?this.texture:this._scene.environmentTexture},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r);var o=this._getTexture(),a=o&&o.getTextureMatrix;r.setValue("REFLECTION",a,!0),!!a&&(r.setValue(this._defineLODReflectionAlpha,o.lodLevelInAlpha,!0),r.setValue(this._defineLinearSpecularReflection,o.linearSpecularLOD,!0),r.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!o.invertZ:o.invertZ,!0),r.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),r.setValue("GAMMAREFLECTION",o.gammaSpace,!0),r.setValue("RGBDREFLECTION",o.isRGBD,!0),o&&o.coordinatesMode!==Ze.a.SKYBOX_MODE&&o.isCube&&(r.setValue("USESPHERICALFROMREFLECTIONMAP",!0),r.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?r.setValue("USESPHERICALINVERTEX",!1):r.setValue("USESPHERICALINVERTEX",!0)))},t.prototype.bind=function(e,i,r,o){n.prototype.bind.call(this,e,i,r);var a=this._getTexture();if(!(!a||!o)){a.isCube?e.setTexture(this._cubeSamplerName,a):e.setTexture(this._2DSamplerName,a);var s=a.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,s,a.lodGenerationScale,a.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,s,$e.a.Log2(s));var c=o._materialDefines,_=a.sphericalPolynomial;if(c.USESPHERICALFROMREFLECTIONMAP&&_)if(c.SPHERICAL_HARMONICS){var b=_.preScaledHarmonics;e.setVector3("vSphericalL00",b.l00),e.setVector3("vSphericalL1_1",b.l1_1),e.setVector3("vSphericalL10",b.l10),e.setVector3("vSphericalL11",b.l11),e.setVector3("vSphericalL2_2",b.l2_2),e.setVector3("vSphericalL2_1",b.l2_1),e.setVector3("vSphericalL20",b.l20),e.setVector3("vSphericalL21",b.l21),e.setVector3("vSphericalL22",b.l22)}else e.setFloat3("vSphericalX",_.x.x,_.x.y,_.x.z),e.setFloat3("vSphericalY",_.y.x,_.y.y,_.y.z),e.setFloat3("vSphericalZ",_.z.x,_.z.y,_.z.z),e.setFloat3("vSphericalXX_ZZ",_.xx.x-_.zz.x,_.xx.y-_.zz.y,_.xx.z-_.zz.z),e.setFloat3("vSphericalYY_ZZ",_.yy.x-_.zz.x,_.yy.y-_.zz.y,_.yy.z-_.zz.z),e.setFloat3("vSphericalZZ",_.zz.x,_.zz.y,_.zz.z),e.setFloat3("vSphericalXY",_.xy.x,_.xy.y,_.xy.z),e.setFloat3("vSphericalYZ",_.yz.x,_.yz.y,_.yz.z),e.setFloat3("vSphericalZX",_.zx.x,_.zx.y,_.zx.z)}},t.prototype.handleVertexSide=function(e){var i=n.prototype.handleVertexSide.call(this,e);e._emitFunctionFromInclude("harmonicsFunctions","//"+this.name,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});var r=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),i+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                vec3 `+r+" = vec3("+this._reflectionMatrixName+" * vec4(normalize("+this.worldNormal.associatedVariableName+`).xyz, 0)).xyz;
                #ifdef `+this._defineOppositeZ+`
                    `+r+`.z *= -1.0;
                #endif
                `+this._vEnvironmentIrradianceName+" = computeEnvironmentIrradiance("+r+`);
            #endif\r
`,i},t.prototype.getCode=function(e,i){var r="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions","//"+this.name,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`
            #ifdef `+this._define3DName+`
                #define sampleReflection(s, c) textureCube(s, c)
            #else
                #define sampleReflection(s, c) texture2D(s, c)
            #endif\r
`,"//"+this.name),e._emitFunction("sampleReflectionLod",`
            #ifdef `+this._define3DName+`
                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`,"//"+this.name);var o=`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                `+this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0)+`
                return `+this._reflectionVectorName+`;
            }\r
`;return e._emitFunction("computeReflectionCoordsPBR",o,"//"+this.name),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),r+=`#ifdef REFLECTION
            vec2 `+this._vReflectionInfosName+` = vec2(1., 0.);

            reflectionOutParams reflectionOut;

            reflectionBlock(
                `+("v_"+this.worldPosition.associatedVariableName+".xyz")+`,
                `+i+`,
                alphaG,
                `+this._vReflectionMicrosurfaceInfosName+`,
                `+this._vReflectionInfosName+`,
                `+this.reflectionColor+`,
            #ifdef ANISOTROPIC
                anisotropicOut,
            #endif
            #if defined(`+this._defineLODReflectionAlpha+") && !defined("+this._defineSkyboxName+`)
                NdotVUnclamped,
            #endif
            #ifdef `+this._defineLinearSpecularReflection+`
                roughness,
            #endif
            #ifdef `+this._define3DName+`
                `+this._cubeSamplerName+`,
            #else
                `+this._2DSamplerName+`,
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                `+this._vEnvironmentIrradianceName+`,
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    `+this._reflectionMatrixName+`,
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                irradianceSampler, // ** not handled **
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef `+this._define3DName+`
                    `+this._cubeSamplerName+`,
                    `+this._cubeSamplerName+`,
                #else
                    `+this._2DSamplerName+`,
                    `+this._2DSamplerName+`,
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                `+this._vReflectionFilteringInfoName+`,
            #endif
                reflectionOut
            );
        #endif\r
`,r},t.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,e.target!==ve.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this},t.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return this.texture&&(e+=this._codeVariableName+".texture.gammaSpace = "+this.texture.gammaSpace+`;\r
`),e+=this._codeVariableName+".useSphericalHarmonics = "+this.useSphericalHarmonics+`;\r
`,e+=this._codeVariableName+".forceIrradianceInFragment = "+this.forceIrradianceInFragment+`;\r
`,e},t.prototype.serialize=function(){var e,i,r=n.prototype.serialize.call(this);return r.useSphericalHarmonics=this.useSphericalHarmonics,r.forceIrradianceInFragment=this.forceIrradianceInFragment,r.gammaSpace=(i=(e=this.texture)===null||e===void 0?void 0:e.gammaSpace)!==null&&i!==void 0?i:!0,r},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)},Object(p.c)([Lt("Spherical Harmonics",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"useSphericalHarmonics",void 0),Object(p.c)([Lt("Force irradiance in fragment",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"forceIrradianceInFragment",void 0),t}(ks);f.a.RegisteredTypes["BABYLON.ReflectionBlock"]=Zs;var Bf=u(626),sa=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i.remapF0OnInterfaceChange=!0,i._isUnique=!0,i.registerInput("intensity",ie.Float,!1,ve.Fragment),i.registerInput("roughness",ie.Float,!0,ve.Fragment),i.registerInput("indexOfRefraction",ie.Float,!0,ve.Fragment),i.registerInput("normalMapColor",ie.Color3,!0,ve.Fragment),i.registerInput("uv",ie.Vector2,!0,ve.Fragment),i.registerInput("tintColor",ie.Color3,!0,ve.Fragment),i.registerInput("tintAtDistance",ie.Float,!0,ve.Fragment),i.registerInput("tintThickness",ie.Float,!0,ve.Fragment),i.registerInput("worldTangent",ie.Vector4,!0),i.registerOutput("clearcoat",ie.Object,ve.Fragment,new yr("clearcoat",i,Ni.Output,t,"ClearCoatBlock")),i}return t.prototype.initialize=function(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams")},t.prototype.getClassName=function(){return"ClearCoatBlock"},Object.defineProperty(t.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"roughness",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"indexOfRefraction",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalMapColor",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uv",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintAtDistance",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintThickness",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldTangent",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clearcoat",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.intensity.isConnected){var i=new bt("ClearCoat intensity",ve.Fragment,ie.Float);i.value=1,i.output.connectTo(this.intensity)}},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r),r.setValue("CLEARCOAT",!0),r.setValue("CLEARCOAT_TEXTURE",!1,!0),r.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),r.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),r.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),r.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===Bf.a._DefaultIndexOfRefraction:!0,!0),r.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)},t.prototype.bind=function(e,i,r,o){var a,s;n.prototype.bind.call(this,e,i,r);var c=(s=(a=this.indexOfRefraction.connectInputBlock)===null||a===void 0?void 0:a.value)!==null&&s!==void 0?s:Bf.a._DefaultIndexOfRefraction,_=1-c,b=1+c,C=Math.pow(-_/b,2),x=1/c;e.setFloat4("vClearCoatRefractionParams",C,x,_,b);var V=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,D=(V==null?void 0:V.perturbedNormal.isConnected)?V.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",(D==null?void 0:D.invertX)?1:-1,(D==null?void 0:D.invertY)?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",(D==null?void 0:D.invertX)?-1:1,(D==null?void 0:D.invertY)?-1:1)},t.prototype._generateTBNSpace=function(e,i,r){var o="",a="//"+this.name,s=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var c={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"};return s.isConnected&&(o+="vec3 tbnNormal = normalize("+r+`.xyz);\r
`,o+="vec3 tbnTangent = normalize("+s.associatedVariableName+`.xyz);\r
`,o+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,o+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",a,{replaceStrings:[c]}),o},t.GetCode=function(e,i,r,o,a,s,c){var _="",b=(i==null?void 0:i.intensity.isConnected)?i.intensity.associatedVariableName:"1.",C=(i==null?void 0:i.roughness.isConnected)?i.roughness.associatedVariableName:"0.",x=(i==null?void 0:i.normalMapColor.isConnected)?i.normalMapColor.associatedVariableName:"vec3(0.)",V=(i==null?void 0:i.uv.isConnected)?i.uv.associatedVariableName:"vec2(0.)",D=(i==null?void 0:i.tintColor.isConnected)?i.tintColor.associatedVariableName:"vec3(1.)",z=(i==null?void 0:i.tintThickness.isConnected)?i.tintThickness.associatedVariableName:"1.",q=(i==null?void 0:i.tintAtDistance.isConnected)?i.tintAtDistance.associatedVariableName:"1.",ue="vec4(0.)";return i&&(e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2")),a&&i&&(_+=i._generateTBNSpace(e,o,c),s=i.worldTangent.isConnected),_+=`clearcoatOutParams clearcoatOut;

        #ifdef CLEARCOAT
            vec2 vClearCoatParams = vec2(`+b+", "+C+`);
            vec4 vClearCoatTintParams = vec4(`+D+", "+z+`);

            clearcoatBlock(
                `+o+`.xyz,
                geometricNormalW,
                viewDirectionW,
                vClearCoatParams,
                specularEnvironmentR0,
            #ifdef CLEARCOAT_TEXTURE
                vec2(0.),
            #endif
            #ifdef CLEARCOAT_TINT
                vClearCoatTintParams,
                `+q+`,
                vClearCoatRefractionParams,
                #ifdef CLEARCOAT_TINT_TEXTURE
                    `+ue+`,
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                vec2(0., 1.),
                vec4(`+x+`, 0.),
                `+V+`,
                #if defined(`+(s?"TANGENT":"IGNORE")+`) && defined(NORMAL)
                    vTBN,
                #else
                    vClearCoatTangentSpaceParams,
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    normalMatrix,
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                faceNormal,
            #endif
            #ifdef REFLECTION
                `+(r==null?void 0:r._vReflectionMicrosurfaceInfosName)+`,
                `+(r==null?void 0:r._vReflectionInfosName)+`,
                `+(r==null?void 0:r.reflectionColor)+`,
                vLightingIntensity,
                #ifdef `+(r==null?void 0:r._define3DName)+`
                    `+(r==null?void 0:r._cubeSamplerName)+`,
                #else
                    `+(r==null?void 0:r._2DSamplerName)+`,
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `+(r==null?void 0:r._define3DName)+`
                        `+(r==null?void 0:r._cubeSamplerName)+`,
                        `+(r==null?void 0:r._cubeSamplerName)+`,
                    #else
                        `+(r==null?void 0:r._2DSamplerName)+`,
                        `+(r==null?void 0:r._2DSamplerName)+`,
                    #endif
                #endif
            #endif
            #if defined(ENVIRONMENTBRDF) && !defined(`+(r==null?void 0:r._defineSkyboxName)+`)
                #ifdef RADIANCEOCCLUSION
                    ambientMonochrome,
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                (gl_FrontFacing ? 1. : -1.),
            #endif
                clearcoatOut
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif\r
`,_},t.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,e.target===ve.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this},t.prototype._dumpPropertiesCode=function(){var e="";return e+=this._codeVariableName+".remapF0OnInterfaceChange = "+this.remapF0OnInterfaceChange+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e},t.prototype._deserialize=function(e,i,r){var o;n.prototype._deserialize.call(this,e,i,r),this.remapF0OnInterfaceChange=(o=e.remapF0OnInterfaceChange)!==null&&o!==void 0?o:!0},Object(p.c)([Lt("Remap F0 on interface change",Dt.Boolean,"ADVANCED")],t.prototype,"remapF0OnInterfaceChange",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.ClearCoatBlock"]=sa;var Js=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i.linkRefractionWithTransparency=!1,i.invertRefractionY=!1,i._isUnique=!0,i.registerInput("intensity",ie.Float,!1,ve.Fragment),i.registerInput("tintAtDistance",ie.Float,!0,ve.Fragment),i.registerOutput("refraction",ie.Object,ve.Fragment,new yr("refraction",i,Ni.Output,t,"RefractionBlock")),i}return t.prototype.getClassName=function(){return"RefractionBlock"},Object.defineProperty(t.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintAtDistance",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this.viewConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"refraction",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasTexture",{get:function(){return!!this._getTexture()},enumerable:!1,configurable:!0}),t.prototype._getTexture=function(){return this.texture?this.texture:this._scene.environmentTexture},t.prototype.autoConfigure=function(e){if(!this.intensity.isConnected){var i=new bt("Refraction intensity",ve.Fragment,ie.Float);i.value=1,i.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){var r=e.getInputBlockByPredicate(function(o){return o.systemValue===mt.View});r||(r=new bt("view"),r.setAsSystemValue(mt.View)),r.output.connectTo(this.view)}},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r);var o=this._getTexture(),a=o&&o.getTextureMatrix;r.setValue("SS_REFRACTION",a,!0),!!a&&(r.setValue(this._define3DName,o.isCube,!0),r.setValue(this._defineLODRefractionAlpha,o.lodLevelInAlpha,!0),r.setValue(this._defineLinearSpecularRefraction,o.linearSpecularLOD,!0),r.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!o.invertZ:o.invertZ,!0),r.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),r.setValue("SS_GAMMAREFRACTION",o.gammaSpace,!0),r.setValue("SS_RGBDREFRACTION",o.isRGBD,!0))},t.prototype.isReady=function(){var e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())},t.prototype.bind=function(e,i,r,o){var a,s;n.prototype.bind.call(this,e,i,r);var c=this._getTexture();if(!!c){c.isCube?e.setTexture(this._cubeSamplerName,c):e.setTexture(this._2DSamplerName,c),e.setMatrix(this._refractionMatrixName,c.getReflectionTextureMatrix());var _=1;c.isCube||c.depth&&(_=c.depth);var b=(s=(a=this.indexOfRefractionConnectionPoint.connectInputBlock)===null||a===void 0?void 0:a.value)!==null&&s!==void 0?s:1.5;e.setFloat4(this._vRefractionInfosName,c.level,1/b,_,this.invertRefractionY?-1:1),e.setFloat3(this._vRefractionMicrosurfaceInfosName,c.getSize().width,c.lodGenerationScale,c.lodGenerationOffset);var C=c.getSize().width;e.setFloat2(this._vRefractionFilteringInfoName,C,$e.a.Log2(C))}},t.prototype.getCode=function(e){var i="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+="#ifdef "+this._define3DName+`\r
`,e._samplerDeclaration+="uniform samplerCube "+this._cubeSamplerName+`;\r
`,e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+="uniform sampler2D "+this._2DSamplerName+`;\r
`,e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`
            #ifdef `+this._define3DName+`
                #define sampleRefraction(s, c) textureCube(s, c)
            #else
                #define sampleRefraction(s, c) texture2D(s, c)
            #endif\r
`,"//"+this.name),e._emitFunction("sampleRefractionLod",`
            #ifdef `+this._define3DName+`
                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`,"//"+this.name),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec3"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),i},t.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,this},t.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return this.texture&&(this.texture.isCube?e=this._codeVariableName+'.texture = new BABYLON.CubeTexture("'+this.texture.name+`");\r
`:e=this._codeVariableName+'.texture = new BABYLON.Texture("'+this.texture.name+`");\r
`,e+=this._codeVariableName+".texture.coordinatesMode = "+this.texture.coordinatesMode+`;\r
`),e+=this._codeVariableName+".linkRefractionWithTransparency = "+this.linkRefractionWithTransparency+`;\r
`,e+=this._codeVariableName+".invertRefractionY = "+this.invertRefractionY+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e},t.prototype._deserialize=function(e,i,r){n.prototype._deserialize.call(this,e,i,r),e.texture&&(r=e.texture.url.indexOf("data:")===0?"":r,e.texture.isCube?this.texture=pn.a.Parse(e.texture,i,r):this.texture=Ze.a.Parse(e.texture,i,r)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY},Object(p.c)([Lt("Link refraction to transparency",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"linkRefractionWithTransparency",void 0),Object(p.c)([Lt("Invert refraction Y",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"invertRefractionY",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.RefractionBlock"]=Js;var la=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Fragment)||this;return i._isUnique=!0,i.registerInput("thickness",ie.Float,!1,ve.Fragment),i.registerInput("tintColor",ie.Color3,!0,ve.Fragment),i.registerInput("translucencyIntensity",ie.Float,!0,ve.Fragment),i.registerInput("translucencyDiffusionDist",ie.Color3,!0,ve.Fragment),i.registerInput("refraction",ie.Object,!0,ve.Fragment,new yr("refraction",i,Ni.Input,Js,"RefractionBlock")),i.registerOutput("subsurface",ie.Object,ve.Fragment,new yr("subsurface",i,Ni.Output,t,"SubSurfaceBlock")),i}return t.prototype.initialize=function(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity")},t.prototype.getClassName=function(){return"SubSurfaceBlock"},Object.defineProperty(t.prototype,"thickness",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tintColor",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"translucencyIntensity",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"translucencyDiffusionDist",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"refraction",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"subsurface",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.thickness.isConnected){var i=new bt("SubSurface thickness",ve.Fragment,ie.Float);i.value=0,i.output.connectTo(this.thickness)}},t.prototype.prepareDefines=function(e,i,r){n.prototype.prepareDefines.call(this,e,i,r);var o=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;r.setValue("SUBSURFACE",o||this.refraction.isConnected,!0),r.setValue("SS_TRANSLUCENCY",o,!0),r.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),r.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),r.setValue("SS_MASK_FROM_THICKNESS_TEXTURE_GLTF",!1,!0)},t.GetCode=function(e,i,r,o){var a,s,c,_,b,C,x,V,D,z,q,ue,ge,Se,Pe,me,xe="",Fe=(i==null?void 0:i.thickness.isConnected)?i.thickness.associatedVariableName:"0.",we=(i==null?void 0:i.tintColor.isConnected)?i.tintColor.associatedVariableName:"vec3(1.)",Ge=(i==null?void 0:i.translucencyIntensity.isConnected)?i==null?void 0:i.translucencyIntensity.associatedVariableName:"1.",Xe=(i==null?void 0:i.translucencyDiffusionDist.isConnected)?i==null?void 0:i.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",Oe=(i==null?void 0:i.refraction.isConnected)?(a=i==null?void 0:i.refraction.connectedPoint)===null||a===void 0?void 0:a.ownerBlock:null,je=(Oe==null?void 0:Oe.tintAtDistance.isConnected)?Oe.tintAtDistance.associatedVariableName:"1.",ke=(Oe==null?void 0:Oe.intensity.isConnected)?Oe.intensity.associatedVariableName:"1.",ze=(Oe==null?void 0:Oe.view.isConnected)?Oe.view.associatedVariableName:"";return xe+=(s=Oe==null?void 0:Oe.getCode(e))!==null&&s!==void 0?s:"",xe+=`subSurfaceOutParams subSurfaceOut;

        #ifdef SUBSURFACE
            vec2 vThicknessParam = vec2(0., `+Fe+`);
            vec4 vTintColor = vec4(`+we+", "+je+`);
            vec3 vSubSurfaceIntensity = vec3(`+ke+", "+Ge+`, 0.);

            subSurfaceBlock(
                vSubSurfaceIntensity,
                vThicknessParam,
                vTintColor,
                normalW,
                specularEnvironmentReflectance,
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                vec4(0.),
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    `+(r==null?void 0:r._reflectionMatrixName)+`,
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            reflectionOut.irradianceVector,
                        #endif
                        #if defined(REALTIME_FILTERING)
                            `+(r==null?void 0:r._cubeSamplerName)+`,
                            `+(r==null?void 0:r._vReflectionFilteringInfoName)+`,
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        irradianceSampler,
                    #endif
                #endif
            #endif
            #ifdef SS_REFRACTION
                `+o+`.xyz,
                viewDirectionW,
                `+ze+`,
                surfaceAlbedo,
                `+((c=Oe==null?void 0:Oe._vRefractionInfosName)!==null&&c!==void 0?c:"")+`,
                `+((_=Oe==null?void 0:Oe._refractionMatrixName)!==null&&_!==void 0?_:"")+`,
                `+((b=Oe==null?void 0:Oe._vRefractionMicrosurfaceInfosName)!==null&&b!==void 0?b:"")+`,
                vLightingIntensity,
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha,
                #endif
                #ifdef `+((C=Oe==null?void 0:Oe._defineLODRefractionAlpha)!==null&&C!==void 0?C:"IGNORE")+`
                    NdotVUnclamped,
                #endif
                #ifdef `+((x=Oe==null?void 0:Oe._defineLinearSpecularRefraction)!==null&&x!==void 0?x:"IGNORE")+`
                    roughness,
                #else
                    alphaG,
                #endif
                #ifdef `+((V=Oe==null?void 0:Oe._define3DName)!==null&&V!==void 0?V:"IGNORE")+`
                    `+((D=Oe==null?void 0:Oe._cubeSamplerName)!==null&&D!==void 0?D:"")+`,
                #else
                    `+((z=Oe==null?void 0:Oe._2DSamplerName)!==null&&z!==void 0?z:"")+`,
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `+((q=Oe==null?void 0:Oe._define3DName)!==null&&q!==void 0?q:"IGNORE")+`
                        `+((ue=Oe==null?void 0:Oe._cubeSamplerName)!==null&&ue!==void 0?ue:"")+`,
                        `+((ge=Oe==null?void 0:Oe._cubeSamplerName)!==null&&ge!==void 0?ge:"")+`,
                    #else
                        `+((Se=Oe==null?void 0:Oe._2DSamplerName)!==null&&Se!==void 0?Se:"")+`,
                        `+((Pe=Oe==null?void 0:Oe._2DSamplerName)!==null&&Pe!==void 0?Pe:"")+`,
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    anisotropicOut,
                #endif
                #ifdef REALTIME_FILTERING
                    `+((me=Oe==null?void 0:Oe._vRefractionFilteringInfoName)!==null&&me!==void 0?me:"")+`,
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                `+Xe+`,
            #endif
                subSurfaceOut
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif\r
`,xe},t.prototype._buildBlock=function(e){return e.target===ve.Fragment&&e.sharedData.blocksWithDefines.push(this),this},t}(nt);f.a.RegisteredTypes["BABYLON.SubSurfaceBlock"]=la;var tg={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]},Nf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.VertexAndFragment)||this;return i._environmentBRDFTexture=null,i._metallicReflectanceColor=v.a.White(),i._metallicF0Factor=1,i.directIntensity=1,i.environmentIntensity=1,i.specularIntensity=1,i.lightFalloff=0,i.useAlphaTest=!1,i.alphaTestCutoff=.5,i.useAlphaBlending=!1,i.useRadianceOverAlpha=!0,i.useSpecularOverAlpha=!0,i.enableSpecularAntiAliasing=!1,i.realTimeFiltering=!1,i.realTimeFilteringQuality=8,i.useEnergyConservation=!0,i.useRadianceOcclusion=!0,i.useHorizonOcclusion=!0,i.unlit=!1,i.forceNormalForward=!1,i.debugMode=0,i.debugLimit=0,i.debugFactor=1,i._isUnique=!0,i.registerInput("worldPosition",ie.Vector4,!1,ve.Vertex),i.registerInput("worldNormal",ie.Vector4,!1,ve.Fragment),i.registerInput("view",ie.Matrix,!1),i.registerInput("cameraPosition",ie.Vector3,!1,ve.Fragment),i.registerInput("perturbedNormal",ie.Vector4,!0,ve.Fragment),i.registerInput("baseColor",ie.Color3,!0,ve.Fragment),i.registerInput("metallic",ie.Float,!1,ve.Fragment),i.registerInput("roughness",ie.Float,!1,ve.Fragment),i.registerInput("ambientOcc",ie.Float,!0,ve.Fragment),i.registerInput("opacity",ie.Float,!0,ve.Fragment),i.registerInput("indexOfRefraction",ie.Float,!0,ve.Fragment),i.registerInput("ambientColor",ie.Color3,!0,ve.Fragment),i.registerInput("reflection",ie.Object,!0,ve.Fragment,new yr("reflection",i,Ni.Input,Zs,"ReflectionBlock")),i.registerInput("clearcoat",ie.Object,!0,ve.Fragment,new yr("clearcoat",i,Ni.Input,sa,"ClearCoatBlock")),i.registerInput("sheen",ie.Object,!0,ve.Fragment,new yr("sheen",i,Ni.Input,Ks,"SheenBlock")),i.registerInput("subsurface",ie.Object,!0,ve.Fragment,new yr("subsurface",i,Ni.Input,la,"SubSurfaceBlock")),i.registerInput("anisotropy",ie.Object,!0,ve.Fragment,new yr("anisotropy",i,Ni.Input,Qs,"AnisotropyBlock")),i.registerOutput("ambientClr",ie.Color3,ve.Fragment),i.registerOutput("diffuseDir",ie.Color3,ve.Fragment),i.registerOutput("specularDir",ie.Color3,ve.Fragment),i.registerOutput("clearcoatDir",ie.Color3,ve.Fragment),i.registerOutput("sheenDir",ie.Color3,ve.Fragment),i.registerOutput("diffuseInd",ie.Color3,ve.Fragment),i.registerOutput("specularInd",ie.Color3,ve.Fragment),i.registerOutput("clearcoatInd",ie.Color3,ve.Fragment),i.registerOutput("sheenInd",ie.Color3,ve.Fragment),i.registerOutput("refraction",ie.Color3,ve.Fragment),i.registerOutput("lighting",ie.Color3,ve.Fragment),i.registerOutput("shadow",ie.Float,ve.Fragment),i.registerOutput("alpha",ie.Float,ve.Fragment),i}return t.prototype.initialize=function(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")},t.prototype.getClassName=function(){return"PBRMetallicRoughnessBlock"},Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cameraPosition",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"perturbedNormal",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"baseColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"metallic",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"roughness",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ambientOcc",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"opacity",{get:function(){return this._inputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"indexOfRefraction",{get:function(){return this._inputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ambientColor",{get:function(){return this._inputs[11]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflection",{get:function(){return this._inputs[12]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clearcoat",{get:function(){return this._inputs[13]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sheen",{get:function(){return this._inputs[14]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"subsurface",{get:function(){return this._inputs[15]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"anisotropy",{get:function(){return this._inputs[16]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ambientClr",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseDir",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"specularDir",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clearcoatDir",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sheenDir",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseIndirect",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"specularIndirect",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clearcoatIndirect",{get:function(){return this._outputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sheenIndirect",{get:function(){return this._outputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"refraction",{get:function(){return this._outputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lighting",{get:function(){return this._outputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._outputs[11]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._outputs[12]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.systemValue===mt.CameraPosition});i||(i=new bt("cameraPosition"),i.setAsSystemValue(mt.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){var r=e.getInputBlockByPredicate(function(o){return o.systemValue===mt.View});r||(r=new bt("view"),r.setAsSystemValue(mt.View)),r.output.connectTo(this.view)}},t.prototype.prepareDefines=function(e,i,r){r.setValue("PBR",!0),r.setValue("METALLICWORKFLOW",!0),r.setValue("DEBUGMODE",this.debugMode,!0),r.setValue("NORMALXYSCALE",!0),r.setValue("BUMP",this.perturbedNormal.isConnected,!0),r.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),r.setValue("ALBEDO",!1,!0),r.setValue("OPACITY",this.opacity.isConnected,!0),r.setValue("AMBIENT",!0,!0),r.setValue("AMBIENTINGRAYSCALE",!1,!0),r.setValue("REFLECTIVITY",!1,!0),r.setValue("AOSTOREINMETALMAPRED",!1,!0),r.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),r.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),r.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===Hr.a.LIGHTFALLOFF_STANDARD?(r.setValue("USEPHYSICALLIGHTFALLOFF",!1),r.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===Hr.a.LIGHTFALLOFF_GLTF?(r.setValue("USEPHYSICALLIGHTFALLOFF",!1),r.setValue("USEGLTFLIGHTFALLOFF",!0)):(r.setValue("USEPHYSICALLIGHTFALLOFF",!0),r.setValue("USEGLTFLIGHTFALLOFF",!1));var o=this.alphaTestCutoff.toString();r.setValue("ALPHABLEND",this.useAlphaBlending,!0),r.setValue("ALPHAFROMALBEDO",!1,!0),r.setValue("ALPHATEST",this.useAlphaTest,!0),r.setValue("ALPHATESTVALUE",o.indexOf(".")<0?o+".":o,!0),r.setValue("OPACITYRGB",!1,!0),r.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),r.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),r.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),r.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);var a=e.getScene();if(a.getEngine()._features.needTypeSuffixInShaderConstants?r.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):r.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),r.setValue("BRDF_V_HEIGHT_CORRELATED",!0),r.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),r.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),r.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),r.setValue("UNLIT",this.unlit,!0),r.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&en.a.ReflectionTextureEnabled?(r.setValue("ENVIRONMENTBRDF",!0),r.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(r.setValue("ENVIRONMENTBRDF",!1),r.setValue("ENVIRONMENTBRDF_RGBD",!1)),!!r._areLightsDirty)if(!this.light)xt.a.PrepareDefinesForLights(a,e,r,!0,i.maxSimultaneousLights),r._needNormals=!0,xt.a.PrepareDefinesForMultiview(a,r);else{var s={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};xt.a.PrepareDefinesForLight(a,e,this.light,this._lightId,r,!0,s),s.needRebuild&&r.rebuild()}},t.prototype.updateUniformsAndSamples=function(e,i,r,o){for(var a=0;a<i.maxSimultaneousLights&&r["LIGHT"+a];a++){var s=e.uniforms.indexOf("vLightData"+a)>=0;xt.a.PrepareUniformsAndSamplersForLight(a,e.uniforms,e.samplers,r["PROJECTEDLIGHTTEXTURE"+a],o,s)}},t.prototype.isReady=function(){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady())},t.prototype.bind=function(e,i,r){var o,a;if(!!r){var s=r.getScene();this.light?xt.a.BindLight(this.light,this._lightId,s,e,!0):xt.a.BindLights(s,r,e,!0,i.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);var c=this._scene.ambientColor;c&&e.setColor3("ambientFromScene",c);var _=s.useRightHandedSystem===(s._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,_?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);var b=1,C=(a=(o=this.indexOfRefraction.connectInputBlock)===null||o===void 0?void 0:o.value)!==null&&a!==void 0?a:1.5,x=Math.pow((C-b)/(C+b),2);this._metallicReflectanceColor.scaleToRef(x*this._metallicF0Factor,v.c.Color3[0]);var V=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,v.c.Color3[0],V)}},t.prototype._injectVertexCode=function(e){var i,r,o=this.worldPosition,a="//"+this.name;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",a,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",a,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));var s="v_"+o.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+=s+" = "+o.associatedVariableName+`;\r
`);var c=this.reflection.isConnected?(i=this.reflection.connectedPoint)===null||i===void 0?void 0:i.ownerBlock:null;c&&(c.viewConnectionPoint=this.view),e.compilationString+=(r=c==null?void 0:c.handleVertexSide(e))!==null&&r!==void 0?r:"",e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0\r
`,e._injectAtEnd+=`vClipSpacePosition = gl_Position;\r
`,e._injectAtEnd+=`#endif\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",a,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:o.associatedVariableName}]}):(e.compilationString+="vec4 worldPos = "+o.associatedVariableName+`;\r
`,this.view.isConnected&&(e.compilationString+="mat4 view = "+this.view.associatedVariableName+`;\r
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",a,{repeatKey:"maxSimultaneousLights"}))},t.prototype._getAlbedoOpacityCode=function(){var e=`albedoOpacityOutParams albedoOpacityOut;\r
`,i=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",r=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return e+=`albedoOpacityBlock(
                vec4(`+i+`, 1.),
            #ifdef ALBEDO
                vec4(1.),
                vec2(1., 1.),
            #endif
            #ifdef OPACITY
                vec4(`+r+`),
                vec2(1., 1.),
            #endif
                albedoOpacityOut
            );

            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;
            float alpha = albedoOpacityOut.alpha;\r
`,e},t.prototype._getAmbientOcclusionCode=function(){var e=`ambientOcclusionOutParams aoOut;\r
`,i=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return e+=`ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3(`+i+`),
                vec4(0., 1.0, 1.0, 0.),
            #endif
                aoOut
            );\r
`,e},t.prototype._getReflectivityCode=function(e){var i=`reflectivityOutParams reflectivityOut;\r
`,r="1.";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),i+=`vec3 baseColor = surfaceAlbedo;

            reflectivityBlock(
                vec4(`+this.metallic.associatedVariableName+", "+this.roughness.associatedVariableName+`, 0., 0.),
            #ifdef METALLICWORKFLOW
                surfaceAlbedo,
                `+this._vMetallicReflectanceFactorsName+`,
            #endif
            #ifdef REFLECTIVITY
                vec3(0., 0., `+r+`),
                vec4(1.),
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor,
            #endif
            #ifdef MICROSURFACEMAP
                microSurfaceTexel, <== not handled!
            #endif
                reflectivityOut
            );

            float microSurface = reflectivityOut.microSurface;
            float roughness = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif\r
`,i},t.prototype._buildBlock=function(e){var i,r,o,a,s,c,_,b,C,x,V,D,z,q,ue,ge,Se,Pe,me,xe,Fe,we,Ge,Xe,Oe,je,ke,ze,Je,it,Ke,St,Mt,Rt,at,Bt,Wt,lt,Ft;n.prototype._buildBlock.call(this,e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=Ff.a.GetEnvironmentBRDFTexture(this._scene));var Qe=this.reflection.isConnected?(i=this.reflection.connectedPoint)===null||i===void 0?void 0:i.ownerBlock:null;if(Qe&&(Qe.worldPositionConnectionPoint=this.worldPosition,Qe.cameraPositionConnectionPoint=this.cameraPosition,Qe.worldNormalConnectionPoint=this.worldNormal),e.target!==ve.Fragment)return this._injectVertexCode(e),this;e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this);var ct="//"+this.name,wt="v_"+this.worldPosition.associatedVariableName,fi=this.perturbedNormal;this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",ct,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",ct,{repeatKey:"maxSimultaneousLights"}),e._emitFunctionFromInclude("helperFunctions",ct),e._emitFunctionFromInclude("importanceSampling",ct),e._emitFunctionFromInclude("pbrHelperFunctions",ct),e._emitFunctionFromInclude("imageProcessingFunctions",ct),e._emitFunctionFromInclude("shadowsFragmentFunctions",ct,{replaceStrings:[{search:/vPositionW/g,replace:wt+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",ct,{replaceStrings:[{search:/vPositionW/g,replace:wt+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",ct),e._emitFunctionFromInclude("pbrBRDFFunctions",ct,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(r=Qe==null?void 0:Qe._defineSkyboxName)!==null&&r!==void 0?r:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",ct),e._emitFunctionFromInclude("pbrDirectLightingFunctions",ct,{replaceStrings:[{search:/vPositionW/g,replace:wt+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",ct),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",ct),e._emitFunctionFromInclude("pbrBlockReflectivity",ct),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",ct),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",ct),e._emitFunctionFromInclude("pbrBlockAnisotropic",ct),e._emitUniformFromString("vLightingIntensity","vec4"),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+="vec4 "+this._vNormalWName+" = normalize("+this.worldNormal.associatedVariableName+`);\r
`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+="vec3 viewDirectionW = normalize("+this.cameraPosition.associatedVariableName+" - "+wt+`.xyz);\r
`),e.compilationString+="vec3 geometricNormalW = "+this._vNormalWName+`.xyz;\r
`,e.compilationString+="vec3 normalW = "+(fi.isConnected?"normalize("+fi.associatedVariableName+".xyz)":"geometricNormalW")+`;\r
`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",ct,{replaceStrings:[{search:/vPositionW/g,replace:wt+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",ct),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",ct),e.compilationString+=`#ifdef UNLIT
                vec3 diffuseBase = vec3(1., 1., 1.);
            #else\r
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",ct,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(o=Qe==null?void 0:Qe._defineSkyboxName)!==null&&o!==void 0?o:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(a=Qe==null?void 0:Qe._define3DName)!==null&&a!==void 0?a:"REFLECTIONMAP_3D"}]});var si=this.anisotropy.isConnected?(s=this.anisotropy.connectedPoint)===null||s===void 0?void 0:s.ownerBlock:null;si&&(si.worldPositionConnectionPoint=this.worldPosition,si.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=si.getCode(e,!this.perturbedNormal.isConnected)),Qe&&Qe.hasTexture&&(e.compilationString+=Qe.getCode(e,si?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",ct,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(c=Qe==null?void 0:Qe._define3DName)!==null&&c!==void 0?c:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(_=Qe==null?void 0:Qe._defineOppositeZ)!==null&&_!==void 0?_:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(b=Qe==null?void 0:Qe._defineProjectionName)!==null&&b!==void 0?b:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(C=Qe==null?void 0:Qe._defineSkyboxName)!==null&&C!==void 0?C:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(x=Qe==null?void 0:Qe._defineLODReflectionAlpha)!==null&&x!==void 0?x:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(V=Qe==null?void 0:Qe._defineLinearSpecularReflection)!==null&&V!==void 0?V:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:(D=Qe==null?void 0:Qe._vReflectionFilteringInfoName)!==null&&D!==void 0?D:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",ct,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});var xi=this.sheen.isConnected?(z=this.sheen.connectedPoint)===null||z===void 0?void 0:z.ownerBlock:null;xi&&(e.compilationString+=xi.getCode(Qe)),e._emitFunctionFromInclude("pbrBlockSheen",ct,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(q=Qe==null?void 0:Qe._define3DName)!==null&&q!==void 0?q:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(ue=Qe==null?void 0:Qe._defineSkyboxName)!==null&&ue!==void 0?ue:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(ge=Qe==null?void 0:Qe._defineLODReflectionAlpha)!==null&&ge!==void 0?ge:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(Se=Qe==null?void 0:Qe._defineLinearSpecularReflection)!==null&&Se!==void 0?Se:"LINEARSPECULARREFLECTION"}]});var bi=this.clearcoat.isConnected?(Pe=this.clearcoat.connectedPoint)===null||Pe===void 0?void 0:Pe.ownerBlock:null,Tt=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,$t=this.perturbedNormal.isConnected&&((me=this.perturbedNormal.connectedPoint)===null||me===void 0?void 0:me.ownerBlock).worldTangent.isConnected,vi=this.anisotropy.isConnected&&((xe=this.anisotropy.connectedPoint)===null||xe===void 0?void 0:xe.ownerBlock).worldTangent.isConnected,hi=$t||!this.perturbedNormal.isConnected&&vi;e.compilationString+=sa.GetCode(e,bi,Qe,wt,Tt,hi,this.worldNormal.associatedVariableName),Tt&&(hi=(Fe=bi==null?void 0:bi.worldTangent.isConnected)!==null&&Fe!==void 0?Fe:!1),e._emitFunctionFromInclude("pbrBlockClearcoat",ct,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(we=Qe==null?void 0:Qe._define3DName)!==null&&we!==void 0?we:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(Ge=Qe==null?void 0:Qe._defineOppositeZ)!==null&&Ge!==void 0?Ge:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(Xe=Qe==null?void 0:Qe._defineProjectionName)!==null&&Xe!==void 0?Xe:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(Oe=Qe==null?void 0:Qe._defineSkyboxName)!==null&&Oe!==void 0?Oe:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(je=Qe==null?void 0:Qe._defineLODReflectionAlpha)!==null&&je!==void 0?je:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(ke=Qe==null?void 0:Qe._defineLinearSpecularReflection)!==null&&ke!==void 0?ke:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:hi?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",ct,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(ze=Qe==null?void 0:Qe._defineSkyboxName)!==null&&ze!==void 0?ze:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(Je=Qe==null?void 0:Qe._define3DName)!==null&&Je!==void 0?Je:"REFLECTIONMAP_3D"}]});var di=this.subsurface.isConnected?(it=this.subsurface.connectedPoint)===null||it===void 0?void 0:it.ownerBlock:null,ft=this.subsurface.isConnected?(St=((Ke=this.subsurface.connectedPoint)===null||Ke===void 0?void 0:Ke.ownerBlock).refraction.connectedPoint)===null||St===void 0?void 0:St.ownerBlock:null;ft&&(ft.viewConnectionPoint=this.view,ft.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=la.GetCode(e,di,Qe,wt),e._emitFunctionFromInclude("pbrBlockSubSurface",ct,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(Mt=Qe==null?void 0:Qe._define3DName)!==null&&Mt!==void 0?Mt:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(Rt=Qe==null?void 0:Qe._defineOppositeZ)!==null&&Rt!==void 0?Rt:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(at=Qe==null?void 0:Qe._defineProjectionName)!==null&&at!==void 0?at:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:(Bt=ft==null?void 0:ft._define3DName)!==null&&Bt!==void 0?Bt:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:(Wt=ft==null?void 0:ft._defineLODRefractionAlpha)!==null&&Wt!==void 0?Wt:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:(lt=ft==null?void 0:ft._defineLinearSpecularRefraction)!==null&&lt!==void 0?lt:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:(Ft=ft==null?void 0:ft._defineOppositeZ)!==null&&Ft!==void 0?Ft:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",ct),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",ct,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",ct,{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",ct),e.compilationString+=`#endif\r
`;var oi=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)",sn=Hr.a.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();sn.indexOf(".")===-1&&(sn+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",ct,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:oi+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:sn}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",ct,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",ct,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",ct,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:wt},{search:/albedoTexture\.rgb;/g,replace:`vec3(1.);\r
gl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r
`}]});for(var Kr=0,Nn=this._outputs;Kr<Nn.length;Kr++){var Qr=Nn[Kr];if(Qr.hasEndpoints){var _n=tg[Qr.name];if(_n){var Oa=_n[0],wn=_n[1];wn&&(e.compilationString+="#if "+wn+`\r
`),e.compilationString+=this._declareOutput(Qr,e)+" = "+Oa+`;\r
`,wn&&(e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(Qr,e)+` = vec3(0.);\r
`,e.compilationString+=`#endif\r
`)}else console.error("There's no remapping for the "+Qr.name+" end point! No code generated")}}return this},t.prototype._dumpPropertiesCode=function(){var e="";return e+=this._codeVariableName+".lightFalloff = "+this.lightFalloff+`;\r
`,e+=this._codeVariableName+".useAlphaTest = "+this.useAlphaTest+`;\r
`,e+=this._codeVariableName+".alphaTestCutoff = "+this.alphaTestCutoff+`;\r
`,e+=this._codeVariableName+".useAlphaBlending = "+this.useAlphaBlending+`;\r
`,e+=this._codeVariableName+".useRadianceOverAlpha = "+this.useRadianceOverAlpha+`;\r
`,e+=this._codeVariableName+".useSpecularOverAlpha = "+this.useSpecularOverAlpha+`;\r
`,e+=this._codeVariableName+".enableSpecularAntiAliasing = "+this.enableSpecularAntiAliasing+`;\r
`,e+=this._codeVariableName+".realTimeFiltering = "+this.realTimeFiltering+`;\r
`,e+=this._codeVariableName+".realTimeFilteringQuality = "+this.realTimeFilteringQuality+`;\r
`,e+=this._codeVariableName+".useEnergyConservation = "+this.useEnergyConservation+`;\r
`,e+=this._codeVariableName+".useRadianceOcclusion = "+this.useRadianceOcclusion+`;\r
`,e+=this._codeVariableName+".useHorizonOcclusion = "+this.useHorizonOcclusion+`;\r
`,e+=this._codeVariableName+".unlit = "+this.unlit+`;\r
`,e+=this._codeVariableName+".forceNormalForward = "+this.forceNormalForward+`;\r
`,e+=this._codeVariableName+".debugMode = "+this.debugMode+`;\r
`,e+=this._codeVariableName+".debugLimit = "+this.debugLimit+`;\r
`,e+=this._codeVariableName+".debugFactor = "+this.debugFactor+`;\r
`,e},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e},t.prototype._deserialize=function(e,i,r){var o,a;n.prototype._deserialize.call(this,e,i,r),e.lightId&&(this.light=i.getLightByID(e.lightId)),this.lightFalloff=(o=e.lightFalloff)!==null&&o!==void 0?o:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=(a=e.realTimeFilteringQuality)!==null&&a!==void 0?a:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor},Object(p.c)([Lt("Direct lights",Dt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],t.prototype,"directIntensity",void 0),Object(p.c)([Lt("Environment lights",Dt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],t.prototype,"environmentIntensity",void 0),Object(p.c)([Lt("Specular highlights",Dt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],t.prototype,"specularIntensity",void 0),Object(p.c)([Lt("Light falloff",Dt.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:Hr.a.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:Hr.a.LIGHTFALLOFF_GLTF},{label:"Standard",value:Hr.a.LIGHTFALLOFF_STANDARD}]})],t.prototype,"lightFalloff",void 0),Object(p.c)([Lt("Alpha Testing",Dt.Boolean,"OPACITY")],t.prototype,"useAlphaTest",void 0),Object(p.c)([Lt("Alpha CutOff",Dt.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],t.prototype,"alphaTestCutoff",void 0),Object(p.c)([Lt("Alpha blending",Dt.Boolean,"OPACITY")],t.prototype,"useAlphaBlending",void 0),Object(p.c)([Lt("Radiance over alpha",Dt.Boolean,"RENDERING",{notifiers:{update:!0}})],t.prototype,"useRadianceOverAlpha",void 0),Object(p.c)([Lt("Specular over alpha",Dt.Boolean,"RENDERING",{notifiers:{update:!0}})],t.prototype,"useSpecularOverAlpha",void 0),Object(p.c)([Lt("Specular anti-aliasing",Dt.Boolean,"RENDERING",{notifiers:{update:!0}})],t.prototype,"enableSpecularAntiAliasing",void 0),Object(p.c)([Lt("Realtime filtering",Dt.Boolean,"RENDERING",{notifiers:{update:!0}})],t.prototype,"realTimeFiltering",void 0),Object(p.c)([Lt("Realtime filtering quality",Dt.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],t.prototype,"realTimeFilteringQuality",void 0),Object(p.c)([Lt("Energy Conservation",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"useEnergyConservation",void 0),Object(p.c)([Lt("Radiance occlusion",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"useRadianceOcclusion",void 0),Object(p.c)([Lt("Horizon occlusion",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"useHorizonOcclusion",void 0),Object(p.c)([Lt("Unlit",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"unlit",void 0),Object(p.c)([Lt("Force normal forward",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],t.prototype,"forceNormalForward",void 0),Object(p.c)([Lt("Debug mode",Dt.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],t.prototype,"debugMode",void 0),Object(p.c)([Lt("Split position",Dt.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],t.prototype,"debugLimit",void 0),Object(p.c)([Lt("Output factor",Dt.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],t.prototype,"debugFactor",void 0),t}(nt);f.a.RegisteredTypes["BABYLON.PBRMetallicRoughnessBlock"]=Nf;var wf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("left",ie.AutoDetect),i.registerInput("right",ie.AutoDetect),i.registerOutput("output",ie.BasedOnInput),i._outputs[0]._typeConnectionSource=i._inputs[0],i._linkConnectionTypes(0,1),i}return t.prototype.getClassName=function(){return"ModBlock"},Object.defineProperty(t.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0];return e.compilationString+=this._declareOutput(i,e)+(" = mod("+this.left.associatedVariableName+", "+this.right.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.ModBlock"]=wf;var Vf=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e,ve.Neutral)||this;return i.registerInput("row0",ie.Vector4),i.registerInput("row1",ie.Vector4),i.registerInput("row2",ie.Vector4),i.registerInput("row3",ie.Vector4),i.registerOutput("output",ie.Matrix),i}return t.prototype.getClassName=function(){return"MatrixBuilder"},Object.defineProperty(t.prototype,"row0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"row1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"row2",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"row3",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),t.prototype.autoConfigure=function(e){if(!this.row0.isConnected){var i=new bt("row0");i.value=new l.f(1,0,0,0),i.output.connectTo(this.row0)}if(!this.row1.isConnected){var r=new bt("row1");r.value=new l.f(0,1,0,0),r.output.connectTo(this.row1)}if(!this.row2.isConnected){var o=new bt("row2");o.value=new l.f(0,0,1,0),o.output.connectTo(this.row2)}if(!this.row3.isConnected){var a=new bt("row3");a.value=new l.f(0,0,0,1),a.output.connectTo(this.row3)}},t.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var i=this._outputs[0],r=this.row0,o=this.row1,a=this.row2,s=this.row3;return e.compilationString+=this._declareOutput(i,e)+(" = mat4("+r.associatedVariableName+", "+o.associatedVariableName+", "+a.associatedVariableName+", "+s.associatedVariableName+`);\r
`),this},t}(nt);f.a.RegisteredTypes["BABYLON.MatrixBuilder"]=Vf;var ig=function(){function n(){}return n.prototype.optimize=function(t,e){},n}(),Uf=u(630),rg=u(709),ng=function(){function n(){this.mm=new Map}return n.prototype.get=function(t,e){var i=this.mm.get(t);if(i!==void 0)return i.get(e)},n.prototype.set=function(t,e,i){var r=this.mm.get(t);r===void 0&&this.mm.set(t,r=new Map),r.set(e,i)},n}(),og=function(){function n(t,e,i){var r=this;this._baseMaterial=t,this._scene=e,this._options=i,this._subMeshToEffect=new Map,this._subMeshToDepthEffect=new ng,this._meshes=new Map;var o=t.getClassName()==="NodeMaterial"?"u_":"";if(o){this._matriceNames={world:o+"World",view:o+"View",projection:o+"Projection",viewProjection:o+"ViewProjection",worldView:o+"WorldxView",worldViewProjection:o+"WorldxViewxProjection"};for(var a=t,s=a.getInputBlocks(),c=0;c<s.length;++c)switch(s[c]._systemValue){case mt.World:this._matriceNames.world=s[c].associatedVariableName;break;case mt.View:this._matriceNames.view=s[c].associatedVariableName;break;case mt.Projection:this._matriceNames.projection=s[c].associatedVariableName;break;case mt.ViewProjection:this._matriceNames.viewProjection=s[c].associatedVariableName;break;case mt.WorldView:this._matriceNames.worldView=s[c].associatedVariableName;break;case mt.WorldViewProjection:this._matriceNames.worldViewProjection=s[c].associatedVariableName;break}}else this._matriceNames={world:o+"world",view:o+"view",projection:o+"projection",viewProjection:o+"viewProjection",worldView:o+"worldView",worldViewProjection:o+"worldViewProjection"};this._onEffectCreatedObserver=this._baseMaterial.onEffectCreatedObservable.add(function(_){var b,C=(b=_.subMesh)===null||b===void 0?void 0:b.getMesh();C&&!r._meshes.has(C)&&r._meshes.set(C,C.onDisposeObservable.add(function(x){for(var V=r._subMeshToEffect.keys(),D=V.next();D.done!==!0;D=V.next()){var z=D.value;(z==null?void 0:z.getMesh())===x&&(r._subMeshToEffect.delete(z),r._subMeshToDepthEffect.mm.delete(z))}})),r._subMeshToEffect.set(_.subMesh,_.effect),r._subMeshToDepthEffect.mm.delete(_.subMesh)})}return Object.defineProperty(n.prototype,"standalone",{get:function(){var t,e;return(e=(t=this._options)===null||t===void 0?void 0:t.standalone)!==null&&e!==void 0?e:!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"baseMaterial",{get:function(){return this._baseMaterial},enumerable:!1,configurable:!0}),n.prototype.getEffect=function(t,e){var i,r,o,a,s,c;return(c=(o=(r=(i=this._subMeshToDepthEffect.mm.get(t))===null||i===void 0?void 0:i.get(e))===null||r===void 0?void 0:r.depthEffect)!==null&&o!==void 0?o:(s=(a=this._subMeshToDepthEffect.mm.get(null))===null||a===void 0?void 0:a.get(e))===null||s===void 0?void 0:s.depthEffect)!==null&&c!==void 0?c:null},n.prototype.isReadyForSubMesh=function(t,e,i,r){var o,a;return this.standalone&&this._baseMaterial.isReadyForSubMesh(t.getMesh(),t,r),(a=(o=this._makeEffect(t,e,i))===null||o===void 0?void 0:o.isReady())!==null&&a!==void 0?a:!1},n.prototype.dispose=function(){this._baseMaterial.onEffectCreatedObservable.remove(this._onEffectCreatedObserver),this._onEffectCreatedObserver=null;for(var t=this._meshes.entries(),e=t.next();e.done!==!0;e=t.next()){var i=e.value,r=i[0],o=i[1];r.onDisposeObservable.remove(o)}},n.prototype._makeEffect=function(t,e,i){var r,o=(r=this._subMeshToEffect.get(t))!==null&&r!==void 0?r:this._subMeshToEffect.get(null);if(!o)return null;var a=this._subMeshToDepthEffect.get(t,i);a||(a={depthEffect:null,depthDefines:"",token:rg.a.RandomId()},this._subMeshToDepthEffect.set(t,i,a));var s=e.join(`
`);if(a.depthEffect&&s===a.depthDefines)return a.depthEffect;a.depthDefines=s;var c=o.rawVertexSourceCode,_=o.rawFragmentSourceCode,b=this._options&&this._options.remappedVariables?"#include<shadowMapVertexNormalBias>("+this._options.remappedVariables.join(",")+")":qe.a.IncludesShadersStore.shadowMapVertexNormalBias,C=this._options&&this._options.remappedVariables?"#include<shadowMapVertexMetric>("+this._options.remappedVariables.join(",")+")":qe.a.IncludesShadersStore.shadowMapVertexMetric,x=this._options&&this._options.remappedVariables?"#include<shadowMapFragmentSoftTransparentShadow>("+this._options.remappedVariables.join(",")+")":qe.a.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow,V=qe.a.IncludesShadersStore.shadowMapFragment;c=c.replace(/void\s+?main/g,qe.a.IncludesShadersStore.shadowMapVertexDeclaration+`\r
void main`),c=c.replace(/#define SHADOWDEPTH_NORMALBIAS|#define CUSTOM_VERTEX_UPDATE_WORLDPOS/g,b),c.indexOf("#define SHADOWDEPTH_METRIC")!==-1?c=c.replace(/#define SHADOWDEPTH_METRIC/g,C):c=c.replace(/}\s*$/g,C+`\r
}`),c=c.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");var D=_.indexOf("#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW")>=0||_.indexOf("#define CUSTOM_FRAGMENT_BEFORE_FOG")>=0,z=_.indexOf("#define SHADOWDEPTH_FRAGMENT")!==-1,q="";D?_=_.replace(/#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW|#define CUSTOM_FRAGMENT_BEFORE_FOG/g,x):q=x+`\r
`,_=_.replace(/void\s+?main/g,qe.a.IncludesShadersStore.shadowMapFragmentDeclaration+`\r
void main`),z?_=_.replace(/#define SHADOWDEPTH_FRAGMENT/g,V):q+=V+`\r
`,q&&(_=_.replace(/}\s*$/g,q+"}")),_=_.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");var ue=o.getUniformNames().slice();return ue.push("biasAndScaleSM","depthValuesSM","lightDataSM","softTransparentShadowSM"),a.depthEffect=this._scene.getEngine().createEffect({vertexSource:c,fragmentSource:_,vertexToken:a.token,fragmentToken:a.token},{attributes:o.getAttributesNames(),uniformsNames:ue,uniformBuffersNames:o.getUniformBuffersNames(),samplers:o.getSamplers(),defines:s+`
`+o.defines.replace("#define SHADOWS","").replace(/#define SHADOW\d/g,""),indexParameters:o.getIndexParameters()},this._scene.getEngine()),a.depthEffect},n}(),Gf=u(710),ag=u(696),Ro=u(559),zf=0,sg=function(){function n(t,e,i,r){this.pos=t,this.normal=e,this.uv=i,this.vertColor=r}return n.prototype.clone=function(){var t,e;return new n(this.pos.clone(),this.normal.clone(),(t=this.uv)===null||t===void 0?void 0:t.clone(),(e=this.vertColor)===null||e===void 0?void 0:e.clone())},n.prototype.flip=function(){this.normal=this.normal.scale(-1)},n.prototype.interpolate=function(t,e){return new n(l.e.Lerp(this.pos,t.pos,e),l.e.Lerp(this.normal,t.normal,e),this.uv&&t.uv?l.d.Lerp(this.uv,t.uv,e):void 0,this.vertColor&&t.vertColor?v.b.Lerp(this.vertColor,t.vertColor,e):void 0)},n}(),lg=function(){function n(t,e){this.normal=t,this.w=e}return n.FromPoints=function(t,e,i){var r=i.subtract(t),o=e.subtract(t);if(r.lengthSquared()===0||o.lengthSquared()===0)return null;var a=l.e.Normalize(l.e.Cross(r,o));return new n(a,l.e.Dot(a,t))},n.prototype.clone=function(){return new n(this.normal.clone(),this.w)},n.prototype.flip=function(){this.normal.scaleInPlace(-1),this.w=-this.w},n.prototype.splitPolygon=function(t,e,i,r,o){var a=0,s=1,c=2,_=3,b=0,C=[],x,V;for(x=0;x<t.vertices.length;x++){V=l.e.Dot(this.normal,t.vertices[x].pos)-this.w;var D=V<-n.EPSILON?c:V>n.EPSILON?s:a;b|=D,C.push(D)}switch(b){case a:(l.e.Dot(this.normal,t.plane.normal)>0?e:i).push(t);break;case s:r.push(t);break;case c:o.push(t);break;case _:var z=[],q=[];for(x=0;x<t.vertices.length;x++){var ue=(x+1)%t.vertices.length,ge=C[x],Se=C[ue],Pe=t.vertices[x],me=t.vertices[ue];if(ge!==c&&z.push(Pe),ge!==s&&q.push(ge!==c?Pe.clone():Pe),(ge|Se)===_){V=(this.w-l.e.Dot(this.normal,Pe.pos))/l.e.Dot(this.normal,me.pos.subtract(Pe.pos));var xe=Pe.interpolate(me,V);z.push(xe),q.push(xe.clone())}}var Fe;z.length>=3&&(Fe=new $s(z,t.shared),Fe.plane&&r.push(Fe)),q.length>=3&&(Fe=new $s(q,t.shared),Fe.plane&&o.push(Fe));break}},n.EPSILON=1e-5,n}(),$s=function(){function n(t,e){this.vertices=t,this.shared=e,this.plane=lg.FromPoints(t[0].pos,t[1].pos,t[2].pos)}return n.prototype.clone=function(){var t=this.vertices.map(function(e){return e.clone()});return new n(t,this.shared)},n.prototype.flip=function(){this.vertices.reverse().map(function(t){t.flip()}),this.plane.flip()},n}(),br=function(){function n(t){this.plane=null,this.front=null,this.back=null,this.polygons=new Array,t&&this.build(t)}return n.prototype.clone=function(){var t=new n;return t.plane=this.plane&&this.plane.clone(),t.front=this.front&&this.front.clone(),t.back=this.back&&this.back.clone(),t.polygons=this.polygons.map(function(e){return e.clone()}),t},n.prototype.invert=function(){for(var t=0;t<this.polygons.length;t++)this.polygons[t].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var e=this.front;this.front=this.back,this.back=e},n.prototype.clipPolygons=function(t){if(!this.plane)return t.slice();for(var e=new Array,i=new Array,r=0;r<t.length;r++)this.plane.splitPolygon(t[r],e,i,e,i);return this.front&&(e=this.front.clipPolygons(e)),this.back?i=this.back.clipPolygons(i):i=[],e.concat(i)},n.prototype.clipTo=function(t){this.polygons=t.clipPolygons(this.polygons),this.front&&this.front.clipTo(t),this.back&&this.back.clipTo(t)},n.prototype.allPolygons=function(){var t=this.polygons.slice();return this.front&&(t=t.concat(this.front.allPolygons())),this.back&&(t=t.concat(this.back.allPolygons())),t},n.prototype.build=function(t){if(!!t.length){this.plane||(this.plane=t[0].plane.clone());for(var e=new Array,i=new Array,r=0;r<t.length;r++)this.plane.splitPolygon(t[r],this.polygons,this.polygons,e,i);e.length&&(this.front||(this.front=new n),this.front.build(e)),i.length&&(this.back||(this.back=new n),this.back.build(i))}},n}(),ug=function(){function n(){this.polygons=new Array}return n.FromMesh=function(t){var e,i,r=void 0,o,a=void 0,s,c=new Array,_,b,C,x,V=null,D;if(t instanceof st.a)t.computeWorldMatrix(!0),b=t.getWorldMatrix(),C=t.position.clone(),x=t.rotation.clone(),t.rotationQuaternion&&(V=t.rotationQuaternion.clone()),D=t.scaling.clone();else throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";for(var z=t.getIndices(),q=t.getVerticesData(Be.b.PositionKind),ue=t.getVerticesData(Be.b.NormalKind),ge=t.getVerticesData(Be.b.UVKind),Se=t.getVerticesData(Be.b.ColorKind),Pe=t.subMeshes,me=0,xe=Pe.length;me<xe;me++)for(var Fe=Pe[me].indexStart,we=Pe[me].indexCount+Pe[me].indexStart;Fe<we;Fe+=3){_=[];for(var Ge=0;Ge<3;Ge++){var Xe=new l.e(ue[z[Fe+Ge]*3],ue[z[Fe+Ge]*3+1],ue[z[Fe+Ge]*3+2]);ge&&(r=new l.d(ge[z[Fe+Ge]*2],ge[z[Fe+Ge]*2+1])),Se&&(a=new v.b(Se[z[Fe+Ge]*4],Se[z[Fe+Ge]*4+1],Se[z[Fe+Ge]*4+2],Se[z[Fe+Ge]*4+3]));var Oe=new l.e(q[z[Fe+Ge]*3],q[z[Fe+Ge]*3+1],q[z[Fe+Ge]*3+2]);o=l.e.TransformCoordinates(Oe,b),i=l.e.TransformNormal(Xe,b),e=new sg(o,i,r,a),_.push(e)}s=new $s(_,{subMeshId:me,meshId:zf,materialIndex:Pe[me].materialIndex}),s.plane&&c.push(s)}var je=n.FromPolygons(c);return je.matrix=b,je.position=C,je.rotation=x,je.scaling=D,je.rotationQuaternion=V,zf++,je},n.FromPolygons=function(t){var e=new n;return e.polygons=t,e},n.prototype.clone=function(){var t=new n;return t.polygons=this.polygons.map(function(e){return e.clone()}),t.copyTransformAttributes(this),t},n.prototype.union=function(t){var e=new br(this.clone().polygons),i=new br(t.clone().polygons);return e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.unionInPlace=function(t){var e=new br(this.polygons),i=new br(t.polygons);e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),this.polygons=e.allPolygons()},n.prototype.subtract=function(t){var e=new br(this.clone().polygons),i=new br(t.clone().polygons);return e.invert(),e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),e.invert(),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.subtractInPlace=function(t){var e=new br(this.polygons),i=new br(t.polygons);e.invert(),e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),e.invert(),this.polygons=e.allPolygons()},n.prototype.intersect=function(t){var e=new br(this.clone().polygons),i=new br(t.clone().polygons);return e.invert(),i.clipTo(e),i.invert(),e.clipTo(i),i.clipTo(e),e.build(i.allPolygons()),e.invert(),n.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},n.prototype.intersectInPlace=function(t){var e=new br(this.polygons),i=new br(t.polygons);e.invert(),i.clipTo(e),i.invert(),e.clipTo(i),i.clipTo(e),e.build(i.allPolygons()),e.invert(),this.polygons=e.allPolygons()},n.prototype.inverse=function(){var t=this.clone();return t.inverseInPlace(),t},n.prototype.inverseInPlace=function(){this.polygons.map(function(t){t.flip()})},n.prototype.copyTransformAttributes=function(t){return this.matrix=t.matrix,this.position=t.position,this.rotation=t.rotation,this.scaling=t.scaling,this.rotationQuaternion=t.rotationQuaternion,this},n.prototype.buildMeshGeometry=function(t,e,i){var r=this.matrix.clone();r.invert();var o=new st.a(t,e),a=[],s=[],c=[],_=null,b=null,C=l.e.Zero(),x=l.e.Zero(),V=l.d.Zero(),D=new v.b(0,0,0,0),z=this.polygons,q=[0,0,0],ue,ge={},Se,Pe=0,me={},xe;i&&z.sort(function(Rt,at){return Rt.shared.meshId===at.shared.meshId?Rt.shared.subMeshId-at.shared.subMeshId:Rt.shared.meshId-at.shared.meshId});for(var Fe=0,we=z.length;Fe<we;Fe++){ue=z[Fe],me[ue.shared.meshId]||(me[ue.shared.meshId]={}),me[ue.shared.meshId][ue.shared.subMeshId]||(me[ue.shared.meshId][ue.shared.subMeshId]={indexStart:Infinity,indexEnd:-Infinity,materialIndex:ue.shared.materialIndex}),xe=me[ue.shared.meshId][ue.shared.subMeshId];for(var Ge=2,Xe=ue.vertices.length;Ge<Xe;Ge++){q[0]=0,q[1]=Ge-1,q[2]=Ge;for(var Oe=0;Oe<3;Oe++){C.copyFrom(ue.vertices[q[Oe]].pos),x.copyFrom(ue.vertices[q[Oe]].normal),ue.vertices[q[Oe]].uv&&(_||(_=[]),V.copyFrom(ue.vertices[q[Oe]].uv)),ue.vertices[q[Oe]].vertColor&&(b||(b=[]),D.copyFrom(ue.vertices[q[Oe]].vertColor));var je=l.e.TransformCoordinates(C,r),ke=l.e.TransformNormal(x,r);Se=ge[je.x+","+je.y+","+je.z];var ze=!1;_&&!(_[Se*2]===V.x||_[Se*2+1]===V.y)&&(ze=!0);var Je=!1;b&&!(b[Se*4]===D.r||b[Se*4+1]===D.g||b[Se*4+2]===D.b||b[Se*4+3]===D.a)&&(Je=!0),(!(typeof Se!="undefined"&&c[Se*3]===ke.x&&c[Se*3+1]===ke.y&&c[Se*3+2]===ke.z)||ze||Je)&&(a.push(je.x,je.y,je.z),_&&_.push(V.x,V.y),c.push(x.x,x.y,x.z),b&&b.push(D.r,D.g,D.b,D.a),Se=ge[je.x+","+je.y+","+je.z]=a.length/3-1),s.push(Se),xe.indexStart=Math.min(Pe,xe.indexStart),xe.indexEnd=Math.max(Pe,xe.indexEnd),Pe++}}}if(o.setVerticesData(Be.b.PositionKind,a),o.setVerticesData(Be.b.NormalKind,c),_&&o.setVerticesData(Be.b.UVKind,_),b&&o.setVerticesData(Be.b.ColorKind,b),o.setIndices(s,null),i){var it=0,Ke;o.subMeshes=new Array;for(var St in me){Ke=-1;for(var Mt in me[St])xe=me[St][Mt],Ro.a.CreateFromIndices(xe.materialIndex+it,xe.indexStart,xe.indexEnd-xe.indexStart+1,o),Ke=Math.max(xe.materialIndex,Ke);it+=++Ke}}return o},n.prototype.toMesh=function(t,e,i,r){e===void 0&&(e=null);var o=this.buildMeshGeometry(t,i,r);return o.material=e,o.position.copyFrom(this.position),o.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(o.rotationQuaternion=this.rotationQuaternion.clone()),o.scaling.copyFrom(this.scaling),o.computeWorldMatrix(!0),o},n}(),cg=u(661),fg=u(730),an=u(485),hg=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){o===void 0&&(o=1),a===void 0&&(a=60),s===void 0&&(s=!0);var c=n.call(this,e,r)||this;c._sectionPolygonPointsCount=4,c._running=!1,c._autoStart=s,c._generator=i,c._diameter=o,c._length=a,c._sectionVectors=[],c._sectionNormalVectors=[];for(var _=0;_<c._sectionPolygonPointsCount;_++)c._sectionVectors[_]=l.e.Zero(),c._sectionNormalVectors[_]=l.e.Zero();return c._createMesh(),c}return t.prototype.getClassName=function(){return"TrailMesh"},t.prototype._createMesh=function(){var e=new an.a,i=[],r=[],o=[],a=l.e.Zero();this._generator instanceof Ae.a&&this._generator._boundingInfo?a=this._generator._boundingInfo.boundingBox.centerWorld:a=this._generator.position;for(var s=2*Math.PI/this._sectionPolygonPointsCount,c=0;c<this._sectionPolygonPointsCount;c++)i.push(a.x+Math.cos(c*s)*this._diameter,a.y+Math.sin(c*s)*this._diameter,a.z);for(var c=1;c<=this._length;c++){for(var _=0;_<this._sectionPolygonPointsCount;_++)i.push(a.x+Math.cos(_*s)*this._diameter,a.y+Math.sin(_*s)*this._diameter,a.z);for(var b=i.length/3-2*this._sectionPolygonPointsCount,_=0;_<this._sectionPolygonPointsCount-1;_++)o.push(b+_,b+_+this._sectionPolygonPointsCount,b+_+this._sectionPolygonPointsCount+1),o.push(b+_,b+_+this._sectionPolygonPointsCount+1,b+_+1);o.push(b+this._sectionPolygonPointsCount-1,b+this._sectionPolygonPointsCount-1+this._sectionPolygonPointsCount,b+this._sectionPolygonPointsCount),o.push(b+this._sectionPolygonPointsCount-1,b+this._sectionPolygonPointsCount,b)}an.a.ComputeNormals(i,o,r),e.positions=i,e.normals=r,e.indices=o,e.applyToMesh(this,!0),this._autoStart&&this.start()},t.prototype.start=function(){var e=this;this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add(function(){e.update()}))},t.prototype.stop=function(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))},t.prototype.update=function(){var e=this.getVerticesData(Be.b.PositionKind),i=this.getVerticesData(Be.b.NormalKind),r=this._generator.getWorldMatrix();if(e&&i){for(var o=3*this._sectionPolygonPointsCount;o<e.length;o++)e[o-3*this._sectionPolygonPointsCount]=e[o]-i[o]/this._length*this._diameter;for(var o=3*this._sectionPolygonPointsCount;o<i.length;o++)i[o-3*this._sectionPolygonPointsCount]=i[o];for(var a=e.length-3*this._sectionPolygonPointsCount,s=2*Math.PI/this._sectionPolygonPointsCount,o=0;o<this._sectionPolygonPointsCount;o++)this._sectionVectors[o].copyFromFloats(Math.cos(o*s)*this._diameter,Math.sin(o*s)*this._diameter,0),this._sectionNormalVectors[o].copyFromFloats(Math.cos(o*s),Math.sin(o*s),0),l.e.TransformCoordinatesToRef(this._sectionVectors[o],r,this._sectionVectors[o]),l.e.TransformNormalToRef(this._sectionNormalVectors[o],r,this._sectionNormalVectors[o]);for(var o=0;o<this._sectionPolygonPointsCount;o++)e[a+3*o]=this._sectionVectors[o].x,e[a+3*o+1]=this._sectionVectors[o].y,e[a+3*o+2]=this._sectionVectors[o].z,i[a+3*o]=this._sectionNormalVectors[o].x,i[a+3*o+1]=this._sectionNormalVectors[o].y,i[a+3*o+2]=this._sectionNormalVectors[o].z;this.updateVerticesData(Be.b.PositionKind,e,!0,!1),this.updateVerticesData(Be.b.NormalKind,i,!0,!1)}},t.prototype.clone=function(e,i){return e===void 0&&(e=""),new t(e,i===void 0?this._generator:i,this.getScene(),this._diameter,this._length,this._autoStart)},t.prototype.serialize=function(e){n.prototype.serialize.call(this,e)},t.Parse=function(e,i){return new t(e.name,e._generator,i,e._diameter,e._length,e._autoStart)},t}(st.a),dg=u(731),Oo=u(692),pg=u(648),mg=function(){function n(t,e,i){this.quality=t,this.distance=e,this.optimizeMesh=i}return n}(),jf=function(){function n(){this.running=!1,this._simplificationArray=[]}return n.prototype.addTask=function(t){this._simplificationArray.push(t)},n.prototype.executeNext=function(){var t=this._simplificationArray.pop();t?(this.running=!0,this.runSimplification(t)):this.running=!1},n.prototype.runSimplification=function(t){var e=this;if(t.parallelProcessing)t.settings.forEach(function(o){var a=e.getSimplifier(t);a.simplify(o,function(s){o.distance!==void 0&&t.mesh.addLODLevel(o.distance,s),s.isVisible=!0,o.quality===t.settings[t.settings.length-1].quality&&t.successCallback&&t.successCallback(),e.executeNext()})});else{var i=this.getSimplifier(t),r=function(o,a){i.simplify(o,function(s){o.distance!==void 0&&t.mesh.addLODLevel(o.distance,s),s.isVisible=!0,a()})};re.a.Run(t.settings.length,function(o){r(t.settings[o.index],function(){o.executeNext()})},function(){t.successCallback&&t.successCallback(),e.executeNext()})}},n.prototype.getSimplifier=function(t){switch(t.simplificationType){case Mo.QUADRATIC:default:return new Hf(t.mesh)}},n}(),Mo;(function(n){n[n.QUADRATIC=0]="QUADRATIC"})(Mo||(Mo={}));var gg=function(){function n(t){this.vertices=t,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}return n}(),vg=function(){function n(t,e){this.position=t,this.id=e,this.isBorder=!0,this.q=new Wf,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}return n.prototype.updatePosition=function(t){this.position.copyFrom(t)},n}(),Wf=function(){function n(t){this.data=new Array(10);for(var e=0;e<10;++e)t&&t[e]?this.data[e]=t[e]:this.data[e]=0}return n.prototype.det=function(t,e,i,r,o,a,s,c,_){var b=this.data[t]*this.data[o]*this.data[_]+this.data[i]*this.data[r]*this.data[c]+this.data[e]*this.data[a]*this.data[s]-this.data[i]*this.data[o]*this.data[s]-this.data[t]*this.data[a]*this.data[c]-this.data[e]*this.data[r]*this.data[_];return b},n.prototype.addInPlace=function(t){for(var e=0;e<10;++e)this.data[e]+=t.data[e]},n.prototype.addArrayInPlace=function(t){for(var e=0;e<10;++e)this.data[e]+=t[e]},n.prototype.add=function(t){for(var e=new n,i=0;i<10;++i)e.data[i]=this.data[i]+t.data[i];return e},n.FromData=function(t,e,i,r){return new n(n.DataFromNumbers(t,e,i,r))},n.DataFromNumbers=function(t,e,i,r){return[t*t,t*e,t*i,t*r,e*e,e*i,e*r,i*i,i*r,r*r]},n}(),_g=function(){function n(t,e){this.vertexId=t,this.triangleId=e}return n}(),Hf=function(){function n(t){this._mesh=t,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=ho.a}return n.prototype.simplify=function(t,e){var i=this;this.initDecimatedMesh(),re.a.Run(this._mesh.subMeshes.length,function(r){i.initWithMesh(r.index,function(){i.runDecimation(t,r.index,function(){r.executeNext()})},t.optimizeMesh)},function(){setTimeout(function(){e(i._reconstructedMesh)},0)})},n.prototype.runDecimation=function(t,e,i){var r=this,o=~~(this.triangles.length*t.quality),a=0,s=this.triangles.length,c=function(_,b){setTimeout(function(){_%5==0&&r.updateMesh(_===0);for(var C=0;C<r.triangles.length;++C)r.triangles[C].isDirty=!1;var x=1e-9*Math.pow(_+3,r.aggressiveness),V=function(D){var z=~~((r.triangles.length/2+D)%r.triangles.length),q=r.triangles[z];if(!!q&&!(q.error[3]>x||q.deleted||q.isDirty)){for(var ue=0;ue<3;++ue)if(q.error[ue]<x){var ge=[],Se=[],Pe=q.vertices[ue],me=q.vertices[(ue+1)%3];if(Pe.isBorder||me.isBorder)continue;var xe=l.e.Zero();r.calculateError(Pe,me,xe);var Fe=new Array;if(r.isFlipped(Pe,me,xe,ge,Fe)||r.isFlipped(me,Pe,xe,Se,Fe)||ge.indexOf(!0)<0||Se.indexOf(!0)<0)continue;var we=new Array;if(Fe.forEach(function(je){we.indexOf(je)===-1&&(je.deletePending=!0,we.push(je))}),we.length%2!=0)continue;Pe.q=me.q.add(Pe.q),Pe.updatePosition(xe);var Ge=r.references.length;a=r.updateTriangles(Pe,Pe,ge,a),a=r.updateTriangles(Pe,me,Se,a);var Xe=r.references.length-Ge;if(Xe<=Pe.triangleCount){if(Xe)for(var Oe=0;Oe<Xe;Oe++)r.references[Pe.triangleStart+Oe]=r.references[Ge+Oe]}else Pe.triangleStart=Ge;Pe.triangleCount=Xe;break}}};re.a.SyncAsyncForLoop(r.triangles.length,r.syncIterations,V,b,function(){return s-a<=o})},0)};re.a.Run(this.decimationIterations,function(_){s-a<=o?_.breakLoop():c(_.index,function(){_.executeNext()})},function(){setTimeout(function(){r.reconstructMesh(e),i()},0)})},n.prototype.initWithMesh=function(t,e,i){var r=this;this.vertices=[],this.triangles=[];var o=this._mesh.getVerticesData(Be.b.PositionKind),a=this._mesh.getIndices(),s=this._mesh.subMeshes[t],c=function(x){if(i){for(var V=0;V<r.vertices.length;++V)if(r.vertices[V].position.equalsWithEpsilon(x,1e-4))return r.vertices[V]}return null},_=[],b=function(x){if(!!o){var V=x+s.verticesStart,D=l.e.FromArray(o,V*3),z=c(D)||new vg(D,r.vertices.length);z.originalOffsets.push(V),z.id===r.vertices.length&&r.vertices.push(z),_.push(z.id)}},C=s.verticesCount;re.a.SyncAsyncForLoop(C,this.syncIterations/4>>0,b,function(){var x=function(V){if(!!a){var D=s.indexStart/3+V,z=D*3,q=a[z+0],ue=a[z+1],ge=a[z+2],Se=r.vertices[_[q-s.verticesStart]],Pe=r.vertices[_[ue-s.verticesStart]],me=r.vertices[_[ge-s.verticesStart]],xe=new gg([Se,Pe,me]);xe.originalOffset=z,r.triangles.push(xe)}};re.a.SyncAsyncForLoop(s.indexCount/3,r.syncIterations,x,function(){r.init(e)})})},n.prototype.init=function(t){var e=this,i=function(r){var o=e.triangles[r];o.normal=l.e.Cross(o.vertices[1].position.subtract(o.vertices[0].position),o.vertices[2].position.subtract(o.vertices[0].position)).normalize();for(var a=0;a<3;a++)o.vertices[a].q.addArrayInPlace(Wf.DataFromNumbers(o.normal.x,o.normal.y,o.normal.z,-l.e.Dot(o.normal,o.vertices[0].position)))};re.a.SyncAsyncForLoop(this.triangles.length,this.syncIterations,i,function(){var r=function(o){for(var a=e.triangles[o],s=0;s<3;++s)a.error[s]=e.calculateError(a.vertices[s],a.vertices[(s+1)%3]);a.error[3]=Math.min(a.error[0],a.error[1],a.error[2])};re.a.SyncAsyncForLoop(e.triangles.length,e.syncIterations,r,function(){t()})})},n.prototype.reconstructMesh=function(t){var e=[],i;for(i=0;i<this.vertices.length;++i)this.vertices[i].triangleCount=0;var r,o;for(i=0;i<this.triangles.length;++i)if(!this.triangles[i].deleted){for(r=this.triangles[i],o=0;o<3;++o)r.vertices[o].triangleCount=1;e.push(r)}var a=this._reconstructedMesh.getVerticesData(Be.b.PositionKind)||[],s=this._reconstructedMesh.getVerticesData(Be.b.NormalKind)||[],c=this._reconstructedMesh.getVerticesData(Be.b.UVKind)||[],_=this._reconstructedMesh.getVerticesData(Be.b.ColorKind)||[],b=this._mesh.getVerticesData(Be.b.NormalKind),C=this._mesh.getVerticesData(Be.b.UVKind),x=this._mesh.getVerticesData(Be.b.ColorKind),V=0;for(i=0;i<this.vertices.length;++i){var D=this.vertices[i];D.id=V,D.triangleCount&&D.originalOffsets.forEach(function(me){a.push(D.position.x),a.push(D.position.y),a.push(D.position.z),b&&b.length&&(s.push(b[me*3]),s.push(b[me*3+1]),s.push(b[me*3+2])),C&&C.length&&(c.push(C[me*2]),c.push(C[me*2+1])),x&&x.length&&(_.push(x[me*4]),_.push(x[me*4+1]),_.push(x[me*4+2]),_.push(x[me*4+3])),++V})}var z=this._reconstructedMesh.getTotalIndices(),q=this._reconstructedMesh.getTotalVertices(),ue=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];var ge=this._reconstructedMesh.getIndices(),Se=this._mesh.getIndices();for(i=0;i<e.length;++i)r=e[i],[0,1,2].forEach(function(me){var xe=Se[r.originalOffset+me],Fe=r.vertices[me].originalOffsets.indexOf(xe);Fe<0&&(Fe=0),ge.push(r.vertices[me].id+Fe+q)});this._reconstructedMesh.setIndices(ge),this._reconstructedMesh.setVerticesData(Be.b.PositionKind,a),s.length>0&&this._reconstructedMesh.setVerticesData(Be.b.NormalKind,s),c.length>0&&this._reconstructedMesh.setVerticesData(Be.b.UVKind,c),_.length>0&&this._reconstructedMesh.setVerticesData(Be.b.ColorKind,_);var Pe=this._mesh.subMeshes[t];t>0&&(this._reconstructedMesh.subMeshes=[],ue.forEach(function(me){Ro.a.AddToMesh(me.materialIndex,me.verticesStart,me.verticesCount,me.indexStart,me.indexCount,me.getMesh())}),Ro.a.AddToMesh(Pe.materialIndex,q,V,z,e.length*3,this._reconstructedMesh))},n.prototype.initDecimatedMesh=function(){this._reconstructedMesh=new st.a(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId},n.prototype.isFlipped=function(t,e,i,r,o){for(var a=0;a<t.triangleCount;++a){var s=this.triangles[this.references[t.triangleStart+a].triangleId];if(!s.deleted){var c=this.references[t.triangleStart+a].vertexId,_=s.vertices[(c+1)%3],b=s.vertices[(c+2)%3];if(_===e||b===e){r[a]=!0,o.push(s);continue}var C=_.position.subtract(i);C=C.normalize();var x=b.position.subtract(i);if(x=x.normalize(),Math.abs(l.e.Dot(C,x))>.999)return!0;var V=l.e.Cross(C,x).normalize();if(r[a]=!1,l.e.Dot(V,s.normal)<.2)return!0}}return!1},n.prototype.updateTriangles=function(t,e,i,r){for(var o=r,a=0;a<e.triangleCount;++a){var s=this.references[e.triangleStart+a],c=this.triangles[s.triangleId];if(!c.deleted){if(i[a]&&c.deletePending){c.deleted=!0,o++;continue}c.vertices[s.vertexId]=t,c.isDirty=!0,c.error[0]=this.calculateError(c.vertices[0],c.vertices[1])+c.borderFactor/2,c.error[1]=this.calculateError(c.vertices[1],c.vertices[2])+c.borderFactor/2,c.error[2]=this.calculateError(c.vertices[2],c.vertices[0])+c.borderFactor/2,c.error[3]=Math.min(c.error[0],c.error[1],c.error[2]),this.references.push(s)}}return o},n.prototype.identifyBorder=function(){for(var t=0;t<this.vertices.length;++t){var e=[],i=[],r=this.vertices[t],o;for(o=0;o<r.triangleCount;++o)for(var a=this.triangles[this.references[r.triangleStart+o].triangleId],s=0;s<3;s++){for(var c=0,_=a.vertices[s];c<e.length&&i[c]!==_.id;)++c;c===e.length?(e.push(1),i.push(_.id)):e[c]++}for(o=0;o<e.length;++o)e[o]===1?this.vertices[i[o]].isBorder=!0:this.vertices[i[o]].isBorder=!1}},n.prototype.updateMesh=function(t){t===void 0&&(t=!1);var e;if(!t){var i=[];for(e=0;e<this.triangles.length;++e)this.triangles[e].deleted||i.push(this.triangles[e]);this.triangles=i}for(e=0;e<this.vertices.length;++e)this.vertices[e].triangleCount=0,this.vertices[e].triangleStart=0;var r,o,a;for(e=0;e<this.triangles.length;++e)for(r=this.triangles[e],o=0;o<3;++o)a=r.vertices[o],a.triangleCount++;var s=0;for(e=0;e<this.vertices.length;++e)this.vertices[e].triangleStart=s,s+=this.vertices[e].triangleCount,this.vertices[e].triangleCount=0;var c=new Array(this.triangles.length*3);for(e=0;e<this.triangles.length;++e)for(r=this.triangles[e],o=0;o<3;++o)a=r.vertices[o],c[a.triangleStart+a.triangleCount]=new _g(o,e),a.triangleCount++;this.references=c,t&&this.identifyBorder()},n.prototype.vertexError=function(t,e){var i=e.x,r=e.y,o=e.z;return t.data[0]*i*i+2*t.data[1]*i*r+2*t.data[2]*i*o+2*t.data[3]*i+t.data[4]*r*r+2*t.data[5]*r*o+2*t.data[6]*r+t.data[7]*o*o+2*t.data[8]*o+t.data[9]},n.prototype.calculateError=function(t,e,i){var r=t.q.add(e.q),o=t.isBorder&&e.isBorder,a=0,s=r.det(0,1,2,1,4,5,2,5,7);if(s!==0&&!o)i||(i=l.e.Zero()),i.x=-1/s*r.det(1,2,3,4,5,6,5,7,8),i.y=1/s*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/s*r.det(0,1,3,1,4,6,2,5,8),a=this.vertexError(r,i);else{var c=t.position.add(e.position).divide(new l.e(2,2,2)),_=this.vertexError(r,t.position),b=this.vertexError(r,e.position),C=this.vertexError(r,c);a=Math.min(_,b,C),a===_?i&&i.copyFrom(t.position):a===b?i&&i.copyFrom(e.position):i&&i.copyFrom(c)}return a},n}();Object.defineProperty(ae.a.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new jf;var n=this._getComponent(X.a.NAME_SIMPLIFICATIONQUEUE);n||(n=new kf(this),this._addComponent(n))}return this._simplificationQueue},set:function(n){this._simplificationQueue=n},enumerable:!0,configurable:!0}),st.a.prototype.simplify=function(n,t,e,i){return t===void 0&&(t=!0),e===void 0&&(e=Mo.QUADRATIC),this.getScene().simplificationQueue.addTask({settings:n,parallelProcessing:t,mesh:this,simplificationType:e,successCallback:i}),this};var kf=function(){function n(t){this.name=X.a.NAME_SIMPLIFICATIONQUEUE,this.scene=t}return n.prototype.register=function(){this.scene._beforeCameraUpdateStage.registerStep(X.a.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n.prototype._beforeCameraUpdate=function(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()},n}(),Xf=u(737),yg=u(721),bg=u(734),Yf=u(697),Eg=u(706),Pg=u(735),Cg=u(736),Sg=u(617),Tg=u(738),Ag=u(739),Rg=u(740),Og=u(636),Mg=u(741),xg=u(742),Dg=u(708),sy=u(555),Ig=u(608),Kf=u(561),Lg=function(){function n(t){if(t===void 0&&(t=Recast),this.bjsRECAST={},this.name="RecastJSPlugin",this._maximumSubStepCount=10,this._timeStep=1/60,typeof t=="function"?t(this.bjsRECAST):this.bjsRECAST=t,!this.isSupported()){d.a.Error("RecastJS is not available. Please make sure you included the js file.");return}this.setTimeStep()}return n.prototype.setTimeStep=function(t){t===void 0&&(t=1/60),this._timeStep=t},n.prototype.getTimeStep=function(){return this._timeStep},n.prototype.setMaximumSubStepCount=function(t){t===void 0&&(t=10),this._maximumSubStepCount=t},n.prototype.getMaximumSubStepCount=function(){return this._maximumSubStepCount},n.prototype.createNavMesh=function(t,e){var i=new this.bjsRECAST.rcConfig;i.cs=e.cs,i.ch=e.ch,i.borderSize=e.borderSize?e.borderSize:0,i.tileSize=e.tileSize?e.tileSize:0,i.walkableSlopeAngle=e.walkableSlopeAngle,i.walkableHeight=e.walkableHeight,i.walkableClimb=e.walkableClimb,i.walkableRadius=e.walkableRadius,i.maxEdgeLen=e.maxEdgeLen,i.maxSimplificationError=e.maxSimplificationError,i.minRegionArea=e.minRegionArea,i.mergeRegionArea=e.mergeRegionArea,i.maxVertsPerPoly=e.maxVertsPerPoly,i.detailSampleDist=e.detailSampleDist,i.detailSampleMaxError=e.detailSampleMaxError,this.navMesh=new this.bjsRECAST.NavMesh;var r,o,a,s=[],c=[],_=0;for(r=0;r<t.length;r++)if(t[r]){var b=t[r],C=b.getIndices();if(!C)continue;var x=b.getVerticesData(Be.b.PositionKind,!1,!1);if(!x)continue;var V=[],D=b.computeWorldMatrix(!0);if(b.hasThinInstances)for(var z=b.thinInstanceGetWorldMatrices(),q=0;q<z.length;q++){var ue=new tt.k,ge=z[q];ge.multiplyToRef(D,ue),V.push(ue)}else V.push(D);for(var Se=0;Se<V.length;Se++){var Pe=V[Se];for(o=0;o<C.length;o++)s.push(C[o]+_);var me=tt.z.Zero(),xe=tt.z.Zero();for(a=0;a<x.length;a+=3)tt.z.FromArrayToRef(x,a,xe),tt.z.TransformCoordinatesToRef(xe,Pe,me),c.push(me.x,me.y,me.z);_+=x.length/3}}this.navMesh.build(c,_,s,s.length,i)},n.prototype.createDebugNavMesh=function(t){var e,i,r=this.navMesh.getDebugNavMesh(),o=r.getTriangleCount(),a=[],s=[];for(e=0;e<o*3;e++)a.push(e);for(e=0;e<o;e++)for(i=0;i<3;i++){var c=r.getTriangle(e).getPoint(i);s.push(c.x,c.y,c.z)}var _=new st.a("NavMeshDebug",t),b=new an.a;return b.indices=a,b.positions=s,b.applyToMesh(_,!1),_},n.prototype.getClosestPoint=function(t){var e=new this.bjsRECAST.Vec3(t.x,t.y,t.z),i=this.navMesh.getClosestPoint(e),r=new tt.z(i.x,i.y,i.z);return r},n.prototype.getClosestPointToRef=function(t,e){var i=new this.bjsRECAST.Vec3(t.x,t.y,t.z),r=this.navMesh.getClosestPoint(i);e.set(r.x,r.y,r.z)},n.prototype.getRandomPointAround=function(t,e){var i=new this.bjsRECAST.Vec3(t.x,t.y,t.z),r=this.navMesh.getRandomPointAround(i,e),o=new tt.z(r.x,r.y,r.z);return o},n.prototype.getRandomPointAroundToRef=function(t,e,i){var r=new this.bjsRECAST.Vec3(t.x,t.y,t.z),o=this.navMesh.getRandomPointAround(r,e);i.set(o.x,o.y,o.z)},n.prototype.moveAlong=function(t,e){var i=new this.bjsRECAST.Vec3(t.x,t.y,t.z),r=new this.bjsRECAST.Vec3(e.x,e.y,e.z),o=this.navMesh.moveAlong(i,r),a=new tt.z(o.x,o.y,o.z);return a},n.prototype.moveAlongToRef=function(t,e,i){var r=new this.bjsRECAST.Vec3(t.x,t.y,t.z),o=new this.bjsRECAST.Vec3(e.x,e.y,e.z),a=this.navMesh.moveAlong(r,o);i.set(a.x,a.y,a.z)},n.prototype.computePath=function(t,e){var i,r=new this.bjsRECAST.Vec3(t.x,t.y,t.z),o=new this.bjsRECAST.Vec3(e.x,e.y,e.z),a=this.navMesh.computePath(r,o),s=a.getPointCount(),c=[];for(i=0;i<s;i++){var _=a.getPoint(i);c.push(new tt.z(_.x,_.y,_.z))}return c},n.prototype.createCrowd=function(t,e,i){var r=new Qf(this,t,e,i);return r},n.prototype.setDefaultQueryExtent=function(t){var e=new this.bjsRECAST.Vec3(t.x,t.y,t.z);this.navMesh.setDefaultQueryExtent(e)},n.prototype.getDefaultQueryExtent=function(){var t=this.navMesh.getDefaultQueryExtent();return new tt.z(t.x,t.y,t.z)},n.prototype.buildFromNavmeshData=function(t){var e=t.length*t.BYTES_PER_ELEMENT,i=this.bjsRECAST._malloc(e),r=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,i,e);r.set(t);var o=new this.bjsRECAST.NavmeshData;o.dataPointer=r.byteOffset,o.size=t.length,this.navMesh=new this.bjsRECAST.NavMesh,this.navMesh.buildFromNavmeshData(o),this.bjsRECAST._free(r.byteOffset)},n.prototype.getNavmeshData=function(){var t=this.navMesh.getNavmeshData(),e=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,t.dataPointer,t.size),i=new Uint8Array(t.size);return i.set(e),this.navMesh.freeNavmeshData(t),i},n.prototype.getDefaultQueryExtentToRef=function(t){var e=this.navMesh.getDefaultQueryExtent();t.set(e.x,e.y,e.z)},n.prototype.dispose=function(){},n.prototype.addCylinderObstacle=function(t,e,i){return this.navMesh.addCylinderObstacle(new this.bjsRECAST.Vec3(t.x,t.y,t.z),e,i)},n.prototype.addBoxObstacle=function(t,e,i){return this.navMesh.addBoxObstacle(new this.bjsRECAST.Vec3(t.x,t.y,t.z),new this.bjsRECAST.Vec3(e.x,e.y,e.z),i)},n.prototype.removeObstacle=function(t){this.navMesh.removeObstacle(t)},n.prototype.isSupported=function(){return this.bjsRECAST!==void 0},n}(),Qf=function(){function n(t,e,i,r){var o=this;this.recastCrowd={},this.transforms=new Array,this.agents=new Array,this._onBeforeAnimationsObserver=null,this.bjsRECASTPlugin=t,this.recastCrowd=new this.bjsRECASTPlugin.bjsRECAST.Crowd(e,i,this.bjsRECASTPlugin.navMesh.getNavMesh()),this._scene=r,this._onBeforeAnimationsObserver=r.onBeforeAnimationsObservable.add(function(){o.update(r.getEngine().getDeltaTime()*.001)})}return n.prototype.addAgent=function(t,e,i){var r=new this.bjsRECASTPlugin.bjsRECAST.dtCrowdAgentParams;r.radius=e.radius,r.height=e.height,r.maxAcceleration=e.maxAcceleration,r.maxSpeed=e.maxSpeed,r.collisionQueryRange=e.collisionQueryRange,r.pathOptimizationRange=e.pathOptimizationRange,r.separationWeight=e.separationWeight,r.updateFlags=7,r.obstacleAvoidanceType=0,r.queryFilterType=0,r.userData=0;var o=this.recastCrowd.addAgent(new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z),r);return this.transforms.push(i),this.agents.push(o),o},n.prototype.getAgentPosition=function(t){var e=this.recastCrowd.getAgentPosition(t);return new tt.z(e.x,e.y,e.z)},n.prototype.getAgentPositionToRef=function(t,e){var i=this.recastCrowd.getAgentPosition(t);e.set(i.x,i.y,i.z)},n.prototype.getAgentVelocity=function(t){var e=this.recastCrowd.getAgentVelocity(t);return new tt.z(e.x,e.y,e.z)},n.prototype.getAgentVelocityToRef=function(t,e){var i=this.recastCrowd.getAgentVelocity(t);e.set(i.x,i.y,i.z)},n.prototype.getAgentNextTargetPath=function(t){var e=this.recastCrowd.getAgentNextTargetPath(t);return new tt.z(e.x,e.y,e.z)},n.prototype.getAgentNextTargetPathToRef=function(t,e){var i=this.recastCrowd.getAgentNextTargetPath(t);e.set(i.x,i.y,i.z)},n.prototype.getAgentState=function(t){return this.recastCrowd.getAgentState(t)},n.prototype.overOffmeshConnection=function(t){return this.recastCrowd.overOffmeshConnection(t)},n.prototype.agentGoto=function(t,e){this.recastCrowd.agentGoto(t,new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z))},n.prototype.agentTeleport=function(t,e){this.recastCrowd.agentTeleport(t,new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z))},n.prototype.updateAgentParameters=function(t,e){var i=this.recastCrowd.getAgentParameters(t);e.radius!==void 0&&(i.radius=e.radius),e.height!==void 0&&(i.height=e.height),e.maxAcceleration!==void 0&&(i.maxAcceleration=e.maxAcceleration),e.maxSpeed!==void 0&&(i.maxSpeed=e.maxSpeed),e.collisionQueryRange!==void 0&&(i.collisionQueryRange=e.collisionQueryRange),e.pathOptimizationRange!==void 0&&(i.pathOptimizationRange=e.pathOptimizationRange),e.separationWeight!==void 0&&(i.separationWeight=e.separationWeight),this.recastCrowd.setAgentParameters(t,i)},n.prototype.removeAgent=function(t){this.recastCrowd.removeAgent(t);var e=this.agents.indexOf(t);e>-1&&(this.agents.splice(e,1),this.transforms.splice(e,1))},n.prototype.getAgents=function(){return this.agents},n.prototype.update=function(t){this.bjsRECASTPlugin.navMesh.update();var e=this.bjsRECASTPlugin.getTimeStep(),i=this.bjsRECASTPlugin.getMaximumSubStepCount();if(e<=tt.i)this.recastCrowd.update(t);else{var r=Math.floor(t/e);i&&r>i&&(r=i),r<1&&(r=1);for(var o=t/r,a=0;a<r;a++)this.recastCrowd.update(o)}for(var s=0;s<this.agents.length;s++)this.transforms[s].position=this.getAgentPosition(this.agents[s])},n.prototype.setDefaultQueryExtent=function(t){var e=new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z);this.recastCrowd.setDefaultQueryExtent(e)},n.prototype.getDefaultQueryExtent=function(){var t=this.recastCrowd.getDefaultQueryExtent();return new tt.z(t.x,t.y,t.z)},n.prototype.getDefaultQueryExtentToRef=function(t){var e=this.recastCrowd.getDefaultQueryExtent();t.set(e.x,e.y,e.z)},n.prototype.getCorners=function(t){var e,i=this.recastCrowd.getPath(t),r=i.getPointCount(),o=[];for(e=0;e<r;e++){var a=i.getPoint(e);o.push(new tt.z(a.x,a.y,a.z))}return o},n.prototype.dispose=function(){this.recastCrowd.destroy(),this._scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null},n}();G.a.OfflineProviderFactory=function(n,t,e){return e===void 0&&(e=!1),new Zf(n,t,e)};var Zf=function(){function n(t,e,i){var r=this;i===void 0&&(i=!1),this._idbFactory=typeof window!="undefined"?window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB:indexedDB,this._callbackManifestChecked=e,this._currentSceneUrl=n._ReturnFullUrlLocation(t),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,n.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,re.b.SetImmediate(function(){r._callbackManifestChecked(!0)})):this._checkManifestFile():this._callbackManifestChecked(!0)}return Object.defineProperty(n.prototype,"enableSceneOffline",{get:function(){return this._enableSceneOffline},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"enableTexturesOffline",{get:function(){return this._enableTexturesOffline},enumerable:!1,configurable:!0}),n.prototype._checkManifestFile=function(){var t=this,e=function(){t._enableSceneOffline=!1,t._enableTexturesOffline=!1,t._callbackManifestChecked(!1)},i=!1,r=this._currentSceneUrl+".manifest",o=new Rr.a;navigator.onLine&&(i=!0,r=r+(r.match(/\?/)==null?"?":"&")+Date.now()),o.open("GET",r),o.addEventListener("load",function(){if(o.status===200||n._ValidateXHRData(o,1))try{var a=JSON.parse(o.response);t._enableSceneOffline=a.enableSceneOffline,t._enableTexturesOffline=a.enableTexturesOffline&&n.IsUASupportingBlobStorage,a.version&&!isNaN(parseInt(a.version))&&(t._manifestVersionFound=a.version),t._callbackManifestChecked&&t._callbackManifestChecked(!0)}catch(s){e()}else e()},!1),o.addEventListener("error",function(){if(i){i=!1;var a=t._currentSceneUrl+".manifest";o.open("GET",a),o.send()}else e()},!1);try{o.send()}catch(a){d.a.Error("Error on XHR send request."),this._callbackManifestChecked(!1)}},n.prototype.open=function(t,e){var i=this,r=function(){i._isSupported=!1,e&&e()};if(!this._idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline))this._isSupported=!1,e&&e();else if(this._db)t&&t();else{this._hasReachedQuota=!1,this._isSupported=!0;var o=this._idbFactory.open("babylonjs",1);o.onerror=function(){r()},o.onblocked=function(){d.a.Error("IDB request blocked. Please reload the page."),r()},o.onsuccess=function(){i._db=o.result,t()},o.onupgradeneeded=function(a){if(i._db=a.target.result,i._db)try{i._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),i._db.createObjectStore("versions",{keyPath:"sceneUrl"}),i._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(s){d.a.Error("Error while creating object stores. Exception: "+s.message),r()}}}},n.prototype.loadImage=function(t,e){var i=this,r=n._ReturnFullUrlLocation(t),o=function(){!i._hasReachedQuota&&i._db!==null?i._saveImageIntoDBAsync(r,e):e.src=t};this._mustUpdateRessources?o():this._loadImageFromDBAsync(r,e,o)},n.prototype._loadImageFromDBAsync=function(t,e,i){if(this._isSupported&&this._db!==null){var r,o=this._db.transaction(["textures"]);o.onabort=function(){e.src=t},o.oncomplete=function(){var s;if(r){var c=window.URL||window.webkitURL;s=c.createObjectURL(r.data),e.onerror=function(){d.a.Error("Error loading image from blob URL: "+s+" switching back to web url: "+t),e.src=t},e.src=s}else i()};var a=o.objectStore("textures").get(t);a.onsuccess=function(s){r=s.target.result},a.onerror=function(){d.a.Error("Error loading texture "+t+" from DB."),e.src=t}}else d.a.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),e.src=t},n.prototype._saveImageIntoDBAsync=function(t,e){var i=this;if(this._isSupported){var r=function(){var s;if(a){var c=window.URL||window.webkitURL;try{s=c.createObjectURL(a)}catch(_){s=c.createObjectURL(a)}}s&&(e.src=s)};if(n.IsUASupportingBlobStorage){var o=new Rr.a,a;o.open("GET",t),o.responseType="blob",o.addEventListener("load",function(){if(o.status===200&&i._db){a=o.response;var s=i._db.transaction(["textures"],"readwrite");s.onabort=function(b){try{var C=b.srcElement||b.target,x=C.error;x&&x.name==="QuotaExceededError"&&(i._hasReachedQuota=!0)}catch(V){}r()},s.oncomplete=function(){r()};var c={textureUrl:t,data:a};try{var _=s.objectStore("textures").put(c);_.onsuccess=function(){},_.onerror=function(){r()}}catch(b){b.code===25&&(n.IsUASupportingBlobStorage=!1,i._enableTexturesOffline=!1),e.src=t}}else e.src=t},!1),o.addEventListener("error",function(){d.a.Error("Error in XHR request in BABYLON.Database."),e.src=t},!1),o.send()}else e.src=t}else d.a.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),e.src=t},n.prototype._checkVersionFromDB=function(t,e){var i=this,r=function(){i._saveVersionIntoDBAsync(t,e)};this._loadVersionFromDBAsync(t,e,r)},n.prototype._loadVersionFromDBAsync=function(t,e,i){var r=this;if(this._isSupported&&this._db){var o;try{var a=this._db.transaction(["versions"]);a.oncomplete=function(){o?r._manifestVersionFound!==o.data?(r._mustUpdateRessources=!0,i()):e(o.data):(r._mustUpdateRessources=!0,i())},a.onabort=function(){e(-1)};var s=a.objectStore("versions").get(t);s.onsuccess=function(c){o=c.target.result},s.onerror=function(){d.a.Error("Error loading version for scene "+t+" from DB."),e(-1)}}catch(c){d.a.Error("Error while accessing 'versions' object store (READ OP). Exception: "+c.message),e(-1)}}else d.a.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),e(-1)},n.prototype._saveVersionIntoDBAsync=function(t,e){var i=this;if(this._isSupported&&!this._hasReachedQuota&&this._db)try{var r=this._db.transaction(["versions"],"readwrite");r.onabort=function(s){try{var c=s.srcElement.error;c&&c.name==="QuotaExceededError"&&(i._hasReachedQuota=!0)}catch(_){}e(-1)},r.oncomplete=function(){e(i._manifestVersionFound)};var o={sceneUrl:t,data:this._manifestVersionFound},a=r.objectStore("versions").put(o);a.onsuccess=function(){},a.onerror=function(){d.a.Error("Error in DB add version request in BABYLON.Database.")}}catch(s){d.a.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+s.message),e(-1)}else e(-1)},n.prototype.loadFile=function(t,e,i,r,o){var a=this,s=n._ReturnFullUrlLocation(t),c=function(){a._saveFileAsync(s,e,i,o,r)};this._checkVersionFromDB(s,function(_){_!==-1?a._mustUpdateRessources?a._saveFileAsync(s,e,i,o,r):a._loadFileAsync(s,e,c):r&&r()})},n.prototype._loadFileAsync=function(t,e,i){if(this._isSupported&&this._db){var r;t.indexOf(".babylon")!==-1?r="scenes":r="textures";var o,a=this._db.transaction([r]);a.oncomplete=function(){o?e(o.data):i()},a.onabort=function(){i()};var s=a.objectStore(r).get(t);s.onsuccess=function(c){o=c.target.result},s.onerror=function(){d.a.Error("Error loading file "+t+" from DB."),i()}}else d.a.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),e()},n.prototype._saveFileAsync=function(t,e,i,r,o){var a=this;if(this._isSupported){var s;t.indexOf(".babylon")!==-1?s="scenes":s="textures";var c=new Rr.a,_;c.open("GET",t+"?"+Date.now()),r&&(c.responseType="arraybuffer"),i&&(c.onprogress=i),c.addEventListener("load",function(){if(c.status===200||c.status<400&&n._ValidateXHRData(c,r?6:1))if(_=r?c.response:c.responseText,!a._hasReachedQuota&&a._db){var b=a._db.transaction([s],"readwrite");b.onabort=function(V){try{var D=V.srcElement.error;D&&D.name==="QuotaExceededError"&&(a._hasReachedQuota=!0)}catch(z){}e(_)},b.oncomplete=function(){e(_)};var C;s==="scenes"?C={sceneUrl:t,data:_,version:a._manifestVersionFound}:C={textureUrl:t,data:_};try{var x=b.objectStore(s).put(C);x.onsuccess=function(){},x.onerror=function(){d.a.Error("Error in DB add file request in BABYLON.Database.")}}catch(V){e(_)}}else e(_);else c.status>=400&&o?o(c):e()},!1),c.addEventListener("error",function(){d.a.Error("error on XHR request."),e()},!1),c.send()}else d.a.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),e()},n._ValidateXHRData=function(t,e){e===void 0&&(e=7);try{if(e&1){if(t.responseText&&t.responseText.length>0)return!0;if(e===1)return!1}if(e&2){var i=qo.GetTGAHeader(t.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(e===2)return!1}if(e&4){var r=new Uint8Array(t.response,0,3);return r[0]===68&&r[1]===68&&r[2]===83}}catch(o){}return!1},n.IsUASupportingBlobStorage=!0,n.IDBStorageEnabled=!1,n._ParseURL=function(t){var e=document.createElement("a");e.href=t;var i=t.substring(0,t.lastIndexOf("#")),r=t.substring(i.lastIndexOf("/")+1,t.length),o=t.substring(0,t.indexOf(r,0));return o},n._ReturnFullUrlLocation=function(t){return t.indexOf("http:/")===-1&&t.indexOf("https:/")===-1&&typeof window!="undefined"?n._ParseURL(window.location.href)+t:t},n}(),qs=function(){function n(t,e,i){this.gradient=t,this.color1=e,this.color2=i}return n.prototype.getColorToRef=function(t){if(!this.color2){t.copyFrom(this.color1);return}v.b.LerpToRef(this.color1,this.color2,Math.random(),t)},n}(),Jf=function(){function n(t,e){this.gradient=t,this.color=e}return n}(),el=function(){function n(t,e,i){this.gradient=t,this.factor1=e,this.factor2=i}return n.prototype.getFactor=function(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()},n}(),Qi=function(){function n(){}return n.GetCurrentGradient=function(t,e,i){if(e[0].gradient>t){i(e[0],e[0],1);return}for(var r=0;r<e.length-1;r++){var o=e[r],a=e[r+1];if(t>=o.gradient&&t<=a.gradient){var s=(t-o.gradient)/(a.gradient-o.gradient);i(o,a,s);return}}var c=e.length-1;i(e[c],e[c],1)},n}(),$f=function(){function n(t){this.particleSystem=t,this.position=l.e.Zero(),this.direction=l.e.Zero(),this.color=new v.b(0,0,0,0),this.colorStep=new v.b(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new l.d(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new v.b(0,0,0,0),this._currentColor2=new v.b(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=n._Count++,!!this.particleSystem.isAnimationSheetEnabled&&this.updateCellInfoFromSystem()}return n.prototype.updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID},n.prototype.updateCellIndex=function(){var t=this.age,e=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),e===0?(e=1,t=this._randomCellOffset):t+=this._randomCellOffset);var i=this._initialEndSpriteCellID-this._initialStartSpriteCellID,r=$e.a.Clamp(t*e%this.lifeTime/this.lifeTime);this.cellIndex=this._initialStartSpriteCellID+r*i|0},n.prototype._inheritParticleInfoToSubEmitter=function(t){if(t.particleSystem.emitter.position){var e=t.particleSystem.emitter;if(e.position.copyFrom(this.position),t.inheritDirection){var i=l.c.Vector3[0];this.direction.normalizeToRef(i),e.setDirection(i,0,Math.PI/2)}}else{var r=t.particleSystem.emitter;r.copyFrom(this.position)}this.direction.scaleToRef(t.inheritedVelocityAmount/2,l.c.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(l.c.Vector3[0])},n.prototype._inheritParticleInfoToSubEmitters=function(){var t=this;this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(function(e){t._inheritParticleInfoToSubEmitter(e)})},n.prototype._reset=function(){this.age=0,this.id=n._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0},n.prototype.copyTo=function(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this._initialStartSpriteCellID,t._initialEndSpriteCellID=this._initialEndSpriteCellID),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new l.f(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))},n._Count=0,n}(),Dn;(function(n){n[n.ATTACHED=0]="ATTACHED",n[n.END=1]="END"})(Dn||(Dn={}));var xo=function(){function n(t){if(this.particleSystem=t,this.type=Dn.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!t.emitter||!t.emitter.dispose){var e=f.a.GetClass("BABYLON.AbstractMesh");t.emitter=new e("SubemitterSystemEmitter",t.getScene())}t.onDisposeObservable.add(function(){t.emitter&&t.emitter.dispose&&t.emitter.dispose()})}return n.prototype.clone=function(){var t=this.particleSystem.emitter;if(!t)t=new l.e;else if(t instanceof l.e)t=t.clone();else if(t.getClassName().indexOf("Mesh")!==-1){var e=f.a.GetClass("BABYLON.Mesh");t=new e("",t.getScene()),t.isVisible=!1}var i=new n(this.particleSystem.clone("",t));return i.particleSystem.name+="Clone",i.type=this.type,i.inheritDirection=this.inheritDirection,i.inheritedVelocityAmount=this.inheritedVelocityAmount,i.particleSystem._disposeEmitterOnDispose=!0,i.particleSystem.disposeOnStop=!0,i},n.prototype.serialize=function(){var t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(),t},n._ParseParticleSystem=function(t,e,i){throw Re.a.WarnImport("ParseParticle")},n.Parse=function(t,e,i){var r=t.particleSystem,o=new n(n._ParseParticleSystem(r,e,i));return o.type=t.type,o.inheritDirection=t.inheritDirection,o.inheritedVelocityAmount=t.inheritedVelocityAmount,o.particleSystem._isSubEmitter=!0,o},n.prototype.dispose=function(){this.particleSystem.dispose()},n}(),qf="particlesPixelShader",eh=`
varying vec2 vUV;
varying vec4 vColor;
uniform vec4 textureMask;
uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
uniform sampler2D rampSampler;
#endif
void main(void) {
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);
vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;
float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);
vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));
baseColor.rgb*=rampColor.rgb;

float finalAlpha=baseColor.a;
baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;
baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif


#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);
baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
}`;qe.a.ShadersStore[qf]=eh;var ly={name:qf,shader:eh},th="particlesVertexShader",ih=`
attribute vec3 position;
attribute vec4 color;
attribute float angle;
attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;

uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos;
#endif

varying vec2 vUV;
varying vec4 vColor;
varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix=mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix=mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#endif
void main(void) {
vec2 cornerPos;
cornerPos=(vec2(offset.x-0.5,offset.y-0.5)-translationPivot)*size+translationPivot;
#ifdef BILLBOARD

vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=position-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=position-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;
vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif

gl_Position=projection*vec4(viewPos,1.0);
#else

vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=normalize(direction);
vPositionW=rotate(yaxis,rotatedCorner);
gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);
float columnOffset=cellIndex-rowOffset/particlesInfos.z;
vec2 uvScale=particlesInfos.xy;
vec2 uvOffset=vec2(offset.x ,1.0-offset.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif

#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
}`;qe.a.ShadersStore[th]=ih;var uy={name:th,shader:ih},gi=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){o===void 0&&(o=null),a===void 0&&(a=!1),s===void 0&&(s=.01);var c=n.call(this,e)||this;c._inheritedVelocityOffset=new l.e,c.onDisposeObservable=new g.c,c.onStoppedObservable=new g.c,c._particles=new Array,c._stockParticles=new Array,c._newPartsExcess=0,c._vertexBuffers={},c._scaledColorStep=new v.b(0,0,0,0),c._colorDiff=new v.b(0,0,0,0),c._scaledDirection=l.e.Zero(),c._scaledGravity=l.e.Zero(),c._currentRenderId=-1,c._useInstancing=!1,c._started=!1,c._stopped=!1,c._actualFrame=0,c._currentEmitRate1=0,c._currentEmitRate2=0,c._currentStartSize1=0,c._currentStartSize2=0,c._rawTextureWidth=256,c._useRampGradients=!1,c._disposeEmitterOnDispose=!1,c.isLocal=!1,c._onBeforeDrawParticlesObservable=null,c.recycleParticle=function(b){var C=c._particles.pop();C!==b&&C.copyTo(b),c._stockParticles.push(C)},c._createParticle=function(){var b;if(c._stockParticles.length!==0?(b=c._stockParticles.pop(),b._reset()):b=new $f(c),c._subEmitters&&c._subEmitters.length>0){var C=c._subEmitters[Math.floor(Math.random()*c._subEmitters.length)];b._attachedSubEmitters=[],C.forEach(function(x){if(x.type===Dn.ATTACHED){var V=x.clone();b._attachedSubEmitters.push(V),V.particleSystem.start()}})}return b},c._emitFromParticle=function(b){if(!(!c._subEmitters||c._subEmitters.length===0)){var C=Math.floor(Math.random()*c._subEmitters.length);c._subEmitters[C].forEach(function(x){if(x.type===Dn.END){var V=x.clone();b._inheritParticleInfoToSubEmitter(V),V.particleSystem._rootParticleSystem=c,c.activeSubSystems.push(V.particleSystem),V.particleSystem.start()}})}},c._capacity=i,c._epsilon=s,c._isAnimationSheetEnabled=a,!r||r.getClassName()==="Scene"?(c._scene=r||Kt.a.LastCreatedScene,c._engine=c._scene.getEngine(),c.uniqueId=c._scene.getUniqueId(),c._scene.particleSystems.push(c)):(c._engine=r,c.defaultProjectionMatrix=l.a.PerspectiveFovLH(.8,1,.1,100)),c._engine.getCaps().vertexArrayObject&&(c._vertexArrayObject=null),c._attachImageProcessingConfiguration(null),c._customEffect={0:o},c._useInstancing=c._engine.getCaps().instancedArrays,c._createIndexBuffer(),c._createVertexBuffers(),c.particleEmitterType=new Mn;var _=null;return c.updateFunction=function(b){var C,x=null;c.noiseTexture&&(x=c.noiseTexture.getSize(),(C=c.noiseTexture.getContent())===null||C===void 0||C.then(function(q){_=q}));for(var V=function(){D=b[z];var q=c._scaledUpdateSpeed,ue=D.age;if(D.age+=q,D.age>D.lifeTime){var ge=D.age-ue,Se=D.lifeTime-ue;q=Se*q/ge,D.age=D.lifeTime}var Pe=D.age/D.lifeTime;c._colorGradients&&c._colorGradients.length>0?Qi.GetCurrentGradient(Pe,c._colorGradients,function(Oe,je,ke){Oe!==D._currentColorGradient&&(D._currentColor1.copyFrom(D._currentColor2),je.getColorToRef(D._currentColor2),D._currentColorGradient=Oe),v.b.LerpToRef(D._currentColor1,D._currentColor2,ke,D.color)}):(D.colorStep.scaleToRef(q,c._scaledColorStep),D.color.addInPlace(c._scaledColorStep),D.color.a<0&&(D.color.a=0)),c._angularSpeedGradients&&c._angularSpeedGradients.length>0&&Qi.GetCurrentGradient(Pe,c._angularSpeedGradients,function(Oe,je,ke){Oe!==D._currentAngularSpeedGradient&&(D._currentAngularSpeed1=D._currentAngularSpeed2,D._currentAngularSpeed2=je.getFactor(),D._currentAngularSpeedGradient=Oe),D.angularSpeed=$e.a.Lerp(D._currentAngularSpeed1,D._currentAngularSpeed2,ke)}),D.angle+=D.angularSpeed*q;var me=q;if(c._velocityGradients&&c._velocityGradients.length>0&&Qi.GetCurrentGradient(Pe,c._velocityGradients,function(Oe,je,ke){Oe!==D._currentVelocityGradient&&(D._currentVelocity1=D._currentVelocity2,D._currentVelocity2=je.getFactor(),D._currentVelocityGradient=Oe),me*=$e.a.Lerp(D._currentVelocity1,D._currentVelocity2,ke)}),D.direction.scaleToRef(me,c._scaledDirection),c._limitVelocityGradients&&c._limitVelocityGradients.length>0&&Qi.GetCurrentGradient(Pe,c._limitVelocityGradients,function(Oe,je,ke){Oe!==D._currentLimitVelocityGradient&&(D._currentLimitVelocity1=D._currentLimitVelocity2,D._currentLimitVelocity2=je.getFactor(),D._currentLimitVelocityGradient=Oe);var ze=$e.a.Lerp(D._currentLimitVelocity1,D._currentLimitVelocity2,ke),Je=D.direction.length();Je>ze&&D.direction.scaleInPlace(c.limitVelocityDamping)}),c._dragGradients&&c._dragGradients.length>0&&Qi.GetCurrentGradient(Pe,c._dragGradients,function(Oe,je,ke){Oe!==D._currentDragGradient&&(D._currentDrag1=D._currentDrag2,D._currentDrag2=je.getFactor(),D._currentDragGradient=Oe);var ze=$e.a.Lerp(D._currentDrag1,D._currentDrag2,ke);c._scaledDirection.scaleInPlace(1-ze)}),c.isLocal&&D._localPosition?(D._localPosition.addInPlace(c._scaledDirection),l.e.TransformCoordinatesToRef(D._localPosition,c._emitterWorldMatrix,D.position)):D.position.addInPlace(c._scaledDirection),_&&x&&D._randomNoiseCoordinates1){var xe=c._fetchR(D._randomNoiseCoordinates1.x,D._randomNoiseCoordinates1.y,x.width,x.height,_),Fe=c._fetchR(D._randomNoiseCoordinates1.z,D._randomNoiseCoordinates2.x,x.width,x.height,_),we=c._fetchR(D._randomNoiseCoordinates2.y,D._randomNoiseCoordinates2.z,x.width,x.height,_),Ge=l.c.Vector3[0],Xe=l.c.Vector3[1];Ge.copyFromFloats((2*xe-1)*c.noiseStrength.x,(2*Fe-1)*c.noiseStrength.y,(2*we-1)*c.noiseStrength.z),Ge.scaleToRef(q,Xe),D.direction.addInPlace(Xe)}if(c.gravity.scaleToRef(q,c._scaledGravity),D.direction.addInPlace(c._scaledGravity),c._sizeGradients&&c._sizeGradients.length>0&&Qi.GetCurrentGradient(Pe,c._sizeGradients,function(Oe,je,ke){Oe!==D._currentSizeGradient&&(D._currentSize1=D._currentSize2,D._currentSize2=je.getFactor(),D._currentSizeGradient=Oe),D.size=$e.a.Lerp(D._currentSize1,D._currentSize2,ke)}),c._useRampGradients&&(c._colorRemapGradients&&c._colorRemapGradients.length>0&&Qi.GetCurrentGradient(Pe,c._colorRemapGradients,function(Oe,je,ke){var ze=$e.a.Lerp(Oe.factor1,je.factor1,ke),Je=$e.a.Lerp(Oe.factor2,je.factor2,ke);D.remapData.x=ze,D.remapData.y=Je-ze}),c._alphaRemapGradients&&c._alphaRemapGradients.length>0&&Qi.GetCurrentGradient(Pe,c._alphaRemapGradients,function(Oe,je,ke){var ze=$e.a.Lerp(Oe.factor1,je.factor1,ke),Je=$e.a.Lerp(Oe.factor2,je.factor2,ke);D.remapData.z=ze,D.remapData.w=Je-ze})),c._isAnimationSheetEnabled&&D.updateCellIndex(),D._inheritParticleInfoToSubEmitters(),D.age>=D.lifeTime)return c._emitFromParticle(D),D._attachedSubEmitters&&(D._attachedSubEmitters.forEach(function(Oe){Oe.particleSystem.disposeOnStop=!0,Oe.particleSystem.stop()}),D._attachedSubEmitters=null),c.recycleParticle(D),z--,"continue"},D,z=0;z<b.length;z++)V()},c}return Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"useRampGradients",{get:function(){return this._useRampGradients},set:function(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"particles",{get:function(){return this._particles},enumerable:!1,configurable:!0}),t.prototype.getActiveCount=function(){return this._particles.length},t.prototype.getClassName=function(){return"ParticleSystem"},t.prototype.isStopping=function(){return this._stopped&&this.isAlive()},t.prototype.getCustomEffect=function(e){var i;return e===void 0&&(e=0),(i=this._customEffect[e])!==null&&i!==void 0?i:this._customEffect[0]},t.prototype.setCustomEffect=function(e,i){i===void 0&&(i=0),this._customEffect[i]=e},Object.defineProperty(t.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new g.c),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vertexShaderName",{get:function(){return"particles"},enumerable:!1,configurable:!0}),t.prototype._addFactorGradient=function(e,i,r,o){var a=new el(i,r,o);e.push(a),e.sort(function(s,c){return s.gradient<c.gradient?-1:s.gradient>c.gradient?1:0})},t.prototype._removeFactorGradient=function(e,i){if(!!e)for(var r=0,o=0,a=e;o<a.length;o++){var s=a[o];if(s.gradient===i){e.splice(r,1);break}r++}},t.prototype.addLifeTimeGradient=function(e,i,r){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,i,r),this},t.prototype.removeLifeTimeGradient=function(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this},t.prototype.addSizeGradient=function(e,i,r){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,i,r),this},t.prototype.removeSizeGradient=function(e){return this._removeFactorGradient(this._sizeGradients,e),this},t.prototype.addColorRemapGradient=function(e,i,r){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,i,r),this},t.prototype.removeColorRemapGradient=function(e){return this._removeFactorGradient(this._colorRemapGradients,e),this},t.prototype.addAlphaRemapGradient=function(e,i,r){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,i,r),this},t.prototype.removeAlphaRemapGradient=function(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this},t.prototype.addAngularSpeedGradient=function(e,i,r){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,i,r),this},t.prototype.removeAngularSpeedGradient=function(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this},t.prototype.addVelocityGradient=function(e,i,r){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,i,r),this},t.prototype.removeVelocityGradient=function(e){return this._removeFactorGradient(this._velocityGradients,e),this},t.prototype.addLimitVelocityGradient=function(e,i,r){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,i,r),this},t.prototype.removeLimitVelocityGradient=function(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this},t.prototype.addDragGradient=function(e,i,r){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,i,r),this},t.prototype.removeDragGradient=function(e){return this._removeFactorGradient(this._dragGradients,e),this},t.prototype.addEmitRateGradient=function(e,i,r){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,i,r),this},t.prototype.removeEmitRateGradient=function(e){return this._removeFactorGradient(this._emitRateGradients,e),this},t.prototype.addStartSizeGradient=function(e,i,r){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,i,r),this},t.prototype.removeStartSizeGradient=function(e){return this._removeFactorGradient(this._startSizeGradients,e),this},t.prototype._createRampGradientTexture=function(){if(!(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)){for(var e=new Uint8Array(this._rawTextureWidth*4),i=v.c.Color3[0],r=0;r<this._rawTextureWidth;r++){var o=r/this._rawTextureWidth;Qi.GetCurrentGradient(o,this._rampGradients,function(a,s,c){v.a.LerpToRef(a.color,s.color,c,i),e[r*4]=i.r*255,e[r*4+1]=i.g*255,e[r*4+2]=i.b*255,e[r*4+3]=255})}this._rampGradientsTexture=kr.a.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}},t.prototype.getRampGradients=function(){return this._rampGradients},t.prototype.forceRefreshGradients=function(){this._syncRampGradientTexture()},t.prototype._syncRampGradientTexture=function(){!this._rampGradients||(this._rampGradients.sort(function(e,i){return e.gradient<i.gradient?-1:e.gradient>i.gradient?1:0}),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())},t.prototype.addRampGradient=function(e,i){this._rampGradients||(this._rampGradients=[]);var r=new Jf(e,i);return this._rampGradients.push(r),this._syncRampGradientTexture(),this},t.prototype.removeRampGradient=function(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this},t.prototype.addColorGradient=function(e,i,r){this._colorGradients||(this._colorGradients=[]);var o=new qs(e,i,r);return this._colorGradients.push(o),this._colorGradients.sort(function(a,s){return a.gradient<s.gradient?-1:a.gradient>s.gradient?1:0}),this},t.prototype.removeColorGradient=function(e){if(!this._colorGradients)return this;for(var i=0,r=0,o=this._colorGradients;r<o.length;r++){var a=o[r];if(a.gradient===e){this._colorGradients.splice(i,1);break}i++}return this},t.prototype._fetchR=function(e,i,r,o,a){e=Math.abs(e)*.5+.5,i=Math.abs(i)*.5+.5;var s=e*r%r|0,c=i*o%o|0,_=(s+c*r)*4;return a[_]/255},t.prototype._reset=function(){this._resetEffect()},t.prototype._resetEffect=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()},t.prototype._createVertexBuffers=function(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===t.BILLBOARDMODE_STRETCHED)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);var e=this._engine;this._vertexData=new Float32Array(this._capacity*this._vertexBufferSize*(this._useInstancing?1:4)),this._vertexBuffer=new Be.a(e,this._vertexData,!0,this._vertexBufferSize);var i=0,r=this._vertexBuffer.createVertexBuffer(Be.b.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Be.b.PositionKind]=r,i+=3;var o=this._vertexBuffer.createVertexBuffer(Be.b.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Be.b.ColorKind]=o,i+=4;var a=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=a,i+=1;var s=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=s,i+=2,this._isAnimationSheetEnabled){var c=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=c,i+=1}if(!this._isBillboardBased||this.billboardMode===t.BILLBOARDMODE_STRETCHED){var _=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=_,i+=3}if(this._useRampGradients){var b=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=b,i+=4}var C;if(this._useInstancing){var x=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Be.a(e,x,!1,2),C=this._spriteBuffer.createVertexBuffer("offset",0,2)}else C=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=C},t.prototype._createIndexBuffer=function(){if(!this._useInstancing){for(var e=[],i=0,r=0;r<this._capacity;r++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}},t.prototype.getCapacity=function(){return this._capacity},t.prototype.isAlive=function(){return this._alive},t.prototype.isStarted=function(){return this._started},t.prototype._prepareSubEmitterInternalArray=function(){var e=this;this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(function(i){i instanceof t?e._subEmitters.push([new xo(i)]):i instanceof xo?e._subEmitters.push([i]):i instanceof Array&&e._subEmitters.push(i)})},t.prototype.start=function(e){var i=this,r;if(e===void 0&&(e=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(function(){i.start(0)},e);return}if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((r=this.emitter)===null||r===void 0?void 0:r.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);var o=this.noiseTexture;if(o&&o.onGeneratedObservable)o.onGeneratedObservable.addOnce(function(){setTimeout(function(){for(var s=0;s<i.preWarmCycles;s++)i.animate(!0),o.render()})});else for(var a=0;a<this.preWarmCycles;a++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)},t.prototype.stop=function(e){e===void 0&&(e=!0),!this._stopped&&(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,e&&this._stopSubEmitters())},t.prototype.reset=function(){this._stockParticles=[],this._particles=[]},t.prototype._appendParticleVertex=function(e,i,r,o){var a=e*this._vertexBufferSize;if(this._vertexData[a++]=i.position.x+this.worldOffset.x,this._vertexData[a++]=i.position.y+this.worldOffset.y,this._vertexData[a++]=i.position.z+this.worldOffset.z,this._vertexData[a++]=i.color.r,this._vertexData[a++]=i.color.g,this._vertexData[a++]=i.color.b,this._vertexData[a++]=i.color.a,this._vertexData[a++]=i.angle,this._vertexData[a++]=i.scale.x*i.size,this._vertexData[a++]=i.scale.y*i.size,this._isAnimationSheetEnabled&&(this._vertexData[a++]=i.cellIndex),this._isBillboardBased)this.billboardMode===t.BILLBOARDMODE_STRETCHED&&(this._vertexData[a++]=i.direction.x,this._vertexData[a++]=i.direction.y,this._vertexData[a++]=i.direction.z);else if(i._initialDirection){var s=i._initialDirection;this.isLocal&&(l.e.TransformNormalToRef(s,this._emitterWorldMatrix,l.c.Vector3[0]),s=l.c.Vector3[0]),s.x===0&&s.z===0&&(s.x=.001),this._vertexData[a++]=s.x,this._vertexData[a++]=s.y,this._vertexData[a++]=s.z}else{var c=i.direction;this.isLocal&&(l.e.TransformNormalToRef(c,this._emitterWorldMatrix,l.c.Vector3[0]),c=l.c.Vector3[0]),c.x===0&&c.z===0&&(c.x=.001),this._vertexData[a++]=c.x,this._vertexData[a++]=c.y,this._vertexData[a++]=c.z}this._useRampGradients&&i.remapData&&(this._vertexData[a++]=i.remapData.x,this._vertexData[a++]=i.remapData.y,this._vertexData[a++]=i.remapData.z,this._vertexData[a++]=i.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),o===0?o=this._epsilon:o===1&&(o=1-this._epsilon)),this._vertexData[a++]=r,this._vertexData[a++]=o)},t.prototype._stopSubEmitters=function(){!this.activeSubSystems||(this.activeSubSystems.forEach(function(e){e.stop(!0)}),this.activeSubSystems=new Array)},t.prototype._removeFromRoot=function(){if(!!this._rootParticleSystem){var e=this._rootParticleSystem.activeSubSystems.indexOf(this);e!==-1&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}},t.prototype._update=function(e){var i=this;if(this._alive=this._particles.length>0,this.emitter.position){var r=this.emitter;this._emitterWorldMatrix=r.getWorldMatrix()}else{var o=this.emitter;this._emitterWorldMatrix=l.a.Translation(o.x,o.y,o.z)}this.updateFunction(this._particles);for(var a,s=function(){if(c._particles.length===c._capacity)return"break";if(a=c._createParticle(),c._particles.push(a),c.targetStopDuration&&c._lifeTimeGradients&&c._lifeTimeGradients.length>0){var x=$e.a.Clamp(c._actualFrame/c.targetStopDuration);Qi.GetCurrentGradient(x,c._lifeTimeGradients,function(z,q){var ue=z,ge=q,Se=ue.getFactor(),Pe=ge.getFactor(),me=(x-ue.gradient)/(ge.gradient-ue.gradient);a.lifeTime=$e.a.Lerp(Se,Pe,me)})}else a.lifeTime=$e.a.RandomRange(c.minLifeTime,c.maxLifeTime);var V=$e.a.RandomRange(c.minEmitPower,c.maxEmitPower);if(c.startPositionFunction?c.startPositionFunction(c._emitterWorldMatrix,a.position,a,c.isLocal):c.particleEmitterType.startPositionFunction(c._emitterWorldMatrix,a.position,a,c.isLocal),c.isLocal&&(a._localPosition?a._localPosition.copyFrom(a.position):a._localPosition=a.position.clone(),l.e.TransformCoordinatesToRef(a._localPosition,c._emitterWorldMatrix,a.position)),c.startDirectionFunction?c.startDirectionFunction(c._emitterWorldMatrix,a.direction,a,c.isLocal):c.particleEmitterType.startDirectionFunction(c._emitterWorldMatrix,a.direction,a,c.isLocal),V===0?a._initialDirection?a._initialDirection.copyFrom(a.direction):a._initialDirection=a.direction.clone():a._initialDirection=null,a.direction.scaleInPlace(V),!c._sizeGradients||c._sizeGradients.length===0?a.size=$e.a.RandomRange(c.minSize,c.maxSize):(a._currentSizeGradient=c._sizeGradients[0],a._currentSize1=a._currentSizeGradient.getFactor(),a.size=a._currentSize1,c._sizeGradients.length>1?a._currentSize2=c._sizeGradients[1].getFactor():a._currentSize2=a._currentSize1),a.scale.copyFromFloats($e.a.RandomRange(c.minScaleX,c.maxScaleX),$e.a.RandomRange(c.minScaleY,c.maxScaleY)),c._startSizeGradients&&c._startSizeGradients[0]&&c.targetStopDuration){var D=c._actualFrame/c.targetStopDuration;Qi.GetCurrentGradient(D,c._startSizeGradients,function(z,q,ue){z!==i._currentStartSizeGradient&&(i._currentStartSize1=i._currentStartSize2,i._currentStartSize2=q.getFactor(),i._currentStartSizeGradient=z);var ge=$e.a.Lerp(i._currentStartSize1,i._currentStartSize2,ue);a.scale.scaleInPlace(ge)})}!c._angularSpeedGradients||c._angularSpeedGradients.length===0?a.angularSpeed=$e.a.RandomRange(c.minAngularSpeed,c.maxAngularSpeed):(a._currentAngularSpeedGradient=c._angularSpeedGradients[0],a.angularSpeed=a._currentAngularSpeedGradient.getFactor(),a._currentAngularSpeed1=a.angularSpeed,c._angularSpeedGradients.length>1?a._currentAngularSpeed2=c._angularSpeedGradients[1].getFactor():a._currentAngularSpeed2=a._currentAngularSpeed1),a.angle=$e.a.RandomRange(c.minInitialRotation,c.maxInitialRotation),c._velocityGradients&&c._velocityGradients.length>0&&(a._currentVelocityGradient=c._velocityGradients[0],a._currentVelocity1=a._currentVelocityGradient.getFactor(),c._velocityGradients.length>1?a._currentVelocity2=c._velocityGradients[1].getFactor():a._currentVelocity2=a._currentVelocity1),c._limitVelocityGradients&&c._limitVelocityGradients.length>0&&(a._currentLimitVelocityGradient=c._limitVelocityGradients[0],a._currentLimitVelocity1=a._currentLimitVelocityGradient.getFactor(),c._limitVelocityGradients.length>1?a._currentLimitVelocity2=c._limitVelocityGradients[1].getFactor():a._currentLimitVelocity2=a._currentLimitVelocity1),c._dragGradients&&c._dragGradients.length>0&&(a._currentDragGradient=c._dragGradients[0],a._currentDrag1=a._currentDragGradient.getFactor(),c._dragGradients.length>1?a._currentDrag2=c._dragGradients[1].getFactor():a._currentDrag2=a._currentDrag1),!c._colorGradients||c._colorGradients.length===0?(_=$e.a.RandomRange(0,1),v.b.LerpToRef(c.color1,c.color2,_,a.color),c.colorDead.subtractToRef(a.color,c._colorDiff),c._colorDiff.scaleToRef(1/a.lifeTime,a.colorStep)):(a._currentColorGradient=c._colorGradients[0],a._currentColorGradient.getColorToRef(a.color),a._currentColor1.copyFrom(a.color),c._colorGradients.length>1?c._colorGradients[1].getColorToRef(a._currentColor2):a._currentColor2.copyFrom(a.color)),c._isAnimationSheetEnabled&&(a._initialStartSpriteCellID=c.startSpriteCellID,a._initialEndSpriteCellID=c.endSpriteCellID),a.direction.addInPlace(c._inheritedVelocityOffset),c._useRampGradients&&(a.remapData=new l.f(0,1,0,1)),c.noiseTexture&&(a._randomNoiseCoordinates1?(a._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),a._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(a._randomNoiseCoordinates1=new l.e(Math.random(),Math.random(),Math.random()),a._randomNoiseCoordinates2=new l.e(Math.random(),Math.random(),Math.random()))),a._inheritParticleInfoToSubEmitters()},c=this,_,b=0;b<e;b++){var C=s();if(C==="break")break}},t._GetAttributeNamesOrOptions=function(e,i,r){e===void 0&&(e=!1),i===void 0&&(i=!1),r===void 0&&(r=!1);var o=[Be.b.PositionKind,Be.b.ColorKind,"angle","offset","size"];return e&&o.push("cellIndex"),i||o.push("direction"),r&&o.push("remapData"),o},t._GetEffectCreationOptions=function(e){e===void 0&&(e=!1);var i=["invView","view","projection","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","textureMask","translationPivot","eyePosition"];return e&&i.push("particlesInfos"),i},t.prototype.fillDefines=function(e,i){if(this._scene&&(this._scene.clipPlane&&e.push("#define CLIPPLANE"),this._scene.clipPlane2&&e.push("#define CLIPPLANE2"),this._scene.clipPlane3&&e.push("#define CLIPPLANE3"),this._scene.clipPlane4&&e.push("#define CLIPPLANE4"),this._scene.clipPlane5&&e.push("#define CLIPPLANE5"),this._scene.clipPlane6&&e.push("#define CLIPPLANE6")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i===t.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case t.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case t.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case t.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break;default:break}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))},t.prototype.fillUniformsAttributesAndSamplerNames=function(e,i,r){i.push.apply(i,t._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==t.BILLBOARDMODE_STRETCHED,this._useRampGradients)),e.push.apply(e,t._GetEffectCreationOptions(this._isAnimationSheetEnabled)),r.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(gr.a.PrepareUniforms(e,this._imageProcessingConfigurationDefines),gr.a.PrepareSamplers(r,this._imageProcessingConfigurationDefines))},t.prototype._getEffect=function(e){var i=this.getCustomEffect(e);if(i)return i;var r=[];this.fillDefines(r,e);var o=r.join(`
`);if(this._cachedDefines!==o){this._cachedDefines=o;var a=[],s=[],c=[];this.fillUniformsAttributesAndSamplerNames(s,a,c),this._effect=this._engine.createEffect("particles",a,s,c,o)}return this._effect},t.prototype.animate=function(e){var i=this,r;if(e===void 0&&(e=!1),!!this._started){if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:((r=this._scene)===null||r===void 0?void 0:r.getAnimationRatio())||1);var o;if(this.manualEmitCount>-1)o=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{var a=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){var s=this._actualFrame/this.targetStopDuration;Qi.GetCurrentGradient(s,this._emitRateGradients,function(C,x,V){C!==i._currentEmitRateGradient&&(i._currentEmitRate1=i._currentEmitRate2,i._currentEmitRate2=x.getFactor(),i._currentEmitRateGradient=C),a=$e.a.Lerp(i._currentEmitRate1,i._currentEmitRate2,V)})}o=a*this._scaledUpdateSpeed>>0,this._newPartsExcess+=a*this._scaledUpdateSpeed-o}if(this._newPartsExcess>1&&(o+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?o=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(o),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){for(var c=0,_=0;_<this._particles.length;_++){var b=this._particles[_];this._appendParticleVertices(c,b),c+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.update(this._vertexData)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}},t.prototype._appendParticleVertices=function(e,i){this._appendParticleVertex(e++,i,0,0),this._useInstancing||(this._appendParticleVertex(e++,i,1,0),this._appendParticleVertex(e++,i,1,1),this._appendParticleVertex(e++,i,0,1))},t.prototype.rebuild=function(){this._createIndexBuffer(),this._vertexBuffer&&this._vertexBuffer._rebuild();for(var e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()},t.prototype.isReady=function(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==t.BLENDMODE_MULTIPLYADD){if(!this._getEffect(this.blendMode).isReady())return!1}else if(!this._getEffect(t.BLENDMODE_MULTIPLY).isReady()||!this._getEffect(t.BLENDMODE_ADD).isReady())return!1;return!0},t.prototype._render=function(e){var i,r,o=this._getEffect(e),a=this._engine;a.enableEffect(o);var s=(i=this.defaultViewMatrix)!==null&&i!==void 0?i:this._scene.getViewMatrix();if(o.setTexture("diffuseSampler",this.particleTexture),o.setMatrix("view",s),o.setMatrix("projection",(r=this.defaultProjectionMatrix)!==null&&r!==void 0?r:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){var c=this.particleTexture.getBaseSize();o.setFloat3("particlesInfos",this.spriteCellWidth/c.width,this.spriteCellHeight/c.height,this.spriteCellWidth/c.width)}if(o.setVector2("translationPivot",this.translationPivot),o.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){var _=this._scene.activeCamera;o.setVector3("eyePosition",_.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),o.setTexture("rampSampler",this._rampGradientsTexture));var b=o.defines;switch(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&vc.a.BindClipPlane(o,this._scene),b.indexOf("#define BILLBOARDMODE_ALL")>=0&&(s.invertToRef(l.c.Matrix[0]),o.setMatrix("invView",l.c.Matrix[0])),this._vertexArrayObject!==void 0?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,o)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):a.bindBuffers(this._vertexBuffers,this._indexBuffer,o),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(o),e){case t.BLENDMODE_ADD:a.setAlphaMode(1);break;case t.BLENDMODE_ONEONE:a.setAlphaMode(6);break;case t.BLENDMODE_STANDARD:a.setAlphaMode(2);break;case t.BLENDMODE_MULTIPLY:a.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(o),this._useInstancing?a.drawArraysType(7,0,4,this._particles.length):a.drawElementsType(0,0,this._particles.length*6),this._particles.length},t.prototype.render=function(){if(!this.isReady()||!this._particles.length)return 0;var e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));var i=0;return this.blendMode===t.BLENDMODE_MULTIPLYADD?i=this._render(t.BLENDMODE_MULTIPLY)+this._render(t.BLENDMODE_ADD):i=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),i},t.prototype.dispose=function(e){if(e===void 0&&(e=!0),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this._subEmitters&&this._subEmitters.length){for(var i=0;i<this._subEmitters.length;i++)for(var r=0,o=this._subEmitters[i];r<o.length;r++){var a=o[r];a.dispose()}this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){var i=this._scene.particleSystems.indexOf(this);i>-1&&this._scene.particleSystems.splice(i,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()},t.prototype.clone=function(e,i){var r=Object(p.a)({},this._customEffect),o=null,a=this._engine;if(a.createEffectForParticles&&this.customShader!=null){o=this.customShader;var s=o.shaderOptions.defines.length>0?o.shaderOptions.defines.join(`
`):"";r[0]=a.createEffectForParticles(o.shaderPath.fragmentElement,o.shaderOptions.uniforms,o.shaderOptions.samplers,s)}var c=this.serialize(),_=t.Parse(c,this._scene||this._engine,this._rootUrl);return _.name=e,_.customShader=o,_._customEffect=r,i===void 0&&(i=this.emitter),this.noiseTexture&&(_.noiseTexture=this.noiseTexture.clone()),_.emitter=i,this.preventAutoStart||_.start(),_},t.prototype.serialize=function(e){e===void 0&&(e=!1);var i={};if(t._Serialize(i,this,e),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,this.subEmitters){i.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(var r=0,o=this._subEmitters;r<o.length;r++){for(var a=o[r],s=[],c=0,_=a;c<_.length;c++){var b=_[c];s.push(b.serialize())}i.subEmitters.push(s)}}return i},t._Serialize=function(e,i,r){if(e.name=i.name,e.id=i.id,e.capacity=i.getCapacity(),e.disposeOnStop=i.disposeOnStop,e.manualEmitCount=i.manualEmitCount,i.emitter.position){var o=i.emitter;e.emitterId=o.id}else{var a=i.emitter;e.emitter=a.asArray()}i.particleEmitterType&&(e.particleEmitterType=i.particleEmitterType.serialize()),i.particleTexture&&(r?e.texture=i.particleTexture.serialize():(e.textureName=i.particleTexture.name,e.invertY=!!i.particleTexture._invertY)),e.isLocal=i.isLocal,Ee.a.AppendSerializedAnimations(i,e),e.beginAnimationOnStart=i.beginAnimationOnStart,e.beginAnimationFrom=i.beginAnimationFrom,e.beginAnimationTo=i.beginAnimationTo,e.beginAnimationLoop=i.beginAnimationLoop,e.startDelay=i.startDelay,e.renderingGroupId=i.renderingGroupId,e.isBillboardBased=i.isBillboardBased,e.billboardMode=i.billboardMode,e.minAngularSpeed=i.minAngularSpeed,e.maxAngularSpeed=i.maxAngularSpeed,e.minSize=i.minSize,e.maxSize=i.maxSize,e.minScaleX=i.minScaleX,e.maxScaleX=i.maxScaleX,e.minScaleY=i.minScaleY,e.maxScaleY=i.maxScaleY,e.minEmitPower=i.minEmitPower,e.maxEmitPower=i.maxEmitPower,e.minLifeTime=i.minLifeTime,e.maxLifeTime=i.maxLifeTime,e.emitRate=i.emitRate,e.gravity=i.gravity.asArray(),e.noiseStrength=i.noiseStrength.asArray(),e.color1=i.color1.asArray(),e.color2=i.color2.asArray(),e.colorDead=i.colorDead.asArray(),e.updateSpeed=i.updateSpeed,e.targetStopDuration=i.targetStopDuration,e.blendMode=i.blendMode,e.preWarmCycles=i.preWarmCycles,e.preWarmStepOffset=i.preWarmStepOffset,e.minInitialRotation=i.minInitialRotation,e.maxInitialRotation=i.maxInitialRotation,e.startSpriteCellID=i.startSpriteCellID,e.endSpriteCellID=i.endSpriteCellID,e.spriteCellChangeSpeed=i.spriteCellChangeSpeed,e.spriteCellWidth=i.spriteCellWidth,e.spriteCellHeight=i.spriteCellHeight,e.spriteRandomStartCell=i.spriteRandomStartCell,e.isAnimationSheetEnabled=i.isAnimationSheetEnabled;var s=i.getColorGradients();if(s){e.colorGradients=[];for(var c=0,_=s;c<_.length;c++){var b=_[c],C={gradient:b.gradient,color1:b.color1.asArray()};b.color2?C.color2=b.color2.asArray():C.color2=b.color1.asArray(),e.colorGradients.push(C)}}var x=i.getRampGradients();if(x){e.rampGradients=[];for(var V=0,D=x;V<D.length;V++){var z=D[V],C={gradient:z.gradient,color:z.color.asArray()};e.rampGradients.push(C)}e.useRampGradients=i.useRampGradients}var q=i.getColorRemapGradients();if(q){e.colorRemapGradients=[];for(var ue=0,ge=q;ue<ge.length;ue++){var Se=ge[ue],C={gradient:Se.gradient,factor1:Se.factor1};Se.factor2!==void 0?C.factor2=Se.factor2:C.factor2=Se.factor1,e.colorRemapGradients.push(C)}}var Pe=i.getAlphaRemapGradients();if(Pe){e.alphaRemapGradients=[];for(var me=0,xe=Pe;me<xe.length;me++){var Fe=xe[me],C={gradient:Fe.gradient,factor1:Fe.factor1};Fe.factor2!==void 0?C.factor2=Fe.factor2:C.factor2=Fe.factor1,e.alphaRemapGradients.push(C)}}var we=i.getSizeGradients();if(we){e.sizeGradients=[];for(var Ge=0,Xe=we;Ge<Xe.length;Ge++){var Oe=Xe[Ge],C={gradient:Oe.gradient,factor1:Oe.factor1};Oe.factor2!==void 0?C.factor2=Oe.factor2:C.factor2=Oe.factor1,e.sizeGradients.push(C)}}var je=i.getAngularSpeedGradients();if(je){e.angularSpeedGradients=[];for(var ke=0,ze=je;ke<ze.length;ke++){var Je=ze[ke],C={gradient:Je.gradient,factor1:Je.factor1};Je.factor2!==void 0?C.factor2=Je.factor2:C.factor2=Je.factor1,e.angularSpeedGradients.push(C)}}var it=i.getVelocityGradients();if(it){e.velocityGradients=[];for(var Ke=0,St=it;Ke<St.length;Ke++){var Mt=St[Ke],C={gradient:Mt.gradient,factor1:Mt.factor1};Mt.factor2!==void 0?C.factor2=Mt.factor2:C.factor2=Mt.factor1,e.velocityGradients.push(C)}}var Rt=i.getDragGradients();if(Rt){e.dragGradients=[];for(var at=0,Bt=Rt;at<Bt.length;at++){var Wt=Bt[at],C={gradient:Wt.gradient,factor1:Wt.factor1};Wt.factor2!==void 0?C.factor2=Wt.factor2:C.factor2=Wt.factor1,e.dragGradients.push(C)}}var lt=i.getEmitRateGradients();if(lt){e.emitRateGradients=[];for(var Ft=0,Qe=lt;Ft<Qe.length;Ft++){var ct=Qe[Ft],C={gradient:ct.gradient,factor1:ct.factor1};ct.factor2!==void 0?C.factor2=ct.factor2:C.factor2=ct.factor1,e.emitRateGradients.push(C)}}var wt=i.getStartSizeGradients();if(wt){e.startSizeGradients=[];for(var fi=0,si=wt;fi<si.length;fi++){var xi=si[fi],C={gradient:xi.gradient,factor1:xi.factor1};xi.factor2!==void 0?C.factor2=xi.factor2:C.factor2=xi.factor1,e.startSizeGradients.push(C)}}var bi=i.getLifeTimeGradients();if(bi){e.lifeTimeGradients=[];for(var Tt=0,$t=bi;Tt<$t.length;Tt++){var vi=$t[Tt],C={gradient:vi.gradient,factor1:vi.factor1};vi.factor2!==void 0?C.factor2=vi.factor2:C.factor2=vi.factor1,e.lifeTimeGradients.push(C)}}var hi=i.getLimitVelocityGradients();if(hi){e.limitVelocityGradients=[];for(var di=0,ft=hi;di<ft.length;di++){var oi=ft[di],C={gradient:oi.gradient,factor1:oi.factor1};oi.factor2!==void 0?C.factor2=oi.factor2:C.factor2=oi.factor1,e.limitVelocityGradients.push(C)}e.limitVelocityDamping=i.limitVelocityDamping}i.noiseTexture&&(e.noiseTexture=i.noiseTexture.serialize())},t._Parse=function(e,i,r,o){var a,s,c;r instanceof fn.a?c=null:c=r;var _=f.a.GetClass("BABYLON.Texture");if(_&&c&&(e.texture?i.particleTexture=_.Parse(e.texture,c,o):e.textureName&&(i.particleTexture=new _(o+e.textureName,c,!1,e.invertY!==void 0?e.invertY:!0),i.particleTexture.name=e.textureName)),!e.emitterId&&e.emitterId!==0&&e.emitter===void 0?i.emitter=l.e.Zero():e.emitterId&&c?i.emitter=c.getLastMeshByID(e.emitterId):i.emitter=l.e.FromArray(e.emitter),i.isLocal=!!e.isLocal,e.renderingGroupId!==void 0&&(i.renderingGroupId=e.renderingGroupId),e.isBillboardBased!==void 0&&(i.isBillboardBased=e.isBillboardBased),e.billboardMode!==void 0&&(i.billboardMode=e.billboardMode),e.animations){for(var b=0;b<e.animations.length;b++){var C=e.animations[b],x=f.a.GetClass("BABYLON.Animation");x&&i.animations.push(x.Parse(C))}i.beginAnimationOnStart=e.beginAnimationOnStart,i.beginAnimationFrom=e.beginAnimationFrom,i.beginAnimationTo=e.beginAnimationTo,i.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&c&&c.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),i.startDelay=e.startDelay|0,i.minAngularSpeed=e.minAngularSpeed,i.maxAngularSpeed=e.maxAngularSpeed,i.minSize=e.minSize,i.maxSize=e.maxSize,e.minScaleX&&(i.minScaleX=e.minScaleX,i.maxScaleX=e.maxScaleX,i.minScaleY=e.minScaleY,i.maxScaleY=e.maxScaleY),e.preWarmCycles!==void 0&&(i.preWarmCycles=e.preWarmCycles,i.preWarmStepOffset=e.preWarmStepOffset),e.minInitialRotation!==void 0&&(i.minInitialRotation=e.minInitialRotation,i.maxInitialRotation=e.maxInitialRotation),i.minLifeTime=e.minLifeTime,i.maxLifeTime=e.maxLifeTime,i.minEmitPower=e.minEmitPower,i.maxEmitPower=e.maxEmitPower,i.emitRate=e.emitRate,i.gravity=l.e.FromArray(e.gravity),e.noiseStrength&&(i.noiseStrength=l.e.FromArray(e.noiseStrength)),i.color1=v.b.FromArray(e.color1),i.color2=v.b.FromArray(e.color2),i.colorDead=v.b.FromArray(e.colorDead),i.updateSpeed=e.updateSpeed,i.targetStopDuration=e.targetStopDuration,i.blendMode=e.blendMode,e.colorGradients)for(var V=0,D=e.colorGradients;V<D.length;V++){var z=D[V];i.addColorGradient(z.gradient,v.b.FromArray(z.color1),z.color2?v.b.FromArray(z.color2):void 0)}if(e.rampGradients){for(var q=0,ue=e.rampGradients;q<ue.length;q++){var ge=ue[q];i.addRampGradient(ge.gradient,v.a.FromArray(ge.color))}i.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(var Se=0,Pe=e.colorRemapGradients;Se<Pe.length;Se++){var me=Pe[Se];i.addColorRemapGradient(me.gradient,me.factor1!==void 0?me.factor1:me.factor,me.factor2)}if(e.alphaRemapGradients)for(var xe=0,Fe=e.alphaRemapGradients;xe<Fe.length;xe++){var we=Fe[xe];i.addAlphaRemapGradient(we.gradient,we.factor1!==void 0?we.factor1:we.factor,we.factor2)}if(e.sizeGradients)for(var Ge=0,Xe=e.sizeGradients;Ge<Xe.length;Ge++){var Oe=Xe[Ge];i.addSizeGradient(Oe.gradient,Oe.factor1!==void 0?Oe.factor1:Oe.factor,Oe.factor2)}if(e.angularSpeedGradients)for(var je=0,ke=e.angularSpeedGradients;je<ke.length;je++){var ze=ke[je];i.addAngularSpeedGradient(ze.gradient,ze.factor1!==void 0?ze.factor1:ze.factor,ze.factor2)}if(e.velocityGradients)for(var Je=0,it=e.velocityGradients;Je<it.length;Je++){var Ke=it[Je];i.addVelocityGradient(Ke.gradient,Ke.factor1!==void 0?Ke.factor1:Ke.factor,Ke.factor2)}if(e.dragGradients)for(var St=0,Mt=e.dragGradients;St<Mt.length;St++){var Rt=Mt[St];i.addDragGradient(Rt.gradient,Rt.factor1!==void 0?Rt.factor1:Rt.factor,Rt.factor2)}if(e.emitRateGradients)for(var at=0,Bt=e.emitRateGradients;at<Bt.length;at++){var Wt=Bt[at];i.addEmitRateGradient(Wt.gradient,Wt.factor1!==void 0?Wt.factor1:Wt.factor,Wt.factor2)}if(e.startSizeGradients)for(var lt=0,Ft=e.startSizeGradients;lt<Ft.length;lt++){var Qe=Ft[lt];i.addStartSizeGradient(Qe.gradient,Qe.factor1!==void 0?Qe.factor1:Qe.factor,Qe.factor2)}if(e.lifeTimeGradients)for(var ct=0,wt=e.lifeTimeGradients;ct<wt.length;ct++){var fi=wt[ct];i.addLifeTimeGradient(fi.gradient,fi.factor1!==void 0?fi.factor1:fi.factor,fi.factor2)}if(e.limitVelocityGradients){for(var si=0,xi=e.limitVelocityGradients;si<xi.length;si++){var bi=xi[si];i.addLimitVelocityGradient(bi.gradient,bi.factor1!==void 0?bi.factor1:bi.factor,bi.factor2)}i.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&c){var Tt=f.a.GetClass("BABYLON.ProceduralTexture");i.noiseTexture=Tt.Parse(e.noiseTexture,c,o)}var $t;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":$t=new na;break;case"SphereDirectedParticleEmitter":$t=new zs;break;case"ConeEmitter":case"ConeParticleEmitter":$t=new ws;break;case"CylinderParticleEmitter":$t=new ra;break;case"CylinderDirectedParticleEmitter":$t=new Vs;break;case"HemisphericParticleEmitter":$t=new Us;break;case"PointParticleEmitter":$t=new Gs;break;case"MeshParticleEmitter":$t=new Bc;break;case"BoxEmitter":case"BoxParticleEmitter":default:$t=new Mn;break}$t.parse(e.particleEmitterType,c)}else $t=new Mn,$t.parse(e,c);i.particleEmitterType=$t,i.startSpriteCellID=e.startSpriteCellID,i.endSpriteCellID=e.endSpriteCellID,i.spriteCellWidth=e.spriteCellWidth,i.spriteCellHeight=e.spriteCellHeight,i.spriteCellChangeSpeed=e.spriteCellChangeSpeed,i.spriteRandomStartCell=e.spriteRandomStartCell,i.disposeOnStop=(a=e.disposeOnStop)!==null&&a!==void 0?a:!1,i.manualEmitCount=(s=e.manualEmitCount)!==null&&s!==void 0?s:-1},t.Parse=function(e,i,r,o){o===void 0&&(o=!1);var a=e.name,s=null,c=null,_,b;if(i instanceof fn.a?_=i:(b=i,_=b.getEngine()),e.customShader&&_.createEffectForParticles){c=e.customShader;var C=c.shaderOptions.defines.length>0?c.shaderOptions.defines.join(`
`):"";s=_.createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,C)}var x=new t(a,e.capacity,i,s,e.isAnimationSheetEnabled);if(x.customShader=c,x._rootUrl=r,e.id&&(x.id=e.id),e.subEmitters){x.subEmitters=[];for(var V=0,D=e.subEmitters;V<D.length;V++){for(var z=D[V],q=[],ue=0,ge=z;ue<ge.length;ue++){var Se=ge[ue];q.push(xo.Parse(Se,i,r))}x.subEmitters.push(q)}}return t._Parse(e,x,i,r),e.textureMask&&(x.textureMask=v.b.FromArray(e.textureMask)),e.preventAutoStart&&(x.preventAutoStart=e.preventAutoStart),!o&&!x.preventAutoStart&&x.start(),x},t.BILLBOARDMODE_Y=2,t.BILLBOARDMODE_ALL=7,t.BILLBOARDMODE_STRETCHED=8,t}(To);xo._ParseParticleSystem=gi.Parse;var rh="gpuUpdateParticlesPixelShader",nh=`#version 300 es
void main() {
discard;
}
`;qe.a.ShadersStore[rh]=nh;var cy={name:rh,shader:nh},oh="gpuUpdateParticlesVertexShader",ah=`#version 300 es
#define PI 3.14159
uniform float currentCount;
uniform float timeDelta;
uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;
uniform vec2 emitPower;
uniform vec2 sizeRange;
uniform vec4 scaleRange;
#ifndef COLORGRADIENTS
uniform vec4 color1;
uniform vec4 color2;
#endif
uniform vec3 gravity;
uniform sampler2D randomSampler;
uniform sampler2D randomSampler2;
uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
uniform vec3 minEmitBox;
uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;
uniform float radiusRange;
uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;
uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;
uniform float height;
uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;
uniform float coneAngle;
uniform vec2 height;
uniform float directionRandomizer;
#endif

in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;
in float life;
in vec4 seed;
in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;
in vec3 noiseCoordinates2;
#endif

out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;
out float outLife;
out vec4 outSeed;
out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;
out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;
uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;
uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec3 cellInfos;
#endif
vec3 getRandomVec3(float offset) {
return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;
}
vec4 getRandomVec4(float offset) {
return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));
}
void main() {
float newAge=age+timeDelta;

if (newAge>=life && stopFactor != 0.) {
vec3 newPosition;
vec3 newDirection;

vec4 randoms=getRandomVec4(seed.x);

outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;
outAge=newAge-life;

outSeed=seed;

#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;
outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a;
#ifndef COLORGRADIENTS

outColor=color1+(color2-color1)*randoms.b;
#endif

#ifndef ANGULARSPEEDGRADIENTS
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;
outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif

#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
newPosition=vec3(0,0,0);
newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;
newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);

float phi=2.0*PI*randoms2.x;
float theta=acos(2.0*randoms2.y-1.0);
float randX=cos(phi)*sin(theta);
float randY=cos(theta);
float randZ=sin(phi)*sin(theta);
newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);
newDirection=newPosition+directionRandomizer*randoms3;
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);

float phi=2.0*PI*randoms2.x;
float theta=acos(2.0*randoms2.y-1.0);
float randX=cos(phi)*sin(theta);
float randY=cos(theta);
float randZ=sin(phi)*sin(theta);
newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else

newDirection=newPosition+directionRandomizer*randoms3;
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);

float yPos=(randoms2.x-0.5)*height;
float angle=randoms2.y*PI*2.;
float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));
float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));
float xPos=positionRadius*cos(angle);
float zPos=positionRadius*sin(angle);
newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else

angle=angle+((randoms3.x-0.5)*PI);
newDirection=vec3(cos(angle),randoms3.y-0.5,sin(angle));
newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;

h=1.-h*h;
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;
lRadius=lRadius*h;
float randX=lRadius*sin(s);
float randZ=lRadius*cos(s);
float randY=h*height.x;
newPosition=vec3(randX,randY,randZ);

if (abs(cos(coneAngle)) == 1.0) {
newDirection=vec3(0.,1.0,0.);
} else {
vec3 randoms3=getRandomVec3(seed.z);
newDirection=normalize(newPosition+directionRandomizer*randoms3);
}
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;
outInitialPosition=initialPosition;
#else

newPosition=vec3(0.,0.,0.);

newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;
outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {
float directionScale=timeDelta;
outAge=newAge;
float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient;
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;
outSeed=seed;
#ifndef COLORGRADIENTS
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;
outSize.yz=size.yz;
#else
outSize=size;
#endif
#ifndef BILLBOARD
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;
float currentVelocity=length(updatedDirection);
if (currentVelocity>limitVelocity) {
updatedDirection=updatedDirection*limitVelocityDamping;
}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;
float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;
float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;
vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;
outDirection=outDirection+force*timeDelta;
outNoiseCoordinates1=noiseCoordinates1;
outNoiseCoordinates2=noiseCoordinates2;
#endif
#endif
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;
outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET
float offsetAge=outAge;
float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;
offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif
float ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}
}`;qe.a.ShadersStore[oh]=ah;var fy={name:oh,shader:ah},sh="clipPlaneFragmentDeclaration2",lh=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif`;qe.a.IncludesShadersStore[sh]=lh;var hy={name:sh,shader:lh},uh="gpuRenderParticlesPixelShader",ch=`#version 300 es
uniform sampler2D diffuseSampler;
in vec2 vUV;
in vec4 vColor;
out vec4 outFragColor;
#include<clipPlaneFragmentDeclaration2>
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
void main() {
#include<clipPlaneFragment>
vec4 textureColor=texture(diffuseSampler,vUV);
outFragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;
outFragColor.rgb=outFragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif


#ifdef IMAGEPROCESSINGPOSTPROCESS
outFragColor.rgb=toLinearSpace(outFragColor.rgb);
#else
#ifdef IMAGEPROCESSING
outFragColor.rgb=toLinearSpace(outFragColor.rgb);
outFragColor=applyImageProcessing(outFragColor);
#endif
#endif
}
`;qe.a.ShadersStore[uh]=ch;var dy={name:uh,shader:ch},fh="clipPlaneVertexDeclaration2",hh=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
out float fClipDistance6;
#endif`;qe.a.IncludesShadersStore[fh]=hh;var py={name:fh,shader:hh},dh="gpuRenderParticlesVertexShader",ph=`#version 300 es
uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif

in vec3 position;
in float age;
in float life;
in vec3 size;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
in vec3 direction;
#endif
in float angle;
#ifdef ANIMATESHEET
in float cellIndex;
#endif
in vec2 offset;
in vec2 uv;
out vec2 vUV;
out vec4 vColor;
out vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;
in vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix=mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix=mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);
float columnOffset=cellIndex-rowOffset*sheetInfos.z;
vec2 uvScale=sheetInfos.xy;
vec2 uvOffset=vec2(uv.x ,1.0-uv.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=age/life;
#ifdef COLORGRADIENTS
vColor=texture(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x+translationPivot;
#ifdef BILLBOARD
vec4 rotatedCorner;
rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=(position+worldOffset)-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);
vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=(position+worldOffset)-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);
vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else

rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;

#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else

vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=0.;
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
vec3 yaxis=normalize(initialDirection);
vPositionW=rotate(yaxis,rotatedCorner);

vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;

#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
}`;qe.a.ShadersStore[dh]=ph;var my={name:dh,shader:ph},gn=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!1),a===void 0&&(a=null);var s=n.call(this,e)||this;s.layerMask=268435455,s._accumulatedCount=0,s._targetIndex=0,s._currentRenderId=-1,s._started=!1,s._stopped=!1,s._timeDelta=0,s._actualFrame=0,s._rawTextureWidth=256,s.onDisposeObservable=new g.c,s.onStoppedObservable=new g.c,s.forceDepthWrite=!1,s._preWarmDone=!1,s.isLocal=!1,s._onBeforeDrawParticlesObservable=null,!r||r.getClassName()==="Scene"?(s._scene=r||Kt.a.LastCreatedScene,s._engine=s._scene.getEngine(),s.uniqueId=s._scene.getUniqueId(),s._scene.particleSystems.push(s)):(s._engine=r,s.defaultProjectionMatrix=l.a.PerspectiveFovLH(.8,1,.1,100)),s._customEffect={0:a},s._attachImageProcessingConfiguration(null),i.randomTextureSize||delete i.randomTextureSize;var c=Object(p.a)({capacity:5e4,randomTextureSize:s._engine.getCaps().maxTextureSize},i),_=i;isFinite(_)&&(c.capacity=_),s._capacity=c.capacity,s._activeCount=c.capacity,s._currentActiveCount=0,s._isAnimationSheetEnabled=o,s._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]},s.particleEmitterType=new Mn;for(var b=Math.min(s._engine.getCaps().maxTextureSize,c.randomTextureSize),C=[],x=0;x<b;++x)C.push(Math.random()),C.push(Math.random()),C.push(Math.random()),C.push(Math.random());s._randomTexture=new kr.a(new Float32Array(C),b,1,5,r,!1,!1,1,1),s._randomTexture.wrapU=1,s._randomTexture.wrapV=1,C=[];for(var x=0;x<b;++x)C.push(Math.random()),C.push(Math.random()),C.push(Math.random()),C.push(Math.random());return s._randomTexture2=new kr.a(new Float32Array(C),b,1,5,r,!1,!1,1,1),s._randomTexture2.wrapU=1,s._randomTexture2.wrapV=1,s._randomTextureSize=b,s}return Object.defineProperty(t,"IsSupported",{get:function(){return Kt.a.LastCreatedEngine?Kt.a.LastCreatedEngine.name==="WebGL"&&Kt.a.LastCreatedEngine.version>1:!1},enumerable:!1,configurable:!0}),t.prototype.getCapacity=function(){return this._capacity},Object.defineProperty(t.prototype,"activeParticleCount",{get:function(){return this._activeCount},set:function(e){this._activeCount=Math.min(e,this._capacity)},enumerable:!1,configurable:!0}),t.prototype.isReady=function(){return this._updateEffect?!(!this.emitter||!this._updateEffect.isReady()||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this._getEffect().isReady()||!this.particleTexture||!this.particleTexture.isReady()):(this._recreateUpdateEffect(),this._recreateRenderEffect(),!1)},t.prototype.isStarted=function(){return this._started},t.prototype.isStopped=function(){return this._stopped},t.prototype.isStopping=function(){return!1},t.prototype.getActiveCount=function(){return this._currentActiveCount},t.prototype.start=function(e){var i=this;if(e===void 0&&(e=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(function(){i.start(0)},e);return}this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)},t.prototype.stop=function(){this._stopped||(this._stopped=!0)},t.prototype.reset=function(){this._releaseBuffers(),this._releaseVAOs(),this._currentActiveCount=0,this._targetIndex=0},t.prototype.getClassName=function(){return"GPUParticleSystem"},t.prototype.getCustomEffect=function(e){var i;return e===void 0&&(e=0),(i=this._customEffect[e])!==null&&i!==void 0?i:this._customEffect[0]},t.prototype.setCustomEffect=function(e,i){i===void 0&&(i=0),this._customEffect[i]=e},Object.defineProperty(t.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new g.c),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vertexShaderName",{get:function(){return"gpuRenderParticles"},enumerable:!1,configurable:!0}),t.prototype._removeGradientAndTexture=function(e,i,r){return n.prototype._removeGradientAndTexture.call(this,e,i,r),this._releaseBuffers(),this},t.prototype.addColorGradient=function(e,i,r){this._colorGradients||(this._colorGradients=[]);var o=new qs(e,i);return this._colorGradients.push(o),this._refreshColorGradient(!0),this._releaseBuffers(),this},t.prototype._refreshColorGradient=function(e){e===void 0&&(e=!1),this._colorGradients&&(e&&this._colorGradients.sort(function(i,r){return i.gradient<r.gradient?-1:i.gradient>r.gradient?1:0}),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))},t.prototype.forceRefreshGradients=function(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()},t.prototype.removeColorGradient=function(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this},t.prototype._addFactorGradient=function(e,i,r){var o=new el(i,r);e.push(o),this._releaseBuffers()},t.prototype.addSizeGradient=function(e,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,i),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeSizeGradient=function(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this},t.prototype._refreshFactorGradient=function(e,i,r){if(r===void 0&&(r=!1),!!e){r&&e.sort(function(a,s){return a.gradient<s.gradient?-1:a.gradient>s.gradient?1:0});var o=this;o[i]&&(o[i].dispose(),o[i]=null)}},t.prototype.addAngularSpeedGradient=function(e,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,i),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeAngularSpeedGradient=function(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this},t.prototype.addVelocityGradient=function(e,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,i),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeVelocityGradient=function(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this},t.prototype.addLimitVelocityGradient=function(e,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,i),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeLimitVelocityGradient=function(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this},t.prototype.addDragGradient=function(e,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,i),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeDragGradient=function(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this},t.prototype.addEmitRateGradient=function(e,i,r){return this},t.prototype.removeEmitRateGradient=function(e){return this},t.prototype.addStartSizeGradient=function(e,i,r){return this},t.prototype.removeStartSizeGradient=function(e){return this},t.prototype.addColorRemapGradient=function(e,i,r){return this},t.prototype.removeColorRemapGradient=function(){return this},t.prototype.addAlphaRemapGradient=function(e,i,r){return this},t.prototype.removeAlphaRemapGradient=function(){return this},t.prototype.addRampGradient=function(e,i){return this},t.prototype.removeRampGradient=function(){return this},t.prototype.getRampGradients=function(){return null},Object.defineProperty(t.prototype,"useRampGradients",{get:function(){return!1},set:function(e){},enumerable:!1,configurable:!0}),t.prototype.addLifeTimeGradient=function(e,i,r){return this},t.prototype.removeLifeTimeGradient=function(e){return this},t.prototype._reset=function(){this._releaseBuffers()},t.prototype._createUpdateVAO=function(e){var i={};i.position=e.createVertexBuffer("position",0,3);var r=3;this.particleEmitterType instanceof xn&&(i.initialPosition=e.createVertexBuffer("initialPosition",r,3),r+=3),i.age=e.createVertexBuffer("age",r,1),r+=1,i.life=e.createVertexBuffer("life",r,1),r+=1,i.seed=e.createVertexBuffer("seed",r,4),r+=4,i.size=e.createVertexBuffer("size",r,3),r+=3,this._colorGradientsTexture||(i.color=e.createVertexBuffer("color",r,4),r+=4),i.direction=e.createVertexBuffer("direction",r,3),r+=3,this._isBillboardBased||(i.initialDirection=e.createVertexBuffer("initialDirection",r,3),r+=3),this._angularSpeedGradientsTexture?(i.angle=e.createVertexBuffer("angle",r,1),r+=1):(i.angle=e.createVertexBuffer("angle",r,2),r+=2),this._isAnimationSheetEnabled&&(i.cellIndex=e.createVertexBuffer("cellIndex",r,1),r+=1,this.spriteRandomStartCell&&(i.cellStartOffset=e.createVertexBuffer("cellStartOffset",r,1),r+=1)),this.noiseTexture&&(i.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",r,3),r+=3,i.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",r,3),r+=3);var o=this._engine.recordVertexArrayObject(i,null,this._updateEffect);return this._engine.bindArrayBuffer(null),o},t.prototype._createRenderVAO=function(e,i){var r={};r.position=e.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);var o=3;this.particleEmitterType instanceof xn&&(o+=3),r.age=e.createVertexBuffer("age",o,1,this._attributesStrideSize,!0),o+=1,r.life=e.createVertexBuffer("life",o,1,this._attributesStrideSize,!0),o+=5,r.size=e.createVertexBuffer("size",o,3,this._attributesStrideSize,!0),o+=3,this._colorGradientsTexture||(r.color=e.createVertexBuffer("color",o,4,this._attributesStrideSize,!0),o+=4),this.billboardMode===gi.BILLBOARDMODE_STRETCHED&&(r.direction=e.createVertexBuffer("direction",o,3,this._attributesStrideSize,!0)),o+=3,this._isBillboardBased||(r.initialDirection=e.createVertexBuffer("initialDirection",o,3,this._attributesStrideSize,!0),o+=3),r.angle=e.createVertexBuffer("angle",o,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?o++:o+=2,this._isAnimationSheetEnabled&&(r.cellIndex=e.createVertexBuffer("cellIndex",o,1,this._attributesStrideSize,!0),o+=1,this.spriteRandomStartCell&&(r.cellStartOffset=e.createVertexBuffer("cellStartOffset",o,1,this._attributesStrideSize,!0),o+=1)),this.noiseTexture&&(r.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",o,3,this._attributesStrideSize,!0),o+=3,r.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",o,3,this._attributesStrideSize,!0),o+=3),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2);var a=this._engine.recordVertexArrayObject(r,null,this._getEffect());return this._engine.bindArrayBuffer(null),a},t.prototype._initialize=function(e){if(e===void 0&&(e=!1),!(this._buffer0&&!e)){var i=this._engine,r=new Array;this._attributesStrideSize=21,this._targetIndex=0,this.particleEmitterType instanceof xn&&(this._attributesStrideSize+=3),this.isBillboardBased||(this._attributesStrideSize+=3),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6);for(var o=this.particleEmitterType instanceof xn,a=l.c.Vector3[0],s=0;s<this._capacity;s++)r.push(0),r.push(0),r.push(0),o&&(this.particleEmitterType.particlePositionGenerator(s,null,a),r.push(a.x),r.push(a.y),r.push(a.z)),r.push(0),r.push(0),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(0),r.push(0),r.push(0),this._colorGradientsTexture||(r.push(0),r.push(0),r.push(0),r.push(0)),o?(this.particleEmitterType.particleDestinationGenerator(s,null,a),r.push(a.x),r.push(a.y),r.push(a.z)):(r.push(0),r.push(0),r.push(0)),this.isBillboardBased||(r.push(0),r.push(0),r.push(0)),r.push(0),this._angularSpeedGradientsTexture||r.push(0),this._isAnimationSheetEnabled&&(r.push(0),this.spriteRandomStartCell&&r.push(0)),this.noiseTexture&&(r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()));var c=new Float32Array([.5,.5,1,1,-.5,.5,0,1,-.5,-.5,0,0,.5,-.5,1,0]);this._buffer0=new Be.a(i,r,!1,this._attributesStrideSize),this._buffer1=new Be.a(i,r,!1,this._attributesStrideSize),this._spriteBuffer=new Be.a(i,c,!1,4),this._updateVAO=[],this._updateVAO.push(this._createUpdateVAO(this._buffer0)),this._updateVAO.push(this._createUpdateVAO(this._buffer1)),this._renderVAO=[],this._renderVAO.push(this._createRenderVAO(this._buffer1,this._spriteBuffer)),this._renderVAO.push(this._createRenderVAO(this._buffer0,this._spriteBuffer)),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}},t.prototype._recreateUpdateEffect=function(){var e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),!(this._updateEffect&&this._updateEffectOptions.defines===e)&&(this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this.particleEmitterType instanceof xn&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.defines=e,this._updateEffect=new qe.a("gpuUpdateParticles",this._updateEffectOptions,this._engine))},t.prototype._getEffect=function(){var e;return(e=this.getCustomEffect())!==null&&e!==void 0?e:this._renderEffect},t.prototype.fillDefines=function(e,i){if(i===void 0&&(i=0),this._scene&&(this._scene.clipPlane&&e.push("#define CLIPPLANE"),this._scene.clipPlane2&&e.push("#define CLIPPLANE2"),this._scene.clipPlane3&&e.push("#define CLIPPLANE3"),this._scene.clipPlane4&&e.push("#define CLIPPLANE4"),this._scene.clipPlane5&&e.push("#define CLIPPLANE5"),this._scene.clipPlane6&&e.push("#define CLIPPLANE6")),this.blendMode===gi.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case gi.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case gi.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case gi.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break;default:break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))},t.prototype.fillUniformsAttributesAndSamplerNames=function(e,i,r){i.push("position","age","life","size","color","offset","uv","direction","initialDirection","angle","cellIndex"),e.push("emitterWM","worldOffset","view","projection","colorDead","invView","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","sheetInfos","translationPivot","eyePosition"),r.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(gr.a.PrepareUniforms(e,this._imageProcessingConfigurationDefines),gr.a.PrepareSamplers(r,this._imageProcessingConfigurationDefines))},t.prototype._recreateRenderEffect=function(){var e=this.getCustomEffect();if(e)return e;var i=[];this.fillDefines(i);var r=i.join(`
`);if(this._renderEffect&&this._renderEffect.defines===r)return this._renderEffect;var o=[],a=[],s=[];return this.fillUniformsAttributesAndSamplerNames(a,o,s),this._renderEffect=new qe.a("gpuRenderParticles",o,a,s,this._engine,r),this._renderEffect},t.prototype.animate=function(e){var i;e===void 0&&(e=!1),this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:((i=this._scene)===null||i===void 0?void 0:i.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()},t.prototype._createFactorGradientTexture=function(e,i){var r=this[i];if(!(!e||!e.length||r)){for(var o=new Float32Array(this._rawTextureWidth),a=0;a<this._rawTextureWidth;a++){var s=a/this._rawTextureWidth;Qi.GetCurrentGradient(s,e,function(c,_,b){o[a]=$e.a.Lerp(c.factor1,_.factor1,b)})}this[i]=kr.a.CreateRTexture(o,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1)}},t.prototype._createSizeGradientTexture=function(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")},t.prototype._createAngularSpeedGradientTexture=function(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")},t.prototype._createVelocityGradientTexture=function(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")},t.prototype._createLimitVelocityGradientTexture=function(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")},t.prototype._createDragGradientTexture=function(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")},t.prototype._createColorGradientTexture=function(){if(!(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)){for(var e=new Uint8Array(this._rawTextureWidth*4),i=v.c.Color4[0],r=0;r<this._rawTextureWidth;r++){var o=r/this._rawTextureWidth;Qi.GetCurrentGradient(o,this._colorGradients,function(a,s,c){v.b.LerpToRef(a.color1,s.color1,c,i),e[r*4]=i.r*255,e[r*4+1]=i.g*255,e[r*4+2]=i.b*255,e[r*4+3]=i.a*255})}this._colorGradientsTexture=kr.a.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}},t.prototype.render=function(e){var i,r;if(e===void 0&&(e=!1),!this._started||(this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture(),this._recreateUpdateEffect(),this._recreateRenderEffect(),!this.isReady()))return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(var o=0;o<this.preWarmCycles;o++)this.animate(!0),this.render(!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId())return 0;this._currentRenderId=this._scene.getFrameId()}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){var a=this._accumulatedCount|0;this._accumulatedCount-=a,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+a)}if(!this._currentActiveCount)return 0;this._engine.enableEffect(this._updateEffect);var s=this._engine;if(!s.setState)throw new Error("GPU particles cannot work with a full Engine. ThinEngine is not supported");this._updateEffect.setFloat("currentCount",this._currentActiveCount),this._updateEffect.setFloat("timeDelta",this._timeDelta),this._updateEffect.setFloat("stopFactor",this._stopped?0:1),this._updateEffect.setTexture("randomSampler",this._randomTexture),this._updateEffect.setTexture("randomSampler2",this._randomTexture2),this._updateEffect.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateEffect.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateEffect.setDirectColor4("color1",this.color1),this._updateEffect.setDirectColor4("color2",this.color2)),this._updateEffect.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateEffect.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateEffect.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateEffect.setVector3("gravity",this.gravity),this._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._sizeGradientsTexture),this._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._angularSpeedGradientsTexture),this._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._velocityGradientsTexture),this._limitVelocityGradientsTexture&&(this._updateEffect.setTexture("limitVelocityGradientSampler",this._limitVelocityGradientsTexture),this._updateEffect.setFloat("limitVelocityDamping",this.limitVelocityDamping)),this._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._dragGradientsTexture),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateEffect),this._isAnimationSheetEnabled&&this._updateEffect.setFloat3("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed),this.noiseTexture&&(this._updateEffect.setTexture("noiseSampler",this.noiseTexture),this._updateEffect.setVector3("noiseStrength",this.noiseStrength));var c;if(this.emitter.position){var _=this.emitter;c=_.getWorldMatrix()}else{var b=this.emitter;c=l.a.Translation(b.x,b.y,b.z)}if(this.isLocal||this._updateEffect.setMatrix("emitterWM",c),this._engine.bindVertexArrayObject(this._updateVAO[this._targetIndex],null),s.bindTransformFeedbackBuffer(this._targetBuffer.getBuffer()),s.setRasterizerState(!1),s.beginTransformFeedback(!0),s.drawArraysType(3,0,this._currentActiveCount),s.endTransformFeedback(),s.setRasterizerState(!0),s.bindTransformFeedbackBuffer(null),!e){var C=this._getEffect();this._engine.enableEffect(C);var x=((i=this._scene)===null||i===void 0?void 0:i.getViewMatrix())||l.a.IdentityReadOnly;if(C.setMatrix("view",x),C.setMatrix("projection",(r=this.defaultProjectionMatrix)!==null&&r!==void 0?r:this._scene.getProjectionMatrix()),C.setTexture("diffuseSampler",this.particleTexture),C.setVector2("translationPivot",this.translationPivot),C.setVector3("worldOffset",this.worldOffset),this.isLocal&&C.setMatrix("emitterWM",c),this._colorGradientsTexture?C.setTexture("colorGradientSampler",this._colorGradientsTexture):C.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){var V=this.particleTexture.getBaseSize();C.setFloat3("sheetInfos",this.spriteCellWidth/V.width,this.spriteCellHeight/V.height,V.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){var D=this._scene.activeCamera;C.setVector3("eyePosition",D.globalPosition)}var z=C.defines;if(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&xt.a.BindClipPlane(C,this._scene),z.indexOf("#define BILLBOARDMODE_ALL")>=0){var q=x.clone();q.invert(),C.setMatrix("invView",q)}switch(this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(C),this.blendMode){case gi.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case gi.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case gi.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case gi.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4);break}this.forceDepthWrite&&s.setDepthWrite(!0),this._engine.bindVertexArrayObject(this._renderVAO[this._targetIndex],null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(C),this._engine.drawArraysType(8,0,4,this._currentActiveCount),this._engine.setAlphaMode(0)}this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);var ue=this._sourceBuffer;return this._sourceBuffer=this._targetBuffer,this._targetBuffer=ue,this._currentActiveCount},t.prototype.rebuild=function(){this._initialize(!0)},t.prototype._releaseBuffers=function(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null)},t.prototype._releaseVAOs=function(){if(!!this._updateVAO){for(var e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO=[];for(var e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO=[]}},t.prototype.dispose=function(e){if(e===void 0&&(e=!0),this._scene){var i=this._scene.particleSystems.indexOf(this);i>-1&&this._scene.particleSystems.splice(i,1)}this._releaseBuffers(),this._releaseVAOs(),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},t.prototype.clone=function(e,i){var r=this.serialize(),o=t.Parse(r,this._scene||this._engine,this._rootUrl),a=Object(p.a)({},this._customEffect);return o.name=e,o._customEffect=a,i===void 0&&(i=this.emitter),o.emitter=i,o.noiseTexture=this.noiseTexture,o},t.prototype.serialize=function(e){e===void 0&&(e=!1);var i={};return gi._Serialize(i,this,e),i.activeParticleCount=this.activeParticleCount,i.randomTextureSize=this._randomTextureSize,i},t.Parse=function(e,i,r,o){o===void 0&&(o=!1);var a=e.name,s=new t(a,{capacity:e.capacity,randomTextureSize:e.randomTextureSize},i);return s._rootUrl=r,e.activeParticleCount&&(s.activeParticleCount=e.activeParticleCount),gi._Parse(e,s,i,r),e.preventAutoStart&&(s.preventAutoStart=e.preventAutoStart),!o&&!s.preventAutoStart&&s.start(),s},t}(To),gy=function(){function n(){}return n}(),ua=function(){function n(){this.systems=new Array}return Object.defineProperty(n.prototype,"emitterNode",{get:function(){return this._emitterNode},enumerable:!1,configurable:!0}),n.prototype.setEmitterAsSphere=function(t,e,i){this._emitterNode&&this._emitterNode.dispose(),this._emitterCreationOptions={kind:"Sphere",options:t,renderingGroupId:e};var r=nr.a.CreateSphere("emitterSphere",{diameter:t.diameter,segments:t.segments},i);r.renderingGroupId=e;var o=new zt.a("emitterSphereMaterial",i);o.emissiveColor=t.color,r.material=o;for(var a=0,s=this.systems;a<s.length;a++){var c=s[a];c.emitter=r}this._emitterNode=r},n.prototype.start=function(t){for(var e=0,i=this.systems;e<i.length;e++){var r=i[e];t&&(r.emitter=t),r.start()}},n.prototype.dispose=function(){for(var t=0,e=this.systems;t<e.length;t++){var i=e[t];i.dispose()}this.systems=[],this._emitterNode&&(this._emitterNode.dispose(),this._emitterNode=null)},n.prototype.serialize=function(t){t===void 0&&(t=!1);var e={};e.systems=[];for(var i=0,r=this.systems;i<r.length;i++){var o=r[i];e.systems.push(o.serialize(t))}return this._emitterNode&&(e.emitter=this._emitterCreationOptions),e},n.Parse=function(t,e,i){i===void 0&&(i=!1);var r=new n,o=this.BaseAssetsUrl+"/textures/";e=e||Kt.a.LastCreatedScene;for(var a=0,s=t.systems;a<s.length;a++){var c=s[a];r.systems.push(i?gn.Parse(c,e,o,!0):gi.Parse(c,e,o,!0))}if(t.emitter){var _=t.emitter.options;switch(t.emitter.kind){case"Sphere":r.setEmitterAsSphere({diameter:_.diameter,segments:_.segments,color:v.a.FromArray(_.color)},t.emitter.renderingGroupId,e);break}}return r},n.BaseAssetsUrl="https://assets.babylonjs.com/particles",n}(),Fg=function(){function n(){}return n.CreateDefault=function(t,e,i,r){e===void 0&&(e=500),r===void 0&&(r=!1);var o;return r?o=new gn("default system",{capacity:e},i):o=new gi("default system",e,i),o.emitter=t,o.particleTexture=new Ze.a("https://www.babylonjs.com/assets/Flare.png",o.getScene()),o.createConeEmitter(.1,Math.PI/4),o.color1=new v.b(1,1,1,1),o.color2=new v.b(1,1,1,1),o.colorDead=new v.b(1,1,1,0),o.minSize=.1,o.maxSize=.1,o.minEmitPower=2,o.maxEmitPower=2,o.updateSpeed=1/60,o.emitRate=30,o},n.CreateAsync=function(t,e,i){i===void 0&&(i=!1),e||(e=Kt.a.LastCreatedScene);var r={};return e._addPendingData(r),new Promise(function(o,a){if(i&&!gn.IsSupported)return e._removePendingData(r),a("Particle system with GPU is not supported.");re.b.LoadFile(n.BaseAssetsUrl+"/systems/"+t+".json",function(s){e._removePendingData(r);var c=JSON.parse(s.toString());return o(ua.Parse(c,e,i))},void 0,void 0,void 0,function(){return e._removePendingData(r),a("An error occurred with the creation of your particle system. Check if your type '"+t+"' exists.")})})},n.ExportSet=function(t){for(var e=new ua,i=0,r=t;i<r.length;i++){var o=r[i];e.systems.push(o)}return e},n.ParseFromFileAsync=function(t,e,i,r,o){return r===void 0&&(r=!1),o===void 0&&(o=""),new Promise(function(a,s){var c=new Rr.a;c.addEventListener("readystatechange",function(){if(c.readyState==4)if(c.status==200){var _=JSON.parse(c.responseText),b=void 0;r?b=gn.Parse(_,i,o):b=gi.Parse(_,i,o),t&&(b.name=t),a(b)}else s("Unable to load the particle system")}),c.open("GET",e),c.send()})},n.CreateFromSnippetAsync=function(t,e,i,r){var o=this;if(i===void 0&&(i=!1),r===void 0&&(r=""),t==="_BLANK"){var a=this.CreateDefault(null);return a.start(),Promise.resolve(a)}return new Promise(function(s,c){var _=new Rr.a;_.addEventListener("readystatechange",function(){if(_.readyState==4)if(_.status==200){var b=JSON.parse(JSON.parse(_.responseText).jsonPayload),C=JSON.parse(b.particleSystem),x=void 0;i?x=gn.Parse(C,e,r):x=gi.Parse(C,e,r),x.snippetId=t,s(x)}else c("Unable to load the snippet "+t)}),_.open("GET",o.SnippetUrl+"/"+t.replace(/#/g,"/")),_.send()})},n.BaseAssetsUrl=ua.BaseAssetsUrl,n.SnippetUrl="https://snippet.babylonjs.com",n}();T.a.AddParser(X.a.NAME_PARTICLESYSTEM,function(n,t,e,i){var r=T.a.GetIndividualParser(X.a.NAME_PARTICLESYSTEM);if(!!r&&n.particleSystems!==void 0&&n.particleSystems!==null)for(var o=0,a=n.particleSystems.length;o<a;o++){var s=n.particleSystems[o];e.particleSystems.push(r(s,t,i))}}),T.a.AddIndividualParser(X.a.NAME_PARTICLESYSTEM,function(n,t,e){if(n.activeParticleCount){var i=gn.Parse(n,t,e);return i}else{var i=gi.Parse(n,t,e);return i}}),G.a.prototype.createEffectForParticles=function(n,t,e,i,r,o,a,s){var c;t===void 0&&(t=[]),e===void 0&&(e=[]),i===void 0&&(i="");var _=[],b=[],C=[];return s?s.fillUniformsAttributesAndSamplerNames(b,_,C):(_=gi._GetAttributeNamesOrOptions(),b=gi._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),e.indexOf("diffuseSampler")===-1&&e.push("diffuseSampler"),this.createEffect({vertex:(c=s==null?void 0:s.vertexShaderName)!==null&&c!==void 0?c:"particles",fragmentElement:n},_,b.concat(t),C.concat(e),i,r,o,a)},st.a.prototype.getEmittedParticleSystems=function(){for(var n=new Array,t=0;t<this.getScene().particleSystems.length;t++){var e=this.getScene().particleSystems[t];e.emitter===this&&n.push(e)}return n},st.a.prototype.getHierarchyEmittedParticleSystems=function(){var n=new Array,t=this.getDescendants();t.push(this);for(var e=0;e<this.getScene().particleSystems.length;e++){var i=this.getScene().particleSystems[e],r=i.emitter;r.position&&t.indexOf(r)!==-1&&n.push(i)}return n};var tl=function(){function n(t,e,i,r,o,a,s,c,_,b){_===void 0&&(_=null),b===void 0&&(b=null),this.idx=0,this.id=0,this.color=new v.b(1,1,1,1),this.position=l.e.Zero(),this.rotation=l.e.Zero(),this.scaling=l.e.One(),this.uvs=new l.f(0,0,1,1),this.velocity=l.e.Zero(),this.pivot=l.e.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.materialIndex=null,this.props=null,this.cullingStrategy=Ae.a.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=l.e.Zero(),this.idx=t,this.id=e,this._pos=i,this._ind=r,this._model=o,this.shapeId=a,this.idxInShape=s,this._sps=c,_&&(this._modelBoundingInfo=_,this._boundingInfo=new Ye.a(_.minimum,_.maximum)),b!==null&&(this.materialIndex=b)}return n.prototype.copyToRef=function(t){return t.position.copyFrom(this.position),t.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(t.rotationQuaternion?t.rotationQuaternion.copyFrom(this.rotationQuaternion):t.rotationQuaternion=this.rotationQuaternion.clone()),t.scaling.copyFrom(this.scaling),this.color&&(t.color?t.color.copyFrom(this.color):t.color=this.color.clone()),t.uvs.copyFrom(this.uvs),t.velocity.copyFrom(this.velocity),t.pivot.copyFrom(this.pivot),t.translateFromPivot=this.translateFromPivot,t.alive=this.alive,t.isVisible=this.isVisible,t.parentId=this.parentId,t.cullingStrategy=this.cullingStrategy,this.materialIndex!==null&&(t.materialIndex=this.materialIndex),this},Object.defineProperty(n.prototype,"scale",{get:function(){return this.scaling},set:function(t){this.scaling=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(t){this.rotationQuaternion=t},enumerable:!1,configurable:!0}),n.prototype.intersectsMesh=function(t){return!this._boundingInfo||!t._boundingInfo?!1:this._sps._bSphereOnly?Pt.a.Intersects(this._boundingInfo.boundingSphere,t._boundingInfo.boundingSphere):this._boundingInfo.intersects(t._boundingInfo,!1)},n.prototype.isInFrustum=function(t){return this._boundingInfo!==null&&this._boundingInfo.isInFrustum(t,this.cullingStrategy)},n.prototype.getRotationMatrix=function(t){var e;if(this.rotationQuaternion)e=this.rotationQuaternion;else{e=l.c.Quaternion[0];var i=this.rotation;l.b.RotationYawPitchRollToRef(i.y,i.x,i.z,e)}e.toRotationMatrix(t)},n}(),il=function(){function n(t,e,i,r,o,a,s,c,_){this._indicesLength=0,this.shapeID=t,this._shape=e,this._indices=i,this._indicesLength=i.length,this._shapeUV=a,this._shapeColors=o,this._normals=r,this._positionFunction=s,this._vertexFunction=c,this._material=_}return n}(),mh=function(){function n(t,e,i,r){this.idx=0,this.ind=0,this.indicesLength=0,this.sqDistance=0,this.materialIndex=0,this.idx=t,this.ind=e,this.indicesLength=i,this.materialIndex=r}return n}(),gh=function(){function n(){this.position=l.e.Zero(),this.color=new v.b(1,1,1,1),this.uv=l.d.Zero()}return Object.defineProperty(n.prototype,"x",{get:function(){return this.position.x},set:function(t){this.position.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this.position.y},set:function(t){this.position.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"z",{get:function(){return this.position.z},set:function(t){this.position.z=t},enumerable:!1,configurable:!0}),n}(),Bg=function(){function n(t,e,i){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!1,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._expandable=!1,this._shapeCounter=0,this._copy=new tl(0,0,0,0,null,0,0,this),this._color=new v.b(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this._isNotBuilt=!0,this._lastParticleId=0,this._idxOfId=[],this._multimaterialEnabled=!1,this._useModelMaterial=!1,this._depthSortFunction=function(r,o){return o.sqDistance-r.sqDistance},this._materialSortFunction=function(r,o){return r.materialIndex-o.materialIndex},this._autoUpdateSubMeshes=!1,this.name=t,this._scene=e||Kt.a.LastCreatedScene,this._camera=e.activeCamera,this._pickable=i?i.isPickable:!1,this._depthSort=i?i.enableDepthSort:!1,this._multimaterialEnabled=i?i.enableMultiMaterial:!1,this._useModelMaterial=i?i.useModelMaterial:!1,this._multimaterialEnabled=this._useModelMaterial?!0:this._multimaterialEnabled,this._expandable=i?i.expandable:!1,this._particlesIntersect=i?i.particleIntersection:!1,this._bSphereOnly=i?i.boundingSphereOnly:!1,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,i&&i.updatable!==void 0?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]),(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]),this._multimaterialEnabled&&(this._multimaterial=new yo.a(this.name+"MultiMaterial",this._scene),this._materials=[],this._materialIndexesById={}),this._tmpVertex=new gh}return n.prototype.buildMesh=function(){if(!this._isNotBuilt&&this.mesh)return this.mesh;if(this.nbParticles===0&&!this.mesh){var t=Yf.a.CreateDisc("",{radius:1,tessellation:3},this._scene);this.addShape(t,1),t.dispose()}if(this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),!this.mesh){var e=new st.a(this.name,this._scene);this.mesh=e}!this._updatable&&this._multimaterialEnabled&&this._sortParticlesByMaterial(),this.recomputeNormals&&an.a.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();var i=new an.a;if(i.indices=this._depthSort?this._indices:this._indices32,i.set(this._positions32,Be.b.PositionKind),i.set(this._normals32,Be.b.NormalKind),this._uvs32.length>0&&i.set(this._uvs32,Be.b.UVKind),this._colors32.length>0&&i.set(this._colors32,Be.b.ColorKind),i.applyToMesh(this.mesh,this._updatable),this.mesh.isPickable=this._pickable,this._pickable)for(var r=0,o=0;o<this.nbParticles;o++)for(var a=this.particles[o],s=a._model._indicesLength,c=0;c<s;c++){var _=c%3;if(_==0){var b={idx:a.idx,faceId:r};this.pickedParticles[r]=b,r++}}return this._multimaterialEnabled&&this.setMultiMaterial(this._materials),this._expandable||(!this._depthSort&&!this._multimaterialEnabled&&(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0)),this._isNotBuilt=!1,this.recomputeNormals=!1,this.mesh},n.prototype.digest=function(t,e){var i=e&&e.facetNb||1,r=e&&e.number||0,o=e&&e.delta||0,a=t.getVerticesData(Be.b.PositionKind),s=t.getIndices(),c=t.getVerticesData(Be.b.UVKind),_=t.getVerticesData(Be.b.ColorKind),b=t.getVerticesData(Be.b.NormalKind),C=e&&e.storage?e.storage:null,x=0,V=s.length/3;r?(r=r>V?V:r,i=Math.round(V/r),o=0):i=i>V?V:i;for(var D=[],z=[],q=[],ue=[],ge=[],Se=l.e.Zero(),Pe=i;x<V;){i=Pe+Math.floor((1+o)*Math.random()),x>V-i&&(i=V-x),D.length=0,z.length=0,q.length=0,ue.length=0,ge.length=0;for(var me=0,xe=x*3;xe<(x+i)*3;xe++){q.push(me);var Fe=s[xe],we=Fe*3;if(D.push(a[we],a[we+1],a[we+2]),z.push(b[we],b[we+1],b[we+2]),c){var Ge=Fe*2;ue.push(c[Ge],c[Ge+1])}if(_){var Xe=Fe*4;ge.push(_[Xe],_[Xe+1],_[Xe+2],_[Xe+3])}me++}var Oe=this.nbParticles,je=this._posToShape(D),ke=this._uvsToShapeUV(ue),ze=re.b.Slice(q),Je=re.b.Slice(ge),it=re.b.Slice(z);Se.copyFromFloats(0,0,0);var Ke;for(Ke=0;Ke<je.length;Ke++)Se.addInPlace(je[Ke]);Se.scaleInPlace(1/je.length);var St=new l.e(Infinity,Infinity,Infinity),Mt=new l.e(-Infinity,-Infinity,-Infinity);for(Ke=0;Ke<je.length;Ke++)je[Ke].subtractInPlace(Se),St.minimizeInPlaceFromFloats(je[Ke].x,je[Ke].y,je[Ke].z),Mt.maximizeInPlaceFromFloats(je[Ke].x,je[Ke].y,je[Ke].z);var Rt;this._particlesIntersect&&(Rt=new Ye.a(St,Mt));var at=null;this._useModelMaterial&&(at=t.material?t.material:this._setDefaultMaterial());var Bt=new il(this._shapeCounter,je,ze,it,Je,ke,null,null,at),Wt=this._positions.length,lt=this._indices.length;this._meshBuilder(this._index,lt,je,this._positions,ze,this._indices,ue,this._uvs,Je,this._colors,it,this._normals,Oe,0,null,Bt),this._addParticle(Oe,this._lastParticleId,Wt,lt,Bt,this._shapeCounter,0,Rt,C),this.particles[this.nbParticles].position.addInPlace(Se),C||(this._index+=je.length,Oe++,this.nbParticles++,this._lastParticleId++),this._shapeCounter++,x+=i}return this._isNotBuilt=!0,this},n.prototype._unrotateFixedNormals=function(){for(var t=0,e=0,i=l.c.Vector3[0],r=l.c.Quaternion[0],o=l.c.Matrix[0],a=0;a<this.particles.length;a++){var s=this.particles[a],c=s._model._shape;if(s.rotationQuaternion)s.rotationQuaternion.conjugateToRef(r);else{var _=s.rotation;l.b.RotationYawPitchRollToRef(_.y,_.x,_.z,r),r.conjugateInPlace()}r.toRotationMatrix(o);for(var b=0;b<c.length;b++)e=t+b*3,l.e.TransformNormalFromFloatsToRef(this._normals32[e],this._normals32[e+1],this._normals32[e+2],o,i),i.toArray(this._fixedNormal32,e);t=e+3}},n.prototype._resetCopy=function(){var t=this._copy;t.position.setAll(0),t.rotation.setAll(0),t.rotationQuaternion=null,t.scaling.setAll(1),t.uvs.copyFromFloats(0,0,1,1),t.color=null,t.translateFromPivot=!1,t.shapeId=0,t.materialIndex=null},n.prototype._meshBuilder=function(t,e,i,r,o,a,s,c,_,b,C,x,V,D,z,q){var ue,ge=0,Se=0,Pe=0;this._resetCopy();var me=this._copy,xe=!!(z&&z.storage);if(me.idx=V,me.idxInShape=D,me.shapeId=q.shapeID,this._useModelMaterial){var Fe=q._material.uniqueId,we=this._materialIndexesById;we.hasOwnProperty(Fe)||(we[Fe]=this._materials.length,this._materials.push(q._material));var Ge=we[Fe];me.materialIndex=Ge}if(z&&z.positionFunction&&(z.positionFunction(me,V,D),this._mustUnrotateFixedNormals=!0),xe)return me;var Xe=l.c.Matrix[0],Oe=this._tmpVertex,je=Oe.position,ke=Oe.color,ze=Oe.uv,Je=l.c.Vector3[1],it=l.c.Vector3[2],Ke=l.c.Vector3[3];l.a.IdentityToRef(Xe),me.getRotationMatrix(Xe),me.pivot.multiplyToRef(me.scaling,Ke),me.translateFromPivot?it.setAll(0):it.copyFrom(Ke);var St=z&&z.vertexFunction;for(ue=0;ue<i.length;ue++){if(je.copyFrom(i[ue]),me.color&&ke.copyFrom(me.color),s&&ze.copyFromFloats(s[ge],s[ge+1]),St&&z.vertexFunction(me,Oe,ue),je.multiplyInPlace(me.scaling).subtractInPlace(Ke),l.e.TransformCoordinatesToRef(je,Xe,Je),Je.addInPlace(it).addInPlace(me.position),r.push(Je.x,Je.y,Je.z),s){var Mt=me.uvs;c.push((Mt.z-Mt.x)*ze.x+Mt.x,(Mt.w-Mt.y)*ze.y+Mt.y),ge+=2}if(me.color)this._color.copyFrom(ke);else{var Rt=this._color;_&&_[Se]!==void 0?(Rt.r=_[Se],Rt.g=_[Se+1],Rt.b=_[Se+2],Rt.a=_[Se+3]):(Rt.r=1,Rt.g=1,Rt.b=1,Rt.a=1)}b.push(this._color.r,this._color.g,this._color.b,this._color.a),Se+=4,!this.recomputeNormals&&C&&(l.e.TransformNormalFromFloatsToRef(C[Pe],C[Pe+1],C[Pe+2],Xe,je),x.push(je.x,je.y,je.z),Pe+=3)}for(ue=0;ue<o.length;ue++){var at=t+o[ue];a.push(at),at>65535&&(this._needs32Bits=!0)}if(this._depthSort||this._multimaterialEnabled){var Bt=me.materialIndex!==null?me.materialIndex:0;this.depthSortedParticles.push(new mh(V,e,o.length,Bt))}return me},n.prototype._posToShape=function(t){for(var e=[],i=0;i<t.length;i+=3)e.push(l.e.FromArray(t,i));return e},n.prototype._uvsToShapeUV=function(t){var e=[];if(t)for(var i=0;i<t.length;i++)e.push(t[i]);return e},n.prototype._addParticle=function(t,e,i,r,o,a,s,c,_){c===void 0&&(c=null),_===void 0&&(_=null);var b=new tl(t,e,i,r,o,a,s,this,c),C=_||this.particles;return C.push(b),b},n.prototype.addShape=function(t,e,i){var r=t.getVerticesData(Be.b.PositionKind),o=t.getIndices(),a=t.getVerticesData(Be.b.UVKind),s=t.getVerticesData(Be.b.ColorKind),c=t.getVerticesData(Be.b.NormalKind);this.recomputeNormals=!c;var _=re.b.SliceToArray(o),b=re.b.SliceToArray(c),C=s?re.b.SliceToArray(s):[],x=i&&i.storage?i.storage:null,V=null;this._particlesIntersect&&(V=t.getBoundingInfo());var D=this._posToShape(r),z=this._uvsToShapeUV(a),q=i?i.positionFunction:null,ue=i?i.vertexFunction:null,ge=null;this._useModelMaterial&&(ge=t.material?t.material:this._setDefaultMaterial());for(var Se=new il(this._shapeCounter,D,_,b,C,z,q,ue,ge),Pe=0;Pe<e;Pe++)this._insertNewParticle(this.nbParticles,Pe,Se,D,o,a,s,c,V,x,i);return this._shapeCounter++,this._isNotBuilt=!0,this._shapeCounter-1},n.prototype._rebuildParticle=function(t,e){e===void 0&&(e=!1),this._resetCopy();var i=this._copy;t._model._positionFunction&&t._model._positionFunction(i,t.idx,t.idxInShape);var r=l.c.Matrix[0],o=l.c.Vector3[0],a=l.c.Vector3[1],s=l.c.Vector3[2],c=l.c.Vector3[3];i.getRotationMatrix(r),t.pivot.multiplyToRef(t.scaling,c),i.translateFromPivot?s.copyFromFloats(0,0,0):s.copyFrom(c);for(var _=t._model._shape,b=0;b<_.length;b++)o.copyFrom(_[b]),t._model._vertexFunction&&t._model._vertexFunction(i,o,b),o.multiplyInPlace(i.scaling).subtractInPlace(c),l.e.TransformCoordinatesToRef(o,r,a),a.addInPlace(s).addInPlace(i.position).toArray(this._positions32,t._pos+b*3);e&&(t.position.setAll(0),t.rotation.setAll(0),t.rotationQuaternion=null,t.scaling.setAll(1),t.uvs.setAll(0),t.pivot.setAll(0),t.translateFromPivot=!1,t.parentId=null)},n.prototype.rebuildMesh=function(t){t===void 0&&(t=!1);for(var e=0;e<this.particles.length;e++)this._rebuildParticle(this.particles[e],t);return this.mesh.updateVerticesData(Be.b.PositionKind,this._positions32,!1,!1),this},n.prototype.removeParticles=function(t,e){var i=e-t+1;if(!this._expandable||i<=0||i>=this.nbParticles||!this._updatable)return[];var r=this.particles,o=this.nbParticles;if(e<o-1)for(var a=e+1,s=r[a]._pos-r[t]._pos,c=r[a]._ind-r[t]._ind,_=a;_<o;_++){var b=r[_];b._pos-=s,b._ind-=c}var C=r.splice(t,i);this._positions.length=0,this._indices.length=0,this._colors.length=0,this._uvs.length=0,this._normals.length=0,this._index=0,this._idxOfId.length=0,(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]);for(var x=0,V=r.length,D=0;D<V;D++){var z=r[D],q=z._model,ue=q._shape,ge=q._indices,Se=q._normals,Pe=q._shapeColors,me=q._shapeUV;z.idx=D,this._idxOfId[z.id]=D,this._meshBuilder(this._index,x,ue,this._positions,ge,this._indices,me,this._uvs,Pe,this._colors,Se,this._normals,z.idx,z.idxInShape,null,q),this._index+=ue.length,x+=ge.length}return this.nbParticles-=i,this._isNotBuilt=!0,C},n.prototype.insertParticlesFromArray=function(t){if(!this._expandable)return this;for(var e=0,i=t[0].shapeId,r=t.length,o=0;o<r;o++){var a=t[o],s=a._model,c=s._shape,_=s._indices,b=s._shapeUV,C=s._shapeColors,x=s._normals,V=!x;this.recomputeNormals=V||this.recomputeNormals;var D=a._boundingInfo,z=this._insertNewParticle(this.nbParticles,e,s,c,_,b,C,x,D,null,null);a.copyToRef(z),e++,i!=a.shapeId&&(i=a.shapeId,e=0)}return this._isNotBuilt=!0,this},n.prototype._insertNewParticle=function(t,e,i,r,o,a,s,c,_,b,C){var x=this._positions.length,V=this._indices.length,D=this._meshBuilder(this._index,V,r,this._positions,o,this._indices,a,this._uvs,s,this._colors,c,this._normals,t,e,C,i),z=null;return this._updatable&&(z=this._addParticle(this.nbParticles,this._lastParticleId,x,V,i,this._shapeCounter,e,_,b),z.position.copyFrom(D.position),z.rotation.copyFrom(D.rotation),D.rotationQuaternion&&(z.rotationQuaternion?z.rotationQuaternion.copyFrom(D.rotationQuaternion):z.rotationQuaternion=D.rotationQuaternion.clone()),D.color&&(z.color?z.color.copyFrom(D.color):z.color=D.color.clone()),z.scaling.copyFrom(D.scaling),z.uvs.copyFrom(D.uvs),D.materialIndex!==null&&(z.materialIndex=D.materialIndex),this.expandable&&(this._idxOfId[z.id]=z.idx)),b||(this._index+=r.length,this.nbParticles++,this._lastParticleId++),z},n.prototype.setParticles=function(t,e,i){if(t===void 0&&(t=0),e===void 0&&(e=this.nbParticles-1),i===void 0&&(i=!0),!this._updatable||this._isNotBuilt)return this;this.beforeUpdateParticles(t,e,i);var r=l.c.Matrix[0],o=l.c.Matrix[1],a=this.mesh,s=this._colors32,c=this._positions32,_=this._normals32,b=this._uvs32,C=this._indices32,x=this._indices,V=this._fixedNormal32,D=l.c.Vector3,z=D[5].copyFromFloats(1,0,0),q=D[6].copyFromFloats(0,1,0),ue=D[7].copyFromFloats(0,0,1),ge=D[8].setAll(Number.MAX_VALUE),Se=D[9].setAll(-Number.MAX_VALUE),Pe=D[10].setAll(0),me=this._tmpVertex,xe=me.position,Fe=me.color,we=me.uv;if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(o)),this.billboard){var Ge=D[0];this._camera.getDirectionToRef(Le.a.Z,Ge),l.e.TransformNormalToRef(Ge,o,ue),ue.normalize();var Xe=this._camera.getViewMatrix(!0);l.e.TransformNormalFromFloatsToRef(Xe.m[1],Xe.m[5],Xe.m[9],o,q),l.e.CrossToRef(q,ue,z),q.normalize(),z.normalize()}this._depthSort&&l.e.TransformCoordinatesToRef(this._camera.globalPosition,o,Pe),l.a.IdentityToRef(r);var Oe=0,je=0,ke=0,ze=0,Je=0,it=0,Ke=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),e=e>=this.nbParticles?this.nbParticles-1:e,this._computeBoundingBox&&(t!=0||e!=this.nbParticles-1)){var St=this.mesh._boundingInfo;St&&(ge.copyFrom(St.minimum),Se.copyFrom(St.maximum))}je=this.particles[t]._pos;var Mt=je/3|0;ze=Mt*4,it=Mt*2;for(var Rt=t;Rt<=e;Rt++){var at=this.particles[Rt];this.updateParticle(at);var Bt=at._model._shape,Wt=at._model._shapeUV,lt=at._rotationMatrix,Ft=at.position,Qe=at.rotation,ct=at.scaling,wt=at._globalPosition;if(this._depthSort&&this._depthSortParticles){var fi=this.depthSortedParticles[Rt];fi.idx=at.idx,fi.ind=at._ind,fi.indicesLength=at._model._indicesLength,fi.sqDistance=l.e.DistanceSquared(at.position,Pe)}if(!at.alive||at._stillInvisible&&!at.isVisible){Ke=Bt.length,je+=Ke*3,ze+=Ke*4,it+=Ke*2;continue}if(at.isVisible){at._stillInvisible=!1;var si=D[12];at.pivot.multiplyToRef(ct,si),this.billboard&&(Qe.x=0,Qe.y=0),(this._computeParticleRotation||this.billboard)&&at.getRotationMatrix(r);var xi=at.parentId!==null;if(xi){var bi=this.getParticleById(at.parentId);if(bi){var Tt=bi._rotationMatrix,$t=bi._globalPosition,vi=Ft.x*Tt[1]+Ft.y*Tt[4]+Ft.z*Tt[7],hi=Ft.x*Tt[0]+Ft.y*Tt[3]+Ft.z*Tt[6],di=Ft.x*Tt[2]+Ft.y*Tt[5]+Ft.z*Tt[8];if(wt.x=$t.x+hi,wt.y=$t.y+vi,wt.z=$t.z+di,this._computeParticleRotation||this.billboard){var ft=r.m;lt[0]=ft[0]*Tt[0]+ft[1]*Tt[3]+ft[2]*Tt[6],lt[1]=ft[0]*Tt[1]+ft[1]*Tt[4]+ft[2]*Tt[7],lt[2]=ft[0]*Tt[2]+ft[1]*Tt[5]+ft[2]*Tt[8],lt[3]=ft[4]*Tt[0]+ft[5]*Tt[3]+ft[6]*Tt[6],lt[4]=ft[4]*Tt[1]+ft[5]*Tt[4]+ft[6]*Tt[7],lt[5]=ft[4]*Tt[2]+ft[5]*Tt[5]+ft[6]*Tt[8],lt[6]=ft[8]*Tt[0]+ft[9]*Tt[3]+ft[10]*Tt[6],lt[7]=ft[8]*Tt[1]+ft[9]*Tt[4]+ft[10]*Tt[7],lt[8]=ft[8]*Tt[2]+ft[9]*Tt[5]+ft[10]*Tt[8]}}else at.parentId=null}else if(wt.x=Ft.x,wt.y=Ft.y,wt.z=Ft.z,this._computeParticleRotation||this.billboard){var ft=r.m;lt[0]=ft[0],lt[1]=ft[1],lt[2]=ft[2],lt[3]=ft[4],lt[4]=ft[5],lt[5]=ft[6],lt[6]=ft[8],lt[7]=ft[9],lt[8]=ft[10]}var oi=D[11];for(at.translateFromPivot?oi.setAll(0):oi.copyFrom(si),Ke=0;Ke<Bt.length;Ke++){Oe=je+Ke*3,ke=ze+Ke*4,Je=it+Ke*2;var sn=2*Ke,Kr=sn+1;xe.copyFrom(Bt[Ke]),this._computeParticleColor&&at.color&&Fe.copyFrom(at.color),this._computeParticleTexture&&we.copyFromFloats(Wt[sn],Wt[Kr]),this._computeParticleVertex&&this.updateParticleVertex(at,me,Ke);var Nn=xe.x*ct.x-si.x,Qr=xe.y*ct.y-si.y,_n=xe.z*ct.z-si.z,hi=Nn*lt[0]+Qr*lt[3]+_n*lt[6],vi=Nn*lt[1]+Qr*lt[4]+_n*lt[7],di=Nn*lt[2]+Qr*lt[5]+_n*lt[8];hi+=oi.x,vi+=oi.y,di+=oi.z;var Oa=c[Oe]=wt.x+z.x*hi+q.x*vi+ue.x*di,wn=c[Oe+1]=wt.y+z.y*hi+q.y*vi+ue.y*di,rp=c[Oe+2]=wt.z+z.z*hi+q.z*vi+ue.z*di;if(this._computeBoundingBox&&(ge.minimizeInPlaceFromFloats(Oa,wn,rp),Se.maximizeInPlaceFromFloats(Oa,wn,rp)),!this._computeParticleVertex){var pl=V[Oe],ml=V[Oe+1],gl=V[Oe+2],vl=pl*lt[0]+ml*lt[3]+gl*lt[6],_l=pl*lt[1]+ml*lt[4]+gl*lt[7],yl=pl*lt[2]+ml*lt[5]+gl*lt[8];_[Oe]=z.x*vl+q.x*_l+ue.x*yl,_[Oe+1]=z.y*vl+q.y*_l+ue.y*yl,_[Oe+2]=z.z*vl+q.z*_l+ue.z*yl}if(this._computeParticleColor&&at.color){var Ma=this._colors32;Ma[ke]=Fe.r,Ma[ke+1]=Fe.g,Ma[ke+2]=Fe.b,Ma[ke+3]=Fe.a}if(this._computeParticleTexture){var hr=at.uvs;b[Je]=we.x*(hr.z-hr.x)+hr.x,b[Je+1]=we.y*(hr.w-hr.y)+hr.y}}}else for(at._stillInvisible=!0,Ke=0;Ke<Bt.length;Ke++){if(Oe=je+Ke*3,ke=ze+Ke*4,Je=it+Ke*2,c[Oe]=c[Oe+1]=c[Oe+2]=0,_[Oe]=_[Oe+1]=_[Oe+2]=0,this._computeParticleColor&&at.color){var xa=at.color;s[ke]=xa.r,s[ke+1]=xa.g,s[ke+2]=xa.b,s[ke+3]=xa.a}if(this._computeParticleTexture){var hr=at.uvs;b[Je]=Wt[Ke*2]*(hr.z-hr.x)+hr.x,b[Je+1]=Wt[Ke*2+1]*(hr.w-hr.y)+hr.y}}if(this._particlesIntersect){var np=at._boundingInfo,Wv=np.boundingBox,Hv=np.boundingSphere,bl=at._modelBoundingInfo;if(!this._bSphereOnly){var El=bl.boundingBox.vectors,Pl=D[1],Cl=D[2];Pl.setAll(Number.MAX_VALUE),Cl.setAll(-Number.MAX_VALUE);for(var Lo=0;Lo<8;Lo++){var Sl=El[Lo].x*ct.x,Tl=El[Lo].y*ct.y,Al=El[Lo].z*ct.z,hi=Sl*lt[0]+Tl*lt[3]+Al*lt[6],vi=Sl*lt[1]+Tl*lt[4]+Al*lt[7],di=Sl*lt[2]+Tl*lt[5]+Al*lt[8],op=Ft.x+z.x*hi+q.x*vi+ue.x*di,ap=Ft.y+z.y*hi+q.y*vi+ue.y*di,sp=Ft.z+z.z*hi+q.z*vi+ue.z*di;Pl.minimizeInPlaceFromFloats(op,ap,sp),Cl.maximizeInPlaceFromFloats(op,ap,sp)}Wv.reConstruct(Pl,Cl,a._worldMatrix)}var lp=bl.minimum.multiplyToRef(ct,D[1]),up=bl.maximum.multiplyToRef(ct,D[2]),cp=up.addToRef(lp,D[3]).scaleInPlace(.5).addInPlace(wt),fp=up.subtractToRef(lp,D[4]).scaleInPlace(.5*this._bSphereRadiusFactor),kv=cp.subtractToRef(fp,D[1]),Xv=cp.addToRef(fp,D[2]);Hv.reConstruct(kv,Xv,a._worldMatrix)}je=Oe+3,ze=ke+4,it=Je+2}if(i){if(this._computeParticleColor&&a.updateVerticesData(Be.b.ColorKind,s,!1,!1),this._computeParticleTexture&&a.updateVerticesData(Be.b.UVKind,b,!1,!1),a.updateVerticesData(Be.b.PositionKind,c,!1,!1),!a.areNormalsFrozen||a.isFacetDataEnabled){if(this._computeParticleVertex||a.isFacetDataEnabled){var Yv=a.isFacetDataEnabled?a.getFacetDataParameters():null;an.a.ComputeNormals(c,C,_,Yv);for(var Zr=0;Zr<_.length;Zr++)V[Zr]=_[Zr]}a.areNormalsFrozen||a.updateVerticesData(Be.b.NormalKind,_,!1,!1)}if(this._depthSort&&this._depthSortParticles){var Rl=this.depthSortedParticles;Rl.sort(this._depthSortFunction);for(var Kv=Rl.length,hp=0,Ol=0,Ml=0;Ml<Kv;Ml++)for(var xl=Rl[Ml],Qv=xl.indicesLength,Zv=xl.ind,Zr=0;Zr<Qv;Zr++)if(C[hp]=x[Zv+Zr],hp++,this._pickable){var Jv=Zr%3;if(Jv==0){var dp=this.pickedParticles[Ol];dp.idx=xl.idx,dp.faceId=Ol,Ol++}}a.updateIndices(C)}}return this._computeBoundingBox&&(a._boundingInfo?a._boundingInfo.reConstruct(ge,Se,a._worldMatrix):a._boundingInfo=new Ye.a(ge,Se,a._worldMatrix)),this._autoUpdateSubMeshes&&this.computeSubMeshes(),this.afterUpdateParticles(t,e,i),this},n.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null,this.pickedBySubMesh=null,this._materials=null,this._materialIndexes=null,this._indicesByMaterial=null,this._idxOfId=null},n.prototype.pickedParticle=function(t){if(t.hit){var e=t.subMeshId,i=t.faceId,r=this.pickedBySubMesh;if(r[e]&&r[e][i])return r[e][i]}return null},n.prototype.getParticleById=function(t){var e=this.particles[t];if(e&&e.id==t)return e;var i=this.particles,r=this._idxOfId[t];if(r!==void 0)return i[r];for(var o=0,a=this.nbParticles;o<a;){var s=i[o];if(s.id==t)return s;o++}return null},n.prototype.getParticlesByShapeId=function(t){var e=[];return this.getParticlesByShapeIdToRef(t,e),e},n.prototype.getParticlesByShapeIdToRef=function(t,e){e.length=0;for(var i=0;i<this.nbParticles;i++){var r=this.particles[i];r.shapeId==t&&e.push(r)}return this},n.prototype.computeSubMeshes=function(){if(!this.mesh||!this._multimaterialEnabled)return this;var t=this.depthSortedParticles;if(this.particles.length>0)for(var e=0;e<this.particles.length;e++){var i=this.particles[e];i.materialIndex||(i.materialIndex=0);var r=t[e];r.materialIndex=i.materialIndex,r.ind=i._ind,r.indicesLength=i._model._indicesLength,r.idx=i.idx}this._sortParticlesByMaterial();var o=this._indicesByMaterial,a=this._materialIndexes,s=this.mesh;s.subMeshes=[];for(var c=s.getTotalVertices(),_=0;_<a.length;_++){var b=o[_],C=o[_+1]-b,x=a[_];new Ro.a(x,0,c,b,C,s)}return this},n.prototype._sortParticlesByMaterial=function(){var t=[0];this._indicesByMaterial=t;var e=[];this._materialIndexes=e;var i=this.depthSortedParticles;i.sort(this._materialSortFunction);var r=i.length,o=this._indices32,a=this._indices,s=0,c=0,_=0,b=i[0].materialIndex;e.push(b),this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]);for(var C=0;C<r;C++){var x=i[C],V=x.indicesLength,D=x.ind;x.materialIndex!==b&&(b=x.materialIndex,t.push(_),e.push(b),this._pickable&&(s++,this.pickedBySubMesh[s]=[],c=0));for(var z=0,q=0;q<V;q++){if(o[_]=a[D+q],this._pickable){var ue=q%3;if(ue==0){var ge=this.pickedBySubMesh[s][c];ge?(ge.idx=x.idx,ge.faceId=z):this.pickedBySubMesh[s][c]={idx:x.idx,faceId:z},c++,z++}}_++}}return t.push(o.length),this._updatable&&this.mesh.updateIndices(o),this},n.prototype._setMaterialIndexesById=function(){this._materialIndexesById={};for(var t=0;t<this._materials.length;t++){var e=this._materials[t].uniqueId;this._materialIndexesById[e]=t}},n.prototype._filterUniqueMaterialId=function(t){var e=t.filter(function(i,r,o){return o.indexOf(i)===r});return e},n.prototype._setDefaultMaterial=function(){return this._defaultMaterial||(this._defaultMaterial=new zt.a(this.name+"DefaultMaterial",this._scene)),this._defaultMaterial},n.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},n.prototype.setVisibilityBox=function(t){var e=t/2;this.mesh._boundingInfo=new Ye.a(new l.e(-e,-e,-e),new l.e(e,e,e))},Object.defineProperty(n.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(t){this._isVisibilityBoxLocked=t;var e=this.mesh.getBoundingInfo();e.isLocked=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(t){this._computeParticleRotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(t){this._computeParticleColor=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(t){this._computeParticleTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(t){this._computeParticleVertex=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(t){this._computeBoundingBox=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"depthSortParticles",{get:function(){return this._depthSortParticles},set:function(t){this._depthSortParticles=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"expandable",{get:function(){return this._expandable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"multimaterialEnabled",{get:function(){return this._multimaterialEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useModelMaterial",{get:function(){return this._useModelMaterial},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"materials",{get:function(){return this._materials},enumerable:!1,configurable:!0}),n.prototype.setMultiMaterial=function(t){this._materials=this._filterUniqueMaterialId(t),this._setMaterialIndexesById(),this._multimaterial&&this._multimaterial.dispose(),this._multimaterial=new yo.a(this.name+"MultiMaterial",this._scene);for(var e=0;e<this._materials.length;e++)this._multimaterial.subMaterials.push(this._materials[e]);this.computeSubMeshes(),this.mesh.material=this._multimaterial},Object.defineProperty(n.prototype,"multimaterial",{get:function(){return this._multimaterial},set:function(t){this._multimaterial=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"autoUpdateSubMeshes",{get:function(){return this._autoUpdateSubMeshes},set:function(t){this._autoUpdateSubMeshes=t},enumerable:!1,configurable:!0}),n.prototype.initParticles=function(){},n.prototype.recycleParticle=function(t){return t},n.prototype.updateParticle=function(t){return t},n.prototype.updateParticleVertex=function(t,e,i){return this},n.prototype.beforeUpdateParticles=function(t,e,i){},n.prototype.afterUpdateParticles=function(t,e,i){},n}(),vh=u(610),_h=u(665),yh=u(544),In=u(510);ae.a.prototype.getPhysicsEngine=function(){return this._physicsEngine},ae.a.prototype.enablePhysics=function(n,t){if(n===void 0&&(n=null),this._physicsEngine)return!0;var e=this._getComponent(X.a.NAME_PHYSICSENGINE);e||(e=new bh(this),this._addComponent(e));try{return this._physicsEngine=new yh.a(n,t),this._physicsTimeAccumulator=0,!0}catch(i){return d.a.Error(i.message),!1}},ae.a.prototype.disablePhysicsEngine=function(){!this._physicsEngine||(this._physicsEngine.dispose(),this._physicsEngine=null)},ae.a.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==void 0},ae.a.prototype.deleteCompoundImpostor=function(n){var t=n.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},ae.a.prototype._advancePhysicsEngineStep=function(n){if(this._physicsEngine){var t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=n;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(n/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}},Object.defineProperty(Ae.a.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(n){var t=this;this._physicsImpostor!==n&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=n,n&&(this._disposePhysicsObserver=this.onDisposeObservable.add(function(){t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)})))},enumerable:!0,configurable:!0}),Ae.a.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},Ae.a.prototype.applyImpulse=function(n,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(n,t),this):this},Ae.a.prototype.setPhysicsLinkWith=function(n,t,e,i){return!this.physicsImpostor||!n.physicsImpostor?this:(this.physicsImpostor.createJoint(n.physicsImpostor,In.e.HingeJoint,{mainPivot:t,connectedPivot:e,nativeParams:i}),this)};var bh=function(){function n(t){var e=this;this.name=X.a.NAME_PHYSICSENGINE,this.scene=t,this.scene.onBeforePhysicsObservable=new g.c,this.scene.onAfterPhysicsObservable=new g.c,this.scene.getDeterministicFrameTime=function(){return e.scene._physicsEngine?e.scene._physicsEngine.getTimeStep()*1e3:1e3/60}}return n.prototype.register=function(){},n.prototype.rebuild=function(){},n.prototype.dispose=function(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()},n}(),Ng=function(){function n(t){if(this._scene=t,this._physicsEngine=this._scene.getPhysicsEngine(),!this._physicsEngine){d.a.Warn("Physics engine not enabled. Please enable the physics before you can use the methods.");return}}return n.prototype.applyRadialExplosionImpulse=function(t,e,i,r){if(!this._physicsEngine)return d.a.Warn("Physics engine not enabled. Please enable the physics before you call this method."),null;var o=this._physicsEngine.getImpostors();if(o.length===0)return null;typeof e=="number"&&(e=new Ln,e.radius=e,e.strength=i||e.strength,e.falloff=r||e.falloff);var a=new Eh(this._scene,e),s=Array();return o.forEach(function(c){var _=a.getImpostorHitData(c,t);!_||(c.applyImpulse(_.force,_.contactPoint),s.push({impostor:c,hitData:_}))}),a.triggerAffectedImpostorsCallback(s),a.dispose(!1),a},n.prototype.applyRadialExplosionForce=function(t,e,i,r){if(!this._physicsEngine)return d.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;var o=this._physicsEngine.getImpostors();if(o.length===0)return null;typeof e=="number"&&(e=new Ln,e.radius=e,e.strength=i||e.strength,e.falloff=r||e.falloff);var a=new Eh(this._scene,e),s=Array();return o.forEach(function(c){var _=a.getImpostorHitData(c,t);!_||(c.applyForce(_.force,_.contactPoint),s.push({impostor:c,hitData:_}))}),a.triggerAffectedImpostorsCallback(s),a.dispose(!1),a},n.prototype.gravitationalField=function(t,e,i,r){if(!this._physicsEngine)return d.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;var o=this._physicsEngine.getImpostors();if(o.length===0)return null;typeof e=="number"&&(e=new Ln,e.radius=e,e.strength=i||e.strength,e.falloff=r||e.falloff);var a=new wg(this,this._scene,t,e);return a.dispose(!1),a},n.prototype.updraft=function(t,e,i,r,o){if(!this._physicsEngine)return d.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(this._physicsEngine.getImpostors().length===0)return null;typeof e=="number"&&(e=new rl,e.radius=e,e.strength=i||e.strength,e.height=r||e.height,e.updraftMode=o||e.updraftMode);var a=new Vg(this._scene,t,e);return a.dispose(!1),a},n.prototype.vortex=function(t,e,i,r){if(!this._physicsEngine)return d.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(this._physicsEngine.getImpostors().length===0)return null;typeof e=="number"&&(e=new nl,e.radius=e,e.strength=i||e.strength,e.height=r||e.height);var o=new Ug(this._scene,t,e);return o.dispose(!1),o},n}(),Eh=function(){function n(t,e){this._scene=t,this._options=e,this._dataFetched=!1,this._options=Object(p.a)(Object(p.a)({},new Ln),this._options)}return n.prototype.getData=function(){return this._dataFetched=!0,{sphere:this._sphere}},n.prototype.getImpostorHitData=function(t,e){if(t.mass===0||!this._intersectsWithSphere(t,e,this._options.radius)||t.object.getClassName()!=="Mesh"&&t.object.getClassName()!=="InstancedMesh")return null;var i=t.getObjectCenter(),r=i.subtract(e),o=new Jt.a(e,r,this._options.radius),a=o.intersectsMesh(t.object),s=a.pickedPoint;if(!s)return null;var c=l.e.Distance(e,s);if(c>this._options.radius)return null;var _=this._options.falloff===Do.Constant?this._options.strength:this._options.strength*(1-c/this._options.radius),b=r.multiplyByFloats(_,_,_);return{force:b,contactPoint:s,distanceFromOrigin:c}},n.prototype.triggerAffectedImpostorsCallback=function(t){this._options.affectedImpostorsCallback&&this._options.affectedImpostorsCallback(t)},n.prototype.dispose=function(t){var e=this;t===void 0&&(t=!0),t?this._sphere.dispose():setTimeout(function(){e._dataFetched||e._sphere.dispose()},0)},n.prototype._prepareSphere=function(){this._sphere||(this._sphere=nr.a.CreateSphere("radialExplosionEventSphere",this._options.sphere,this._scene),this._sphere.isVisible=!1)},n.prototype._intersectsWithSphere=function(t,e,i){var r=t.object;return this._prepareSphere(),this._sphere.position=e,this._sphere.scaling=new l.e(i*2,i*2,i*2),this._sphere._updateBoundingInfo(),this._sphere.computeWorldMatrix(!0),this._sphere.intersectsMesh(r,!0)},n}(),wg=function(){function n(t,e,i,r){this._physicsHelper=t,this._scene=e,this._origin=i,this._options=r,this._dataFetched=!1,this._options=Object(p.a)(Object(p.a)({},new Ln),this._options),this._tickCallback=this._tick.bind(this),this._options.strength=this._options.strength*-1}return n.prototype.getData=function(){return this._dataFetched=!0,{sphere:this._sphere}},n.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},n.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},n.prototype.dispose=function(t){var e=this;t===void 0&&(t=!0),t?this._sphere.dispose():setTimeout(function(){e._dataFetched||e._sphere.dispose()},0)},n.prototype._tick=function(){if(this._sphere)this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);else{var t=this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);t&&(this._sphere=t.getData().sphere.clone("radialExplosionEventSphereClone"))}},n}(),Vg=function(){function n(t,e,i){this._scene=t,this._origin=e,this._options=i,this._originTop=l.e.Zero(),this._originDirection=l.e.Zero(),this._cylinderPosition=l.e.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=Object(p.a)(Object(p.a)({},new rl),this._options),this._origin.addToRef(new l.e(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new l.e(0,this._options.height,0),this._originTop),this._options.updraftMode===Fn.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}return n.prototype.getData=function(){return this._dataFetched=!0,{cylinder:this._cylinder}},n.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},n.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},n.prototype.dispose=function(t){var e=this;t===void 0&&(t=!0),!!this._cylinder&&(t?this._cylinder.dispose():setTimeout(function(){e._dataFetched||e._cylinder.dispose()},0))},n.prototype.getImpostorHitData=function(t){if(t.mass===0||!this._intersectsWithCylinder(t))return null;var e=t.getObjectCenter();if(this._options.updraftMode===Fn.Perpendicular)var i=this._originDirection;else var i=e.subtract(this._originTop);var r=l.e.Distance(this._origin,e),o=this._options.strength*-1,a=i.multiplyByFloats(o,o,o);return{force:a,contactPoint:e,distanceFromOrigin:r}},n.prototype._tick=function(){var t=this;this._physicsEngine.getImpostors().forEach(function(e){var i=t.getImpostorHitData(e);!i||e.applyForce(i.force,i.contactPoint)})},n.prototype._prepareCylinder=function(){this._cylinder||(this._cylinder=Tr.a.CreateCylinder("updraftEventCylinder",{height:this._options.height,diameter:this._options.radius*2},this._scene),this._cylinder.isVisible=!1)},n.prototype._intersectsWithCylinder=function(t){var e=t.object;return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)},n}(),Ug=function(){function n(t,e,i){this._scene=t,this._origin=e,this._options=i,this._originTop=l.e.Zero(),this._cylinderPosition=l.e.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=Object(p.a)(Object(p.a)({},new nl),this._options),this._origin.addToRef(new l.e(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new l.e(0,this._options.height,0),this._originTop),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}return n.prototype.getData=function(){return this._dataFetched=!0,{cylinder:this._cylinder}},n.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},n.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},n.prototype.dispose=function(t){var e=this;t===void 0&&(t=!0),t?this._cylinder.dispose():setTimeout(function(){e._dataFetched||e._cylinder.dispose()},0)},n.prototype.getImpostorHitData=function(t){if(t.mass===0||!this._intersectsWithCylinder(t)||t.object.getClassName()!=="Mesh"&&t.object.getClassName()!=="InstancedMesh")return null;var e=t.getObjectCenter(),i=new l.e(this._origin.x,e.y,this._origin.z),r=e.subtract(i),o=new Jt.a(i,r,this._options.radius),a=o.intersectsMesh(t.object),s=a.pickedPoint;if(!s)return null;var c=a.distance/this._options.radius,_=s.normalize();if(c>this._options.centripetalForceThreshold&&(_=_.negate()),c>this._options.centripetalForceThreshold)var b=_.x*this._options.centripetalForceMultiplier,C=_.y*this._options.updraftForceMultiplier,x=_.z*this._options.centripetalForceMultiplier;else var V=l.e.Cross(i,e).normalize(),b=(V.x+_.x)*this._options.centrifugalForceMultiplier,C=this._originTop.y*this._options.updraftForceMultiplier,x=(V.z+_.z)*this._options.centrifugalForceMultiplier;var D=new l.e(b,C,x);return D=D.multiplyByFloats(this._options.strength,this._options.strength,this._options.strength),{force:D,contactPoint:e,distanceFromOrigin:c}},n.prototype._tick=function(){var t=this;this._physicsEngine.getImpostors().forEach(function(e){var i=t.getImpostorHitData(e);!i||e.applyForce(i.force,i.contactPoint)})},n.prototype._prepareCylinder=function(){this._cylinder||(this._cylinder=Tr.a.CreateCylinder("vortexEventCylinder",{height:this._options.height,diameter:this._options.radius*2},this._scene),this._cylinder.isVisible=!1)},n.prototype._intersectsWithCylinder=function(t){var e=t.object;return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)},n}(),Ln=function(){function n(){this.radius=5,this.strength=10,this.falloff=Do.Constant,this.sphere={segments:32,diameter:1}}return n}(),rl=function(){function n(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=Fn.Center}return n}(),nl=function(){function n(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}return n}(),Do;(function(n){n[n.Constant=0]="Constant",n[n.Linear=1]="Linear"})(Do||(Do={}));var Fn;(function(n){n[n.Center=0]="Center",n[n.Perpendicular=1]="Perpendicular"})(Fn||(Fn={}));var Xr=u(503),Gg=u(632),zg=u(634),jg=u(633),Ph="blackAndWhitePixelShader",Ch=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float degree;
void main(void)
{
vec3 color=texture2D(textureSampler,vUV).rgb;
float luminance=dot(color,vec3(0.3,0.59,0.11));
vec3 blackAndWhite=vec3(luminance,luminance,luminance);
gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);
}`;qe.a.ShadersStore[Ph]=Ch;var vy={name:Ph,shader:Ch},Sh=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e,"blackAndWhite",["degree"],null,i,r,o,a,s)||this;return c.degree=1,c.onApplyObservable.add(function(_){_.setFloat("degree",c.degree)}),c}return t.prototype.getClassName=function(){return"BlackAndWhitePostProcess"},t._Parse=function(e,i,r,o){return Ee.a.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},Object(p.c)([Object(Ee.c)()],t.prototype,"degree",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.BlackAndWhitePostProcess"]=Sh;var Wg=u(578),Hg=u(585),kg=u(579),Xg=u(582),Th="colorCorrectionPixelShader",Ah=`
uniform sampler2D textureSampler;
uniform sampler2D colorTable;

varying vec2 vUV;

const float SLICE_COUNT=16.0;

vec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {
float sliceSize=1.0/width;
float slicePixelSize=sliceSize/width;
float sliceInnerSize=slicePixelSize*(width-1.0);
float zSlice0=min(floor(uv.z*width),width-1.0);
float zSlice1=min(zSlice0+1.0,width-1.0);
float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;
float s0=xOffset+(zSlice0*sliceSize);
float s1=xOffset+(zSlice1*sliceSize);
vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));
vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));
float zOffset=mod(uv.z*width,1.0);
vec4 result=mix(slice0Color,slice1Color,zOffset);
return result;
}
void main(void)
{
vec4 screen_color=texture2D(textureSampler,vUV);
gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);
}`;qe.a.ShadersStore[Th]=Ah;var _y={name:Th,shader:Ah},Rh=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){var _=n.call(this,e,"colorCorrection",null,["colorTable"],r,o,a,s,c)||this;return _._colorTableTexture=new Ze.a(i,o.getScene(),!0,!1,Ze.a.TRILINEAR_SAMPLINGMODE),_._colorTableTexture.anisotropicFilteringLevel=1,_._colorTableTexture.wrapU=Ze.a.CLAMP_ADDRESSMODE,_._colorTableTexture.wrapV=Ze.a.CLAMP_ADDRESSMODE,_.colorTableUrl=i,_.onApply=function(b){b.setTexture("colorTable",_._colorTableTexture)},_}return t.prototype.getClassName=function(){return"ColorCorrectionPostProcess"},t._Parse=function(e,i,r,o){return Ee.a.Parse(function(){return new t(e.name,e.colorTableUrl,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},Object(p.c)([Object(Ee.c)()],t.prototype,"colorTableUrl",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.ColorCorrectionPostProcess"]=Rh;var Oh="convolutionPixelShader",Mh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform float kernel[9];
void main(void)
{
vec2 onePixel=vec2(1.0,1.0)/screenSize;
vec4 colorSum =
texture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +
texture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +
texture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +
texture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +
texture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +
texture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +
texture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];
float kernelWeight =
kernel[0] +
kernel[1] +
kernel[2] +
kernel[3] +
kernel[4] +
kernel[5] +
kernel[6] +
kernel[7] +
kernel[8];
if (kernelWeight<=0.0) {
kernelWeight=1.0;
}
gl_FragColor=vec4((colorSum/kernelWeight).rgb,1);
}`;qe.a.ShadersStore[Oh]=Mh;var yy={name:Oh,shader:Mh},xh=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_){_===void 0&&(_=0);var b=n.call(this,e,"convolution",["kernel","screenSize"],null,r,o,a,s,c,null,_)||this;return b.kernel=i,b.onApply=function(C){C.setFloat2("screenSize",b.width,b.height),C.setArray("kernel",b.kernel)},b}return t.prototype.getClassName=function(){return"ConvolutionPostProcess"},t._Parse=function(e,i,r,o){return Ee.a.Parse(function(){return new t(e.name,e.kernel,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable,e.textureType)},e,r,o)},t.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],t.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],t.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],t.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],t.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],t.GaussianKernel=[0,1,0,1,1,1,0,1,0],Object(p.c)([Object(Ee.c)()],t.prototype,"kernel",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.ConvolutionPostProcess"]=xh;var Yg=u(580),Dh=u(570),Ih=u(583),Lh="displayPassPixelShader",Fh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D passSampler;
void main(void)
{
gl_FragColor=texture2D(passSampler,vUV);
}`;qe.a.ShadersStore[Lh]=Fh;var by={name:Lh,shader:Fh},Bh=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){return n.call(this,e,"displayPass",["passSampler"],["passSampler"],i,r,o,a,s)||this}return t.prototype.getClassName=function(){return"DisplayPassPostProcess"},t._Parse=function(e,i,r,o){return Ee.a.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},t}(ii.a);f.a.RegisteredTypes["BABYLON.DisplayPassPostProcess"]=Bh;var Kg=u(584),Nh="filterPixelShader",wh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform mat4 kernelMatrix;
void main(void)
{
vec3 baseColor=texture2D(textureSampler,vUV).rgb;
vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;
gl_FragColor=vec4(updatedColor,1.0);
}`;qe.a.ShadersStore[Nh]=wh;var Ey={name:Nh,shader:wh},Vh=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){var _=n.call(this,e,"filter",["kernelMatrix"],null,r,o,a,s,c)||this;return _.kernelMatrix=i,_.onApply=function(b){b.setMatrix("kernelMatrix",_.kernelMatrix)},_}return t.prototype.getClassName=function(){return"FilterPostProcess"},t._Parse=function(e,i,r,o){return Ee.a.Parse(function(){return new t(e.name,e.kernelMatrix,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},Object(p.c)([Object(Ee.j)()],t.prototype,"kernelMatrix",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.FilterPostProcess"]=Vh;var Uh=u(517),Qg=u(586),Gh="highlightsPixelShader",zh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);
void main(void)
{
vec4 tex=texture2D(textureSampler,vUV);
vec3 c=tex.rgb;
float luma=dot(c.rgb,RGBLuminanceCoefficients);


gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a);
}`;qe.a.ShadersStore[Gh]=zh;var Py={name:Gh,shader:zh},Zg=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){return c===void 0&&(c=0),n.call(this,e,"highlights",null,null,i,r,o,a,s,null,c)||this}return t.prototype.getClassName=function(){return"HighlightsPostProcess"},t}(ii.a),Jg=u(571),$g=u(590),jh="refractionPixelShader",Wh=`
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D refractionSampler;

uniform vec3 baseColor;
uniform float depth;
uniform float colorLevel;
void main() {
float ref=1.0-texture2D(refractionSampler,vUV).r;
vec2 uv=vUV-vec2(0.5);
vec2 offset=uv*depth*ref;
vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;
gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);
}`;qe.a.ShadersStore[jh]=Wh;var Cy={name:jh,shader:Wh},Hh=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_,b,C){var x=n.call(this,e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],s,c,_,b,C)||this;return x._ownRefractionTexture=!0,x.color=r,x.depth=o,x.colorLevel=a,x.refractionTextureUrl=i,x.onActivateObservable.add(function(V){x._refTexture=x._refTexture||new Ze.a(i,V.getScene())}),x.onApplyObservable.add(function(V){V.setColor3("baseColor",x.color),V.setFloat("depth",x.depth),V.setFloat("colorLevel",x.colorLevel),V.setTexture("refractionSampler",x._refTexture)}),x}return Object.defineProperty(t.prototype,"refractionTexture",{get:function(){return this._refTexture},set:function(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"RefractionPostProcess"},t.prototype.dispose=function(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),n.prototype.dispose.call(this,e)},t._Parse=function(e,i,r,o){return Ee.a.Parse(function(){return new t(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,o)},Object(p.c)([Object(Ee.c)()],t.prototype,"color",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"depth",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"colorLevel",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"refractionTextureUrl",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.RefractionPostProcess"]=Hh;var Yr=u(602),qg=u(587),kh="tonemapPixelShader",Xh=`
varying vec2 vUV;
uniform sampler2D textureSampler;

uniform float _ExposureAdjustment;
#if defined(HABLE_TONEMAPPING)
const float A=0.15;
const float B=0.50;
const float C=0.10;
const float D=0.20;
const float E=0.02;
const float F=0.30;
const float W=11.2;
#endif
float Luminance(vec3 c)
{
return dot(c,vec3(0.22,0.707,0.071));
}
void main(void)
{
vec3 colour=texture2D(textureSampler,vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
float lum=Luminance(colour.rgb);
float lumTm=lum*_ExposureAdjustment;
float scale=lumTm/(1.0+lumTm);
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=_ExposureAdjustment;
const float ExposureBias=2.0;
vec3 x=ExposureBias*colour;
vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
x=vec3(W,W,W);
vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);
colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=_ExposureAdjustment;
vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);
vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);
colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour=vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);
#endif
gl_FragColor=vec4(colour.rgb,1.0);
}`;qe.a.ShadersStore[kh]=Xh;var Sy={name:kh,shader:Xh},vn;(function(n){n[n.Hable=0]="Hable",n[n.Reinhard=1]="Reinhard",n[n.HejiDawson=2]="HejiDawson",n[n.Photographic=3]="Photographic"})(vn||(vn={}));var ev=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){a===void 0&&(a=2),c===void 0&&(c=0);var _=n.call(this,e,"tonemap",["_ExposureAdjustment"],null,1,o,a,s,!0,null,c)||this;_._operator=i,_.exposureAdjustment=r;var b="#define ";return _._operator===vn.Hable?b+="HABLE_TONEMAPPING":_._operator===vn.Reinhard?b+="REINHARD_TONEMAPPING":_._operator===vn.HejiDawson?b+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":_._operator===vn.Photographic&&(b+="PHOTOGRAPHIC_TONEMAPPING"),_.updateEffect(b),_.onApply=function(C){C.setFloat("_ExposureAdjustment",_.exposureAdjustment)},_}return t.prototype.getClassName=function(){return"TonemapPostProcess"},t}(ii.a),Ty=u(664),Yh="volumetricLightScatteringPixelShader",Kh=`uniform sampler2D textureSampler;
uniform sampler2D lightScatteringSampler;
uniform float decay;
uniform float exposure;
uniform float weight;
uniform float density;
uniform vec2 meshPositionOnScreen;
varying vec2 vUV;
void main(void) {
vec2 tc=vUV;
vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);
deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;
float illuminationDecay=1.0;
vec4 color=texture2D(lightScatteringSampler,tc)*0.4;
for(int i=0; i<NUM_SAMPLES; i++) {
tc-=deltaTexCoord;
vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;
dataSample*=illuminationDecay*weight;
color+=dataSample;
illuminationDecay*=decay;
}
vec4 realColor=texture2D(textureSampler,vUV);
gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));
}
`;qe.a.ShadersStore[Yh]=Kh;var Ay={name:Yh,shader:Kh},Ry=u(507),Oy=u(508),Qh="volumetricLightScatteringPassVertexShader",Zh=`
attribute vec3 position;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
void main(void)
{
vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;qe.a.ShadersStore[Qh]=Zh;var My={name:Qh,shader:Zh},Jh="volumetricLightScatteringPassPixelShader",$h=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);
if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);
}
`;qe.a.ShadersStore[Jh]=$h;var xy={name:Jh,shader:$h},qh=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_,b){a===void 0&&(a=100),s===void 0&&(s=Ze.a.BILINEAR_SAMPLINGMODE);var C=n.call(this,e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],i.postProcessRatio||i,r,s,c,_,"#define NUM_SAMPLES "+a)||this;return C._screenCoordinates=l.d.Zero(),C.customMeshPosition=l.e.Zero(),C.useCustomMeshPosition=!1,C.invert=!0,C.excludedMeshes=new Array,C.exposure=.3,C.decay=.96815,C.weight=.58767,C.density=.926,b=r===null?b:r.getScene(),c=b.getEngine(),C._viewPort=new lr.a(0,0,1,1).toGlobal(c.getRenderWidth(),c.getRenderHeight()),C.mesh=o!==null?o:t.CreateDefaultMesh("VolumetricLightScatteringMesh",b),C._createPass(b,i.passRatio||i),C.onActivate=function(x){C.isSupported||C.dispose(x),C.onActivate=null},C.onApplyObservable.add(function(x){C._updateMeshScreenCoordinates(b),x.setTexture("lightScatteringSampler",C._volumetricLightScatteringRTT),x.setFloat("exposure",C.exposure),x.setFloat("decay",C.decay),x.setFloat("weight",C.weight),x.setFloat("density",C.density),x.setVector2("meshPositionOnScreen",C._screenCoordinates)}),C}return Object.defineProperty(t.prototype,"useDiffuseColor",{get:function(){return d.a.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1},set:function(e){d.a.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"VolumetricLightScatteringPostProcess"},t.prototype._isReady=function(e,i){var r=e.getMesh();if(r===this.mesh&&r.material)return r.material.isReady(r);var o=[],a=[Be.b.PositionKind],s=e.getMaterial();s&&(s.needAlphaTesting()&&o.push("#define ALPHATEST"),r.isVerticesDataPresent(Be.b.UVKind)&&(a.push(Be.b.UVKind),o.push("#define UV1")),r.isVerticesDataPresent(Be.b.UV2Kind)&&(a.push(Be.b.UV2Kind),o.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders?(a.push(Be.b.MatricesIndicesKind),a.push(Be.b.MatricesWeightsKind),o.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),o.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0))):o.push("#define NUM_BONE_INFLUENCERS 0"),i&&(o.push("#define INSTANCES"),xt.a.PushAttributesForInstances(a),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));var c=o.join(`
`);return this._cachedDefines!==c&&(this._cachedDefines=c,this._volumetricLightScatteringPass=r.getScene().getEngine().createEffect("volumetricLightScatteringPass",a,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],c,void 0,void 0,void 0,{maxSimultaneousMorphTargets:r.numBoneInfluencers})),this._volumetricLightScatteringPass.isReady()},t.prototype.setCustomMeshPosition=function(e){this.customMeshPosition=e},t.prototype.getCustomMeshPosition=function(){return this.customMeshPosition},t.prototype.dispose=function(e){var i=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);i!==-1&&e.getScene().customRenderTargets.splice(i,1),this._volumetricLightScatteringRTT.dispose(),n.prototype.dispose.call(this,e)},t.prototype.getPass=function(){return this._volumetricLightScatteringRTT},t.prototype._meshExcluded=function(e){return this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1},t.prototype._createPass=function(e,i){var r=this,o=e.getEngine();this._volumetricLightScatteringRTT=new Cr.a("volumetricLightScatteringMap",{width:o.getRenderWidth()*i,height:o.getRenderHeight()*i},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=Ze.a.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;var a=this.getCamera();a?a.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);var s=function(b){var C=b.getRenderingMesh(),x=b.getEffectiveMesh();if(!r._meshExcluded(C)){x._internalAbstractMeshDataInfo._isActiveIntermediate=!1;var V=b.getMaterial();if(!!V){var D=C.getScene(),z=D.getEngine();z.setState(V.backFaceCulling);var q=C._getInstancesRenderList(b._id,!!b.getReplacementMesh());if(!q.mustReturn){var ue=z.getCaps().instancedArrays&&(q.visibleInstances[b._id]!==null||C.hasThinInstances);if(r._isReady(b,ue)){var ge=r._volumetricLightScatteringPass;if(C===r.mesh&&(b.effect?ge=b.effect:ge=V.getEffect()),z.enableEffect(ge),C._bind(b,ge,V.fillMode),C===r.mesh)V.bind(x.getWorldMatrix(),C);else{if(r._volumetricLightScatteringPass.setMatrix("viewProjection",D.getTransformMatrix()),V&&V.needAlphaTesting()){var Se=V.getAlphaTestTexture();r._volumetricLightScatteringPass.setTexture("diffuseSampler",Se),Se&&r._volumetricLightScatteringPass.setMatrix("diffuseMatrix",Se.getTextureMatrix())}C.useBones&&C.computeBonesUsingShaders&&C.skeleton&&r._volumetricLightScatteringPass.setMatrices("mBones",C.skeleton.getTransformMatrices(C))}C._processRendering(x,b,r._volumetricLightScatteringPass,Yi.a.TriangleFillMode,q,ue,function(Pe,me){return ge.setMatrix("world",me)})}}}}},c,_=new v.b(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){c=e.clearColor,e.clearColor=_}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){e.clearColor=c}),this._volumetricLightScatteringRTT.customRenderFunction=function(b,C,x,V){var D=e.getEngine(),z;if(V.length){for(D.setColorWrite(!1),z=0;z<V.length;z++)s(V.data[z]);D.setColorWrite(!0)}for(z=0;z<b.length;z++)s(b.data[z]);for(z=0;z<C.length;z++)s(C.data[z]);if(x.length){for(z=0;z<x.length;z++){var q=x.data[z],ue=q.getBoundingInfo();ue&&e.activeCamera&&(q._alphaIndex=q.getMesh().alphaIndex,q._distanceToCamera=ue.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}var ge=x.data.slice(0,x.length);for(ge.sort(function(Se,Pe){return Se._alphaIndex>Pe._alphaIndex?1:Se._alphaIndex<Pe._alphaIndex?-1:Se._distanceToCamera<Pe._distanceToCamera?1:Se._distanceToCamera>Pe._distanceToCamera?-1:0}),D.setAlphaMode(2),z=0;z<ge.length;z++)s(ge[z]);D.setAlphaMode(0)}}},t.prototype._updateMeshScreenCoordinates=function(e){var i=e.getTransformMatrix(),r;this.useCustomMeshPosition?r=this.customMeshPosition:this.attachedNode?r=this.attachedNode.position:r=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;var o=l.e.Project(r,l.a.Identity(),i,this._viewPort);this._screenCoordinates.x=o.x/this._viewPort.width,this._screenCoordinates.y=o.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)},t.CreateDefaultMesh=function(e,i){var r=st.a.CreatePlane(e,1,i);r.billboardMode=Ae.a.BILLBOARDMODE_ALL;var o=new zt.a(e+"Material",i);return o.emissiveColor=new v.a(1,1,1),r.material=o,r},Object(p.c)([Object(Ee.o)()],t.prototype,"customMeshPosition",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"useCustomMeshPosition",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"invert",void 0),Object(p.c)([Object(Ee.k)()],t.prototype,"mesh",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"excludedMeshes",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"exposure",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"decay",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"weight",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"density",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.VolumetricLightScatteringPostProcess"]=qh;var tv=u(581),iv=u(547),ed="screenSpaceCurvaturePixelShader",td=`

precision highp float;

varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D normalSampler;
uniform float curvature_ridge;
uniform float curvature_valley;
#ifndef CURVATURE_OFFSET
#define CURVATURE_OFFSET 1
#endif
float curvature_soft_clamp(float curvature,float control)
{
if (curvature<0.5/control)
return curvature*(1.0-curvature*control);
return 0.25/control;
}
float calculate_curvature(ivec2 texel,float ridge,float valley)
{
vec2 normal_up=texelFetchOffset(normalSampler,texel,0,ivec2(0,CURVATURE_OFFSET)).rb;
vec2 normal_down=texelFetchOffset(normalSampler,texel,0,ivec2(0,-CURVATURE_OFFSET)).rb;
vec2 normal_left=texelFetchOffset(normalSampler,texel,0,ivec2(-CURVATURE_OFFSET,0)).rb;
vec2 normal_right=texelFetchOffset(normalSampler,texel,0,ivec2( CURVATURE_OFFSET,0)).rb;
float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));
if (normal_diff<0.0)
return -2.0*curvature_soft_clamp(-normal_diff,valley);
return 2.0*curvature_soft_clamp(normal_diff,ridge);
}
void main(void)
{
ivec2 texel=ivec2(gl_FragCoord.xy);
vec4 baseColor=texture2D(textureSampler,vUV);
float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);
baseColor.rgb*=curvature+1.0;
gl_FragColor=baseColor;
}`;qe.a.ShadersStore[ed]=td;var Dy={name:ed,shader:td},id=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_,b){_===void 0&&(_=0),b===void 0&&(b=!1);var C=n.call(this,e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],r,o,a,s,c,void 0,_,void 0,null,b)||this;return C.ridge=1,C.valley=1,C._geometryBufferRenderer=i.enableGeometryBufferRenderer(),C._geometryBufferRenderer?C.onApply=function(x){x.setFloat("curvature_ridge",.5/Math.max(C.ridge*C.ridge,1e-4)),x.setFloat("curvature_valley",.7/Math.max(C.valley*C.valley,1e-4));var V=C._geometryBufferRenderer.getGBuffer().textures[1];x.setTexture("normalSampler",V)}:d.a.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first."),C}return t.prototype.getClassName=function(){return"ScreenSpaceCurvaturePostProcess"},Object.defineProperty(t,"IsSupported",{get:function(){var e=Kt.a.LastCreatedEngine;return e?e.getCaps().drawBuffersExtension:!1},enumerable:!1,configurable:!0}),t._Parse=function(e,i,r,o){return Ee.a.Parse(function(){return new t(e.name,r,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.textureType,e.reusable)},e,r,o)},Object(p.c)([Object(Ee.c)()],t.prototype,"ridge",void 0),Object(p.c)([Object(Ee.c)()],t.prototype,"valley",void 0),t}(ii.a);f.a.RegisteredTypes["BABYLON.ScreenSpaceCurvaturePostProcess"]=id;var rv=u(635);Object.defineProperty(ae.a.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(n){this._forceShowBoundingBoxes=n,n&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),ae.a.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new rd(this)),this._boundingBoxRenderer},Object.defineProperty(Ae.a.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(n){this._showBoundingBox=n,n&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});var rd=function(){function n(t){this.name=X.a.NAME_BOUNDINGBOXRENDERER,this.frontColor=new v.a(1,1,1),this.backColor=new v.a(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new g.c,this.onAfterBoxRenderingObservable=new g.c,this.onResourcesReadyObservable=new g.c,this.enabled=!0,this.renderList=new Ct.a(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=t,t._addComponent(this)}return n.prototype.register=function(){this.scene._beforeEvaluateActiveMeshStage.registerStep(X.a.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(X.a.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(X.a.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(X.a.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)},n.prototype._evaluateSubMesh=function(t,e){if(t.showSubMeshesBoundingBox){var i=e.getBoundingInfo();i!=null&&(i.boundingBox._tag=t.renderingGroupId,this.renderList.push(i.boundingBox))}},n.prototype._preActiveMesh=function(t){if(t.showBoundingBox||this.scene.forceShowBoundingBoxes){var e=t.getBoundingInfo();e.boundingBox._tag=t.renderingGroupId,this.renderList.push(e.boundingBox)}},n.prototype._prepareResources=function(){if(!this._colorShader){this._colorShader=new Tn.a("colorShader",this.scene,"color",{attributes:[Be.b.PositionKind],uniforms:["world","viewProjection","color"]}),this._colorShader.reservedDataStore={hidden:!0};var t=this.scene.getEngine(),e=an.a.CreateBox({size:1});this._vertexBuffers[Be.b.PositionKind]=new Be.b(t,e.positions,Be.b.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=e.indices,this.onResourcesReadyObservable.notifyObservers(this)}},n.prototype._createIndexBuffer=function(){var t=this.scene.getEngine();this._indexBuffer=t.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])},n.prototype.rebuild=function(){var t=this._vertexBuffers[Be.b.PositionKind];t&&t._rebuild(),this._createIndexBuffer()},n.prototype.reset=function(){this.renderList.reset()},n.prototype.render=function(t){if(!(this.renderList.length===0||!this.enabled)&&(this._prepareResources(),!!this._colorShader.isReady())){var e=this.scene.getEngine();e.setDepthWrite(!1),this._colorShader._preBind();for(var i=0;i<this.renderList.length;i++){var r=this.renderList.data[i];if(r._tag===t){this.onBeforeBoxRenderingObservable.notifyObservers(r);var o=r.minimum,a=r.maximum,s=a.subtract(o),c=o.add(s.scale(.5)),_=l.a.Scaling(s.x,s.y,s.z).multiply(l.a.Translation(c.x,c.y,c.z)).multiply(r.getWorldMatrix());e.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),this.showBackLines&&(e.setDepthFunctionToGreaterOrEqual(),this.scene.resetCachedMaterial(),this._colorShader.setColor4("color",this.backColor.toColor4()),this._colorShader.bind(_),e.drawElementsType(Yi.a.LineListDrawMode,0,24)),e.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._colorShader.setColor4("color",this.frontColor.toColor4()),this._colorShader.bind(_),e.drawElementsType(Yi.a.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(r)}}this._colorShader.unbind(),e.setDepthFunctionToLessOrEqual(),e.setDepthWrite(!0)}},n.prototype.renderOcclusionBoundingBox=function(t){if(this._prepareResources(),!(!this._colorShader.isReady()||!t._boundingInfo)){var e=this.scene.getEngine();this._fillIndexBuffer||(this._fillIndexBuffer=e.createIndexBuffer(this._fillIndexData)),e.setDepthWrite(!1),e.setColorWrite(!1),this._colorShader._preBind();var i=t._boundingInfo.boundingBox,r=i.minimum,o=i.maximum,a=o.subtract(r),s=r.add(a.scale(.5)),c=l.a.Scaling(a.x,a.y,a.z).multiply(l.a.Translation(s.x,s.y,s.z)).multiply(i.getWorldMatrix());e.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,this._colorShader.getEffect()),e.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._colorShader.bind(c),e.drawElementsType(Yi.a.TriangleFillMode,0,36),this._colorShader.unbind(),e.setDepthFunctionToLessOrEqual(),e.setDepthWrite(!0),e.setColorWrite(!0)}},n.prototype.dispose=function(){if(!!this._colorShader){this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose();var t=this._vertexBuffers[Be.b.PositionKind];t&&(t.dispose(),this._vertexBuffers[Be.b.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}},n}(),nv=u(556),ov=u(666),nd="linePixelShader",od=`uniform vec4 color;
void main(void) {
gl_FragColor=color;
}`;qe.a.ShadersStore[nd]=od;var Iy={name:nd,shader:od},ad="lineVertexShader",sd=`#include<instancesDeclaration>

attribute vec3 position;
attribute vec4 normal;

uniform mat4 viewProjection;
uniform float width;
uniform float aspectRatio;
void main(void) {
#include<instancesVertex>
mat4 worldViewProjection=viewProjection*finalWorld;
vec4 viewPosition=worldViewProjection*vec4(position,1.0);
vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);
vec2 currentScreen=viewPosition.xy/viewPosition.w;
vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;
currentScreen.x*=aspectRatio;
nextScreen.x*=aspectRatio;
vec2 dir=normalize(nextScreen-currentScreen);
vec2 normalDir=vec2(-dir.y,dir.x);
normalDir*=width/2.0;
normalDir.x/=aspectRatio;
vec4 offset=vec4(normalDir*normal.w,0.0,0.0);
gl_Position=viewPosition+offset;
}`;qe.a.ShadersStore[ad]=sd;var Ly={name:ad,shader:sd};Ae.a.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},Ae.a.prototype.enableEdgesRendering=function(n,t,e){return n===void 0&&(n=.95),t===void 0&&(t=!1),this.disableEdgesRendering(),this._edgesRenderer=new ol(this,n,t,!0,e),this},Object.defineProperty(Ae.a.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),Oo.b.prototype.enableEdgesRendering=function(n,t){return n===void 0&&(n=.95),t===void 0&&(t=!1),this.disableEdgesRendering(),this._edgesRenderer=new ld(this,n,t),this},Oo.a.prototype.enableEdgesRendering=function(n,t){return n===void 0&&(n=.95),t===void 0&&(t=!1),Oo.b.prototype.enableEdgesRendering.apply(this,arguments),this};var av=function(){function n(){this.edges=new Array,this.edgesConnectedCount=0}return n}(),ol=function(){function n(t,e,i,r,o){var a=this;e===void 0&&(e=.95),i===void 0&&(i=!1),r===void 0&&(r=!0);var s;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new Ct.a(32),this._source=t,this._checkVerticesInsteadOfIndices=i,this._options=o!=null?o:null,this._epsilon=e,this._prepareRessources(),r&&(((s=o==null?void 0:o.useAlternateEdgeFinder)!==null&&s!==void 0?s:!0)?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(function(){a._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(function(){a.dispose()})}return Object.defineProperty(n.prototype,"linesPositions",{get:function(){return this._linesPositions},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"linesNormals",{get:function(){return this._linesNormals},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"linesIndices",{get:function(){return this._linesIndices},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"lineShader",{get:function(){return this._lineShader},set:function(t){this._lineShader=t},enumerable:!1,configurable:!0}),n.GetShader=function(t){if(!t._edgeRenderLineShader){var e=new Tn.a("lineShader",t,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]});e.disableDepthWrite=!0,e.backFaceCulling=!1,t._edgeRenderLineShader=e}return t._edgeRenderLineShader},n.prototype._prepareRessources=function(){this._lineShader||(this._lineShader=n.GetShader(this._source.getScene()))},n.prototype._rebuild=function(){var t=this._buffers[Be.b.PositionKind];t&&t._rebuild(),t=this._buffers[Be.b.NormalKind],t&&t._rebuild();var e=this._source.getScene(),i=e.getEngine();this._ib=i.createIndexBuffer(this._linesIndices)},n.prototype.dispose=function(){this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);var t=this._buffers[Be.b.PositionKind];t&&(t.dispose(),this._buffers[Be.b.PositionKind]=null),t=this._buffers[Be.b.NormalKind],t&&(t.dispose(),this._buffers[Be.b.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose()},n.prototype._processEdgeForAdjacencies=function(t,e,i,r,o){return t===i&&e===r||t===r&&e===i?0:t===r&&e===o||t===o&&e===r?1:t===o&&e===i||t===i&&e===o?2:-1},n.prototype._processEdgeForAdjacenciesWithVertices=function(t,e,i,r,o){var a=1e-10;return t.equalsWithEpsilon(i,a)&&e.equalsWithEpsilon(r,a)||t.equalsWithEpsilon(r,a)&&e.equalsWithEpsilon(i,a)?0:t.equalsWithEpsilon(r,a)&&e.equalsWithEpsilon(o,a)||t.equalsWithEpsilon(o,a)&&e.equalsWithEpsilon(r,a)?1:t.equalsWithEpsilon(o,a)&&e.equalsWithEpsilon(i,a)||t.equalsWithEpsilon(i,a)&&e.equalsWithEpsilon(o,a)?2:-1},n.prototype._checkEdge=function(t,e,i,r,o){var a;if(e===void 0)a=!0;else{var s=l.e.Dot(i[t],i[e]);a=s<this._epsilon}a&&this.createLine(r,o,this._linesPositions.length/3)},n.prototype.createLine=function(t,e,i){this._linesPositions.push(t.x,t.y,t.z,t.x,t.y,t.z,e.x,e.y,e.z,e.x,e.y,e.z),this._linesNormals.push(e.x,e.y,e.z,-1,e.x,e.y,e.z,1,t.x,t.y,t.z,-1,t.x,t.y,t.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)},n.prototype._tessellateTriangle=function(t,e,i,r){var o=function(Oe,je,ke){ke>=0&&je.push(ke);for(var ze=0;ze<Oe.length;++ze)je.push(Oe[ze][0])},a=0;t[1].length>=t[0].length&&t[1].length>=t[2].length?a=1:t[2].length>=t[0].length&&t[2].length>=t[1].length&&(a=2);for(var s=0;s<3;++s)s===a?t[s].sort(function(Oe,je){return Oe[1]<je[1]?-1:Oe[1]>je[1]?1:0}):t[s].sort(function(Oe,je){return Oe[1]>je[1]?-1:Oe[1]<je[1]?1:0});var c=[],_=[];o(t[a],c,-1);for(var b=c.length,C=a+2;C>=a+1;--C)o(t[C%3],_,C!==a+2?r[i[e+(C+1)%3]]:-1);var x=_.length,V=0,D=0;i.push(r[i[e+a]],c[0],_[0]),i.push(r[i[e+(a+1)%3]],_[x-1],c[b-1]);for(var z=b<=x,q=z?b:x,ue=z?x:b,ge=z?b-1:x-1,Se=z?0:1,Pe=b+x-2,me=z?V:D,xe=z?D:V,Fe=z?c:_,we=z?_:c,Ge=0;Pe-- >0;){Se?i.push(Fe[me],we[xe]):i.push(we[xe],Fe[me]),Ge+=q;var Xe=void 0;Ge>=ue&&me<ge?(Xe=Fe[++me],Ge-=ue):Xe=we[++xe],i.push(Xe)}i[e+0]=i[i.length-3],i[e+1]=i[i.length-2],i[e+2]=i[i.length-1],i.length=i.length-3},n.prototype._generateEdgesLinesAlternate=function(){var t,e,i,r,o,a,s,c,_,b=this._source.getVerticesData(Be.b.PositionKind),C=this._source.getIndices();if(!(!C||!b)){Array.isArray(C)||(C=re.b.SliceToArray(C));var x=(e=(t=this._options)===null||t===void 0?void 0:t.useFastVertexMerger)!==null&&e!==void 0?e:!0,V=x?Math.round(-Math.log((r=(i=this._options)===null||i===void 0?void 0:i.epsilonVertexMerge)!==null&&r!==void 0?r:1e-6)/Math.log(10)):(a=(o=this._options)===null||o===void 0?void 0:o.epsilonVertexMerge)!==null&&a!==void 0?a:1e-6,D=[],z=[];if(x)for(var q={},ue=0;ue<b.length;ue+=3){var ge=b[ue+0],Se=b[ue+1],Pe=b[ue+2],me=ge.toFixed(V)+"|"+Se.toFixed(V)+"|"+Pe.toFixed(V);if(q[me]!==void 0)D.push(q[me]);else{var xe=ue/3;q[me]=xe,D.push(xe),z.push(xe)}}else for(var ue=0;ue<b.length;ue+=3){for(var ge=b[ue+0],Se=b[ue+1],Pe=b[ue+2],Fe=!1,we=0;we<ue&&!Fe;we+=3){var Ge=b[we+0],Xe=b[we+1],Oe=b[we+2];if(Math.abs(ge-Ge)<V&&Math.abs(Se-Xe)<V&&Math.abs(Pe-Oe)<V){D.push(we/3),Fe=!0;break}}Fe||(D.push(ue/3),z.push(ue/3))}if((s=this._options)===null||s===void 0?void 0:s.applyTessellation){for(var je=(_=(c=this._options)===null||c===void 0?void 0:c.epsilonVertexAligned)!==null&&_!==void 0?_:1e-6,ke=[],ze=0;ze<C.length;ze+=3)for(var Je=void 0,it=0;it<3;++it){var Ke=D[C[ze+it]],St=D[C[ze+(it+1)%3]],Mt=D[C[ze+(it+2)%3]];if(Ke!==St)for(var Rt=b[Ke*3+0],at=b[Ke*3+1],Bt=b[Ke*3+2],Wt=b[St*3+0],lt=b[St*3+1],Ft=b[St*3+2],Qe=Math.sqrt((Wt-Rt)*(Wt-Rt)+(lt-at)*(lt-at)+(Ft-Bt)*(Ft-Bt)),ct=0;ct<z.length-1;ct++){var wt=z[ct];if(!(wt===Ke||wt===St||wt===Mt)){var fi=b[wt*3+0],si=b[wt*3+1],xi=b[wt*3+2],bi=Math.sqrt((fi-Rt)*(fi-Rt)+(si-at)*(si-at)+(xi-Bt)*(xi-Bt)),Tt=Math.sqrt((fi-Wt)*(fi-Wt)+(si-lt)*(si-lt)+(xi-Ft)*(xi-Ft));Math.abs(bi+Tt-Qe)<je&&(Je||(Je={index:ze,edgesPoints:[[],[],[]]},ke.push(Je)),Je.edgesPoints[it].push([wt,bi]))}}}for(var $t=0;$t<ke.length;++$t){var vi=ke[$t];this._tessellateTriangle(vi.edgesPoints,vi.index,C,D)}ke=null}for(var hi={},ze=0;ze<C.length;ze+=3)for(var di=void 0,it=0;it<3;++it){var Ke=D[C[ze+it]],St=D[C[ze+(it+1)%3]],Mt=D[C[ze+(it+2)%3]];if(Ke!==St){if(l.c.Vector3[0].copyFromFloats(b[Ke*3+0],b[Ke*3+1],b[Ke*3+2]),l.c.Vector3[1].copyFromFloats(b[St*3+0],b[St*3+1],b[St*3+2]),l.c.Vector3[2].copyFromFloats(b[Mt*3+0],b[Mt*3+1],b[Mt*3+2]),di||(l.c.Vector3[1].subtractToRef(l.c.Vector3[0],l.c.Vector3[3]),l.c.Vector3[2].subtractToRef(l.c.Vector3[1],l.c.Vector3[4]),di=l.e.Cross(l.c.Vector3[3],l.c.Vector3[4]),di.normalize()),Ke>St){var ft=Ke;Ke=St,St=ft}var me=Ke+"_"+St,oi=hi[me];if(oi){if(!oi.done){var sn=l.e.Dot(di,oi.normal);sn<this._epsilon&&this.createLine(l.c.Vector3[0],l.c.Vector3[1],this._linesPositions.length/3),oi.done=!0}}else hi[me]={normal:di,done:!1,index:ze,i:it}}}for(var me in hi){var oi=hi[me];if(!oi.done){var Ke=D[C[oi.index+oi.i]],St=D[C[oi.index+(oi.i+1)%3]];l.c.Vector3[0].copyFromFloats(b[Ke*3+0],b[Ke*3+1],b[Ke*3+2]),l.c.Vector3[1].copyFromFloats(b[St*3+0],b[St*3+1],b[St*3+2]),this.createLine(l.c.Vector3[0],l.c.Vector3[1],this._linesPositions.length/3)}}var Kr=this._source.getScene().getEngine();this._buffers[Be.b.PositionKind]=new Be.b(Kr,this._linesPositions,Be.b.PositionKind,!1),this._buffers[Be.b.NormalKind]=new Be.b(Kr,this._linesNormals,Be.b.NormalKind,!1,!1,4),this._buffersForInstances[Be.b.PositionKind]=this._buffers[Be.b.PositionKind],this._buffersForInstances[Be.b.NormalKind]=this._buffers[Be.b.NormalKind],this._ib=Kr.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},n.prototype._generateEdgesLines=function(){var t=this._source.getVerticesData(Be.b.PositionKind),e=this._source.getIndices();if(!(!e||!t)){var i=new Array,r=new Array,o,a;for(o=0;o<e.length;o+=3){a=new av;var s=e[o],c=e[o+1],_=e[o+2];a.p0=new l.e(t[s*3],t[s*3+1],t[s*3+2]),a.p1=new l.e(t[c*3],t[c*3+1],t[c*3+2]),a.p2=new l.e(t[_*3],t[_*3+1],t[_*3+2]);var b=l.e.Cross(a.p1.subtract(a.p0),a.p2.subtract(a.p1));b.normalize(),r.push(b),i.push(a)}for(o=0;o<i.length;o++){a=i[o];for(var C=o+1;C<i.length;C++){var x=i[C];if(a.edgesConnectedCount===3)break;if(x.edgesConnectedCount!==3)for(var V=e[C*3],D=e[C*3+1],z=e[C*3+2],q=0;q<3;q++){var ue=0;if(a.edges[q]===void 0){switch(q){case 0:this._checkVerticesInsteadOfIndices?ue=this._processEdgeForAdjacenciesWithVertices(a.p0,a.p1,x.p0,x.p1,x.p2):ue=this._processEdgeForAdjacencies(e[o*3],e[o*3+1],V,D,z);break;case 1:this._checkVerticesInsteadOfIndices?ue=this._processEdgeForAdjacenciesWithVertices(a.p1,a.p2,x.p0,x.p1,x.p2):ue=this._processEdgeForAdjacencies(e[o*3+1],e[o*3+2],V,D,z);break;case 2:this._checkVerticesInsteadOfIndices?ue=this._processEdgeForAdjacenciesWithVertices(a.p2,a.p0,x.p0,x.p1,x.p2):ue=this._processEdgeForAdjacencies(e[o*3+2],e[o*3],V,D,z);break}if(ue!==-1&&(a.edges[q]=C,x.edges[ue]=o,a.edgesConnectedCount++,x.edgesConnectedCount++,a.edgesConnectedCount===3))break}}}}for(o=0;o<i.length;o++){var ge=i[o];this._checkEdge(o,ge.edges[0],r,ge.p0,ge.p1),this._checkEdge(o,ge.edges[1],r,ge.p1,ge.p2),this._checkEdge(o,ge.edges[2],r,ge.p2,ge.p0)}var Se=this._source.getScene().getEngine();this._buffers[Be.b.PositionKind]=new Be.b(Se,this._linesPositions,Be.b.PositionKind,!1),this._buffers[Be.b.NormalKind]=new Be.b(Se,this._linesNormals,Be.b.NormalKind,!1,!1,4),this._buffersForInstances[Be.b.PositionKind]=this._buffers[Be.b.PositionKind],this._buffersForInstances[Be.b.NormalKind]=this._buffers[Be.b.NormalKind],this._ib=Se.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},n.prototype.isReady=function(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)},n.prototype.render=function(){var t=this._source.getScene();if(!(!this.isReady()||!t.activeCamera)){var e=t.getEngine();this._lineShader._preBind(),this._source.edgesColor.a!==1?e.setAlphaMode(2):e.setAlphaMode(0);var i=this._source.hasInstances&&this.customInstances.length>0,r=i||this._source.hasThinInstances,o=0;if(r)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){var a=this._source._instanceDataStorage;if(o=this.customInstances.length,!a.isFrozen){for(var s=0,c=0;c<o;++c)this.customInstances.data[c].copyToArray(a.instancesData,s),s+=16;a.instancesBuffer.updateDirectly(a.instancesData,0,o)}}else o=this._source.thinInstanceCount;e.bindBuffers(r?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),t.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),t.activeCamera.mode===te.a.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",e.getAspectRatio(t.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),e.drawElementsType(Yi.a.TriangleFillMode,0,this._indicesCount,o),this._lineShader.unbind(),r&&e.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset()}},n}(),ld=function(n){Object(p.d)(t,n);function t(e,i,r){i===void 0&&(i=.95),r===void 0&&(r=!1);var o=n.call(this,e,i,r,!1)||this;return o._generateEdgesLines(),o}return t.prototype._generateEdgesLines=function(){var e=this._source.getVerticesData(Be.b.PositionKind),i=this._source.getIndices();if(!(!i||!e)){for(var r=l.c.Vector3[0],o=l.c.Vector3[1],a=i.length-1,s=0,c=0;s<a;s+=2,c+=4)l.e.FromArrayToRef(e,3*i[s],r),l.e.FromArrayToRef(e,3*i[s+1],o),this.createLine(r,o,c);var _=this._source.getScene().getEngine();this._buffers[Be.b.PositionKind]=new Be.b(_,this._linesPositions,Be.b.PositionKind,!1),this._buffers[Be.b.NormalKind]=new Be.b(_,this._linesNormals,Be.b.NormalKind,!1,!1,4),this._ib=_.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},t}(ol),sv=u(502),lv=u(598),uv=u(649),Fy=u(644),ud="fibonacci",cd=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
#define TWO_PI 6.2831855


vec2 Golden2dSeq(int i,float n)
{


return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));
}
vec2 SampleDiskGolden(int i,int sampleCount)
{
vec2 f=Golden2dSeq(i,float(sampleCount));
return vec2(sqrt(f.x),TWO_PI*f.y);
}`;qe.a.IncludesShadersStore[ud]=cd;var By={name:ud,shader:cd},Ny=u(627),fd="diffusionProfile",hd=`uniform vec3 diffusionS[5];
uniform float diffusionD[5];
uniform float filterRadii[5];`;qe.a.IncludesShadersStore[fd]=hd;var wy={name:fd,shader:hd},dd="subSurfaceScatteringPixelShader",pd=`
#include<fibonacci>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;
uniform vec2 texelSize;
uniform sampler2D textureSampler;
uniform sampler2D irradianceSampler;
uniform sampler2D depthSampler;
uniform sampler2D albedoSampler;
uniform vec2 viewportSize;
uniform float metersPerUnit;
const float LOG2_E=1.4426950408889634;
const float SSS_PIXELS_PER_SAMPLE=4.;
const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true


vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{
vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S);
vec3 expSum=exp_13*(1.+exp_13*exp_13);
return (S*rcp(8.*PI))*expSum;
}






vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{
u=1.-u;
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));
float n=exp2(log2(g)*(-1.0/3.0));
float p=(g*n)*n;
float c=1.+p+n;
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u);
float x=(3./LOG2_E)*log2(c)-d;






float rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));
float r=x*rcpS;
float rcpPdf=(8.*PI*rcpS)*rcpExp;
return vec2(r,rcpPdf);
}


vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif



float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));
float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{

float scale=rcp(float(n));
float offset=rcp(float(n))*0.5;

float sinPhase,cosPhase;
sinPhase=sin(phase);
cosPhase=cos(phase);
vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);
float r=bdp.x;
float rcpPdf=bdp.y;
float phi=SampleDiskGolden(i,n).y;
float sinPhi,cosPhi;
sinPhi=sin(phi);
cosPhi=cos(phi);
float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi;
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi;
vec2 vec=r*vec2(cosPsi,sinPsi);

vec2 position;
float xy2;
position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;
xy2=r*r;
vec4 textureSample=texture2D(irradianceSampler,position);
float viewZ=texture2D(depthSampler,position).r;
vec3 irradiance=textureSample.rgb;
if (testLightingForSSS(textureSample.a))
{

float relZ=viewZ-centerPosVS.z;
vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);
totalIrradiance+=weight*irradiance;
totalWeight+=weight;
}
else
{






}
}
void main(void)
{
vec4 irradianceAndDiffusionProfile=texture2D(irradianceSampler,vUV);
vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;
int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));
float centerDepth=0.;
vec4 inputColor=texture2D(textureSampler,vUV);
bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);
if (passedStencilTest)
{
centerDepth=texture2D(depthSampler,vUV).r;
}
if (!passedStencilTest) {
gl_FragColor=inputColor;
return;
}
float distScale=1.;
vec3 S=diffusionS[diffusionProfileIndex];
float d=diffusionD[diffusionProfileIndex];
float filterRadius=filterRadii[diffusionProfileIndex];

vec2 centerPosNDC=vUV;
vec2 cornerPosNDC=vUV+0.5*texelSize;
vec3 centerPosVS=vec3(centerPosNDC*viewportSize,1.0)*centerDepth;
vec3 cornerPosVS=vec3(cornerPosNDC*viewportSize,1.0)*centerDepth;

float mmPerUnit=1000.*(metersPerUnit*rcp(distScale));
float unitsPerMm=rcp(mmPerUnit);


float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);
float pixelsPerMm=rcp(unitsPerPixel)*unitsPerMm;

float filterArea=PI*Sq(filterRadius*pixelsPerMm);
int sampleCount=int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));
int sampleBudget=_SssSampleBudget;
int texturingMode=0;
vec3 albedo=texture2D(albedoSampler,vUV).rgb;
if (distScale == 0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);
gl_FragColor=vec4(green,1.0);
return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);
return;
}
#ifdef DEBUG_SSS_SAMPLES
vec3 red=vec3(1.,0.,0.);
vec3 blue=vec3(0.,0.,1.);
gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);
return;
#endif

float phase=0.;
int n=min(sampleCount,sampleBudget);

vec3 centerWeight=vec3(0.);
vec3 totalIrradiance=vec3(0.);
vec3 totalWeight=vec3(0.);
for (int i=0; i<n; i++)
{

EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);
}

totalWeight=max(totalWeight,HALF_MIN);
gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);
}`;qe.a.ShadersStore[dd]=pd;var Vy={name:dd,shader:pd},Uy=u(534),cv=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c,_){o===void 0&&(o=null),_===void 0&&(_=0);var b=n.call(this,e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],r,o,a||Ze.a.BILINEAR_SAMPLINGMODE,s,c,null,_,"postprocess",void 0,!0)||this;return b._scene=i,b.updateEffect(),b.onApplyObservable.add(function(C){if(!i.prePassRenderer||!i.subSurfaceConfiguration){d.a.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}var x=b.texelSize;C.setFloat("metersPerUnit",i.subSurfaceConfiguration.metersPerUnit),C.setFloat2("texelSize",x.x,x.y),C.setTexture("irradianceSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(0)]),C.setTexture("depthSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(5)]),C.setTexture("albedoSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(7)]),C.setFloat2("viewportSize",Math.tan(i.activeCamera.fov/2)*i.getEngine().getAspectRatio(i.activeCamera,!0),Math.tan(i.activeCamera.fov/2)),C.setArray3("diffusionS",i.subSurfaceConfiguration.ssDiffusionS),C.setArray("diffusionD",i.subSurfaceConfiguration.ssDiffusionD),C.setArray("filterRadii",i.subSurfaceConfiguration.ssFilterRadii)}),b}return t.prototype.getClassName=function(){return"SubSurfaceScatteringPostProcess"},t}(ii.a),md=function(){function n(t){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=X.a.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new v.a(1,1,1)),this._scene=t,n._SceneComponentInitialization(this._scene)}return Object.defineProperty(n.prototype,"ssDiffusionS",{get:function(){return this._ssDiffusionS},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ssDiffusionD",{get:function(){return this._ssDiffusionD},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ssFilterRadii",{get:function(){return this._ssFilterRadii},enumerable:!1,configurable:!0}),n.prototype.addDiffusionProfile=function(t){if(this.ssDiffusionD.length>=5)return d.a.Error("You already reached the maximum number of diffusion profiles."),0;for(var e=0;e<this._ssDiffusionS.length/3;e++)if(this._ssDiffusionS[e*3]===t.r&&this._ssDiffusionS[e*3+1]===t.g&&this._ssDiffusionS[e*3+2]===t.b)return e;return this._ssDiffusionS.push(t.r,t.b,t.g),this._ssDiffusionD.push(Math.max(Math.max(t.r,t.b),t.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(t)),this.ssDiffusionProfileColors.push(t),this._ssDiffusionD.length-1},n.prototype.createPostProcess=function(){return this.postProcess=new cv("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess},n.prototype.clearAllDiffusionProfiles=function(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]},n.prototype.dispose=function(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()},n.prototype.getDiffusionProfileParameters=function(t){var e=.997,i=Math.max(t.r,t.g,t.b);return this._sampleBurleyDiffusionProfile(e,i)},n.prototype._sampleBurleyDiffusionProfile=function(t,e){t=1-t;var i=1+4*t*(2*t+Math.sqrt(1+4*t*t)),r=Math.pow(i,-1/3),o=i*r*r,a=1+o+r,s=3*Math.log(a/(4*t));return s*e},n._SceneComponentInitialization=function(t){throw Re.a.WarnImport("PrePassRendererSceneComponent")},n}();T.a.AddParser(X.a.NAME_SUBSURFACE,function(n,t){if(n.ssDiffusionProfileColors!==void 0&&n.ssDiffusionProfileColors!==null&&(t.enableSubSurfaceForPrePass(),t.subSurfaceConfiguration))for(var e=0,i=n.ssDiffusionProfileColors.length;e<i;e++){var r=n.ssDiffusionProfileColors[e];t.subSurfaceConfiguration.addDiffusionProfile(new v.a(r.r,r.g,r.b))}}),Object.defineProperty(ae.a.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(n){n&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=n)},enumerable:!0,configurable:!0}),ae.a.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;var n=this.enablePrePassRenderer();return n?(this._subSurfaceConfiguration=new md(this),n.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null},ae.a.prototype.disableSubSurfaceForPrePass=function(){!this._subSurfaceConfiguration||(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};var gd=function(){function n(t){this.name=X.a.NAME_PREPASSRENDERER,this.scene=t}return n.prototype.register=function(){},n.prototype.serialize=function(t){if(!!this.scene.subSurfaceConfiguration){var e=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;t.ssDiffusionProfileColors=[];for(var i=0;i<e.length;i++)t.ssDiffusionProfileColors.push({r:e[i].r,g:e[i].g,b:e[i].b})}},n.prototype.addFromContainer=function(t){},n.prototype.removeFromContainer=function(t,e){!this.scene.prePassRenderer||this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n}();md._SceneComponentInitialization=function(n){var t=n._getComponent(X.a.NAME_SUBSURFACE);t||(t=new gd(n),n._addComponent(t))};var Gy=u(558),zy=u(701),vd="outlinePixelShader",_d=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform vec4 color;
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<logDepthDeclaration>
void main(void) {
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#include<logDepthFragment>
gl_FragColor=color;
}`;qe.a.ShadersStore[vd]=_d;var jy={name:vd,shader:_d},Wy=u(703),yd="outlineVertexShader",bd=`
attribute vec3 position;
attribute vec3 normal;
#include<bonesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]

uniform float offset;
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<logDepthDeclaration>
void main(void)
{
vec3 positionUpdated=position;
vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
vec3 offsetPosition=positionUpdated+(normalUpdated*offset);
#include<instancesVertex>
#include<bonesVertex>
gl_Position=viewProjection*finalWorld*vec4(offsetPosition,1.0);
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<logDepthVertex>
}
`;qe.a.ShadersStore[yd]=bd;var Hy={name:yd,shader:bd};ae.a.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new Ed(this)),this._outlineRenderer},Object.defineProperty(st.a.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(n){n&&this.getScene().getOutlineRenderer(),this._renderOutline=n},enumerable:!0,configurable:!0}),Object.defineProperty(st.a.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(n){n&&this.getScene().getOutlineRenderer(),this._renderOverlay=n},enumerable:!0,configurable:!0});var Ed=function(){function n(t){this.name=X.a.NAME_OUTLINERENDERER,this.zOffset=1,this.scene=t,this._engine=t.getEngine(),this.scene._addComponent(this)}return n.prototype.register=function(){this.scene._beforeRenderingMeshStage.registerStep(X.a.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(X.a.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n.prototype.render=function(t,e,i){var r=this;i===void 0&&(i=!1);var o=this.scene,a=o.getEngine(),s=a.getCaps().instancedArrays&&(e.visibleInstances[t._id]!==null&&e.visibleInstances[t._id]!==void 0||t.getRenderingMesh().hasThinInstances);if(!!this.isReady(t,s)){var c=t.getMesh(),_=c._internalAbstractMeshDataInfo._actAsRegularMesh?c:null,b=t.getRenderingMesh(),C=_||b,x=t.getMaterial();if(!(!x||!o.activeCamera)){if(a.enableEffect(this._effect),x.useLogarithmicDepth&&this._effect.setFloat("logarithmicDepthConstant",2/(Math.log(o.activeCamera.maxZ+1)/Math.LN2)),this._effect.setFloat("offset",i?0:b.outlineWidth),this._effect.setColor4("color",i?b.overlayColor:b.outlineColor,i?b.overlayAlpha:x.alpha),this._effect.setMatrix("viewProjection",o.getTransformMatrix()),this._effect.setMatrix("world",C.getWorldMatrix()),b.useBones&&b.computeBonesUsingShaders&&b.skeleton&&this._effect.setMatrices("mBones",b.skeleton.getTransformMatrices(b)),b.morphTargetManager&&b.morphTargetManager.isUsingTextureForTargets&&b.morphTargetManager._bind(this._effect),xt.a.BindMorphTargetParameters(b,this._effect),b._bind(t,this._effect,x.fillMode),x&&x.needAlphaTesting()){var V=x.getAlphaTestTexture();V&&(this._effect.setTexture("diffuseSampler",V),this._effect.setMatrix("diffuseMatrix",V.getTextureMatrix()))}a.setZOffset(-this.zOffset),b._processRendering(C,t,this._effect,x.fillMode,e,s,function(D,z){r._effect.setMatrix("world",z)}),a.setZOffset(0)}}},n.prototype.isReady=function(t,e){var i=[],r=[Be.b.PositionKind,Be.b.NormalKind],o=t.getMesh(),a=t.getMaterial();a&&(a.needAlphaTesting()&&(i.push("#define ALPHATEST"),o.isVerticesDataPresent(Be.b.UVKind)&&(r.push(Be.b.UVKind),i.push("#define UV1")),o.isVerticesDataPresent(Be.b.UV2Kind)&&(r.push(Be.b.UV2Kind),i.push("#define UV2"))),a.useLogarithmicDepth&&i.push("#define LOGARITHMICDEPTH")),o.useBones&&o.computeBonesUsingShaders?(r.push(Be.b.MatricesIndicesKind),r.push(Be.b.MatricesWeightsKind),o.numBoneInfluencers>4&&(r.push(Be.b.MatricesIndicesExtraKind),r.push(Be.b.MatricesWeightsExtraKind)),i.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers),i.push("#define BonesPerMesh "+(o.skeleton?o.skeleton.bones.length+1:0))):i.push("#define NUM_BONE_INFLUENCERS 0");var s=o.morphTargetManager,c=0;s&&s.numInfluencers>0&&(c=s.numInfluencers,i.push("#define MORPHTARGETS"),i.push("#define NUM_MORPH_INFLUENCERS "+c),s.isUsingTextureForTargets&&i.push("#define MORPHTARGETS_TEXTURE"),xt.a.PrepareAttributesForMorphTargetsInfluencers(r,o,c)),e&&(i.push("#define INSTANCES"),xt.a.PushAttributesForInstances(r),t.getRenderingMesh().hasThinInstances&&i.push("#define THIN_INSTANCES"));var _=i.join(`
`);return this._cachedDefines!==_&&(this._cachedDefines=_,this._effect=this.scene.getEngine().createEffect("outline",r,["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],["diffuseSampler","morphTargets"],_,void 0,void 0,void 0,{maxSimultaneousMorphTargets:c})),this._effect.isReady()},n.prototype._beforeRenderingMesh=function(t,e,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),t.renderOutline){var r=e.getMaterial();r&&r.needAlphaBlendingForMesh(t)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(n._StencilReference),this._engine.setStencilFunctionReference(n._StencilReference),this.render(e,i,!0),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(e,i),this._engine.setDepthWrite(this._savedDepthWrite),r&&r.needAlphaBlendingForMesh(t)&&this._engine.restoreStencilState()}},n.prototype._afterRenderingMesh=function(t,e,i){if(t.renderOverlay){var r=this._engine.getAlphaMode(),o=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(e,i,!0),this._engine.setAlphaMode(r),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=o}t.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(e,i),this._engine.setColorWrite(!0))},n._StencilReference=4,n}(),fv=u(720),Pd=u(591),hv=function(){function n(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}return Object.defineProperty(n.prototype,"animationStarted",{get:function(){return this._animationStarted},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fromIndex",{get:function(){return this._fromIndex},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"toIndex",{get:function(){return this._toIndex},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"loopAnimation",{get:function(){return this._loopAnimation},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"delay",{get:function(){return Math.max(this._delay,1)},enumerable:!1,configurable:!0}),n.prototype.playAnimation=function(t,e,i,r,o){this._fromIndex=t,this._toIndex=e,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=o,t<e?this._direction=1:(this._direction=-1,this._toIndex=t,this._fromIndex=e),this.cellIndex=t,this._time=0},n.prototype.stopAnimation=function(){this._animationStarted=!1},n.prototype._animate=function(t){!this._animationStarted||(this._time+=t,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))},n}(),Cd=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this)||this;return r.name=e,r.animations=new Array,r.isPickable=!1,r.useAlphaForPicking=!1,r.onDisposeObservable=new g.c,r._onAnimationEnd=null,r._endAnimation=function(){r._onAnimationEnd&&r._onAnimationEnd(),r.disposeWhenFinishedAnimating&&r.dispose()},r.color=new v.b(1,1,1,1),r.position=l.e.Zero(),r._manager=i,r._manager.sprites.push(r),r.uniqueId=r._manager.scene.getUniqueId(),r}return Object.defineProperty(t.prototype,"size",{get:function(){return this.width},set:function(e){this.width=e,this.height=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"manager",{get:function(){return this._manager},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"Sprite"},Object.defineProperty(t.prototype,"fromIndex",{get:function(){return this._fromIndex},set:function(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"toIndex",{get:function(){return this._toIndex},set:function(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loopAnimation",{get:function(){return this._loopAnimation},set:function(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"delay",{get:function(){return Math.max(this._delay,1)},set:function(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)},enumerable:!1,configurable:!0}),t.prototype.playAnimation=function(e,i,r,o,a){a===void 0&&(a=null),this._onAnimationEnd=a,n.prototype.playAnimation.call(this,e,i,r,o,this._endAnimation)},t.prototype.dispose=function(){for(var e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},t.prototype.serialize=function(){var e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e},t.Parse=function(e,i){var r=new t(e.name,i);return r.position=l.e.FromArray(e.position),r.color=v.b.FromArray(e.color),r.width=e.width,r.height=e.height,r.angle=e.angle,r.cellIndex=e.cellIndex,r.cellRef=e.cellRef,r.invertU=e.invertU,r.invertV=e.invertV,r.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,r.isPickable=e.isPickable,r.isVisible=e.isVisible,r.useAlphaForPicking=e.useAlphaForPicking,r.fromIndex=e.fromIndex,r.toIndex=e.toIndex,r.loopAnimation=e.loopAnimation,r.delay=e.delay,e.animationStarted&&r.playAnimation(r.fromIndex,r.toIndex,r.loopAnimation,r.delay),r},t}(hv);ae.a.prototype._internalPickSprites=function(n,t,e,i){if(!vt.a)return null;var r=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers.length>0)for(var o=0;o<this.spriteManagers.length;o++){var a=this.spriteManagers[o];if(!!a.isPickable){var s=a.intersects(n,i,t,e);if(!(!s||!s.hit)&&!(!e&&r!=null&&s.distance>=r.distance)&&(r=s,e))break}}return r||new vt.a},ae.a.prototype._internalMultiPickSprites=function(n,t,e){if(!vt.a)return null;var i=new Array;if(!e){if(!this.activeCamera)return null;e=this.activeCamera}if(this.spriteManagers.length>0)for(var r=0;r<this.spriteManagers.length;r++){var o=this.spriteManagers[r];if(!!o.isPickable){var a=o.multiIntersects(n,e,t);a!==null&&(i=i.concat(a))}}return i},ae.a.prototype.pickSprite=function(n,t,e,i,r){return this._tempSpritePickingRay?(this.createPickingRayInCameraSpaceToRef(n,t,this._tempSpritePickingRay,r),this._internalPickSprites(this._tempSpritePickingRay,e,i,r)):null},ae.a.prototype.pickSpriteWithRay=function(n,t,e,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}return Jt.a.TransformToRef(n,i.getViewMatrix(),this._tempSpritePickingRay),this._internalPickSprites(this._tempSpritePickingRay,t,e,i)},ae.a.prototype.multiPickSprite=function(n,t,e,i){return this.createPickingRayInCameraSpaceToRef(n,t,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,e,i)},ae.a.prototype.multiPickSpriteWithRay=function(n,t,e){if(!this._tempSpritePickingRay)return null;if(!e){if(!this.activeCamera)return null;e=this.activeCamera}return Jt.a.TransformToRef(n,e.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,t,e)},ae.a.prototype.setPointerOverSprite=function(n){this._pointerOverSprite!==n&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,O.a.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=n,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,O.a.CreateNewFromSprite(this._pointerOverSprite,this)))},ae.a.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};var Sd=function(){function n(t){this.name=X.a.NAME_SPRITE,this.scene=t,this.scene.spriteManagers=new Array,this.scene._tempSpritePickingRay=Jt.a?Jt.a.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new g.c,this.scene.onAfterSpritesRenderingObservable=new g.c,this._spritePredicate=function(e){return e.actionManager?e.isPickable&&e.actionManager.hasPointerTriggers:!1}}return n.prototype.register=function(){this.scene._pointerMoveStage.registerStep(X.a.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(X.a.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(X.a.STEP_POINTERUP_SPRITE,this,this._pointerUp)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();for(var t=this.scene.spriteManagers;t.length;)t[0].dispose()},n.prototype._pickSpriteButKeepRay=function(t,e,i,r,o){var a=this.scene.pickSprite(e,i,this._spritePredicate,r,o);return a&&(a.ray=t?t.ray:null),a},n.prototype._pointerMove=function(t,e,i,r,o){var a=this.scene;return r?a.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,t,e,!1,a.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite?(a.setPointerOverSprite(i.pickedSprite),a.doNotHandleCursors||(a._pointerOverSprite&&a._pointerOverSprite.actionManager&&a._pointerOverSprite.actionManager.hoverCursor?o.style.cursor=a._pointerOverSprite.actionManager.hoverCursor:o.style.cursor=a.hoverCursor)):a.setPointerOverSprite(null)),i},n.prototype._pointerDown=function(t,e,i,r){var o=this.scene;if(o._pickedDownSprite=null,o.spriteManagers.length>0&&(i=o.pickSprite(t,e,this._spritePredicate,!1,o.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager)){switch(o._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,O.a.CreateNewFromSprite(i.pickedSprite,o,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,O.a.CreateNewFromSprite(i.pickedSprite,o,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,O.a.CreateNewFromSprite(i.pickedSprite,o,r));break}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,O.a.CreateNewFromSprite(i.pickedSprite,o,r))}return i},n.prototype._pointerUp=function(t,e,i,r){var o=this.scene;if(o.spriteManagers.length>0){var a=o.pickSprite(t,e,this._spritePredicate,!1,o.cameraToUseForPointers||void 0);a&&(a.hit&&a.pickedSprite&&a.pickedSprite.actionManager&&(a.pickedSprite.actionManager.processTrigger(7,O.a.CreateNewFromSprite(a.pickedSprite,o,r)),a.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||a.pickedSprite.actionManager.processTrigger(1,O.a.CreateNewFromSprite(a.pickedSprite,o,r)))),o._pickedDownSprite&&o._pickedDownSprite.actionManager&&o._pickedDownSprite!==a.pickedSprite&&o._pickedDownSprite.actionManager.processTrigger(16,O.a.CreateNewFromSprite(o._pickedDownSprite,o,r)))}return i},n}(),Td="imageProcessingCompatibility",Ad=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif`;qe.a.IncludesShadersStore[Td]=Ad;var ky={name:Td,shader:Ad},Rd="spritesPixelShader",Od=`uniform bool alphaTest;
varying vec4 vColor;

varying vec2 vUV;
uniform sampler2D diffuseSampler;

#include<fogFragmentDeclaration>
void main(void) {
vec4 color=texture2D(diffuseSampler,vUV);
if (alphaTest)
{
if (color.a<0.95)
discard;
}
color*=vColor;
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
}`;qe.a.ShadersStore[Rd]=Od;var Xy={name:Rd,shader:Od},Md="spritesVertexShader",xd=`
attribute vec4 position;
attribute vec2 options;
attribute vec2 offsets;
attribute vec2 inverts;
attribute vec4 cellInfo;
attribute vec4 color;

uniform mat4 view;
uniform mat4 projection;

varying vec2 vUV;
varying vec4 vColor;
#include<fogVertexDeclaration>
void main(void) {
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz;
vec2 cornerPos;
float angle=position.w;
vec2 size=vec2(options.x,options.y);
vec2 offset=offsets.xy;
cornerPos=vec2(offset.x-0.5,offset.y-0.5)*size;

vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;

viewPos+=rotatedCorner;
gl_Position=projection*vec4(viewPos,1.0);

vColor=color;

vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));
vec2 uvPlace=cellInfo.xy;
vec2 uvSize=cellInfo.zw;
vUV.x=uvPlace.x+uvSize.x*uvOffset.x;
vUV.y=uvPlace.y+uvSize.y*uvOffset.y;

#ifdef FOG
vFogDistance=viewPos;
#endif
}`;qe.a.ShadersStore[Md]=xd;var Yy={name:Md,shader:xd},dv=function(){function n(t,e,i,r){if(i===void 0&&(i=.01),r===void 0&&(r=null),this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this.fogEnabled=!0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._capacity=e,this._epsilon=i,this._engine=t,this._useInstancing=t.getCaps().instancedArrays,this._useVAO=t.getCaps().vertexArrayObject&&!t.disableVertexArrayObjects,this._scene=r,!this._useInstancing){for(var o=[],a=0,s=0;s<e;s++)o.push(a),o.push(a+1),o.push(a+2),o.push(a),o.push(a+2),o.push(a+3),a+=4;this._indexBuffer=t.createIndexBuffer(o)}this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(e*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new Be.a(t,this._vertexData,!0,this._vertexBufferSize);var c=this._buffer.createVertexBuffer(Be.b.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),_=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing),b=6,C;if(this._useInstancing){var x=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Be.a(t,x,!1,2),C=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else C=this._buffer.createVertexBuffer("offsets",b,2,this._vertexBufferSize,this._useInstancing),b+=2;var V=this._buffer.createVertexBuffer("inverts",b,2,this._vertexBufferSize,this._useInstancing),D=this._buffer.createVertexBuffer("cellInfo",b+2,4,this._vertexBufferSize,this._useInstancing),z=this._buffer.createVertexBuffer(Be.b.ColorKind,b+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Be.b.PositionKind]=c,this._vertexBuffers.options=_,this._vertexBuffers.offsets=C,this._vertexBuffers.inverts=V,this._vertexBuffers.cellInfo=D,this._vertexBuffers[Be.b.ColorKind]=z,this._effectBase=this._engine.createEffect("sprites",[Be.b.PositionKind,"options","offsets","inverts","cellInfo",Be.b.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],""),this._scene&&(this._effectFog=this._scene.getEngine().createEffect("sprites",[Be.b.PositionKind,"options","offsets","inverts","cellInfo",Be.b.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG"))}return Object.defineProperty(n.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),n.prototype.render=function(t,e,i,r,o){if(o===void 0&&(o=null),!(!this.texture||!this.texture.isReady()||!t.length)){var a=this._effectBase,s=!1;if(this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&(a=this._effectFog,s=!0),!!a.isReady()){for(var c=this._engine,_=!!(this._scene&&this._scene.useRightHandedSystem),b=this.texture.getBaseSize(),C=Math.min(this._capacity,t.length),x=0,V=!0,D=0;D<C;D++){var z=t[D];!z||!z.isVisible||(V=!1,z._animate(e),this._appendSpriteVertex(x++,z,0,0,b,_,o),this._useInstancing||(this._appendSpriteVertex(x++,z,1,0,b,_,o),this._appendSpriteVertex(x++,z,1,1,b,_,o),this._appendSpriteVertex(x++,z,0,1,b,_,o)))}if(!V){this._buffer.update(this._vertexData);var q=c.depthCullingState.cull||!0,ue=c.depthCullingState.zOffset;if(_&&this._scene.getEngine().setState(q,ue,!1,!1),c.enableEffect(a),a.setTexture("diffuseSampler",this.texture),a.setMatrix("view",i),a.setMatrix("projection",r),s){var ge=this._scene;a.setFloat4("vFogInfos",ge.fogMode,ge.fogStart,ge.fogEnd,ge.fogDensity),a.setColor3("vFogColor",ge.fogColor)}this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=c.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,a)),c.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):c.bindBuffers(this._vertexBuffers,this._indexBuffer,a),c.depthCullingState.depthFunc=515,this.disableDepthWrite||(a.setBool("alphaTest",!0),c.setColorWrite(!1),this._useInstancing?c.drawArraysType(7,0,4,x):c.drawElementsType(0,0,x/4*6),c.setColorWrite(!0),a.setBool("alphaTest",!1)),c.setAlphaMode(this.blendMode),this._useInstancing?c.drawArraysType(7,0,4,x):c.drawElementsType(0,0,x/4*6),this.autoResetAlpha&&c.setAlphaMode(0),_&&this._scene.getEngine().setState(q,ue,!1,!0),c.unbindInstanceAttributes()}}}},n.prototype._appendSpriteVertex=function(t,e,i,r,o,a,s){var c=t*this._vertexBufferSize;if(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),s)s(e,o);else{e.cellIndex||(e.cellIndex=0);var _=o.width/this.cellWidth,b=e.cellIndex/_>>0;e._xOffset=(e.cellIndex-b*_)*this.cellWidth/o.width,e._yOffset=b*this.cellHeight/o.height,e._xSize=this.cellWidth,e._ySize=this.cellHeight}this._vertexData[c]=e.position.x,this._vertexData[c+1]=e.position.y,this._vertexData[c+2]=e.position.z,this._vertexData[c+3]=e.angle,this._vertexData[c+4]=e.width,this._vertexData[c+5]=e.height,this._useInstancing?c-=2:(this._vertexData[c+6]=i,this._vertexData[c+7]=r),a?this._vertexData[c+8]=e.invertU?0:1:this._vertexData[c+8]=e.invertU?1:0,this._vertexData[c+9]=e.invertV?1:0,this._vertexData[c+10]=e._xOffset,this._vertexData[c+11]=e._yOffset,this._vertexData[c+12]=e._xSize/o.width,this._vertexData[c+13]=e._ySize/o.height,this._vertexData[c+14]=e.color.r,this._vertexData[c+15]=e.color.g,this._vertexData[c+16]=e.color.b,this._vertexData[c+17]=e.color.a},n.prototype.dispose=function(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null)},n}(),Dd=function(){function n(t,e,i,r,o,a,s,c,_){var b=this;a===void 0&&(a=.01),s===void 0&&(s=Ze.a.TRILINEAR_SAMPLINGMODE),c===void 0&&(c=!1),_===void 0&&(_=null),this.name=t,this.sprites=new Array,this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.onDisposeObservable=new g.c,this.disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=function(x,V){x.cellRef||(x.cellIndex=0);var D=x.cellIndex;typeof D=="number"&&isFinite(D)&&Math.floor(D)===D&&(x.cellRef=b._spriteMap[x.cellIndex]),x._xOffset=b._cellData[x.cellRef].frame.x/V.width,x._yOffset=b._cellData[x.cellRef].frame.y/V.height,x._xSize=b._cellData[x.cellRef].frame.w,x._ySize=b._cellData[x.cellRef].frame.h},o||(o=G.a.LastCreatedScene),o._getComponent(X.a.NAME_SPRITE)||o._addComponent(new Sd(o)),this._fromPacked=c,this._scene=o;var C=this._scene.getEngine();if(this._spriteRenderer=new dv(C,i,a,o),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else if(r!==void 0)this.cellWidth=r,this.cellHeight=r;else{this._spriteRenderer=null;return}this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),e&&(this.texture=new Ze.a(e,o,!0,!1,s)),this._fromPacked&&this._makePacked(e,_)}return Object.defineProperty(n.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"children",{get:function(){return this.sprites},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"capacity",{get:function(){return this._spriteRenderer.capacity},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"texture",{get:function(){return this._spriteRenderer.texture},set:function(t){t.wrapU=Ze.a.CLAMP_ADDRESSMODE,t.wrapV=Ze.a.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=t,this._textureContent=null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cellWidth",{get:function(){return this._spriteRenderer.cellWidth},set:function(t){this._spriteRenderer.cellWidth=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cellHeight",{get:function(){return this._spriteRenderer.cellHeight},set:function(t){this._spriteRenderer.cellHeight=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fogEnabled",{get:function(){return this._spriteRenderer.fogEnabled},set:function(t){this._spriteRenderer.fogEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"blendMode",{get:function(){return this._spriteRenderer.blendMode},set:function(t){this._spriteRenderer.blendMode=t},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"SpriteManager"},n.prototype._makePacked=function(t,e){var i=this;if(e!==null)try{var r=void 0;if(typeof e=="string"?r=JSON.parse(e):r=e,r.frames.length){for(var o={},a=0;a<r.frames.length;a++){var s=r.frames[a];if(typeof Object.keys(s)[0]!="string")throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");var c=s[Object.keys(s)[0]];o[c]=s}r.frames=o}var _=Reflect.ownKeys(r.frames);this._spriteMap=_,this._packedAndReady=!0,this._cellData=r.frames}catch(D){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{var b=/\./g,C=void 0;do C=b.lastIndex,b.test(t);while(b.lastIndex>0);var x=t.substring(0,C-1)+".json",V=new XMLHttpRequest;V.open("GET",x,!0),V.onerror=function(){d.a.Error("JSON ERROR: Unable to load JSON file."),i._fromPacked=!1,i._packedAndReady=!1},V.onload=function(){try{var D=JSON.parse(V.response),z=Reflect.ownKeys(D.frames);i._spriteMap=z,i._packedAndReady=!0,i._cellData=D.frames}catch(q){throw i._fromPacked=!1,i._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}},V.send()}},n.prototype._checkTextureAlpha=function(t,e,i,r,o){if(!t.useAlphaForPicking||!this.texture)return!0;var a=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(a.width*a.height*4),this.texture.readPixels(0,0,this._textureContent));var s=l.c.Vector3[0];s.copyFrom(e.direction),s.normalize(),s.scaleInPlace(i),s.addInPlace(e.origin);var c=(s.x-r.x)/(o.x-r.x)-.5,_=1-(s.y-r.y)/(o.y-r.y)-.5,b=t.angle,C=.5+(c*Math.cos(b)-_*Math.sin(b)),x=.5+(c*Math.sin(b)+_*Math.cos(b)),V=t._xOffset*a.width+C*t._xSize|0,D=t._yOffset*a.height+x*t._ySize|0,z=this._textureContent[(V+D*a.width)*4+3];return z>.5},n.prototype.intersects=function(t,e,i,r){for(var o=Math.min(this.capacity,this.sprites.length),a=l.e.Zero(),s=l.e.Zero(),c=Number.MAX_VALUE,_=null,b=l.c.Vector3[0],C=l.c.Vector3[1],x=e.getViewMatrix(),V=0;V<o;V++){var D=this.sprites[V];if(!!D){if(i){if(!i(D))continue}else if(!D.isPickable)continue;if(l.e.TransformCoordinatesToRef(D.position,x,C),a.copyFromFloats(C.x-D.width/2,C.y-D.height/2,C.z),s.copyFromFloats(C.x+D.width/2,C.y+D.height/2,C.z),t.intersectsBoxMinMax(a,s)){var z=l.e.Distance(C,t.origin);if(c>z){if(!this._checkTextureAlpha(D,t,z,a,s))continue;if(c=z,_=D,r)break}}}}if(_){var q=new vt.a;x.invertToRef(l.c.Matrix[0]),q.hit=!0,q.pickedSprite=_,q.distance=c;var ue=l.c.Vector3[2];return ue.copyFrom(t.direction),ue.normalize(),ue.scaleInPlace(c),t.origin.addToRef(ue,b),q.pickedPoint=l.e.TransformCoordinates(b,l.c.Matrix[0]),q}return null},n.prototype.multiIntersects=function(t,e,i){for(var r=Math.min(this.capacity,this.sprites.length),o=l.e.Zero(),a=l.e.Zero(),s,c=[],_=l.c.Vector3[0].copyFromFloats(0,0,0),b=l.c.Vector3[1].copyFromFloats(0,0,0),C=e.getViewMatrix(),x=0;x<r;x++){var V=this.sprites[x];if(!!V){if(i){if(!i(V))continue}else if(!V.isPickable)continue;if(l.e.TransformCoordinatesToRef(V.position,C,b),o.copyFromFloats(b.x-V.width/2,b.y-V.height/2,b.z),a.copyFromFloats(b.x+V.width/2,b.y+V.height/2,b.z),t.intersectsBoxMinMax(o,a)){if(s=l.e.Distance(b,t.origin),!this._checkTextureAlpha(V,t,s,o,a))continue;var D=new vt.a;c.push(D),C.invertToRef(l.c.Matrix[0]),D.hit=!0,D.pickedSprite=V,D.distance=s;var z=l.c.Vector3[2];z.copyFrom(t.direction),z.normalize(),z.scaleInPlace(s),t.origin.addToRef(z,_),D.pickedPoint=l.e.TransformCoordinates(_,l.c.Matrix[0])}}}return c},n.prototype.render=function(){if(!(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))){var t=this._scene.getEngine(),e=t.getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}},n.prototype.dispose=function(){this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null;var t=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},n.prototype.serialize=function(t){t===void 0&&(t=!1);var e={};e.name=this.name,e.capacity=this.capacity,e.cellWidth=this.cellWidth,e.cellHeight=this.cellHeight,this.texture&&(t?e.texture=this.texture.serialize():(e.textureUrl=this.texture.name,e.invertY=this.texture._invertY)),e.sprites=[];for(var i=0,r=this.sprites;i<r.length;i++){var o=r[i];e.sprites.push(o.serialize())}return e},n.Parse=function(t,e,i){var r=new n(t.name,"",t.capacity,{width:t.cellWidth,height:t.cellHeight},e);t.texture?r.texture=Ze.a.Parse(t.texture,e,i):t.textureName&&(r.texture=new Ze.a(i+t.textureUrl,e,!1,t.invertY!==void 0?t.invertY:!0));for(var o=0,a=t.sprites;o<a.length;o++){var s=a[o];Cd.Parse(s,r)}return r},n.ParseFromFileAsync=function(t,e,i,r){return r===void 0&&(r=""),new Promise(function(o,a){var s=new Rr.a;s.addEventListener("readystatechange",function(){if(s.readyState==4)if(s.status==200){var c=JSON.parse(s.responseText),_=n.Parse(c,i||G.a.LastCreatedScene,r);t&&(_.name=t),o(_)}else a("Unable to load the sprite manager")}),s.open("GET",e),s.send()})},n.CreateFromSnippetAsync=function(t,e,i){var r=this;return i===void 0&&(i=""),t==="_BLANK"?Promise.resolve(new n("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,e)):new Promise(function(o,a){var s=new Rr.a;s.addEventListener("readystatechange",function(){if(s.readyState==4)if(s.status==200){var c=JSON.parse(JSON.parse(s.responseText).jsonPayload),_=JSON.parse(c.spriteManager),b=n.Parse(_,e||G.a.LastCreatedScene,i);b.snippetId=t,o(b)}else a("Unable to load the snippet "+t)}),s.open("GET",r.SnippetUrl+"/"+t.replace(/#/g,"/")),s.send()})},n.SnippetUrl="https://snippet.babylonjs.com",n}(),Id="spriteMapPixelShader",Ld=`precision highp float;
varying vec3 vPosition;
varying vec2 vUV;
varying vec2 tUV;
uniform float time;
uniform float spriteCount;
uniform sampler2D spriteSheet;
uniform vec2 spriteMapSize;
uniform vec2 outputSize;
uniform vec2 stageSize;
uniform sampler2D frameMap;
uniform sampler2D tileMaps[LAYERS];
uniform sampler2D animationMap;
uniform vec3 colorMul;
float mt;
const float fdStep=1./4.;
const float aFrameSteps=1./MAX_ANIMATION_FRAMES;
mat4 getFrameData(float frameID){
float fX=frameID/spriteCount;
return mat4(
texture2D(frameMap,vec2(fX,0.),0.),
texture2D(frameMap,vec2(fX,fdStep*1.),0.),
texture2D(frameMap,vec2(fX,fdStep*2.),0.),
vec4(0.)
);
}
void main(){
vec4 color=vec4(0.);
vec2 tileUV=fract(tUV);
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
vec2 tileID=floor(tUV);
vec2 sheetUnits=1./spriteMapSize;
float spriteUnits=1./spriteCount;
vec2 stageUnits=1./stageSize;
for(int i=0; i<LAYERS; i++) {
float frameID;
#define LAYER_ID_SWITCH
vec4 animationData=texture2D(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);
if(animationData.y>0.) {
mt=mod(time*animationData.z,1.0);
for(float f=0.; f<MAX_ANIMATION_FRAMES; f++){
if(animationData.y>mt){
frameID=animationData.x;
break;
}
animationData=texture2D(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);
}
}

mat4 frameData=getFrameData(frameID+0.5);
vec2 frameSize=(frameData[0].wz)/spriteMapSize;
vec2 offset=frameData[0].xy*sheetUnits;
vec2 ratio=frameData[2].xy/frameData[0].wz;

if (frameData[2].z == 1.){
tileUV.xy=tileUV.yx;
}
if (i == 0){
color=texture2D(spriteSheet,tileUV*frameSize+offset);
} else {
vec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);
float alpha=min(color.a+nc.a,1.0);
vec3 mixed=mix(color.xyz,nc.xyz,nc.a);
color=vec4(mixed,alpha);
}
}
color.xyz*=colorMul;
gl_FragColor=color;
}`;qe.a.ShadersStore[Id]=Ld;var Ky={name:Id,shader:Ld},Fd="spriteMapVertexShader",Bd=`precision highp float;

attribute vec3 position;
attribute vec3 normal;
attribute vec2 uv;

varying vec3 vPosition;
varying vec2 vUV;
varying vec2 tUV;
varying vec2 stageUnits;
varying vec2 levelUnits;
varying vec2 tileID;

uniform float time;
uniform mat4 worldViewProjection;
uniform vec2 outputSize;
uniform vec2 stageSize;
uniform vec2 spriteMapSize;
uniform float stageScale;
void main() {
vec4 p=vec4( position,1. );
vPosition=p.xyz;
vUV=uv;
tUV=uv*stageSize;
gl_Position=worldViewProjection*p;
}`;qe.a.ShadersStore[Fd]=Bd;var Qy={name:Fd,shader:Bd},pv=function(){function n(t,e,i,r,o){var a=this;this.name=t,this.sprites=[],this.atlasJSON=e,this.sprites=this.atlasJSON.frames,this.spriteSheet=i,this.options=r,r.stageSize=r.stageSize||new l.d(1,1),r.outputSize=r.outputSize||r.stageSize,r.outputPosition=r.outputPosition||l.e.Zero(),r.outputRotation=r.outputRotation||l.e.Zero(),r.layerCount=r.layerCount||1,r.maxAnimationFrames=r.maxAnimationFrames||0,r.baseTile=r.baseTile||0,r.flipU=r.flipU||!1,r.colorMultiply=r.colorMultiply||new l.e(1,1,1),this._scene=o,this._frameMap=this._createFrameBuffer(),this._tileMaps=new Array;for(var s=0;s<r.layerCount;s++)this._tileMaps.push(this._createTileBuffer(null,s));this._animationMap=this._createTileAnimationBuffer(null);var c=[];c.push("#define LAYERS "+r.layerCount),r.flipU&&c.push("#define FLIPU"),c.push("#define MAX_ANIMATION_FRAMES "+r.maxAnimationFrames+".0");var _=qe.a.ShadersStore.spriteMapPixelShader,b;if(o.getEngine()._features.supportSwitchCaseInShader){b="switch(i) {";for(var s=0;s<r.layerCount;s++)b+="case "+s+" : frameID = texture(tileMaps["+s+"], (tileID + 0.5) / stageSize, 0.).x;",b+="break;";b+="}"}else{b="";for(var s=0;s<r.layerCount;s++)b+="if ("+s+" == i) { frameID = texture2D(tileMaps["+s+"], (tileID + 0.5) / stageSize, 0.).x; }"}qe.a.ShadersStore["spriteMap"+this.name+"PixelShader"]=_.replace("#define LAYER_ID_SWITCH",b),this._material=new Tn.a("spriteMap:"+this.name,this._scene,{vertex:"spriteMap",fragment:"spriteMap"+this.name},{defines:c,attributes:["position","normal","uv"],uniforms:["worldViewProjection","time","stageSize","outputSize","spriteMapSize","spriteCount","time","colorMul","mousePosition","curTile","flipU"],samplers:["spriteSheet","frameMap","tileMaps","animationMap"],needAlphaBlending:!0}),this._time=0,this._material.setFloat("spriteCount",this.spriteCount),this._material.setVector2("stageSize",r.stageSize),this._material.setVector2("outputSize",r.outputSize),this._material.setTexture("spriteSheet",this.spriteSheet),this._material.setVector2("spriteMapSize",new l.d(1,1)),this._material.setVector3("colorMul",r.colorMultiply);var C=0,x=function(){if(a.spriteSheet&&a.spriteSheet.isReady()&&a.spriteSheet._texture){a._material.setVector2("spriteMapSize",new l.d(a.spriteSheet._texture.baseWidth||1,a.spriteSheet._texture.baseHeight||1));return}C<100&&setTimeout(function(){C++,x()},100)};x(),this._material.setVector3("colorMul",r.colorMultiply),this._material.setTexture("frameMap",this._frameMap),this._material.setTextureArray("tileMaps",this._tileMaps),this._material.setTexture("animationMap",this._animationMap),this._material.setFloat("time",this._time),this._output=st.a.CreatePlane(t+":output",1,o,!0),this._output.scaling.x=r.outputSize.x,this._output.scaling.y=r.outputSize.y,this.position=r.outputPosition,this.rotation=r.outputRotation;var V=function(){a._time+=a._scene.getEngine().getDeltaTime(),a._material.setFloat("time",a._time)};this._scene.onBeforeRenderObservable.add(V),this._output.material=this._material}return Object.defineProperty(n.prototype,"spriteCount",{get:function(){return this.sprites.length},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"position",{get:function(){return this._output.position},set:function(t){this._output.position=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rotation",{get:function(){return this._output.rotation},set:function(t){this._output.rotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"animationMap",{get:function(){return this._animationMap},set:function(t){var e=t._texture._bufferView,i=this._createTileAnimationBuffer(e);this._animationMap.dispose(),this._animationMap=i,this._material.setTexture("animationMap",this._animationMap)},enumerable:!1,configurable:!0}),n.prototype.getTileID=function(){var t=this.getMousePosition();return t.multiplyInPlace(this.options.stageSize||l.d.Zero()),t.x=Math.floor(t.x),t.y=Math.floor(t.y),t},n.prototype.getMousePosition=function(){var t=this._output,e=this._scene.pick(this._scene.pointerX,this._scene.pointerY,function(r){return r===t});if(!e||!e.hit||!e.getTextureCoordinates)return new l.d(-1,-1);var i=e.getTextureCoordinates();return i||new l.d(-1,-1)},n.prototype._createFrameBuffer=function(){for(var t=new Array,e=0;e<this.spriteCount;e++)t.push(0,0,0,0),t.push(0,0,0,0),t.push(0,0,0,0),t.push(0,0,0,0);for(var e=0;e<this.spriteCount;e++){var i=this.sprites[e].frame,r=this.sprites[e].spriteSourceSize,o=this.sprites[e].sourceSize,a=this.sprites[e].rotated?1:0,s=this.sprites[e].trimmed?1:0;t[e*4]=i.x,t[e*4+1]=i.y,t[e*4+2]=i.w,t[e*4+3]=i.h,t[e*4+this.spriteCount*4]=r.x,t[e*4+1+this.spriteCount*4]=r.y,t[e*4+3+this.spriteCount*4]=r.h,t[e*4+this.spriteCount*8]=o.w,t[e*4+1+this.spriteCount*8]=o.h,t[e*4+2+this.spriteCount*8]=a,t[e*4+3+this.spriteCount*8]=s}var c=new Float32Array(t),_=kr.a.CreateRGBATexture(c,this.spriteCount,4,this._scene,!1,!1,Ze.a.NEAREST_NEAREST,G.a.TEXTURETYPE_FLOAT);return _},n.prototype._createTileBuffer=function(t,e){e===void 0&&(e=0);var i=new Array,r=this.options.stageSize.y||0,o=this.options.stageSize.x||0;if(t)i=t;else{var a=this.options.baseTile;e!=0&&(a=0);for(var s=0;s<r;s++)for(var c=0;c<o*4;c+=4)i.push(a,0,0,0)}var _=new Float32Array(i),b=kr.a.CreateRGBATexture(_,o,r,this._scene,!1,!1,Ze.a.NEAREST_NEAREST,G.a.TEXTURETYPE_FLOAT);return b},n.prototype.changeTiles=function(t,e,i){t===void 0&&(t=0),i===void 0&&(i=0);var r;if(r=this._tileMaps[t]._texture._bufferView,r!==null){var o=new Array;e instanceof l.d?o.push(e):o=e;for(var a=this.options.stageSize.x||0,s=0;s<o.length;s++){var c=o[s];c.x=Math.floor(c.x),c.y=Math.floor(c.y);var _=c.x*4+c.y*(a*4);r[_]=i}var b=this._createTileBuffer(r);this._tileMaps[t].dispose(),this._tileMaps[t]=b,this._material.setTextureArray("tileMap",this._tileMaps)}},n.prototype._createTileAnimationBuffer=function(t){var e=new Array,i;if(t)i=t;else{for(var r=0;r<this.spriteCount;r++){e.push(0,0,0,0);for(var o=1;o<(this.options.maxAnimationFrames||4);)e.push(0,0,0,0),o++}i=new Float32Array(e)}var a=kr.a.CreateRGBATexture(i,this.spriteCount,this.options.maxAnimationFrames||4,this._scene,!1,!1,Ze.a.NEAREST_NEAREST,G.a.TEXTURETYPE_FLOAT);return a},n.prototype.addAnimationToTile=function(t,e,i,r,o){t===void 0&&(t=0),e===void 0&&(e=0),i===void 0&&(i=0),r===void 0&&(r=0),o===void 0&&(o=1);var a=this._animationMap._texture._bufferView,s=t*4+this.spriteCount*4*e;if(!!a){a[s]=i,a[s+1]=r,a[s+2]=o;var c=this._createTileAnimationBuffer(a);this._animationMap.dispose(),this._animationMap=c,this._material.setTexture("animationMap",this._animationMap)}},n.prototype.saveTileMaps=function(){for(var t="",e=0;e<this._tileMaps.length;e++)e>0&&(t+=`
\r`),t+=this._tileMaps[e]._texture._bufferView.toString();var i=document.createElement("a");i.href="data:octet/stream;charset=utf-8,"+encodeURI(t),i.target="_blank",i.download=this.name+".tilemaps",i.click(),i.remove()},n.prototype.loadTileMaps=function(t){var e=this,i=new XMLHttpRequest;i.open("GET",t);var r=this.options.layerCount||0;i.onload=function(){for(var o=i.response.split(`
\r`),a=0;a<r;a++){var s=o[a].split(",").map(Number),c=e._createTileBuffer(s);e._tileMaps[a].dispose(),e._tileMaps[a]=c}e._material.setTextureArray("tileMap",e._tileMaps)},i.send()},n.prototype.dispose=function(){this._output.dispose(),this._material.dispose(),this._animationMap.dispose(),this._tileMaps.forEach(function(t){t.dispose()}),this._frameMap.dispose()},n}(),mv=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){a===void 0&&(a=null),s===void 0&&(s=.01),c===void 0&&(c=Ze.a.TRILINEAR_SAMPLINGMODE);var _=n.call(this,e,i,r,64,o,s,c,!0,a)||this;return _.name=e,_}return t}(Dd),gv=u(713),vv=u(711),Or;(function(n){n[n.INIT=0]="INIT",n[n.RUNNING=1]="RUNNING",n[n.DONE=2]="DONE",n[n.ERROR=3]="ERROR"})(Or||(Or={}));var Mr=function(){function n(t){this.name=t,this._isCompleted=!1,this._taskState=Or.INIT}return Object.defineProperty(n.prototype,"isCompleted",{get:function(){return this._isCompleted},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"taskState",{get:function(){return this._taskState},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"errorObject",{get:function(){return this._errorObject},enumerable:!1,configurable:!0}),n.prototype._setErrorObject=function(t,e){this._errorObject||(this._errorObject={message:t,exception:e})},n.prototype.run=function(t,e,i){var r=this;this._taskState=Or.RUNNING,this.runTask(t,function(){r.onDoneCallback(e,i)},function(o,a){r.onErrorCallback(i,o,a)})},n.prototype.runTask=function(t,e,i){throw new Error("runTask is not implemented")},n.prototype.reset=function(){this._taskState=Or.INIT},n.prototype.onErrorCallback=function(t,e,i){this._taskState=Or.ERROR,this._errorObject={message:e,exception:i},this.onError&&this.onError(this,e,i),t()},n.prototype.onDoneCallback=function(t,e){try{this._taskState=Or.DONE,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),t()}catch(i){this.onErrorCallback(e,"Task is done, error executing success callback(s)",i)}},n}(),Nd=function(){function n(t,e,i){this.remainingCount=t,this.totalCount=e,this.task=i}return n}(),wd=function(n){Object(p.d)(t,n);function t(e,i,r,o){var a=n.call(this,e)||this;return a.name=e,a.meshesNames=i,a.rootUrl=r,a.sceneFilename=o,a}return t.prototype.runTask=function(e,i,r){var o=this;Mi.a.LoadAssetContainer(this.rootUrl,this.sceneFilename,e,function(a){o.loadedContainer=a,o.loadedMeshes=a.meshes,o.loadedParticleSystems=a.particleSystems,o.loadedSkeletons=a.skeletons,o.loadedAnimationGroups=a.animationGroups,i()},null,function(a,s,c){r(s,c)})},t}(Mr),Vd=function(n){Object(p.d)(t,n);function t(e,i,r,o){var a=n.call(this,e)||this;return a.name=e,a.meshesNames=i,a.rootUrl=r,a.sceneFilename=o,a}return t.prototype.runTask=function(e,i,r){var o=this;Mi.a.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,function(a,s,c,_){o.loadedMeshes=a,o.loadedParticleSystems=s,o.loadedSkeletons=c,o.loadedAnimationGroups=_,i()},null,function(a,s,c){r(s,c)})},t}(Mr),Ud=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.name=e,r.url=i,r}return t.prototype.runTask=function(e,i,r){var o=this;e._loadFile(this.url,function(a){o.text=a,i()},void 0,!1,!1,function(a,s){a&&r(a.status+" "+a.statusText,s)})},t}(Mr),Gd=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.name=e,r.url=i,r}return t.prototype.runTask=function(e,i,r){var o=this;e._loadFile(this.url,function(a){o.data=a,i()},void 0,!0,!0,function(a,s){a&&r(a.status+" "+a.statusText,s)})},t}(Mr),zd=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.name=e,r.url=i,r}return t.prototype.runTask=function(e,i,r){var o=this,a=new Image;re.b.SetCorsBehavior(this.url,a),a.onload=function(){o.image=a,i()},a.onerror=function(s){r("Error loading image",s)},a.src=this.url},t}(Mr),jd=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!0),a===void 0&&(a=Ze.a.TRILINEAR_SAMPLINGMODE);var s=n.call(this,e)||this;return s.name=e,s.url=i,s.noMipmap=r,s.invertY=o,s.samplingMode=a,s}return t.prototype.runTask=function(e,i,r){var o=function(){i()},a=function(s,c){r(s,c)};this.texture=new Ze.a(this.url,e,this.noMipmap,this.invertY,this.samplingMode,o,a)},t}(Mr),Wd=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s){var c=n.call(this,e)||this;return c.name=e,c.url=i,c.extensions=r,c.noMipmap=o,c.files=a,c.prefiltered=s,c}return t.prototype.runTask=function(e,i,r){var o=function(){i()},a=function(s,c){r(s,c)};this.texture=new pn.a(this.url,e,this.extensions,this.noMipmap,this.files,o,a,void 0,this.prefiltered)},t}(Mr),Hd=function(n){Object(p.d)(t,n);function t(e,i,r,o,a,s,c){o===void 0&&(o=!1),a===void 0&&(a=!0),s===void 0&&(s=!1),c===void 0&&(c=!1);var _=n.call(this,e)||this;return _.name=e,_.url=i,_.size=r,_.noMipmap=o,_.generateHarmonics=a,_.gammaSpace=s,_.reserved=c,_}return t.prototype.runTask=function(e,i,r){var o=function(){i()},a=function(s,c){r(s,c)};this.texture=new Cc.a(this.url,e,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,o,a)},t}(Mr),kd=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!1),a===void 0&&(a=!0);var s=n.call(this,e)||this;return s.name=e,s.url=i,s.size=r,s.noMipmap=o,s.gammaSpace=a,s}return t.prototype.runTask=function(e,i,r){var o=function(){i()},a=function(s,c){r(s,c)};this.texture=new Pc(this.url,e,this.size,this.noMipmap,this.gammaSpace,o,a)},t}(Mr),_v=function(){function n(t){this._isLoading=!1,this._tasks=new Array,this._waitingTasksCount=0,this._totalTasksCount=0,this.onTaskSuccessObservable=new g.c,this.onTaskErrorObservable=new g.c,this.onTasksDoneObservable=new g.c,this.onProgressObservable=new g.c,this.useDefaultLoadingScreen=!0,this.autoHideLoadingUI=!0,this._scene=t}return n.prototype.addContainerTask=function(t,e,i,r){var o=new wd(t,e,i,r);return this._tasks.push(o),o},n.prototype.addMeshTask=function(t,e,i,r){var o=new Vd(t,e,i,r);return this._tasks.push(o),o},n.prototype.addTextFileTask=function(t,e){var i=new Ud(t,e);return this._tasks.push(i),i},n.prototype.addBinaryFileTask=function(t,e){var i=new Gd(t,e);return this._tasks.push(i),i},n.prototype.addImageTask=function(t,e){var i=new zd(t,e);return this._tasks.push(i),i},n.prototype.addTextureTask=function(t,e,i,r,o){o===void 0&&(o=Ze.a.TRILINEAR_SAMPLINGMODE);var a=new jd(t,e,i,r,o);return this._tasks.push(a),a},n.prototype.addCubeTextureTask=function(t,e,i,r,o,a){var s=new Wd(t,e,i,r,o,a);return this._tasks.push(s),s},n.prototype.addHDRCubeTextureTask=function(t,e,i,r,o,a,s){r===void 0&&(r=!1),o===void 0&&(o=!0),a===void 0&&(a=!1),s===void 0&&(s=!1);var c=new Hd(t,e,i,r,o,a,s);return this._tasks.push(c),c},n.prototype.addEquiRectangularCubeTextureAssetTask=function(t,e,i,r,o){r===void 0&&(r=!1),o===void 0&&(o=!0);var a=new kd(t,e,i,r,o);return this._tasks.push(a),a},n.prototype.removeTask=function(t){var e=this._tasks.indexOf(t);e>-1&&this._tasks.splice(e,1)},n.prototype._decreaseWaitingTasksCount=function(t){this._waitingTasksCount--;try{this.onProgress&&this.onProgress(this._waitingTasksCount,this._totalTasksCount,t),this.onProgressObservable.notifyObservers(new Nd(this._waitingTasksCount,this._totalTasksCount,t))}catch(a){d.a.Error("Error running progress callbacks."),console.log(a)}if(this._waitingTasksCount===0){try{var e=this._tasks.slice();this.onFinish&&this.onFinish(e);for(var i=0,r=e;i<r.length;i++){var t=r[i];if(t.taskState===Or.DONE){var o=this._tasks.indexOf(t);o>-1&&this._tasks.splice(o,1)}}this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(a){d.a.Error("Error running tasks-done callbacks."),console.log(a)}this._isLoading=!1,this.autoHideLoadingUI&&this._scene.getEngine().hideLoadingUI()}},n.prototype._runTask=function(t){var e=this,i=function(){try{e.onTaskSuccess&&e.onTaskSuccess(t),e.onTaskSuccessObservable.notifyObservers(t),e._decreaseWaitingTasksCount(t)}catch(o){r("Error executing task success callbacks",o)}},r=function(o,a){t._setErrorObject(o,a),e.onTaskError&&e.onTaskError(t),e.onTaskErrorObservable.notifyObservers(t),e._decreaseWaitingTasksCount(t)};t.run(this._scene,i,r)},n.prototype.reset=function(){return this._isLoading=!1,this._tasks=new Array,this},n.prototype.load=function(){if(this._isLoading)return this;if(this._isLoading=!0,this._waitingTasksCount=this._tasks.length,this._totalTasksCount=this._tasks.length,this._waitingTasksCount===0)return this._isLoading=!1,this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(var t=0;t<this._tasks.length;t++){var e=this._tasks[t];e.taskState===Or.INIT&&this._runTask(e)}return this},n.prototype.loadAsync=function(){var t=this;return new Promise(function(e,i){if(t._isLoading){e();return}t.onTasksDoneObservable.addOnce(function(r){r&&r.length?i(r):e()}),t.load()})},n}(),yv=u(698),bv=function(){function n(t,e){this._meshesOrigins=[],this._toCenterVectors=[],this._scaledDirection=l.e.Zero(),this._newPosition=l.e.Zero(),this._centerPosition=l.e.Zero(),this._meshes=t.slice(),e?this._centerMesh=e:this._setCenterMesh();var i=this._meshes.indexOf(this._centerMesh);i>=0&&this._meshes.splice(i,1),this._centerPosition=this._centerMesh.getAbsolutePosition().clone();for(var r=0;r<this._meshes.length;r++)if(this._meshes[r]){var o=this._meshes[r];this._meshesOrigins[r]=o.getAbsolutePosition().clone(),this._toCenterVectors[r]=l.e.Zero(),o._boundingInfo&&this._centerMesh._boundingInfo&&o._boundingInfo.boundingBox.centerWorld.subtractToRef(this._centerMesh._boundingInfo.boundingBox.centerWorld,this._toCenterVectors[r])}}return n.prototype._setCenterMesh=function(){for(var t=l.e.Zero(),e=l.e.Zero(),i=Number.MAX_VALUE,r=0;r<this._meshes.length;r++)if(this._meshes[r]){var o=this._meshes[r],a=o.getBoundingInfo();a&&e.addInPlace(a.boundingBox.centerWorld)}t=e.scale(1/this._meshes.length);for(var r=0;r<this._meshes.length;r++)if(this._meshes[r]){var o=this._meshes[r],a=o.getBoundingInfo();if(a){var s=a.boundingBox.centerWorld.subtract(t).lengthSquared();s<i&&(this._centerMesh=o,i=s)}}},n.prototype.getClassName=function(){return"MeshExploder"},n.prototype.getMeshes=function(){var t=this._meshes.slice();return t.unshift(this._centerMesh),t},n.prototype.explode=function(t){t===void 0&&(t=1);for(var e=0;e<this._meshes.length;e++)this._meshes[e]&&this._meshesOrigins[e]&&this._toCenterVectors[e]&&(this._toCenterVectors[e].scaleToRef(t,this._scaledDirection),this._meshesOrigins[e].addToRef(this._scaledDirection,this._newPosition),this._meshes[e].setAbsolutePosition(this._newPosition));this._centerMesh.setAbsolutePosition(this._centerPosition)},n}(),Xd=u(611),Ev=function(){function n(t,e,i,r,o,a,s,c,_){var b=this;this.onProcessFileCallback=function(){return!0},this.loadAsync=function(C,x){return Mi.a.LoadAsync("file:",C,b._engine,x)},this._engine=t,this._currentScene=e,this._sceneLoadedCallback=i,this._progressCallback=r,this._additionalRenderLoopLogicCallback=o,this._textureLoadingCallback=a,this._startingProcessingFilesCallback=s,this._onReloadCallback=c,this._errorCallback=_}return Object.defineProperty(n,"FilesToLoad",{get:function(){return Xd.a.FilesToLoad},enumerable:!1,configurable:!0}),n.prototype.monitorElementForDragNDrop=function(t){var e=this;t&&(this._elementToMonitor=t,this._dragEnterHandler=function(i){e.drag(i)},this._dragOverHandler=function(i){e.drag(i)},this._dropHandler=function(i){e.drop(i)},this._elementToMonitor.addEventListener("dragenter",this._dragEnterHandler,!1),this._elementToMonitor.addEventListener("dragover",this._dragOverHandler,!1),this._elementToMonitor.addEventListener("drop",this._dropHandler,!1))},Object.defineProperty(n.prototype,"filesToLoad",{get:function(){return this._filesToLoad},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){!this._elementToMonitor||(this._elementToMonitor.removeEventListener("dragenter",this._dragEnterHandler),this._elementToMonitor.removeEventListener("dragover",this._dragOverHandler),this._elementToMonitor.removeEventListener("drop",this._dropHandler))},n.prototype.renderFunction=function(){if(this._additionalRenderLoopLogicCallback&&this._additionalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){var t=this._currentScene.getWaitingItemsCount();t>0&&this._textureLoadingCallback(t)}this._currentScene.render()}},n.prototype.drag=function(t){t.stopPropagation(),t.preventDefault()},n.prototype.drop=function(t){t.stopPropagation(),t.preventDefault(),this.loadFiles(t)},n.prototype._traverseFolder=function(t,e,i,r){var o=this,a=t.createReader(),s=t.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,"$1/");a.readEntries(function(c){i.count+=c.length;for(var _=0,b=c;_<b.length;_++){var C=b[_];C.isFile?C.file(function(x){x.correctName=s+x.name,e.push(x),--i.count==0&&r()}):C.isDirectory&&o._traverseFolder(C,e,i,r)}--i.count==0&&r()})},n.prototype._processFiles=function(t){for(var e=this,i=0;i<t.length;i++){var r=t[i].correctName.toLowerCase(),o=r.split(".").pop();!this.onProcessFileCallback(t[i],r,o,function(a){return e._sceneFileToLoad=a})||(Mi.a.IsPluginForExtensionAvailable("."+o)&&(this._sceneFileToLoad=t[i]),n.FilesToLoad[r]=t[i])}},n.prototype.loadFiles=function(t){var e=this;if(t&&t.dataTransfer&&t.dataTransfer.files&&(this._filesToLoad=t.dataTransfer.files),t&&t.target&&t.target.files&&(this._filesToLoad=t.target.files),!(!this._filesToLoad||this._filesToLoad.length===0)&&(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(this._filesToLoad),this._filesToLoad&&this._filesToLoad.length>0)){for(var i=new Array,r=[],o=t.dataTransfer?t.dataTransfer.items:null,a=0;a<this._filesToLoad.length;a++){var s=this._filesToLoad[a],c=s.name.toLowerCase(),_=void 0;if(s.correctName=c,o){var b=o[a];b.getAsEntry?_=b.getAsEntry():b.webkitGetAsEntry&&(_=b.webkitGetAsEntry())}_&&_.isDirectory?r.push(_):i.push(s)}if(r.length===0)this._processFiles(i),this._processReload();else for(var C={count:r.length},x=0,V=r;x<V.length;x++){var D=V[x];this._traverseFolder(D,i,C,function(){e._processFiles(i),C.count===0&&e._processReload()})}}},n.prototype._processReload=function(){this._onReloadCallback?this._onReloadCallback(this._sceneFileToLoad):this.reload()},n.prototype.reload=function(){var t=this;this._sceneFileToLoad?(this._currentScene&&(d.a.errorsCount>0&&d.a.ClearLogCache(),this._engine.stopRenderLoop()),Mi.a.ShowLoadingScreen=!1,this._engine.displayLoadingUI(),this.loadAsync(this._sceneFileToLoad,this._progressCallback).then(function(e){t._currentScene&&t._currentScene.dispose(),t._currentScene=e,t._sceneLoadedCallback&&t._sceneLoadedCallback(t._sceneFileToLoad,t._currentScene),t._currentScene.executeWhenReady(function(){t._engine.hideLoadingUI(),t._engine.runRenderLoop(function(){t.renderFunction()})})}).catch(function(e){t._engine.hideLoadingUI(),t._errorCallback&&t._errorCallback(t._sceneFileToLoad,t._currentScene,e.message)})):d.a.Error("Please provide a valid .babylon file.")},n}(),Yd=u(716),Pv=u(715),xr=function(){function n(t){t===void 0&&(t=0),this.priority=t}return n.prototype.getDescription=function(){return""},n.prototype.apply=function(t,e){return!0},n}(),ca=function(n){Object(p.d)(t,n);function t(e,i,r){e===void 0&&(e=0),i===void 0&&(i=1024),r===void 0&&(r=.5);var o=n.call(this,e)||this;return o.priority=e,o.maximumSize=i,o.step=r,o}return t.prototype.getDescription=function(){return"Reducing render target texture size to "+this.maximumSize},t.prototype.apply=function(e,i){for(var r=!0,o=0;o<e.textures.length;o++){var a=e.textures[o];if(!(!a.canRescale||a.getContext)){var s=a.getSize(),c=Math.max(s.width,s.height);c>this.maximumSize&&(a.scale(this.step),r=!1)}}return r},t}(xr),al=function(n){Object(p.d)(t,n);function t(e,i,r){e===void 0&&(e=0),i===void 0&&(i=2),r===void 0&&(r=.25);var o=n.call(this,e)||this;return o.priority=e,o.maximumScale=i,o.step=r,o._currentScale=-1,o._directionOffset=1,o}return t.prototype.getDescription=function(){return"Setting hardware scaling level to "+this._currentScale},t.prototype.apply=function(e,i){return this._currentScale===-1&&(this._currentScale=e.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,e.getEngine().setHardwareScalingLevel(this._currentScale),this._directionOffset===1?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale},t}(xr),fa=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning shadows on/off"},t.prototype.apply=function(e,i){return e.shadowsEnabled=i.isInImprovementMode,!0},t}(xr),ha=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning post-processes on/off"},t.prototype.apply=function(e,i){return e.postProcessesEnabled=i.isInImprovementMode,!0},t}(xr),da=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning lens flares on/off"},t.prototype.apply=function(e,i){return e.lensFlaresEnabled=i.isInImprovementMode,!0},t}(xr),Kd=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"},t.prototype.apply=function(e,i){return this.onApply?this.onApply(e,i):!0},t}(xr),pa=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning particles on/off"},t.prototype.apply=function(e,i){return e.particlesEnabled=i.isInImprovementMode,!0},t}(xr),sl=function(n){Object(p.d)(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.getDescription=function(){return"Turning render targets off"},t.prototype.apply=function(e,i){return e.renderTargetsEnabled=i.isInImprovementMode,!0},t}(xr),ma=function(n){Object(p.d)(t,n);function t(){var e=n!==null&&n.apply(this,arguments)||this;return e._canBeMerged=function(i){if(!(i instanceof st.a))return!1;var r=i;return!(r.isDisposed()||!r.isVisible||!r.isEnabled()||r.instances.length>0||r.skeleton||r.hasLODLevels)},e}return Object.defineProperty(t,"UpdateSelectionTree",{get:function(){return t._UpdateSelectionTree},set:function(e){t._UpdateSelectionTree=e},enumerable:!1,configurable:!0}),t.prototype.getDescription=function(){return"Merging similar meshes together"},t.prototype.apply=function(e,i,r){for(var o=e.meshes.slice(0),a=o.length,s=0;s<a;s++){var c=new Array,_=o[s];if(!!this._canBeMerged(_)){c.push(_);for(var b=s+1;b<a;b++){var C=o[b];!this._canBeMerged(C)||C.material===_.material&&C.checkCollisions===_.checkCollisions&&(c.push(C),a--,o.splice(b,1),b--)}c.length<2||st.a.MergeMeshes(c,void 0,!0)}}var x=e;return x.createOrUpdateSelectionOctree&&(r!=null?r&&x.createOrUpdateSelectionOctree():t.UpdateSelectionTree&&x.createOrUpdateSelectionOctree()),!0},t._UpdateSelectionTree=!1,t}(xr),ll=function(){function n(t,e){t===void 0&&(t=60),e===void 0&&(e=2e3),this.targetFrameRate=t,this.trackerDuration=e,this.optimizations=new Array}return n.prototype.addOptimization=function(t){return this.optimizations.push(t),this},n.prototype.addCustomOptimization=function(t,e,i){i===void 0&&(i=0);var r=new Kd(i);return r.onApply=t,r.onGetDescription=e,this.optimizations.push(r),this},n.LowDegradationAllowed=function(t){var e=new n(t),i=0;return e.addOptimization(new ma(i)),e.addOptimization(new fa(i)),e.addOptimization(new da(i)),i++,e.addOptimization(new ha(i)),e.addOptimization(new pa(i)),i++,e.addOptimization(new ca(i,1024)),e},n.ModerateDegradationAllowed=function(t){var e=new n(t),i=0;return e.addOptimization(new ma(i)),e.addOptimization(new fa(i)),e.addOptimization(new da(i)),i++,e.addOptimization(new ha(i)),e.addOptimization(new pa(i)),i++,e.addOptimization(new ca(i,512)),i++,e.addOptimization(new sl(i)),i++,e.addOptimization(new al(i,2)),e},n.HighDegradationAllowed=function(t){var e=new n(t),i=0;return e.addOptimization(new ma(i)),e.addOptimization(new fa(i)),e.addOptimization(new da(i)),i++,e.addOptimization(new ha(i)),e.addOptimization(new pa(i)),i++,e.addOptimization(new ca(i,256)),i++,e.addOptimization(new sl(i)),i++,e.addOptimization(new al(i,4)),e},n}(),Cv=function(){function n(t,e,i,r){var o=this;if(i===void 0&&(i=!0),r===void 0&&(r=!1),this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new g.c,this.onNewOptimizationAppliedObservable=new g.c,this.onFailureObservable=new g.c,e?this._options=e:this._options=new ll,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i)for(var a=0,s=0,c=this._options.optimizations;s<c.length;s++){var _=c[s];_.priority=a++}this._improvementMode=r,this._scene=t||Kt.a.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(function(){o._sceneDisposeObserver=null,o.dispose()})}return Object.defineProperty(n.prototype,"isInImprovementMode",{get:function(){return this._improvementMode},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentPriorityLevel",{get:function(){return this._currentPriorityLevel},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentFrameRate",{get:function(){return this._currentFrameRate},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"targetFrameRate",{get:function(){return this._targetFrameRate},set:function(t){this._targetFrameRate=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"trackerDuration",{get:function(){return this._trackerDuration},set:function(t){this._trackerDuration=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"optimizations",{get:function(){return this._options.optimizations},enumerable:!1,configurable:!0}),n.prototype.stop=function(){this._isRunning=!1},n.prototype.reset=function(){this._currentPriorityLevel=0},n.prototype.start=function(){var t=this;this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady(function(){setTimeout(function(){t._checkCurrentState()},t._trackerDuration)}))},n.prototype._checkCurrentState=function(){var t=this;if(!!this._isRunning){var e=this._scene,i=this._options;if(this._currentFrameRate=Math.round(e.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate){this._isRunning=!1,this.onSuccessObservable.notifyObservers(this);return}for(var r=!0,o=!0,a=0;a<i.optimizations.length;a++){var s=i.optimizations[a];s.priority===this._currentPriorityLevel&&(o=!1,r=r&&s.apply(e,this),this.onNewOptimizationAppliedObservable.notifyObservers(s))}if(o){this._isRunning=!1,this.onFailureObservable.notifyObservers(this);return}r&&this._currentPriorityLevel++,e.executeWhenReady(function(){setTimeout(function(){t._checkCurrentState()},t._trackerDuration)})}},n.prototype.dispose=function(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)},n.OptimizeAsync=function(t,e,i,r){var o=new n(t,e||ll.ModerateDegradationAllowed(),!1);return i&&o.onSuccessObservable.add(function(){i()}),r&&o.onFailureObservable.add(function(){r()}),o.start(),o},n}(),ga=[],ul=function(n,t){ga[n.id]||n.doNotSerialize||(t.vertexData.push(n.serializeVerticeData()),ga[n.id]=!0)},Qd=function(n,t){var e={},i=n._geometry;return i&&(n.getScene().getGeometryByID(i.id)||ul(i,t.geometries)),n.serialize&&n.serialize(e),e},Sv=function(n,t){if(n.delayLoadState===1||n.delayLoadState===0){if(n.material&&!n.material.doNotSerialize)if(n.material instanceof yo.a){if(t.multiMaterials=t.multiMaterials||[],t.materials=t.materials||[],!t.multiMaterials.some(function(s){return s.id===n.material.id})){t.multiMaterials.push(n.material.serialize());for(var e=function(s){s&&(t.materials.some(function(c){return c.id===s.id})||t.materials.push(s.serialize()))},i=0,r=n.material.subMaterials;i<r.length;i++){var o=r[i];e(o)}}}else t.materials=t.materials||[],t.materials.some(function(s){return s.id===n.material.id})||t.materials.push(n.material.serialize());var a=n._geometry;a&&(t.geometries||(t.geometries={},t.geometries.boxes=[],t.geometries.spheres=[],t.geometries.cylinders=[],t.geometries.toruses=[],t.geometries.grounds=[],t.geometries.planes=[],t.geometries.torusKnots=[],t.geometries.vertexData=[]),ul(a,t.geometries)),n.skeleton&&!n.skeleton.doNotSerialize&&(t.skeletons=t.skeletons||[],t.skeletons.push(n.skeleton.serialize())),t.meshes=t.meshes||[],t.meshes.push(Qd(n,t))}},cl=function(){function n(){}return n.ClearCache=function(){ga=[]},n.Serialize=function(t){return n._Serialize(t)},n._Serialize=function(t,e){e===void 0&&(e=!0);var i={};if(e&&!t.getEngine()._features.supportSyncTextureRead&&Ze.a.ForceSerializeBuffers&&console.warn("The serialization object may not contain the proper base64 encoded texture data! You should use the SerializeAsync method instead."),n.ClearCache(),i.useDelayedTextureLoading=t.useDelayedTextureLoading,i.autoClear=t.autoClear,i.clearColor=t.clearColor.asArray(),i.ambientColor=t.ambientColor.asArray(),i.gravity=t.gravity.asArray(),i.collisionsEnabled=t.collisionsEnabled,t.fogMode&&t.fogMode!==0&&(i.fogMode=t.fogMode,i.fogColor=t.fogColor.asArray(),i.fogStart=t.fogStart,i.fogEnd=t.fogEnd,i.fogDensity=t.fogDensity),t.isPhysicsEnabled()){var r=t.getPhysicsEngine();r&&(i.physicsEnabled=!0,i.physicsGravity=r.gravity.asArray(),i.physicsEngine=r.getPhysicsPluginName())}t.metadata&&(i.metadata=t.metadata),i.morphTargetManagers=[];for(var o=0,a=t.meshes;o<a.length;o++){var s=a[o],c=s.morphTargetManager;c&&i.morphTargetManagers.push(c.serialize())}i.lights=[];var _,b;for(_=0;_<t.lights.length;_++)b=t.lights[_],b.doNotSerialize||i.lights.push(b.serialize());for(i.cameras=[],_=0;_<t.cameras.length;_++){var C=t.cameras[_];C.doNotSerialize||i.cameras.push(C.serialize())}if(t.activeCamera&&(i.activeCameraID=t.activeCamera.id),Ee.a.AppendSerializedAnimations(t,i),t.animationGroups&&t.animationGroups.length>0){i.animationGroups=[];for(var x=0;x<t.animationGroups.length;x++){var V=t.animationGroups[x];i.animationGroups.push(V.serialize())}}if(t.reflectionProbes&&t.reflectionProbes.length>0)for(i.reflectionProbes=[],_=0;_<t.reflectionProbes.length;_++){var D=t.reflectionProbes[_];i.reflectionProbes.push(D.serialize())}i.materials=[],i.multiMaterials=[];var z;for(_=0;_<t.materials.length;_++)z=t.materials[_],z.doNotSerialize||i.materials.push(z.serialize());for(i.multiMaterials=[],_=0;_<t.multiMaterials.length;_++){var q=t.multiMaterials[_];i.multiMaterials.push(q.serialize())}for(t.environmentTexture&&(i.environmentTexture=t.environmentTexture.name),i.environmentIntensity=t.environmentIntensity,i.skeletons=[],_=0;_<t.skeletons.length;_++){var ue=t.skeletons[_];ue.doNotSerialize||i.skeletons.push(ue.serialize())}for(i.transformNodes=[],_=0;_<t.transformNodes.length;_++)t.transformNodes[_].doNotSerialize||i.transformNodes.push(t.transformNodes[_].serialize());i.geometries={},i.geometries.boxes=[],i.geometries.spheres=[],i.geometries.cylinders=[],i.geometries.toruses=[],i.geometries.grounds=[],i.geometries.planes=[],i.geometries.torusKnots=[],i.geometries.vertexData=[],ga=[];var ge=t.getGeometries();for(_=0;_<ge.length;_++){var Se=ge[_];Se.isReady()&&ul(Se,i.geometries)}for(i.meshes=[],_=0;_<t.meshes.length;_++){var s=t.meshes[_];if(s instanceof st.a){var Pe=s;Pe.doNotSerialize||(Pe.delayLoadState===1||Pe.delayLoadState===0)&&i.meshes.push(Qd(Pe,i))}}for(i.particleSystems=[],_=0;_<t.particleSystems.length;_++)i.particleSystems.push(t.particleSystems[_].serialize(!1));for(i.postProcesses=[],_=0;_<t.postProcesses.length;_++)i.postProcesses.push(t.postProcesses[_].serialize());t.actionManager&&(i.actions=t.actionManager.serialize("scene"));for(var me=0,xe=t._serializableComponents;me<xe.length;me++){var Fe=xe[me];Fe.serialize(i)}return i},n.SerializeAsync=function(t){var e=n._Serialize(t,!1),i=[];return this._CollectPromises(e,i),Promise.all(i).then(function(){return e})},n._CollectPromises=function(t,e){if(Array.isArray(t))for(var i=function(_){var b=t[_];b instanceof Promise?e.push(b.then(function(C){return t[_]=C})):(b instanceof Object||Array.isArray(b))&&r._CollectPromises(b,e)},r=this,o=0;o<t.length;++o)i(o);else if(t instanceof Object){var a=function(_){if(t.hasOwnProperty(_)){var b=t[_];b instanceof Promise?e.push(b.then(function(C){return t[_]=C})):(b instanceof Object||Array.isArray(b))&&s._CollectPromises(b,e)}},s=this;for(var c in t)a(c)}},n.SerializeMesh=function(t,e,i){e===void 0&&(e=!1),i===void 0&&(i=!1);var r={};if(n.ClearCache(),t=t instanceof Array?t:[t],e||i)for(var o=0;o<t.length;++o)i&&t[o].getDescendants().forEach(function(a){a instanceof st.a&&t.indexOf(a)<0&&!a.doNotSerialize&&t.push(a)}),e&&t[o].parent&&t.indexOf(t[o].parent)<0&&!t[o].parent.doNotSerialize&&t.push(t[o].parent);return t.forEach(function(a){Sv(a,r)}),r},n}(),Zd=u(663),Tv=u(566),Av=function(){function n(t,e){if(e===void 0&&(e=null),!n.IsSupported(t))throw"Your browser does not support recording so far.";var i=t.getRenderingCanvas();if(!i)throw"The babylon engine must have a canvas to be recorded";this._canvas=i,this._canvas.isRecording=!1,this._options=Object(p.a)(Object(p.a)({},n._defaultOptions),e);var r=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(var o=0,a=this._options.audioTracks;o<a.length;o++){var s=a[o];r.addTrack(s)}this._mediaRecorder=new MediaRecorder(r,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=this._handleDataAvailable.bind(this),this._mediaRecorder.onerror=this._handleError.bind(this),this._mediaRecorder.onstop=this._handleStop.bind(this)}return n.IsSupported=function(t){var e=t.getRenderingCanvas();return!!e&&typeof e.captureStream=="function"},Object.defineProperty(n.prototype,"isRecording",{get:function(){return!!this._canvas&&this._canvas.isRecording},enumerable:!1,configurable:!0}),n.prototype.stopRecording=function(){!this._canvas||!this._mediaRecorder||!this.isRecording||(this._canvas.isRecording=!1,this._mediaRecorder.stop())},n.prototype.startRecording=function(t,e){var i=this;if(t===void 0&&(t="babylonjs.webm"),e===void 0&&(e=7),!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return e>0&&setTimeout(function(){i.stopRecording()},e*1e3),this._fileName=t,this._recordedChunks=[],this._resolve=null,this._reject=null,this._canvas.isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise(function(r,o){i._resolve=r,i._reject=o})},n.prototype.dispose=function(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null},n.prototype._handleDataAvailable=function(t){t.data.size>0&&this._recordedChunks.push(t.data)},n.prototype._handleError=function(t){if(this.stopRecording(),this._reject)this._reject(t.error);else throw new t.error},n.prototype._handleStop=function(){this.stopRecording();var t=new Blob(this._recordedChunks);this._resolve&&this._resolve(t),window.URL.createObjectURL(t),this._fileName&&re.b.Download(t,this._fileName)},n._defaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3},n}(),Io=function(){function n(){}return n.CreateScreenshot=function(t,e,i,r,o,a){o===void 0&&(o="image/png"),a===void 0&&(a=!1);var s=n._getScreenshotSize(t,e,i),c=s.height,_=s.width;if(!(c&&_)){d.a.Error("Invalid 'size' parameter !");return}re.b._ScreenshotCanvas||(re.b._ScreenshotCanvas=document.createElement("canvas")),re.b._ScreenshotCanvas.width=_,re.b._ScreenshotCanvas.height=c;var b=re.b._ScreenshotCanvas.getContext("2d"),C=t.getRenderWidth()/t.getRenderHeight(),x=_,V=x/C;V>c&&(V=c,x=V*C);var D=Math.max(0,_-x)/2,z=Math.max(0,c-V)/2;t.onEndFrameObservable.addOnce(function(){var q=t.getRenderingCanvas();b&&q&&b.drawImage(q,D,z,x,V),a?(re.b.EncodeScreenshotCanvasData(void 0,o),r&&r("")):re.b.EncodeScreenshotCanvasData(r,o)})},n.CreateScreenshotAsync=function(t,e,i,r){return r===void 0&&(r="image/png"),new Promise(function(o,a){n.CreateScreenshot(t,e,i,function(s){typeof s!="undefined"?o(s):a(new Error("Data is undefined"))},r)})},n.CreateScreenshotWithResizeAsync=function(t,e,i,r,o){return o===void 0&&(o="image/png"),new Promise(function(a,s){n.CreateScreenshot(t,e,{width:i,height:r},function(){a()},o,!0)})},n.CreateScreenshotUsingRenderTarget=function(t,e,i,r,o,a,s,c,_,b){o===void 0&&(o="image/png"),a===void 0&&(a=1),s===void 0&&(s=!1),_===void 0&&(_=!1),b===void 0&&(b=!1);var C=n._getScreenshotSize(t,e,i),x=C.height,V=C.width,D={width:V,height:x};if(!(x&&V)){d.a.Error("Invalid 'size' parameter !");return}var z=e.getScene(),q=null,ue=z.activeCameras;z.activeCameras=null,z.activeCamera!==e&&(q=z.activeCamera,z.activeCamera=e),z.render();var ge=new Cr.a("screenShot",D,z,!1,!1,0,!1,Ze.a.NEAREST_SAMPLINGMODE,void 0,b,void 0,void 0,void 0,a);ge.renderList=null,ge.samples=a,ge.renderSprites=_,t.onEndFrameObservable.addOnce(function(){ge.readPixels(void 0,void 0,void 0,!1).then(function(me){re.b.DumpData(V,x,me,r,o,c,!0),ge.dispose()})});var Se=function(){z.incrementRenderId(),z.resetCachedMaterial(),ge.render(!0),z.incrementRenderId(),z.resetCachedMaterial(),q&&(z.activeCamera=q),z.activeCameras=ue,e.getProjectionMatrix(!0),z.render()};if(s){var Pe=new Uh.a("antialiasing",1,z.activeCamera);ge.addPostProcess(Pe),Pe.getEffect().isReady()?Se():Pe.getEffect().onCompiled=function(){Se()}}else Se()},n.CreateScreenshotUsingRenderTargetAsync=function(t,e,i,r,o,a,s,c){return r===void 0&&(r="image/png"),o===void 0&&(o=1),a===void 0&&(a=!1),c===void 0&&(c=!1),new Promise(function(_,b){n.CreateScreenshotUsingRenderTarget(t,e,i,function(C){typeof C!="undefined"?_(C):b(new Error("Data is undefined"))},r,o,a,s,c)})},n._getScreenshotSize=function(t,e,i){var r=0,o=0;if(typeof i=="object"){var a=i.precision?Math.abs(i.precision):1;i.width&&i.height?(r=i.height*a,o=i.width*a):i.width&&!i.height?(o=i.width*a,r=Math.round(o/t.getAspectRatio(e))):i.height&&!i.width?(r=i.height*a,o=Math.round(r*t.getAspectRatio(e))):(o=Math.round(t.getRenderWidth()*a),r=Math.round(o/t.getAspectRatio(e)))}else isNaN(i)||(r=i,o=i);return o&&(o=Math.floor(o)),r&&(r=Math.floor(r)),{height:r|0,width:o|0}},n}();re.b.CreateScreenshot=Io.CreateScreenshot,re.b.CreateScreenshotAsync=Io.CreateScreenshotAsync,re.b.CreateScreenshotUsingRenderTarget=Io.CreateScreenshotUsingRenderTarget,re.b.CreateScreenshotUsingRenderTargetAsync=Io.CreateScreenshotUsingRenderTargetAsync;var fl;(function(n){n[n.Checkbox=0]="Checkbox",n[n.Slider=1]="Slider",n[n.Vector3=2]="Vector3",n[n.Quaternion=3]="Quaternion",n[n.Color3=4]="Color3",n[n.String=5]="String"})(fl||(fl={}));var Rv=u(712),va=u(662),Ov=u(699),Mv=u(638),xv=u(629),Dv=function(){function n(){}return n._GetStorage=function(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch(e){var t={};return{getItem:function(i){var r=t[i];return r===void 0?null:r},setItem:function(i,r){t[i]=r}}}},n.ReadString=function(t,e){var i=this._Storage.getItem(t);return i!==null?i:e},n.WriteString=function(t,e){this._Storage.setItem(t,e)},n.ReadBoolean=function(t,e){var i=this._Storage.getItem(t);return i!==null?i==="true":e},n.WriteBoolean=function(t,e){this._Storage.setItem(t,e?"true":"false")},n.ReadNumber=function(t,e){var i=this._Storage.getItem(t);return i!==null?parseFloat(i):e},n.WriteNumber=function(t,e){this._Storage.setItem(t,e.toString())},n._Storage=n._GetStorage(),n}(),Iv=function(){function n(){this._trackedScene=null}return n.prototype.track=function(t){this._trackedScene=t,this._savedJSON=cl.Serialize(t)},n.prototype.getDelta=function(){if(!this._trackedScene)return null;var t=Ze.a.ForceSerializeBuffers;Ze.a.ForceSerializeBuffers=!1;var e=cl.Serialize(this._trackedScene),i={};for(var r in e)this._compareCollections(r,this._savedJSON[r],e[r],i);return Ze.a.ForceSerializeBuffers=t,i},n.prototype._compareArray=function(t,e,i,r){if(e.length===0&&i.length===0)return!0;if(e.length&&!isNaN(e[0])||i.length&&!isNaN(i[0])){if(e.length!==i.length)return!1;if(e.length===0)return!0;for(var o=0;o<e.length;o++)if(e[o]!==i[o])return r[t]=i,!1;return!0}for(var a=[],s=function(){var C=e[o],x=C.uniqueId;a.push(x);var V=i.filter(function(q){return q.uniqueId===x});if(V.length){var D=V[0],z={};c._compareObjects(C,D,z)||(r[t]||(r[t]=[]),z.__state={id:D.id||D.name},r[t].push(z))}else{var z={__state:{deleteId:C.id||C.name}};r[t].push(z)}},c=this,o=0;o<e.length;o++)s();for(var o=0;o<i.length;o++){var _=i[o],b=_.uniqueId;a.indexOf(b)===-1&&(r[t]||(r[t]=[]),r[t].push(_))}return!0},n.prototype._compareObjects=function(t,e,i){var r=!1;for(var o in t)if(!!t.hasOwnProperty(o)){var a=t[o],s=e[o],c=!1;Array.isArray(a)?c=JSON.stringify(a)!==JSON.stringify(s):(!isNaN(a)||Object.prototype.toString.call(a)=="[object String]")&&(c=a!==s),c&&(r=!0,i[o]=s)}return!r},n.prototype._compareCollections=function(t,e,i,r){if(e!==i&&e&&i){if(Array.isArray(e)&&Array.isArray(i)){if(this._compareArray(t,e,i,r))return}else if(typeof e=="object"&&typeof i=="object"){var o={};this._compareObjects(e,i,o)||(r[t]=o);return}}},n.GetShadowGeneratorById=function(t,e){for(var i=t.lights.map(function(s){return s.getShadowGenerator()}),r=0,o=i;r<o.length;r++){var a=o[r];if(a&&a.id===e)return a}return null},n.ApplyDelta=function(t,e){var i=this;typeof t=="string"&&(t=JSON.parse(t));var r=e;for(var o in t){var a=t[o],s=r[o];if(Array.isArray(s)||o==="shadowGenerators")switch(o){case"cameras":this._ApplyDeltaForEntity(a,e,e.getCameraByID.bind(e),function(c){return te.a.Parse(c,e)});break;case"lights":this._ApplyDeltaForEntity(a,e,e.getLightByID.bind(e),function(c){return Zo.a.Parse(c,e)});break;case"shadowGenerators":this._ApplyDeltaForEntity(a,e,function(c){return i.GetShadowGeneratorById(e,c)},function(c){return pc.a.Parse(c,e)});break;case"meshes":this._ApplyDeltaForEntity(a,e,e.getMeshByID.bind(e),function(c){return st.a.Parse(c,e,"")});break;case"skeletons":this._ApplyDeltaForEntity(a,e,e.getSkeletonById.bind(e),function(c){return ot.a.Parse(c,e)});break;case"materials":this._ApplyDeltaForEntity(a,e,e.getMaterialByID.bind(e),function(c){return Yi.a.Parse(c,e,"")});break;case"multiMaterials":this._ApplyDeltaForEntity(a,e,e.getMaterialByID.bind(e),function(c){return yo.a.Parse(c,e,"")});break;case"transformNodes":this._ApplyDeltaForEntity(a,e,e.getTransformNodeByID.bind(e),function(c){return po.a.Parse(c,e,"")});break;case"particleSystems":this._ApplyDeltaForEntity(a,e,e.getParticleSystemByID.bind(e),function(c){return gi.Parse(c,e,"")});break;case"morphTargetManagers":this._ApplyDeltaForEntity(a,e,e.getMorphTargetById.bind(e),function(c){return Kf.a.Parse(c,e)});break;case"postProcesses":this._ApplyDeltaForEntity(a,e,e.getPostProcessByName.bind(e),function(c){return ii.a.Parse(c,e,"")});break}else isNaN(s)?s.fromArray&&s.fromArray(a):r[o]=a}},n._ApplyPropertiesToEntity=function(t,e){for(var i in t){var r=t[i],o=e[i];o!==void 0&&(!isNaN(o)||Array.isArray(o)?e[i]=r:o.fromArray&&o.fromArray(r))}},n._ApplyDeltaForEntity=function(t,e,i,r){for(var o=0,a=t;o<a.length;o++){var s=a[o];if(s.__state&&s.__state.id!==void 0){var c=i(s.__state.id);c&&this._ApplyPropertiesToEntity(s,c)}else if(s.__state&&s.__state.deleteId!==void 0){var _=i(s.__state.deleteId);_==null||_.dispose()}else r(s)}},n}(),Bn;(function(n){var t=function(){function i(r,o,a,s){o===void 0&&(o=null),a===void 0&&(a=null),s===void 0&&(s=null),o=o!=null?o:function(){return 1},a=a!=null?a:function(){return 1},s=s!=null?s:function(C,x){return C===x?0:1},this._characterToIdx=new Map,this._insertionCosts=new Array(r.length),this._deletionCosts=new Array(r.length),this._substitutionCosts=new Array(r.length);for(var c,_=0;_<r.length;++_){c=r[_],this._characterToIdx.set(c,_),this._insertionCosts[_]=o(c),this._deletionCosts[_]=a(c),this._substitutionCosts[_]=new Array(r.length);for(var b=_;b<r.length;++b)this._substitutionCosts[_][b]=s(c,r[b])}}return i.prototype.serialize=function(){var r={},o=new Array(this._characterToIdx.size);return this._characterToIdx.forEach(function(a,s){o[a]=s}),r.characters=o,r.insertionCosts=this._insertionCosts,r.deletionCosts=this._deletionCosts,r.substitutionCosts=this._substitutionCosts,JSON.stringify(r)},i.Deserialize=function(r){var o=JSON.parse(r),a=new i(o.characters);return a._insertionCosts=o.insertionCosts,a._deletionCosts=o.deletionCosts,a._substitutionCosts=o.substitutionCosts,a},i.prototype.getCharacterIdx=function(r){return this._characterToIdx.get(r)},i.prototype.getInsertionCost=function(r){return this._insertionCosts[r]},i.prototype.getDeletionCost=function(r){return this._deletionCosts[r]},i.prototype.getSubstitutionCost=function(r,o){var a=Math.min(r,o),s=Math.max(r,o);return this._substitutionCosts[a][s]},i}();n.Alphabet=t;var e=function(){function i(r,o){var a=this;if(r.length>i.MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+i.MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=o,this._characters=r.map(function(s){return a._alphabet.getCharacterIdx(s)})}return i.prototype.serialize=function(){return JSON.stringify(this._characters)},i.Deserialize=function(r,o){var a=new i([],o);return a._characters=JSON.parse(r),a},i.prototype.distance=function(r){return i._distance(this,r)},i._distance=function(r,o){var a=r._alphabet;if(a!==o._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");var s=r._characters,c=o._characters,_=s.length,b=c.length,C=i._costMatrix;C[0][0]=0;for(var x=0;x<_;++x)C[x+1][0]=C[x][0]+a.getInsertionCost(s[x]);for(var x=0;x<b;++x)C[0][x+1]=C[0][x]+a.getInsertionCost(c[x]);for(var V=0;V<_;++V)for(var D=0;D<b;++D)i._insertionCost=C[V+1][D]+a.getInsertionCost(c[D]),i._deletionCost=C[V][D+1]+a.getDeletionCost(s[V]),i._substitutionCost=C[V][D]+a.getSubstitutionCost(s[V],c[D]),C[V+1][D+1]=Math.min(i._insertionCost,i._deletionCost,i._substitutionCost);return C[_][b]},i.MAX_SEQUENCE_LENGTH=256,i._costMatrix=Object(p.f)([],Array(i.MAX_SEQUENCE_LENGTH+1)).map(function(r){return new Array(i.MAX_SEQUENCE_LENGTH+1)}),i}();n.Sequence=e})(Bn||(Bn={}));var Lv=function(){function n(t){t===void 0&&(t=.01),this._points=[],this._segmentLength=t}return n.prototype.serialize=function(){return JSON.stringify(this)},n.Deserialize=function(t){var e=JSON.parse(t),i=new n(e._segmentLength);return i._points=e._points.map(function(r){return new l.e(r._x,r._y,r._z)}),i},n.prototype.getLength=function(){return this._points.length*this._segmentLength},n.prototype.add=function(t){var e=this,i=this._points.length;if(i===0)this._points.push(t.clone());else for(var r=function(){return e._segmentLength/l.e.Distance(e._points[i-1],t)},o=r();o<=1;o=r()){var a=this._points[i-1].scale(1-o);t.scaleAndAddToRef(o,a),this._points.push(a),++i}},n.prototype.resampleAtTargetResolution=function(t){var e=new n(this.getLength()/t);return this._points.forEach(function(i){e.add(i)}),e},n.prototype.tokenize=function(t){for(var e=[],i=new l.e,r=2;r<this._points.length;++r)n._transformSegmentDirToRef(this._points[r-2],this._points[r-1],this._points[r],i)&&e.push(n._tokenizeSegment(i,t));return e},n._transformSegmentDirToRef=function(t,e,i,r){var o=.98;return e.subtractToRef(t,n._forwardDir),n._forwardDir.normalize(),e.scaleToRef(-1,n._inverseFromVec),n._inverseFromVec.normalize(),Math.abs(l.e.Dot(n._forwardDir,n._inverseFromVec))>o?!1:(l.e.CrossToRef(n._forwardDir,n._inverseFromVec,n._upDir),n._upDir.normalize(),l.a.LookAtLHToRef(t,e,n._upDir,n._lookMatrix),i.subtractToRef(e,n._fromToVec),n._fromToVec.normalize(),l.e.TransformNormalToRef(n._fromToVec,n._lookMatrix,r),!0)},n._tokenizeSegment=function(t,e){n._bestMatch=0,n._score=l.e.Dot(t,e[0]),n._bestScore=n._score;for(var i=1;i<e.length;++i)n._score=l.e.Dot(t,e[i]),n._score>n._bestScore&&(n._bestMatch=i,n._bestScore=n._score);return n._bestMatch},n._forwardDir=new l.e,n._inverseFromVec=new l.e,n._upDir=new l.e,n._fromToVec=new l.e,n._lookMatrix=new l.a,n}(),Jd=function(){function n(t){this.chars=new Array(t)}return n.Generate=function(t,e,i,r,o){t===void 0&&(t=64),e===void 0&&(e=256),i===void 0&&(i=.1),r===void 0&&(r=.001),o===void 0&&(o=[]);for(var a=.001,s=a*a,c=new n(t),_=0;_<t;++_)c.chars[_]=new l.e(Math.random()-.5,Math.random()-.5,Math.random()-.5),c.chars[_].normalize();for(var _=0;_<o.length;++_)c.chars[_].copyFrom(o[_]);for(var b,C,x=new l.e,V=new l.e,D=function(ue,ge,Se){return(1-Se)*ue+Se*ge},z=0;z<e;++z){b=D(i,r,z/(e-1));for(var q=function(ue){x.copyFromFloats(0,0,0),c.chars.forEach(function(ge){c.chars[ue].subtractToRef(ge,V),C=V.lengthSquared(),C>s&&V.scaleAndAddToRef(1/(V.lengthSquared()*C),x)}),x.scaleInPlace(b),c.chars[ue].addInPlace(x),c.chars[ue].normalize()},_=o.length;_<c.chars.length;++_)q(_)}return c},n.prototype.serialize=function(){return JSON.stringify(this.chars)},n.Deserialize=function(t){for(var e=JSON.parse(t),i=new n(e.length),r=0;r<e.length;++r)i.chars[r]=new l.e(e[r]._x,e[r]._y,e[r]._z);return i},n}(),hl=function(){function n(){this._sequences=[]}return n.prototype.serialize=function(){return JSON.stringify(this._sequences.map(function(t){return t.serialize()}))},n.Deserialize=function(t,e){var i=new n;return i._sequences=JSON.parse(t).map(function(r){return Bn.Sequence.Deserialize(r,e)}),i},n.CreateFromTrajectory=function(t,e,i){return n.CreateFromTokenizationPyramid(n._getTokenizationPyramid(t,e),i)},n.CreateFromTokenizationPyramid=function(t,e){var i=new n;return i._sequences=t.map(function(r){return new Bn.Sequence(r,e)}),i},n._getTokenizationPyramid=function(t,e,i){i===void 0&&(i=n.FINEST_DESCRIPTOR_RESOLUTION);for(var r=[],o=i;o>4;o=Math.floor(o/2))r.push(t.resampleAtTargetResolution(o).tokenize(e.chars));return r},n.prototype.distance=function(t){for(var e=0,i,r=0;r<this._sequences.length;++r)i=Math.pow(2,r),e+=i*this._sequences[r].distance(t._sequences[r]);return e},n.FINEST_DESCRIPTOR_RESOLUTION=32,n}(),$d=function(){function n(t){t===void 0&&(t=[]),this._descriptors=t,this._centroidIdx=-1,this._averageDistance=0,this._refreshDescription()}return n.prototype.serialize=function(){var t={};return t.descriptors=this._descriptors.map(function(e){return e.serialize()}),t.centroidIdx=this._centroidIdx,t.averageDistance=this._averageDistance,JSON.stringify(t)},n.Deserialize=function(t,e){var i=JSON.parse(t),r=new n;return r._descriptors=i.descriptors.map(function(o){return hl.Deserialize(o,e)}),r._centroidIdx=i.centroidIdx,r._averageDistance=i.averageDistance,r},n.prototype.add=function(t){this._descriptors.push(t),this._refreshDescription()},n.prototype.getMatchCost=function(t){return t.distance(this._descriptors[this._centroidIdx])/this._averageDistance},n.prototype.getMatchMinimumDistance=function(t){return Math.min.apply(Math,this._descriptors.map(function(e){return e.distance(t)}))},n.prototype._refreshDescription=function(){var t=this;this._centroidIdx=-1;for(var e,i=this._descriptors.map(function(o){return e=0,t._descriptors.forEach(function(a){e+=o.distance(a)}),e}),r=0;r<i.length;++r)(this._centroidIdx<0||i[r]<i[this._centroidIdx])&&(this._centroidIdx=r);this._averageDistance=0,this._descriptors.forEach(function(o){t._averageDistance+=o.distance(t._descriptors[t._centroidIdx])}),this._descriptors.length>0&&(this._averageDistance=Math.max(this._averageDistance/this._descriptors.length,n.MIN_AVERAGE_DISTANCE))},n.MIN_AVERAGE_DISTANCE=1,n}(),Fv=function(){function n(){this._maximumAllowableMatchCost=4,this._nameToDescribedTrajectory=new Map}return n.prototype.serialize=function(){var t={};return t.maximumAllowableMatchCost=this._maximumAllowableMatchCost,t.vector3Alphabet=this._vector3Alphabet.serialize(),t.levenshteinAlphabet=this._levenshteinAlphabet.serialize(),t.nameToDescribedTrajectory=[],this._nameToDescribedTrajectory.forEach(function(e,i){t.nameToDescribedTrajectory.push(i),t.nameToDescribedTrajectory.push(e.serialize())}),JSON.stringify(t)},n.Deserialize=function(t){var e=JSON.parse(t),i=new n;i._maximumAllowableMatchCost=e.maximumAllowableMatchCost,i._vector3Alphabet=Jd.Deserialize(e.vector3Alphabet),i._levenshteinAlphabet=Bn.Alphabet.Deserialize(e.levenshteinAlphabet);for(var r=0;r<e.nameToDescribedTrajectory.length;r+=2)i._nameToDescribedTrajectory.set(e.nameToDescribedTrajectory[r],$d.Deserialize(e.nameToDescribedTrajectory[r+1],i._levenshteinAlphabet));return i},n.Generate=function(){for(var t=Jd.Generate(64,256,.1,.001,[l.e.Forward()]),e=new Array(t.chars.length),i=0;i<e.length;++i)e[i]=i;var r=new Bn.Alphabet(e,function(a){return a===0?0:1},function(a){return a===0?0:1},function(a,s){return Math.min(1-l.e.Dot(t.chars[a],t.chars[s]),1)}),o=new n;return o._vector3Alphabet=t,o._levenshteinAlphabet=r,o},n.prototype.addTrajectoryToClassification=function(t,e){this._nameToDescribedTrajectory.has(e)||this._nameToDescribedTrajectory.set(e,new $d),this._nameToDescribedTrajectory.get(e).add(hl.CreateFromTrajectory(t,this._vector3Alphabet,this._levenshteinAlphabet))},n.prototype.deleteClassification=function(t){return this._nameToDescribedTrajectory.delete(t)},n.prototype.classifyTrajectory=function(t){var e=this,i=hl.CreateFromTrajectory(t,this._vector3Alphabet,this._levenshteinAlphabet),r=[];if(this._nameToDescribedTrajectory.forEach(function(_,b){_.getMatchCost(i)<e._maximumAllowableMatchCost&&r.push(b)}),r.length===0)return null;for(var o=0,a=this._nameToDescribedTrajectory.get(r[o]).getMatchMinimumDistance(i),s,c=0;c<r.length;++c)s=this._nameToDescribedTrajectory.get(r[c]).getMatchMinimumDistance(i),s<a&&(a=s,o=c);return r[o]},n}(),Bv=u(725),_a=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r.options=i,r._direction=new l.e(0,0,-1),r._mat=new l.a,r._onSelectEnabled=!1,r._origin=new l.e(0,0,0),r.lastNativeXRHitResults=[],r.onHitTestResultObservable=new g.c,r._onHitTestResults=function(o){var a=o.map(function(s){var c=l.a.FromArray(s.hitMatrix);return r._xrSessionManager.scene.useRightHandedSystem||c.toggleModelMatrixHandInPlace(),r.options.worldParentNode&&c.multiplyToRef(r.options.worldParentNode.getWorldMatrix(),c),{xrHitResult:s,transformationMatrix:c}});r.lastNativeXRHitResults=o,r.onHitTestResultObservable.notifyObservers(a)},r._onSelect=function(o){!r._onSelectEnabled||t.XRHitTestWithSelectEvent(o,r._xrSessionManager.referenceSpace)},r.xrNativeFeatureName="hit-test",re.b.Warn("A newer version of this plugin is available"),r}return t.XRHitTestWithRay=function(e,i,r,o){return e.requestHitTest(i,r).then(function(a){var s=o||function(c){return!!c.hitMatrix};return a.filter(s)})},t.XRHitTestWithSelectEvent=function(e,i){var r=e.frame.getPose(e.inputSource.targetRaySpace,i);if(!r)return Promise.resolve([]);var o=new XRRay(r.transform);return this.XRHitTestWithRay(e.frame.session,o,i)},t.prototype.attach=function(){return n.prototype.attach.call(this)?(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0):!1},t.prototype.detach=function(){return n.prototype.detach.call(this)?(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onHitTestResultObservable.clear()},t.prototype._onXRFrame=function(e){if(!(!this.attached||this.options.testOnPointerDownOnly)){var i=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!!i){l.a.FromArrayToRef(i.transform.matrix,0,this._mat),l.e.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),l.e.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();var r=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});t.XRHitTestWithRay(this._xrSessionManager.session,r,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}},t.Name=ur.HIT_TEST,t.Version=1,t}(cr);or.AddWebXRFeature(_a.Name,function(n,t){return function(){return new _a(n,t)}},_a.Version,!1);var Nv=0,ya=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r._options=i,r._lastFrameDetected=new Set,r._trackedAnchors=[],r._futureAnchors=[],r.onAnchorAddedObservable=new g.c,r.onAnchorRemovedObservable=new g.c,r.onAnchorUpdatedObservable=new g.c,r._tmpVector=new l.e,r._tmpQuaternion=new l.b,r.xrNativeFeatureName="anchors",r}return Object.defineProperty(t.prototype,"referenceSpaceForFrameAnchors",{set:function(e){this._referenceSpaceForFrameAnchors=e},enumerable:!1,configurable:!0}),t.prototype._populateTmpTransformation=function(e,i){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(i),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}},t.prototype.addAnchorPointUsingHitTestResultAsync=function(e,i,r){return i===void 0&&(i=new l.e),r===void 0&&(r=new l.b),Object(p.b)(this,void 0,void 0,function(){var o,a,s,c=this;return Object(p.e)(this,function(_){switch(_.label){case 0:if(this._populateTmpTransformation(i,r),o=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),e.xrHitResult.createAnchor)return[3,1];throw this.detach(),new Error("Anchors not enabled in this environment/browser");case 1:return _.trys.push([1,3,,4]),[4,e.xrHitResult.createAnchor(o)];case 2:return a=_.sent(),[2,new Promise(function(b,C){c._futureAnchors.push({nativeAnchor:a,resolved:!1,submitted:!0,xrTransformation:o,resolve:b,reject:C})})];case 3:throw s=_.sent(),new Error(s);case 4:return[2]}})})},t.prototype.addAnchorAtPositionAndRotationAsync=function(e,i,r){return i===void 0&&(i=new l.b),r===void 0&&(r=!1),Object(p.b)(this,void 0,void 0,function(){var o,a,s,c=this;return Object(p.e)(this,function(_){switch(_.label){case 0:return this._populateTmpTransformation(e,i),o=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),r&&this.attached&&this._xrSessionManager.currentFrame?[4,this._createAnchorAtTransformation(o,this._xrSessionManager.currentFrame)]:[3,2];case 1:return s=_.sent(),[3,3];case 2:s=void 0,_.label=3;case 3:return a=s,[2,new Promise(function(b,C){c._futureAnchors.push({nativeAnchor:a,resolved:!1,submitted:!1,xrTransformation:o,resolve:b,reject:C})})]}})})},Object.defineProperty(t.prototype,"anchors",{get:function(){return this._trackedAnchors},enumerable:!1,configurable:!0}),t.prototype.detach=function(){if(!n.prototype.detach.call(this))return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){var e=this._trackedAnchors.pop();if(e){try{e.remove()}catch(i){}this.onAnchorRemovedObservable.notifyObservers(e)}}return!0},t.prototype.dispose=function(){this._futureAnchors.length=0,n.prototype.dispose.call(this),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()},t.prototype._onXRFrame=function(e){var i=this;if(!(!this.attached||!e)){var r=e.trackedAnchors;if(r){var o=this._trackedAnchors.filter(function(s){return!r.has(s.xrAnchor)}).map(function(s){var c=i._trackedAnchors.indexOf(s);return c}),a=0;o.forEach(function(s){var c=i._trackedAnchors.splice(s-a,1)[0];i.onAnchorRemovedObservable.notifyObservers(c),a++}),r.forEach(function(s){if(i._lastFrameDetected.has(s)){var x=i._findIndexInAnchorArray(s),_=i._trackedAnchors[x];try{i._updateAnchorWithXRFrame(s,_,e),_.attachedNode&&(_.attachedNode.rotationQuaternion=_.attachedNode.rotationQuaternion||new l.b,_.transformationMatrix.decompose(_.attachedNode.scaling,_.attachedNode.rotationQuaternion,_.attachedNode.position)),i.onAnchorUpdatedObservable.notifyObservers(_)}catch(D){re.b.Warn("Anchor could not be updated")}}else{var c={id:Nv++,xrAnchor:s,remove:function(){return s.delete()}},_=i._updateAnchorWithXRFrame(s,c,e);i._trackedAnchors.push(_),i.onAnchorAddedObservable.notifyObservers(_);var b=i._futureAnchors.filter(function(V){return V.nativeAnchor===s}),C=b[0];C&&(C.resolve(_),C.resolved=!0)}}),this._lastFrameDetected=r}this._futureAnchors.forEach(function(s){!s.resolved&&!s.submitted&&(i._createAnchorAtTransformation(s.xrTransformation,e).then(function(c){s.nativeAnchor=c},function(c){s.resolved=!0,s.reject(c)}),s.submitted=!0)})}},t.prototype._findIndexInAnchorArray=function(e){for(var i=0;i<this._trackedAnchors.length;++i)if(this._trackedAnchors[i].xrAnchor===e)return i;return-1},t.prototype._updateAnchorWithXRFrame=function(e,i,r){var o=r.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(o){var a=i.transformationMatrix||new l.a;l.a.FromArrayToRef(o.transform.matrix,0,a),this._xrSessionManager.scene.useRightHandedSystem||a.toggleModelMatrixHandInPlace(),i.transformationMatrix=a,this._options.worldParentNode&&a.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),a)}return i},t.prototype._createAnchorAtTransformation=function(e,i){var r;return Object(p.b)(this,void 0,void 0,function(){return Object(p.e)(this,function(o){if(i.createAnchor)try{return[2,i.createAnchor(e,(r=this._referenceSpaceForFrameAnchors)!==null&&r!==void 0?r:this._xrSessionManager.referenceSpace)]}catch(a){throw new Error(a)}else throw this.detach(),new Error("Anchors are not enabled in your browser");return[2]})})},t.Name=ur.ANCHOR_SYSTEM,t.Version=1,t}(cr);or.AddWebXRFeature(ya.Name,function(n,t){return function(){return new ya(n,t)}},ya.Version);var wv=0,ba=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r._options=i,r._detectedPlanes=[],r._enabled=!1,r._lastFrameDetected=new Set,r.onPlaneAddedObservable=new g.c,r.onPlaneRemovedObservable=new g.c,r.onPlaneUpdatedObservable=new g.c,r.xrNativeFeatureName="plane-detection",r._xrSessionManager.session?r._init():r._xrSessionManager.onXRSessionInit.addOnce(function(){r._init()}),r}return t.prototype.detach=function(){if(!n.prototype.detach.call(this))return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){var e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()},t.prototype.isCompatible=function(){return typeof XRPlane!="undefined"},t.prototype._onXRFrame=function(e){var i=this;if(!(!this.attached||!this._enabled||!e)){var r=e.worldInformation.detectedPlanes;if(r){var o=this._detectedPlanes.filter(function(s){return!r.has(s.xrPlane)}).map(function(s){return i._detectedPlanes.indexOf(s)}),a=0;o.forEach(function(s){var c=i._detectedPlanes.splice(s-a,1)[0];i.onPlaneRemovedObservable.notifyObservers(c),a++}),r.forEach(function(s){if(i._lastFrameDetected.has(s)){if(s.lastChangedTime===i._xrSessionManager.currentTimestamp){var b=i._findIndexInPlaneArray(s),_=i._detectedPlanes[b];i._updatePlaneWithXRPlane(s,_,e),i.onPlaneUpdatedObservable.notifyObservers(_)}}else{var c={id:wv++,xrPlane:s,polygonDefinition:[]},_=i._updatePlaneWithXRPlane(s,c,e);i._detectedPlanes.push(_),i.onPlaneAddedObservable.notifyObservers(_)}}),this._lastFrameDetected=r}}},t.prototype._init=function(){var e=this,i,r,o=function(){e._enabled=!0,e._detectedPlanes.length&&(e._detectedPlanes.length=0)};if(!!this._xrSessionManager.isNative&&!!this._options.preferredDetectorOptions&&!!this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),!this._xrSessionManager.session.updateWorldTrackingState){var a=(r=(i=this._xrSessionManager.session.worldTrackingState)===null||i===void 0?void 0:i.planeDetectionState)===null||r===void 0?void 0:r.enabled;a&&o();return}this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),o()},t.prototype._updatePlaneWithXRPlane=function(e,i,r){var o=this;i.polygonDefinition=e.polygon.map(function(c){var _=o._xrSessionManager.scene.useRightHandedSystem?1:-1;return new l.e(c.x,c.y,c.z*_)});var a=r.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(a){var s=i.transformationMatrix||new l.a;l.a.FromArrayToRef(a.transform.matrix,0,s),this._xrSessionManager.scene.useRightHandedSystem||s.toggleModelMatrixHandInPlace(),i.transformationMatrix=s,this._options.worldParentNode&&s.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),s)}return i},t.prototype._findIndexInPlaneArray=function(e){for(var i=0;i<this._detectedPlanes.length;++i)if(this._detectedPlanes[i].xrPlane===e)return i;return-1},t.Name=ur.PLANE_DETECTION,t.Version=1,t}(cr);or.AddWebXRFeature(ba.Name,function(n,t){return function(){return new ba(n,t)}},ba.Version);var Ea=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r.options=i,r.onBackgroundStateChangedObservable=new g.c,r}return t.prototype.attach=function(){return this._setBackgroundState(!1),n.prototype.attach.call(this)},t.prototype.detach=function(){return this._setBackgroundState(!0),n.prototype.detach.call(this)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onBackgroundStateChangedObservable.clear()},t.prototype._onXRFrame=function(e){},t.prototype._setBackgroundState=function(e){var i=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){var r=i.getMeshByName("BackgroundSkybox");r&&r.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){var o=i.getMeshByName("BackgroundPlane");o&&o.setEnabled(e)}}else{var a=i.getMeshByName("BackgroundHelper");a&&a.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach(function(s){return s.setEnabled(e)}),this.onBackgroundStateChangedObservable.notifyObservers(e)},t.Name=ur.BACKGROUND_REMOVER,t.Version=1,t}(cr);or.AddWebXRFeature(Ea.Name,function(n,t){return function(){return new Ea(n,t)}},Ea.Version,!0);var Vv=function(){function n(){}return n}(),Pa=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r._options=i,r._attachController=function(o){if(!r._controllers[o.uniqueId])if(r._xrSessionManager.scene.isPhysicsEnabled()||d.a.Warn("physics engine not enabled, skipped. Please add this controller manually."),r._options.physicsProperties.useControllerMesh&&o.inputSource.gamepad)o.onMotionControllerInitObservable.addOnce(function(C){C.onModelLoadedObservable.addOnce(function(){var x=new Xr.a(C.rootMesh,Xr.a.MeshImpostor,Object(p.a)({mass:0},r._options.physicsProperties)),V=o.grip||o.pointer;r._controllers[o.uniqueId]={xrController:o,impostor:x,oldPos:V.position.clone(),oldRotation:V.rotationQuaternion.clone()}})});else{var a=r._options.physicsProperties.impostorType||Xr.a.SphereImpostor,s=r._options.physicsProperties.impostorSize||.1,c=nr.a.CreateSphere("impostor-mesh-"+o.uniqueId,{diameterX:typeof s=="number"?s:s.width,diameterY:typeof s=="number"?s:s.height,diameterZ:typeof s=="number"?s:s.depth});c.isVisible=r._debugMode,c.isPickable=!1,c.rotationQuaternion=new l.b;var _=o.grip||o.pointer;c.position.copyFrom(_.position),c.rotationQuaternion.copyFrom(_.rotationQuaternion);var b=new Xr.a(c,a,Object(p.a)({mass:0},r._options.physicsProperties));r._controllers[o.uniqueId]={xrController:o,impostor:b,impostorMesh:c}}},r._controllers={},r._debugMode=!1,r._delta=0,r._lastTimestamp=0,r._tmpQuaternion=new l.b,r._tmpVector=new l.e,r._options.physicsProperties||(r._options.physicsProperties={}),r}return t.prototype._enablePhysicsDebug=function(){var e=this;this._debugMode=!0,Object.keys(this._controllers).forEach(function(i){var r=e._controllers[i];r.impostorMesh&&(r.impostorMesh.isVisible=!0)})},t.prototype.addController=function(e){this._attachController(e)},t.prototype.attach=function(){var e=this;if(!n.prototype.attach.call(this))return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(o){e._detachController(o.uniqueId)}),this._options.enableHeadsetImpostor){var i=this._options.headsetImpostorParams||{impostorType:Xr.a.SphereImpostor,restitution:.8,impostorSize:.3},r=i.impostorSize||.3;this._headsetMesh=nr.a.CreateSphere("headset-mesh",{diameterX:typeof r=="number"?r:r.width,diameterY:typeof r=="number"?r:r.height,diameterZ:typeof r=="number"?r:r.depth}),this._headsetMesh.rotationQuaternion=new l.b,this._headsetMesh.isVisible=!1,this._headsetImpostor=new Xr.a(this._headsetMesh,i.impostorType,Object(p.a)({mass:0},i))}return!0},t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(i){e._detachController(i)}),this._headsetMesh&&this._headsetMesh.dispose(),!0):!1},t.prototype.getHeadsetImpostor=function(){return this._headsetImpostor},t.prototype.getImpostorForController=function(e){var i=typeof e=="string"?e:e.uniqueId;return this._controllers[i]?this._controllers[i].impostor:null},t.prototype.setPhysicsProperties=function(e){this._options.physicsProperties=Object(p.a)(Object(p.a)({},this._options.physicsProperties),e)},t.prototype._onXRFrame=function(e){var i=this;this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.position),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion)),Object.keys(this._controllers).forEach(function(r){var o=i._controllers[r],a=o.xrController.grip||o.xrController.pointer,s=o.oldPos||o.impostorMesh.position,c=o.oldRotation||o.impostorMesh.rotationQuaternion;if(a.position.subtractToRef(s,i._tmpVector),i._tmpVector.scaleInPlace(1e3/i._delta),o.impostor.setLinearVelocity(i._tmpVector),i._debugMode&&console.log(i._tmpVector,"linear"),!c.equalsWithEpsilon(a.rotationQuaternion)){c.conjugateInPlace().multiplyToRef(a.rotationQuaternion,i._tmpQuaternion);var _=Math.sqrt(i._tmpQuaternion.x*i._tmpQuaternion.x+i._tmpQuaternion.y*i._tmpQuaternion.y+i._tmpQuaternion.z*i._tmpQuaternion.z);if(i._tmpVector.set(i._tmpQuaternion.x,i._tmpQuaternion.y,i._tmpQuaternion.z),_<.001)i._tmpVector.scaleInPlace(2);else{var b=2*Math.atan2(_,i._tmpQuaternion.w);i._tmpVector.scaleInPlace(b/(_*(i._delta/1e3)))}o.impostor.setAngularVelocity(i._tmpVector),i._debugMode&&console.log(i._tmpVector,i._tmpQuaternion,"angular")}s.copyFrom(a.position),c.copyFrom(a.rotationQuaternion)})},t.prototype._detachController=function(e){var i=this._controllers[e];!i||(i.impostorMesh&&i.impostorMesh.dispose(),delete this._controllers[e])},t.Name=ur.PHYSICS_CONTROLLERS,t.Version=1,t}(cr);or.AddWebXRFeature(Pa.Name,function(n,t){return function(){return new Pa(n,t)}},Pa.Version,!0);var Ca=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r.options=i,r._tmpMat=new l.a,r._tmpPos=new l.e,r._tmpQuat=new l.b,r.initHitTestSource=function(o){if(!!o){var a=new XRRay(r.options.offsetRay||{}),s={space:r.options.useReferenceSpace?o:r._xrSessionManager.viewerReferenceSpace,offsetRay:a};if(r.options.entityTypes&&(s.entityTypes=r.options.entityTypes),!s.space){re.b.Warn("waiting for viewer reference space to initialize");return}r._xrSessionManager.session.requestHitTestSource(s).then(function(c){r._xrHitTestSource&&r._xrHitTestSource.cancel(),r._xrHitTestSource=c})}},r.autoCloneTransformation=!1,r.onHitTestResultObservable=new g.c,r.paused=!1,r.xrNativeFeatureName="hit-test",re.b.Warn("Hit test is an experimental and unstable feature."),r}return t.prototype.attach=function(){var e=this;if(!n.prototype.attach.call(this)||!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this.initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this.initHitTestSource)),this.options.enableTransientHitTest){var i=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:"generic-touchscreen",offsetRay:i,entityTypes:this.options.entityTypes}).then(function(r){e._transientXrHitTestSource=r})}return!0},t.prototype.detach=function(){return n.prototype.detach.call(this)?(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this.initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onHitTestResultObservable.clear()},t.prototype._onXRFrame=function(e){var i=this;if(!(!this.attached||this.paused)){if(this._xrHitTestSource){var r=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(r)}if(this._transientXrHitTestSource){var o=e.getHitTestResultsForTransientInput(this._transientXrHitTestSource);o.forEach(function(a){i._processWebXRHitTestResult(a.results,a.inputSource)})}}},t.prototype._processWebXRHitTestResult=function(e,i){var r=this,o=[];e.forEach(function(a){var s=a.getPose(r._xrSessionManager.referenceSpace);if(!!s){var c=s.transform.position,_=s.transform.orientation;r._tmpPos.set(c.x,c.y,c.z),r._tmpQuat.set(_.x,_.y,_.z,_.w),l.a.FromFloat32ArrayToRefScaled(s.transform.matrix,0,1,r._tmpMat),r._xrSessionManager.scene.useRightHandedSystem||(r._tmpPos.z*=-1,r._tmpQuat.z*=-1,r._tmpQuat.w*=-1,r._tmpMat.toggleModelMatrixHandInPlace());var b={position:r.autoCloneTransformation?r._tmpPos.clone():r._tmpPos,rotationQuaternion:r.autoCloneTransformation?r._tmpQuat.clone():r._tmpQuat,transformationMatrix:r.autoCloneTransformation?r._tmpMat.clone():r._tmpMat,inputSource:i,isTransient:!!i,xrHitResult:a};o.push(b)}}),this.onHitTestResultObservable.notifyObservers(o)},t.Name=ur.HIT_TEST,t.Version=2,t}(cr);or.AddWebXRFeature(Ca.Name,function(n,t){return function(){return new Ca(n,t)}},Ca.Version,!1);var Sa=function(n){Object(p.d)(t,n);function t(e){var i=n.call(this,e)||this;return i._enabled=!1,i._featurePointCloud=[],i.onFeaturePointsAddedObservable=new g.c,i.onFeaturePointsUpdatedObservable=new g.c,i.xrNativeFeatureName="bjsfeature-points",i._xrSessionManager.session?i._init():i._xrSessionManager.onXRSessionInit.addOnce(function(){i._init()}),i}return Object.defineProperty(t.prototype,"featurePointCloud",{get:function(){return this._featurePointCloud},enumerable:!1,configurable:!0}),t.prototype.detach=function(){return n.prototype.detach.call(this)?(this.featurePointCloud.length=0,!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()},t.prototype._onXRFrame=function(e){if(!(!this.attached||!this._enabled||!e)){var i=e.featurePointCloud;if(!(!i||i.length===0)){if(i.length%5!=0)throw new Error("Received malformed feature point cloud of length: "+i.length);for(var r=i.length/5,o=new Array,a=new Array,s=0;s<r;s++){var c=s*5,_=i[c+4];this._featurePointCloud[_]?o.push(_):(this._featurePointCloud[_]={position:new l.e,confidenceValue:0},a.push(_)),this._featurePointCloud[_].position.x=i[c],this._featurePointCloud[_].position.y=i[c+1],this._featurePointCloud[_].position.z=i[c+2],this._featurePointCloud[_].confidenceValue=i[c+3]}a.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(a),o.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(o)}}},t.prototype._init=function(){!this._xrSessionManager.session.trySetFeaturePointCloudEnabled||!this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)||(this._enabled=!0)},t.Name=ur.FEATURE_POINTS,t.Version=1,t}(cr);or.AddWebXRFeature(Sa.Name,function(n){return function(){return new Sa(n)}},Sa.Version);var Et;(function(n){n.wrist="wrist",n["thumb-metacarpal"]="thumb-metacarpal",n["thumb-phalanx-proximal"]="thumb-phalanx-proximal",n["thumb-phalanx-distal"]="thumb-phalanx-distal",n["thumb-tip"]="thumb-tip",n["index-finger-metacarpal"]="index-finger-metacarpal",n["index-finger-phalanx-proximal"]="index-finger-phalanx-proximal",n["index-finger-phalanx-intermediate"]="index-finger-phalanx-intermediate",n["index-finger-phalanx-distal"]="index-finger-phalanx-distal",n["index-finger-tip"]="index-finger-tip",n["middle-finger-metacarpal"]="middle-finger-metacarpal",n["middle-finger-phalanx-proximal"]="middle-finger-phalanx-proximal",n["middle-finger-phalanx-intermediate"]="middle-finger-phalanx-intermediate",n["middle-finger-phalanx-distal"]="middle-finger-phalanx-distal",n["middle-finger-tip"]="middle-finger-tip",n["ring-finger-metacarpal"]="ring-finger-metacarpal",n["ring-finger-phalanx-proximal"]="ring-finger-phalanx-proximal",n["ring-finger-phalanx-intermediate"]="ring-finger-phalanx-intermediate",n["ring-finger-phalanx-distal"]="ring-finger-phalanx-distal",n["ring-finger-tip"]="ring-finger-tip",n["pinky-finger-metacarpal"]="pinky-finger-metacarpal",n["pinky-finger-phalanx-proximal"]="pinky-finger-phalanx-proximal",n["pinky-finger-phalanx-intermediate"]="pinky-finger-phalanx-intermediate",n["pinky-finger-phalanx-distal"]="pinky-finger-phalanx-distal",n["pinky-finger-tip"]="pinky-finger-tip"})(Et||(Et={}));var qd=[Et.wrist,Et["thumb-metacarpal"],Et["thumb-phalanx-proximal"],Et["thumb-phalanx-distal"],Et["thumb-tip"],Et["index-finger-metacarpal"],Et["index-finger-phalanx-proximal"],Et["index-finger-phalanx-intermediate"],Et["index-finger-phalanx-distal"],Et["index-finger-tip"],Et["middle-finger-metacarpal"],Et["middle-finger-phalanx-proximal"],Et["middle-finger-phalanx-intermediate"],Et["middle-finger-phalanx-distal"],Et["middle-finger-tip"],Et["ring-finger-metacarpal"],Et["ring-finger-phalanx-proximal"],Et["ring-finger-phalanx-intermediate"],Et["ring-finger-phalanx-distal"],Et["ring-finger-tip"],Et["pinky-finger-metacarpal"],Et["pinky-finger-phalanx-proximal"],Et["pinky-finger-phalanx-intermediate"],Et["pinky-finger-phalanx-distal"],Et["pinky-finger-tip"]],ep=function(){function n(t,e,i,r,o,a,s){var c=this;this.xrController=t,this.trackedMeshes=e,this._handMesh=i,this._rigMapping=r,this._nearInteractionMesh=a,this._leftHandedMeshes=s,this._defaultHandMesh=!1,this._transformNodeMapping=[],this._boneMapping=[],this._useBones=!1,this.onHandMeshReadyObservable=new g.c,this.handPartsDefinition=this.generateHandPartsDefinition(),this._scene=e.get("wrist").getScene(),this.onHandMeshReadyObservable.add(function(){if(!!c._rigMapping){var _=c._scene.getTransformNodeByName(c._rigMapping[0]);if(!_){var b=c._scene.getBoneByName(c._rigMapping[0]);b&&(c._useBones=!0)}}}),this._handMesh&&this._rigMapping?(this._defaultHandMesh=!1,this._handMesh.alwaysSelectAsActiveMesh=!0,this._handMesh.getChildMeshes().forEach(function(_){return _.alwaysSelectAsActiveMesh=!0}),this.onHandMeshReadyObservable.notifyObservers(this)):o||this._generateDefaultHandMesh(),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add(function(_){_.rootMesh&&_.rootMesh.setEnabled(!1)})),this.xrController.onMotionControllerInitObservable.add(function(_){_.onModelLoadedObservable.add(function(b){b.rootMesh&&b.rootMesh.setEnabled(!1)}),_.rootMesh&&_.rootMesh.setEnabled(!1)})}return n.prototype.generateHandPartsDefinition=function(){var t;return t={},t.wrist=[Et.wrist],t.thumb=[Et["thumb-metacarpal"],Et["thumb-phalanx-proximal"],Et["thumb-phalanx-distal"],Et["thumb-tip"]],t.index=[Et["index-finger-metacarpal"],Et["index-finger-phalanx-proximal"],Et["index-finger-phalanx-intermediate"],Et["index-finger-phalanx-distal"],Et["index-finger-tip"]],t.middle=[Et["middle-finger-metacarpal"],Et["middle-finger-phalanx-proximal"],Et["middle-finger-phalanx-intermediate"],Et["middle-finger-phalanx-distal"],Et["middle-finger-tip"]],t.ring=[Et["ring-finger-metacarpal"],Et["ring-finger-phalanx-proximal"],Et["ring-finger-phalanx-intermediate"],Et["ring-finger-phalanx-distal"],Et["ring-finger-tip"]],t.little=[Et["pinky-finger-metacarpal"],Et["pinky-finger-phalanx-proximal"],Et["pinky-finger-phalanx-intermediate"],Et["pinky-finger-phalanx-distal"],Et["pinky-finger-tip"]],t},Object.defineProperty(n.prototype,"handMesh",{get:function(){return this._handMesh},enumerable:!1,configurable:!0}),n.prototype.updateFromXRFrame=function(t,e,i){var r=this;i===void 0&&(i=2);var o=this.xrController.inputSource.hand;if(!!o&&(this.trackedMeshes.forEach(function(s,c){var _=o.get(c);if(_){var b=t.getJointPose(_,e);if(!b||!b.transform)return;var C=b.transform.position,x=b.transform.orientation;s.position.set(C.x,C.y,C.z),s.rotationQuaternion.set(x.x,x.y,x.z,x.w);var V=(b.radius||.008)*i;if(s.scaling.set(V,V,V),r._leftHandedMeshes&&!s.getScene().useRightHandedSystem&&(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1),r._handMesh&&r._rigMapping){var D=qd.indexOf(c);r._rigMapping[D]&&(r._useBones?(r._boneMapping[D]=r._boneMapping[D]||r._scene.getBoneByName(r._rigMapping[D]),r._boneMapping[D]&&(r._boneMapping[D].setPosition(s.position),r._boneMapping[D].setRotationQuaternion(s.rotationQuaternion),s.isVisible=!1)):(r._transformNodeMapping[D]=r._transformNodeMapping[D]||r._scene.getTransformNodeByName(r._rigMapping[D]),r._transformNodeMapping[D]&&(r._transformNodeMapping[D].position.copyFrom(s.position),r._transformNodeMapping[D].rotationQuaternion.copyFrom(s.rotationQuaternion),s.isVisible=!1)))}!r._leftHandedMeshes&&!s.getScene().useRightHandedSystem&&(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1)}}),this._nearInteractionMesh&&this.trackedMeshes.has("index-finger-tip"))){var a=this.trackedMeshes.get("index-finger-tip").position;this._nearInteractionMesh.position.set(a.x,a.y,a.z)}},n.prototype.getHandPartMeshes=function(t){var e=this;return this.handPartsDefinition[t].map(function(i){return e.trackedMeshes.get(i)})},n.prototype.dispose=function(){var t;this.trackedMeshes.forEach(function(e){return e.dispose()}),(t=this._nearInteractionMesh)===null||t===void 0||t.dispose(),this.onHandMeshReadyObservable.clear(),this._defaultHandMesh&&this._handMesh&&this._handMesh.dispose()},n.prototype._generateDefaultHandMesh=function(){return Object(p.b)(this,void 0,void 0,function(){var t,e,i,r,o,a,s,c;return Object(p.e)(this,function(_){switch(_.label){case 0:return _.trys.push([0,3,,4]),t=this.xrController.inputSource.handedness==="right"?"right":"left",e=(t==="right"?"r":"l")+"_hand_"+(this._scene.useRightHandedSystem?"r":"l")+"hs.glb",[4,Mi.a.ImportMeshAsync("","https://assets.babylonjs.com/meshes/HandMeshes/",e,this._scene)];case 1:return i=_.sent(),r={base:v.a.FromInts(116,63,203),fresnel:v.a.FromInts(149,102,229),fingerColor:v.a.FromInts(177,130,255),tipFresnel:v.a.FromInts(220,200,255)},o=new oa("leftHandShader",this._scene,{emitComments:!1}),[4,o.loadAsync("https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json")];case 2:if(_.sent(),o.build(!1),o.needDepthPrePass=!0,o.transparencyMode=Yi.a.MATERIAL_ALPHABLEND,o.alphaMode=G.a.ALPHA_COMBINE,a={base:o.getBlockByName("baseColor"),fresnel:o.getBlockByName("fresnelColor"),fingerColor:o.getBlockByName("fingerColor"),tipFresnel:o.getBlockByName("tipFresnelColor")},a.base.value=r.base,a.fresnel.value=r.fresnel,a.fingerColor.value=r.fingerColor,a.tipFresnel.value=r.tipFresnel,i.meshes[1].material=o,i.meshes[1].alwaysSelectAsActiveMesh=!0,this._defaultHandMesh=!0,this._handMesh=i.meshes[0],this._rigMapping=["wrist_","thumb_metacarpal_","thumb_proxPhalanx_","thumb_distPhalanx_","thumb_tip_","index_metacarpal_","index_proxPhalanx_","index_intPhalanx_","index_distPhalanx_","index_tip_","middle_metacarpal_","middle_proxPhalanx_","middle_intPhalanx_","middle_distPhalanx_","middle_tip_","ring_metacarpal_","ring_proxPhalanx_","ring_intPhalanx_","ring_distPhalanx_","ring_tip_","little_metacarpal_","little_proxPhalanx_","little_intPhalanx_","little_distPhalanx_","little_tip_"].map(function(b){return""+b+(t==="right"?"R":"L")}),s=this._scene.getTransformNodeByName(this._rigMapping[0]),s)s.parent&&s.parent.rotate(Le.a.Y,Math.PI);else throw new Error("could not find the wrist node");return this.onHandMeshReadyObservable.notifyObservers(this),[3,4];case 3:return c=_.sent(),re.b.Error("error loading hand mesh"),console.log(c),[3,4];case 4:return[2]}})})},n}(),Ta=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.options=i,r.onHandAddedObservable=new g.c,r.onHandRemovedObservable=new g.c,r._hands={},r._attachHand=function(o){var a,s,c,_,b,C,x,V,D,z,q,ue;if(!(!o.inputSource.hand||r._hands[o.uniqueId])){var ge=o.inputSource.hand,Se=new Map,Pe=((a=r.options.jointMeshes)===null||a===void 0?void 0:a.sourceMesh)||nr.a.CreateSphere("jointParent",{diameter:1});Pe.scaling.set(.01,.01,.01),Pe.isVisible=!!((s=r.options.jointMeshes)===null||s===void 0?void 0:s.keepOriginalVisible);for(var me=0;me<ge.size;++me){var xe=Pe.createInstance(o.uniqueId+"-handJoint-"+me);if((c=r.options.jointMeshes)===null||c===void 0?void 0:c.onHandJointMeshGenerated){var Fe=r.options.jointMeshes.onHandJointMeshGenerated(xe,me,o.uniqueId);Fe&&Fe!==xe&&(xe.dispose(),xe=Fe)}if(xe.isPickable=!1,(_=r.options.jointMeshes)===null||_===void 0?void 0:_.enablePhysics){var we=r.options.jointMeshes.physicsProps||{},Ge=we.impostorType!==void 0?we.impostorType:Xr.a.SphereImpostor;xe.physicsImpostor=new Xr.a(xe,Ge,Object(p.a)({mass:0},we))}xe.rotationQuaternion=new l.b,((b=r.options.jointMeshes)===null||b===void 0?void 0:b.invisible)&&(xe.isVisible=!1),Se.set(qd[me],xe)}var Xe=null;((C=r.options.jointMeshes)===null||C===void 0?void 0:C.sceneForNearInteraction)&&(Xe=nr.a.CreateSphere(o.uniqueId+"-handJoint-indexCollidable",{},r.options.jointMeshes.sceneForNearInteraction),Xe.isVisible=!1,Zd.a.AddTagsTo(Xe,"touchEnabled"));var Oe=o.inputSource.handedness==="right"?"right":"left",je=((x=r.options.jointMeshes)===null||x===void 0?void 0:x.handMeshes)&&((V=r.options.jointMeshes)===null||V===void 0?void 0:V.handMeshes[Oe]),ke=((D=r.options.jointMeshes)===null||D===void 0?void 0:D.rigMapping)&&((z=r.options.jointMeshes)===null||z===void 0?void 0:z.rigMapping[Oe]),ze=new ep(o,Se,je,ke,(q=r.options.jointMeshes)===null||q===void 0?void 0:q.disableDefaultHandMesh,Xe,(ue=r.options.jointMeshes)===null||ue===void 0?void 0:ue.leftHandedSystemMeshes);r._hands[o.uniqueId]={handObject:ze,id:t._idCounter++},r.onHandAddedObservable.notifyObservers(ze)}},r.xrNativeFeatureName="hand-tracking",r}return t.prototype.isCompatible=function(){return typeof XRHand!="undefined"},t.prototype.attach=function(){var e=this;return n.prototype.attach.call(this)?(this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,function(i){e._detachHand(i.uniqueId)}),!0):!1},t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(Object.keys(this._hands).forEach(function(i){e._detachHand(i)}),!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onHandAddedObservable.clear()},t.prototype.getHandByControllerId=function(e){var i;return((i=this._hands[e])===null||i===void 0?void 0:i.handObject)||null},t.prototype.getHandByHandedness=function(e){var i=this,r=Object.keys(this._hands).map(function(a){return i._hands[a].handObject.xrController.inputSource.handedness}),o=r.indexOf(e);return o!==-1?this._hands[o].handObject:null},t.prototype._onXRFrame=function(e){var i=this;Object.keys(this._hands).forEach(function(r){var o;i._hands[r].handObject.updateFromXRFrame(e,i._xrSessionManager.referenceSpace,(o=i.options.jointMeshes)===null||o===void 0?void 0:o.scaleFactor)})},t.prototype._detachHand=function(e){this._hands[e]&&(this.onHandRemovedObservable.notifyObservers(this._hands[e].handObject),this._hands[e].handObject.dispose(),delete this._hands[e])},t._idCounter=0,t.Name=ur.HAND_TRACKING,t.Version=1,t}(cr);or.AddWebXRFeature(Ta.Name,function(n,t){return function(){return new Ta(n,t)}},Ta.Version,!1);var Uv=0,Aa=function(n){Object(p.d)(t,n);function t(e,i){i===void 0&&(i={});var r=n.call(this,e)||this;return r._options=i,r._detectedMeshes=new Map,r.onMeshAddedObservable=new g.c,r.onMeshRemovedObservable=new g.c,r.onMeshUpdatedObservable=new g.c,r.xrNativeFeatureName="mesh-detection",r._xrSessionManager.session?r._init():r._xrSessionManager.onXRSessionInit.addOnce(function(){r._init()}),r}return t.prototype.detach=function(){var e=this;return n.prototype.detach.call(this)?(!!this._xrSessionManager.isNative&&!!this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach(function(i){e.onMeshRemovedObservable.notifyObservers(i)}),this._detectedMeshes.clear()),!0):!1},t.prototype.dispose=function(){n.prototype.dispose.call(this),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()},t.prototype._onXRFrame=function(e){var i=this,r;try{if(!this.attached||!e)return;var o=(r=e.worldInformation)===null||r===void 0?void 0:r.detectedMeshes;if(o){var a=new Set;this._detectedMeshes.forEach(function(s,c){o.has(c)||a.add(c)}),a.forEach(function(s){var c=i._detectedMeshes.get(s);c&&(i.onMeshRemovedObservable.notifyObservers(c),i._detectedMeshes.delete(s))}),o.forEach(function(s){if(i._detectedMeshes.has(s)){if(s.lastChangedTime===i._xrSessionManager.currentTimestamp){var _=i._detectedMeshes.get(s);_&&(i._updateVertexDataWithXRMesh(s,_,e),i.onMeshUpdatedObservable.notifyObservers(_))}}else{var c={id:Uv++,xrMesh:s},_=i._updateVertexDataWithXRMesh(s,c,e);i._detectedMeshes.set(s,_),i.onMeshAddedObservable.notifyObservers(_)}})}}catch(s){console.log(s.stack)}},t.prototype._init=function(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),!!this._options.preferredDetectorOptions&&!!this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))},t.prototype._updateVertexDataWithXRMesh=function(e,i,r){if(i.xrMesh=e,i.worldParentNode=this._options.worldParentNode,this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)i.positions=e.positions,i.normals=e.normals;else{i.positions=new Float32Array(e.positions.length);for(var o=0;o<e.positions.length;o+=3)i.positions[o]=e.positions[o],i.positions[o+1]=e.positions[o+1],i.positions[o+2]=-1*e.positions[o+2];if(e.normals){i.normals=new Float32Array(e.normals.length);for(var o=0;o<e.normals.length;o+=3)i.normals[o]=e.normals[o],i.normals[o+1]=e.normals[o+1],i.normals[o+2]=-1*e.normals[o+2]}}i.indices=e.indices;var a=r.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(a){var s=i.transformationMatrix||new tt.k;tt.k.FromArrayToRef(a.transform.matrix,0,s),this._xrSessionManager.scene.useRightHandedSystem||s.toggleModelMatrixHandInPlace(),i.transformationMatrix=s,this._options.worldParentNode&&s.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),s)}}return i},t.Name=ur.MESH_DETECTION,t.Version=1,t}(cr);or.AddWebXRFeature(Aa.Name,function(n,t){return function(){return new Aa(n,t)}},Aa.Version,!1);var Ra=function(n){Object(p.d)(t,n);function t(e,i){var r=n.call(this,e)||this;return r.options=i,r.onUntrackableImageFoundObservable=new g.c,r.onTrackableImageFoundObservable=new g.c,r.onTrackedImageUpdatedObservable=new g.c,r._trackedImages=[],r.xrNativeFeatureName="image-tracking",r.options.images.length===0||(r._xrSessionManager.session?r._init():r._xrSessionManager.onXRSessionInit.addOnce(function(){r._init()})),r}return t.prototype.attach=function(){return n.prototype.attach.call(this)},t.prototype.detach=function(){return n.prototype.detach.call(this)},t.prototype.isCompatible=function(){return typeof XRImageTrackingResult!="undefined"},t.prototype.getTrackedImageById=function(e){return this._trackedImages[e]||null},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._trackedImages.forEach(function(e){e.originalBitmap.close()}),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()},t.prototype.getXRSessionInitExtension=function(){return Object(p.b)(this,void 0,void 0,function(){var e,i,r=this;return Object(p.e)(this,function(o){switch(o.label){case 0:return!this.options.images||!this.options.images.length?[2,{}]:(e=this.options.images.map(function(a){if(typeof a.src=="string"){var s=new Promise(function(c,_){if(typeof a.src=="string"){var b=new Image;b.src=a.src,b.onload=function(){b.decode().then(function(){createImageBitmap(b).then(function(C){c(C)})})},b.onerror=function(){re.b.Error("Error loading image "+a.src),_("Error loading image "+a.src)}}});return s}else return Promise.resolve(a.src)}),[4,Promise.all(e)]);case 1:return i=o.sent(),this._originalTrackingRequest=i.map(function(a,s){return{image:a,widthInMeters:r.options.images[s].estimatedRealWorldWidth}}),[2,{trackedImages:this._originalTrackingRequest}]}})})},t.prototype._onXRFrame=function(e){if(!!e.getImageTrackingResults)for(var i=e.getImageTrackingResults(),r=0,o=i;r<o.length;r++){var a=o[r],s=!1,c=a.index,_=this._trackedImages[c];if(!!_){_.xrTrackingResult=a,_.realWorldWidth!==a.measuredWidthInMeters&&(_.realWorldWidth=a.measuredWidthInMeters,s=!0);var b=e.getPose(a.imageSpace,this._xrSessionManager.referenceSpace);if(b){var C=_.transformationMatrix;l.a.FromArrayToRef(b.transform.matrix,0,C),this._xrSessionManager.scene.useRightHandedSystem||C.toggleModelMatrixHandInPlace(),s=!0}var x=a.trackingState,V=x==="emulated";_.emulated!==V&&(_.emulated=V,s=!0),s&&this.onTrackedImageUpdatedObservable.notifyObservers(_)}}},t.prototype._init=function(){return Object(p.b)(this,void 0,void 0,function(){var e,i,r,o;return Object(p.e)(this,function(a){switch(a.label){case 0:return this._xrSessionManager.session.getTrackedImageScores?[4,this._xrSessionManager.session.getTrackedImageScores()]:[2];case 1:for(e=a.sent(),i=0;i<e.length;++i)e[i]=="untrackable"?this.onUntrackableImageFoundObservable.notifyObservers(i):(r=this._originalTrackingRequest[i].image,o={id:i,originalBitmap:r,transformationMatrix:new l.a,ratio:r.width/r.height},this._trackedImages[i]=o,this.onTrackableImageFoundObservable.notifyObservers(o));return[2]}})})},t.Name=ur.IMAGE_TRACKING,t.Version=1,t}(cr);or.AddWebXRFeature(Ra.Name,function(n,t){return function(){return new Ra(n,t)}},Ra.Version,!1);var tp=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,Gv["left-right"],i,r)||this;return o._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},o.profileId="microsoft-mixed-reality",o}return t.prototype._getFilenameAndPath=function(){var e="";this.handedness==="left"?e=t.MODEL_LEFT_FILENAME:e=t.MODEL_RIGHT_FILENAME;var i="default",r=t.MODEL_BASE_URL+i+"/";return{filename:e,path:r}},t.prototype._getModelLoadingConstraints=function(){var e=Mi.a.IsPluginForExtensionAvailable(".glb");return e||d.a.Warn("glTF / glb loaded was not registered, using generic controller instead"),e},t.prototype._processLoadedModel=function(e){var i=this;!this.rootMesh||(this.getComponentIds().forEach(function(r,o){if(!i.disableAnimation&&r&&i.rootMesh){var a=i._mapping.buttons[r],s=a.rootNodeName;if(!s){d.a.Log("Skipping unknown button at index: "+o+" with mapped name: "+r);return}var c=i._getChildByName(i.rootMesh,s);if(!c){d.a.Warn("Missing button mesh with name: "+s);return}if(a.valueMesh=i._getImmediateChildByName(c,i._mapping.defaultButton.valueNodeName),a.pressedMesh=i._getImmediateChildByName(c,i._mapping.defaultButton.pressedNodeName),a.unpressedMesh=i._getImmediateChildByName(c,i._mapping.defaultButton.unpressedNodeName),a.valueMesh&&a.pressedMesh&&a.unpressedMesh){var _=i.getComponent(r);_&&_.onButtonStateChangedObservable.add(function(b){i._lerpTransform(a,b.value)},void 0,!0)}else d.a.Warn("Missing button submesh under mesh with name: "+s)}}),this.getComponentIds().forEach(function(r,o){var a=i.getComponent(r);!a.isAxes()||["x-axis","y-axis"].forEach(function(s){if(!!i.rootMesh){var c=i._mapping.axes[r][s],_=i._getChildByName(i.rootMesh,c.rootNodeName);if(!_){d.a.Warn("Missing axis mesh with name: "+c.rootNodeName);return}c.valueMesh=i._getImmediateChildByName(_,i._mapping.defaultAxis.valueNodeName),c.minMesh=i._getImmediateChildByName(_,i._mapping.defaultAxis.minNodeName),c.maxMesh=i._getImmediateChildByName(_,i._mapping.defaultAxis.maxNodeName),c.valueMesh&&c.minMesh&&c.maxMesh?a&&a.onAxisValueChangedObservable.add(function(b){var C=s==="x-axis"?b.x:b.y;i._lerpTransform(c,C,!0)},void 0,!0):d.a.Warn("Missing axis submesh under mesh with name: "+c.rootNodeName)}})}))},t.prototype._setRootMesh=function(e){this.rootMesh=new st.a(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(var i,r=0;r<e.length;r++){var o=e[r];o.isPickable=!1,o.parent||(i=o)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0))},t.prototype._updateModel=function(){},t.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",t.MODEL_LEFT_FILENAME="left.glb",t.MODEL_RIGHT_FILENAME="right.glb",t}(Rn);ar.RegisterController("windows-mixed-reality",function(n,t){return new tp(t,n.gamepad,n.handedness)});var Gv={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}},dl=function(n){Object(p.d)(t,n);function t(e,i,r,o,a){o===void 0&&(o=!1),a===void 0&&(a=!1);var s=n.call(this,e,zv[r],i,r)||this;return s._forceLegacyControllers=a,s.profileId="oculus-touch",s}return t.prototype._getFilenameAndPath=function(){var e="";this.handedness==="left"?e=t.MODEL_LEFT_FILENAME:e=t.MODEL_RIGHT_FILENAME;var i=this._isQuest()?t.QUEST_MODEL_BASE_URL:t.MODEL_BASE_URL;return{filename:e,path:i}},t.prototype._getModelLoadingConstraints=function(){return!0},t.prototype._processLoadedModel=function(e){var i=this,r=this._isQuest(),o=this.handedness==="right"?-1:1;this.getComponentIds().forEach(function(a){var s=a&&i.getComponent(a);s&&s.onButtonStateChangedObservable.add(function(c){if(!(!i.rootMesh||i.disableAnimation))switch(a){case"xr-standard-trigger":r||(i._modelRootNode.getChildren()[3].rotation.x=-c.value*.2,i._modelRootNode.getChildren()[3].position.y=-c.value*.005,i._modelRootNode.getChildren()[3].position.z=-c.value*.005);return;case"xr-standard-squeeze":r||(i._modelRootNode.getChildren()[4].position.x=o*c.value*.0035);return;case"xr-standard-thumbstick":return;case"a-button":case"x-button":r||(c.pressed?i._modelRootNode.getChildren()[1].position.y=-.001:i._modelRootNode.getChildren()[1].position.y=0);return;case"b-button":case"y-button":r||(c.pressed?i._modelRootNode.getChildren()[2].position.y=-.001:i._modelRootNode.getChildren()[2].position.y=0);return}},void 0,!0)})},t.prototype._setRootMesh=function(e){this.rootMesh=new st.a(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0)),e.forEach(function(i){i.isPickable=!1}),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh},t.prototype._updateModel=function(){},t.prototype._isQuest=function(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers},t.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",t.MODEL_LEFT_FILENAME="left.babylon",t.MODEL_RIGHT_FILENAME="right.babylon",t.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",t}(Rn);ar.RegisterController("oculus-touch",function(n,t){return new dl(t,n.gamepad,n.handedness)}),ar.RegisterController("oculus-touch-legacy",function(n,t){return new dl(t,n.gamepad,n.handedness,!0)});var zv={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}},ip=function(n){Object(p.d)(t,n);function t(e,i,r){var o=n.call(this,e,jv[r],i,r)||this;return o.profileId="htc-vive",o}return t.prototype._getFilenameAndPath=function(){var e=t.MODEL_FILENAME,i=t.MODEL_BASE_URL;return{filename:e,path:i}},t.prototype._getModelLoadingConstraints=function(){return!0},t.prototype._processLoadedModel=function(e){var i=this;this.getComponentIds().forEach(function(r){var o=r&&i.getComponent(r);o&&o.onButtonStateChangedObservable.add(function(a){if(!(!i.rootMesh||i.disableAnimation))switch(r){case"xr-standard-trigger":i._modelRootNode.getChildren()[6].rotation.x=-a.value*.15;return;case"xr-standard-touchpad":return;case"xr-standard-squeeze":return}},void 0,!0)})},t.prototype._setRootMesh=function(e){this.rootMesh=new st.a(this.profileId+" "+this.handedness,this.scene),e.forEach(function(i){i.isPickable=!1}),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=l.b.FromEulerAngles(0,Math.PI,0))},t.prototype._updateModel=function(){},t.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",t.MODEL_FILENAME="wand.babylon",t}(Rn);ar.RegisterController("htc-vive",function(n,t){return new ip(t,n.gamepad,n.handedness)});var jv={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}}},743:function(Ue,P,u){"use strict";u.d(P,"a",function(){return S});/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var T=function(Q,G){return T=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(K,fe){K.__proto__=fe}||function(K,fe){for(var ce in fe)Object.prototype.hasOwnProperty.call(fe,ce)&&(K[ce]=fe[ce])},T(Q,G)};function S(Q,G){if(typeof G!="function"&&G!==null)throw new TypeError("Class extends value "+String(G)+" is not a constructor or null");T(Q,G);function K(){this.constructor=Q}Q.prototype=G===null?Object.create(G):(K.prototype=G.prototype,new K)}var j=function(){return j=Object.assign||function(G){for(var K,fe=1,ce=arguments.length;fe<ce;fe++){K=arguments[fe];for(var re in K)Object.prototype.hasOwnProperty.call(K,re)&&(G[re]=K[re])}return G},j.apply(this,arguments)};function O(Q,G){var K={};for(var fe in Q)Object.prototype.hasOwnProperty.call(Q,fe)&&G.indexOf(fe)<0&&(K[fe]=Q[fe]);if(Q!=null&&typeof Object.getOwnPropertySymbols=="function")for(var ce=0,fe=Object.getOwnPropertySymbols(Q);ce<fe.length;ce++)G.indexOf(fe[ce])<0&&Object.prototype.propertyIsEnumerable.call(Q,fe[ce])&&(K[fe[ce]]=Q[fe[ce]]);return K}function M(Q,G,K,fe){var ce=arguments.length,re=ce<3?G:fe===null?fe=Object.getOwnPropertyDescriptor(G,K):fe,Re;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")re=Reflect.decorate(Q,G,K,fe);else for(var Ie=Q.length-1;Ie>=0;Ie--)(Re=Q[Ie])&&(re=(ce<3?Re(re):ce>3?Re(G,K,re):Re(G,K))||re);return ce>3&&re&&Object.defineProperty(G,K,re),re}function H(Q,G){return function(K,fe){G(K,fe,Q)}}function A(Q,G){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(Q,G)}function p(Q,G,K,fe){function ce(re){return re instanceof K?re:new K(function(Re){Re(re)})}return new(K||(K=Promise))(function(re,Re){function Ie(ae){try{X(fe.next(ae))}catch(ee){Re(ee)}}function Ce(ae){try{X(fe.throw(ae))}catch(ee){Re(ee)}}function X(ae){ae.done?re(ae.value):ce(ae.value).then(Ie,Ce)}X((fe=fe.apply(Q,G||[])).next())})}function f(Q,G){var K={label:0,sent:function(){if(re[0]&1)throw re[1];return re[1]},trys:[],ops:[]},fe,ce,re,Re;return Re={next:Ie(0),throw:Ie(1),return:Ie(2)},typeof Symbol=="function"&&(Re[Symbol.iterator]=function(){return this}),Re;function Ie(X){return function(ae){return Ce([X,ae])}}function Ce(X){if(fe)throw new TypeError("Generator is already executing.");for(;K;)try{if(fe=1,ce&&(re=X[0]&2?ce.return:X[0]?ce.throw||((re=ce.return)&&re.call(ce),0):ce.next)&&!(re=re.call(ce,X[1])).done)return re;switch(ce=0,re&&(X=[X[0]&2,re.value]),X[0]){case 0:case 1:re=X;break;case 4:return K.label++,{value:X[1],done:!1};case 5:K.label++,ce=X[1],X=[0];continue;case 7:X=K.ops.pop(),K.trys.pop();continue;default:if(re=K.trys,!(re=re.length>0&&re[re.length-1])&&(X[0]===6||X[0]===2)){K=0;continue}if(X[0]===3&&(!re||X[1]>re[0]&&X[1]<re[3])){K.label=X[1];break}if(X[0]===6&&K.label<re[1]){K.label=re[1],re=X;break}if(re&&K.label<re[2]){K.label=re[2],K.ops.push(X);break}re[2]&&K.ops.pop(),K.trys.pop();continue}X=G.call(Q,K)}catch(ae){X=[6,ae],ce=0}finally{fe=re=0}if(X[0]&5)throw X[1];return{value:X[0]?X[1]:void 0,done:!0}}}var h=Object.create?function(Q,G,K,fe){fe===void 0&&(fe=K),Object.defineProperty(Q,fe,{enumerable:!0,get:function(){return G[K]}})}:function(Q,G,K,fe){fe===void 0&&(fe=K),Q[fe]=G[K]};function m(Q,G){for(var K in Q)K!=="default"&&!Object.prototype.hasOwnProperty.call(G,K)&&h(G,Q,K)}function d(Q){var G=typeof Symbol=="function"&&Symbol.iterator,K=G&&Q[G],fe=0;if(K)return K.call(Q);if(Q&&typeof Q.length=="number")return{next:function(){return Q&&fe>=Q.length&&(Q=void 0),{value:Q&&Q[fe++],done:!Q}}};throw new TypeError(G?"Object is not iterable.":"Symbol.iterator is not defined.")}function g(Q,G){var K=typeof Symbol=="function"&&Q[Symbol.iterator];if(!K)return Q;var fe=K.call(Q),ce,re=[],Re;try{for(;(G===void 0||G-- >0)&&!(ce=fe.next()).done;)re.push(ce.value)}catch(Ie){Re={error:Ie}}finally{try{ce&&!ce.done&&(K=fe.return)&&K.call(fe)}finally{if(Re)throw Re.error}}return re}function v(){for(var Q=[],G=0;G<arguments.length;G++)Q=Q.concat(g(arguments[G]));return Q}function l(){for(var Q=0,G=0,K=arguments.length;G<K;G++)Q+=arguments[G].length;for(var fe=Array(Q),ce=0,G=0;G<K;G++)for(var re=arguments[G],Re=0,Ie=re.length;Re<Ie;Re++,ce++)fe[ce]=re[Re];return fe}function y(Q,G){for(var K=0,fe=G.length,ce=Q.length;K<fe;K++,ce++)Q[ce]=G[K];return Q}function E(Q){return this instanceof E?(this.v=Q,this):new E(Q)}function R(Q,G,K){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var fe=K.apply(Q,G||[]),ce,re=[];return ce={},Re("next"),Re("throw"),Re("return"),ce[Symbol.asyncIterator]=function(){return this},ce;function Re(w){fe[w]&&(ce[w]=function(N){return new Promise(function(W,$){re.push([w,N,W,$])>1||Ie(w,N)})})}function Ie(w,N){try{Ce(fe[w](N))}catch(W){ee(re[0][3],W)}}function Ce(w){w.value instanceof E?Promise.resolve(w.value.v).then(X,ae):ee(re[0][2],w)}function X(w){Ie("next",w)}function ae(w){Ie("throw",w)}function ee(w,N){w(N),re.shift(),re.length&&Ie(re[0][0],re[0][1])}}function F(Q){var G,K;return G={},fe("next"),fe("throw",function(ce){throw ce}),fe("return"),G[Symbol.iterator]=function(){return this},G;function fe(ce,re){G[ce]=Q[ce]?function(Re){return(K=!K)?{value:E(Q[ce](Re)),done:ce==="return"}:re?re(Re):Re}:re}}function B(Q){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var G=Q[Symbol.asyncIterator],K;return G?G.call(Q):(Q=typeof d=="function"?d(Q):Q[Symbol.iterator](),K={},fe("next"),fe("throw"),fe("return"),K[Symbol.asyncIterator]=function(){return this},K);function fe(re){K[re]=Q[re]&&function(Re){return new Promise(function(Ie,Ce){Re=Q[re](Re),ce(Ie,Ce,Re.done,Re.value)})}}function ce(re,Re,Ie,Ce){Promise.resolve(Ce).then(function(X){re({value:X,done:Ie})},Re)}}function L(Q,G){return Object.defineProperty?Object.defineProperty(Q,"raw",{value:G}):Q.raw=G,Q}var I=Object.create?function(Q,G){Object.defineProperty(Q,"default",{enumerable:!0,value:G})}:function(Q,G){Q.default=G};function k(Q){if(Q&&Q.__esModule)return Q;var G={};if(Q!=null)for(var K in Q)K!=="default"&&Object.prototype.hasOwnProperty.call(Q,K)&&h(G,Q,K);return I(G,Q),G}function Z(Q){return Q&&Q.__esModule?Q:{default:Q}}function Y(Q,G){if(!G.has(Q))throw new TypeError("attempted to get private field on non-instance");return G.get(Q)}function U(Q,G,K){if(!G.has(Q))throw new TypeError("attempted to set private field on non-instance");return G.set(Q,K),K}},758:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(743),S=u(435),j=u(455),O=u(437),M=function(){function p(){}return p}(),H=function(){function p(){}return p}(),A=function(p){Object(T.a)(f,p);function f(h,m){var d=p.call(this,h,m)||this;return d.CustomParts=new H,d.customShaderNameResolve=d.Builder,d.FragmentShader=S.a.ShadersStore.defaultPixelShader,d.VertexShader=S.a.ShadersStore.defaultVertexShader,d}return f.prototype.AttachAfterBind=function(h,m){if(this._newUniformInstances)for(var d in this._newUniformInstances){var g=d.toString().split("-");g[0]=="vec2"?m.setVector2(g[1],this._newUniformInstances[d]):g[0]=="vec3"?m.setVector3(g[1],this._newUniformInstances[d]):g[0]=="vec4"?m.setVector4(g[1],this._newUniformInstances[d]):g[0]=="mat4"?m.setMatrix(g[1],this._newUniformInstances[d]):g[0]=="float"&&m.setFloat(g[1],this._newUniformInstances[d])}if(this._newSamplerInstances)for(var d in this._newSamplerInstances){var g=d.toString().split("-");g[0]=="sampler2D"&&this._newSamplerInstances[d].isReady&&this._newSamplerInstances[d].isReady()&&m.setTexture(g[1],this._newSamplerInstances[d])}},f.prototype.ReviewUniform=function(h,m){if(h=="uniform"&&this._newUniforms)for(var d=0;d<this._newUniforms.length;d++)this._customUniform[d].indexOf("sampler")==-1&&m.push(this._newUniforms[d]);if(h=="sampler"&&this._newUniforms)for(var d=0;d<this._newUniforms.length;d++)this._customUniform[d].indexOf("sampler")!=-1&&m.push(this._newUniforms[d]);return m},f.prototype.Builder=function(h,m,d,g,v,l){var y=this;if(l&&this._customAttributes&&this._customAttributes.length>0&&l.push.apply(l,this._customAttributes),this.ReviewUniform("uniform",m),this.ReviewUniform("sampler",g),this._isCreatedShader)return this._createdShaderName;this._isCreatedShader=!1,f.ShaderIndexer++;var E="custom_"+f.ShaderIndexer,R=this._afterBind.bind(this);return this._afterBind=function(F,B){if(!!B){y.AttachAfterBind(F,B);try{R(F,B)}catch(L){}}},S.a.ShadersStore[E+"VertexShader"]=this.VertexShader.replace("#define CUSTOM_VERTEX_BEGIN",this.CustomParts.Vertex_Begin?this.CustomParts.Vertex_Begin:"").replace("#define CUSTOM_VERTEX_DEFINITIONS",(this._customUniform?this._customUniform.join(`
`):"")+(this.CustomParts.Vertex_Definitions?this.CustomParts.Vertex_Definitions:"")).replace("#define CUSTOM_VERTEX_MAIN_BEGIN",this.CustomParts.Vertex_MainBegin?this.CustomParts.Vertex_MainBegin:"").replace("#define CUSTOM_VERTEX_UPDATE_POSITION",this.CustomParts.Vertex_Before_PositionUpdated?this.CustomParts.Vertex_Before_PositionUpdated:"").replace("#define CUSTOM_VERTEX_UPDATE_NORMAL",this.CustomParts.Vertex_Before_NormalUpdated?this.CustomParts.Vertex_Before_NormalUpdated:"").replace("#define CUSTOM_VERTEX_MAIN_END",this.CustomParts.Vertex_MainEnd?this.CustomParts.Vertex_MainEnd:""),this.CustomParts.Vertex_After_WorldPosComputed&&(S.a.ShadersStore[E+"VertexShader"]=S.a.ShadersStore[E+"VertexShader"].replace("#define CUSTOM_VERTEX_UPDATE_WORLDPOS",this.CustomParts.Vertex_After_WorldPosComputed)),S.a.ShadersStore[E+"PixelShader"]=this.FragmentShader.replace("#define CUSTOM_FRAGMENT_BEGIN",this.CustomParts.Fragment_Begin?this.CustomParts.Fragment_Begin:"").replace("#define CUSTOM_FRAGMENT_MAIN_BEGIN",this.CustomParts.Fragment_MainBegin?this.CustomParts.Fragment_MainBegin:"").replace("#define CUSTOM_FRAGMENT_DEFINITIONS",(this._customUniform?this._customUniform.join(`
`):"")+(this.CustomParts.Fragment_Definitions?this.CustomParts.Fragment_Definitions:"")).replace("#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE",this.CustomParts.Fragment_Custom_Diffuse?this.CustomParts.Fragment_Custom_Diffuse:"").replace("#define CUSTOM_FRAGMENT_UPDATE_ALPHA",this.CustomParts.Fragment_Custom_Alpha?this.CustomParts.Fragment_Custom_Alpha:"").replace("#define CUSTOM_FRAGMENT_BEFORE_LIGHTS",this.CustomParts.Fragment_Before_Lights?this.CustomParts.Fragment_Before_Lights:"").replace("#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR",this.CustomParts.Fragment_Before_FragColor?this.CustomParts.Fragment_Before_FragColor:""),this.CustomParts.Fragment_Before_Fog&&(S.a.ShadersStore[E+"PixelShader"]=S.a.ShadersStore[E+"PixelShader"].replace("#define CUSTOM_FRAGMENT_BEFORE_FOG",this.CustomParts.Fragment_Before_Fog)),this._isCreatedShader=!0,this._createdShaderName=E,E},f.prototype.AddUniform=function(h,m,d){return this._customUniform||(this._customUniform=new Array,this._newUniforms=new Array,this._newSamplerInstances={},this._newUniformInstances={}),d&&(m.indexOf("sampler")!=-1?this._newSamplerInstances[m+"-"+h]=d:this._newUniformInstances[m+"-"+h]=d),this._customUniform.push("uniform "+m+" "+h+";"),this._newUniforms.push(h),this},f.prototype.AddAttribute=function(h){return this._customAttributes||(this._customAttributes=[]),this._customAttributes.push(h),this},f.prototype.Fragment_Begin=function(h){return this.CustomParts.Fragment_Begin=h,this},f.prototype.Fragment_Definitions=function(h){return this.CustomParts.Fragment_Definitions=h,this},f.prototype.Fragment_MainBegin=function(h){return this.CustomParts.Fragment_MainBegin=h,this},f.prototype.Fragment_Custom_Diffuse=function(h){return this.CustomParts.Fragment_Custom_Diffuse=h.replace("result","diffuseColor"),this},f.prototype.Fragment_Custom_Alpha=function(h){return this.CustomParts.Fragment_Custom_Alpha=h.replace("result","alpha"),this},f.prototype.Fragment_Before_Lights=function(h){return this.CustomParts.Fragment_Before_Lights=h,this},f.prototype.Fragment_Before_Fog=function(h){return this.CustomParts.Fragment_Before_Fog=h,this},f.prototype.Fragment_Before_FragColor=function(h){return this.CustomParts.Fragment_Before_FragColor=h.replace("result","color"),this},f.prototype.Vertex_Begin=function(h){return this.CustomParts.Vertex_Begin=h,this},f.prototype.Vertex_Definitions=function(h){return this.CustomParts.Vertex_Definitions=h,this},f.prototype.Vertex_MainBegin=function(h){return this.CustomParts.Vertex_MainBegin=h,this},f.prototype.Vertex_Before_PositionUpdated=function(h){return this.CustomParts.Vertex_Before_PositionUpdated=h.replace("result","positionUpdated"),this},f.prototype.Vertex_Before_NormalUpdated=function(h){return this.CustomParts.Vertex_Before_NormalUpdated=h.replace("result","normalUpdated"),this},f.prototype.Vertex_After_WorldPosComputed=function(h){return this.CustomParts.Vertex_After_WorldPosComputed=h,this},f.prototype.Vertex_MainEnd=function(h){return this.CustomParts.Vertex_MainEnd=h,this},f.ShaderIndexer=1,f}(j.a);O.a.RegisteredTypes["BABYLON.CustomMaterial"]=A},766:function(Ue,P,u){"use strict";u.d(P,"a",function(){return A});var T=u(743),S=u(435),j=u(533),O=u(437),M=u(554),H=function(){function p(){}return p}(),A=function(p){Object(T.a)(f,p);function f(h,m){var d=p.call(this,h,m)||this;return d.CustomParts=new H,d.customShaderNameResolve=d.Builder,d.FragmentShader=S.a.ShadersStore.pbrPixelShader,d.VertexShader=S.a.ShadersStore.pbrVertexShader,d.FragmentShader=d.FragmentShader.replace(/#include<pbrBlockAlbedoOpacity>/g,S.a.IncludesShadersStore.pbrBlockAlbedoOpacity),d.FragmentShader=d.FragmentShader.replace(/#include<pbrBlockReflectivity>/g,S.a.IncludesShadersStore.pbrBlockReflectivity),d.FragmentShader=d.FragmentShader.replace(/#include<pbrBlockFinalColorComposition>/g,S.a.IncludesShadersStore.pbrBlockFinalColorComposition),d}return f.prototype.AttachAfterBind=function(h,m){if(this._newUniformInstances)for(var d in this._newUniformInstances){var g=d.toString().split("-");g[0]=="vec2"?m.setVector2(g[1],this._newUniformInstances[d]):g[0]=="vec3"?m.setVector3(g[1],this._newUniformInstances[d]):g[0]=="vec4"?m.setVector4(g[1],this._newUniformInstances[d]):g[0]=="mat4"?m.setMatrix(g[1],this._newUniformInstances[d]):g[0]=="float"&&m.setFloat(g[1],this._newUniformInstances[d])}if(this._newSamplerInstances)for(var d in this._newSamplerInstances){var g=d.toString().split("-");g[0]=="sampler2D"&&this._newSamplerInstances[d].isReady&&this._newSamplerInstances[d].isReady()&&m.setTexture(g[1],this._newSamplerInstances[d])}},f.prototype.ReviewUniform=function(h,m){if(h=="uniform"&&this._newUniforms)for(var d=0;d<this._newUniforms.length;d++)this._customUniform[d].indexOf("sampler")==-1&&m.push(this._newUniforms[d]);if(h=="sampler"&&this._newUniforms)for(var d=0;d<this._newUniforms.length;d++)this._customUniform[d].indexOf("sampler")!=-1&&m.push(this._newUniforms[d]);return m},f.prototype.Builder=function(h,m,d,g,v,l,y){var E=this;if(y&&(y.processFinalCode=function(B,L){if(B==="vertex")return L;var I=new M.a(L);return I.inlineToken="#define pbr_inline",I.processCode(),I.code}),l&&this._customAttributes&&this._customAttributes.length>0&&l.push.apply(l,this._customAttributes),this.ReviewUniform("uniform",m),this.ReviewUniform("sampler",g),this._isCreatedShader)return this._createdShaderName;this._isCreatedShader=!1,f.ShaderIndexer++;var R="custom_"+f.ShaderIndexer,F=this._afterBind.bind(this);return this._afterBind=function(B,L){if(!!L){E.AttachAfterBind(B,L);try{F(B,L)}catch(I){}}},S.a.ShadersStore[R+"VertexShader"]=this.VertexShader.replace("#define CUSTOM_VERTEX_BEGIN",this.CustomParts.Vertex_Begin?this.CustomParts.Vertex_Begin:"").replace("#define CUSTOM_VERTEX_DEFINITIONS",(this._customUniform?this._customUniform.join(`
`):"")+(this.CustomParts.Vertex_Definitions?this.CustomParts.Vertex_Definitions:"")).replace("#define CUSTOM_VERTEX_MAIN_BEGIN",this.CustomParts.Vertex_MainBegin?this.CustomParts.Vertex_MainBegin:"").replace("#define CUSTOM_VERTEX_UPDATE_POSITION",this.CustomParts.Vertex_Before_PositionUpdated?this.CustomParts.Vertex_Before_PositionUpdated:"").replace("#define CUSTOM_VERTEX_UPDATE_NORMAL",this.CustomParts.Vertex_Before_NormalUpdated?this.CustomParts.Vertex_Before_NormalUpdated:"").replace("#define CUSTOM_VERTEX_MAIN_END",this.CustomParts.Vertex_MainEnd?this.CustomParts.Vertex_MainEnd:""),this.CustomParts.Vertex_After_WorldPosComputed&&(S.a.ShadersStore[R+"VertexShader"]=S.a.ShadersStore[R+"VertexShader"].replace("#define CUSTOM_VERTEX_UPDATE_WORLDPOS",this.CustomParts.Vertex_After_WorldPosComputed)),S.a.ShadersStore[R+"PixelShader"]=this.FragmentShader.replace("#define CUSTOM_FRAGMENT_BEGIN",this.CustomParts.Fragment_Begin?this.CustomParts.Fragment_Begin:"").replace("#define CUSTOM_FRAGMENT_MAIN_BEGIN",this.CustomParts.Fragment_MainBegin?this.CustomParts.Fragment_MainBegin:"").replace("#define CUSTOM_FRAGMENT_DEFINITIONS",(this._customUniform?this._customUniform.join(`
`):"")+(this.CustomParts.Fragment_Definitions?this.CustomParts.Fragment_Definitions:"")).replace("#define CUSTOM_FRAGMENT_UPDATE_ALBEDO",this.CustomParts.Fragment_Custom_Albedo?this.CustomParts.Fragment_Custom_Albedo:"").replace("#define CUSTOM_FRAGMENT_UPDATE_ALPHA",this.CustomParts.Fragment_Custom_Alpha?this.CustomParts.Fragment_Custom_Alpha:"").replace("#define CUSTOM_FRAGMENT_BEFORE_LIGHTS",this.CustomParts.Fragment_Before_Lights?this.CustomParts.Fragment_Before_Lights:"").replace("#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS",this.CustomParts.Fragment_Custom_MetallicRoughness?this.CustomParts.Fragment_Custom_MetallicRoughness:"").replace("#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE",this.CustomParts.Fragment_Custom_MicroSurface?this.CustomParts.Fragment_Custom_MicroSurface:"").replace("#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR",this.CustomParts.Fragment_Before_FragColor?this.CustomParts.Fragment_Before_FragColor:""),this.CustomParts.Fragment_Before_Fog&&(S.a.ShadersStore[R+"PixelShader"]=S.a.ShadersStore[R+"PixelShader"].replace("#define CUSTOM_FRAGMENT_BEFORE_FOG",this.CustomParts.Fragment_Before_Fog)),this._isCreatedShader=!0,this._createdShaderName=R,R},f.prototype.AddUniform=function(h,m,d){return this._customUniform||(this._customUniform=new Array,this._newUniforms=new Array,this._newSamplerInstances={},this._newUniformInstances={}),d&&(m.indexOf("sampler")!=-1?this._newSamplerInstances[m+"-"+h]=d:this._newUniformInstances[m+"-"+h]=d),this._customUniform.push("uniform "+m+" "+h+";"),this._newUniforms.push(h),this},f.prototype.AddAttribute=function(h){return this._customAttributes||(this._customAttributes=[]),this._customAttributes.push(h),this},f.prototype.Fragment_Begin=function(h){return this.CustomParts.Fragment_Begin=h,this},f.prototype.Fragment_Definitions=function(h){return this.CustomParts.Fragment_Definitions=h,this},f.prototype.Fragment_MainBegin=function(h){return this.CustomParts.Fragment_MainBegin=h,this},f.prototype.Fragment_Custom_Albedo=function(h){return this.CustomParts.Fragment_Custom_Albedo=h.replace("result","surfaceAlbedo"),this},f.prototype.Fragment_Custom_Alpha=function(h){return this.CustomParts.Fragment_Custom_Alpha=h.replace("result","alpha"),this},f.prototype.Fragment_Before_Lights=function(h){return this.CustomParts.Fragment_Before_Lights=h,this},f.prototype.Fragment_Custom_MetallicRoughness=function(h){return this.CustomParts.Fragment_Custom_MetallicRoughness=h,this},f.prototype.Fragment_Custom_MicroSurface=function(h){return this.CustomParts.Fragment_Custom_MicroSurface=h,this},f.prototype.Fragment_Before_Fog=function(h){return this.CustomParts.Fragment_Before_Fog=h,this},f.prototype.Fragment_Before_FragColor=function(h){return this.CustomParts.Fragment_Before_FragColor=h.replace("result","color"),this},f.prototype.Vertex_Begin=function(h){return this.CustomParts.Vertex_Begin=h,this},f.prototype.Vertex_Definitions=function(h){return this.CustomParts.Vertex_Definitions=h,this},f.prototype.Vertex_MainBegin=function(h){return this.CustomParts.Vertex_MainBegin=h,this},f.prototype.Vertex_Before_PositionUpdated=function(h){return this.CustomParts.Vertex_Before_PositionUpdated=h.replace("result","positionUpdated"),this},f.prototype.Vertex_Before_NormalUpdated=function(h){return this.CustomParts.Vertex_Before_NormalUpdated=h.replace("result","normalUpdated"),this},f.prototype.Vertex_After_WorldPosComputed=function(h){return this.CustomParts.Vertex_After_WorldPosComputed=h,this},f.prototype.Vertex_MainEnd=function(h){return this.CustomParts.Vertex_MainEnd=h,this},f.ShaderIndexer=1,f}(j.a);O.a.RegisteredTypes["BABYLON.PBRCustomMaterial"]=A},780:function(Ue,P,u){"use strict";u.d(P,"a",function(){return X}),u.d(P,"b",function(){return ae});var T=u(698),S=u(436),j=u(441),O=u(443),M=u(451),H=u(478),A=u(540),p=u(483),f=u(542),h=u(560),m=u(459),d=u(533),g=u(442),v=u(499),l=u(447),y=u(661),E=u(446),R=u(608),F=u(561),B=u(438),L=u(463),I=u(604),k=u(440),Z=u(699);function Y(ee,w,N,W){var $={externalResourceFunction:function(J){return W(J).then(function(le){return new Uint8Array(le)})}};return N&&($.uri=w==="file:"?N:w+N),ee instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(ee),$):GLTFValidator.validateString(ee,$)}function U(){var ee=[];onmessage=function(w){var N=w.data;switch(N.id){case"init":{importScripts(N.url);break}case"validate":{Y(N.data,N.rootUrl,N.fileName,function(W){return new Promise(function($,J){var le=ee.length;ee.push({resolve:$,reject:J}),postMessage({id:"getExternalResource",index:le,uri:W})})}).then(function(W){postMessage({id:"validate.resolve",value:W})},function(W){postMessage({id:"validate.reject",reason:W})});break}case"getExternalResource.resolve":{ee[N.index].resolve(N.value);break}case"getExternalResource.reject":{ee[N.index].reject(N.reason);break}}}}var Q=function(){function ee(){}return ee.ValidateAsync=function(w,N,W,$){var J=this;return typeof Worker=="function"?new Promise(function(le,ne){var be=Y+"("+U+")()",Me=URL.createObjectURL(new Blob([be],{type:"application/javascript"})),Te=new Worker(Me),Ae=function(te){Te.removeEventListener("error",Ae),Te.removeEventListener("message",se),ne(te)},se=function(te){var he=te.data;switch(he.id){case"getExternalResource":{$(he.uri).then(function(de){Te.postMessage({id:"getExternalResource.resolve",index:he.index,value:de},[de])},function(de){Te.postMessage({id:"getExternalResource.reject",index:he.index,reason:de})});break}case"validate.resolve":{Te.removeEventListener("error",Ae),Te.removeEventListener("message",se),le(he.value);break}case"validate.reject":Te.removeEventListener("error",Ae),Te.removeEventListener("message",se),ne(he.reason)}};Te.addEventListener("error",Ae),Te.addEventListener("message",se),Te.postMessage({id:"init",url:J.Configuration.url}),Te.postMessage({id:"validate",data:w,rootUrl:N,fileName:W})}):(this._LoadScriptPromise||(this._LoadScriptPromise=O.b.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(function(){return Y(w,N,W,$)}))},ee.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"},ee}(),G=u(473),K;(function(ee){ee[ee.AUTO=0]="AUTO",ee[ee.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(K||(K={}));var fe;(function(ee){ee[ee.NONE=0]="NONE",ee[ee.FIRST=1]="FIRST",ee[ee.ALL=2]="ALL"})(fe||(fe={}));var ce;(function(ee){ee[ee.LOADING=0]="LOADING",ee[ee.READY=1]="READY",ee[ee.COMPLETE=2]="COMPLETE"})(ce||(ce={}));var re=function(){function ee(){this.onParsedObservable=new B.c,this.coordinateSystemMode=K.AUTO,this.animationStartMode=fe.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.preprocessUrlAsync=function(w){return Promise.resolve(w)},this.onMeshLoadedObservable=new B.c,this.onTextureLoadedObservable=new B.c,this.onMaterialLoadedObservable=new B.c,this.onCameraLoadedObservable=new B.c,this.onCompleteObservable=new B.c,this.onErrorObservable=new B.c,this.onDisposeObservable=new B.c,this.onExtensionLoadedObservable=new B.c,this.validate=!1,this.onValidatedObservable=new B.c,this._loader=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}return Object.defineProperty(ee.prototype,"onParsed",{set:function(w){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onMeshLoaded",{set:function(w){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onTextureLoaded",{set:function(w){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onMaterialLoaded",{set:function(w){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onCameraLoaded",{set:function(w){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onComplete",{set:function(w){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onError",{set:function(w){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onDispose",{set:function(w){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onExtensionLoaded",{set:function(w){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(w)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"loggingEnabled",{get:function(){return this._loggingEnabled},set:function(w){this._loggingEnabled!==w&&(this._loggingEnabled=w,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"capturePerformanceCounters",{get:function(){return this._capturePerformanceCounters},set:function(w){this._capturePerformanceCounters!==w&&(this._capturePerformanceCounters=w,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"onValidated",{set:function(w){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(w)},enumerable:!1,configurable:!0}),ee.prototype.dispose=function(){this._loader&&(this._loader.dispose(),this._loader=null);for(var w=0,N=this._requests;w<N.length;w++){var W=N[w];W.abort()}this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=function($){return Promise.resolve($)},this.onMeshLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()},ee.prototype.requestFile=function(w,N,W,$,J,le){var ne=this;if(this._progressCallback=$,J){if(this.useRangeRequests){this.validate&&k.a.Warn("glTF validation is not supported when range requests are enabled");var be={abort:function(){},onCompleteObservable:new B.c},Me={readAsync:function(Te,Ae){return new Promise(function(se,te){ne._requestFile(N,w,function(he){se(new Uint8Array(he))},!0,function(he){te(he)},function(he){he.setRequestHeader("Range","bytes="+Te+"-"+(Te+Ae-1))})})},byteLength:0};return this._unpackBinaryAsync(new Z.a(Me)).then(function(Te){be.onCompleteObservable.notifyObservers(be),W(Te)},le),be}return this._requestFile(N,w,function(Te,Ae){var se=Te;ne._unpackBinaryAsync(new Z.a({readAsync:function(te,he){return Promise.resolve(new Uint8Array(se,te,he))},byteLength:se.byteLength})).then(function(te){W(te,Ae)},le)},!0,le)}return this._requestFile(N,w,function(Te,Ae){ne._validate(w,Te,O.b.GetFolderPath(N),O.b.GetFilename(N)),W({json:ne._parseJson(Te)},Ae)},J,le)},ee.prototype.readFile=function(w,N,W,$,J,le){var ne=this;return w._readFile(N,function(be){if(ne._validate(w,be,"file:",N.name),J){var Me=be;ne._unpackBinaryAsync(new Z.a({readAsync:function(Te,Ae){return Promise.resolve(new Uint8Array(Me,Te,Ae))},byteLength:Me.byteLength})).then(W,le)}else W({json:ne._parseJson(be)})},$,J,le)},ee.prototype.importMeshAsync=function(w,N,W,$,J,le){var ne=this;return Promise.resolve().then(function(){return ne.onParsedObservable.notifyObservers(W),ne.onParsedObservable.clear(),ne._log("Loading "+(le||"")),ne._loader=ne._getLoader(W),ne._loader.importMeshAsync(w,N,!1,W,$,J,le)})},ee.prototype.loadAsync=function(w,N,W,$,J){var le=this;return Promise.resolve().then(function(){return le.onParsedObservable.notifyObservers(N),le.onParsedObservable.clear(),le._log("Loading "+(J||"")),le._loader=le._getLoader(N),le._loader.loadAsync(w,N,W,$,J)})},ee.prototype.loadAssetContainerAsync=function(w,N,W,$,J){var le=this;return Promise.resolve().then(function(){le.onParsedObservable.notifyObservers(N),le.onParsedObservable.clear(),le._log("Loading "+(J||"")),le._loader=le._getLoader(N);var ne=new I.a(w),be=[];le.onMaterialLoadedObservable.add(function(Ae){be.push(Ae),Ae.onDisposeObservable.addOnce(function(){var se=ne.materials.indexOf(Ae);se>-1&&ne.materials.splice(se,1),se=be.indexOf(Ae),se>-1&&be.splice(se,1)})});var Me=[];le.onTextureLoadedObservable.add(function(Ae){Me.push(Ae),Ae.onDisposeObservable.addOnce(function(){var se=ne.textures.indexOf(Ae);se>-1&&ne.textures.splice(se,1),se=Me.indexOf(Ae),se>-1&&Me.splice(se,1)})});var Te=[];return le.onCameraLoadedObservable.add(function(Ae){Te.push(Ae)}),le._loader.importMeshAsync(null,w,!0,N,W,$,J).then(function(Ae){return Array.prototype.push.apply(ne.geometries,Ae.geometries),Array.prototype.push.apply(ne.meshes,Ae.meshes),Array.prototype.push.apply(ne.particleSystems,Ae.particleSystems),Array.prototype.push.apply(ne.skeletons,Ae.skeletons),Array.prototype.push.apply(ne.animationGroups,Ae.animationGroups),Array.prototype.push.apply(ne.materials,be),Array.prototype.push.apply(ne.textures,Me),Array.prototype.push.apply(ne.lights,Ae.lights),Array.prototype.push.apply(ne.transformNodes,Ae.transformNodes),Array.prototype.push.apply(ne.cameras,Te),ne})})},ee.prototype.canDirectLoad=function(w){return w.indexOf("asset")!==-1&&w.indexOf("version")!==-1||G.a.StartsWith(w,"data:base64,"+ee.magicBase64Encoded)||G.a.StartsWith(w,"data:application/octet-stream;base64,"+ee.magicBase64Encoded)||G.a.StartsWith(w,"data:model/gltf-binary;base64,"+ee.magicBase64Encoded)},ee.prototype.directLoad=function(w,N){if(G.a.StartsWith(N,"base64,"+ee.magicBase64Encoded)||G.a.StartsWith(N,"application/octet-stream;base64,"+ee.magicBase64Encoded)||G.a.StartsWith(N,"model/gltf-binary;base64,"+ee.magicBase64Encoded)){var W=O.b.DecodeBase64(N);return this._validate(w,W),this._unpackBinaryAsync(new Z.a({readAsync:function($,J){return Promise.resolve(new Uint8Array(W,$,J))},byteLength:W.byteLength}))}return this._validate(w,N),Promise.resolve({json:this._parseJson(N)})},ee.prototype.createPlugin=function(){return new ee},Object.defineProperty(ee.prototype,"loaderState",{get:function(){return this._loader?this._loader.state:null},enumerable:!1,configurable:!0}),ee.prototype.whenCompleteAsync=function(){var w=this;return new Promise(function(N,W){w.onCompleteObservable.addOnce(function(){N()}),w.onErrorObservable.addOnce(function($){W($)})})},ee.prototype._loadFile=function(w,N,W,$,J){var le=this,ne=N._loadFile(w,W,function(be){le._onProgress(be,ne)},void 0,$,J);return ne.onCompleteObservable.add(function(be){le._requests.splice(le._requests.indexOf(be),1)}),this._requests.push(ne),ne},ee.prototype._requestFile=function(w,N,W,$,J,le){var ne=this,be=N._requestFile(w,W,function(Me){ne._onProgress(Me,be)},void 0,$,J,le);return be.onCompleteObservable.add(function(Me){ne._requests.splice(ne._requests.indexOf(Me),1)}),this._requests.push(be),be},ee.prototype._onProgress=function(w,N){if(!!this._progressCallback){N._lengthComputable=w.lengthComputable,N._loaded=w.loaded,N._total=w.total;for(var W=!0,$=0,J=0,le=0,ne=this._requests;le<ne.length;le++){var be=ne[le];if(be._lengthComputable===void 0||be._loaded===void 0||be._total===void 0)return;W=W&&be._lengthComputable,$+=be._loaded,J+=be._total}this._progressCallback({lengthComputable:W,loaded:$,total:W?J:0})}},ee.prototype._validate=function(w,N,W,$){var J=this;W===void 0&&(W=""),$===void 0&&($=""),!!this.validate&&(this._startPerformanceCounter("Validate JSON"),Q.ValidateAsync(N,W,$,function(le){return J.preprocessUrlAsync(W+le).then(function(ne){return w._loadFileAsync(ne,void 0,!0,!0)})}).then(function(le){J._endPerformanceCounter("Validate JSON"),J.onValidatedObservable.notifyObservers(le),J.onValidatedObservable.clear()},function(le){J._endPerformanceCounter("Validate JSON"),O.b.Warn("Failed to validate: "+le.message),J.onValidatedObservable.clear()}))},ee.prototype._getLoader=function(w){var N=w.json.asset||{};this._log("Asset version: "+N.version),N.minVersion&&this._log("Asset minimum version: "+N.minVersion),N.generator&&this._log("Asset generator: "+N.generator);var W=ee._parseVersion(N.version);if(!W)throw new Error("Invalid version: "+N.version);if(N.minVersion!==void 0){var $=ee._parseVersion(N.minVersion);if(!$)throw new Error("Invalid minimum version: "+N.minVersion);if(ee._compareVersion($,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+N.minVersion)}var J={1:ee._CreateGLTF1Loader,2:ee._CreateGLTF2Loader},le=J[W.major];if(!le)throw new Error("Unsupported version: "+N.version);return le(this)},ee.prototype._parseJson=function(w){this._startPerformanceCounter("Parse JSON"),this._log("JSON length: "+w.length);var N=JSON.parse(w);return this._endPerformanceCounter("Parse JSON"),N},ee.prototype._unpackBinaryAsync=function(w){var N=this;return this._startPerformanceCounter("Unpack Binary"),w.loadAsync(20).then(function(){var W={Magic:1179937895},$=w.readUint32();if($!==W.Magic)throw new Error("Unexpected magic: "+$);var J=w.readUint32();N.loggingEnabled&&N._log("Binary version: "+J);var le=w.readUint32();if(w.buffer.byteLength!==0&&le!==w.buffer.byteLength)throw new Error("Length in header does not match actual data length: "+le+" != "+w.buffer.byteLength);var ne;switch(J){case 1:{ne=N._unpackBinaryV1Async(w,le);break}case 2:{ne=N._unpackBinaryV2Async(w,le);break}default:throw new Error("Unsupported version: "+J)}return N._endPerformanceCounter("Unpack Binary"),ne})},ee.prototype._unpackBinaryV1Async=function(w,N){var W={JSON:0},$=w.readUint32(),J=w.readUint32();if(J!==W.JSON)throw new Error("Unexpected content format: "+J);var le=N-w.byteOffset,ne={json:this._parseJson(w.readString($)),bin:null};if(le!==0){var be=w.byteOffset;ne.bin={readAsync:function(Me,Te){return w.buffer.readAsync(be+Me,Te)},byteLength:le}}return Promise.resolve(ne)},ee.prototype._unpackBinaryV2Async=function(w,N){var W=this,$={JSON:1313821514,BIN:5130562},J=w.readUint32(),le=w.readUint32();if(le!==$.JSON)throw new Error("First chunk format is not JSON");return w.byteOffset+J===N?w.loadAsync(J).then(function(){return{json:W._parseJson(w.readString(J)),bin:null}}):w.loadAsync(J+8).then(function(){var ne={json:W._parseJson(w.readString(J)),bin:null},be=function(){var Me=w.readUint32(),Te=w.readUint32();switch(Te){case $.JSON:throw new Error("Unexpected JSON chunk");case $.BIN:{var Ae=w.byteOffset;ne.bin={readAsync:function(se,te){return w.buffer.readAsync(Ae+se,te)},byteLength:Me},w.skipBytes(Me);break}default:{w.skipBytes(Me);break}}return w.byteOffset!==N?w.loadAsync(8).then(be):Promise.resolve(ne)};return be()})},ee._parseVersion=function(w){if(w==="1.0"||w==="1.0.1")return{major:1,minor:0};var N=(w+"").match(/^(\d+)\.(\d+)/);return N?{major:parseInt(N[1]),minor:parseInt(N[2])}:null},ee._compareVersion=function(w,N){return w.major>N.major?1:w.major<N.major?-1:w.minor>N.minor?1:w.minor<N.minor?-1:0},ee.prototype._logOpen=function(w){this._log(w),this._logIndentLevel++},ee.prototype._logClose=function(){--this._logIndentLevel},ee.prototype._logEnabled=function(w){var N=ee._logSpaces.substr(0,this._logIndentLevel*2);k.a.Log(""+N+w)},ee.prototype._logDisabled=function(w){},ee.prototype._startPerformanceCounterEnabled=function(w){O.b.StartPerformanceCounter(w)},ee.prototype._startPerformanceCounterDisabled=function(w){},ee.prototype._endPerformanceCounterEnabled=function(w){O.b.EndPerformanceCounter(w)},ee.prototype._endPerformanceCounterDisabled=function(w){},ee.IncrementalLoading=!0,ee.HomogeneousCoordinates=!1,ee.magicBase64Encoded="Z2xURg",ee._logSpaces="                                ",ee}();L.a&&L.a.RegisterPlugin(new re);var Re=u(707),Ie=u(662),Ce=u(536),X=function(){function ee(){}return ee.Get=function(w,N,W){if(!N||W==null||!N[W])throw new Error(w+": Failed to find index ("+W+")");return N[W]},ee.Assign=function(w){if(w)for(var N=0;N<w.length;N++)w[N].index=N},ee}(),ae=function(){function ee(w){this._completePromises=new Array,this._forAssetContainer=!1,this._babylonLights=[],this._disableInstancedMesh=0,this._disposed=!1,this._state=null,this._extensions=new Array,this._defaultBabylonMaterialData={},this._parent=w}return ee.RegisterExtension=function(w,N){ee.UnregisterExtension(w)&&k.a.Warn("Extension with the name '"+w+"' already exists"),ee._RegisteredExtensions[w]={factory:N}},ee.UnregisterExtension=function(w){return ee._RegisteredExtensions[w]?(delete ee._RegisteredExtensions[w],!0):!1},Object.defineProperty(ee.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"gltf",{get:function(){return this._gltf},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"bin",{get:function(){return this._bin},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"babylonScene",{get:function(){return this._babylonScene},enumerable:!1,configurable:!0}),Object.defineProperty(ee.prototype,"rootBabylonMesh",{get:function(){return this._rootBabylonMesh},enumerable:!1,configurable:!0}),ee.prototype.dispose=function(){if(!this._disposed){this._disposed=!0,this._completePromises.length=0;for(var w in this._extensions){var N=this._extensions[w];N.dispose&&N.dispose(),delete this._extensions[w]}this._gltf=null,this._babylonScene=null,this._rootBabylonMesh=null,this._parent.dispose()}},ee.prototype.importMeshAsync=function(w,N,W,$,J,le,ne){var be=this;return ne===void 0&&(ne=""),Promise.resolve().then(function(){be._babylonScene=N,be._forAssetContainer=W,be._loadData($);var Me=null;if(w){var Te={};if(be._gltf.nodes)for(var Ae=0,se=be._gltf.nodes;Ae<se.length;Ae++){var te=se[Ae];te.name&&(Te[te.name]=te.index)}var he=w instanceof Array?w:[w];Me=he.map(function(de){var Ne=Te[de];if(Ne===void 0)throw new Error("Failed to find node '"+de+"'");return Ne})}return be._loadAsync(J,ne,Me,function(){return{meshes:be._getMeshes(),particleSystems:[],skeletons:be._getSkeletons(),animationGroups:be._getAnimationGroups(),lights:be._babylonLights,transformNodes:be._getTransformNodes(),geometries:be._getGeometries()}})})},ee.prototype.loadAsync=function(w,N,W,$,J){var le=this;return J===void 0&&(J=""),Promise.resolve().then(function(){return le._babylonScene=w,le._loadData(N),le._loadAsync(W,J,null,function(){})})},ee.prototype._loadAsync=function(w,N,W,$){var J=this;return Promise.resolve().then(function(){J._rootUrl=w,J._uniqueRootUrl=!G.a.StartsWith(w,"file:")&&N?w:""+w+Date.now()+"/",J._fileName=N,J._loadExtensions(),J._checkExtensions();var le=ce[ce.LOADING]+" => "+ce[ce.READY],ne=ce[ce.LOADING]+" => "+ce[ce.COMPLETE];J._parent._startPerformanceCounter(le),J._parent._startPerformanceCounter(ne),J._setState(ce.LOADING),J._extensionsOnLoading();var be=new Array,Me=J._babylonScene.blockMaterialDirtyMechanism;if(J._babylonScene.blockMaterialDirtyMechanism=!0,W)be.push(J.loadSceneAsync("/nodes",{nodes:W,index:-1}));else if(J._gltf.scene!=null||J._gltf.scenes&&J._gltf.scenes[0]){var Te=X.Get("/scene",J._gltf.scenes,J._gltf.scene||0);be.push(J.loadSceneAsync("/scenes/"+Te.index,Te))}if(J.parent.loadAllMaterials&&J._gltf.materials)for(var Ae=0;Ae<J._gltf.materials.length;++Ae){var se=J._gltf.materials[Ae],te="/materials/"+Ae,he=m.a.TriangleFillMode;be.push(J._loadMaterialAsync(te,se,null,he,function(Ne){}))}J._babylonScene.blockMaterialDirtyMechanism=Me,J._parent.compileMaterials&&be.push(J._compileMaterialsAsync()),J._parent.compileShadowGenerators&&be.push(J._compileShadowGeneratorsAsync());var de=Promise.all(be).then(function(){return J._rootBabylonMesh&&J._rootBabylonMesh.setEnabled(!0),J._extensionsOnReady(),J._setState(ce.READY),J._startAnimations(),$()});return de.then(function(Ne){return J._parent._endPerformanceCounter(le),O.b.SetImmediate(function(){J._disposed||Promise.all(J._completePromises).then(function(){J._parent._endPerformanceCounter(ne),J._setState(ce.COMPLETE),J._parent.onCompleteObservable.notifyObservers(void 0),J._parent.onCompleteObservable.clear(),J.dispose()},function(Le){J._parent.onErrorObservable.notifyObservers(Le),J._parent.onErrorObservable.clear(),J.dispose()})}),Ne})}).catch(function(le){throw J._disposed||(J._parent.onErrorObservable.notifyObservers(le),J._parent.onErrorObservable.clear(),J.dispose()),le})},ee.prototype._loadData=function(w){if(this._gltf=w.json,this._setupData(),w.bin){var N=this._gltf.buffers;if(N&&N[0]&&!N[0].uri){var W=N[0];(W.byteLength<w.bin.byteLength-3||W.byteLength>w.bin.byteLength)&&k.a.Warn("Binary buffer length ("+W.byteLength+") from JSON does not match chunk length ("+w.bin.byteLength+")"),this._bin=w.bin}else k.a.Warn("Unexpected BIN chunk")}},ee.prototype._setupData=function(){if(X.Assign(this._gltf.accessors),X.Assign(this._gltf.animations),X.Assign(this._gltf.buffers),X.Assign(this._gltf.bufferViews),X.Assign(this._gltf.cameras),X.Assign(this._gltf.images),X.Assign(this._gltf.materials),X.Assign(this._gltf.meshes),X.Assign(this._gltf.nodes),X.Assign(this._gltf.samplers),X.Assign(this._gltf.scenes),X.Assign(this._gltf.skins),X.Assign(this._gltf.textures),this._gltf.nodes){for(var w={},N=0,W=this._gltf.nodes;N<W.length;N++){var $=W[N];if($.children)for(var J=0,le=$.children;J<le.length;J++){var ne=le[J];w[ne]=$.index}}for(var be=this._createRootNode(),Me=0,Te=this._gltf.nodes;Me<Te.length;Me++){var $=Te[Me],Ae=w[$.index];$.parent=Ae===void 0?be:this._gltf.nodes[Ae]}}},ee.prototype._loadExtensions=function(){for(var w in ee._RegisteredExtensions){var N=ee._RegisteredExtensions[w].factory(this);N.name!==w&&k.a.Warn("The name of the glTF loader extension instance does not match the registered name: "+N.name+" !== "+w),this._extensions.push(N),this._parent.onExtensionLoadedObservable.notifyObservers(N)}this._extensions.sort(function(W,$){return(W.order||Number.MAX_VALUE)-($.order||Number.MAX_VALUE)}),this._parent.onExtensionLoadedObservable.clear()},ee.prototype._checkExtensions=function(){if(this._gltf.extensionsRequired)for(var w=function(le){var ne=N._extensions.some(function(be){return be.name===le&&be.enabled});if(!ne)throw new Error("Require extension "+le+" is not available")},N=this,W=0,$=this._gltf.extensionsRequired;W<$.length;W++){var J=$[W];w(J)}},ee.prototype._setState=function(w){this._state=w,this.log(ce[this._state])},ee.prototype._createRootNode=function(){this._babylonScene._blockEntityCollection=this._forAssetContainer,this._rootBabylonMesh=new E.a("__root__",this._babylonScene),this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);var w={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case K.AUTO:{this._babylonScene.useRightHandedSystem||(w.rotation=[0,1,0,0],w.scale=[1,1,-1],ee._LoadTransform(w,this._rootBabylonMesh));break}case K.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error("Invalid coordinate system mode ("+this._parent.coordinateSystemMode+")")}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),w},ee.prototype.loadSceneAsync=function(w,N){var W=this,$=this._extensionsLoadSceneAsync(w,N);if($)return $;var J=new Array;if(this.logOpen(w+" "+(N.name||"")),N.nodes)for(var le=0,ne=N.nodes;le<ne.length;le++){var be=ne[le],Me=X.Get(w+"/nodes/"+be,this._gltf.nodes,be);J.push(this.loadNodeAsync("/nodes/"+Me.index,Me,function(de){de.parent=W._rootBabylonMesh}))}if(this._gltf.nodes)for(var Te=0,Ae=this._gltf.nodes;Te<Ae.length;Te++){var Me=Ae[Te];if(Me._babylonTransformNode&&Me._babylonBones)for(var se=0,te=Me._babylonBones;se<te.length;se++){var he=te[se];he.linkTransformNode(Me._babylonTransformNode)}}return J.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(J).then(function(){})},ee.prototype._forEachPrimitive=function(w,N){if(w._primitiveBabylonMeshes)for(var W=0,$=w._primitiveBabylonMeshes;W<$.length;W++){var J=$[W];N(J)}},ee.prototype._getGeometries=function(){var w=new Array,N=this._gltf.nodes;if(N)for(var W=0,$=N;W<$.length;W++){var J=$[W];this._forEachPrimitive(J,function(le){var ne=le.geometry;ne&&w.indexOf(ne)===-1&&w.push(ne)})}return w},ee.prototype._getMeshes=function(){var w=new Array;w.push(this._rootBabylonMesh);var N=this._gltf.nodes;if(N)for(var W=0,$=N;W<$.length;W++){var J=$[W];this._forEachPrimitive(J,function(le){w.push(le)})}return w},ee.prototype._getTransformNodes=function(){var w=new Array,N=this._gltf.nodes;if(N)for(var W=0,$=N;W<$.length;W++){var J=$[W];J._babylonTransformNode&&J._babylonTransformNode.getClassName()==="TransformNode"&&w.push(J._babylonTransformNode)}return w},ee.prototype._getSkeletons=function(){var w=new Array,N=this._gltf.skins;if(N)for(var W=0,$=N;W<$.length;W++){var J=$[W];J._data&&w.push(J._data.babylonSkeleton)}return w},ee.prototype._getAnimationGroups=function(){var w=new Array,N=this._gltf.animations;if(N)for(var W=0,$=N;W<$.length;W++){var J=$[W];J._babylonAnimationGroup&&w.push(J._babylonAnimationGroup)}return w},ee.prototype._startAnimations=function(){switch(this._parent.animationStartMode){case fe.NONE:break;case fe.FIRST:{var w=this._getAnimationGroups();w.length!==0&&w[0].start(!0);break}case fe.ALL:{for(var w=this._getAnimationGroups(),N=0,W=w;N<W.length;N++){var $=W[N];$.start(!0)}break}default:{k.a.Error("Invalid animation start mode ("+this._parent.animationStartMode+")");return}}},ee.prototype.loadNodeAsync=function(w,N,W){var $=this;W===void 0&&(W=function(){});var J=this._extensionsLoadNodeAsync(w,N,W);if(J)return J;if(N._babylonTransformNode)throw new Error(w+": Invalid recursive node hierarchy");var le=new Array;this.logOpen(w+" "+(N.name||""));var ne=function(Te){if(ee.AddPointerMetadata(Te,w),ee._LoadTransform(N,Te),N.camera!=null){var Ae=X.Get(w+"/camera",$._gltf.cameras,N.camera);le.push($.loadCameraAsync("/cameras/"+Ae.index,Ae,function(Ne){Ne.parent=Te}))}if(N.children)for(var se=0,te=N.children;se<te.length;se++){var he=te[se],de=X.Get(w+"/children/"+he,$._gltf.nodes,he);le.push($.loadNodeAsync("/nodes/"+de.index,de,function(Ne){Ne.parent=Te}))}W(Te)};if(N.mesh==null){var be=N.name||"node"+N.index;this._babylonScene._blockEntityCollection=this._forAssetContainer,N._babylonTransformNode=new v.a(be,this._babylonScene),this._babylonScene._blockEntityCollection=!1,ne(N._babylonTransformNode)}else{var Me=X.Get(w+"/mesh",this._gltf.meshes,N.mesh);le.push(this._loadMeshAsync("/meshes/"+Me.index,N,Me,ne))}return this.logClose(),Promise.all(le).then(function(){return $._forEachPrimitive(N,function(Te){Te.geometry&&Te.geometry.useBoundingInfoFromGeometry?Te._updateBoundingInfo():Te.refreshBoundingInfo(!0)}),N._babylonTransformNode})},ee.prototype._loadMeshAsync=function(w,N,W,$){var J=W.primitives;if(!J||!J.length)throw new Error(w+": Primitives are missing");J[0].index==null&&X.Assign(J);var le=new Array;this.logOpen(w+" "+(W.name||""));var ne=N.name||"node"+N.index;if(J.length===1){var be=W.primitives[0];le.push(this._loadMeshPrimitiveAsync(w+"/primitives/"+be.index,ne,N,W,be,function(se){N._babylonTransformNode=se,N._primitiveBabylonMeshes=[se]}))}else{this._babylonScene._blockEntityCollection=this._forAssetContainer,N._babylonTransformNode=new v.a(ne,this._babylonScene),this._babylonScene._blockEntityCollection=!1,N._primitiveBabylonMeshes=[];for(var Me=0,Te=J;Me<Te.length;Me++){var be=Te[Me];le.push(this._loadMeshPrimitiveAsync(w+"/primitives/"+be.index,ne+"_primitive"+be.index,N,W,be,function(te){te.parent=N._babylonTransformNode,N._primitiveBabylonMeshes.push(te)}))}}if(N.skin!=null){var Ae=X.Get(w+"/skin",this._gltf.skins,N.skin);le.push(this._loadSkinAsync("/skins/"+Ae.index,N,Ae))}return $(N._babylonTransformNode),this.logClose(),Promise.all(le).then(function(){return N._babylonTransformNode})},ee.prototype._loadMeshPrimitiveAsync=function(w,N,W,$,J,le){var ne=this,be=this._extensionsLoadMeshPrimitiveAsync(w,N,W,$,J,le);if(be)return be;this.logOpen(""+w);var Me=this._disableInstancedMesh===0&&this._parent.createInstances&&W.skin==null&&!$.primitives[0].targets,Te,Ae;if(Me&&J._instanceData)this._babylonScene._blockEntityCollection=this._forAssetContainer,Te=J._instanceData.babylonSourceMesh.createInstance(N),this._babylonScene._blockEntityCollection=!1,Ae=J._instanceData.promise;else{var se=new Array;this._babylonScene._blockEntityCollection=this._forAssetContainer;var te=new E.a(N,this._babylonScene);this._babylonScene._blockEntityCollection=!1,te.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?m.a.CounterClockWiseSideOrientation:m.a.ClockWiseSideOrientation,this._createMorphTargets(w,W,$,J,te),se.push(this._loadVertexDataAsync(w,J,te).then(function(Le){return ne._loadMorphTargetsAsync(w,J,te,Le).then(function(){ne._babylonScene._blockEntityCollection=ne._forAssetContainer,Le.applyToMesh(te),ne._babylonScene._blockEntityCollection=!1})}));var he=ee._GetDrawMode(w,J.mode);if(J.material==null){var de=this._defaultBabylonMaterialData[he];de||(de=this._createDefaultMaterial("__GLTFLoader._default",he),this._parent.onMaterialLoadedObservable.notifyObservers(de),this._defaultBabylonMaterialData[he]=de),te.material=de}else{var Ne=X.Get(w+"/material",this._gltf.materials,J.material);se.push(this._loadMaterialAsync("/materials/"+Ne.index,Ne,te,he,function(Le){te.material=Le}))}Ae=Promise.all(se),Me&&(J._instanceData={babylonSourceMesh:te,promise:Ae}),Te=te}return ee.AddPointerMetadata(Te,w),this._parent.onMeshLoadedObservable.notifyObservers(Te),le(Te),this.logClose(),Ae.then(function(){return Te})},ee.prototype._loadVertexDataAsync=function(w,N,W){var $=this,J=this._extensionsLoadVertexDataAsync(w,N,W);if(J)return J;var le=N.attributes;if(!le)throw new Error(w+": Attributes are missing");var ne=new Array,be=new y.a(W.name,this._babylonScene);if(N.indices==null)W.isUnIndexed=!0;else{var Me=X.Get(w+"/indices",this._gltf.accessors,N.indices);ne.push(this._loadIndicesAccessorAsync("/accessors/"+Me.index,Me).then(function(Ae){be.setIndices(Ae)}))}var Te=function(Ae,se,te){if(le[Ae]!=null){W._delayInfo=W._delayInfo||[],W._delayInfo.indexOf(se)===-1&&W._delayInfo.push(se);var he=X.Get(w+"/attributes/"+Ae,$._gltf.accessors,le[Ae]);ne.push($._loadVertexAccessorAsync("/accessors/"+he.index,he,se).then(function(de){if(de.getKind()===l.b.PositionKind&&!$.parent.alwaysComputeBoundingBox&&!W.skeleton){var Ne=he.min,Le=he.max;if(Ne!==void 0&&Le!==void 0){var pe=S.c.Vector3[0],He=S.c.Vector3[1];pe.copyFromFloats.apply(pe,Ne),He.copyFromFloats.apply(He,Le),be._boundingInfo=new Ce.a(pe,He),be.useBoundingInfoFromGeometry=!0}}be.setVerticesBuffer(de,he.count)})),se==l.b.MatricesIndicesExtraKind&&(W.numBoneInfluencers=8),te&&te(he)}};return Te("POSITION",l.b.PositionKind),Te("NORMAL",l.b.NormalKind),Te("TANGENT",l.b.TangentKind),Te("TEXCOORD_0",l.b.UVKind),Te("TEXCOORD_1",l.b.UV2Kind),Te("JOINTS_0",l.b.MatricesIndicesKind),Te("WEIGHTS_0",l.b.MatricesWeightsKind),Te("JOINTS_1",l.b.MatricesIndicesExtraKind),Te("WEIGHTS_1",l.b.MatricesWeightsExtraKind),Te("COLOR_0",l.b.ColorKind,function(Ae){Ae.type==="VEC4"&&(W.hasVertexAlpha=!0)}),Promise.all(ne).then(function(){return be})},ee.prototype._createMorphTargets=function(w,N,W,$,J){if(!!$.targets){if(N._numMorphTargets==null)N._numMorphTargets=$.targets.length;else if($.targets.length!==N._numMorphTargets)throw new Error(w+": Primitives do not have the same number of targets");var le=W.extras?W.extras.targetNames:null;J.morphTargetManager=new F.a(J.getScene());for(var ne=0;ne<$.targets.length;ne++){var be=N.weights?N.weights[ne]:W.weights?W.weights[ne]:0,Me=le?le[ne]:"morphTarget"+ne;J.morphTargetManager.addTarget(new R.a(Me,be,J.getScene()))}}},ee.prototype._loadMorphTargetsAsync=function(w,N,W,$){if(!N.targets)return Promise.resolve();for(var J=new Array,le=W.morphTargetManager,ne=0;ne<le.numTargets;ne++){var be=le.getTarget(ne);J.push(this._loadMorphTargetVertexDataAsync(w+"/targets/"+ne,$,N.targets[ne],be))}return Promise.all(J).then(function(){})},ee.prototype._loadMorphTargetVertexDataAsync=function(w,N,W,$){var J=this,le=new Array,ne=function(be,Me,Te){if(W[be]!=null){var Ae=N.getVertexBuffer(Me);if(!!Ae){var se=X.Get(w+"/"+be,J._gltf.accessors,W[be]);le.push(J._loadFloatAccessorAsync("/accessors/"+se.index,se).then(function(te){Te(Ae,te)}))}}};return ne("POSITION",l.b.PositionKind,function(be,Me){var Te=new Float32Array(Me.length);be.forEach(Me.length,function(Ae,se){Te[se]=Me[se]+Ae}),$.setPositions(Te)}),ne("NORMAL",l.b.NormalKind,function(be,Me){var Te=new Float32Array(Me.length);be.forEach(Te.length,function(Ae,se){Te[se]=Me[se]+Ae}),$.setNormals(Te)}),ne("TANGENT",l.b.TangentKind,function(be,Me){var Te=new Float32Array(Me.length/3*4),Ae=0;be.forEach(Me.length/3*4,function(se,te){(te+1)%4!=0&&(Te[Ae]=Me[Ae]+se,Ae++)}),$.setTangents(Te)}),Promise.all(le).then(function(){})},ee._LoadTransform=function(w,N){if(w.skin==null){var W=S.e.Zero(),$=S.b.Identity(),J=S.e.One();if(w.matrix){var le=S.a.FromArray(w.matrix);le.decompose(J,$,W)}else w.translation&&(W=S.e.FromArray(w.translation)),w.rotation&&($=S.b.FromArray(w.rotation)),w.scale&&(J=S.e.FromArray(w.scale));N.position=W,N.rotationQuaternion=$,N.scaling=J}},ee.prototype._loadSkinAsync=function(w,N,W){var $=this,J=this._extensionsLoadSkinAsync(w,N,W);if(J)return J;var le=function(Te){$._forEachPrimitive(N,function(Ae){Ae.skeleton=Te})};if(W._data)return le(W._data.babylonSkeleton),W._data.promise;var ne="skeleton"+W.index;this._babylonScene._blockEntityCollection=this._forAssetContainer;var be=new h.a(W.name||ne,ne,this._babylonScene);this._babylonScene._blockEntityCollection=!1,be.overrideMesh=this._rootBabylonMesh,this._loadBones(w,W,be),le(be);var Me=this._loadSkinInverseBindMatricesDataAsync(w,W).then(function(Te){$._updateBoneMatrices(be,Te)});return W._data={babylonSkeleton:be,promise:Me},Me},ee.prototype._loadBones=function(w,N,W){for(var $={},J=0,le=N.joints;J<le.length;J++){var ne=le[J],be=X.Get(w+"/joints/"+ne,this._gltf.nodes,ne);this._loadBone(be,N,W,$)}},ee.prototype._loadBone=function(w,N,W,$){var J=$[w.index];if(J)return J;var le=null;w.parent&&w.parent._babylonTransformNode!==this._rootBabylonMesh&&(le=this._loadBone(w.parent,N,W,$));var ne=N.joints.indexOf(w.index);return J=new f.a(w.name||"joint"+w.index,W,le,this._getNodeMatrix(w),null,null,ne),$[w.index]=J,w._babylonBones=w._babylonBones||[],w._babylonBones.push(J),J},ee.prototype._loadSkinInverseBindMatricesDataAsync=function(w,N){if(N.inverseBindMatrices==null)return Promise.resolve(null);var W=X.Get(w+"/inverseBindMatrices",this._gltf.accessors,N.inverseBindMatrices);return this._loadFloatAccessorAsync("/accessors/"+W.index,W)},ee.prototype._updateBoneMatrices=function(w,N){for(var W=0,$=w.bones;W<$.length;W++){var J=$[W],le=S.a.Identity(),ne=J._index;N&&ne!==-1&&(S.a.FromArrayToRef(N,ne*16,le),le.invertToRef(le));var be=J.getParent();be&&le.multiplyToRef(be.getInvertedAbsoluteTransform(),le),J.setBindPose(le),J.updateMatrix(le,!1,!1),J._updateDifferenceMatrix(void 0,!1)}},ee.prototype._getNodeMatrix=function(w){return w.matrix?S.a.FromArray(w.matrix):S.a.Compose(w.scale?S.e.FromArray(w.scale):S.e.One(),w.rotation?S.b.FromArray(w.rotation):S.b.Identity(),w.translation?S.e.FromArray(w.translation):S.e.Zero())},ee.prototype.loadCameraAsync=function(w,N,W){W===void 0&&(W=function(){});var $=this._extensionsLoadCameraAsync(w,N,W);if($)return $;var J=new Array;this.logOpen(w+" "+(N.name||"")),this._babylonScene._blockEntityCollection=this._forAssetContainer;var le=new H.a(N.name||"camera"+N.index,S.e.Zero(),this._babylonScene,!1);switch(this._babylonScene._blockEntityCollection=!1,le.ignoreParentScaling=!0,le.rotation=new S.e(0,Math.PI,0),N.type){case"perspective":{var ne=N.perspective;if(!ne)throw new Error(w+": Camera perspective properties are missing");le.fov=ne.yfov,le.minZ=ne.znear,le.maxZ=ne.zfar||0;break}case"orthographic":{if(!N.orthographic)throw new Error(w+": Camera orthographic properties are missing");le.mode=M.a.ORTHOGRAPHIC_CAMERA,le.orthoLeft=-N.orthographic.xmag,le.orthoRight=N.orthographic.xmag,le.orthoBottom=-N.orthographic.ymag,le.orthoTop=N.orthographic.ymag,le.minZ=N.orthographic.znear,le.maxZ=N.orthographic.zfar;break}default:throw new Error(w+": Invalid camera type ("+N.type+")")}return ee.AddPointerMetadata(le,w),this._parent.onCameraLoadedObservable.notifyObservers(le),W(le),this.logClose(),Promise.all(J).then(function(){return le})},ee.prototype._loadAnimationsAsync=function(){var w=this._gltf.animations;if(!w)return Promise.resolve();for(var N=new Array,W=0;W<w.length;W++){var $=w[W];N.push(this.loadAnimationAsync("/animations/"+$.index,$).then(function(J){J.targetedAnimations.length===0&&J.dispose()}))}return Promise.all(N).then(function(){})},ee.prototype.loadAnimationAsync=function(w,N){var W=this._extensionsLoadAnimationAsync(w,N);if(W)return W;this._babylonScene._blockEntityCollection=this._forAssetContainer;var $=new A.a(N.name||"animation"+N.index,this._babylonScene);this._babylonScene._blockEntityCollection=!1,N._babylonAnimationGroup=$;var J=new Array;X.Assign(N.channels),X.Assign(N.samplers);for(var le=0,ne=N.channels;le<ne.length;le++){var be=ne[le];J.push(this._loadAnimationChannelAsync(w+"/channels/"+be.index,w,N,be,$))}return Promise.all(J).then(function(){return $.normalize(0),$})},ee.prototype._loadAnimationChannelAsync=function(w,N,W,$,J,le){var ne=this;if(le===void 0&&(le=null),$.target.node==null)return Promise.resolve();var be=X.Get(w+"/target/node",this._gltf.nodes,$.target.node);if($.target.path==="weights"&&!be._numMorphTargets||$.target.path!=="weights"&&!be._babylonTransformNode)return Promise.resolve();var Me=X.Get(w+"/sampler",W.samplers,$.sampler);return this._loadAnimationSamplerAsync(N+"/samplers/"+$.sampler,Me).then(function(Te){var Ae,se;switch($.target.path){case"translation":{Ae="position",se=p.a.ANIMATIONTYPE_VECTOR3;break}case"rotation":{Ae="rotationQuaternion",se=p.a.ANIMATIONTYPE_QUATERNION;break}case"scale":{Ae="scaling",se=p.a.ANIMATIONTYPE_VECTOR3;break}case"weights":{Ae="influence",se=p.a.ANIMATIONTYPE_FLOAT;break}default:throw new Error(w+"/target/path: Invalid value ("+$.target.path+")")}var te=0,he;switch(Ae){case"position":{he=function(){var et=S.e.FromArray(Te.output,te);return te+=3,et};break}case"rotationQuaternion":{he=function(){var et=S.b.FromArray(Te.output,te);return te+=4,et};break}case"scaling":{he=function(){var et=S.e.FromArray(Te.output,te);return te+=3,et};break}case"influence":{he=function(){for(var et=new Array(be._numMorphTargets),ht=0;ht<be._numMorphTargets;ht++)et[ht]=Te.output[te++];return et};break}}var de;switch(Te.interpolation){case"STEP":{de=function(et){return{frame:Te.input[et],value:he(),interpolation:Re.a.STEP}};break}case"LINEAR":{de=function(et){return{frame:Te.input[et],value:he()}};break}case"CUBICSPLINE":{de=function(et){return{frame:Te.input[et],inTangent:he(),value:he(),outTangent:he()}};break}}for(var Ne=new Array(Te.input.length),Le=0;Le<Te.input.length;Le++)Ne[Le]=de(Le);if(Ae==="influence")for(var pe=function(et){var ht=J.name+"_channel"+J.targetedAnimations.length,Ee=new p.a(ht,Ae,1,se);Ee.setKeys(Ne.map(function(At){return{frame:At.frame,inTangent:At.inTangent?At.inTangent[et]:void 0,value:At.value[et],outTangent:At.outTangent?At.outTangent[et]:void 0}})),ne._forEachPrimitive(be,function(At){var Ht=At,Ot=Ht.morphTargetManager.getTarget(et),Ut=Ee.clone();Ot.animations.push(Ut),J.addTargetedAnimation(Ut,Ot)})},He=0;He<be._numMorphTargets;He++)pe(He);else{var rt=J.name+"_channel"+J.targetedAnimations.length,ot=new p.a(rt,Ae,1,se);ot.setKeys(Ne),le!=null&&le.animations!=null?(le.animations.push(ot),J.addTargetedAnimation(ot,le)):(be._babylonTransformNode.animations.push(ot),J.addTargetedAnimation(ot,be._babylonTransformNode))}})},ee.prototype._loadAnimationSamplerAsync=function(w,N){if(N._data)return N._data;var W=N.interpolation||"LINEAR";switch(W){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(w+"/interpolation: Invalid value ("+N.interpolation+")")}var $=X.Get(w+"/input",this._gltf.accessors,N.input),J=X.Get(w+"/output",this._gltf.accessors,N.output);return N._data=Promise.all([this._loadFloatAccessorAsync("/accessors/"+$.index,$),this._loadFloatAccessorAsync("/accessors/"+J.index,J)]).then(function(le){var ne=le[0],be=le[1];return{input:ne,interpolation:W,output:be}}),N._data},ee.prototype.loadBufferAsync=function(w,N,W,$){var J=this._extensionsLoadBufferAsync(w,N,W,$);if(J)return J;if(!N._data)if(N.uri)N._data=this.loadUriAsync(w+"/uri",N,N.uri);else{if(!this._bin)throw new Error(w+": Uri is missing or the binary glTF is missing its binary chunk");N._data=this._bin.readAsync(0,N.byteLength)}return N._data.then(function(le){try{return new Uint8Array(le.buffer,le.byteOffset+W,$)}catch(ne){throw new Error(w+": "+ne.message)}})},ee.prototype.loadBufferViewAsync=function(w,N){var W=this._extensionsLoadBufferViewAsync(w,N);if(W)return W;if(N._data)return N._data;var $=X.Get(w+"/buffer",this._gltf.buffers,N.buffer);return N._data=this.loadBufferAsync("/buffers/"+$.index,$,N.byteOffset||0,N.byteLength),N._data},ee.prototype._loadAccessorAsync=function(w,N,W){var $=this;if(N._data)return N._data;var J=ee._GetNumComponents(w,N.type),le=J*l.b.GetTypeByteLength(N.componentType),ne=J*N.count;if(N.bufferView==null)N._data=Promise.resolve(new W(ne));else{var be=X.Get(w+"/bufferView",this._gltf.bufferViews,N.bufferView);N._data=this.loadBufferViewAsync("/bufferViews/"+be.index,be).then(function(Te){if(N.componentType===5126&&!N.normalized&&(!be.byteStride||be.byteStride===le))return ee._GetTypedArray(w,N.componentType,Te,N.byteOffset,ne);var Ae=new W(ne);return l.b.ForEach(Te,N.byteOffset||0,be.byteStride||le,J,N.componentType,Ae.length,N.normalized||!1,function(se,te){Ae[te]=se}),Ae})}if(N.sparse){var Me=N.sparse;N._data=N._data.then(function(Te){var Ae=Te,se=X.Get(w+"/sparse/indices/bufferView",$._gltf.bufferViews,Me.indices.bufferView),te=X.Get(w+"/sparse/values/bufferView",$._gltf.bufferViews,Me.values.bufferView);return Promise.all([$.loadBufferViewAsync("/bufferViews/"+se.index,se),$.loadBufferViewAsync("/bufferViews/"+te.index,te)]).then(function(he){var de=he[0],Ne=he[1],Le=ee._GetTypedArray(w+"/sparse/indices",Me.indices.componentType,de,Me.indices.byteOffset,Me.count),pe=J*Me.count,He;if(N.componentType===5126&&!N.normalized)He=ee._GetTypedArray(w+"/sparse/values",N.componentType,Ne,Me.values.byteOffset,pe);else{var rt=ee._GetTypedArray(w+"/sparse/values",N.componentType,Ne,Me.values.byteOffset,pe);He=new W(pe),l.b.ForEach(rt,0,le,J,N.componentType,He.length,N.normalized||!1,function(At,Ht){He[Ht]=At})}for(var ot=0,et=0;et<Le.length;et++)for(var ht=Le[et]*J,Ee=0;Ee<J;Ee++)Ae[ht++]=He[ot++];return Ae})})}return N._data},ee.prototype._loadFloatAccessorAsync=function(w,N){return this._loadAccessorAsync(w,N,Float32Array)},ee.prototype._loadIndicesAccessorAsync=function(w,N){if(N.type!=="SCALAR")throw new Error(w+"/type: Invalid value "+N.type);if(N.componentType!==5121&&N.componentType!==5123&&N.componentType!==5125)throw new Error(w+"/componentType: Invalid value "+N.componentType);if(N._data)return N._data;if(N.sparse){var W=ee._GetTypedArrayConstructor(w+"/componentType",N.componentType);N._data=this._loadAccessorAsync(w,N,W)}else{var $=X.Get(w+"/bufferView",this._gltf.bufferViews,N.bufferView);N._data=this.loadBufferViewAsync("/bufferViews/"+$.index,$).then(function(J){return ee._GetTypedArray(w,N.componentType,J,N.byteOffset,N.count)})}return N._data},ee.prototype._loadVertexBufferViewAsync=function(w,N){var W=this;return w._babylonBuffer||(w._babylonBuffer=this.loadBufferViewAsync("/bufferViews/"+w.index,w).then(function($){return new l.a(W._babylonScene.getEngine(),$,!1)})),w._babylonBuffer},ee.prototype._loadVertexAccessorAsync=function(w,N,W){var $=this;if(N._babylonVertexBuffer)return N._babylonVertexBuffer;if(N.sparse)N._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+N.index,N).then(function(le){return new l.b($._babylonScene.getEngine(),le,W,!1)});else if(N.byteOffset&&N.byteOffset%l.b.GetTypeByteLength(N.componentType)!=0)k.a.Warn("Accessor byte offset is not a multiple of component type byte length"),N._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+N.index,N).then(function(le){return new l.b($._babylonScene.getEngine(),le,W,!1)});else if(W===l.b.MatricesIndicesKind||W===l.b.MatricesIndicesExtraKind)N._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+N.index,N).then(function(le){return new l.b($._babylonScene.getEngine(),le,W,!1)});else{var J=X.Get(w+"/bufferView",this._gltf.bufferViews,N.bufferView);N._babylonVertexBuffer=this._loadVertexBufferViewAsync(J,W).then(function(le){var ne=ee._GetNumComponents(w,N.type);return new l.b($._babylonScene.getEngine(),le,W,!1,!1,J.byteStride,!1,N.byteOffset,ne,N.componentType,N.normalized,!0,1,!0)})}return N._babylonVertexBuffer},ee.prototype._loadMaterialMetallicRoughnessPropertiesAsync=function(w,N,W){if(!(W instanceof d.a))throw new Error(w+": Material type not supported");var $=new Array;return N&&(N.baseColorFactor?(W.albedoColor=j.a.FromArray(N.baseColorFactor),W.alpha=N.baseColorFactor[3]):W.albedoColor=j.a.White(),W.metallic=N.metallicFactor==null?1:N.metallicFactor,W.roughness=N.roughnessFactor==null?1:N.roughnessFactor,N.baseColorTexture&&$.push(this.loadTextureInfoAsync(w+"/baseColorTexture",N.baseColorTexture,function(J){J.name=W.name+" (Base Color)",W.albedoTexture=J})),N.metallicRoughnessTexture&&(N.metallicRoughnessTexture.nonColorData=!0,$.push(this.loadTextureInfoAsync(w+"/metallicRoughnessTexture",N.metallicRoughnessTexture,function(J){J.name=W.name+" (Metallic Roughness)",W.metallicTexture=J})),W.useMetallnessFromMetallicTextureBlue=!0,W.useRoughnessFromMetallicTextureGreen=!0,W.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all($).then(function(){})},ee.prototype._loadMaterialAsync=function(w,N,W,$,J){J===void 0&&(J=function(){});var le=this._extensionsLoadMaterialAsync(w,N,W,$,J);if(le)return le;N._data=N._data||{};var ne=N._data[$];if(!ne){this.logOpen(w+" "+(N.name||""));var be=this.createMaterial(w,N,$);ne={babylonMaterial:be,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(w,N,be)},N._data[$]=ne,ee.AddPointerMetadata(be,w),this._parent.onMaterialLoadedObservable.notifyObservers(be),this.logClose()}return W&&(ne.babylonMeshes.push(W),W.onDisposeObservable.addOnce(function(){var Me=ne.babylonMeshes.indexOf(W);Me!==-1&&ne.babylonMeshes.splice(Me,1)})),J(ne.babylonMaterial),ne.promise.then(function(){return ne.babylonMaterial})},ee.prototype._createDefaultMaterial=function(w,N){this._babylonScene._blockEntityCollection=this._forAssetContainer;var W=new d.a(w,this._babylonScene);return this._babylonScene._blockEntityCollection=!1,W.fillMode=N,W.enableSpecularAntiAliasing=!0,W.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,W.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,W.transparencyMode=d.a.PBRMATERIAL_OPAQUE,W.metallic=1,W.roughness=1,W},ee.prototype.createMaterial=function(w,N,W){var $=this._extensionsCreateMaterial(w,N,W);if($)return $;var J=N.name||"material"+N.index,le=this._createDefaultMaterial(J,W);return le},ee.prototype.loadMaterialPropertiesAsync=function(w,N,W){var $=this._extensionsLoadMaterialPropertiesAsync(w,N,W);if($)return $;var J=new Array;return J.push(this.loadMaterialBasePropertiesAsync(w,N,W)),N.pbrMetallicRoughness&&J.push(this._loadMaterialMetallicRoughnessPropertiesAsync(w+"/pbrMetallicRoughness",N.pbrMetallicRoughness,W)),this.loadMaterialAlphaProperties(w,N,W),Promise.all(J).then(function(){})},ee.prototype.loadMaterialBasePropertiesAsync=function(w,N,W){if(!(W instanceof d.a))throw new Error(w+": Material type not supported");var $=new Array;return W.emissiveColor=N.emissiveFactor?j.a.FromArray(N.emissiveFactor):new j.a(0,0,0),N.doubleSided&&(W.backFaceCulling=!1,W.twoSidedLighting=!0),N.normalTexture&&(N.normalTexture.nonColorData=!0,$.push(this.loadTextureInfoAsync(w+"/normalTexture",N.normalTexture,function(J){J.name=W.name+" (Normal)",W.bumpTexture=J})),W.invertNormalMapX=!this._babylonScene.useRightHandedSystem,W.invertNormalMapY=this._babylonScene.useRightHandedSystem,N.normalTexture.scale!=null&&(W.bumpTexture.level=N.normalTexture.scale),W.forceIrradianceInFragment=!0),N.occlusionTexture&&(N.occlusionTexture.nonColorData=!0,$.push(this.loadTextureInfoAsync(w+"/occlusionTexture",N.occlusionTexture,function(J){J.name=W.name+" (Occlusion)",W.ambientTexture=J})),W.useAmbientInGrayScale=!0,N.occlusionTexture.strength!=null&&(W.ambientTextureStrength=N.occlusionTexture.strength)),N.emissiveTexture&&$.push(this.loadTextureInfoAsync(w+"/emissiveTexture",N.emissiveTexture,function(J){J.name=W.name+" (Emissive)",W.emissiveTexture=J})),Promise.all($).then(function(){})},ee.prototype.loadMaterialAlphaProperties=function(w,N,W){if(!(W instanceof d.a))throw new Error(w+": Material type not supported");var $=N.alphaMode||"OPAQUE";switch($){case"OPAQUE":{W.transparencyMode=d.a.PBRMATERIAL_OPAQUE;break}case"MASK":{W.transparencyMode=d.a.PBRMATERIAL_ALPHATEST,W.alphaCutOff=N.alphaCutoff==null?.5:N.alphaCutoff,W.albedoTexture&&(W.albedoTexture.hasAlpha=!0);break}case"BLEND":{W.transparencyMode=d.a.PBRMATERIAL_ALPHABLEND,W.albedoTexture&&(W.albedoTexture.hasAlpha=!0,W.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(w+"/alphaMode: Invalid value ("+N.alphaMode+")")}},ee.prototype.loadTextureInfoAsync=function(w,N,W){var $=this;W===void 0&&(W=function(){});var J=this._extensionsLoadTextureInfoAsync(w,N,W);if(J)return J;if(this.logOpen(""+w),N.texCoord>=2)throw new Error(w+"/texCoord: Invalid value ("+N.texCoord+")");var le=X.Get(w+"/index",this._gltf.textures,N.index);le._textureInfo=N;var ne=this._loadTextureAsync("/textures/"+N.index,le,function(be){be.coordinatesIndex=N.texCoord||0,ee.AddPointerMetadata(be,w),$._parent.onTextureLoadedObservable.notifyObservers(be),W(be)});return this.logClose(),ne},ee.prototype._loadTextureAsync=function(w,N,W){W===void 0&&(W=function(){});var $=this._extensionsLoadTextureAsync(w,N,W);if($)return $;this.logOpen(w+" "+(N.name||""));var J=N.sampler==null?ee.DefaultSampler:X.Get(w+"/sampler",this._gltf.samplers,N.sampler),le=X.Get(w+"/source",this._gltf.images,N.source),ne=this._createTextureAsync(w,J,le,W);return this.logClose(),ne},ee.prototype._createTextureAsync=function(w,N,W,$,J){var le=this;$===void 0&&($=function(){});var ne=this._loadSampler("/samplers/"+N.index,N),be=new Array,Me=new T.a;this._babylonScene._blockEntityCollection=this._forAssetContainer;var Te=new g.a(null,this._babylonScene,ne.noMipMaps,!1,ne.samplingMode,function(){le._disposed||Me.resolve()},function(Ae,se){le._disposed||Me.reject(new Error(w+": "+(se&&se.message?se.message:Ae||"Failed to load texture")))},void 0,void 0,void 0,W.mimeType,J);return this._babylonScene._blockEntityCollection=!1,be.push(Me.promise),be.push(this.loadImageAsync("/images/"+W.index,W).then(function(Ae){var se=W.uri||le._fileName+"#image"+W.index,te="data:"+le._uniqueRootUrl+se;Te.updateURL(te,Ae)})),Te.wrapU=ne.wrapU,Te.wrapV=ne.wrapV,$(Te),Promise.all(be).then(function(){return Te})},ee.prototype._loadSampler=function(w,N){return N._data||(N._data={noMipMaps:N.minFilter===9728||N.minFilter===9729,samplingMode:ee._GetTextureSamplingMode(w,N),wrapU:ee._GetTextureWrapMode(w+"/wrapS",N.wrapS),wrapV:ee._GetTextureWrapMode(w+"/wrapT",N.wrapT)}),N._data},ee.prototype.loadImageAsync=function(w,N){if(!N._data){if(this.logOpen(w+" "+(N.name||"")),N.uri)N._data=this.loadUriAsync(w+"/uri",N,N.uri);else{var W=X.Get(w+"/bufferView",this._gltf.bufferViews,N.bufferView);N._data=this.loadBufferViewAsync("/bufferViews/"+W.index,W)}this.logClose()}return N._data},ee.prototype.loadUriAsync=function(w,N,W){var $=this,J=this._extensionsLoadUriAsync(w,N,W);if(J)return J;if(!ee._ValidateUri(W))throw new Error(w+": '"+W+"' is invalid");if(O.b.IsBase64(W)){var le=new Uint8Array(O.b.DecodeBase64(W));return this.log(w+": Decoded "+W.substr(0,64)+"... ("+le.length+" bytes)"),Promise.resolve(le)}return this.log(w+": Loading "+W),this._parent.preprocessUrlAsync(this._rootUrl+W).then(function(ne){return new Promise(function(be,Me){$._parent._loadFile(ne,$._babylonScene,function(Te){$._disposed||($.log(w+": Loaded "+W+" ("+Te.byteLength+" bytes)"),be(new Uint8Array(Te)))},!0,function(Te){Me(new Ie.b(w+": Failed to load '"+W+"'"+(Te?": "+Te.status+" "+Te.statusText:""),Te))})})})},ee.AddPointerMetadata=function(w,N){var W=w.metadata=w.metadata||{},$=W.gltf=W.gltf||{},J=$.pointers=$.pointers||[];J.push(N)},ee._GetTextureWrapMode=function(w,N){switch(N=N==null?10497:N,N){case 33071:return g.a.CLAMP_ADDRESSMODE;case 33648:return g.a.MIRROR_ADDRESSMODE;case 10497:return g.a.WRAP_ADDRESSMODE;default:return k.a.Warn(w+": Invalid value ("+N+")"),g.a.WRAP_ADDRESSMODE}},ee._GetTextureSamplingMode=function(w,N){var W=N.magFilter==null?9729:N.magFilter,$=N.minFilter==null?9987:N.minFilter;if(W===9729)switch($){case 9728:return g.a.LINEAR_NEAREST;case 9729:return g.a.LINEAR_LINEAR;case 9984:return g.a.LINEAR_NEAREST_MIPNEAREST;case 9985:return g.a.LINEAR_LINEAR_MIPNEAREST;case 9986:return g.a.LINEAR_NEAREST_MIPLINEAR;case 9987:return g.a.LINEAR_LINEAR_MIPLINEAR;default:return k.a.Warn(w+"/minFilter: Invalid value ("+$+")"),g.a.LINEAR_LINEAR_MIPLINEAR}else switch(W!==9728&&k.a.Warn(w+"/magFilter: Invalid value ("+W+")"),$){case 9728:return g.a.NEAREST_NEAREST;case 9729:return g.a.NEAREST_LINEAR;case 9984:return g.a.NEAREST_NEAREST_MIPNEAREST;case 9985:return g.a.NEAREST_LINEAR_MIPNEAREST;case 9986:return g.a.NEAREST_NEAREST_MIPLINEAR;case 9987:return g.a.NEAREST_LINEAR_MIPLINEAR;default:return k.a.Warn(w+"/minFilter: Invalid value ("+$+")"),g.a.NEAREST_NEAREST_MIPNEAREST}},ee._GetTypedArrayConstructor=function(w,N){switch(N){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(w+": Invalid component type "+N)}},ee._GetTypedArray=function(w,N,W,$,J){var le=W.buffer;$=W.byteOffset+($||0);var ne=ee._GetTypedArrayConstructor(w+"/componentType",N);try{return new ne(le,$,J)}catch(be){throw new Error(w+": "+be)}},ee._GetNumComponents=function(w,N){switch(N){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(w+": Invalid type ("+N+")")},ee._ValidateUri=function(w){return O.b.IsBase64(w)||w.indexOf("..")===-1},ee._GetDrawMode=function(w,N){switch(N==null&&(N=4),N){case 0:return m.a.PointListDrawMode;case 1:return m.a.LineListDrawMode;case 2:return m.a.LineLoopDrawMode;case 3:return m.a.LineStripDrawMode;case 4:return m.a.TriangleFillMode;case 5:return m.a.TriangleStripDrawMode;case 6:return m.a.TriangleFanDrawMode}throw new Error(w+": Invalid mesh primitive mode ("+N+")")},ee.prototype._compileMaterialsAsync=function(){var w=this;this._parent._startPerformanceCounter("Compile materials");var N=new Array;if(this._gltf.materials)for(var W=0,$=this._gltf.materials;W<$.length;W++){var J=$[W];if(J._data)for(var le in J._data)for(var ne=J._data[le],be=0,Me=ne.babylonMeshes;be<Me.length;be++){var Te=Me[be];Te.computeWorldMatrix(!0);var Ae=ne.babylonMaterial;N.push(Ae.forceCompilationAsync(Te)),N.push(Ae.forceCompilationAsync(Te,{useInstances:!0})),this._parent.useClipPlane&&(N.push(Ae.forceCompilationAsync(Te,{clipPlane:!0})),N.push(Ae.forceCompilationAsync(Te,{clipPlane:!0,useInstances:!0})))}}return Promise.all(N).then(function(){w._parent._endPerformanceCounter("Compile materials")})},ee.prototype._compileShadowGeneratorsAsync=function(){var w=this;this._parent._startPerformanceCounter("Compile shadow generators");for(var N=new Array,W=this._babylonScene.lights,$=0,J=W;$<J.length;$++){var le=J[$],ne=le.getShadowGenerator();ne&&N.push(ne.forceCompilationAsync())}return Promise.all(N).then(function(){w._parent._endPerformanceCounter("Compile shadow generators")})},ee.prototype._forEachExtensions=function(w){for(var N=0,W=this._extensions;N<W.length;N++){var $=W[N];$.enabled&&w($)}},ee.prototype._applyExtensions=function(w,N,W){for(var $=0,J=this._extensions;$<J.length;$++){var le=J[$];if(le.enabled){var ne=le.name+"."+N,be=w;be._activeLoaderExtensionFunctions=be._activeLoaderExtensionFunctions||{};var Me=be._activeLoaderExtensionFunctions;if(!Me[ne]){Me[ne]=!0;try{var Te=W(le);if(Te)return Te}finally{delete Me[ne]}}}}return null},ee.prototype._extensionsOnLoading=function(){this._forEachExtensions(function(w){return w.onLoading&&w.onLoading()})},ee.prototype._extensionsOnReady=function(){this._forEachExtensions(function(w){return w.onReady&&w.onReady()})},ee.prototype._extensionsLoadSceneAsync=function(w,N){return this._applyExtensions(N,"loadScene",function(W){return W.loadSceneAsync&&W.loadSceneAsync(w,N)})},ee.prototype._extensionsLoadNodeAsync=function(w,N,W){return this._applyExtensions(N,"loadNode",function($){return $.loadNodeAsync&&$.loadNodeAsync(w,N,W)})},ee.prototype._extensionsLoadCameraAsync=function(w,N,W){return this._applyExtensions(N,"loadCamera",function($){return $.loadCameraAsync&&$.loadCameraAsync(w,N,W)})},ee.prototype._extensionsLoadVertexDataAsync=function(w,N,W){return this._applyExtensions(N,"loadVertexData",function($){return $._loadVertexDataAsync&&$._loadVertexDataAsync(w,N,W)})},ee.prototype._extensionsLoadMeshPrimitiveAsync=function(w,N,W,$,J,le){return this._applyExtensions(J,"loadMeshPrimitive",function(ne){return ne._loadMeshPrimitiveAsync&&ne._loadMeshPrimitiveAsync(w,N,W,$,J,le)})},ee.prototype._extensionsLoadMaterialAsync=function(w,N,W,$,J){return this._applyExtensions(N,"loadMaterial",function(le){return le._loadMaterialAsync&&le._loadMaterialAsync(w,N,W,$,J)})},ee.prototype._extensionsCreateMaterial=function(w,N,W){return this._applyExtensions(N,"createMaterial",function($){return $.createMaterial&&$.createMaterial(w,N,W)})},ee.prototype._extensionsLoadMaterialPropertiesAsync=function(w,N,W){return this._applyExtensions(N,"loadMaterialProperties",function($){return $.loadMaterialPropertiesAsync&&$.loadMaterialPropertiesAsync(w,N,W)})},ee.prototype._extensionsLoadTextureInfoAsync=function(w,N,W){return this._applyExtensions(N,"loadTextureInfo",function($){return $.loadTextureInfoAsync&&$.loadTextureInfoAsync(w,N,W)})},ee.prototype._extensionsLoadTextureAsync=function(w,N,W){return this._applyExtensions(N,"loadTexture",function($){return $._loadTextureAsync&&$._loadTextureAsync(w,N,W)})},ee.prototype._extensionsLoadAnimationAsync=function(w,N){return this._applyExtensions(N,"loadAnimation",function(W){return W.loadAnimationAsync&&W.loadAnimationAsync(w,N)})},ee.prototype._extensionsLoadSkinAsync=function(w,N,W){return this._applyExtensions(W,"loadSkin",function($){return $._loadSkinAsync&&$._loadSkinAsync(w,N,W)})},ee.prototype._extensionsLoadUriAsync=function(w,N,W){return this._applyExtensions(N,"loadUri",function($){return $._loadUriAsync&&$._loadUriAsync(w,N,W)})},ee.prototype._extensionsLoadBufferViewAsync=function(w,N){return this._applyExtensions(N,"loadBufferView",function(W){return W.loadBufferViewAsync&&W.loadBufferViewAsync(w,N)})},ee.prototype._extensionsLoadBufferAsync=function(w,N,W,$){return this._applyExtensions(N,"loadBuffer",function(J){return J.loadBufferAsync&&J.loadBufferAsync(w,N,W,$)})},ee.LoadExtensionAsync=function(w,N,W,$){if(!N.extensions)return null;var J=N.extensions,le=J[W];return le?$(w+"/extensions/"+W,le):null},ee.LoadExtraAsync=function(w,N,W,$){if(!N.extras)return null;var J=N.extras,le=J[W];return le?$(w+"/extras/"+W,le):null},ee.prototype.isExtensionUsed=function(w){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(w)!==-1},ee.prototype.logOpen=function(w){this._parent._logOpen(w)},ee.prototype.logClose=function(){this._parent._logClose()},ee.prototype.log=function(w){this._parent._log(w)},ee.prototype.startPerformanceCounter=function(w){this._parent._startPerformanceCounter(w)},ee.prototype.endPerformanceCounter=function(w){this._parent._endPerformanceCounter(w)},ee._RegisteredExtensions={},ee.DefaultSampler={index:-1},ee}();re._CreateGLTF2Loader=function(ee){return new ae(ee)}},782:function(Ue,P,u){"use strict";var T=u(696),S=u(447),j=u(661),O=u(780),M="KHR_draco_mesh_compression",H=function(){function A(p){this.name=M,this._loader=p,this.enabled=T.a.DecoderAvailable&&this._loader.isExtensionUsed(M)}return A.prototype.dispose=function(){delete this.dracoCompression,this._loader=null},A.prototype._loadVertexDataAsync=function(p,f,h){var m=this;return O.b.LoadExtensionAsync(p,f,this.name,function(d,g){if(f.mode!=null){if(f.mode!==5&&f.mode!==4)throw new Error(p+": Unsupported mode "+f.mode);if(f.mode===5)throw new Error(p+": Mode "+f.mode+" is not currently supported")}var v={},l=function(E,R){var F=g.attributes[E];F!=null&&(h._delayInfo=h._delayInfo||[],h._delayInfo.indexOf(R)===-1&&h._delayInfo.push(R),v[R]=F)};l("POSITION",S.b.PositionKind),l("NORMAL",S.b.NormalKind),l("TANGENT",S.b.TangentKind),l("TEXCOORD_0",S.b.UVKind),l("TEXCOORD_1",S.b.UV2Kind),l("JOINTS_0",S.b.MatricesIndicesKind),l("WEIGHTS_0",S.b.MatricesWeightsKind),l("COLOR_0",S.b.ColorKind);var y=O.a.Get(d,m._loader.gltf.bufferViews,g.bufferView);return y._dracoBabylonGeometry||(y._dracoBabylonGeometry=m._loader.loadBufferViewAsync("/bufferViews/"+y.index,y).then(function(E){var R=m.dracoCompression||T.a.Default;return R.decodeMeshAsync(E,v).then(function(F){var B=new j.a(h.name,m._loader.babylonScene);return F.applyToGeometry(B),B}).catch(function(F){throw new Error(p+": "+F.message)})})),y._dracoBabylonGeometry})},A}();O.b.RegisterExtension(M,function(A){return new H(A)})},812:function(Ue){Ue.exports=JSON.parse('[["#69d2e7","#a7dbd8","#e0e4cc","#f38630","#fa6900"],["#fe4365","#fc9d9a","#f9cdad","#c8c8a9","#83af9b"],["#ecd078","#d95b43","#c02942","#542437","#53777a"],["#556270","#4ecdc4","#c7f464","#ff6b6b","#c44d58"],["#774f38","#e08e79","#f1d4af","#ece5ce","#c5e0dc"],["#e8ddcb","#cdb380","#036564","#033649","#031634"],["#490a3d","#bd1550","#e97f02","#f8ca00","#8a9b0f"],["#594f4f","#547980","#45ada8","#9de0ad","#e5fcc2"],["#00a0b0","#6a4a3c","#cc333f","#eb6841","#edc951"],["#e94e77","#d68189","#c6a49a","#c6e5d9","#f4ead5"],["#3fb8af","#7fc7af","#dad8a7","#ff9e9d","#ff3d7f"],["#d9ceb2","#948c75","#d5ded9","#7a6a53","#99b2b7"],["#ffffff","#cbe86b","#f2e9e1","#1c140d","#cbe86b"],["#efffcd","#dce9be","#555152","#2e2633","#99173c"],["#343838","#005f6b","#008c9e","#00b4cc","#00dffc"],["#413e4a","#73626e","#b38184","#f0b49e","#f7e4be"],["#ff4e50","#fc913a","#f9d423","#ede574","#e1f5c4"],["#99b898","#fecea8","#ff847c","#e84a5f","#2a363b"],["#655643","#80bca3","#f6f7bd","#e6ac27","#bf4d28"],["#00a8c6","#40c0cb","#f9f2e7","#aee239","#8fbe00"],["#351330","#424254","#64908a","#e8caa4","#cc2a41"],["#554236","#f77825","#d3ce3d","#f1efa5","#60b99a"],["#5d4157","#838689","#a8caba","#cad7b2","#ebe3aa"],["#8c2318","#5e8c6a","#88a65e","#bfb35a","#f2c45a"],["#fad089","#ff9c5b","#f5634a","#ed303c","#3b8183"],["#ff4242","#f4fad2","#d4ee5e","#e1edb9","#f0f2eb"],["#f8b195","#f67280","#c06c84","#6c5b7b","#355c7d"],["#d1e751","#ffffff","#000000","#4dbce9","#26ade4"],["#1b676b","#519548","#88c425","#bef202","#eafde6"],["#5e412f","#fcebb6","#78c0a8","#f07818","#f0a830"],["#bcbdac","#cfbe27","#f27435","#f02475","#3b2d38"],["#452632","#91204d","#e4844a","#e8bf56","#e2f7ce"],["#eee6ab","#c5bc8e","#696758","#45484b","#36393b"],["#f0d8a8","#3d1c00","#86b8b1","#f2d694","#fa2a00"],["#2a044a","#0b2e59","#0d6759","#7ab317","#a0c55f"],["#f04155","#ff823a","#f2f26f","#fff7bd","#95cfb7"],["#b9d7d9","#668284","#2a2829","#493736","#7b3b3b"],["#bbbb88","#ccc68d","#eedd99","#eec290","#eeaa88"],["#b3cc57","#ecf081","#ffbe40","#ef746f","#ab3e5b"],["#a3a948","#edb92e","#f85931","#ce1836","#009989"],["#300030","#480048","#601848","#c04848","#f07241"],["#67917a","#170409","#b8af03","#ccbf82","#e33258"],["#aab3ab","#c4cbb7","#ebefc9","#eee0b7","#e8caaf"],["#e8d5b7","#0e2430","#fc3a51","#f5b349","#e8d5b9"],["#ab526b","#bca297","#c5ceae","#f0e2a4","#f4ebc3"],["#607848","#789048","#c0d860","#f0f0d8","#604848"],["#b6d8c0","#c8d9bf","#dadabd","#ecdbbc","#fedcba"],["#a8e6ce","#dcedc2","#ffd3b5","#ffaaa6","#ff8c94"],["#3e4147","#fffedf","#dfba69","#5a2e2e","#2a2c31"],["#fc354c","#29221f","#13747d","#0abfbc","#fcf7c5"],["#cc0c39","#e6781e","#c8cf02","#f8fcc1","#1693a7"],["#1c2130","#028f76","#b3e099","#ffeaad","#d14334"],["#a7c5bd","#e5ddcb","#eb7b59","#cf4647","#524656"],["#dad6ca","#1bb0ce","#4f8699","#6a5e72","#563444"],["#5c323e","#a82743","#e15e32","#c0d23e","#e5f04c"],["#edebe6","#d6e1c7","#94c7b6","#403b33","#d3643b"],["#fdf1cc","#c6d6b8","#987f69","#e3ad40","#fcd036"],["#230f2b","#f21d41","#ebebbc","#bce3c5","#82b3ae"],["#b9d3b0","#81bda4","#b28774","#f88f79","#f6aa93"],["#3a111c","#574951","#83988e","#bcdea5","#e6f9bc"],["#5e3929","#cd8c52","#b7d1a3","#dee8be","#fcf7d3"],["#1c0113","#6b0103","#a30006","#c21a01","#f03c02"],["#000000","#9f111b","#b11623","#292c37","#cccccc"],["#382f32","#ffeaf2","#fcd9e5","#fbc5d8","#f1396d"],["#e3dfba","#c8d6bf","#93ccc6","#6cbdb5","#1a1f1e"],["#f6f6f6","#e8e8e8","#333333","#990100","#b90504"],["#1b325f","#9cc4e4","#e9f2f9","#3a89c9","#f26c4f"],["#a1dbb2","#fee5ad","#faca66","#f7a541","#f45d4c"],["#c1b398","#605951","#fbeec2","#61a6ab","#accec0"],["#5e9fa3","#dcd1b4","#fab87f","#f87e7b","#b05574"],["#951f2b","#f5f4d7","#e0dfb1","#a5a36c","#535233"],["#8dccad","#988864","#fea6a2","#f9d6ac","#ffe9af"],["#2d2d29","#215a6d","#3ca2a2","#92c7a3","#dfece6"],["#413d3d","#040004","#c8ff00","#fa023c","#4b000f"],["#eff3cd","#b2d5ba","#61ada0","#248f8d","#605063"],["#ffefd3","#fffee4","#d0ecea","#9fd6d2","#8b7a5e"],["#cfffdd","#b4dec1","#5c5863","#a85163","#ff1f4c"],["#9dc9ac","#fffec7","#f56218","#ff9d2e","#919167"],["#4e395d","#827085","#8ebe94","#ccfc8e","#dc5b3e"],["#a8a7a7","#cc527a","#e8175d","#474747","#363636"],["#f8edd1","#d88a8a","#474843","#9d9d93","#c5cfc6"],["#046d8b","#309292","#2fb8ac","#93a42a","#ecbe13"],["#f38a8a","#55443d","#a0cab5","#cde9ca","#f1edd0"],["#a70267","#f10c49","#fb6b41","#f6d86b","#339194"],["#ff003c","#ff8a00","#fabe28","#88c100","#00c176"],["#ffedbf","#f7803c","#f54828","#2e0d23","#f8e4c1"],["#4e4d4a","#353432","#94ba65","#2790b0","#2b4e72"],["#0ca5b0","#4e3f30","#fefeeb","#f8f4e4","#a5b3aa"],["#4d3b3b","#de6262","#ffb88c","#ffd0b3","#f5e0d3"],["#fffbb7","#a6f6af","#66b6ab","#5b7c8d","#4f2958"],["#edf6ee","#d1c089","#b3204d","#412e28","#151101"],["#9d7e79","#ccac95","#9a947c","#748b83","#5b756c"],["#fcfef5","#e9ffe1","#cdcfb7","#d6e6c3","#fafbe3"],["#9cddc8","#bfd8ad","#ddd9ab","#f7af63","#633d2e"],["#30261c","#403831","#36544f","#1f5f61","#0b8185"],["#aaff00","#ffaa00","#ff00aa","#aa00ff","#00aaff"],["#d1313d","#e5625c","#f9bf76","#8eb2c5","#615375"],["#ffe181","#eee9e5","#fad3b2","#ffba7f","#ff9c97"],["#73c8a9","#dee1b6","#e1b866","#bd5532","#373b44"],["#805841","#dcf7f3","#fffcdd","#ffd8d8","#f5a2a2"]]')}}]);
